module("extensions.yuri", package.seeall)
extension = sgs.Package("yuri")
extension_h = sgs.Package("hotblood", sgs.Package_GeneralPack)

JSPwonyi = sgs.General(extension_h, "JSPwonyi", "god", "4", false)
wangzouen = sgs.General(extension_h, "wangzouen", "god", "3", false, true, true)
amayadorimachi = sgs.General(extension, "amayadorimachi", "god", "3", false, false)
sugawakaki = sgs.General(extension, "sugawakaki", "god", "3", false, true, true)
shampoo = sgs.General(extension, "shampoo", "qun", "3", false, false)
ranma = sgs.General(extension, "ranma", "shu", "4", true, true, true)
akane = sgs.General(extension, "akane", "shu", "3", false, true, true)
rapunzel = sgs.General(extension, "rapunzel", "god", "3", false, true, true)
lenuje = sgs.General(extension, "lenuje", "wu", "3", false, true, true)
pyluluco = sgs.General(extension, "pyluluco", "wei", "3", false)
tama = sgs.General(extension, "tama", "qun", "4", false, false)
jiyori = sgs.General(extension, "jiyori", "wu", "4", false, false)
thethief = sgs.General(extension, "thethief", "wu", "4", true, true, true)
takayamaharuka = sgs.General(extension, "takayamaharuka", "god", "3", false)
chiya = sgs.General(extension, "chiya", "wu", "3", false)
nono = sgs.General(extension, "nono", "qun", "4", false)
kon = sgs.General(extension, "kon", "wei", "3", false)
koumae = sgs.General(extension, "koumae", "shu", "4", false)
jsunru = sgs.General(extension_h, "jsunru", "wu", "3", false, false)
jzhaoxiang = sgs.General(extension_h, "jzhaoxiang", "shu", "4", false, false)
jcaojie = sgs.General(extension_h, "jcaojie", "wei", "4", false, false)
yukiyuna = sgs.General(extension, "yukiyuna", "shu", "4", false, false)
ronomiyokaruta = sgs.General(extension, "ronomiyokaruta", "qun", "3", false, false)
saki = sgs.General(extension, "saki", "wei", "4", false, true, true)
shirokenrirchiyo = sgs.General(extension, "shirokenrirchiyo", "shu", "4", false, false)
shitsino = sgs.General(extension, "shitsino", "qun", "3", false, false)
hatarugimanri = sgs.General(extension, "hatarugimanri", "qun", "5", true, false)
koromo = sgs.General(extension, "koromo", "wu", "3", false, false)
koyori = sgs.General(extension, "koyori", "qun", "4", false, false)
agari = sgs.General(extension, "agari", "wei", "3", false, false)
jyuji = sgs.General(extension_h, "jyuji", "qun", "3", true, false)
chikaryu = sgs.General(extension, "chikaryu", "god", "4", false)
tamao = sgs.General(extension, "tamao", "qun", "3", false)
miyako = sgs.General(extension, "miyako", "qun", "3", false)
treefairy = sgs.General(extension_h, "treefairy", "wu", "4", false, false)
konbuandrebuild = sgs.General(extension, "konbuandrebuild", "god", "4", false, false)
maiza = sgs.General(extension, "maiza", "wei", "3", false, false)
yurikuma = sgs.General(extension, "yurikuma", "wu", "3", false, false)
chito = sgs.General(extension, "chito", "qun", "3", false, false)
yuuri = sgs.General(extension, "yuuri", "qun", "4", false, false)
anias = sgs.General(extension, "anias", "shu", "3", false, false)
yuri_guanyinping = sgs.General(extension_h, "yuri_guanyinping", "shu", "3", false, false)
ys_lukang = sgs.General(extension_h, "ys_lukang", "wu", "3", true, false)
-- ys_zhangxiu = sgs.General(extension_h, "ys_zhangxiu", "qun", "4", true, false)
sofy = sgs.General(extension, "sofy", "wu", "3", false, false)
elly = sgs.General(extension, "elly", "wu", "4", false, false)
yuri_zhoufei = sgs.General(extension_h, "yuri_zhoufei", "wu", "3", false, false)
bloodymarry = sgs.General(extension, "bloodymarry", "god", "4", false, false)
yuri_jsunshangxiang = sgs.General(extension_h, "yuri_jsunshangxiang", "wu", "3", false, false)
nulltopeta = sgs.General(extension, "nulltopeta", "qun", "4", false, false)
gasaitoyuki = sgs.General(extension, "gasaitoyuki", "shu", "3", false, false)
tsuuitotina = sgs.General(extension, "tsuuitotina$", "wei", "3", false, false)
tsujimikadokuon = sgs.General(extension, "tsujimikadokuon", "qun", "4", false, false)
rinnene = sgs.General(extension, "rinnene", "qun", "4", false, false)
huukatoinori = sgs.General(extension, "huukatoinori", "wu", "3", false, false)
lio = sgs.General(extension, "lio", "wu", "3", true, false)
eratosoniya = sgs.General(extension, "eratosoniya", "wu", "3", false, false)
asukatoyuu = sgs.General(extension, "asukatoyuu", "wei", "3", false, false)
yuri_caocao = sgs.General(extension_h, "yuri_caocao", "god", "3", true, false)
kamiyamasakuya = sgs.General(extension, "kamiyamasakuya", "wei", "3", false, false)
hashirinio = sgs.General(extension, "hashirinio", "wu", "3", false, false)
mizushimakiyoi = sgs.General(extension, "mizushimakiyoi", "qun", "3", false, false)
yuri_yitandianwei = sgs.General(extension_h, "yuri_yitandianwei", "wei", "4", true, false)
sadoharamai = sgs.General(extension, "sadoharamai", "shu", "3", false, false)
matsuobasho = sgs.General(extension, "matsuobasho", "wei", "4", false, false)
miyoshikarin = sgs.General(extension, "miyoshikarin", "qun", "4", false, false)
mirokuyumiko = sgs.General(extension, "mirokuyumiko$", "wu", "4", false, false)
ainisutoyufi = sgs.General(extension, "ainisutoyufi$", "shu", "4", false, false)
murosakimiyo = sgs.General(extension, "murosakimiyo", "shu", "4", false, false)
yuri_ruyi = sgs.General(extension_h, "yuri_ruyi", "god", "4", false, false)
yuri_yitanjian = sgs.General(extension_h, "yuri_yitanjian", "god", "4", true, false)
nikuou = sgs.General(extension_h, "nikuou$", "god", "30", true, true, true)
yurinosakibasu = sgs.General(extension, "yurinosakibasu", "jin", "4", false, true, true) -- 自創的新角色，目前停產
testguy = sgs.General(extension, "testguy", "god", "4", false, true, true)

sgs.LoadTranslationTable{

["yuri"] = "真誠與百合",
["hotblood"] = "血液沸騰包",

["nikuou"] = "巨肉",
["&nikuou"] = "巨肉",
["#nikuou"] = "食肉節",
["designer:yuri_yitanjian"] = "吉博茲",

["yuri_yitanjian"] = "熱血包-倚天劍",
["&yuri_yitanjian"] = "熱天劍",
["#yuri_yitanjian"] = "鋒銳烈節",
["designer:yuri_yitanjian"] = "吉博茲",

["JSPwonyi"] = "元祖 王異",
["&JSPwonyi"] = "元王異",
["#JSPwonyi"] = "智策的女將",
["designer:JSPwonyi"] = "吉博茲",

["wangzouen"] = "元祖 王趙英",
["&wangzouen"] = "元王趙英",
["#wangzouen"] = "尋母的蟲后",
["designer:wangzouen"] = "吉博茲",

["amayadorimachi"] = "雨宿町",
["&amayadorimachi"] = "雨宿町",
["#amayadorimachi"] = "樂活都鄉",
["designer:amayadorimachi"] = "吉博茲",

["sugawakaki"] = "栖川 柿",
["&sugawakaki"] = "柿子",
["#sugawakaki"] = "隱居魔女",
["designer:sugawakaki"] = "吉博茲",

["shampoo"] = "珊璞",
["&shampoo"] = "珊璞",
["#shampoo"] = "女傑傳人",
["designer:shampoo"] = "吉博茲",

["akane"] = "天道 茜",
["&akane"] = "小茜",
["#akane"] = "天道派傳人",
["designer:akane"] = "吉博茲",

["ranma"] = "早乙女 亂馬",
["&ranma"] = "亂馬",
["#ranma"] = "無差別格鬥",
["designer:ranma"] = "吉博茲",

["rapunzel"] = "樂佩 安澤爾",
["&rapunzel"] = "樂佩",
["#rapunzel"] = "魔髮奇緣",
["designer:rapunzel"] = "吉博茲",

["lenuje"] = "憐玉潔",
["&lenuje"] = "憐玉潔",
["#lenuje"] = "靈水的醫者",
["designer:lenuje"] = "吉博茲",

["pyluluco"] = "皮璐璐可",
["&pyluluco"] = "皮璐璐可",
["#pyluluco"] = "代號歐姆",
["designer:pyluluco"] = "吉博茲",
["illustrator:pyluluco"] = "百合度：☆☆☆",

["tama"] = "小玉",
["&tama"] = "小玉",
["#tama"] = "太陽的巫女",
["designer:tama"] = "吉博茲",
["illustrator:tama"] = "百合度：★☆☆",

["jiyori"] = "艾爾德拉&千依",
["&jiyori"] = "德拉與千依",
["#jiyori"] = "超實的牽絆",
["designer:jiyori"] = "吉博茲",
["illustrator:jiyori"] = "百合度：★☆☆",

["yukiyuna"] = "結城友奈",
["&yukiyuna"] = "友奈",
["#yukiyuna"] = "為友而戰",
["designer:yukiyuna"] = "吉博茲",
["illustrator:yukiyuna"] = "百合度：★★☆",
["~yukiyuna"] = "死亡音效",

["thethief"] = "徐為典",
["&thethief"] = "徐為典",
["#thethief"] = "陷阱盜賊",
["designer:thethief"] = "吉博茲",

["takayamaharuka"] = "高山春香&園田優",
["&takayamaharuka"] = "春香與優",
["#takayamaharuka"] = "百合傳奇",
["designer:takayamaharuka"] = "吉博茲",
["illustrator:takayamaharuka"] = "百合度：★★★",
["~takayamaharuka"] = "陣亡音效",

["chiya"] = "千矢",
["&chiya"] = "千矢",
["#chiya"] = "神裔百合",
["designer:chiya"] = "吉博茲",
["illustrator:chiya"] = "百合度：★☆☆",
["~chiya"] = "陣亡音效",

["nono"] = "棗乃乃",
["&nono"] = "棗乃乃",
["#nono"] = "神裔百合",
["designer:nono"] = "吉博茲",
["illustrator:nono"] = "百合度：★☆☆",
["~nono"] = "陣亡音效",

["kon"] = "巽绀",
["&kon"] = "巽绀",
["#kon"] = "神裔百合",
["designer:kon"] = "吉博茲",
["illustrator:kon"] = "百合度：★☆☆",
["~kon"] = "陣亡音效",

["koumae"] = "雪見小梅",
["&koumae"] = "雪見小梅",
["#koumae"] = "神裔百合",
["designer:koumae"] = "吉博茲",
["illustrator:koumae"] = "百合度：★☆☆",
["~koumae"] = "陣亡音效",

["jsunru"] = "熱血包-孫茹",
["&jsunru"] = "熱孫茹",
["#jsunru"] = "出水青蓮",
["designer:jsunru"] = "吉博茲",

["jzhaoxiang"] = "熱血包-趙襄",
["&jzhaoxiang"] = "熱趙襄",
["#jzhaoxiang"] = "驚鴻魅影",
["designer:jzhaoxiang"] = "吉博茲",
["~jzhaoxiang"] = "遁入阴影之中...",

["jcaojie"] = "熱血包-曹節",
["&jcaojie"] = "熱曹節",
["#jcaojie"] = "獻穆皇后",
["designer:jcaojie"] = "吉博茲",

["ronomiyokaruta"] = "骷髏宮歌留多",
["&ronomiyokaruta"] = "歌留多",
["#ronomiyokaruta"] = "擁護真摯",
["designer:ronomiyokaruta"] = "吉博茲",
["~ronomiyokaruta"] = "陣亡音效",

["hatarugimanri"] = "渡狸萬里",
["&hatarugimanri"] = "渡狸萬里",
["#hatarugimanri"] = "忠貞為愛",
["designer:hatarugimanri"] = "吉博茲",
["~hatarugimanri"] = "陣亡音效",

["shirokenrirchiyo"] = "白鬼院凜凜蝶",
["&shirokenrirchiyo"] = "凜凜蝶",
["#shirokenrirchiyo"] = "與狐偕老",
["designer:shirokenrirchiyo"] = "吉博茲",
["~shirokenrirchiyo"] = "陣亡音效",

["shitsino"] = "高鴨穩乃",
["&shitsino"] = "高鴨穩乃",
["#shitsino"] = "反璞歸真",
["designer:shitsino"] = "吉博茲",
["illustrator:shitsino"] = "百合度：★☆☆",
["~shitsino"] = "陣亡音效",

["saki"] = "宮永咲",
["&saki"] = "宮永咲",
["#saki"] = "嶺上開花",
["designer:saki"] = "吉博茲",
["illustrator:saki"] = "百合度：★☆☆",
["~saki"] = "陣亡音效",

["koromo"] = "天江衣",
["&koromo"] = "天江衣",
["#koromo"] = "海底撈月",
["designer:koromo"] = "吉博茲",
["illustrator:koromo"] = "百合度：★☆☆",
["~koromo"] = "陣亡音效",

["agari"] = "上矢上里",
["&agari"] = "上矢上里",
["#agari"] = "希望之王牌",
["designer:agari"] = "吉博茲",
["illustrator:agari"] = "百合度：★★★",
["~agari"] = "陣亡音效",

["koyori"] = "旋風小寄",
["&koyori"] = "旋風小寄",
["#koyori"] = "逆轉的旋風",
["designer:koyori"] = "吉博茲",
["illustrator:koyori"] = "百合度：★★★",
["~koyori"] = "陣亡音效",

["jyuji"] = "熱血包-于吉",
["&jyuji"] = "熱于吉",
["#jyuji"] = "太平道人",
["designer:jyuji"] = "吉博茲",
["~jyuji"] = "竟然......被猜到了。",

["chikaryu"] = "源 千華留",
["&chikaryu"] = "千華留",
["#chikaryu"] = "百合守護者",
["designer:chikaryu"] = "吉博茲",
["illustrator:chikaryu"] = "百合度：★★★",

["tamao"] = "涼水 玉青",
["&tamao"] = "玉青",
["#tamao"] = "真情祝福",
["designer:MZ"] = "吉博茲",
["illustrator:tamao"] = "百合度：★★★",

["miyako"] = "星野宮子",
["&miyako"] = "宮子",
["#miyako"] = "忘年百合",
["designer:miyako"] = "吉博茲",
["illustrator:miyako"] = "百合度：★★☆",
["~miyako"] = "陣亡音效",

["konbuandrebuild"] = "K-ONWReborn",
["&konbuandrebuild"] = "輕音部",
["#konbuandrebuild"] = "百合天音",
["designer:konbuandrebuild"] = "吉博茲",
["illustrator:konbuandrebuild"] = "百合度：★☆☆",
["~konbuandrebuild"] = "陣亡音效",

["treefairy"] = "熱血包-樹精",
["&treefairy"] = "熱樹精",
["#treefairy"] = "自然的恩澤",
["designer:treefairy"] = "吉博茲",

["maiza"] = "梅札恩達斯特",
["&maiza"] = "梅札",
["#maiza"] = "百合卡牌大師",
["designer:maiza"] = "吉博茲",
["illustrator:maiza"] = "百合度：☆☆☆",
["~maiza"] = "陣亡音效",

["yurikuma"] = "百合熊",
["&yurikuma"] = "百合熊",
["#yurikuma"] = "終將結李",
["designer:yurikuma"] = "吉博茲",
["illustrator:yurikuma"] = "百合度：★★★",
["cv:yurikuma"] = "百合城銀子-百合咲露露-椿輝紅羽",
["~yurikuma"] = "陣亡音效",

["chito"] = "千都",
["&chito"] = "千都",
["#chito"] = "終末百合",
["designer:chito"] = "吉博茲",
["illustrator:chito"] = "百合度：★★★ (與尤莉)",
["~chito"] = "陣亡音效",

["yuuri"] = "尤莉",
["&yuuri"] = "尤莉",
["#yuuri"] = "終末百合",
["designer:yuuri"] = "吉博茲",
["illustrator:yuuri"] = "百合度：★★★ (與千都)",
["~yuuri"] = "陣亡音效",

["anias"] = "阿妮艾斯",
["&anias"] = "阿妮艾斯",
["#anias"] = "百合王國劇團",
["designer:anias"] = "吉博茲",
["illustrator:anias"] = "本角色來自於百合端平行世界。",
["~anias"] = "陣亡音效",

["sofy"] = "蘇菲托萊特",
["&sofy"] = "蘇菲",
["#sofy"] = "不死百合",
["designer:sofy"] = "吉博茲",
["illustrator:sofy"] = "百合度：★☆☆",
["~sofy"] = "陣亡音效",

["elly"] = "愛莉",
["&elly"] = "愛莉",
["#elly"] = "不死百合",
["designer:elly"] = "吉博茲",
["illustrator:elly"] = "百合度：★☆☆",
["~elly"] = "陣亡音效",

["bloodymarry"] = "血腥瑪麗",
["&bloodymarry"] = "血腥瑪麗",
["#bloodymarry"] = "燦紅之百合",
["designer:bloodymarry"] = "吉博茲",

["yuri_ruyi"] = "熱血包-盧弈",
["&yuri_ruyi"] = "熱盧弈",
["#yuri_ruyi"] = "棋享佳才",
["designer:yuri_ruyi"] = "吉博茲",
["illustrator:yuri_ruyi"] = "木美人",
["~yuri_ruyi"] = "陣亡音效",

["yuri_jsunshangxiang"] = "熱血包-孫尚香",
["&yuri_jsunshangxiang"] = "熱孫尚香",
["#yuri_jsunshangxiang"] = "弓騎姬",
["designer:yuri_jsunshangxiang"] = "OL三國殺官方",
["~yuri_jsunshangxiang"] = "陣亡音效",

["yuri_guanyinping"] = "熱血包-關銀屏",
["&yuri_guanyinping"] = "熱關銀屏",
["#yuri_guanyinping"] = "武聖遺風",
["illustrator:yuri_guanyinping"] = "木美人",
["$yuri_wuji1"] = "我感受到了……父親的力量！",
["$yuri_wuji2"] = "我也要像父親那樣堅強！",
["~yuri_guanyinping"] = "父親，你來救我了嗎……",
["$yuri_xueji1"] = "這熾熱的鮮血，父親，你可感覺得到？",
["$yuri_xueji2"] = "大仇未報，還不能放棄！",
["$yuri_huxiao1"] = "取你首級，祭先父之靈！",
["$yuri_huxiao2"] = "虎父無犬女！",

["ys_lukang"] = "熱血包-陸抗",
["&ys_lukang"] = "熱陸抗",
["#ys_lukang"] = "社稷之瑰寶",
["illustrator:ys_lukang"] = "zoo",
["$ys_qianjie1"] = "繼父之節，謙遜恭畢。",
["$ys_qianjie2"] = "謙謙清廉德，節節卓爾茂。",
["$ys_jueyan1"] = "毀堰壩之計，實為阻晉糧道。",
["$ys_jueyan2"] = "堰壩毀之，可令敵軍自退。",
["$ys_jueyan3"] = "破羊祜之策，勢在必行。",
["$ys_jueyan4"] = "破晉軍分進合擊之勢，牽晉軍主力之實。",
["$ys_huairou1"] = "胸懷千萬，彰其德，包其柔。",
["$ys_huairou2"] = "各保分界，無求細利。",
--[[
--廢棄
["ys_zhangxiu"] = "熱血包-張繡",
["&ys_zhangxiu"] = "張繡",
["#ys_zhangxiu"] = "北地槍王",
["illustrator:ys_zhangxiu"] = "PCC",
["$ys_xiongluan1"] = "雄踞宛城，雖亂世可安。",
["$ys_xiongluan2"] = "北地梟雄，亂世不敗！",
["$ys_congjian1"] = "聽君諫言，去危亡，保宗祀！",
["$ys_congjian2"] = "從諫良計，可得自保。",
["~ys_zhangxiu"] = "若失文和，吾將何歸？",
]]
["yuri_zhoufei"] = "熱血包-周妃",
["&yuri_zhoufei"] = "熱周妃",
["#yuri_zhoufei"] = "軟玉溫香",
["illustrator:yuri_zhoufei"] = "眉毛子",
["$yuri_liangyin1"] = "結得良姻，固吳基業。",
["$yuri_liangyin2"] = "君恩之命，妾身良姻之福。",
["$yuri_kongsheng1"] = "窈窕淑女，箜篌友之。",
["$yuri_kongsheng2"] = "箜篌聲聲，琴瑟鳴鳴。",
["~yuri_zhoufei"] = "夫君，妾身再也不能，陪你看這江南翠綠了……",

["nulltopeta"] = "NULL&PETA",
["&nulltopeta"] = "努魯佩塔",
["#nulltopeta"] = "姊妹百合",
["designer:nulltopeta"] = "吉博茲",
["illustrator:nulltopeta"] = "百合度：★☆☆",
["~nulltopeta"] = "陣亡音效",

["gasaitoyuki"] = "由乃與雪輝",
["&gasaitoyuki"] = "由乃雪輝",
["#gasaitoyuki"] = "誠摯之戀",
["designer:gasaitoyuki"] = "吉博茲",
["~gasaitoyuki"] = "陣亡音效",

["tsuuitotina"] = "子瑜與蒂娜",
["&tsuuitotina"] = "子瑜蒂娜",
["#tsuuitotina"] = "競賽百合偶像",
["designer:tsuuitotina"] = "吉博茲",
["illustrator:tsuuitotina"] = "百合度：★★☆",
["~tsuuitotina"] = "陣亡音效",

["tsujimikadokuon"] = "土御門 九音",
["&tsujimikadokuon"] = "土御門九音",
["#tsujimikadokuon"] = "巫女姊妹百合",
["designer:tsujimikadokuon"] = "吉博茲",
["illustrator:tsujimikadokuon"] = "百合度：★★☆",
["~tsujimikadokuon"] = "陣亡音效",

["huukatoinori"] = "環楓花與翠田祈",
["&huukatoinori"] = "楓花與祈",
["#huukatoinori"] = "競賽巫女百合",
["designer:huukatoinori"] = "吉博茲",
["illustrator:huukatoinori"] = "百合度：★★★",
["~huukatoinori"] = "陣亡音效",

["rinnene"] = "林寧寧",
["&rinnene"] = "林寧寧",
["#rinnene"] = "內向資訊百合",
["designer:rinnene"] = "吉博茲",
["illustrator:rinnene"] = "百合度：★☆☆",
["~rinnene"] = "陣亡音效",

["asukatoyuu"] = "明日架與優",
["&asukatoyuu"] = "明日架與優",
["#asukatoyuu"] = "夕照下的真情",
["designer:asukatoyuu"] = "吉博茲",
["illustrator:asukatoyuu"] = "百合度：★★★",
["~asukatoyuu"] = "陣亡音效",

["eratosoniya"] = "艾拉與桑妮亞",
["&eratosoniya"] = "艾拉桑妮亞",
["#eratosoniya"] = "戰亂中的永恆",
["designer:eratosoniya"] = "吉博茲",
["illustrator:eratosoniya"] = "百合度：★★★",
["~eratosoniya"] = "陣亡音效",

["kamiyamasakuya"] = "神山咲夜",
["&kamiyamasakuya"] = "神山咲夜",
["#kamiyamasakuya"] = "不退轉的直達車",
["designer:kamiyamasakuya"] = "吉博茲",
["illustrator:kamiyamasakuya"] = "百合度：★★★",
["~kamiyamasakuya"] = "陣亡音效",

["hashirinio"] = "走鳰",
["&hashirinio"] = "走鳰",
["#hashirinio"] = "百合大會管",
["designer:hashirinio"] = "吉博茲",
["illustrator:hashirinio"] = "百合度：★★★",
["~hashirinio"] = "陣亡音效",

["mizushimakiyoi"] = "水島清衣",
["&mizushimakiyoi"] = "水島清衣",
["#mizushimakiyoi"] = "堅定不移的意志",
["designer:mizushimakiyoi"] = "吉博茲",
["illustrator:mizushimakiyoi"] = "百合度：★★☆",
["~mizushimakiyoi"] = "陣亡音效",

["sadoharamai"] = "佐渡原舞",
["&sadoharamai"] = "佐渡原舞",
["#sadoharamai"] = "白鶴報恩",
["designer:sadoharamai"] = "吉博茲",
["illustrator:sadoharamai"] = "百合度：☆☆☆",
["~sadoharamai"] = "陣亡音效",

["matsuobasho"] = "松尾芭蕉",
["&matsuobasho"] = "松尾芭蕉",
["#matsuobasho"] = "風流浪人",
["designer:matsuobasho"] = "吉博茲",
["illustrator:matsuobasho"] = "百合度：★★☆",
["~matsuobasho"] = "被東西打到。",

["miyoshikarin"] = "三好夏凜",
["&miyoshikarin"] = "三好夏凜",
["#miyoshikarin"] = "無雙勇者",
["designer:miyoshikarin"] = "吉博茲",
["illustrator:miyoshikarin"] = "百合度：★☆☆",
["~miyoshikarin"] = "我太難了",

["mirokuyumiko"] = "彌勒夕海子",
["&mirokuyumiko"] = "夕海子",
["#mirokuyumiko"] = "光宗耀祖",
["designer:mirokuyumiko"] = "吉博茲",
["illustrator:mirokuyumiko"] = "百合度：★☆☆",

["ainisutoyufi"] = "阿妮絲與尤菲",
["&ainisutoyufi"] = "阿妮絲尤菲",
["#ainisutoyufi"] = "王國之戀",
["designer:ainisutoyufi"] = "吉博茲",
["illustrator:ainisutoyufi"] = "百合度：★★★",

["murosakimiyo"] = "室崎美夜",
["&murosakimiyo"] = "室崎美夜",
["#murosakimiyo"] = "百合粉",
["designer:murosakimiyo"] = "吉博茲",
["illustrator:murosakimiyo"] = "百合度：？？？",

["yurinosakibasu"] = "百合夢寐",
["&yurinosakibasu"] = "百合夢寐",
["#yurinosakibasu"] = "百合夢寐_暫定",
["designer:yurinosakibasu"] = "吉博茲",
["illustrator:yurinosakibasu"] = "自創腳色那還用說",

["yuri_caocao"] = "熱血包-神曹操",
["&yuri_caocao"] = "熱神曹操",
["#yuri_caocao"] = "亂世奸雄",
["~yuri_caocao"] = "陣亡音效",
["designer:yuri_caocao"] = "吉博茲",

["yuri_yitandianwei"] = "熱血包-古之惡來",
["&yuri_yitandianwei"] = "熱古惡來",
["#yuri_yitandianwei"] = "壯志雄心",
["~yuri_yitandianwei"] = "陣亡音效",
["designer:yuri_yitandianwei"] = "吉博茲",

["@mana"] = "魔能",
["@pulse"] = "脈動",
["@female"] = "姬",
["@poison"] = "毒",
["@taichi"] = "太極",
["@defensive_distance_test"] = "+1標記",
["@cleverkon"] = "紺",
["@meiying"] = "魅影",
["@imperialjadeseal"] = "玉璽",
["@smoke"] = "霧",
["@hotfightmark"] = "炙灼",
["@wannawin"] = "好勝",
["@cupcake"] = "點心",
["@k-on"] = "輕音",
["@point"] = "點",
["@ys_jueyan"] = "圍堰",
["@sizukana_mark"] = "止水",
["@kiyoi_coin"] = "硬幣",
["@yuri_hengjiang"] = "百江",
["@SuperLimitBreak"] = "超界突破！",
["CardCountByDeepforest"] = "深林觸發",

["assistx"] = "百合",
[":assistx"] = "<font color=\"red\"><b>限定技，</b></font>摸完初始牌後你獲得<font color=\"#FF4500\"><b>“玉璽”</b></font>標記，你可以藉由消耗一個<font color=\"#FF4500\"><b>“玉璽”</b></font>來獲得一項百合包的特殊技能。此外，使用本技能<b>更換英雄、超界限突破</b>不會消耗標記。",
["changehand"] = "換手",
[":changehand"] = "替換主將，換上來的主將會呈現滿血狀態。",
["anotherhand"] = "協力",
[":anotherhand"] = "替換副將或呼喚副將，形成互助合作狀態，最大血量以雙將測量法計算。",
["purgatoryfire"] = "騷亂",
[":purgatoryfire"] = "你可以棄置一張牌指定一名目標對其造成一點火焰傷害，然後視為他隨機對身邊距離為一的對象打出一張殺，接著再換其對距離為一的目標打出一張殺，如此反覆一直到殺五次或無法繼續為止。(你不會成為此殺的對象。)",
["godbow"] = "神弓",
[":godbow"] = "你的殺不能被閃避。當你以殺造成傷害時，你可以令其增加你<font color=\"#FF4500\"><b>攻擊距離與損失生命量</b></font>的傷害。",
["$godbow_log"] = "%from 發動“%arg”的效果，%card 的傷害量增加 %arg2 ",
["bffeedingpoisoning"] = "餵毒",
[":bffeedingpoisoning"] = "每當你對其、其對你距離為一的角色造成傷害時，你可以防止此傷害，令其獲得傷害量的“毒”標記。持有毒標記的目標手牌每減少一張，其棄置一點毒標記並失去一點體力，你摸一张牌。",
["#itmine_log"] = "將被影響的卡為 %card 。",
["#itmine_log2"] = "將被影響的卡為 %card 、",
["#itmine_log3"] = " %card 、",
["#itmine_log4"] = " %card 。",
["itmine"] = "獨佔",
[":itmine"] = "<font color=\"blue\"><b>鎖定技，</b></font><font color=\"#FF4500\"><b>回合外</b></font>，除非<font color=\"#FF4500\"><b>使用、打出、結束階段棄牌</b></font>，否則你的牌之移動都會被<font color=\"#FF4500\"><b>取消</b></font>。",
["#bh_x_log"] = "%from 讓 %to 下去休息，換 %arg 上來。",
["bh_x"] = "王令",
[":bh_x"] = "你可以令指定的目標替換英雄，在替換後將把生命值恢復至全滿，然後你可以選擇是否繼續替換，否則失去標記與技能。",
["yuri_jianchu"] = "鞬出",
[":yuri_jianchu"] = "當你使用【殺】指定一個目標後，你可以棄置其一張牌，若之：為裝備牌，其不能使用【閃】響應此【殺】；不為裝備牌；其獲得此【殺】。",
["getSuperLimitBreak"] = "界限突破",
[":getSuperLimitBreak"] = "讓選擇的角色界限突破，不會失去玉璽標記。百合包中，僅技能說明裡有標示【超界突破】的角色有效。",

["independent"] = "獨當",
[":independent"] = "<font color=\"purple\"><b>覺醒技。</b></font>回合開始階段若你<font color=\"#FF4500\"><b>裝備數量大於等於手牌</b></font>，你棄置所有裝備和<font color=\"#FF4500\"><b>判定區</b></font>的牌，然後摸棄置量+2的牌、失去本技能並失去一點體力上限獲得<font color=\"red\"><b>“亂武”、“焚城”、“間書”、“奮威”、“雄異”</b></font>，同時額外獲得三點間書標記。",
["$nonowake"] = "請看著我的成長，妮娜老師！",
["machiko"] = "松子",
-- [":machiko"] = "<font color=\"blue\"><b>鎖定技，</b></font>你受到傷害時必須棄置一張手牌來免疫即將受到的傷害。若你已<font color=\"purple\"><b>覺醒</b></font>，你可以棄置裝備區或判定區的牌，也能<font color=\"#FF4500\"><b>決定</b></font>是否要發動此技能，如果你否定，對方必須棄置一張<font color=\"#FF4500\"><b>紅心</b></font>手牌否則令你選擇一項，使其棄置所有裝備或棄置所有手牌。",
[":machiko"] = "<font color=\"blue\"><b>鎖定技，</b></font>你受到傷害時必須棄置一張手牌來免疫即將受到的傷害。若你已<font color=\"purple\"><b>覺醒</b></font>，你可以棄置裝備區或判定區的牌，也能<font color=\"#FF4500\"><b>決定</b></font>是否要發動此技能，如果你否定，你可以選擇獲得一點<font color=\"#FF4500\"><b>雄異或奮威</b></font>標記，你獲得雄異標記時必須<font color=\"#FF4500\"><b>流失</b></font>一點體力。",
["LuaRevenge"] = "雪恥",
[":LuaRevenge"] = "<font color=\"blue\"><b>鎖定技，</b></font>你有25%的機會使<font color=\"#FF4500\"><b>傷害翻倍</b></font>，你每失去一點體力，翻倍機率提升25%。若<font color=\"#FF4500\"><b>爆擊發動</b></font>，你可以讓受傷者或你摸該<font color=\"#FF4500\"><b>傷害數量乘與X</b></font>張牌。(若摸牌者不是你，X視為2，否則為1)",
["#Revenge_log"] = " %from 的 %arg 效果，%to 造成的傷害化為<font color=\"orange\"><b>0</b></font>。",
["#Revenge_log2"] = "<font color=\"orange\"><b>爆擊！</b></font> %from 的技能 %arg2 發動，傷害量增幅為 %arg 點。",
["itsmine"] = "自己摸牌",
["giveyou"] = "傷者摸牌",
["losehp"] = "失去生命",
["losequip"] = "棄裝備",
["LuaZhenlie"] = "忠貞",
[":LuaZhenlie"] = "當你成為<font color=\"#FF4500\"><b>殺</b></font>或<font color=\"#FF4500\"><b>非延時錦囊牌</b></font>的目標時，你可以令此牌對你無效并選擇一項1.<font color=\"#FF4500\"><b>失去一點體力並棄置一張牌</b></font>然後獲得使用者一張牌，視為對使用者使用一張不限距離的<font color=\"#FF4500\"><b>火殺</b></font>(<font color=\"#FF4500\"><b>無視</b></font>不能被殺指定的效果。例：空城)，之後你不能受到任何傷害直到回合結束2.棄置一張牌然後<font color=\"#FF4500\"><b>棄置</b></font>使用者一張牌。",
["@LuaZhenlie-slash"] = "請使用一張殺，若取消則獲得對手一張牌。",
["~JSPwonyi"] = "吾之家仇，何日得報？",

["PoisonMaggots"] = "蟲主",
["poisonmaggots"] = "蟲主",
[":PoisonMaggots"] = "<font color=\"blue\"><b>鎖定技，</b></font>你的手牌上限永遠+2。出牌階段你可以使用<font color=\"#FF4500\"><b>紅色錦囊牌或裝備牌</b></font>作為“蛆蟲”寄生在目標身上，單目標最多<font color=\"#FF4500\"><b>兩隻</b></font>。被寄生的目標準備階段開始前，會先進行蛆蟲的行動階段。蛆蟲分為三種行動──<font color=\"green\"><b>1.召回</b></font>：拿回目標身上全部蛆蟲卡，並奪走其X張的判定卡、裝備卡、手牌，若目標沒有牌，則帶回X點體力(視為雷電傷害)(X為拿走的蛆蟲卡數)。若<font color=\"#FF4500\"><b>兩隻</b></font>蛆蟲帶回的都是<font color=\"#FF4500\"><b>卡片</b></font>，則你損失一點體力。<font color=\"green\"><b>2.阻害目標</b></font>：讓蛆蟲停留在目標身上，每有一隻其手牌上限-1，若該目標對你造成傷害，他必定棄置X隻蛆蟲並減少X點傷害(傷害扣至零為止)<font color=\"#FF4500\"><b>(該選項會棄置目標“友”標記)</b></font>。<font color=\"green\"><b>3.輔助同伴</b></font>：目標獲得一點“友”標記，每有一隻蛆蟲令他手牌上限+1，若其受到傷害，必定棄置X隻蛆蟲並減少X點傷害(傷害扣至零為止)。",
["Maggots"] = "蛆蟲",
["callback"] = "召回",
["staythere"] = "●- 阻害目標",
["staythereforAlly"] = "○- 輔助同伴",
["#PoisonMaggotsChoiceLog1"] = " %arg 選擇了令蛆蟲停留在 %from 身上加害他。",
["#PoisonMaggotsChoiceLog2"] = " %arg 選擇了令蛆蟲停留在 %from 身上保護他。",
["#PoisonMaggotsChoiceLog3"] = " %arg 選擇了喚回 %from 身上的蛆蟲！",
["#MaggotsShield_log"] = "蛆蟲 %card 抵擋了從 %from 對 %to 的一點傷害，剩餘 %arg 點傷害。",
["#PoisonMaggotsLogKillself"] = " %from 犧牲了一點生命餵食辛苦的蟲蟲們。 ",
["#PoisonMaggotsLogGetCard"] = "%card 蛆蟲帶了一張卡回來。",
["#PoisonMaggotsLogGetHP"] = "%card 蛆蟲帶回了一點生命。",
["maggotsavethelord"] = "歸巢",
[":maggotsavethelord"] = "<font color=\"red\"><b>絕技</b></font>──<font color=\"green\"><b>〔使用條件</b></font>：場上有<font color=\"#FF4500\"><b>大於一半</b></font>的角色遭到蛆蟲寄生。<font color=\"green\"><b>〕</b></font>你<font color=\"#FF4500\"><b>瀕死</b></font>時，場上每有一名被寄生者你回復一點體力，被寄生者丟棄一張蛆蟲牌並受到一點雷電傷害。若其有“友”標記，則不受傷害。",
["$wangzouenmasterskill"] = "我不會死的...母親，在與妳重逢之前。",
["#backhome"] = "呼喚在四周的蛆蟲攜帶血肉返回！",
["maggotschagelife"] = "血擁",
[":maggotschagelife"] = "<font color=\"green\"><b>階段技，</b></font>你可以丟棄兩張以上的基本卡，棄置擁有<font color=\"#FF4500\"><b>兩枚蛆蟲</b></font>且<font color=\"#FF4500\"><b>距離一以內</b></font>的目標所有裝備卡與手牌，並造成其手牌、裝備數(棄置前)一半(向下取整)加上你棄牌數的火焰傷害。之後<font color=\"#FF4500\"><b>你損失自己所棄牌數的生命</b></font>。",
["liketoask"] = "好知",
[":liketoask"] = "<font color=\"#FF4500\"><b>1.</b></font>除自己之外任意目標打出或使用一張牌時，選一張同種類型的牌給予指定之目標。<font color=\"#FF4500\"><b>2.</b></font>自己受到傷害。以上只要達成其中一點，你從牌堆上方獲得一張或傷害數量的<font color=\"#FF4500\"><b>“E知識”</b></font>置於武將牌上，你可以於合理時機使用該牌，<font color=\"#FF4500\"><b>最多六張</b></font>。達最大數仍新增“E知識”時，你獲得一張既有的“E知識”。當你的E知識到達<font color=\"#FF4500\"><b>三張</b></font>，你可以使用技能<font color=\"brown\"><b>【用學】</b></font>(你<font color=\"#FF4500\"><b>不新增E知識</b></font>。丟棄一張“E知識”令目標使用的牌無效(目標不能是自己)。",
["@liketoask"] = "要使用技能“好知”嗎？",
["liketoask_choiceplayer"] = "選擇一名要給予牌的目標",
["@advice_nolearn"] = "用學",
["&learned"] = "E知識",
["goddess"] = "神樂",
-- [":goddess"] = "<font color=\"blue\"><b>鎖定技，</b></font>X大於三時，判定不可更改，掀開判定牌前，你必須選一張“E知識”放置於牌堆頂並翻開牌堆上X張卡，以任意順序排列於牌堆頂或牌堆底，然後你摸一张牌。(X為<font color=\"#FF4500\"><b>技能發動前</b></font>“E知識”的數量)",
[":goddess"] = "<font color=\"blue\"><b>鎖定技，</b></font>判定不可更改，掀開判定牌前你可以翻開堆頂五張牌任意排列，然後你摸一张牌。",
["#nolearn_log"] = " %arg 技能發動， %from 的 %card 被無效化。",
["#gd_log"] = "進入判定階段， %from 的技能 %arg 發動。",
["#gdnr_log"] = "受 %from 的 %arg 效果影響，本次判定不能被更改。",
["awayfromthemundane"] = "離塵",
[":awayfromthemundane"] = "<font color=\"blue\"><b>鎖定技，</b></font>E知識數量小於三時，你不會成為決鬥、順手牽羊、過河拆橋的目標。",
["#liketoask_log"] = "%from 欲使用 %card 。",
["miyadokyo"] = "都鄉",
[":miyadokyo"] = "<font color=\"blue\"><b>鎖定技，</b></font>當你沒有<font color=\"#FF4500\"><b>“好知”</b></font>標記，你不是其他人使用的<b>單體</b><font color=\"#FF4500\"><b>非延時</b></font>錦囊牌的合法目標。當你使用<b>錦囊牌</b>後，你獲得一枚<font color=\"#FF4500\"><b>“好知”</b></font>標記(至多為<font color=\"#FF4500\"><b>當前生命數</b></font>)。當你成為一名其他角色使用<b>錦囊牌</b>的目標，你失去一枚<font color=\"#FF4500\"><b>“好知”</b></font>標記。當你成為<b>團體錦囊</b>的目標時，做一次判定，若為<b>黑色</b>，則你<font color=\"#FF4500\"><b>再度成為</b></font>目標，若為<font color=\"red\"><b>紅色</b></font>，你<font color=\"#FF4500\"><b>取消</b></font>該目標。",
["@goddess-put"] = "請選擇一張牌置於牌堆頂。",
["goddess_new"] = "神樂",
[":goddess_new"] = "<font color=\"blue\"><b>鎖定技，</b></font>場上<font color=\"#FF4500\"><b>判定不可被更改</b></font>。當需要判定時，你摸一张牌，然後可以將一張牌置於<b>堆頂</b>。",
["magictrick"] = "魔通",
[":magictrick"] = "<font color=\"lightcoral\"><b>遊戲開始你獲得三點魔能。</b></font>場上的雷殺不能被閃避，當雷電傷害發生時，你可以將其轉化為魔能(<font color=\"#FF4500\"><b>除非</b></font>自己是來源的且受害者不是自己)，當其他角色的<font color=\"#FF4500\"><b>雷殺</b></font>或<font color=\"#FF4500\"><b>閃電</b></font>因棄置或判定而進入棄牌堆時，你獲得之。<font color=\"blueviolet\"><b>出牌階段，</b></font>你可以重鑄所有雷殺、閃電，每張獲得一點魔能，而閃電可以獲得三點。<font color=\"green\"><b>開始階段以及結束階段，</b></font>你可以發動不同的魔法，除了名字帶有<font color=\"#FF4500\"><b>“連鎖”</b></font>的魔法，其餘<font color=\"#FF4500\"><b>負面</b></font>法術目標不能是自己，自己也不受影響。\
名稱前帶有星號★的法術，為回合開始才能施放，反之為回合結束才能施放。\
<font color=\"#FF4500\"><b>致命連鎖</b></font>：失去一點魔能，你橫置或重置一到六名目標。\
<font color=\"royalblue\"><b>★寒冰爆</b></font>：失去一點魔能，你令一名目標翻面，計算目標與其他角色距離小於一者會受波及。\
<font color=\"red\"><b>火球術</b></font>：失去兩點魔能，你對目標造成兩點火焰傷害。\
<font color=\"#00AAAA\"><b>連鎖閃電</b></font>：失去兩點魔能，你對目標與其下兩家造成一點雷電傷害，每電一次你摸一张牌，電擊不會觸發非鎖定技。\
<font color=\"green\"><b>★療癒波</b></font>：失去兩點魔能，你選擇一至三名目標各回復一點生命。若只選擇一位則回復量<font color=\"#FF4500\"><b>加倍</b></font>，此情況下目標只損失一點體力時，你<font color=\"#FF4500\"><b>獲得一點魔能</b></font>。",
["~magictrick"] = "取消不會失去魔能。",
["@do_magic_FireBall"] = "選一名目標對他造成兩點火屬傷害。",
["@do_magic_FatalChain"] = "選一到六名目標橫置或重置。",
["@do_magic_FrostNova"] = "選一名目標翻面，計算目標距離其他角色的距離小於一者會受波及。",
["@do_magic_HealingWave"] = "選一至三名目標恢復一點生命，指定單一目標有倍化效果，少恢復的生命會轉為魔能。",
["@do_magic_ChainLightning"] = "選一名目標，對目標與其下兩家之目標造成一點雷屬性傷害，每電一次可以摸一张牌，該傷害不會觸發非鎖定技。",
["FireBall"] = "火球術",
[":FireBall"] = "對一目標造成兩點火屬傷害，本技能的傷害對你無效。",
["FatalChain"] = "致命連鎖",
[":FatalChain"] = "橫置或重置一到六名目標，你可以是本技能的對象。",
["FrostNova"] = "寒冰爆",
[":FrostNova"] = "令一名目標翻面，計算目標距離其他角色的距離小於一者會受波及，你不受影響。",
["HealingWave"] = "療癒波",
[":HealingWave"] = "令一至三名目標恢復一點生命，指定單一目標有倍化效果，少恢復的生命會轉為魔能。",
["ChainLightning"] = "連鎖閃電",
[":ChainLightning"] = "對目標與其下兩家之目標造成一點雷屬性傷害，你會受到本技能的影響，每電一次可以摸一张牌，該傷害不會觸發非鎖定技。",
["#sizhanfort_nodamage"] = " %from 技能 %arg 被觸發，本次傷害被吸收化為 %arg2 點魔能。",
["#sizhanfort_nodamage2"] = "然而 %arg 的傷害對 %from 毫無影響。",
["#HealingWaveUsed"] = " %from 使用了<font color=\"aqua\"><b>療癒波</b></font>！",
["#FatalChainUsed"] = " %from 使用了<font color=\"orange\"><b>致命連鎖</b></font>！",
["#FrostNovaUsed"] = " %from 使用了<font color=\"lightskyblue\"><b>寒冰爆</b></font>！",
["#FireBallUsed"] = " %from 使用了<font color=\"gold\"><b>火球術</b></font>！",
["#ChainLightningUsed"] = " %from 使用了<font color=\"#AFEEEE\"><b>連鎖閃電</b></font>！",

["#remove_equip_area"] = " %from <font color=\"red\"><b>禁止</b></font>裝備 %arg 系列的裝備。",
["breakingSeal"] = "格鬥",
["breakingseal"] = "格鬥",
[":breakingSeal"] = "回合中你可以禁止裝備某系列裝備並失去一點體力來獲得特殊能力，若一回合內使用<font color=\"#FF4500\"><b>超過一次</b></font>，則失去<font color=\"#FF4500\"><b>兩點</b></font>體力。能力維持到下次你的回合。回合開始時若你禁止了所有裝備，你失去該技能並<font color=\"#FF4500\"><b>恢復所有體力</b></font>。\
<b>武器欄</b>：你的殺與決鬥傷害+1，你的殺和決鬥令目標的裝備、非鎖定技無效至下次你的回合開始。\
<b>防具欄</b>：你回復兩點生命，接下來你不會受到傷害。你可以令來源不是你的回復效果-1。\
<b>防禦馬</b>：你回復兩點生命、摸一张牌，你不是順手牽羊、殺和延時錦囊的合法目標。\
<b>進攻馬</b>：你的殺無視距離、必定命中，且可以額外指定2人成為目標。\
<b>寶物欄</b>：摸2X張牌(X為你<font color=\"#FF4500\"><b>損失的體力</b></font>)，你跳過棄牌階段。",
[":weapon"] = "令殺與決鬥傷害+1，並使目標的裝備、非鎖定技無效至下次你的回合開始。",
[":armor"] = "回復兩點生命，接下來不會受到傷害。你可以令來源不是你的回復效果-1。",
[":defensive_horse"] = "回復兩點生命、摸一张牌，你不是順手牽羊、殺和延時錦囊的合法目標。",
[":offensive_horse"] = "令殺無視距離、必定命中，且可以額外指定2人成為目標。",
[":treasure"] = "摸X+2張牌(X為你損失的體力)，並跳過棄牌階段。",
["nomorerec"] = "回復效果-1",	
["#bs_wab1"] = "受 %from 的<font color=\"gold\"><b>修練-武器</b></font>影響，攻擊傷害<font color=\"salmon\"><b>+1</b></font>。",
["#bs_wabi"] = "受 %from 的<font color=\"gold\"><b>修練-防具</b></font>影響，本次傷害被<font color=\"khaki\"><b>無效化</b></font>。",
["#bs_wabr"] = "受 %from 的<font color=\"gold\"><b>修練-防具</b></font>影響，本次恢復效果<font color=\"salmon\"><b>-1</b></font>。",

["changesexual"] = "性轉",
["@changesexual"] = "要改變性別嗎？",
[":changesexual"] = "你可以改變性別。<font color=\"blue\"><b>鎖定技，</b></font>於回合外，每使用一張基本牌或錦囊牌時，摸一张牌，然後你能改變性別。",
["#changesexual_toboy"] = " %from 將性別換成<font color=\"lightskyblue\"><b>男性</b></font>了！",
["#changesexual_togirl"] = " %from 將性別換成<font color=\"pink\"><b>女性</b></font>了！",
["sexualadvantage"] = "雙武",
[":sexualadvantage"] = "當妳是<font color=\"palevioletred\"><b>女性</b></font>時，殺、順手牽羊無視距離，你可以用不為閃的紅牌當閃，當你是<font color=\"royalblue\"><b>男性</b></font>時，你可以用<font color=\"#FF4500\"><b>裝備牌</b></font>當殺，此殺令目標<font color=\"#0066FF\"><b>防具</b></font>與<font color=\"chocolate\"><b>所有技能</b></font>失效到其回合開始。",

["semeruki"] = "強勢",
[":semeruki"] = "你的殺被閃抵銷時，你可以获得其<font color=\"#FF4500\"><b>裝備區內的一張牌</b></font>。<font color=\"#E88114\"><b>天生技，</font></b>其他人與你的距離減少X。(X為“拳脈”牌的數量。)",
["pulsepile"] = "拳脈",
["clearthemeridians"] = "捷拳",
["clearthemeridians_fc"] = "捷拳",
["~clearthemeridians_fc"] = "你可以取消，但還是會消耗脈動印記",
[":clearthemeridians"] = "<font color=\"lightcoral\"><b>遊戲開始</b></font>，你摸三張牌視為“拳脈”，選出其中兩張置於手牌。你可以將你的裝備牌放在武將牌上視為“拳脈”(最多三張)，每當獲得或失去一張“拳脈”，你獲得一個“脈動”印記，當脈動印記<font color=\"#FF4500\"><b>達到五點</b></font>即清空標記，視作使用一張基本卡且<font color=\"#FF4500\"><b>不算入次數限制</b></font>。“拳脈”可以當作酒、殺、閃<font color=\"#FF4500\"><b>使用或打出</b></font>。",
["@use_card_slash"] = "請選擇“殺”的對象。",
["@use_card_thunder_slash"] = "請選擇“雷殺”的對象。",
["@use_card_fire_slash"] = "請選擇“火殺”的對象。",
["@use_card_peach"] = "是否用桃？",
["@use_card_analeptic"] = "是否用酒？",
["@use_card_duel"] = "請選擇“決鬥”的對象。",
["@use_card_snatch"] = "請選擇“順手牽羊”的對象。",
["@use_card_dismantlement"] = "請選擇“過河拆橋”的對象。",
["@use_card_collateral"] = "請選擇“借刀殺人”的對象。",
["@use_card_iron_chain"] = "請選擇“鐵鎖連環”的對象。",
["@use_card_fire_attack"] = "請選擇“火攻”的對象。",

["helptheweak"] = "扶弱",
[":helptheweak"] = "你可以選擇兩張<font color=\"#FF4500\"><b>不同顏色</b></font>的手牌，令場上一名受傷且體力和手牌<font color=\"#FF4500\"><b>不大於</b></font>你的目標獲得(若目標是自己則<font color=\"#FF4500\"><b>棄置</b></font>並摸一张牌)、恢復一點體力。<b>【超界突破】</b>：目標是其他人時也可以摸牌。",
["goodatwep"] = "擅武",
[":goodatwep"] = "你可以將任意於攻擊範圍內目標的一張牌置於其武將牌上，你的回合結束後目標取回(對同一個目標只能<font color=\"#FF4500\"><b>使用一次</b></font>)。若你對目標<font color=\"#FF4500\"><b>造成傷害</b></font>，你<font color=\"#FF4500\"><b>獲得該牌</b></font>。發動時若目標有武器而你沒有，你可失去一點體力來獲得其武器。<b>【超界突破】</b>：若妳已受傷，則不失去體力。",
["goodatwepile"] = "擅武移出",
["gogetit"] = "失去體力並獲得目標武器",

["goldentear"] = "魔淚",
["$goldentear1"] = "我絕對不會逃，絕對不會逃跑的。",
["$goldentear2"] = "讓我治好他的傷病，我就會待在你身邊。",
[":goldentear"] = "<font color=\"red\"><b>限定技，</b></font>當一名角色瀕臨死亡，妳可以棄置X張黑牌令其恢復X點體力。",
["gdancer"] = "舞孃",
["$gdancer1"] = "想看在天空發亮的天燈~hay",
["$gdancer2"] = "追那個壞蛋追累了對吧！",
[":gdancer"] = "妳成為<font color=\"#FF4500\"><b>非延時錦囊</b></font>或<font color=\"#FF4500\"><b>殺</b></font>的目標時，可以進行一次判定，若為黑色，妳摸X張牌(X為妳失去的生命+1，最多為三)，若為紅色，妳成為該卡的使用者(<font color=\"#FF4500\"><b>此卡視為無色卡</b></font>)。",
["~gdancer"] = "你成為本卡片的使用者，可以取消之。",
["gdancercard"] = "舞孃",

["healingwater"] = "癒流",
[":healingwater"] = "<font color=\"green\"><b>階段技，</b></font>你可以<font color=\"#FF4500\"><b>獲取</b></font>至多兩人的手牌、裝備直至其裝備與手牌之和等於<font color=\"#FF4500\"><b>你的當前生命</b></font>(對每個目標以此法獲得的牌至多<font color=\"#FF4500\"><b>五張</b></font>)，若其裝備與手牌之和<font color=\"#FF4500\"><b>小於</b></font>你，則令其摸<font color=\"#FF4500\"><b>你當前生命量</b></font>的牌。(不能指定自己)",
["waterfairy"] = "水靈",
[":waterfairy"] = "<font color=\"blue\"><b>鎖定技，</b></font><b>1.</b>你不會受到火焰傷害，<b>2.</b>你的手牌上限為<font color=\"#FF4500\"><b>當前生命兩倍</b></font>。棄牌階段開始，你可以<font color=\"#FF4500\"><b>放棄第二效果</b></font>並棄置一張紅心牌來恢復一點體力。",
["@waterfairymc"] = "請選擇是否要棄置紅心一張紅心牌來恢復體力，並放棄手牌上限能力。",

["peeking"] = "窺視",
["peekingcard"] = "窺視",
["$peeking_log"] = " %from 對 %to 手牌的猜測為 %arg 。",
[":peeking"] = "<font color=\"green\"><b>階段技，</b></font>你宣言一種牌類，展示一名其他角色手牌。若其被以此法<font color=\"#FF4500\"><b>棄置四張牌以上</b></font>，其失去所有技能。\
<b>基本牌</b>：你摸一張牌。若其基本牌數量<font color=\"#FF4500\"><b>三張以上</b></font>，你棄置其所有基本牌。\
<b>錦囊牌</b>：你棄置目標所有錦囊牌，若棄置<font color=\"#FF4500\"><b>兩張以上</b></font>，其<font color=\"#FF4500\"><b>流失一點</b></font>體力。\
<b>裝備牌</b>：你棄置其手牌中所有裝備，每棄置一張你棄置其<font color=\"#FF4500\"><b>裝備區</b></font>一張牌。",
["countertrick"] = "反制",
[":countertrick"] = "你可以將非基本牌和無懈可擊以外的牌視作無懈可擊使用。使用無懈可擊時，若你的手牌是全場最少(或之一)，你摸一張牌。",
["warlike"] = "好戰",
["warliked"] = "好戰",
[":warlike"] = "你可以將一張錦囊牌當決鬥使用，若你這麼做，回合結束階段你摸<font color=\"#FF4500\"><b>你已损失的体力值</b></font>+1張牌，該回合你獲得技能<font color=\"brown\"><b>【血鬥】</b></font>：除了決鬥之外的手牌皆視為<font color=\"#FF4500\"><b>雷殺</b></font>，你的殺上限增加你失去的生命。<b>【超界突破】</b>：因此方法被決鬥的目標，會令其所有技能失效，直到你的回合結束。",
["bloodfight"] = "血鬥",
[":bloodfight"] = "除了決鬥之外的手牌皆視為<font color=\"#FF4500\"><b>雷殺</b></font>，你可额外使用 你已损失的体力值 张【杀】。",
["arkora"] = "弧光",
[":arkora"] = "你的殺與決鬥指定目標時，你可以令其棄置一張手牌。若為<font color=\"#FF4500\"><b>裝備卡</b></font>，對方必須打出一張<font color=\"#FF4500\"><b>閃</b></font>，否則受到一點傷害。",
["@arkoraask"] = "打出一張閃，否則受到一點傷害。",
["#kurashi_log"] = "%from 本回合“ %arg ”花色的手牌不列入棄牌計算。",
["kurashinfurashu"] = "碎閃",
[":kurashinfurashu"] = "<font color=\"green\"><b>階段技，</b></font>選擇一名目標棄置其一張手牌，本回合與該牌<b>同花色</b>的手牌不計入你的手牌數量。若該牌為<font color=\"pink\"><b>【桃】</b></font>或<b>【酒】</b>，妳可以選擇一名角色，視為對其使用(<font color=\"#FF4500\"><b>不算入次數限制</b></font>)。若非，且其手牌加裝備數量<font color=\"#FF4500\"><b>大於等於</b></font>你的持有數時，其流失1點生命。",
["crushingimpact"] = "碎沖",
[":crushingimpact"] = "<font color=\"green\"><b>階段技，</b></font>棄置一張手牌發動，選擇一名目標翻開牌堆上<font color=\"#FF4500\"><b>一張牌</b></font>。每有一張：<b>裝備牌</b>，對方棄置所有裝備，受到來自於你的X點傷害(X為對方裝備數量，最少為一)；<b>錦囊牌</b>，妳獲得該牌；<b>基本牌</b>，對方流失一點生命。(目標不能是自己)此外，在碎沖翻牌前，發動<font color=\"#FF4500\"><b>五張牌</b></font>的觀星。",
["optimistic"] = "無阻",
[":optimistic"] = "<font color=\"blue\"><b>鎖定技，</b></font>你不是<font color=\"#FF4500\"><b>延時錦囊</b></font>的合法目標。每當你<font color=\"#FF4500\"><b>翻面或橫置</b></font>時，取消之並摸一張牌。當你的手牌加裝備數<font color=\"#FF4500\"><b>大於</b></font>生命值，且<b>當前生命值為一</b>時，所有<font color=\"#FF4500\"><b>傷害類</b></font>卡片的指定與<font color=\"#FF4500\"><b>傷害</b></font>對你無效。【超界突破】：受到超過一點的傷害時，無效之。",
["optimistic_invoke"] = "選擇一個目標代替你受影響。可以取消。",
["trapva"] = "陷阱",
["trap"] = "陷阱", 
[":trapva"] = "你可以將裝備以外的牌，置於<font color=\"#FF4500\"><b>自己以外</b></font>目標的武將牌上稱為“機關”，每名目標至多<font color=\"#FF4500\"><b>三張</b></font>。若目標使用的手牌與其機關牌堆<font color=\"#FF4500\"><b>第一張</b></font>相同牌類，目標使用的牌無效。若非閃你摸一張牌，若為錦囊牌你獲得該牌。",
["taichi"] = "剋剛",
["taichi_disjugde"] = "剋剛-棄置判定區",
[":taichi"] = "當你成為<font color=\"#FF4500\"><b>殺</b></font>或<font color=\"#FF4500\"><b>錦囊牌</b></font>的目標，你可以棄置一張牌(可以棄置<font color=\"#FF4500\"><b>判定區</b></font>的牌)和一個“太極”標記並摸兩張牌。其他角色的回合結束，若你<font color=\"#FF4500\"><b>成為目標過</b></font>，你獲得一個“太極”標記。",
["trappile"] = "機關",
["#trapEffect"] = "%from 的技能“%arg2”被觸發，%to 的【%arg】被無效化。",
["$trapva1"] = "天網恢恢，疏而不漏。",
["$trapva2"] = "誰敢再前進一步！",
["$trapva3"] = "我擋！",
["$taichi1"] = "喝啊！",
["$taichi2"] = "以柔克剛。",
["sincere"] = "篡奪",
[":sincere"] = "<font color=\"green\"><b>階段技，</b></font>你可以失去一項技能，然後<font color=\"purple\"><b>奪取</b></font>場上一名目標的技能(這意味著目標將<font color=\"#FF4500\"><b>失去技能</b></font>)，然後你恢復1點體力並摸1張牌，若你沒受傷，摸兩張牌。如果對象沒技能，你<font color=\"#FF4500\"><b>不失去</b></font>技能。",
["bh"] = "同化",
[":bh"] = "<font color=\"red\"><b>限定技，</b></font>若除了你之外，場上還有<font color=\"#FF4500\"><b>三名以上</b></font>角色存活，你可以失去一枚焚標記，將場上一名對象的身分改為<font color=\"orange\"><b>忠臣</b></font>、<font color=\"green\"><b>反賊</b></font>或<font color=\"blue\"><b>內奸</b></font>，對<font color=\"#FF4500\"><b>主公無效</b></font>。",
["frankly"] = "坦腹",
[":frankly"] = "<font color=\"green\"><b>階段技，</b></font>你可以選擇一名其他角色，你展示所有手牌並棄置其中一種花色，之後你棄置其区域内X張牌或令其摸X張牌，你獲得X個+1標記。X為你棄置<font color=\"#FF4500\"><b>該花色</b></font>牌的數量。",
["flexible"] = "與共",
[":flexible"] = "你的<font color=\"#FF4500\"><b>殺</b></font>、<font color=\"#FF60AF\"><b>桃</b></font>或<font color=\"#FF4500\"><b>非延時</b></font>錦囊牌可以額外指定至多X名目標，同時減少至多X名目標。X為+1標記數量。回合結束時你棄置所有+1標記，若+1標記數量<font color=\"#FF4500\"><b>大於</b></font>你的手牌數，你摸<font color=\"#FF4500\"><b>差距</b></font>的牌。",
["@flexiblelog"] = "選擇額外或再次受到影響的目標。",
["@flexiblelog2"] = "選擇不受影響的目標。",
["~flexible"] = "你可以取消以放棄選擇免疫的目標或額外的目標。",
["foxnature"] = "狐性",
[":foxnature"] = "<font color=\"blue\"><b>鎖定技，</b></font>當你的判定牌為黑色牌時，獲得那張牌並重新做一次判定，直到你的<font color=\"#FF4500\"><b>判定牌</b></font>不為<b>黑色</b>前，你<font color=\"#FF4500\"><b>重複</b></font>這個流程。當你受到卡牌影響時，根據牌色觸發以下效果：\
<b>黑色</b>：你<font color=\"#FF4500\"><b>獲得</b></font>那張牌，但目標<font color=\"#FF4500\"><b>不取消</b></font>。\
<font color=\"red\"><b>紅色</b></font>：進行一次判定，若為<font color=\"red\"><b>紅心</b></font>則獲得之。",
["clever"] = "榮智",
[":clever"] = "<font color=\"green\"><b>階段技，</b></font>你可以將一張牌置於你的武將牌上視為<font color=\"#FF4500\"><b>學識牌</b></font>，並獲得<font color=\"#FF4500\"><b>失去生命</b></font>數量+2的<font color=\"#FF4500\"><b>紺標記</b></font>。在你需要時，可以將任意手牌視為該牌使用或打出，每次使用本技能都必須消耗一點<font color=\"#FF4500\"><b>紺標記</b></font>，但是你不能以此方法使用酒、五穀豐登、無中生有、鐵索連環、<font color=\"#FF4500\"><b>任意裝備</b></font>。你的<font color=\"#FF4500\"><b>回合開始</b></font>時你失去學識牌並將<font color=\"#FF4500\"><b>紺標記</b></font>設為1。",
["clevercards"] = "學識",
["lovesweet"] = "貪甜",
[":lovesweet"] = "<font color=\"blue\"><b>鎖定技，</b></font>你的<font color=\"red\"><b>紅心</b></font>牌於棄牌階段時不列入計算。場上除了你之外的角色使用<font color=\"#FF60AF\"><b>桃</b></font>時，你獲得<font color=\"red\"><b>1+失去生命</b></font>數量的<font color=\"#FF4500\"><b>狂怒標記</b></font>。若你已擁有<font color=\"#FF4500\"><b>“神噬”</b></font>或<font color=\"#FF4500\"><b>“狂吞”</b></font>，則改為失去一點<font color=\"#FF4500\"><b>狂怒標記</b></font>並獲得對方的<font color=\"#FF60AF\"><b>桃</b></font>但<font color=\"#FF4500\"><b>不終止結算</b></font>，當你的狂怒標記歸零，你失去“神噬”、“狂吞”。若你的狂怒標記達到達到<font color=\"#FF4500\"><b>六點以上</b></font>，你獲得“神噬”、“狂吞”。",
["magicat"] = "魔貓",
["@magicat"] = "棄置一張牌並棄置目標一張牌，或令其摸兩張牌。",
[":magicat"] = "一名角色的<font color=\"#FF4500\"><b>回合結束</b></font>時，你可以<font color=\"#FF4500\"><b>棄置一張牌</b></font>並棄置其一張牌，或令其摸兩張牌，如果你已<font color=\"#FF4500\"><b>翻面</b></font>，你改為將角色牌翻面然後恢復一點生命，獲得其一張牌、令其<font color=\"#FF4500\"><b>流失</b></font>一點體力。",
["reedship"] = "筏策",
[":reedship"]  = "當你成為<font color=\"#FF4500\"><b>非延時</b></font>錦囊或<font color=\"#FF4500\"><b>紅色殺</b></font>的目標時，可以將一張<b>黑色</b>牌視為殺使用並終止結算，此殺<font color=\"#FF4500\"><b>無視</b></font>距離限制。<font color=\"blue\"><b>鎖定技，</b></font>每次你使用<b>黑色</b>的殺，令一名目標摸一张牌。",
["@reedship"]  = "選定一名殺的對象，不受距離限制。",
["~reedship"] = "選定一名目標，將一張黑色牌視為殺對其使用。",
["phantom"] = "魅影",
["$phantom1"] = "万花凋落尽，一梅独傲霜。",
["$phantom2"] = "暗香疏影处，凌风踏雪来~",
["@phantomask"] = "請打出一張菱形花色牌否則受到傷害。",
[":phantom"] = "遊戲開始，場上除了你之外所有人獲得一點魅影標記，若你受到指定，<font color=\"#FF4500\"><b>來源</b></font>獲得一點魅影標記(最多持有兩個)。<font color=\"green\"><b>階段技，</b></font>你可以令一名持有魅影標記的敵方棄置<font color=\"#FF4500\"><b>方塊</b></font>牌否則其<font color=\"#FF4500\"><b>非</b></font><font color=\"blue\"><b>鎖定技</b></font>無效直到你回合結束，然後你對其造成1點傷害(<font color=\"purple\"><b>覺醒</b></font>後改為X)、<font color=\"purple\"><b>奪走</b></font>其所有魅影標記。(X為目標的<font color=\"#FF4500\"><b>魅影標記</b></font>數量)【超界突破】：你摸X張牌。",
["inheritedthefather"] = "承志",
[":inheritedthefather"] = "<font color=\"purple\"><b>覺醒技。</b></font>回合結束若你的<font color=\"#FF4500\"><b>魅影</b></font>標記三枚以上，你摸失去生命數量的牌(最少為一)、獲得兩枚魅影、恢復一點體力獲得<font color=\"#FF4500\"><b>龍膽</b></font>。<font color=\"blue\"><b>鎖定技，</b></font>當你以龍膽打出一張牌，你棄置一點魅影標記摸一张牌。",
["$inheritedthefather1"] = "承先父之志，扶汉兴刘~",
["$inheritedthefather2"] = "天将降大任于我！",
["turnoveranddraw"] = "翻面並摸牌",
["obtaincard"] = "棄置其手牌",
["zhixi_choiceplayer"] = "請選擇一位的目標。",
["zhixi"] = "擲璽",
[":zhixi"] = "當妳即將受到傷害，妳可以棄置一張<b>黑牌</b><font color=\"#FF4500\"><b>無效</b></font>此傷害。那之後你可以指定一名其他角色，使其摸<font color=\"#FF4500\"><b>失去生命數量</b></font>的牌(最少一張)，若其<font color=\"#FF4500\"><b>背面</b></font>朝上則<font color=\"#FF4500\"><b>翻面</b></font>摸一张牌。或令其棄置一半的手牌(<font color=\"#FF4500\"><b>向上取整</b></font>)，若其<font color=\"#FF4500\"><b>沒有手牌</b></font>或棄牌<font color=\"#FF4500\"><b>超過兩張</b></font>則流失一點體力。<b>【超界突破】</b>：獲得技能<font color=\"brown\"><b>【逆勇】</b></font>。",
["#zhixi_log"] = " %arg 技能無效了對 %from 造成的<font color=\"red\"><b>傷害</b></font>！",
["@zhixi"] = "妳可以棄置一張黑牌讓傷害無效。",
["y_sousetsu"] = "逆勇",
[":y_sousetsu"] = "<font color=\"blue\"><b>鎖定技，</b></font>你不會跳過回合、不會被翻面，結束階段如果你的手牌<font color=\"#FF4500\"><b>少於</b></font>生命值，你摸兩張牌然後受到一點無來源的傷害，若沒有，則獲得<font color=\"brown\"><b>【突襲】</b></font>(舊版)直到下次回合結束。",
["allknow"] = "身分全知觀點",
["#allknow_log"] = " %from 的身分為 %arg 。",
["yusha"] = "勇者",
[":yusha"] = "<font color=\"blue\"><b>鎖定技，</b></font>你<font color=\"#FF4500\"><b>流失體力</b></font>前進行一次判定並<font color=\"#FF4500\"><b>獲得</b></font>判定牌，若為紅色你無效那次流失。體力變動後若<font color=\"#FF4500\"><b>小於等於一</b></font>，且<b>體力上限大於二</b>，你失去一點體力上限並將體力值恢復到全滿。(【超界突破】：然後你摸體力上限數的牌。)你與其他人的距離<font color=\"#FF4500\"><b>減少</b></font>你的手牌量。",
["tomowodaji"] = "惜友",
[":tomowodaji"] = "當除你為受害者的傷害發生時，你可以<font color=\"#FF4500\"><b>流失</b></font>一點體力令那次<font color=\"#FF4500\"><b>傷害無效</b></font>。如果你不為來源，你可以對來源使用一張<font color=\"#FF4500\"><b>不限距離</b></font>的殺。",
["#tomowodaji_log"] = " %from 將對 %to 造成 %arg 點傷害。",
["#tomowodaji_log2"] = " %arg 技能阻擋了 %from 對 %to 造成的傷害！",
["#tomowodaji_slash"] = "對傷害來源打出一張殺或取消之。",
["excludeforever"] = "永久排除該目標(不可逆)",
["exclude"] = "你回合結束前排除該目標",
["japenknifejile"] = "鬼薙",
["japenknifeslashe2"] = "鬼薙",
[":japenknifejile"] = "你的武器視為殺。你的武器欄無裝備時，你与其他角色的距离-2。每回合出牌階段，你的<font color=\"#FF4500\"><b>第一張殺</b></font>指定目標後，你摸當前生命數的牌(至多三張)【超界突破】：若為本技能轉換之殺，摸牌數不會小於<b>武器攻擊距離數</b>。你的殺<font color=\"#FF4500\"><b>命中目標</b></font>時，你可以令其無法從手牌打出或使用<font color=\"#FF4500\"><b>錦囊牌</b></font>直到下次其回合結束。若被閃避，你獲得<font color=\"brown\"><b>【業刀】</b></font>：你的<b>黑牌</b>視為殺。對手每次閃避殺，獲得一枚<font color=\"#FF4500\"><b>+1標記</b></font>。若殺命中你將額外造成+1標記數量的傷害。當殺結束後，<font color=\"#FF4500\"><b>失去</b></font>該技能、所有+1標記。",
["japenknifeslashe"] = "業刀",
[":japenknifeslashe"] = "你的<b>黑牌</b>視為殺。對手每次閃避殺，或你放棄使用本效果時，獲得一枚<font color=\"#FF4500\"><b>+1標記</b></font>。若殺命中你將額外造成+1標記數量的傷害。當殺結束後，<font color=\"#FF4500\"><b>失去</b></font>該技能、所有+1標記。",
["#bladeeffecct"] = "你可以再對目標打出一張殺。",
["skeleton"] = "骷髏",
[":skeleton"] = "你成為<font color=\"#FF4500\"><b>殺</b></font>的或<font color=\"#FF4500\"><b>非延時錦囊牌</b></font>的對象時，你可以棄一張牌點數<font color=\"#FF4500\"><b>X</b></font>以上的牌然後翻面，並令來源也翻面。你<font color=\"#FF4500\"><b>背面朝上</b></font>時，<font color=\"#FF4500\"><b>非延時錦囊</b></font>與<font color=\"#FF4500\"><b>殺</b></font>對你<font color=\"red\"><b>無效</b></font>。(X為13減去來源的裝備數+手牌，最少為一)",
["@skeleton"] = "可以棄置一張手牌令你與使用者翻面。",
["#skeletoninvisible"] = " %from 的 【%arg】受到 %to 的【骷髏】技能影響！",
["strangeguy"] = "行異",
[":strangeguy"] = "你的<font color=\"pink\"><b>桃</b></font>可以在你受傷時<font color=\"#FF4500\"><b>立刻</b></font>使用。回合開始，你可以將<font color=\"#FF4500\"><b>判定階段</b></font>與<font color=\"#FF4500\"><b>棄牌階段</b></font>互換，若如此做你必須將<font color=\"#FF4500\"><b>出牌階段</b></font>改為<font color=\"#FF4500\"><b>摸牌階段</b></font>。",
["#strangeguy"] = "你可以使用一張桃。",
["strangeguy:ChangeJudgeToDiscard"] = "把判定階段與棄牌階段互換，但出牌階段改為摸牌階段。若要如此做，請按確定。",
["heapridge"] = "堆嶺",
[":heapridge"] = "當你獲得牌，且手牌有<font color=\"#FF4500\"><b>四張以上</b></font>花色相同的牌時，你可以將四張同花色的牌至於武將牌上視為<font color=\"#FF4500\"><b>“槓”</b></font>牌，然後你恢復一點體力摸一张牌。若你已擁有<font color=\"#FF4500\"><b>四副槓牌</b></font>(16張牌)以上，而你以<font color=\"#FF4500\"><b>此法</b></font>摸上來的牌花色與<font color=\"#FF4500\"><b>任一張</b></font>槓牌花色相同，你的所屬陣營獲得<font color=\"#FF4500\"><b>遊戲勝利</b></font>。(失去該技能不會讓你失去槓牌。)",
["$heapridge"] = "自摸！嶺上開花！",
["@heapridge"] = "選擇有四個同花色的牌，收入成槓牌堆。",
["~heapridge"] = "可以取消此動作。",
["bars"] = "槓",
["zerodifference"] = "天資",
[":zerodifference"] = "你的手牌上限始終等同於體力上限。回合結束時，若你有任<font color=\"#FF4500\"><b>三張</b></font>相同花色的手牌，你展示所有牌，然後翻開堆頂，若有與其<font color=\"#FF4500\"><b>花色相同</b></font>的牌，你獲得之，否則棄置再翻(最多翻<font color=\"#FF4500\"><b>3+失去生命量</b></font>的次數)。若沒有，且你的手牌<font color=\"#FF4500\"><b>不是</b></font>場上最多或已受傷，則發動有利者：<b>1.</b>你可以將手牌補至與最多手牌者相同數量。<b>2.</b>摸失去生命數量的牌。(以此法補進的牌最多<font color=\"#FF4500\"><b>五張</b></font>，<font color=\"#FF4500\"><b>一張一張</b></font>摸而非一起摸)。",
["lovesong"] = "戀歌",
[":lovesong"] = "摸完初始牌後場上存在<font color=\"#FF4500\"><b>歌留多</b></font>且其陣營非內奸而你非主公，你<font color=\"#FF4500\"><b>展示身分</b></font>並改為與其<font color=\"#FF4500\"><b>同陣營</b></font>。若你們同屬陣營，你對她造成傷害時你令其<font color=\"#FF4500\"><b>傷害-1</b></font>。",
["loyalm"] = "忠受",
[":loyalm"] = "你受到傷害時，將<font color=\"#FF4500\"><b>傷害來源</b></font>的一張<font color=\"#FF4500\"><b>手牌</b></font>或<font color=\"#FF4500\"><b>裝備</b></font>移到場上一名目標的手上，如果來源<font color=\"#FF4500\"><b>沒有牌</b></font>，你令選擇的目標<font color=\"#FF4500\"><b>摸兩張牌</b></font>。若你不發動效果，則你摸一张牌。",
["deepforest"] = "深林",
[":deepforest"] = "<font color=\"blue\"><b>鎖定技，</b></font>若<font color=\"#FF4500\"><b>牌堆數</b></font>為X張以下，場上所有人<font color=\"#FF4500\"><b>技能失效</b></font>，你摸牌前可以發動<font color=\"#FF4500\"><b>棄牌堆/10</b></font>(向上取整。最少5，最多15)張牌的觀星。(X為總牌堆數的四分之一加上遊戲人數x7)\
深林效果結束後，若身上沒有裝備<font color=\"brown\"><b>木牛流馬</b></font>，則會失去所有木牛流馬牌。\
<b>【超界突破】</b>：每失去一點體力，深林效果提早25張牌發生。",
["tobenature"] = "自然",
-- ["tobenaturecards"] = "自然",
[":tobenature"] = "<font color=\"green\"><b>階段技，</b></font>你指定一名目標，若其手牌數多於你，令其將X張手牌放置於你的武將牌上視為<font color=\"brown\"><b>“木牛流馬牌”</b></font>(若此時“木牛流馬牌”為<b>五張以上</b>，則改成棄置)，反之則其摸X張牌。若你已受傷且當前生命小於X，則改為其摸一张牌、你恢復一點體力。X為你與其手牌數量的差距。(在<font color=\"brown\"><b>深林</b></font>的效果發動期間，你可以指定<font color=\"#FF4500\"><b>任意數量</b></font>的目標。若其手牌量大於你，令其受到<font color=\"#FF4500\"><b>1</b></font>點雷電傷害，目標不能是自己)",
["@tobenatureAsk"] = "選擇一張牌至於成為自然牌。",
["tobenatureuma"] = "鄉香",
[":tobenatureuma"] = "<font color=\"blue\"><b>鎖定技，</b></font>你的木牛流馬牌不會因為失去木牛流馬而被棄置。",
["scoopthemoonup"] = "撈月",
[":scoopthemoonup"] = "<font color=\"blue\"><b>鎖定技，</b></font>每當你的手牌<font color=\"#FF4500\"><b>少於三張</b></font>，你獲得<font color=\"#FF4500\"><b>棄牌堆</b></font>最底的一張牌，直到手牌補足三張(若棄牌堆沒牌則不動作)。",
["deterrence"] = "震懾",
[":deterrence"] = "他到你或你到他距離為一的角色在摸牌階段摸牌後，若其體力值<font color=\"#FF4500\"><b>超過</b></font>你，你可以令其在摸牌階段<font color=\"#FF4500\"><b>不摸牌</b></font>，翻開牌堆頂上三張牌，取得其中的點數<font color=\"#FF4500\"><b>大於等於8</b></font>的牌，若目標獲得三張牌，則失去一點生命。",
["@deterrenceAsk"] = "棄置一張錦囊牌否則跳過出牌階段。",
["wannawin"] = "好勝",
[":wannawin"] = "<font color=\"green\"><b>每名目標限一次。</b></font>出牌階段你可以與一名目標拚點，贏了你可以<font color=\"#FF4500\"><b>獲得</b></font>目標一張牌(<font color=\"#FF4500\"><b>包括判定區</b></font>)並<font color=\"#FF4500\"><b>失去</b></font>所有<font color=\"#EAC100\"><b>好勝</b></font>標記，若輸了你可以獲得一點<font color=\"#EAC100\"><b>好勝</b></font>標記<font color=\"#FF4500\"><b>再拚點一次</b></font>。",
["theace"] = "王牌",
[":theace"] = "<font color=\"blue\"><b>鎖定技，</b></font><font color=\"#FF4500\"><b>以你發起</b></font>的拚點牌亮出後點數<font color=\"#FF4500\"><b>+2X</b></font>(X為<font color=\"#EAC100\"><b>好勝</b></font>標記數量)。當你打出或使用一張數字為<font color=\"#FF4500\"><b>A或13</b></font>的牌(包括拚點牌且計算拚點加上去的點數，若拚點牌原本符合規則，加上點數後不符合的情況依然視為符合)，你摸一张牌。",
["hotfight"] = "燃血",
[":hotfight"] = "你可以棄置一枚<font color=\"#FF4500\"><b>炙灼</b></font>標記視為使用或打出一張<font color=\"#FF4500\"><b>閃或火殺</b></font>，或<font color=\"#FF4500\"><b>阻止</b></font>目標恢復體力，或<font color=\"#FF4500\"><b>跳過</b></font>判定階段(若你擁有延時錦囊)並<font color=\"#FF4500\"><b>獲得</b></font>那張延時錦囊。\
<font color=\"blue\"><b>鎖定技，</b></font>你每使用、打出一張殺或閃，你獲得一點<font color=\"#FF4500\"><b>炙灼</b></font>標記，若此殺<font color=\"#FF4500\"><b>被閃避</b></font>，你額外獲得一點標記(以此技能打出的不算，標記最多持有五個)。",
["#hotfightlog"] = " %from 的技能<font color=\"gold\"><b>燃血</b></font>發動，本次恢復效果<font color=\"salmon\"><b>取消</b></font>。",
["fakebody"] = "虛形",
[":fakebody"] = "當你受到傷害且傷害來源的體力值大於你，你可以棄置X張牌與其<font color=\"#FF4500\"><b>交換</b></font>體力值並令其獲得<font color=\"#FF4500\"><b>纏怨</b></font>，若其已擁有纏怨或體力值與你相同，你摸一张牌。(X為你與其體力值的差距，其失去的體力視為流失體力。)",
["proficient"] = "通曉",
["@proficient"] = "請選擇兩張牌置於牌堆頂。",
[":proficient"] = "出牌阶段，你可以摸兩張牌，然後選兩張牌任意排列在牌堆上，若是裝備牌則會被置入棄牌堆。<font color=\"blue\"><b>鎖定技，</b></font>你的即時錦囊在指定目標後，該牌不能以無懈可擊响应。每次使用或打出錦囊牌，你摸一张牌。",
["thinkhard"] = "慎思",
[":thinkhard"] = "你可以丟棄一張手牌翻開牌堆上兩張牌，然後令一名目標獲得其中與棄置牌不同類型的牌，每一種牌類一回合僅能丟棄一次，若目標不為自己，下個回合開始前該技能無法指定同一個目標。",
["iris"] = "鳶尾",
["#iris"] = "目前技能【%arg】的目標為 %arg2 。",
["@iris_re"] = "棄置一張紅牌獲得當前目標摸的牌。",
["@iris_choiceplayer"] = "選擇一名角色令其棄置紅牌否則受傷。(本次傷害不會觸發非鎖定技)",
[":iris"] = "一名角色在回合內獲得手牌時，你可以棄置一張紅牌獲得那些牌。若獲得的牌中包含紅心牌，你摸一张牌。",

["endingchoice"] = "終局",
[":endingchoice"] = "<font color=\"red\"><b>限定技，</b></font>出牌阶段，若你體力值為一，你可以失去本技能，獲得技能<font color=\"brown\"><b>【開朗】</b></font>、<font color=\"brown\"><b>【鳶尾】</b></font>(一名角色在回合內獲得手牌時，你可以棄置一張紅心牌獲得那些牌。若獲得的牌中包含紅牌，你摸一张牌。)、摸三張牌，並令除自己以外全場每一名角色翻面，該效果不會將其轉回正面。",
["$tamaoendingchoice"] = "現實不能被更改，但我能前進！",
["acting"] = "演技",
[":acting"] = "<font color=\"green\"><b>階段技，</b></font>妳可以選擇一名角色獲得其能力直到你下回合摸牌階段結束。 ",
["liketoplay"] = "好玩",
[":liketoplay"] = "<font color=\"green\"><b>階段技，</b></font>你額外摸兩張牌，若你已經使用過演技，你少摸一张牌並重置演技使用次數。",
["shywithpeople"] = "避俗",
[":shywithpeople"] = "妳與其他人的距離、其他人與妳的距離+2。",
["sweetsis"] = "甜伴",
[":sweetsis"] = "遊戲開始時，妳獲得三枚<font color=\"#FF4500\"><b>點心</b></font>標記。回合開始，妳獲得一枚點心標記。妳可以棄置任意枚<font color=\"#FF4500\"><b>點心</b></font>標記獲得以下<font color=\"#FF4500\"><b>棄置數量</b></font>的能力，若妳取消，則獲得兩枚<font color=\"#FF4500\"><b>點心</b></font>。下個妳的回合開始，妳失去那些能力。\
<font color=\"brown\"><b>【天使】</b></font>：<font color=\"blue\"><b>鎖定技，</b></font>妳的桃恢復能力加一。妳的<font color=\"red\"><b>紅心牌</b></font>可以視作<font color=\"pink\"><b>桃。</b></font>\
<font color=\"brown\"><b>【好動】</b></font>：<font color=\"blue\"><b>鎖定技，</b></font>妳的殺無距離<font color=\"#FF4500\"><b>限制</b></font>，且妳可以額外使用一張殺，並指定至多<font color=\"#FF4500\"><b>兩人</b></font>。\
<font color=\"brown\"><b>【打扮】</b></font>：出牌阶段，妳可以棄置X張手牌，選擇一名角色X張裝備牌移至另一名角色身上。\
<font color=\"brown\"><b>【奮勇】</b></font>：<font color=\"blue\"><b>鎖定技，</b></font>每次妳成為牌的目標，摸一张牌。若手牌數量大於生命，且自己橫置或判定區有牌時，<font color=\"#FF4500\"><b>重置</b></font>角色牌、棄置<font color=\"#FF4500\"><b>判定區</b></font>所有牌。\
<font color=\"brown\"><b>【有容】</b></font>：<font color=\"blue\"><b>鎖定技，</b></font>妳的手牌上限+3，回合結束時妳請來<font color=\"#EAC100\"><b>小依</b></font>：<font color=\"brown\"><b>【奮勇】</b></font>陪同。\
<font color=\"brown\"><b>【匿蹤】</b></font>：<font color=\"blue\"><b>鎖定技，</b></font>妳與其他人的距離改為一。妳的<font color=\"#FF4500\"><b>菱形</b></font>牌可以當作順手牽羊使用。",
["angel"] = "天使",
[":angel"] = "<font color=\"blue\"><b>鎖定技，</b></font>妳的桃恢復能力加一。妳的<font color=\"red\"><b>紅心牌</b></font>可以視作<font color=\"pink\"><b>桃。</b></font>",
["moveliketrigger"] = "好動",
[":moveliketrigger"] = "<font color=\"blue\"><b>鎖定技，</b></font>妳的殺無距離<font color=\"#FF4500\"><b>限制</b></font>，且妳可以額外使用一張殺，並指定至多<font color=\"#FF4500\"><b>兩人</b></font>。",
["dressing"] = "打扮",
[":dressing"] = "出牌阶段，妳可以棄置X張手牌，選擇一名角色X張裝備牌移至另一名角色身上。",
["nfever"] = "奮勇",
[":nfever"] = "<font color=\"blue\"><b>鎖定技，</b></font>每次妳成為牌的目標，摸一张牌。若手牌數量大於生命，且橫置或判定區有牌時，<font color=\"#FF4500\"><b>重置</b></font>角色牌、棄置<font color=\"#FF4500\"><b>判定區</b></font>所有牌。",
["toleranceIsAVirtue"] = "有容",
[":toleranceIsAVirtue"] = "<font color=\"blue\"><b>鎖定技，</b></font>妳的手牌上限+3，回合結束時妳請來<font color=\"#EAC100\"><b>小依</b></font>：<font color=\"brown\"><b>【奮勇】</b></font>陪同。",
["hidethepath"] = "匿蹤",
[":hidethepath"] = "<font color=\"blue\"><b>鎖定技，</b></font>妳與其他人的距離改為一。妳的<font color=\"#FF4500\"><b>菱形</b></font>牌可以當作順手牽羊使用。",
["dressing_moveto"] = "請選擇一名獲得【%src】的角色",
-- ["hightention"] = "振奮",
["turned"] = "轉化",
[":turned"] = "階段技，出牌階段，你可以摸取另一名角色兩張手牌(不足則只摸一張)，然後還其等量的手牌。<b>【超界突破】</b>：只需還一張牌。",
["lovetoevo"] = "樂團",
[":lovetoevo"] = "當你的手牌數大於體力值，你可以棄置所有手牌，然後摸等同於體力值的牌。之後你額外獲得行動階段。",
["graduation"] = "畢業",
[":graduation"] = "<font color=\"blue\"><b>鎖定技，</b></font>每次妳的回合開始都會得一點輕音標記，覺醒後失效。<font color=\"purple\"><b>覺醒技。</b></font>回合開始若輕音標記累積<font color=\"#FF4500\"><b>五點以上</b></font>，妳獲得以下技能然後失去一點體力上限恢復兩點體力。<font color=\"brown\"><b>【終曲】</b></font>：一名目標<font color=\"#FF4500\"><b>瀕死</b></font>求桃時，你可以棄置等同於<font color=\"#FF4500\"><b>其最大生命</b></font>的輕音標記，令其取消求桃，並將體力值<font color=\"#FF4500\"><b>恢復至一點</b></font>。、<font color=\"brown\"><b>【再臨】</b></font>：<font color=\"blue\"><b>鎖定技，</b></font>每當你<font color=\"#FF4500\"><b>受到傷害</b></font>時，你獲得<font color=\"#FF4500\"><b>一枚</b></font>輕音標記，如果你的輕音標記<font color=\"#FF4500\"><b>少於四點</b></font>，你摸一张牌。<b>【超界突破】</b>：如果已受傷，每回合改成獲得X+1點標記。(X為已損失的生命)",
["songforatsu"] = "終曲",
[":songforatsu"] = "一名目標<font color=\"#FF4500\"><b>瀕死</b></font>求桃時，你可以棄置等同於<font color=\"#FF4500\"><b>其最大生命</b></font>的輕音標記，令其取消求桃，並將體力值<font color=\"#FF4500\"><b>恢復至一點</b></font>。",
["newmember"] = "再臨",
[":newmember"] = "<font color=\"blue\"><b>鎖定技，</b></font>每當你<font color=\"#FF4500\"><b>受到傷害</b></font>時，你獲得<font color=\"#FF4500\"><b>一枚</b></font>輕音標記，如果你的輕音標記<font color=\"#FF4500\"><b>少於四點</b></font>，你摸一张牌。",
["getk"] = "橫置或轉正",
["#introvert_log"] = "%from 的“<font color=\"yellow\"><b>怕生</b></font>”技能生效！",
["#introvert_elog"] = "%from 正打算對妳裝上<font color=\"red\"><b>狂風甲</b></font>。",
["cardcollecter"] = "惜卡",
[":cardcollecter"] = "<font color=\"blue\"><b>鎖定技，</b></font>每次妳使用或打出一張<font color=\"#FF4500\"><b>基本牌</b></font>前可以進行一次判定，若判定牌色與使用牌色<font color=\"#FF4500\"><b>相同</b></font>，妳<font color=\"#FF4500\"><b>回收判定牌</b></font>。",
["introvert"] = "怕生",
[":introvert"] = "<font color=\"green\"><b>每名角色回合限一次。</b></font>其對妳使用五穀豐登、桃園結義以外的<font color=\"#FF4500\"><b>錦囊牌</b></font>或桃、酒以外的<font color=\"#FF4500\"><b>基本牌</b></font>，妳可以令其<font color=\"#FF4500\"><b>無效</b></font>。若是裝備卡，則會<font color=\"#FF4500\"><b>返回</b></font>目標裝備欄。",

["fc"] = "歷練",
["fightingexper"] = "歷練",
[":fightingexper"] = "<font color=\"blue\"><b>鎖定技，</b></font>每當你體力發生變動，你摸一张牌置於武將牌上稱為“歷練”，歷練最多五張。根據你擁有的歷練獲得技能，你不會因為失去歷練卡而失去能。\
<b>一張以上</b>：你擁有<font color=\"brown\"><b>【護壁】</b></font>。\
<b>兩張以上</b>：你擁有<font color=\"brown\"><b>【驍勇】</b></font>：<font color=\"blue\"><b>鎖定技，</b></font>摸牌階段，若你已受傷，你多摸X張牌(X為已失去的生命+1，<font color=\"#FF4500\"><b>不超過三張。</b></font>)<b>【超界突破】</b>：手牌上限增加X。\
<b>三張以上</b>：你擁有<font color=\"brown\"><b>【博洛】</b></font>：妳的黑牌可以當無懈可擊打出。<b>【超界突破】</b>：回合結束時，妳可以進行一次判定，若為黑色，妳獲得該牌(<font color=\"#FF4500\"><b>最多連續三次</b></font>)。\
<b>四張以上</b>：你擁有<font color=\"brown\"><b>【百剛】</b></font>：每當你受到一點傷害，你可以棄置來源一張<font color=\"#FF4500\"><b>裝備區</b></font>的牌和一張<font color=\"#FF4500\"><b>手牌</b></font>，若來源沒有裝備則受到<font color=\"#FF4500\"><b>一點</b></font>傷害。\
<b>五張</b>：你擁有<font color=\"brown\"><b>【熊嵐】</b></font>：<font color=\"red\"><b>限定技，</b></font>限定擁有<font color=\"#FF4500\"><b>五張</b></font>歷練牌。你可以獲得所有歷練牌，使所有角色的<font color=\"#FF4500\"><b>技能與裝備</b></font>失效，直到其回合<font color=\"#FF4500\"><b>結束後</b></font>。",
["yuri_hagaku"] = "博洛",
[":yuri_hagaku"] = "妳的黑牌可以當無懈可擊打出。<b>【超界突破】</b>：回合結束時，妳可以進行一次判定，若為黑色，妳獲得該牌(<font color=\"#FF4500\"><b>最多連續三次</b></font>)。",
["braveheart"] = "驍勇",
[":braveheart"] = "<font color=\"blue\"><b>鎖定技，</b></font>摸牌階段，若你已受傷，你多摸X張牌(X為已失去的生命+1，<font color=\"#FF4500\"><b>不超過三張。</b></font>)<b>【超界突破】</b>：手牌上限增加X。",
["yuriganglie"] = "百剛",
[":yuriganglie"] = "每當你受到一點傷害，你可以棄置來源一張<font color=\"#FF4500\"><b>裝備區</b></font>的牌和一張<font color=\"#FF4500\"><b>手牌</b></font>，若來源沒有裝備則受到<font color=\"#FF4500\"><b>一點</b></font>傷害。",
["fightingclimax"] = "熊嵐",
[":fightingclimax"] = "<font color=\"red\"><b>限定技，</b></font>限定擁有<font color=\"#FF4500\"><b>五張</b></font>歷練牌。你可以獲得所有歷練牌，使所有角色的<font color=\"#FF4500\"><b>技能與裝備</b></font>失效，直到其回合<font color=\"#FF4500\"><b>結束後</b></font>。",
["againstdis"] = "抗末",
[":againstdis"] = "你可以用一張牌替代判定。若更改的為你的判定，則其他人<font color=\"#FF4500\"><b>無法改動</b></font>此判定。",
["@againstdis-card"] = "妳可打出一張牌修正判定，若此判定為妳的判定，其他人將無法再度修改。",
["new_againstdis"] = "抗末",
[":new_againstdis"] = "<font color=\"green\"><b>階段技，</b></font>你可以選出<font color=\"#FF4500\"><b>棄牌堆</b></font>中選出所有<font color=\"#FF4500\"><b>團體錦囊</b></font>和<font color=\"#FF4500\"><b>寶物</b></font>然後洗牌，你摸一其中一張，並將其他的置回棄牌堆。若棄牌堆沒牌則沒有效果。<b>【超界突破】</b>：若已受傷則可摸兩張。",
["witty"] = "巧智",
[":witty"] = "你可以棄置一張<font color=\"#FF4500\"><b>群體</b></font>或<font color=\"#FF4500\"><b>延時</b></font>錦囊，然後選擇任意數量的目標，其摸一张牌。\
每次妳使用裝備牌，根據其<font color=\"#FF4500\"><b>種類</b></font>將有不同的效果：\
<b>武器</b>：視為使用一張<font color=\"#FF4500\"><b>不限距離</b></font>殺，此殺不納入<font color=\"#FF4500\"><b>次數限制</b></font>。\
<b>坐騎</b>：當妳持有坐騎，妳的最大手牌量加一。\
<b>寶物、防具</b>：令你摸X張牌。(X為你失去的生命，最多為二、最少為一。)",
["helmet"] = "鋼盔",
[":helmet"] = "<font color=\"blue\"><b>鎖定技，</b></font><b>雷殺或火殺</b><font color=\"#FF4500\"><b>以外</b></font>的殺對妳<font color=\"#FF4500\"><b>無效</b></font>。",
["eatforlike"] = "天吃",
[":eatforlike"] = "<font color=\"blue\"><b>鎖定技，</b></font>你的錦囊手牌視作桃。",
["yuriforever"] = "終合",
[":yuriforever"] = "<font color=\"blue\"><b>鎖定技，</b></font>摸完初始牌後若<font color=\"#FF4500\"><b>千都</b></font>在場，你將轉變為與其同屬陣營，若其為內奸，則其轉變為與你同陣營。若你們同為內奸，則一起變為反賊。",
["sportsw"] = "健將",
[":sportsw"] = "<font color=\"blue\"><b>鎖定技，</b></font>你與其他人的距離-1。回合開始必須進行一次判定，若為</font><font color=\"red\"><b>紅色</b></font>，視為你擁有<font color=\"brown\"><b>【鐵騎】</b></font>。若為<b>黑色</b>，視為你擁有<font color=\"brown\"><b>【鞬出】</b></font>，直到下回合開始。每次使用或打出一張殺可以使你摸一张牌。",
["@luajtieji-discard"] = "請棄置一張 %arg 牌，否則你不能使用【閃】響應此【殺】",
["LuaJTieji"] = "鐵騎",
[":LuaJTieji"] = "你的殺指定目標時令其非鎖定技無效，然後進行一次判定，目標必須棄置一張與判定牌同花色的牌，否則無法用閃迴避此殺。",
["thedolls"] = "偶劇",
[":thedolls"] = "<font color=\"green\"><b>回合結束階段</b></font>，妳可以選擇妳<font color=\"#FF4500\"><b>曾經指定過</b></font>、或是其之前有<font color=\"#FF4500\"><b>指定妳為目標</b></font>的三名角色，從其身上獲得一張牌。",
["cheerful"] = "開朗",
[":cheerful"] = "<font color=\"blue\"><b>鎖定技，</b></font>妳受到的傷害不會<font color=\"#FF4500\"><b>大於</b></font>一，且妳不會<font color=\"#FF4500\"><b>流失生命</b></font>。",
["@thedollslog"] = "選擇想要獲取其身上之牌的角色。",
["~thedolls"] = "可以選擇自己。",

["yuri_xueji"] = "雪恨",
[":yuri_xueji"] = "<font color=\"green\"><b>階段技，</b></font>妳可以棄置一張<b>黑牌</b>並<font color=\"#FF4500\"><b>橫置</b></font>一至1+X名角色(若該色已被橫置，妳<font color=\"#FF4500\"><b>重置</b></font>之)。(X為妳已<font color=\"#FF4500\"><b>損失的體力</b></font>值且至少為2)",
["yuri_huxiao"] = "虎嘯",
[":yuri_huxiao"] = "<font color=\"blue\"><b>鎖定技，</b></font>當妳對一名角色造成傷害，妳摸該<font color=\"#FF4500\"><b>傷害數量</b></font>的牌。",
["yuri_wuji"] = "武繼",
[":yuri_wuji"] = "妳可以將一張<font color=\"red\"><b>紅色牌</b></font>當作<font color=\"#FF4500\"><b>火殺</b></font>使用。【超界突破】：你的火殺沒有距離限制。",

["ys_qianjie"] = "謙節",
[":ys_qianjie"] = "<font color=\"blue\"><b>鎖定技，</b></font>你不是延時錦囊的合法目標，你不會失去因拚點而失去的牌。",
["ys_jueyan_effect"] = "困頓",
[":ys_jueyan_effect"] = "<font color=\"blue\"><b>鎖定技，</b></font>你的棄牌階段移至摸牌階段之前。",
["ys_jueyan"] = "圍困",
[":ys_jueyan"] = "<font color=\"red\"><b>限定技，</b></font>你可以選擇一名手牌數量大於你的角色，令其受到一點傷害並獲得<font color=\"brown\"><b>【困頓】</b></font>：<font color=\"blue\"><b>鎖定技，</b></font>你的棄牌階段移至摸牌階段之前。",
["ys_huairou-invoke"] = "你可以令一名目標獲得你所有的牌，在手牌交出前，你獲得連營。",
["ys_huairou"] = "援救",
[":ys_huairou"] = "<font color=\"green\"><b>回合開始階段</b></font>，你可以將所有手牌交給一名角色，若你這麼做，你獲得標準版<font color=\"brown\"><b>【連營】</b></font>直到下次你的回合開始。",

["ys_xiongluan"] = "雄亂",
["ys_xiongluan_slash"] = "亂雄誅殺",
[":ys_xiongluan"] = "<font color=\"red\"><b>限定技，</b></font>你可以指定<font color=\"#FF4500\"><b>任意數量</b></font>的角色，視為對其打出一張<font color=\"#FF4500\"><b>不限距離、不計入次數限制</b></font>的殺，然後摸一张牌、失去本技能獲得技能<font color=\"brown\"><b>【雄起】</b></font>：<font color=\"red\"><b>限定技，</b></font>你可以指定任意數量的角色令其摸一张牌，然後你恢復一點體力。<font color=\"brown\"><b>【王槍】</b></font>：<font color=\"blue\"><b>鎖定技，</b></font>你不受延時錦囊影響。你沒有裝備區，你的裝備牌視為閃。",
["ys_congjian"] = "從諫",
["@ys_congjian"] = "你可以發動“從諫”",
["~ys_congjian"] = "選擇一張牌→選擇一名其他角色→點擊確定",
[":ys_congjian"] = "當你成為<font color=\"#FF4500\"><b>錦囊牌</b></font>的目標時，若使用者<font color=\"#FF4500\"><b>不為你</b></font>，你可以將一張牌交給其中一個目標(若目標為<font color=\"#FF4500\"><b>自己</b></font>，你<font color=\"#FF4500\"><b>棄置</b></font>那張牌)，然後你摸X張牌。（若你以此法交給其他角色的牌為裝備牌，X為2，否則為1。）",
["ys_xionchi"] = "雄起",
[":ys_xionchi"] = "<font color=\"red\"><b>限定技，</b></font>你可以指定任意數量的角色令其摸一张牌，然後你恢復一點體力。",
["ys_xionchijink"] = "王槍",
[":ys_xionchijink"] = "<font color=\"blue\"><b>鎖定技，</b></font>你不受延時錦囊影響。你沒有裝備區，你的裝備牌視為閃。",

["books"] = "書",
["likebooks"] = "閱歷",
["@likebooks"] = "請選擇一張牌置於武將牌上成為“書”。",
[":likebooks"] = "摸牌階段妳可以多摸一张牌，然後妳必須將一張牌置於武將牌上稱為<font color=\"#FF4500\"><b>“書”</b></font>，妳的手牌上限增加“書”的數量。",
["happinesstoeveryone"] = "同樂",
[":happinesstoeveryone"] = "<b>1.</b>當自己以外一名角色結束階段，你可以棄置一張<font color=\"#FF4500\"><b>“書”</b></font>，然後其選擇一項：轉正並<font color=\"#FF4500\"><b>摸一张牌</b></font>(如果橫置)或恢復體力。若目標滿血且未橫置，則令其將手牌補置<font color=\"#FF4500\"><b>體力上限</b></font>。(最少一張、最多三張。)\
<b>2.</b>當一名角色被翻面，你可以棄置一張<font color=\"#FF4500\"><b>“書”</b></font>令其翻回正面。\
<b>【超界突破】</b>：棄置書改為獲得書。",
["#bloody_log"] = "%from 的 “%arg2”技能生效，即將損失的 %arg 點體力被無效化。",
["bloody"] = "血源",
[":bloody"] = "<font color=\"blue\"><b>鎖定技，</b></font>出牌階段外，每次你受到傷害或流失體力即獲得一枚<font color=\"#FF4500\"><b>“死戰”</b></font>標記。如果你的<font color=\"#FF4500\"><b>“死戰”</b></font>標記為二<font color=\"#FF4500\"><b>以上</b></font>，妳不會受到<font color=\"#FF4500\"><b>傷害、流失生命</b></font>。妳的出牌階段開始時，妳失去所有死戰標記，如果失去兩枚以上，妳摸一张牌。",
["blooddry"] = "渴血",
[":blooddry"] = "<font color=\"blue\"><b>鎖定技，</b></font>妳不是<font color=\"#FF4500\"><b>延時錦囊</b></font>的合法目標，每次妳<font color=\"#FF4500\"><b>回合結束</b></font>，你<font color=\"#FF4500\"><b>流失</b></font>一點體力。妳可以令妳與其<font color=\"#FF4500\"><b>距離為一</b></font>的目標<font color=\"#FF4500\"><b>無法迴避</b></font>妳的殺，且妳的殺令其<font color=\"#FF4500\"><b>防具、技能失效</b></font>直到妳回合結束。你與其他人的距離-X(X為妳<font color=\"#FF4500\"><b>失去的生命</b></font>)。",
["suckblood"] = "血噬",
[":suckblood"] = "妳可以流失一點體力視為打出一張無色殺。當你的殺造成傷害時，若目標手牌數量大於你的體力，妳可以獲取其手牌直到其<font color=\"#FF4500\"><b>手牌數量</b></font>等同於妳的<font color=\"#FF4500\"><b>體力值</b></font>。妳的體力值恢復獲取牌量的<font color=\"#FF4500\"><b>一半</b></font>(向上取整)",

["yuri_liangyin"] = "良姻",
["yuri_liangyin-invoke"] = "你可以發動“良姻”<br/> <b>提示</b>: 會令選擇的武將摸牌。<br/>",
["yuri_liangyin-invoke_dis"] = "你可以發動“良姻”<br/> <b>提示</b>: 會令選擇的武將棄牌。<br/>",
[":yuri_liangyin"] = "當一名角色將牌置於武將牌後，你可以令一名手牌數或體力小於妳的角色摸一张牌；當一名角色從武將牌上/旁獲得牌後，你可以令一名手牌數或體力大於你的角色棄置一張牌。",
["yuri_kongsheng"] = "空笙",
["@yuri_kongsheng"] = "你可以發動“空笙”",
["~yuri_kongsheng"] = "選好想保留的牌後點擊確定。",
["yuri_kongsheng_choiceplayer"] = "選擇一名目標使其獲得空笙。",
["music"] = "聲",
[":yuri_kongsheng"] = "準備階段開始時，你可以令一名自己之外的角色獲得“空笙”，之後你可以將至多兩張牌置於武將牌上，稱為“聲”，結束階段開始時，妳獲得所有“聲”。若你不是“空笙”的原持有者，你失去“空笙”。",

["whosfromhell"] = "腥血",
[":whosfromhell"] = "本技能含有<font color=\"red\"><b>兩種類型</font></b>。其中<font color=\"#E88114\"><b>天生技</font></b>的部分僅為<font color=\"#FF4500\"><b>描述</b></font>，失去本技能不會失去<font color=\"#E88114\"><b>天生技</font></b>。其餘角色獲得本技能也<font color=\"#FF4500\"><b>無法獲得</b></font><font color=\"#E88114\"><b>天生技</font></b>。<font color=\"#E88114\"><b>天生技</font></b>僅在<font color=\"#FF4500\"><b>主將</b></font>時生效。\
<font color=\"blue\"><b>鎖定技，</b></font>當你成為來源非自身之<font color=\"#FF4500\"><b>錦囊牌</b></font>的目標時，妳可以立刻使用一張殺。當妳判定區有牌時，妳棄置之。\
<font color=\"brown\"><b>【追魂】</b></font>：<font color=\"#E88114\"><b>天生技。</font></b>摸牌階段妳額外摸X張牌(最多三張)。妳與其他角色的距離-X，妳的殺可以額外指定X名目標，妳的手牌上限+X。(X為場上體力值<font color=\"#FF4500\"><b>一半</b></font>以下的角色數量(<font color=\"#FF4500\"><b>向下取整</b></font>))【超界突破】：若X大於一，妳不會陣亡。\
<font color=\"brown\"><b>【刀痕】</b></font>：<font color=\"#E88114\"><b>天生技。</font></b>妳的殺指定目標後，可以棄置目標<font color=\"#FF4500\"><b>防具和所有坐騎</font></b>，並<font color=\"#FF4500\"><b>失去</font></b><b>防具欄</b>。",
["harvest"] = "追魂",
["protectdestroy"] = "刀痕",
["#protectdestroy_log"] = "因為 %from 的 “%arg” 效果，%to 的防具和坐騎遭破壞，且失去防具欄。",

["married"] = "結姻",
[":married"] = "<font color=\"green\"><b>階段技，</b></font>你可以選擇一名角色，並棄置一張手牌或將一張裝備置入其裝備區，然後你與其體力值較<font color=\"#FF4500\"><b>高</font></b>的角色摸一張牌，體力值較<font color=\"#FF4500\"><b>低</font></b>的角色恢復一點體力。若體力值相同，你視為體力值較<font color=\"#FF4500\"><b>低</font></b>者。",

["withwings"] = "比翼",
["#withwings-discard"] = "請棄置一張牌。包括裝備區。",
[":withwings"] = "當妳成為<font color=\"#FF4500\"><b>五穀豐登</b></font>或<font color=\"#FF4500\"><b>裝備牌</b></font>以外卡牌的目標時，妳可以摸一张牌。若摸牌後手牌數量為<font color=\"#FF4500\"><b>三以上</b></font>，則必須棄置一張牌。",
["flyaway"] = "雙飛",
[":flyaway"] = "妳可以將兩張<b>黑色</b>手牌視為<font color=\"#FF4500\"><b>五穀豐登</b></font>使用，或將兩張<font color=\"red\"><b>紅牌</b></font>視為<font color=\"#FF4500\"><b>桃園結義</b></font>使用。妳的桃園結義或五穀豐登最多可以<font color=\"#FF4500\"><b>取消</b></font>X+1名目標。(X為<font color=\"#FF4500\"><b>當前</b></font>手牌量)",

["meleemaster"] = "近戰",
[":meleemaster"] = "你手上的<font color=\"#FF4500\"><b>錦囊牌</b></font>可以當作<font color=\"#FF4500\"><b>殺</b></font>或<font color=\"#FF4500\"><b>閃</b></font>使用。當你打出一張<font color=\"#FF4500\"><b>閃</b></font>，可以立刻<font color=\"#FF4500\"><b>使用</b></font>一張殺。<b>【超界突破】</b>：當你已因用閃而打出殺，摸一张牌。",
["thefuture"] = "未來",
[":thefuture"] = "<font color=\"blue\"><b>鎖定技，</b></font>與自己距離或自己與其距離<font color=\"#FF4500\"><b>小於二</b></font>的角色在回合開始前，你可以觀看牌堆上<font color=\"#FF4500\"><b>兩張牌</b></font>，再依次序放回。當以下情況發生，在當前角色行動階段開始時，你可以<font color=\"#FF4500\"><b>摸X張牌</b></font>。(X為符合狀況的數量，每個狀況<font color=\"#FF4500\"><b>不能重複</b></font>計算)\
1.其中有<font color=\"#FF4500\"><b>殺</b></font>，而你手牌<font color=\"#FF4500\"><b>沒有閃</b></font>。\
2.其中有<font color=\"#FF4500\"><b>錦囊牌</b></font>，而你手牌<font color=\"#FF4500\"><b>沒有無懈可擊</b></font>。\
3.其中有<font color=\"#FF4500\"><b>裝備牌</b></font>。",

["solidarity"] = "聲援",
[":solidarity"] = "<font color=\"yellow\"><b>主公技。</b></font>當你對一名<font color=\"blue\"><b>魏</b></font>勢力的武將造成傷害時，你可以與其各摸一张牌。",
["tacitunderstanding"] = "默契",
[":tacitunderstanding"] = "<font color=\"blue\"><b>鎖定技，</b></font>受到<font color=\"#FF4500\"><b>傷害</b></font>或<font color=\"#FF4500\"><b>流失</b></font>體力時，可以翻開牌堆頂<font color=\"#FF4500\"><b>三張</b></font>牌。將至少兩張<font color=\"#FF4500\"><b>相同花色</b></font>的牌加入手牌，其餘棄置。若皆不同，則全棄置、<font color=\"#FF4500\"><b>摸一张牌</b></font>。",
["weareidle"] = "偶像",
[":weareidle"] = "<font color=\"green\"><b>階段技，</b></font>你可以棄置兩張<font color=\"#FF4500\"><b>同花色</b></font>牌(若兩張皆為<font color=\"red\"><b>紅色</b></font>，則恢復一點體力，否則摸一张牌。)，棄置最多<font color=\"#FF4500\"><b>兩名</b></font>角色一張牌。",

["migonoinorislash"] = "祝福",
["migonoinorijink"] = "祝福",
["migonoinori"] = "祝福",
[":migonoinori"] = "<font color=\"blue\"><b>鎖定技，</b></font>每當你需要打出<font color=\"#FF4500\"><b>殺或閃</b></font>時，可以進行一次判定，若為<b>黑桃</b>則視為你打出了該牌，其餘花色則摸一张牌。",
["listentonature"] = "傾聽",
["@listentonature"] = "可以選擇一張黑牌交換判定牌。(沒有更改判定效力，超界突破則隨便選)",
[":listentonature"] = "判定階段<font color=\"#FF4500\"><b>結束</b></font>後，妳可以選擇一張<b>黑牌</b>交換判定牌。(<font color=\"#FF4500\"><b>沒有更改判定效力</b></font>)<b>【超界突破】</b>：不再限定黑牌。",

["imwatching"] = "守望",
["@imwatching"] = "可以棄置一張黑色牌，令當前恢復生命的目標受到無來源雷電傷害。",
[":imwatching"] = "自己以外，一名體力值<font color=\"#FF4500\"><b>一以上</b></font>的角色恢復體力時，其獲得一個<font color=\"#FF4500\"><b>守望標記</b></font>，然後你可以棄置一張<b>黑牌</b>，令其受到一點無來由的<b>雷電傷害</b>(該傷害不會觸發<font color=\"#FF4500\"><b>非鎖定技</b></font>)。若目標的<font color=\"#FF4500\"><b>守望標記</b></font>數量超過一枚，則其必須在回合結束後給你所有裝備和手牌，然後你還給他<font color=\"#FF4500\"><b>等量-X</b></font>至等量的牌，若減去X後為零以下，則可以不還。這之後，清光其標記。若對方沒有牌，則你摸X張牌。(X為守望標記數量，最多三枚)<b>【超界突破】</b>：目標恢復體力、死亡時，你摸X張牌，摸牌順序在獲得標記之前。",

["bougairensha"] = "壓制",
["@bougairensha"] = "可以棄置一張黑牌，阻止這次卡片效果發生。",
["@bougairensha_es"] = "棄置一張與使用牌同花色的牌。(若為複合牌則以第一張的花色為基準。)",
[":bougairensha"] = "一名自己以外的角色使用<font color=\"#FF4500\"><b>殺、決鬥、順手牽羊</b></font>時，若你可以棄置一張<b>黑牌</b>使其無效。",
["sizukana"] = "寧靜",
["@sizukana_choiceplayer"] = "選擇一名角色獲得止水標記，可以選自己。",
[":sizukana"] = "<font color=\"#E88114\"><b>天生技</font></b>。持有<font color=\"#FF4500\"><b>“止水”</b></font>標記者手牌上限加一。回合結束時可以發動此技能，選擇一名目標，令其獲得一枚<font color=\"#FF4500\"><b>“止水”</b></font>標記。那之後，場上擁有<font color=\"#FF4500\"><b>“止水”</b></font>標記者可以<font color=\"#FF4500\"><b>摸一张牌</b></font>。【超界突破】：持有<font color=\"#FF4500\"><b>“止水”</b></font>標記者於摸牌階段多摸一张牌。",

["moekogoro"] = "燃心",
[":moekogoro"] = "<font color=\"blue\"><b>鎖定技，</b></font>你受到的<font color=\"#FF4500\"><b>火焰傷害</b></font>視為恢復體力，若滿體力，則摸牌。(藤甲等增傷效果不計算)",
["hononozouki"] = "炙動",
[":hononozouki"] = "<font color=\"green\"><b>每個目標限一次。</b></font>你的回合中，選擇<font color=\"#FF4500\"><b>自己以外</b></font>的目標進行判定，若為<font color=\"#FF4500\"><b>紅心</b></font>，則恢復一點體力(滿體力則摸<font color=\"#FF4500\"><b>兩張牌</b></font>)，若為<font color=\"#FF4500\"><b>菱形</b></font>，其摸一张牌。使用結束後，你摸此技能指定<font color=\"#FF4500\"><b>目標數量</b></font>的牌。",
["hononochikara"] = "紅蓮",
[":hononochikara"] = "你的<font color=\"#FF4500\"><b>紅色錦囊牌</b></font>在指定目標後，可以視為<font color=\"#FF4500\"><b>火殺</b></font>使用。",

["wisdom_s"] = "榮慧",
[":wisdom_s"] = "判定開始時，妳可以將裝備或手牌與判定牌交換。<b>【超界突破】</b>：如果改判定的牌是<font color=\"#FF4500\"><b>紅心基本牌</b></font>，妳視為使用一張桃(不觸發【竹輪】)。",
["@wisdom-card"] = "可以選擇一張牌與判定牌交換。",
["@kaeriuchi:kaeriuchi"] = "放棄獲得：【%src】，視為使用無中生有？",
["chikuwasama"] = "竹輪",
[":chikuwasama"] = "<font color=\"blue\"><b>鎖定技，</b></font>場上有人用使用<font color=\"#FF4500\"><b>桃</b></font>時，進行一次判定，若是<font color=\"#FF4500\"><b>紅色</b></font>，你與使用者各摸一张牌(若你就是使用者則只摸<font color=\"#FF4500\"><b>一張</b></font>。)，<b>黑色</b>，使用者棄置一張牌，你摸一张牌。當卡片因<font color=\"brown\"><b>【榮慧】</b></font>效果而更改判定時，不論之後是否繼續改判，效果依舊照<font color=\"brown\"><b>【榮慧】</b></font>的改判卡判定。<b>【超界突破】</b>：不再侷限於桃，只要是回復效果都可觸發。",
["#chikuwasama_log"] = "因為 %from 的 “%arg” 效果，%to 的“桃”視為“竹輪”。",
["#chikuwasama_log2"] = "本次判定將遵循 “%arg” 的改判牌。",

["yochi"] = "預知",
[":yochi"] = "<font color=\"blue\"><b>鎖定技，</b></font>當你成為<font color=\"#FF4500\"><b>殺</b></font>的目標，你必須<font color=\"#FF4500\"><b>棄置一張牌摸一张牌</b></font>，然後殺對妳<font color=\"#FF4500\"><b>無效</b></font>。若無法這麼做則殺依然<font color=\"#FF4500\"><b>有效</b></font>。",
["yomi"] = "預視",
[":yomi"] = "<font color=\"#FF4500\"><b>你的回合中</b></font>，你可以觀看任一角色的手牌。",
["kanchi"] = "感知",
[":kanchi"] = "<font color=\"green\"><b>階段技，</b></font>指定一名目標，令其無法從手中打出<font color=\"#FF4500\"><b>基本牌、錦囊牌</b></font>，直到<font color=\"#FF4500\"><b>你的</b></font>回合結束。",

["yuri_guixin"] = "百歸",
["#yg_log"] = "目前【%arg】目標為 %to 。",
["yg_obtain"] = "獲得其牌",
["yg_dis"] = "棄置並令其摸牌",
[":yuri_guixin"] = "每當你受到<font color=\"#FF4500\"><b>一點傷害</b></font>後，你可以對<font color=\"#FF4500\"><b>所有角色</b></font>做出選擇：<font color=\"#FF4500\"><b>棄置</b></font>其一張牌令其<font color=\"#FF4500\"><b>摸一张牌</b></font>，或你<font color=\"#FF4500\"><b>獲得</b></font>其一張牌。若你獲得的牌數<font color=\"#FF4500\"><b>大於</b></font>失去的生命，或你<font color=\"#FF4500\"><b>背面朝上</b></font>，則你<font color=\"#FF4500\"><b>翻面</b></font>。",

["okanemochi"] = "巨資",
[":okanemochi"] = "<font color=\"blue\"><b>鎖定技，</b></font>回合開始時，你摸X張牌，該回合手牌上限增加X，X根據以下條件計算。\
<b>1.</b>已受傷：X+1\
<b>2.</b>手牌數小於三張：X+1\
<b>3.</b>X+延時錦囊牌的數量。",
["#barakurosaku_log"] = "【%arg】使用次數剩下 %arg2 次。",
["barakurosaku"] = "謀策",
[":barakurosaku"] = "<font color=\"pink\"><b>轉換技。</b></font>你可以棄置一張牌，<font color=\"#FF4500\"><b>輪流</b></font>發動以下效果。每回合最多使用三次，每因<font color=\"brown\"><b>【巨資】</b></font>摸一张牌，可額外多一次：1.令一名目標受到一點傷害<font color=\"#FF4500\"><b>摸一张牌</b></font>。2.令一名目標恢復一點體力<font color=\"#FF4500\"><b>棄置兩張牌</b></font>。3.對<font color=\"#FF4500\"><b>自己</b></font>造成一點傷害摸<font color=\"#FF4500\"><b>失去生命數量</b></font><b>+2</b>張牌(最多摸五張)。",

["gensou"] = "幻影",
["genjutsuslash"] = "影襲",
["genjutsu"] = "幻術",
[":genjutsu"] = "<font color=\"blue\"><b>鎖定技，</b></font>回合結束時，若你沒有<font color=\"purple\"><b>“幻影”</b></font>牌，你從牌堆將一張牌至於武將牌上，稱為<font color=\"purple\"><b>“幻影”</b></font>，<font color=\"purple\"><b>“幻影”</b></font>不可見。若有<font color=\"purple\"><b>“幻影”</b></font>牌，則根據持有的牌類型發生效果：\
<b>錦囊牌</b>：將該牌視為殺使用，且<font color=\"#FF4500\"><b>無視防具</b></font>。\
<b>裝備牌、基本牌</b>：你獲得<font color=\"purple\"><b>“幻影”</b></font>牌，\
當你成為來源非自身的<font color=\"#FF4500\"><b>殺</b></font>或<font color=\"#FF4500\"><b>非延時錦囊牌</b></font>的目標時，若該牌與<font color=\"purple\"><b>幻影牌</b></font><font color=\"#FF4500\"><b>花色相同</b></font>，妳免疫該牌，不同，則妳摸一张牌加入<font color=\"purple\"><b>幻影牌</b></font>(最多兩張)。<b>【超界突破】</b>：上限提升至四張。",
["#genjutsu_log"] = "“%arg”的效果， %from 對 %card 免疫！ ",
["#kanshi_dis_log"] = "“%arg”技能發動， %from 可以棄置 %to 一張牌。",
["kanshi"] = "監管",
["kanshi_dis"] = "監管-棄牌",
[":kanshi"] = "一名角色於棄牌階段棄置<font color=\"#FF4500\"><b>小於</b></font>兩張牌，且其<font color=\"#FF4500\"><b>手牌和裝備</b></font>合計數大於等於你，你可以棄置其一張牌(<font color=\"#FF4500\"><b>不觸發非鎖定技</b></font>)。棄置<font color=\"#FF4500\"><b>超過</b></font>一張牌時，妳可以令其摸一张牌。",
["tsuyoiishiki"] = "意志",
[":tsuyoiishiki"] = "<font color=\"blue\"><b>鎖定技，</b></font>遊戲開始時你獲得<font color=\"#FF4500\"><b>三枚</b></font><font color=\"orange\"><b>“硬幣”</b></font>。你判定區的<font color=\"#FF4500\"><b>兵糧寸斷、樂不思蜀</b></font>判定效果反轉。當你的牌被其他人棄置或獲得時，選擇一名目標令其摸失去數量的牌。",
["unlock"] = "解鎖",
[":unlock"] = "本技能有三種效果。\
<b>1.</b>你可以棄置<font color=\"#FF4500\"><b>一枚</b></font><font color=\"orange\"><b>“硬幣”</b></font>，獲得技能<font color=\"brown\"><b>【窺視】</b></font>、<font color=\"brown\"><b>【反制】</b></font>直到下個回合開始時。\
<b>2.</b>當你陷入瀕死階段，必須消耗<font color=\"#FF4500\"><b>三枚</b></font><font color=\"orange\"><b>“硬幣”</b></font>，將體力<font color=\"#FF4500\"><b>恢復至一點</b></font>，然後你摸<font color=\"#FF4500\"><b>恢復量</b></font>的牌。\
<b>3.</b>每當一名目標陷入<font color=\"#FF4500\"><b>瀕死</b></font>，你<font color=\"#FF4500\"><b>獲得</b></font>一枚<font color=\"orange\"><b>“硬幣”</b></font>(最多五枚)。",

["yuri_sizhan"] = "百死",
[":yuri_sizhan"] = "<font color=\"blue\"><b>鎖定技，</b></font>當你受到傷害時，<font color=\"#FF4500\"><b>無效</b></font>那次傷害，然後獲得等同於傷害數量的死戰標記(死戰標記最多<font color=\"#FF4500\"><b>四枚</b></font>，若超過則依舊會<font color=\"#FF4500\"><b>受傷</b></font>)，你每獲得一枚死戰標記，便<font color=\"#FF4500\"><b>摸一张牌</b></font>。回合結束後，若你回合中有使用過殺<font color=\"#FF4500\"><b>造成傷害</b></font>，你必須失去所有死戰標記，然後流失該數量的生命(<font color=\"#FF4500\"><b>最多流失三點</b></font>)。",

["zurunoonkaeshi"] = "恩癒",
[":zurunoonkaeshi"] = "<font color=\"green\"><b>階段技，</b></font>你可以失去一項<font color=\"#FF4500\"><b>技能</b></font>或棄置一張牌，選擇一名受傷目標，其恢復一點體力摸一张牌。若你選擇失去技能，你摸兩張牌。",
["buuzetsu"] = "武絕",
[":buuzetsu"] = "你可以將<b>黑牌</b>當<b>雷殺</b>、<font color=\"red\"><b>紅牌</b></font>當<font color=\"#FF4500\"><b>火殺</b></font>使用或打出。<font color=\"#FF4500\"><b>錦囊牌或無來源</b></font>造成的傷害對你無效。<b>【超界突破】</b>：當妳沒有手牌，受到的所有傷害減一，然後你摸X張牌(X為原傷害數值)。",

["haigu"] = "俳句",
["haigue"] = "恩澤天下",
["haigu_pile"] = "俳字",
[":haigu"] = "<font color=\"green\"><b>行動階段外</b></font>，當你失去牌、受到傷害時，你可以將那張牌(若為受傷則摸牌)至於武將牌上視為<font color=\"red\"><b>“俳字”</b></font>。當你蒐集X張<font color=\"red\"><b>“俳字”</b></font>時(X為575循環)，你<font color=\"#FF4500\"><b>恢復</b></font>一點體力，指定五名以內的目標，令其獲得其中的一張牌，其餘牌棄置。你可以棄置一名目標等同棄置量的牌。",
[":haigu1"] = "<font color=\"green\"><b>行動階段外</b></font>，當你失去牌、受到傷害時，你可以將那張牌(若為受傷則摸牌)至於武將牌上視為<font color=\"red\"><b>“俳字”</b></font>。當你蒐集 %arg1 張<font color=\"red\"><b>“俳字”</b></font>時(X為575循環)，你<font color=\"#FF4500\"><b>恢復</b></font>一點體力，指定五名以內的目標，令其獲得其中的一張牌，其餘牌棄置。你可以棄置一名目標等同棄置量的牌。",
["#haigulog"] = "點選獲益的武將，可以取消此動作。",
["#haigu_pc"] = "點選將被棄牌的武將。",
["~haigu"] = "點選的武將將可以選擇“俳字”獲得。",
["Subetewonomikonmu"] = "神噬",
[":Subetewonomikonmu"] = "<font color=\"green\"><b>階段技，</b></font>當你的暴怒標記為四點以上，你可以翻面、棄置所有標記，並根據標記數量發動效果。\
4點以上：棄置所有目標裝備卡。五點以上：棄置所有目標的全部手牌。六點以上：對所有目標造成一點傷害。七點以上：效果結束後，你摸X張牌、恢復X點體力(X為暴怒標記數量減六)",
["Kuitsukusu"] = "狂吞",
[":Kuitsukusu"] = "<font color=\"blue\"><b>鎖定技，</b></font>當你造成傷害或受到傷害時，獲得那個數量的暴怒標記，然後獲得棄牌堆中第一張紅心牌。",
["@wrath"] = "狂暴憤怒",

["kirisou"] = "斬雙",
["kirisou_umaretuski"] = "斬雙天生技",
["kirisou_e1"] = "棄置其一張牌",
["kirisou_e2"] = "視為再用一張同類型的殺",
["kirisou_ea"] = "兩個都發動，但要棄牌",
[":kirisou"] = "你的殺指定目標後，你能選擇一項：1. 棄置其一張牌。 2.視為再對其使用一張同類型的無色殺。3.棄置兩張手牌然後兩個皆發動(不足也可發動)。<b>【超界突破】</b>：<font color=\"#E88114\"><b>天生技</font></b>。當你不持有武器，你的攻擊距離為2，且當你的殺指定目標，可以令其選擇：棄置一張牌，或使你摸一张牌。",
["gopugu"] = "務樸",
[":gopugu"] = "你可以棄置一張<b>非基本牌</b>然後摸一张牌。你不會受到<font color=\"#FF4500\"><b>殺、決鬥、萬劍齊發、南蠻入侵、火攻</b></font>以外造成的傷害。",
["kirisou_umaretuski:choice"] = "你可以發動斬雙的天生技，令 %src 棄置一張手牌或你摸一张牌。",
["@kirisou_umaretuski"] = "%src：你可以棄置一張手牌，否則 %dest 摸一张牌。",

["genshunoYURI"] = "真百",
[":genshunoYURI"] = "<font color=\"green\"><b>階段技，</b></font>你可以將一張牌當作<font color=\"#FF4500\"><b>非延時錦囊</font></b>或<font color=\"#FF4500\"><b>基本牌</font></b>使用或打出。若為<font color=\"#FF4500\"><b>打出</b></font>，則不受。<font color=\"green\"><b>階段技</b></font>所限制。",
["yuriKansen"] = "百染",
[":yuriKansen"] = "<font color=\"blue\"><b>鎖定技，</b></font>当你对其他角色造成伤害后，或你受到其他角色的伤害后，你令该角色獲得一枚<b>百染標記</b>(<font color=\"#FF4500\"><b>最多一枚</font></b>)，若已持有且其未死亡，則妳摸一张牌。已帶有<b>百染標記</b>的目標使用桃、酒、無中生有、洞燭先機、裝備牌時，你可以令其失去標記，然後妳也成為目標(若為裝備則你成為受益者)。",
["#yuriKansenEffect_log"] = "%from 正打算使用 %card 。",

["restrained"] = "矜持",
[":restrained"] = "<font color=\"blue\"><b>鎖定技，</b></font>準備階段開始與棄牌階段結束，妳必須將手牌補至X+1張，若X+1低於自己的手牌數量，則不動作。(X為所有角色手牌最多的數量，最多為25)",
["ienoimei"] = "家世",
[":ienoimei"] = "<font color=\"yellow\"><b>主公技。</b></font><font color=\"green\"><b>吳勢力</b></font>的角色在你眼中，其手牌數量+X。(X為場上存活的<font color=\"green\"><b>吳勢力</b></font>角色)",

["hunnshin"] = "奮進",
["@hunnshin"] = "要發動【奮進】嗎？(選擇手牌後選擇目標)",
["MWCreate"] = "冶具",
[":hunnshin"] = "<font color=\"green\"><b>行動階段結束</b></font>時，若你至少有一張牌，妳可以將最多2張手牌放置到2名沒有<font color=\"brown\"><b>【冶具】</b></font>的武將牌上，視為<font color=\"brown\"><b>【冶具】</b></font>。\
帶有<font color=\"brown\"><b>【冶具】</b></font>的武將將於行動開始階段時棄置<font color=\"brown\"><b>【冶具】</b></font>，從摸牌堆頂十張牌中，隨機獲得兩張<b>裝備牌</b>或<b>錦囊牌</b>，其餘的牌棄置，若無則摸牌。\
若目標為妳，額外獲得<font color=\"red\"><b>跳過</b></font><font color=\"green\"><b>判定階段</b></font>的效果。",
["tennsainohojyou"] = "天輔",
[":tennsainohojyou"] = "<font color=\"blue\"><b>鎖定技，</b></font><font color=\"green\"><b>回合結束階段</b></font>，若你的手牌數在2以下，你可以棄置任意區域的X張牌進行X次判定(X至多為3)，效果持續到下次自己的<font color=\"green\"><b>回合開始</b></font>。\
1. <b>基本牌</b>：殺對你無效。\
2. <b>錦囊牌</b>：非延時錦囊對你無效。\
3. <b>武器牌</b>：重新做一次判定。\
不論判定結果為何，妳<b>獲得</b>那張牌。<b>【超界突破】</b>：改為進行X+1次判定(X至多為4)。",
["jiyuunokuni"] = "無束",
[":jiyuunokuni"] = "<font color=\"yellow\"><b>主公技。</b></font>妳以外的<font color=\"red\"><b>蜀勢力</b></font>的武將<font color=\"#FF4500\"><b>翻面</b></font>或<font color=\"#FF4500\"><b>橫置</b></font>時，其可以交給你一張手牌，然後<font color=\"#FF4500\"><b>重置</b></font>翻面或橫置。",
["@jiyuunokuni-give"] = "你可以給予 %src 一張牌，來重置這次翻面或橫置。",
["@yurimi_topile"] = "選擇一張手牌或裝備成為【觀】。",
["@yurimi-exchange"] = "選擇將成為【觀】的手牌或裝備，未被選擇的牌將留在原地。",
["yurimipile"] = "觀",
["yurimibirth"] = "觀百-超界突破",
["yurimi:givetoyurimipile"] = "給%src隨機手牌視為【觀】",
["yurimi"] = "觀百",
[":yurimi"] = "<font color=\"#E88114\"><b>天生技</font></b>。場上的<font color=\"palevioletred\"><b>女性</b></font>角色受到<font color=\"palevioletred\"><b>同性</b></font>的指定後，妳摸一张牌，並將一張牌至於武將牌上視為<font color=\"#FF4500\"><b>【觀】</b></font>牌(<font color=\"#FF4500\"><b>至多6張</b></font>，超過則失效)。場上一名武將<font color=\"#FF4500\"><b>受到傷害</b></font>或<font color=\"#FF4500\"><b>流失生命</b></font>時，妳可以令其選一張<font color=\"#FF4500\"><b>【觀】</b></font>獲得。若體力減少者是妳，則<b>必須</b>獲得一張<font color=\"#FF4500\"><b>【觀】</b></font>。\
若你受到<font color=\"lightskyblue\"><b>男性</b></font>或<b>無來由</b>的傷害，則可以發動<font color=\"brown\"><b>【百江】</b></font>，並於摸牌後將一張牌加入<font color=\"#FF4500\"><b>【觀】</b></font>。【超界突破】：上限增為8張。\
<font color=\"blue\"><b>鎖定技</b></font>。<font color=\"green\"><b>回合開始及結束</b></font>，妳可以發動<font color=\"#FF4500\"><b>【觀】</b></font>張數的觀星。<font color=\"green\"><b>摸牌階段結束</b></font>，妳可以用任意數量的牌交換等量的<font color=\"#FF4500\"><b>【觀】</b></font>。",
["yuri_hengjiang_choiceplayer"] = "選擇一名自己以外的目標獲取百橫標記。",
["#yuri_hengjiang_log"] = "%from 的 “%arg2”技能生效，將給予 %to 共 %arg 枚的<font color=\"#FF4500\"><b>“百江”</b></font>標記。",
["yuri_hengjiang"] = "百江",
[":yuri_hengjiang"] = "當你受到傷害時，可以選擇一名目標獲得該傷害數的<font color=\"#FF4500\"><b>“百江”</b></font>標記，每有一枚標記手牌上限-1。其回合結束時失去一枚標記。(【超界突破】：若不棄牌，則其不會失去標記。)若沒有棄牌，你恢復一點體力。若有或你滿體力，則你摸一张牌。",

["yuryounowaku"] = "領惑",
[":yuryounowaku"] = "一名目標的<font color=\"green\"><b>行動階段開始</b></font>，妳可以與其<font color=\"#FF4500\"><b>交換</b></font><b>全身所有牌</b>。若你這麼做，其<font color=\"green\"><b>行動階段結束</b></font>時，妳與其<font color=\"#FF4500\"><b>交換</b></font><b>全身所有牌</b>。",

["keishoukaki"] = "經撰",
[":keishoukaki"] = "你可以將任意數量的手牌至於武將牌上，視為<font color=\"#FF4500\"><b>“太平經”</b></font>。一場遊戲最多僅能獲取<b>10張</b><font color=\"#FF4500\"><b>“太平經”</b></font>。\
<font color=\"green\"><b>回合開始</b></font>，妳可以選擇以下一項發動，但<b>無法連續兩回合發動同一效果</b>。效果直到下次你的回合開始。\
<b>【金】</b>：場上所有武將，在<b>使用三張牌</b>後直接<font color=\"#FF4500\"><b>結束階段</b></font>。\
<b>【木】</b>：場上所有武將在其<font color=\"green\"><b>回合結束</b></font>時，可以棄置一張手牌，<b>摸兩張牌</b>。\
<b>【水】</b>：場上所有武將的恢復時，受恢復者可棄置一張<font color=\"red\"><b>紅色手牌</b></font>，令恢復力<font color=\"#FF4500\"><b>+1</b></font>。\
<b>【火】</b>：造成<font color=\"#FF4500\"><b>屬性</b></font>傷害時，來源可以棄置一張黑桃手牌，令傷害<font color=\"#FF4500\"><b>+1</b></font>。\
<b>【土】</b>：造成<b>非屬性</b>傷害時，受害者可以棄置一張<b>黑色手牌</b>，令傷害<font color=\"#FF4500\"><b>-1</b></font>。\
本技能效果發生時，你可以選擇：<b>1.</b>無效該次效果，<b>2.</b>本次效果無須棄牌。若你有選擇以上其中之一，你棄置一張<font color=\"#FF4500\"><b>“太平經”</b></font>然後摸一张牌。",
["taiheikei"] = "太平經",
["kana"] = "金",
[":kana"] = "場上所有武將，在使用三張牌後直接結束階段。",
["kana_counter"] = "金：已使用牌",
["moku"] = "木",
[":moku"] = "場上所有武將在其回合結束時，可以棄置一張手牌，摸兩張牌。",
["mizu"] = "水",
[":mizu"] = "場上所有武將的恢復時，受恢復者可棄置一張紅色手牌，令恢復力+1。",
["hono"] = "火",
[":hono"] = "造成屬性傷害時，來源可以棄置一張黑桃手牌，令傷害+1。",
["daiji"] = "土",
[":daiji"] = "造成非屬性傷害時，受害者可以棄置一張黑色手牌，令傷害-1。",
["active_effect"] = "強制生效",
["cancel_effect"] = "強制取消",
["#taiheikei_pre_log"] = "“%arg2”： %from 的 <b>【</b > %arg <b>】</b >屬性效果準備生效。",
["#daiji_log"] = "%from 的 “%arg2”屬性<font color=\"peru\"><b>【土】</b></font>之影響，本次普通傷害降減為 %arg 點。",
["#hono_log"] = "%from 的 “%arg2”屬性<font color=\"crimson\"><b>【火】</b></font>之影響，本次屬性傷害提升為 %arg 點。",
["#mizu_log"] = "%from 的 “%arg2”屬性<font color=\"cornflowerblue\"><b>【水】</b></font>之影響，本次恢復效果提升為 %arg 點。",
["#moku_log"] = "%from 的 “%arg2”屬性<font color=\"limegreen\"><b>【木】</b></font>之影響，回合結束可摸 %arg 張牌。",
["#kana_log"] = "%from 的 “%arg2”屬性<font color=\"gold\"><b>【金】</b></font>之影響，使用 %arg 張牌後強制結束階段。",
["@mizu_recover_ask"] = "太平經【水】：你可以棄置一張紅色手牌，令本次恢復增加一點。",
["@hono_damage_ask"] = "太平經【火】：你可以棄置一張黑桃手牌，令本次傷害增加一點。",
["@daiji_damage_ask"] = "太平經【土】：你可以棄置一張梅花手牌，令本次傷害減少一點。",
["@moku_draw_ask"] = "太平經【木】：你可以棄置一張手牌，然後摸兩張牌。",

["taigyokunoyousei"] = "邀棋",
[":taigyokunoyousei"] = "<font color=\"blue\"><b>鎖定技</b></font>。<font color=\"green\"><b>遊戲開始</b></font>，你令全場獲得<font color=\"brown\"><b>【落子】</b></font>技能，並獲得一枚<b>“落子：黑”</b>標記。場上所有武將成為<b>其他</b>持有相同<b>“落子標記”</b>之武將的目標時，棄置一張手牌(若目標是你，則不棄牌)。不同，摸兩張牌棄置一張牌。",
["gomaoku"] = "落子",
[":gomaoku"] = "<font color=\"green\"><b>階段技</b></font>。1.當你擁有<b>“落子：黑”</b>標記時，可以棄置一張<font color=\"red\"><b>紅色</b></font>手牌，獲得</b><font color=\"#FF4500\"><b>“落子：紅”</b></font>、失去<b>“落子：黑”</b>。\
2.當你擁有<font color=\"#FF4500\"><b>“落子：紅”</b></font>標記時，可以棄置一張<b>黑色</b>手牌，獲得<b>“落子：黑”</b>、失去</b><font color=\"#FF4500\"><b>“落子：紅”</b></font>。\
標記更換前，你令持有<font color=\"brown\"><b>【邀棋】</b></font>技能者選擇一項 ：1.摸一张牌；2.自己的落子標記換成另一種顏色。若你自己擁有<font color=\"brown\"><b>【邀棋】</b></font>，則必定摸牌。",
["gomaoku_black"] = "【落子】：黑",
["gomaoku_red"] = "【落子】：紅",
["change_goma"] = "更換落子標記顏色",
["hb_yitain"] = "倚天",
[":hb_yitain"] = "<font color=\"blue\"><b>鎖定技</b></font>。若你沒裝備武器，你的攻擊距離等同你的當前生命。你的殺被<font color=\"#FF4500\"><b>閃</b></font>抵銷且該<font color=\"#FF4500\"><b>閃</b></font>置入棄牌堆時，你獲得該<font color=\"#FF4500\"><b>閃</b></font>。【超界突破】：該<font color=\"#FF4500\"><b>閃</b></font>沒有落入棄牌堆則你摸一张牌。你的<font color=\"#FF4500\"><b>閃</b></font><b>不會算入手牌數量</b>。",
["@hb_konoyaiba_uketemiyo"] = "【鬥陣】：選擇一名要打出【%src】的受害者。",
["@konayaiba-discard"] = "請打出一張【%src】，否則受到來自 %arg 的一點傷害。",
["hb_konoyaiba_uketemiyo"] = "鬥陣",
[":hb_konoyaiba_uketemiyo"] = "當你打出一張<font color=\"#FF4500\"><b>閃</b></font>/<b>殺</b>，你可以令除自己之外的一名在<b>攻擊範圍內</b>且生命在你<b>以下</b>的目標打出一張<b>殺</b>/<font color=\"#FF4500\"><b>閃</b></font>，否則受到來自於你的一點傷害。",
["nikuhei"] = "肉濘",
[":nikuhei"] = "<font color=\"blue\"><b>鎖定技</b></font>。每次你受到<b>通常傷害</b>時，若為一點則無效之，然後你獲得一枚<font color=\"#FF4500\"><b>“死戰”</b></font>標記。若<b>兩點以上或為屬性傷害</b>，該傷害增加<font color=\"#FF4500\"><b>“死戰”</b></font>標記數，再令其<b>傷害翻倍</b>，然後棄置所有<font color=\"#FF4500\"><b>“死戰”</b></font>標記。若傷害來源的生命值少於你，你令其摸一张牌。回合結束時，若你的最大生命值大於3，且至少損失了兩點生命，你必須恢復一點生命然後失去一點最大生命值，重複此流程直到生命全滿。",
-- ["nikuhei_p"] = "肉牆",
-- [":nikuhei_p"] = "<font color=\"blue\"><b>鎖定技</b></font>。你與其<b>距離為一</b>的角色受你及其自己之外的角色的<font color=\"#FF4500\"><b>非延時錦囊、殺、桃</b></font>指定時，你<b>代替</b>成為目標。",
["#nikuhei_p_log"] = "由於 %arg 的效果，%from的%card指定對象改為%to。",
["#nikuhei_p_log2"] = "(原始目標為：%to)。",
["nikuhei_k"] = "王肉",
[":nikuhei_k"] = "<font color=\"yellow\"><b>主公技。</b></font>當<b>基本牌</b>或<font color=\"#FF4500\"><b>錦囊牌</b></font>卡片使用結束，若你曾為該目標，且使用者不為你，你可以令使用者摸一张牌，如果你的生命值<b>小於等於</b>使用者，你額外恢復一點生命。",
}

--[[
	-- 技能名：忠貞
	-- 相关武将：學習 限界突破 王異
	-- 描述：當你成為殺或錦囊牌的目標時，你可以失去一點體力、棄置一張牌，然後獲得對方的一張牌並無效指定，之後回合結束前你將不再受到傷害。
	-- 引用：LuaXNosLonghun、LuaXDuojian(不受傷的腳本寫在雪恥那)
	-- 状态：1217验证通过player:hasFlag("ZhenlieTarget") or effect.to:getRoom():setPlayerFlag(effect.to, "ckshiliangtarget")
-- ]]--
LuaZhenlie = sgs.CreateTriggerSkill{
	name = "LuaZhenlie" ,
	events = {sgs.TargetConfirmed} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
			if event == sgs.TargetConfirmed then
				local current = room:getCurrent()
				local use = data:toCardUse()
				if use.to:contains(player) and use.from:objectName() ~= player:objectName() then
					if use.card:isKindOf("Slash") or use.card:isNDTrick() then
						if player:canDiscard(player, "he") and room:askForSkillInvoke(player, self:objectName(), data) then
							room:askForDiscard(player,self:objectName(),1,1,false,true)
							room:broadcastSkillInvoke("zhenlie", math.random(1, 2))
							local nullified_list = use.nullified_list
							table.insert(nullified_list, player:objectName())
							use.nullified_list = nullified_list
							data:setValue(use)
							if room:askForChoice(player, "LuaZhenlie", "losehp+no", data) == "losehp" then
								room:addPlayerMark(player, "LuaZhenlie-Clear")
								room:addPlayerMark(player, "&LuaZhenlie-Clear")
								room:loseHp(player)
								if not player:isAlive() then return end
								if player:canDiscard(use.from, "he") then
									local id = room:askForCardChosen(player, use.from, "he", self:objectName(), false, sgs.Card_MethodNone)
									room:obtainCard(player, id)
								end
								local slash = sgs.Sanguosha:cloneCard("fire_slash", sgs.Card_NoSuit, 0)
								slash:deleteLater()
								slash:setSkillName(self:objectName())
								room:useCard(sgs.CardUseStruct(slash, player, current), false)					
							else
								if player:canDiscard(use.from, "he") then
									local id = room:askForCardChosen(player, use.from, "he", self:objectName(), false, sgs.Card_MethodDiscard)
									room:throwCard(id, use.from, player)
								end
							end
						end
					end
				end
			end
		return false
	end
}
LuaZhenlie_buff = sgs.CreateTriggerSkill{
	name = "#LuaZhenlie_buff",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.DamageInflicted},
	on_trigger = function(self, event, player, data)
		local damage = data:toDamage()
		local room = player:getRoom()
		local target = damage.to
		if damage.to:getMark("LuaZhenlie-Clear") > 0 then
			local log = sgs.LogMessage()
			log.type = "#Revenge_log"
			log.from = player
			log.to:append(damage.from)
			log.arg = "LuaRevenge"
			room:sendLog(log)
			damage.prevented = true
			data:setValue(damage)
			return true
		end
		return false
	end,
}
--[[
	技能名：獨當（觉醒技）
	相关武将：棗乃乃
	描述：覺醒技。回合開始階段若裝備數量大於等於手牌，你棄置所裝備然後摸棄置數量的牌、失去本技能並失去一點體力上限獲得"亂武"、"焚城"、"間書"，同時額外獲得三點間書標記。
	引用：LuaRuoyu
	状态：1217验证通过
]]--
independent = sgs.CreateTriggerSkill{
	name = "independent",
	events = {sgs.EventPhaseStart},
	frequency = sgs.Skill_Wake,
	waked_skills = "fencheng,luanwu,jianshu,xiongyi,fenwei",
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		-- room:addPlayerMark(player, "independent")
			room:setPlayerMark(player, "independent", 1)
			if room:changeMaxHpForAwakenSkill(player, -1, self:objectName()) and player:getMark("independent") == 1 then
				room:doLightbox("$nonowake") --這是顯示字
				room:broadcastSkillInvoke("independent", 1)
				-- room:doSuperLightbox("nono","independent")
				room:setEmotion(player, "skill/yuri_independent")
				-- local ecards = player:getEquips()
				local ecards = player:getCards("je")
				local count = player:getCards("je"):length() + 2
				local allecard = DummyCard:clone()
				allecard:deleteLater()
				for _,dis in sgs.qlist(ecards) do
					allecard:addSubcard(dis)
				end
				room:throwCard(allecard, player)
				room:acquireSkill(player, "fencheng")
				room:acquireSkill(player, "luanwu")
				room:acquireSkill(player, "jianshu")
				room:acquireSkill(player, "xiongyi")
				room:acquireSkill(player, "fenwei")
				-- room:acquireSkill(player, "shenfen")
				room:detachSkillFromPlayer(player, "independent")
				player:drawCards(count)
				-- player:gainMark("@wrath", 6)
				player:gainMark("@jianshuMark", 3)
			end
		return false
	end ,

	can_trigger = function(self, target)
		return target and (target:getPhase() == sgs.Player_Start)
				and target:hasSkill("independent")
				and target:isAlive()
				and target:getEquips():length() >= target:getHandcardNum() or target:canWake(self:objectName())
	end
}

--[[
	技能名：松子
	相关武将：棗乃乃
	描述：鎖定技。若你的手牌數大於等於裝備數量，你受到傷害時必須棄置一張手牌來免疫即將受到的傷害。若你已覺醒，你可以棄置裝備區或判定區的牌，也能決定是否要棄置牌抵擋傷害，如果你否定，對方必須棄置一張紅心手牌否則讓你選擇，令他失去所有裝備或失去所有手牌。
	引用：
	状态：1217验证通过
]]--

machiko = sgs.CreateTriggerSkill{
	name = "machiko",  
	frequency = sgs.Skill_Compulsory, 
	events = {sgs.DamageInflicted},  
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()
		local source = damage.from
		if player:isAllNude() then return false end
		if player:getMark("@waked") > 0 then
			if room:askForSkillInvoke(player, self:objectName(), data) then
				local id = room:askForCardChosen(player, player, "jhe", self:objectName())
				room:throwCard(id, nil)
				room:broadcastSkillInvoke("machiko", math.random(1, 2))
				damage.prevented = true
                data:setValue(damage)
                return true
				-- damage.damage = -10
				-- data:setValue(damage)
			else
				room:broadcastSkillInvoke("machiko", 3)
				-- if not room:askForCard(source, ".|heart|.", "@machiko") then
					-- if room:askForChoice(player, "machiko", "discard+losequip") == "discard" then
						-- local acards = source:getHandcards()
						-- local allcard = DummyCard:clone()
						-- for _,dis in sgs.qlist(acards) do
							-- allcard:addSubcard(dis)
						-- end
						-- room:throwCard(allcard, source, player)
					-- else
						-- local acards = source:getEquips()
						-- local allcard = DummyCard:clone()
						-- for _,dis in sgs.qlist(acards) do
							-- allcard:addSubcard(dis)
						-- end
						-- room:throwCard(allcard, source, player)
					-- end
				-- end
				if room:askForChoice(player, "machiko", "xiongyi+fenwei") == "xiongyi" then
					room:loseHp(player)
					player:gainMark("@arise")
				else
					player:gainMark("@fenwei")
				end
				return false
			end
		else
			if not player:isKongcheng() then
				local id = room:askForCardChosen(player, player, "h", self:objectName())
				room:throwCard(id, nil)
				room:broadcastSkillInvoke("machiko", math.random(1, 2))
				damage.prevented = true
                data:setValue(damage)
                return true
			end
		end
		return false
	end,
}
--[[
	技能名：復仇2_雪恥
	相关武将：JSP王異
	描述：鎖定技。你有25%的機會使造成的傷害翻倍，你每失去一點體力，翻倍機率提升25%。若爆擊發動，你可以讓受傷者或你摸該傷害數量的牌。
	引用：
	状态：1217验证通过
]]--

LuaRevenge = sgs.CreateTriggerSkill{
	name = "LuaRevenge",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.DamageCaused},
	on_trigger = function(self, event, player, data)
		local damage = data:toDamage()
		local target = damage.to
		local user = damage.from
        local room = player:getRoom()
		if damage.chain or damage.transfer or not damage.by_user then return false end
		-- local reason = damage.card
		local num = math.random(1, 100)
		local crit = 25 + user:getLostHp()*25
		-- if reason and num <= crit then
		if num <= crit then
		    user:setFlags("revenged")
			local log = sgs.LogMessage()
			log.type = "#Revenge_log2"
			log.from = user
			log.to:append(damage.to)
			log.arg = damage.damage*2
			log.arg2 = "LuaRevenge"
			room:sendLog(log)
			damage.damage = damage.damage*2
			data:setValue(damage)
		else
			data:setValue(damage)
		end
		return false
	end,
	can_trigger = function(self, target)
		return target and target:hasSkill(self:objectName()) and target:isAlive()
	end
}

LuaRevengeforcard = sgs.CreateTriggerSkill{
	name = "#LuaRevengeforcard",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.Damage, sgs.DamageDone},
	on_trigger = function(self, event, player, data)
		local damage = data:toDamage()
		local room = player:getRoom()
		local target = damage.to
		if (event == sgs.DamageDone) and damage.from and damage.from:hasSkill(self:objectName()) and damage.from:isAlive() then
			local JSPwonyi = damage.from
			JSPwonyi:setTag("invokeLuaRevengeforcard", sgs.QVariant(JSPwonyi:hasFlag("revenged")))
		elseif (event == sgs.Damage) and player:hasSkill(self:objectName()) and player:isAlive() then
			local invoke = player:getTag("invokeLuaRevengeforcard"):toBool()
			player:setTag("LuaRevengeforcard", sgs.QVariant(false))
			if invoke then
				damage.from:setFlags("-revenged")
				if room:askForChoice(player, "LuaRevenge", "itsmine+giveyou", data) == "itsmine" then
					damage.from:drawCards(damage.damage)
				else
					damage.to:drawCards(damage.damage*2)
				end
			end
		end
		return false
	end,
	can_trigger = function(self, target)
		return target
	end
}


--[[
	技能名：蟲主
	相关武将：王趙英
	描述：
	引用：急救、連理殺
	状态：1217验证通过
]]--

PoisonMaggotsCard = sgs.CreateSkillCard{
	name = "PoisonMaggotsCard", 
	target_fixed = false,
	will_throw = false,
	filter = function(self, targets, to_select) 
		if #targets == 0 then
			local bifalist = to_select:getPile("Maggots")
			if (bifalist:isEmpty()) or (bifalist:length() + self:getSubcards():length() <= 2) then
				return (to_select:objectName() ~= sgs.Self:objectName())
				-- return (sgs.Self:inMyAttackRange(to_select))
			end
		end
		return false
	end,
	on_use = function(self, room, source, targets)
		local ids = self:getSubcards()
		local n = ids:length()
		for _,id in sgs.qlist(ids) do
			targets[1]:addToPile("Maggots", id, true)
		end
	end
}

PoisonMaggotsVS = sgs.CreateViewAsSkill{
	name = "PoisonMaggots", 
	n = 2, 
	view_filter = function(self, selected, to_select)
		return (not to_select:isKindOf("BasicCard")) and (to_select:isRed() or to_select:isKindOf("EquipCard"))
	end, 
	view_as = function(self, cards)
		if #cards > 0 then
			local acard = PoisonMaggotsCard:clone()
			for _,card in pairs(cards) do
				acard:addSubcard(card)
			end
			acard:setSkillName(self:objectName())
			return acard
		end
	end, 
	enabled_at_play = function(self, player)
		return true
	end, 
	enabled_at_response = function(self, player, pattern)
		return false
	end
}

PoisonMaggots = sgs.CreateTriggerSkill{
	name = "PoisonMaggots",  
	frequency = sgs.Skill_NotFrequent, 
	events = {sgs.EventPhaseStart}, 
	view_as_skill = PoisonMaggotsVS, 
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if player:getPhase() == sgs.Player_Judge then
			local Maggots_list = player:getPile("Maggots")
			local MaggotMom = room:findPlayerBySkillName(self:objectName())
			local sentlog = false
			if not MaggotMom then return false end
			if Maggots_list:length() > 0 then
			local n = 0
			n = Maggots_list:length()
			local choice = room:askForChoice(MaggotMom, self:objectName(), "callback+staythere+staythereforAlly")
			if choice == "staythere" then
			    if not sentlog then
			        local log = sgs.LogMessage()
					log.from = player
					log.type = "#PoisonMaggotsChoiceLog1"
					log.arg = "PoisonMaggots"
					room:sendLog(log)
				end
				sentlog = true
				if player:getMark("@beam") > 0 then
				room:setPlayerMark(player, "@beam", 0)
			    end
			    return false 
			end
            if choice == "staythereforAlly" then 
			  	if not sentlog then
					local log = sgs.LogMessage()
					log.from = player
					log.type = "#PoisonMaggotsChoiceLog2"
					log.arg = "PoisonMaggots"
					room:sendLog(log)
				end
				sentlog = true
			    player:setFlags("ForAllyMaggot")
				if player:getMark("@beam") == 0 then
				room:addPlayerMark(player, "@beam")
			    end
				return false 
			end
			if choice == "callback" then 
			    if not sentlog then
					local log = sgs.LogMessage()
					log.from = player
					log.type = "#PoisonMaggotsChoiceLog3"
					log.arg = "PoisonMaggots"
					room:sendLog(log)
				end
                sentlog = true
			  
			    -- if player:getMark("@beam") > 0 then
				-- room:setPlayerMark(player, "@beam", 0)
			    -- end
				local maggotscount = 0
				for i = 1,n,1 do
					if not player:isAlive() then break end
					if Maggots_list:length() == 0 then return false end
					local card_id = Maggots_list:first()
					local card = sgs.Sanguosha:getCard(card_id)
					Maggots_list:removeOne(card_id)
					-- room:throwCard(card, player)
					room:moveCardTo(card, MaggotMom, sgs.Player_PlaceHand)
					Maggots_list = player:getPile("Maggots")

					if MaggotMom:canDiscard(player, "hej") then
					    local OBcard_id = room:askForCardChosen(MaggotMom, player, "hej", self:objectName())
						local log = sgs.LogMessage()
						log.type = "#PoisonMaggotsLogGetCard"
					    log.card_str = card:toString()
					    room:sendLog(log)
					    room:obtainCard(MaggotMom, OBcard_id)
						maggotscount = maggotscount + 1

						
						if maggotscount >= 2 then
						    -- room:damage(sgs.DamageStruct("PoisonMaggotsdamage", MaggotMom, MaggotMom, 1, sgs.DamageStruct_Thunder))
							local log = sgs.LogMessage()
							log.from = MaggotMom
							log.type = "#PoisonMaggotsLogKillself"
					        log.card_str = card:toString()
					        room:sendLog(log)
							
							room:loseHp(MaggotMom)
							
						end
                    else
					    room:damage(sgs.DamageStruct("PoisonMaggotsdamage", MaggotMom, player, 1, sgs.DamageStruct_Thunder))
	                        local log = sgs.LogMessage()
							log.type = "#PoisonMaggotsLogGetHP"
					        log.card_str = card:toString()
					        room:sendLog(log)
					    if MaggotMom:isWounded() then

					        local theRecover = sgs.RecoverStruct()
					        theRecover.recover = 1
		                    theRecover.who = MaggotMom
		                    room:recover(MaggotMom, theRecover)	
							
					    end
					end
			    end
				end
			end
		end
		return false
	end, 
	can_trigger = function(self, target)
		return target
	end
}

-- ParasiticMaggots = sgs.CreateMaxCardsSkill{ -- 蛆蟲限制目標最大手牌
	-- name = "#ParasiticMaggots" ,
	-- extra_func = function(self, target)
	
		-- if target:getPile("Maggots"):isEmpty() and (not target:hasSkill("PoisonMaggots")) then -- 判斷沒被寄生的對象
		    -- return 0
		-- end
		-- if target:hasSkill("PoisonMaggots") then -- 判斷是否蟲主
		    -- return 2
		-- end
		-- if (not target:getPile("Maggots"):isEmpty()) and (not target:hasFlag("ForAllyMaggot")) then -- 判斷是否被寄生且沒有友善標記
			-- return -target:getPile("Maggots"):length()
		-- end
		-- if (not target:getPile("Maggots"):isEmpty()) and target:hasFlag("ForAllyMaggot") then -- 判斷是否被寄生且有友善標記
			-- return target:getPile("Maggots"):length()
		-- end
	-- end
-- }

MaggotsShield = sgs.CreateTriggerSkill{ -- 蛆蟲抵制傷害
	name = "#MaggotsShield",
	events = {sgs.PreDamageDone},
	
	on_trigger = function(self, event, player, data)
		local damage = data:toDamage()
		-- local victim = damage.to
		local killer = damage.from
		
		if player:hasSkill("PoisonMaggots") and (not killer:getPile("Maggots"):isEmpty()) and (killer:getMark("@beam") == 0) then
			local room = killer:getRoom()
			local Maggots_list = killer:getPile("Maggots")
			if Maggots_list:length() > 0 then
			local n = Maggots_list:length()
			n = Maggots_list:length()
			    for i = 1,n,1 do
					if not player:isAlive() then break end
					if damage.damage <= 0 then
					damage.damage = 0
					break
					end
                    
					if Maggots_list:length() == 0 then break end
					local card_id = killer:getPile("Maggots"):first()
					local card = sgs.Sanguosha:getCard(card_id)
					Maggots_list:removeOne(card_id)
					room:throwCard(card, killer)
					damage.damage = damage.damage - 1
					Maggots_list = killer:getPile("Maggots")
                    local log = sgs.LogMessage()
					log.type = "#MaggotsShield_log"
					log.from = damage.from
					log.to:append(damage.to)
					log.arg = damage.damage
					log.card_str = card:toString()
					room:sendLog(log)
			    end
			end
			data:setValue(damage)
			return false
		end
		
		if (not player:getPile("Maggots"):isEmpty()) and (player:getMark("@beam") > 0) then
			local room = player:getRoom()

			local Maggots_list = player:getPile("Maggots")
			-- local MaggotMom = room:findPlayerBySkillName(self:objectName())
			-- if not MaggotMom then return false end
			if Maggots_list:length() > 0 then
			local n = Maggots_list:length()
			n = Maggots_list:length()
			    for i = 1,n,1 do
					if not player:isAlive() then break end
					if damage.damage <= 0 then
					damage.damage = 0
					break
					end
					-- if Maggots_list:length() == 0 then return false end
					if Maggots_list:length() == 0 then break end
					local card_id = player:getPile("Maggots"):first()
					local card = sgs.Sanguosha:getCard(card_id)
					Maggots_list:removeOne(card_id)
					room:throwCard(card, player)
					damage.damage = damage.damage - 1
					Maggots_list = player:getPile("Maggots")
                    local log = sgs.LogMessage()
					log.type = "#MaggotsShield_log"
					log.from = damage.from
					log.to:append(damage.to)
					log.arg = damage.damage
					log.card_str = card:toString()
					room:sendLog(log)
			    end
			end
			data:setValue(damage)
			return false
		end
		return false
	end,
	can_trigger = function(self, target)
		return target and ((not target:getPile("Maggots"):isEmpty()) or target:hasSkill("PoisonMaggots"))
	end
}

--[[
-- LuaXDuojian = sgs.CreateTriggerSkill{ --高達技能_借用
	-- name = "#LuaXDuojian",
	-- frequency = sgs.Skill_NotFrequent,
	-- events = {sgs.EventPhaseStart},
	-- on_trigger = function(self, event, player, data)
		-- if player:getPhase() == sgs.Player_Start then
		    -- if player:askForSkillInvoke(self:objectName(), data) then
			    -- local room = player:getRoom()
			    -- local others = room:getOtherPlayers(player)
			    -- for _,p in sgs.qlist(others) do
			    -- if not p:getPile("Maggots"):isEmpty() then
				-- local card_id = p:getPile("Maggots"):first()
				-- local card = sgs.Sanguosha:getCard(card_id)
				-- room:throwCard(card, p)
				-- room:damage(sgs.DamageStruct("PoisonMaggotsdamage", player, p, 1, sgs.DamageStruct_Thunder))
				-- if player:isWounded() then
					-- local theRecover = sgs.RecoverStruct()
					-- theRecover.recover = 1
		            -- theRecover.who = player
		            -- room:recover(player, theRecover)			
				-- end
				-- local log = sgs.LogMessage()
					-- log.type = "#test"
					-- room:sendLog(log)
				
			    -- end
			    -- end
			-- end
		-- end
		-- return false
	-- end,
	-- can_trigger = function(self, target)
		-- if target then
			-- if target:hasSkill(self:objectName()) then
				-- if target:isAlive() then
				    -- local room = target:getRoom()
			        -- local others = room:getOtherPlayers(target)
				    -- local tatalgen = 0
				    -- local x = 0
				    -- for _,p in sgs.qlist(others) do
					    -- tatalgen = tatalgen + 1
			            -- if not p:getPile("Maggots"):isEmpty() then
				            -- x = x + 1
				        -- end
					-- end
		            -- local count = math.max(1, math.ceil(tatalgen/2))
					-- local count = math.ceil(tatalgen/2)
					-- if x >= count then
					    -- return true
					-- else
					    -- return false
					-- end
				-- end
			-- end
		-- end
		-- return false
	-- end
-- }
]]--

--[[
	技能名：歸巢
	相关武将：王趙英
	描述：
	引用：涅槃
	状态：1217验证通过
]]--

maggotsavethelord = sgs.CreateTriggerSkill{
	name = "maggotsavethelord",
	frequency = sgs.Skill_Limited,
	events = {sgs.AskForPeaches},
	on_trigger = function(self, event, player, data)

		local room = player:getRoom()
		local dying_data = data:toDying()
		local source = dying_data.who
		local others = room:getOtherPlayers(player)

		if source:objectName() == player:objectName() then
			if player:askForSkillInvoke(self:objectName(), data) then
				room:doLightbox("$wangzouenmasterskill", 3000) --這是顯示字
                -- room:doSuperLightbox("wangzouen","maggotsavethelord")
				room:getThread():delay(700)
				local log = sgs.LogMessage()
		        log.type = "#backhome"
		        room:sendLog(log)
				-- player:loseMark("@nirvana")
				-- player:throwAllCards()
                -- local room = player:getRoom()
			    -- local others = room:getOtherPlayers(player)
			    for _,p in sgs.qlist(others) do
					if not p:getPile("Maggots"):isEmpty() then
						local card_id = p:getPile("Maggots"):first()
						local card = sgs.Sanguosha:getCard(card_id)
						room:throwCard(card, p)
						if p:getMark("@beam") == 0 then
						
							local liveDamage = sgs.DamageStruct()
							liveDamage.from = player
							liveDamage.to = p
							liveDamage.damage = 1
							liveDamage.nature = sgs.DamageStruct_Thunder
							liveDamage.chain = false
							-- liveDamage.transfer = false --無效鐵鎖連環傳導
							room:damage(liveDamage)
						
						-- room:damage(sgs.DamageStruct("PoisonMaggotsdamage", player, p, 1, sgs.DamageStruct_Thunder))
						end
						if player:isWounded() then
							local theRecover = sgs.RecoverStruct()
							theRecover.recover = 1
							theRecover.who = player
							room:recover(player, theRecover)			
						end
					end
			    end
				
			end
		end
		return false
	end,
	can_trigger = function(self, target)
		if target then
			if target:hasSkill(self:objectName()) then
				if target:isAlive() then
				    local room = target:getRoom()
			        local others = room:getOtherPlayers(target)
				    local tatalgen = 0
				    local x = 0
				    for _,p in sgs.qlist(others) do
					    tatalgen = tatalgen + 1
			            if not p:getPile("Maggots"):isEmpty() then
				            x = x + 1
				        end
					end
		            -- local count = math.max(1, math.ceil(tatalgen/2))
					local count = math.ceil(tatalgen/2)
					if x >= count then
					    return true
					else
					    return false
					end
				end
			end
		end
		return false
	end
}

-- ndhuli = sgs.CreateTriggerSkill{ --你造成伤害时，可以防止该伤害并令一名已受伤的角色回复等量体力，若造成伤害的牌为锦囊牌，则你本回合内不能再次使用该技能。
	-- name = "ndhuli",
	-- frequency = sgs.Skill_NotFrequent,
	-- events = {sgs.DamageCaused},
	-- on_trigger = function(self, event, player, data)
		-- local room = player:getRoom()
		-- local damage = data:toDamage()
		-- local card = damage.card
		-- if not room:getCurrent():hasFlag("ndhuliused") then
			-- local targets = sgs.SPlayerList()
			-- for _,p in sgs.qlist(room:getAlivePlayers()) do
				-- if p:isWounded() then 
					-- targets:append(p)
				-- end
			-- end
			-- if targets:isEmpty() then return false end
			-- if room:askForSkillInvoke(player, self:objectName(), data) then
				-- local target = room:askForPlayerChosen(player, targets, self:objectName())
				-- if target then
					-- local recover = sgs.RecoverStruct()
					-- recover.who = player
					-- recover.recover = math.min(damage.damage, target:getLostHp())
					-- room:broadcastSkillInvoke(self:objectName(),1)
					-- local json = require("json")
					-- local jsonValue = {
					-- target:objectName(),
					-- "revive"
					-- }
					-- room:doBroadcastNotify(room:getAllPlayers(),sgs.CommandType.S_COMMAND_SET_EMOTION, json.encode(jsonValue))
					-- room:recover(target, recover)
					-- if card and card:isKindOf("TrickCard") then
						-- room:setPlayerFlag(room:getCurrent(),"ndhuliused")
					-- end
					-- return true
				-- end
			-- end
		-- end
	-- end
-- }

--[[
	技能名：血擁
	相关武将：王趙英
	描述：可以丟牌造成傷害或拿牌不打傷害(都自損)看情況選擇以平衡。
	引用：狂骨、制衡、行殤
	状态：1217验证通过
]]--

maggotschagelifeCard = sgs.CreateSkillCard{ -- self:getSubcards():length() and (sgs.Self:inMyAttackRange(to_select))
	name = "maggotschagelifeCard",
	target_fixed = false,
	will_throw = true,
	filter = function(self, targets, to_select) 
		if #targets == 0 then
			local bifalist = to_select:getPile("Maggots")
			if (bifalist:length() == 2) and (self:getSubcards():length() >= 2) and (to_select:getMark("@beam") == 0) and sgs.Self:distanceTo(to_select) <= 1 then
				return (to_select:objectName() ~= sgs.Self:objectName())
				-- return (sgs.Self:inMyAttackRange(to_select))
			end
		end
		return false
	end,
	on_use = function(self, room, source, targets)
	    -- local room = source:getRoom()
		-- local cards = targets[1]:getHandcards()
		local acards = targets[1]:getCards("he")
		local count = self:subcardsLength() + math.floor(acards:length()/2)
		if acards:length() > 0 then
			local allcard = DummyCard:clone()
			for _,card in sgs.qlist(acards) do
					allcard:addSubcard(card)
			end
			room:throwCard(allcard, targets[1], source)
		end
		targets[1]:removePileByName("Maggots")
		-- local ids = targets[1]:handCards()
		-- room:throwCard(self, source)
		if source:isAlive() then
			local theDamage = sgs.DamageStruct()
			theDamage.from = source
			theDamage.to = targets[1]
			theDamage.damage = count
			theDamage.nature = sgs.DamageStruct_Fire
			theDamage.chain = false -- 是否觸發鐵連環(觸發了傷害不會傳導)
			-- theDamage.transfer = false
			room:damage(theDamage)
			-- if theDamage.chain or theDamage.transfer or (not damage.by_user) then return false end
			-- room:damage(sgs.DamageStruct("PoisonMaggotsdamage", source, targets[1], count, sgs.DamageStruct_Thunder))

			room:loseHp(source, self:subcardsLength())
		end
	end
}


maggotschagelife = sgs.CreateViewAsSkill{
	name = "maggotschagelife",
	n = 999,
	view_filter = function(self, selected, to_select)
		return to_select:isKindOf("BasicCard")
	end,
	view_as = function(self, cards)
		if #cards > 0 then
			local zhiheng_card = maggotschagelifeCard:clone()
			for _,card in pairs(cards) do
				zhiheng_card:addSubcard(card)
			end
			zhiheng_card:setSkillName(self:objectName())
			return zhiheng_card
		end
	end,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#maggotschagelifeCard")
	end
}

DummyCard = sgs.CreateSkillCard{
	name = "DummyCard"
}

-- mclthrowcardpart = sgs.CreateTriggerSkill{ -- 如果用巨量傷害秒殺敵人和自己，上面丟卡傷害進行結算後，會跳到狂骨這裡做造成傷害的動作(丟卡、棄蛆蟲)隨後再回去執行失去生命，所以目標會比自己先死，蛆蟲已棄、卡片丟光。此時你才會發動歸巢
	-- name = "#mclthrowcardpart",
	-- frequency = sgs.Skill_Compulsory,
	-- events = {sgs.Damage},
	-- on_trigger = function(self, event, player, data)
		-- local damage = data:toDamage()
		-- local room = player:getRoom()
		-- if (event == sgs.Damage) and player:hasSkill(self:objectName()) and player:isAlive() and player:hasUsed("#maggotschagelifeCard") and (not player:hasFlag("mcltcdpDone")) then
			-- local victim = damage.to
			-- local cards = victim:getCards("he")
			-- local Maggots_list = victim:getPile("Maggots")
			-- if Maggots_list:length() > 0 then
			-- local n = Maggots_list:length()
			-- n = Maggots_list:length()
			    -- for i = 1,n,1 do
					-- if not victim:isAlive() then break end
					-- if Maggots_list:length() == 0 then break end
					-- local card_id = Maggots_list:first()
					-- local card = sgs.Sanguosha:getCard(card_id)
					-- Maggots_list:removeOne(card_id)
					-- room:throwCard(card, victim)
					-- Maggots_list = victim:getPile("Maggots")
			    -- end
			-- end
			-- if cards:length() > 0 then
				-- local allcard = DummyCard:clone()
				-- for _,card in sgs.qlist(cards) do
						-- allcard:addSubcard(card)
				-- end
				-- room:throwCard(allcard, victim, player)
			-- end
		-- end
		-- player:setFlags("mcltcdpDone")
		-- return false
	-- end,
	
	-- can_trigger = function(self, target)
		-- return target
	-- end
-- }

--經典無效牌效果的技能↓
--[[
huanglue = sgs.CreateTriggerSkill{
	name = "huanglue" ,
	-- events = {sgs.CardUsed,sgs.JinkEffect,sgs.NullificationEffect} ,
    events = {sgs.CardUsed,sgs.JinkEffect} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local source = room:findPlayerBySkillName(self:objectName())
		if event == sgs.CardUsed then
			local use = data:toCardUse()
			local ctype = ".."
			if not use.from or not use.card or use.card:getTypeId() == 0 then return false end
			if use.card:isKindOf("Nullification") or source:isNude() then return false end
		    local cardsnum = source:getHandcards():length()
			local cardEnum = source:getEquips():length()
			local n = 0
			
			for _,c in sgs.list(source:getHandcards()) do
                if c:getTypeId() == use.card:getTypeId() then 
				    break
                else
				    n = n + 1
			    end
            end
			if n >= cardsnum and (not use.card:isKindOf("EquipCard") or cardEnum == 0) then
			    return false
			end
			if use.card:isKindOf("BasicCard") then ctype = "BasicCard" end
			if use.card:isKindOf("TrickCard") then ctype = "TrickCard" end
			if use.card:isKindOf("EquipCard") then ctype = "EquipCard" end

			local invoked = room:askForCard(source, ctype, "@huanglue", data, self:objectName())
			if invoked then
				local nullified_list = use.nullified_list
				table.insert(nullified_list, "_ALL_TARGETS")
				use.nullified_list = nullified_list
				data:setValue(use)
				local ids = sgs.IntList()
				if use.card:isVirtualCard() then
					ids = use.card:getSubcards()
				else
					ids:append(use.card:getEffectiveId())
				end
				if ids:length() > 0 then
				
					-- room:throwCard(use.card, room:getCardOwner(use.card:getEffectiveId()), source)
					-- room:obtainCard(source, use.card)
					if source:getPile("learned"):length() < 2 then
					    source:addToPile("learned", use.card)
					else
                    local thepile = source:getPile("learned")
                    local id = -1
                    if (thepile:length() > 1) then
                        room:fillAG(thepile, source)
                        id = room:askForAG(source, thepile, false, self:objectName())
                        room:clearAG(source)
                    else
                        id = thepile:first()
                    end
                    -- local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_REMOVE_FROM_PILE, "", self:objectName(),"")
                    -- room:throwCard(sgs.Sanguosha:getCard(id), reason,nil);
					room:obtainCard(source, sgs.Sanguosha:getCard(id))
					source:addToPile("learned", use.card)
					end
				end
				room:setTag("SkipGameRule",sgs.QVariant(true))
			end
		elseif event == sgs.JinkEffect then
			local card = data:toCard()
			-- local card = nil
			-- if event == sgs.JinkEffect then
				-- card = data:toCard()
			-- end
			-- if event == sgs.NullificationEffect then
				-- card = data:toCardEffect().card
			-- end
			if not card or source:isNude() then return false end
			local sctype = ".."
			local cardsnum = source:getHandcards():length()
			local n = 0
			for _,c in sgs.list(source:getHandcards()) do
                if c:getTypeId() == card:getTypeId() then 
				    break
                else
				    n = n + 1
			    end
            end
			if n >= cardsnum then return false end
			if card:isKindOf("BasicCard") then sctype = "BasicCard" end
			-- if card:isKindOf("TrickCard") then sctype = "TrickCard" end
			local invoked = room:askForCard(source, sctype, "@huanglue", data, self:objectName())
			if invoked then
				local ids = sgs.IntList()
				if card:isVirtualCard() then
					ids = card:getSubcards()
				else
					ids:append(card:getEffectiveId())
				end
				if ids:length() > 0 then
				    if source:getPile("learned"):length() < 2 then
					    source:addToPile("learned", card)
					else
                    local thepile = source:getPile("learned")
                    local id = -1
                    if (thepile:length() > 1) then
                        room:fillAG(thepile, source)
                        id = room:askForAG(source, thepile, false, self:objectName())
                        room:clearAG(source)
                    else
                        id = thepile:first()
                    end
					room:obtainCard(source, sgs.Sanguosha:getCard(id))
					source:addToPile("learned", card)
					end
				end
				return true
			end
		end
		return false
	end,
	can_trigger = function(self, target)
		return target and not target:hasSkill(self:objectName())
	end
}
]]--

--[[ -- 舊神樂改判
goddess = sgs.CreateTriggerSkill{
	name = "goddess",
	frequency = sgs.Skill_Compulsory,
	-- events = {sgs.EventPhaseStart, sgs.StartJudge},
	events = {sgs.StartJudge},
	on_trigger = function(self, event, player, data)

		-- if player:getPhase() == sgs.Player_Start then
		if player:getPhase() == sgs.Player_Judge then
			
			local room = player:getRoom()
			local maji = room:findPlayerBySkillName(self:objectName())
			if maji:getPile("learned"):isEmpty() or maji:getPile("learned"):length() < 3 then return false end
			-- if player ~= maji then room:acquireSkill(player, "#gdnoretrial") end
			-- if (thepile:length() > 1) then
			local log = sgs.LogMessage()
			log.type = "#gd_log"
			log.from = player
			log.arg = "goddess"
			room:sendLog(log)
			
			local Lpile = maji:getPile("learned")
			room:fillAG(Lpile, maji)
			local id = room:askForAG(maji, Lpile, false, self:objectName())
			room:clearAG(maji)
			-- else
				-- cid = thepile:first()
			-- end
			-- room:obtainCard(source, sgs.Sanguosha:getCard(cid))
			room:moveCardTo(sgs.Sanguosha:getCard(id), maji, sgs.Player_DrawPile)
			-- if room:askForSkillInvoke(maji, self:objectName(), data) then
			local count = maji:getPile("learned"):length() + 1
				-- local count = 8
				-- if count > 5 then
					-- count = 5
				-- end
			local cards = room:getNCards(count)
			maji:setFlags("goddessturn") -- 本記號是為了防止3張學習牌，被剪去1發動該技能時，"黨改判技能"判定小於3而不發動
			room:askForGuanxing(maji,cards)
			maji:drawCards(1)
			-- end
		end

		-- if event == sgs.StartJudge then
		
			local room = player:getRoom()
			local maji = room:findPlayerBySkillName(self:objectName())
			-- if maji:hasFlag("goddessturn") then return false end
			if maji:getPile("learned"):isEmpty() or maji:getPile("learned"):length() < 3 then return false end
			-- local log = sgs.LogMessage()
			-- log.type = "#gd_log"
			-- log.from = maji
			-- log.arg = "goddess"
			-- room:sendLog(log)
			
			local Lpile = maji:getPile("learned")
			room:fillAG(Lpile, maji)
			local id = room:askForAG(maji, Lpile, false, self:objectName())
			room:clearAG(maji)
			room:moveCardTo(sgs.Sanguosha:getCard(id), maji, sgs.Player_DrawPile)
			local count = maji:getPile("learned"):length() + 1
			local cards = room:getNCards(count)
			maji:setFlags("goddessturn") -- 本記號是為了防止3張學習牌，被剪去1發動該技能時，"黨改判技能"判定小於3而不發動
			room:askForGuanxing(maji,cards)
			maji:drawCards(1)
		
		-- end
		
	end,
	can_trigger = function(self, target)
		return target and target:canDiscard(target, "j") --這東西用在技能時要去掉
	end
}
]]



--[[ 用use.card等做的回饋，但用"卡片移動完成"來寫更全面一些
luaxxEffect = sgs.CreateTriggerSkill{ -- use.from = player
name = "#luaxxEffect",
events = {sgs.CardUsed, sgs.CardResponded},
frequency = sgs.Skill_Compulsory,
on_trigger = function(self, event, player, data)
	local use = data:toCardUse()
	local room = player:getRoom()
	local s = room:findPlayerBySkillName(self:objectName())
	-- if s:objectName() == player:objectName() and s:getMark("@book") ~= 0 then return false end
	-- if s:getMark("@beam") ~= 0 and s:getMark("@book") ~= 0 then
		-- room:setPlayerMark(s, "@book", 0)
		-- room:setPlayerMark(s, "@beam", 0)
    -- end	
	if s:getMark("@beam") == 0 or (not s) then return false end
	local id = s:getMark("@beam") - 1
	local card_id = sgs.Sanguosha:getCard(id)
	local name = card_id:objectName()
	local suit = card_id:getSuit()
	local point = card_id:getNumber()
	local card
	if event == sgs.CardUsed then
		local use = data:toCardUse()
		card = use.card
	else
		card = data:toCardResponse().m_card
	end
	if card and card:objectName() == name and card:getSuit() == suit and card:getNumber() == point then
		if s:getMark("@burn") ~= 0 then
			local choice = room:askForChoice(s, "LuaQingnang", "sdraw+lhp")
			room:setPlayerMark(s, "@burn", 0) 
				if choice == "lhp" then
					room:setPlayerMark(s, "@beam", 0)
					room:loseHp(player, 1)
					return false 
				end
				if choice == "sdraw" then
					room:setPlayerMark(s, "@beam", 0)
					room:drawCards(s, 2)
					return false 
				end
		elseif s:getMark("@book") ~= 0 then
			room:setPlayerMark(s, "@book", 0)
			room:setPlayerMark(s, "@beam", 0)
		end
			-- room:setPlayerMark(s, "Cid", 0)
			-- room:loseHp(player, 1)
	end
end,
can_trigger = function(self, target)
	-- return target and target:hasFlag("luaxx") 
	return target
end 
}
]]

--[[ ontrigger 使用卡片ID
luaxx = sgs.CreateTriggerSkill{
name = "luaxx" ,
events = {sgs.EventPhaseStart},
on_trigger = function(self, event, player, data)
	if player:getPhase() ~= sgs.Player_Start then return false end
	if player:isKongcheng() then return false end
	if player:askForSkillInvoke(self:objectName(),data) then 
		local room = player:getRoom()
		local target = room:askForPlayerChosen(player, room:getAlivePlayers(), self:objectName())
		local card_id
		if player:getHandcardNum() == 1 then
			card_id = player:handCards():first()
		else
			card_id = room:askForExchange(player, self:objectName(), 1,1, false, "@Push"):getSubcards():first() -- 取用該卡ID的方式
			-- card_id = room:askForExchange(player, self:objectName(), 1,1, true, "@Push") -- 直接取用該卡(非ID)
		end
		local card = sgs.Sanguosha:getCard(card_id) 
		local id = card:getEffectiveId() + 1
		-- local fid = id + 1
		-- local id = card_id:getEffectiveId() -- 直接取用該卡(非ID)時使用
		room:setPlayerMark(player, "Cid", id)
		-- room:setPlayerFlag(target, self:objectName())
		-- target:obtainCard(card_id) -- 直接取用該卡(非ID)時使用
		target:obtainCard(card) 
	end 
end
}
]]

--[[
	技能名：驚喜(奇術)_備份
	相关武将：未創造
	描述：出牌階段，你可以將一張牌交給目標，並暗中選擇一項"良"or"劣"。當目標使用或打出"劣"牌，你選擇令他失去一點生命或你摸兩張牌。當目標棄"良"牌，你可以摸兩張卡並回收該牌。當目標使用或打出"良"牌，你與目標各摸一张牌。
	引用：LuaQixing、LuaQixingStart
	備註：可以給法師用？當成賺魔力的技能等，看情況。本技能技能名跟標記名都尚未更改，要使用則需先更改(否則會露出標記)
]]--

LuaQingnangCard = sgs.CreateSkillCard{
	name = "LuaQingnangCard",
	target_fixed = false,
	will_throw = false,
	filter = function(self, targets, to_select)
		return (to_select:objectName() ~= sgs.Self:objectName())
	end,
	on_use = function(self, room, source, targets)
	    local room = source:getRoom()
		local target = targets[1]
		local id = self:getEffectiveId() + 1
		local choice = room:askForChoice(source, "LuaQingnang", "bomber+goodc")
		if choice == "bomber" then
			room:setPlayerMark(source, "@book", 0)
			room:setPlayerMark(source, "@burn", 1)
		else
			room:setPlayerMark(source, "@burn", 0)
			room:setPlayerMark(source, "@book", 1) 
		end
		room:setPlayerMark(source, "@beam", id)
		
		local pdata = sgs.QVariant()
		pdata:setValue(target)
		room:setTag("LuaYongjue_user",pdata) -- 經測試，playerTAG只會定義一個目標，新目標會蓋過舊目標
		
		room:obtainCard(target, self, false)
		-- local effect = sgs.CardEffectStruct()
		-- effect.card = self
		-- effect.from = source
		-- effect.to = target 
		-- room:cardEffect(effect)
	end,
	-- on_effect = function(self, effect)
		-- local dest = effect.to
		-- local room = dest:getRoom()
		-- local id = effect.card:getEffectiveId() + 1
		-- room:setPlayerMark(effect.from, "@beam", id)
		-- dest:obtainCard(effect.card)
		
	-- end
}

LuaQingnang = sgs.CreateViewAsSkill
{
	name="LuaQingnang",
	n=1,

	view_filter = function(self, selected, to_select)
		return not to_select:isEquipped()
	end,

	view_as = function(self, cards)
		if #cards == 1 then
		
		local view_as_card = LuaQingnangCard:clone()
		view_as_card:addSubcard(cards[1]:getId())
		-- view_as_card:setSkillName(self:objectName())
		return view_as_card
		end
	end,

	enabled_at_play=function(self, player)
		return player:canDiscard(player, "h") and not player:hasUsed("#LuaQingnangCard")
	end,
}

LuaLuoying = sgs.CreateTriggerSkill{ -- @beam
	name = "#LuaLuoying",
	frequency = sgs.Skill_Frequent,
	events = {sgs.CardsMoveOneTime},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local move = data:toMoveOneTime()
		local id = player:getMark("@beam") - 1
		local realcard = sgs.Sanguosha:getCard(id)
		if player:getMark("@beam") == 0 then return false end
		if (move.from == nil) or (move.from:objectName() == player:objectName()) then return false end
		if not move.card_ids:contains(id) then return false end
		local yongjue_user = room:getTag("LuaYongjue_user"):toPlayer()
		room:removeTag("LuaYongjue_user")
		-- if (move.to_place == sgs.Player_DiscardPile)
				-- and (bit32.band(move.reason.m_reason, sgs.CardMoveReason_S_MASK_BASIC_REASON) == sgs.CardMoveReason_S_REASON_DISCARD) then
			-- if player:getMark("@burn") == 0 then
				-- local realcard = sgs.Sanguosha:getCard(id)
				-- data:setValue(move)
				-- room:moveCardTo(realcard, player, sgs.Player_PlaceHand, move.reason, true)
				-- room:drawCards(player, 2)
				-- room:setPlayerMark(player, "@book", 0)
				-- room:setPlayerMark(player, "@beam", 0)
			-- else
				-- room:setPlayerMark(player, "@burn", 0)
				-- room:setPlayerMark(player, "@beam", 0)
			-- end
		-- end
		if player:getMark("@burn") ~= 0 and (bit32.band(move.reason.m_reason, sgs.CardMoveReason_S_MASK_BASIC_REASON) ~= sgs.CardMoveReason_S_REASON_DISCARD) then -- 給出壞卡，而目標一用就出事
			local choice = room:askForChoice(player, "LuaQingnang", "sdraw+lhp")
			room:setPlayerMark(player, "@burn", 0) 
				if choice == "lhp" then
					room:setPlayerMark(player, "@beam", 0)
					room:loseHp(yongjue_user, 1)
					-- room:removeTag("LuaYongjue_user")
					return false 
				end
				if choice == "sdraw" then
					room:setPlayerMark(player, "@beam", 0)
					room:drawCards(player, 2)
					-- room:removeTag("LuaYongjue_user")
					return false 
				end
		elseif player:getMark("@burn") ~= 0 and (bit32.band(move.reason.m_reason, sgs.CardMoveReason_S_MASK_BASIC_REASON) == sgs.CardMoveReason_S_REASON_DISCARD) then  -- 給出壞卡，而目標棄置就沒事
			-- room:removeTag("LuaYongjue_user")
			room:setPlayerMark(player, "@burn", 0) 
			room:setPlayerMark(player, "@beam", 0)
			return false 
			
		elseif player:getMark("@book") ~= 0 and (bit32.band(move.reason.m_reason, sgs.CardMoveReason_S_MASK_BASIC_REASON) ~= sgs.CardMoveReason_S_REASON_DISCARD) then -- 給出好卡，而目標使用
			
			room:drawCards(player, 1)
			room:drawCards(yongjue_user, 1)
			-- room:removeTag("LuaYongjue_user")
			room:setPlayerMark(player, "@book", 0)
			room:setPlayerMark(player, "@beam", 0)
				
		elseif player:getMark("@book") ~= 0 and (bit32.band(move.reason.m_reason, sgs.CardMoveReason_S_MASK_BASIC_REASON) == sgs.CardMoveReason_S_REASON_DISCARD) then -- 給出好卡，而目標卻棄置

			data:setValue(move)
			room:moveCardTo(realcard, player, sgs.Player_PlaceHand, move.reason, true)
			room:drawCards(player, 2)
			-- room:removeTag("LuaYongjue_user")
			room:setPlayerMark(player, "@book", 0)
			room:setPlayerMark(player, "@beam", 0)
		end
		return false
	end,
	priority = 1,
}

--[[
	技能名：魔通
	相关武将：大法師
	描述：鎖定技。你受到的雷電傷害都會轉為魔能標記。出牌階段，你的手牌擁有閃電或雷殺時，你可以發動此技能丟棄所有閃電與雷殺，你獲得丟棄數量之魔能。回合結束階段，若你的"魔力"標記大於一，你可以消耗該標記選擇一項魔法使用，取消不消耗標記。負面法術目標不能是自己，自己也不受影響(致命連鎖除外)。致命連鎖：消耗一枚"魔力"，選擇一到三名目標橫置或重置。寒冰爆：消耗一枚"魔力"，你選擇一名目標，計算目標與其他角色距離為一以內的角色全部翻面。火球術：消耗兩枚"魔力"，你對目標造成兩點火焰傷害。
	引用：LuaQixing、LuaQixingStart
	備註：或許可以給他一個初始魔力值，用完就變成素將。
]]--

magictrickcard = sgs.CreateSkillCard{ -- 出牌阶段，若你的手牌上限大于0，你可以摸一张牌，若如此做，你与此回合内手牌上限-1；结束阶段开始时，若你没有手牌，你可以横置至多X名角色（X为你的体力值）。
	name = "magictrickcard", 
	filter = function(self, targets, to_select)
		if sgs.Self:getPhase() == sgs.Player_Finish or sgs.Self:getPhase() == sgs.Player_Start then
			if sgs.Self:getMark("FatalChain") ~= 0 then
				return #targets < 6
			elseif sgs.Self:getMark("HealingWave") ~= 0 then 
				return to_select:isWounded() and #targets < 3
			elseif sgs.Self:getMark("ChainLightning") ~= 0 then
				return #targets < 1
			else
				return #targets < 1 and not to_select:hasSkill("magictrick")
			end
		else
			return self
		end
		return false
	end, 
	feasible = function(self, targets)
		-- if sgs.Self:getPhase() == sgs.Player_Discard then
		if sgs.Self:getPhase() == sgs.Player_Finish or sgs.Self:getPhase() == sgs.Player_Start then
			if sgs.Self:getMark("FatalChain") ~= 0 then
				return #targets <= 6
			elseif sgs.Self:getMark("HealingWave") ~= 0 then 
				return #targets <= 3
			else
				return #targets <= 1
			end
		else
			return self
		end
		return #targets == 0
	end, 
	on_use = function(self, room, source, targets)
		if source:getPhase() == sgs.Player_Finish or source:getPhase() == sgs.Player_Start then
			local room = source:getRoom()
			if sgs.Self:getMark("FatalChain") ~= 0 then
				local log = sgs.LogMessage()
				log.type = "#FatalChainUsed"
				log.from = source
				room:sendLog(log)
				source:loseMark("@mana", 1)
				for _, p in ipairs(targets) do
					room:setPlayerChained(p)
					-- if not p:isChained() then
						-- p:setChained(true)
						-- room:broadcastProperty(p, "chained")
						-- room:setEmotion(p, "chain")
						-- room:getThread():trigger(sgs.ChainStateChanged, room, p)
					-- else
						-- p:setChained(false)
						-- room:broadcastProperty(p, "chained")
						-- room:setEmotion(p, "chain")
						-- room:getThread():trigger(sgs.ChainStateChanged, room, p)
					-- end
				end
			elseif sgs.Self:getMark("FrostNova") ~= 0 then
				local log = sgs.LogMessage()
				log.type = "#FrostNovaUsed"
				log.from = source
				room:sendLog(log)
				local plist = room:getAlivePlayers() -- 這種單必須用sgs.qlist來做forLoop
				local target = targets[1]
				source:loseMark("@mana", 1)
				for _,p in sgs.qlist(plist) do
					if target:distanceTo(p) <= 1 and not p:hasSkill("magictrick") then
						p:turnOver()
					end
				end
			elseif sgs.Self:getMark("HealingWave") ~= 0 then	
				local log = sgs.LogMessage()
				log.type = "#HealingWaveUsed"
				log.from = source
				room:sendLog(log)
				source:loseMark("@mana", 2)
				local healcount = #targets -- 在lua語法中，前面加#意味著讀取陣列長度
				if healcount == 1 then 
					local target = targets[1]
					if target:isWounded() and target:getLostHp() >= 2 then
						local Healing = sgs.RecoverStruct()
						Healing.recover = 2
						Healing.who = source
						room:recover(target, Healing)
					elseif target:isWounded() then
						source:gainMark("@mana", 1)
						local Healing = sgs.RecoverStruct()
						Healing.recover = 1
						Healing.who = source
						room:recover(target, Healing)
					end
				else
					for _, p in ipairs(targets) do
						if p:isWounded() then
							local Healing = sgs.RecoverStruct()
							Healing.recover = 1
							Healing.who = source
							room:recover(p, Healing)
						end
					end
				end
			
			elseif sgs.Self:getMark("ChainLightning") ~= 0 then
				local log = sgs.LogMessage()
				log.type = "#ChainLightningUsed"
				log.from = source
				room:sendLog(log)
				local ntarget = targets[1]:getNextAlive()
				local list = room:getAlivePlayers()
				local n = 1
				for _,t in sgs.qlist(list) do
					n = n + 1
					table.insert(targets,ntarget)
					ntarget = ntarget:getNextAlive()
					if ntarget == targets[1] then break end
				end
				if n > 3 then n = 3 end
				source:loseMark("@mana", 2)
				for i = 1,n,1 do
					if targets[i]:objectName() ~= source:objectName() then
						room:setPlayerMark(targets[i], "@skill_invalidity", 1)
					end
					source:drawCards(1)
					if targets[i]:isAlive() then
						room:damage(sgs.DamageStruct("ChainLightningDamage", source, targets[i], 1, sgs.DamageStruct_Thunder))
						room:setPlayerMark(targets[i], "@skill_invalidity", 0)
					end
					room:getThread():delay(400)
				end
			else
				local log = sgs.LogMessage()
				log.type = "#FireBallUsed"
				log.from = source
				room:sendLog(log)
				source:loseMark("@mana", 2)
				room:damage(sgs.DamageStruct("FireBallDamage", source, targets[1], 2, sgs.DamageStruct_Fire))
			end
		else
		local hcn = source:getCards("h")
		local num = 0
		local cnum = 0
			if hcn:length() > 0 then
				local tcard = DummyCard:clone()
				local c_str = ""
				for _,card in sgs.qlist(hcn) do
					c_str = card:objectName()
					if card:isKindOf("Lightning") then
						tcard:addSubcard(card)
						num = num + 3
						cnum = cnum + 1
					elseif card:isKindOf("Slash") and c_str == "thunder_slash" then
						tcard:addSubcard(card)
						num = num + 1
						cnum = cnum + 1
					end
				end
				if num == 0 then return false end
				room:throwCard(tcard, source)
			end
			source:gainMark("@mana", num)
			room:drawCards(source, cnum)
		end
	end
}

magictrickVA = sgs.CreateViewAsSkill{
	name = "magictrick", 
	n = 0, 
	view_as = function(self, cards) 
		-- if sgs.Self:getMark("liebianslashmk") == 0 then
			-- return jisheTEcard:clone()
		-- else
			return magictrickcard:clone()
		-- end
	end, 
	enabled_at_play = function(self, player)
		if not player:isKongcheng() then
			local hcn = player:getHandcards()
			local n = 0
			local c_str = ""
			for _,card in sgs.qlist(hcn) do
				c_str = card:objectName()
				if card:isKindOf("Lightning") then
					n = n + 1
				elseif card:isKindOf("Slash") and c_str == "thunder_slash" then
					n = n + 1
				end
			end
			if n > 0 then
				return true
			else
				return false
			end
		else
			return false
		end
	end, 
	enabled_at_response = function(self, player, pattern)
		return pattern == "@@magictrick"
	end
}

magictrick = sgs.CreatePhaseChangeSkill{
	name = "magictrick", 
	view_as_skill = magictrickVA, 
	on_phasechange = function(self, player)
		local room = player:getRoom()
		-- if player:getPhase() == sgs.Player_Discard and player:getHp() > 0 and player:hasSkill(self:objectName()) and player:getMark("@mana") > 0 then
		if (player:getPhase() == sgs.Player_Finish or player:getPhase() == sgs.Player_Start) and player:getHp() > 0 and player:hasSkill(self:objectName()) and player:getMark("@mana") > 0 then
		
		local MagicTrickEffectsStart = {"FrostNova", "HealingWave", "cancel"}
		local MagicTrickEffectsEnd = {"FireBall", "FatalChain",  "ChainLightning", "cancel"}
			local choices = {}
			if player:getPhase() == sgs.Player_Finish then
				for _, effect in ipairs(MagicTrickEffectsEnd) do
					if player:getMark("@mana") >= 2 and (effect == "FireBall" or effect == "ChainLightning") then
						table.insert(choices, effect)
					end
					if (player:getMark("@mana") >= 1 and effect ~= "FireBall" and effect ~= "HealingWave" and effect ~= "ChainLightning") or effect == "cancel" then
						table.insert(choices, effect)
					end
				end
			else
				for _, effect in ipairs(MagicTrickEffectsStart) do
					if player:getMark("@mana") >= 2 and effect == "HealingWave" then
						table.insert(choices, effect)
					end
					if (player:getMark("@mana") >= 1 and effect == "FrostNova") or effect == "cancel" then
						table.insert(choices, effect)
					end
				end
			end
			-- for _, effect in ipairs(MagicTrickEffects) do
				-- if player:getMark("@mana") >= 3 and effect == "HealingWave" then
					-- table.insert(choices, effect)
				-- end
				-- if player:getMark("@mana") >= 2 and (effect == "FireBall" or effect == "ChainLightning") then
					-- table.insert(choices, effect)
				-- end
				-- if (player:getMark("@mana") >= 1 and effect ~= "FireBall" and effect ~= "HealingWave" and effect ~= "ChainLightning") or effect == "cancel" then
					-- table.insert(choices, effect)
				-- end
			-- end
			local room = player:getRoom()
			local choice = room:askForChoice(player, self:objectName(), table.concat(choices, "+"))
			room:setPlayerMark(player, "FrostNova", 0)
			room:setPlayerMark(player, "FatalChain", 0)
			room:setPlayerMark(player, "HealingWave", 0)
			room:setPlayerMark(player, "ChainLightning", 0)
			if choice == "cancel" then return false end
			if choice ~= "FireBall" then room:setPlayerMark(player, choice, 1) end
			room:askForUseCard(player, "@@magictrick", "@do_magic_" .. choice)
		end
	end
}
Sizhanfort = sgs.CreateTriggerSkill{
	name = "#Sizhanfort" ,
	frequency = sgs.Skill_Compulsory ,
	events = {sgs.GameStart, sgs.DamageInflicted, sgs.SlashProceed} ,
	on_trigger = function(self, event, player, data)
		-- if event == sgs.ConfirmDamage then
			-- local room = player:getRoom()
			-- local mstar = room:findPlayerBySkillName(self:objectName())
			-- if mstar:getMark("@thunder") > 0 then
				-- local damage = data:toDamage()
				-- if damage.nature ~= sgs.DamageStruct_Thunder then
				-- damage.nature = sgs.DamageStruct_Thunder
				-- data:setValue(damage)
				-- end
			-- end
		-- end
		if event == sgs.DamageInflicted then
			local damage = data:toDamage()
			if damage.nature == sgs.DamageStruct_Thunder or damage.reason == "FireBallDamage" then
				local room = player:getRoom()
				local mstar = room:findPlayerBySkillName(self:objectName())
				if damage.reason == "FireBallDamage" and player == mstar then 
					local log = sgs.LogMessage()
					log.type = "#sizhanfort_nodamage2"
					log.from = mstar
					log.arg = "FireBall"
					room:sendLog(log)
					return true 
				end
				if damage.nature == sgs.DamageStruct_Thunder then
					if (not mstar) or (damage.from == mstar and player ~= mstar) then return false end
					if player == mstar or room:askForSkillInvoke(mstar, "magictrick", data) then
						local log = sgs.LogMessage()
						log.type = "#sizhanfort_nodamage"
						log.from = mstar
						log.arg = "magictrick"
						log.arg2 = damage.damage
						room:sendLog(log)
						mstar:gainMark("@mana", damage.damage)
						return true
					end
					return false
				end
			end
		end
		if  event == sgs.SlashProceed then
			local room = player:getRoom()
			local kaki = room:findPlayerBySkillName(self:objectName())
			if not kaki then return false end
			local effect = data:toSlashEffect()
			local slashcard = effect.slash
			local s_str = slashcard:objectName()
			-- if (effect.to:objectName() == kaki:objectName()) and s_str == "thunder_slash" then
			if s_str == "thunder_slash" then
				room:slashResult(effect, nil)
				return true
			else
				return false
			end
		end
		if event == sgs.GameStart then
			local room = player:getRoom()
			local kaki = room:findPlayerBySkillName("magictrick")
			room:setPlayerMark(kaki, "@mana", 3)
		end
		return false
	end,
	can_trigger = function(self, target)
		return target
	end
}
listIndexOf = function(theqlist, theitem)
	local index = 0
	for _, item in sgs.qlist(theqlist) do
		if item == theitem then return index end
		index = index + 1
	end
end
S2izhanfort = sgs.CreateTriggerSkill{
	name = "#S2izhanfort",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.BeforeCardsMove},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local move = data:toMoveOneTime()
		if (move.from == nil) or (move.from:objectName() == player:objectName()) then return false end
		if (move.to_place == sgs.Player_DiscardPile)
				and ((bit32.band(move.reason.m_reason, sgs.CardMoveReason_S_MASK_BASIC_REASON) == sgs.CardMoveReason_S_REASON_DISCARD)
				or (move.reason.m_reason == sgs.CardMoveReason_S_REASON_JUDGEDONE)) then
			local card_ids = sgs.IntList()
			local i = 0
			for _, card_id in sgs.qlist(move.card_ids) do
				local c_str = sgs.Sanguosha:getCard(card_id):objectName()
				-- if (sgs.Sanguosha:getCard(card_id):getSuit() == sgs.Card_Club)
				if (sgs.Sanguosha:getCard(card_id):isKindOf("Lightning") or c_str == "thunder_slash")
						and (((move.reason.m_reason == sgs.CardMoveReason_S_REASON_JUDGEDONE)
						and (move.from_places:at(i) == sgs.Player_PlaceJudge)
						and (move.to_place == sgs.Player_DiscardPile))
						or ((move.reason.m_reason ~= sgs.CardMoveReason_S_REASON_JUDGEDONE)
						and (room:getCardOwner(card_id):objectName() == move.from:objectName())
						and ((move.from_places:at(i) == sgs.Player_PlaceHand) or (move.from_places:at(i) == sgs.Player_PlaceEquip)))) then
					card_ids:append(card_id)
				end
				i = i + 1
			end
			if card_ids:isEmpty() then
				return false
			else
				for _, id in sgs.qlist(card_ids) do
					if move.card_ids:contains(id) then
						move.from_places:removeAt(listIndexOf(move.card_ids, id))
						move.card_ids:removeOne(id)
						data:setValue(move)
					end
					room:moveCardTo(sgs.Sanguosha:getCard(id), player, sgs.Player_PlaceHand, move.reason, true)
					if not player:isAlive() then break end
				end
			end
		end
		return false
	end
}



-- 通穴(沒用到_備份)
-- playerFinder = function(skill)
	-- local player = room:findPlayerBySkillName(skill)
-- end

hasEquipArea = function(player, name) 
	-- if (name == "treasure" and (Set(sgs.Sanguosha:getBanPackages()))["limitation_broken"])
	-- or player:getMark(name.."AreaRemoved") > 0 then -- 是判斷限界突破包是否被BAN掉，當被BAN掉，詢問寶物欄時會自動回應無，奇怪的是，如果開啟他，extra補充包就要在，否則判斷寶物有沒有欄位的判斷式就會卡，把它關掉沒啥問題。頂多關掉倚天裝備包，你依然計算寶物區
	if player:getMark(name.."AreaRemoved") > 0 then
		return false
	end
	return true
end

removeEquipArea = function(player, name)
	if hasEquipArea(player, name) then
		local room = player:getRoom()
		room:setPlayerMark(player, name.."AreaRemoved", 1)
		local classname
		if name == "defensive_horse" then classname = "DefensiveHorse"
		elseif name == "offensive_horse" then classname = "OffensiveHorse"
		else classname = name:gsub("^%l", string.upper) end
		room:setPlayerCardLimitation(player, "use", classname.."$0", false)
		local equips = {"weapon", "armor", "defensive_horse", "offensive_horse", "treasure"}
		for i = 1, 5, 1 do
			if name == equips[i] and player:getEquip(i-1) then
				room:throwCard(player:getEquip(i-1), nil)
				-- room:obtainCard(player, player:getEquip(i-1))
				break
			end
		end
		local log = sgs.LogMessage()
		log.type = "#remove_equip_area"
		log.from = player
		log.arg = name
		room:sendLog(log)
	end
end

removeWholeEquipArea = function(player)
	local equips = {"weapon", "armor", "defensive_horse", "offensive_horse", "treasure"}
	for _,equip in ipairs(equips) do
		removeEquipArea(player, equip)
	end
end

blankEquipArea = function(player)
	if hasEquipArea(player, "weapon") or hasEquipArea(player, "armor") or hasEquipArea(player, "defensive_horse")
	or hasEquipArea(player, "offensive_horse") or hasEquipArea(player, "treasure") then
		return false
	end
	return true
end

equippro_dh = sgs.CreateProhibitSkill
{
	name = "#equippro_dh",
	is_prohibited = function(self, from, to, card)
		if to and card:isKindOf("EquipCard") and (not hasEquipArea(to, card:getSubtype())) 
		or (to:getMark("losing_defensive_horse") > 0 and (card:isKindOf("DelayedTrick") or card:isKindOf("Snatch") or card:isKindOf("Slash"))) then
			return true
		end
	end
}
-- 以上全定義以下技能實體
breakingSealcard = sgs.CreateSkillCard{
	name = "breakingSealcard",
	target_fixed = false,
	will_throw = false,
	filter = function(self, targets, to_select, player)
		return to_select:objectName() == player:objectName()
	end,
	on_effect = function(self, effect)
		local room = effect.from:getRoom()
		local choices = {}
		if hasEquipArea(effect.from, "weapon") then table.insert(choices, "weapon") end
		if hasEquipArea(effect.from, "armor") then table.insert(choices, "armor") end
		if hasEquipArea(effect.from, "defensive_horse") then table.insert(choices, "defensive_horse") end
		if hasEquipArea(effect.from, "offensive_horse") then table.insert(choices, "offensive_horse") end
		if hasEquipArea(effect.from, "treasure") then table.insert(choices, "treasure") end
		
		local choice = room:askForChoice(effect.from, "breakingSeal", table.concat(choices, "+"), sgs.QVariant())
		removeEquipArea(effect.from, choice)
		if effect.from:hasFlag("breakingseal") then
			room:loseHp(effect.from, 2)
		else
			room:loseHp(effect.from, 1)
			effect.from:setFlags("breakingseal")
		end
		room:setPlayerMark(effect.from, "losing_" .. choice, 1)
		if (choice == "armor" or choice == "defensive_horse") and effect.from:isWounded() then 
				local count = math.min(2 ,effect.from:getLostHp())
				local Healing = sgs.RecoverStruct()
				Healing.recover = count
				Healing.who = effect.from
				room:recover(effect.from, Healing)
		end
		if (choice == "defensive_horse") then room:drawCards(effect.from, 1) end
		if (choice == "treasure") then
			local n = effect.from:getLostHp()
			room:drawCards(effect.from, n*2)
		end
	end
}

breakingSealVA = sgs.CreateZeroCardViewAsSkill{
	name = "breakingSeal",
	view_as = function()
	    local acard = breakingSealcard:clone()
		acard:setSkillName("breakingSeal")
		return acard
	end,
	enabled_at_play = function(self, player)
		return not blankEquipArea(player)
	end,
	enabled_at_response = function(self, player, pattern)
		return false
	end
}

breakingSeal = sgs.CreateTriggerSkill -- 死亡或更換回合時，將本技能的效果無效
{
	name = "breakingSeal",
	events = {sgs.EventPhaseStart,sgs.Death},
	-- events = {sgs.EventPhaseStart,sgs.Death,sgs.EventLoseSkill},
	view_as_skill = breakingSealVA,
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
		-- local mstar = room:findPlayerBySkillName(self:objectName())
		if (event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Start)
		or (event == sgs.Death and data:toDeath().who:hasSkill(self:objectName())) then
			for _,p in sgs.qlist(room:getOtherPlayers(player)) do
				if p:getMark("Armor_Nullified") > 0 then
					room:removePlayerMark(p,"Armor_Nullified")
					room:setPlayerMark(p, "@skill_invalidity", 0)
					-- local LuaChanyuan_skills = p:getTag("LuaChanyuanSkills"):toString():split("+") -- 當禪院被使用時，這個要開(有用)
					-- for _, skill_name in ipairs(LuaChanyuan_skills) do
						-- room:removePlayerMark(p, "Qingcheng"..skill_name)
					-- end
					-- p:setTag("LuaChanyuanSkills", sgs.QVariant())
				end
			end
			if player:getMark("losing_weapon") > 0 then
				room:removePlayerMark(player,"losing_weapon")
			end
			if player:getMark("losing_armor") > 0 then
				room:removePlayerMark(player,"losing_armor")
			end
			if player:getMark("losing_defensive_horse") > 0 then
				room:removePlayerMark(player,"losing_defensive_horse")
			end
			if player:getMark("losing_offensive_horse") > 0 then
				room:removePlayerMark(player,"losing_offensive_horse")
			end
			if player:getMark("losing_treasure") > 0 then
				room:removePlayerMark(player,"losing_treasure")
			end
			if player:hasFlag("breakingseal") then
				room:setPlayerFlag(player,"-breakingseal")
			end
			if blankEquipArea(player) then
				local maxhp = player:getMaxHp()
				local hp = math.min(4, maxhp)
				room:setPlayerProperty(player, "hp", sgs.QVariant(hp))
				room:detachSkillFromPlayer(player, "breakingSeal")
			end
		end
		return false
	end,
}

bsClear = sgs.CreateTriggerSkill{
	name = "#bsClear" ,
	events = {sgs.EventLoseSkill} ,
	on_trigger = function(self, event, player, data)

		if data:toString() == "breakingSeal" then
			local room = player:getRoom()
			for _,p in sgs.qlist(room:getOtherPlayers(player)) do
				-- p:loseAllMarks("Armor_Nullified")
				-- p:loseAllMarks("@skill_invalidity")
				if not p:hasFlag("SAEflag") then
					room:setPlayerMark(p, "@skill_invalidity", 0)
					room:setPlayerMark(p, "Armor_Nullified", 0)
				end
			end
			if player:getMark("losing_weapon") > 0 then
				room:removePlayerMark(player,"losing_weapon")
			end
			if player:getMark("losing_armor") > 0 then
				room:removePlayerMark(player,"losing_armor")
			end
			if player:getMark("losing_defensive_horse") > 0 then
				room:removePlayerMark(player,"losing_defensive_horse")
			end
			if player:getMark("losing_offensive_horse") > 0 then
				room:removePlayerMark(player,"losing_offensive_horse")
			end
			if player:getMark("losing_treasure") > 0 then
				room:removePlayerMark(player,"losing_treasure")
			end
		end
	end ,
	can_trigger = function(self, target)
		return target
	end ,
}
-- 五門，開

bs_treasure = sgs.CreateTriggerSkill{
	name = "#bs_treasure" ,
	frequency = sgs.Skill_Compulsory ,
	events = {sgs.EventPhaseChanging} ,
	on_trigger = function(self, event, player, data)
		local change = data:toPhaseChange()
		if change.to == sgs.Player_Discard and player:getMark("losing_treasure") > 0 then player:skip(change.to) end
		return false
	end
}

-- 一、二門，開
bs_wab = sgs.CreateTriggerSkill{
	name = "#bs_wab",
	frequency = sgs.Skill_Frequent,
	-- events = {sgs.ConfirmDamage ,sgs.PreHpRecover ,sgs.DamageInflicted ,sgs.TargetConfirming ,sgs.SlashMissed},
	events = {sgs.ConfirmDamage ,sgs.PreHpRecover ,sgs.DamageInflicted ,sgs.TargetConfirming},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local fighter = room:findPlayerBySkillName(self:objectName())
		if not fighter then return false end
		-- if event == sgs.SlashMissed then
			-- local effect = data:toSlashEffect()
			-- if effect.to:getMark("Armor_Nullified") > 0 then
				-- room:setPlayerMark(effect.to, "Armor_Nullified", 0)
				-- room:setPlayerMark(effect.to, "@pulse", 0)
			-- end
		-- end
		if event == sgs.ConfirmDamage then
			-- local room = player:getRoom()
			local damage = data:toDamage()
			local reason = damage.card
			if reason and damage.from:getMark("losing_weapon") > 0 then
				if reason:isKindOf("Slash") or reason:isKindOf("Duel") then
					local log = sgs.LogMessage()
					log.type = "#bs_wab1"
					log.from = fighter
					room:sendLog(log)
					-- local LuaChanyuan_skills = damage.to:getTag("LuaChanyuanSkills"):toString():split("+")
					damage.damage = damage.damage + 1
					data:setValue(damage)
					-- for _, skill_name in ipairs(LuaChanyuan_skills) do
						-- room:removePlayerMark(damage.to, "Qingcheng"..skill_name)
					-- end
					-- damage.to:setTag("LuaChanyuanSkills", sgs.QVariant())
				end
			end
		end
		if event == sgs.TargetConfirming then
			local use = data:toCardUse()
			local card = use.card
			local from = use.from
			local tos = use.to

			if from:getMark("losing_weapon") > 0 and (card:isKindOf("Slash") or card:isKindOf("Duel")) then

				for _, to in sgs.qlist(tos) do

				-- local LuaChanyuan_skills = to:getTag("LuaChanyuanSkills"):toString():split("+") -- 纏怨的方式，有效，看情況替換
				-- local skills = to:getVisibleSkillList()
				-- for _, skill in sgs.qlist(skills) do
					-- if not skill:inherits("SPConvertSkill") and not skill:isAttachedLordSkill() and not (Set(LuaChanyuan_skills))[skill:objectName()] then
						-- room:addPlayerMark(to, "Qingcheng"..skill:objectName())
						-- table.insert(LuaChanyuan_skills, skill:objectName())
					-- end
				-- end
				-- to:setTag("LuaChanyuanSkills", sgs.QVariant(table.concat(LuaChanyuan_skills, "+")))
					room:setPlayerMark(to, "@skill_invalidity", 1)
					room:setPlayerMark(to, "Armor_Nullified", 1)
				end
			end
		end
		if (event == sgs.PreHpRecover) and fighter:getMark("losing_armor") > 0 then
			local rec = data:toRecover()
			if (rec.who ~= fighter) and room:askForSkillInvoke(fighter, "nomorerec", data) then
				local log = sgs.LogMessage()
				log.type = "#bs_wabr"
				log.from = fighter
				room:sendLog(log)
				rec.recover = rec.recover - 1
				if rec.recover < 0 then rec.recover = 0 end
				data:setValue(rec)
			end
		end
		if (event == sgs.DamageInflicted) and fighter:getMark("losing_armor") > 0 then
			local damage = data:toDamage()
			if (damage.damage >= 1) and damage.to == fighter then
				local log = sgs.LogMessage()
				log.type = "#bs_wabi"
				log.from = damage.to
				room:sendLog(log)
				damage.damage = 0
				data:setValue(damage)
			end
		end
		
		return false
		
	end,
	can_trigger = function(self, target)
		-- if target then
			-- if target:getMark("losing_weapon") > 0 then
				-- return target:isAlive()
			-- end
		-- end
		-- return false
		return target
	end
}

-- 三門，開，三門被加入公共技能(公廁)了_attackrange_距離型技能_攻擊距離、攻擊目標數量


bs_ohb = sgs.CreateTargetModSkill{--or (from:isMale() and from:hasSkill("changesexual")))
	name = "#bs_ohb",
	pattern = "Slash",
	extra_target_func = function(self, player, card)
		if player and (player:getMark("losing_offensive_horse") > 0) then
			return 2
		end
		-- if player and player:hasSkill("harvest") then
		if player and player:getGeneralName() == "bloodymarry" then
			return player:getMark("Hponeguys")
		end
	end,
	distance_limit_func = function(self, player, card)
		if player and (player:getMark("losing_offensive_horse") > 0 or (player:isFemale() and player:hasSkill("changesexual")) or (player:hasSkill("LuaZhenlie") and (card:getSkillName() == "LuaZhenlie")) or card:getSkillName() == "reedship" 
		or player:hasFlag("tomowodaji")) then
			return 998
		end
		if player and player:hasSkill("japenknifejile") and not player:getWeapon() then
			return 2
		end
		if player and player:getMark("@SuperLimitBreak") > 0 and player:getGeneralName() == "miyoshikarin" and not player:getWeapon() then
			return 1
		end
		if player and player:hasSkill("yuri_wuji") and player:getMark("@SuperLimitBreak") > 0 and card:isKindOf("FireSlash") then --百合武繼 超界突破
			return 1000
		end
		if player and player:hasSkill("hb_yitain") and not player:getWeapon() then --倚天
			return player:getHp()-1
		end
		return 0
		-- if player and player:hasSkill("semeruki") and not player:getWeapon() then
			-- return 1
		-- end
	end
}
Table2IntList = function(theTable)
	local result = sgs.IntList()
	for i = 1, #theTable, 1 do
		result:append(theTable[i])
	end
	return result
end

bs_ohjon = sgs.CreateTriggerSkill{
	name = "#bs_ohjon" ,
	events = {sgs.TargetConfirmed} ,
	on_trigger = function(self, event, player, data)
		local use = data:toCardUse()
		if player:objectName() ~= use.from:objectName() or use.from:getMark("losing_offensive_horse") == 0 or player:getPhase() ~= sgs.Player_Play or not use.card:isKindOf("Slash") then return false end
		local jink_table = sgs.QList2Table(player:getTag("Jink_" .. use.card:toString()):toIntList())
		local index = 1
		for _, p in sgs.qlist(use.to) do
			local _data = sgs.QVariant()
			_data:setValue(p)
			jink_table[index] = 0
			index = index + 1
		end
		local jink_data = sgs.QVariant()
		jink_data:setValue(Table2IntList(jink_table))
		player:setTag("Jink_" .. use.card:toString(), jink_data)
	end
}

-- 無理BUFF的烈弓↓，小場景用

godbow = sgs.CreateTriggerSkill{
	name = "godbow", 
	events = {sgs.TargetSpecified, sgs.DamageCaused}, 
	on_trigger = function(self, event, player, data)
		local use = data:toCardUse()
		local room = player:getRoom()
		if event == sgs.TargetSpecified and player:objectName() == use.from:objectName() and use.from:hasSkill(self:objectName()) and use.card:isKindOf("Slash") and player:getPhase() == sgs.Player_Play then
			local index = 1
			local jink_table = sgs.QList2Table(player:getTag("Jink_" .. use.card:toString()):toIntList())
			for _, p in sgs.qlist(use.to) do
				if not player:isAlive() then break end
				-- local invoke = 3
				-- if p:getAttackRange() <= player:getAttackRange() then
					-- invoke = invoke+1
				-- end
				-- if p:getHandcardNum() >= player:getHandcardNum() then
					-- invoke = invoke+1
				-- end
				-- if p:getHp() >= player:getHp() then
					-- invoke = invoke+1
				-- end
				local _data = sgs.QVariant()
				_data:setValue(p)
				if room:askForSkillInvoke(player, self:objectName(), _data) then
					jink_table[index] = 0
					-- if invoke >= 2 then
					room:setCardFlag(use.card, "godbow_play"..p:objectName())	
					-- end
				end
				index = index+1
			end
			local jink_data = sgs.QVariant()
			jink_data:setValue(Table2IntList(jink_table))
			player:setTag("Jink_" .. use.card:toString(), jink_data)
		elseif event == sgs.DamageCaused then
			local damage = data:toDamage()
			if damage.card and damage.card:hasFlag("godbow_play"..damage.to:objectName()) then
				local buff = damage.from:getAttackRange() + damage.from:getLostHp()
				local log = sgs.LogMessage()
				log.type = "$godbow_log"
				log.from = player
				log.card_str = damage.card:toString()
				log.arg = self:objectName()
				log.arg2 = buff
				room:sendLog(log)
				damage.damage = damage.damage+buff
				data:setValue(damage)
			end
		end
		return false
	end
}

-- 換性別

changesexualCard = sgs.CreateSkillCard{
	name = "changesexual",
	-- target_fixed = false,
	-- will_throw = true,
	filter = function(self, targets, to_select)
			return to_select:objectName() == sgs.Self:objectName()
		end,
		
	on_use = function(self, room, source, targets)
		if source:isMale() then
			local log = sgs.LogMessage()
			log.type = "#changesexual_togirl"
			log.from = source
			room:sendLog(log)
			source:gainMark("@female", 1)
			source:setGender(sgs.General_Female)
		else
			local log = sgs.LogMessage()
			log.type = "#changesexual_toboy"
			log.from = source
			room:sendLog(log)
			source:loseAllMarks("@female")
			source:setGender(sgs.General_Male)
		end
	end
}

changesexual = sgs.CreateZeroCardViewAsSkill{
	name = "changesexual",
	response_pattern = "@@changesexual",
	response_or_use = true,
	-- view_as = function(self) --開啟備標註的程式碼，可以讓此技能當閃殺用，不耗排
	view_as = function()
		-- local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
		-- if (pattern == "jink") then
			-- local cards = sgs.Sanguosha:cloneCard(pattern, sgs.Card_NoSuit, 0)
			-- cards:setSkillName(self:objectName())
			-- return cards
		-- elseif pattern == "slash" then
			-- local cards = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
			-- cards:setSkillName(self:objectName())
			-- return cards
		-- else
			return changesexualCard:clone()
		-- end
	end,
	enabled_at_play = function(self,player)
		return true
	end
	-- enabled_at_response = function(self, player, pattern)
		-- local usere = sgs.Sanguosha:getCurrentCardUseReason()
		-- return ((pattern == "slash" and player:isMale()) or (pattern == "jink" and player:isFemale())) and (usere == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE or usere == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE) and player:getPhase() == sgs.Player_NotActive
	-- end
}
changesexualforai = sgs.CreateTriggerSkill{
	name = "#changesexualforai",
	frequency = sgs.Skill_Compulsory, 
	events = {sgs.CardUsed, sgs.CardResponded},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		
		if event == sgs.CardUsed then--電腦專用
			local use = data:toCardUse()
			if use.card and player:hasFlag("AI_dont_changesexual") and (use.card:isKindOf("Snatch") or use.card:isKindOf("Slash")) and player:getState() == "robot" then
				player:setFlags("-AI_dont_changesexual")
			end
		end
		
		if room:getCurrent():objectName() == player:objectName() then return false end
		local card = nil
		if event == sgs.CardUsed then
			local use = data:toCardUse()
			card = use.card
		else
			card = data:toCardResponse().m_card
		end
		if card and (card:isKindOf("BasicCard") or card:isKindOf("TrickCard")) then
			player:drawCards(1)
			room:askForUseCard(player, "@@changesexual", "@changesexual")
		end
		
	end
}

-- yuri_gushou = sgs.CreateTriggerSkill{
	-- name = "#yuri_gushou" ,
	-- frequency = sgs.Skill_Compulsory, 
	-- events = {sgs.CardUsed, sgs.CardResponded} ,
	-- on_trigger = function(self, event, player, data)
		-- local room = player:getRoom()
		-- if room:getCurrent():objectName() == player:objectName() then return false end
		-- local card = nil
		-- if event == sgs.CardUsed then
			-- local use = data:toCardUse()
			-- card = use.card
		-- else
			-- card = data:toCardResponse().m_card
		-- end
		-- if card and card:isKindOf("BasicCard") or card:isKindOf("TrickCard") then
			-- player:drawCards(1)
			-- room:askForUseCard(player, "@@changesexual", "@changesexual")
		-- end
		-- return false
	-- end
-- }

--[[
	技能名：雙武
	相关武将：亂碼
	描述：當妳是女生時，你可以用武器牌當閃，當你是男生時，你可以用武器牌當殺。
	引用：sexualadvantage
	状态：1217验证通过
]]--
sexualadvantage = sgs.CreateViewAsSkill{
	name = "sexualadvantage" ,
	n = 1 ,
	expand_pile = "wooden_ox",
	view_filter = function(self, selected, to_select)
		if #selected > 0 then return false end
		if sgs.Self:isMale() then
			return to_select:isKindOf("EquipCard")
		else
			return to_select:isRed() and not to_select:isKindOf("Jink")
		end
	end ,
	view_as = function(self, cards)
		if #cards ~= 1 then return nil end
		local originalCard = cards[1]
		if sgs.Self:isFemale() then
			local jink = sgs.Sanguosha:cloneCard("jink", originalCard:getSuit(), originalCard:getNumber())
			jink:addSubcard(originalCard)
			jink:setSkillName(self:objectName())
			return jink
		else
			local slash = sgs.Sanguosha:cloneCard("slash", originalCard:getSuit(), originalCard:getNumber())
			slash:addSubcard(originalCard)
			slash:setSkillName(self:objectName())
			return slash
		end
	end ,
	enabled_at_play = function(self, target)
		if target:isMale() then
			return sgs.Slash_IsAvailable(target)
		else
			return false
		end
		
	end,
	enabled_at_response = function(self, target, pattern)
		if target:isMale() then
			return (pattern == "slash")
		else
			return (pattern == "jink")
		end
	end
}

SAeffect = sgs.CreateTriggerSkill{
	name = "#SAeffect",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart,sgs.Death,sgs.TargetConfirming},
	can_trigger = function(self, target)
    	return true
	end,
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if event == sgs.Death and data:toDeath().who:hasSkill(self:objectName()) then
			-- if not player:hasSkill(self:objectName()) then return end
			for _,p in sgs.qlist(room:getOtherPlayers(player)) do
				p:setFlags("-SAEflag")
				if p:getMark("@all_skill_invalidity") > 0 then
					room:setPlayerMark(p, "@all_skill_invalidity", 0)
					local SAinvalid_skills = p:getTag("SAinvalidSkills"):toString():split("+") -- 當禪院被使用時，這個要開(有用)
					for _, skill_name in ipairs(SAinvalid_skills) do
						room:removePlayerMark(p, "Qingcheng"..skill_name)
					end
					p:setTag("SAinvalidSkills", sgs.QVariant())
				end
				if p:getMark("Armor_Nullified") > 0 then
					room:setPlayerMark(p, "Armor_Nullified", 0)
				end
			end
		end
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Start then
			-- if not player:hasSkill(self:objectName()) then return end
			-- for _,p in sgs.qlist(room:getOtherPlayers(player)) do
				-- p:setFlags("-SAEflag")
				-- if p:getMark("@all_skill_invalidity") > 0 then
					-- room:setPlayerMark(p, "@all_skill_invalidity", 0)
					-- local SAinvalid_skills = p:getTag("SAinvalidSkills"):toString():split("+")
					-- for _, skill_name in ipairs(SAinvalid_skills) do
						-- room:removePlayerMark(p, "Qingcheng"..skill_name)
					-- end
					-- p:setTag("SAinvalidSkills", sgs.QVariant())
				-- end
				-- if p:getMark("Armor_Nullified") > 0 then
					-- room:setPlayerMark(p, "Armor_Nullified", 0)
				-- end
			-- end
			if player:getMark("@all_skill_invalidity") > 0 then
				room:setPlayerMark(player, "@all_skill_invalidity", 0)
				local SAinvalid_skills = player:getTag("SAinvalidSkills"):toString():split("+")
				for _, skill_name in ipairs(SAinvalid_skills) do
					room:removePlayerMark(player, "Qingcheng"..skill_name)
				end
				player:setTag("SAinvalidSkills", sgs.QVariant())
			end
			if player:getMark("Armor_Nullified") > 0 then
				room:setPlayerMark(player, "Armor_Nullified", 0)
			end
		elseif event == sgs.TargetConfirming then
			-- local room = player:getRoom()
			local use = data:toCardUse()
			-- local card = use.card
			-- local from = use.from
			local tos = use.to

			if use.card:getSkillName() == "sexualadvantage" and use.card:isKindOf("Slash") then
				for _, to in sgs.qlist(tos) do
					to:setFlags("SAEflag")
					room:setPlayerMark(to, "@all_skill_invalidity", 1)
				local SAinvalid_skills = to:getTag("SAinvalidSkills"):toString():split("+") -- 纏怨的方式，有效，看情況替換
				local skills = to:getVisibleSkillList()
				for _, skill in sgs.qlist(skills) do
					-- if not skill:inherits("SPConvertSkill") and not skill:isAttachedLordSkill() and not (Set(SAinvalid_skills))[skill:objectName()] then
						room:addPlayerMark(to, "Qingcheng"..skill:objectName())
						table.insert(SAinvalid_skills, skill:objectName())
					-- end
				end
				to:setTag("SAinvalidSkills", sgs.QVariant(table.concat(SAinvalid_skills, "+")))
					room:setPlayerMark(to, "Armor_Nullified", 1)
				end
			end
		end
		return false
	end,
}
SAEClear = sgs.CreateTriggerSkill{ -- can_trigger標示 target的技能不能當公廁
	name = "#SAEClear" ,
	events = {sgs.EventLoseSkill} ,
	on_trigger = function(self, event, player, data)
		if data:toString() == "sexualadvantage" then
			local room = player:getRoom()
			for _,p in sgs.qlist(room:getOtherPlayers(player)) do
				if p:hasFlag("SAEflag") then
					p:setFlags("-SAEflag")
					room:setPlayerMark(p, "@all_skill_invalidity", 0)
					local SAinvalid_skills = p:getTag("SAinvalidSkills"):toString():split("+") -- 當禪院被使用時，這個要開(有用)
					for _, skill_name in ipairs(SAinvalid_skills) do
						room:removePlayerMark(p, "Qingcheng"..skill_name)
					end
					p:setTag("SAinvalidSkills", sgs.QVariant())
					room:setPlayerMark(p, "Armor_Nullified", 0)
				end
			end
		end
	end,
	can_trigger = function(self, target)
		return target
	end ,
}	

sa_snatch = sgs.CreateTargetModSkill{--or (from:isMale() and from:hasSkill("changesexual")))
	name = "#sa_snatch",
	pattern = "Snatch",
	-- extra_target_func = function(self, player, card)
		-- if player and player:isFemale() and player:hasSkill("changesexual") then
			-- return 1
		-- end
	-- end,
	distance_limit_func = function(self, player, card)
		if player and player:isFemale() and player:hasSkill("changesexual") then
			return 998
		end
	end
}

--強勢：你的殺被閃抵銷時，你可以獲取其一張裝備牌。鎖定技。當你沒有裝備武器牌，你的殺攻擊距離加一。

semeruki = sgs.CreateTriggerSkill{
	name = "semeruki",
	events = {sgs.CardOffset},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local effect = data:toCardEffect()
		if effect.to:isAlive() and effect.card:isKindOf("Slash") and effect.to:getCards("e"):length() > 0 and player:canDiscard(effect.to, "e") then
			if player:askForSkillInvoke(self:objectName(), data) then
				local to_throw = room:askForCardChosen(player, effect.to, "e", self:objectName(), false, sgs.Card_MethodDiscard)
				room:obtainCard(player, sgs.Sanguosha:getCard(to_throw))
				-- effect.to:drawCards(1)
			end
		end
		return false
	end,
}

--捷拳：將裝備卡至於額外卡組，額外卡組的卡可以回應殺、酒、閃、無懈可擊，不可直接使用。


-- local patterns = {"slash", "jink", "analeptic", "nullification"}
-- function getPos(table, value)
	-- for i, v in ipairs(table) do
		-- if v == value then
			-- return i
		-- end
	-- end
	-- return 0
-- end

clearthemeridianscard = sgs.CreateSkillCard{
	name = "clearthemeridians",
	target_fixed = true,
	will_throw = false,
	on_use = function(self, room, source, targets)
		source:addToPile("pulsepile", self)
	end
}

clearthemeridiansvs = sgs.CreateOneCardViewAsSkill{
	name = "clearthemeridians",
	expand_pile = "pulsepile",
	view_filter = function(self, card)
		if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
			return card:isKindOf("EquipCard") and (not sgs.Sanguosha:matchExpPattern(".|.|.|pulsepile", sgs.Self, card))
		end
		return sgs.Sanguosha:matchExpPattern(".|.|.|pulsepile", sgs.Self, card)
	end,
	view_as = function(self, card)

		if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
			local acard = clearthemeridianscard:clone()
			acard:addSubcard(card)
			acard:setSkillName(self:objectName())
			return acard
		elseif sgs.Self:hasFlag("gojink") then
			local ncard = sgs.Sanguosha:cloneCard("jink", card:getSuit(), card:getNumber())
			ncard:addSubcard(card)
			ncard:setSkillName(self:objectName())
			return ncard
		elseif sgs.Self:hasFlag("goslash") then
			local ncard = sgs.Sanguosha:cloneCard("slash", card:getSuit(), card:getNumber())
			ncard:addSubcard(card)
			ncard:setSkillName(self:objectName())
			return ncard
		else
			local ncard = sgs.Sanguosha:cloneCard("analeptic", card:getSuit(), card:getNumber())
			ncard:addSubcard(card)
			ncard:setSkillName(self:objectName())
			return ncard
		end
			
	end,
	enabled_at_play = function(self, player)
		if not player:isNude() then
			local hcn = player:getHandcards()
			local n = player:getEquips():length()
			for _,card in sgs.qlist(hcn) do
				if card:isKindOf("EquipCard") then
					n = n + 1
				end
			end
			if n > 0 then
				return player:getPile("pulsepile"):length() < 3
			else
				return false
			end
		else
			return false
		end
	end,
	
	enabled_at_response = function(self, player, pattern)
		player:setFlags("-gojink")
		player:setFlags("-goslash")
		player:setFlags("-gonullification")
		player:setFlags( "go" .. pattern)
		return ((pattern == "jink") or (pattern == "slash") or (string.find(pattern, "analeptic") and (not player:hasFlag("Global_PreventPeach"))) ) and not player:getPile("pulsepile"):isEmpty()
		-- return ((pattern == "jink") or (pattern == "nullification") or (pattern == "slash") or (string.find(pattern, "analeptic") and (not player:hasFlag("Global_PreventPeach"))) ) and not player:getPile("pulsepile"):isEmpty()
			
	end,
	
	-- enabled_at_nullification = function(self, player)
		-- return not player:getPile("pulsepile"):isEmpty()
	-- end
}

clearthemeridians_fc = sgs.CreateViewAsSkill{ -- 公用行技能卡，丟在整體裡了
	name = "clearthemeridians_fc", 
	n = 999, 
	response_pattern = "@@clearthemeridians_fc", 
	view_filter = function(self, selected, to_select)
		return false
	end, 
	view_as = function(self, cards)
		if sgs.Sanguosha:getCurrentCardUsePattern() == "@@clearthemeridians_fc" then
			if #cards == 0 then
				local name = sgs.Self:property("clearthemeridians_fc"):toString()
				local card = sgs.Sanguosha:cloneCard(name, sgs.Card_NoSuit, 0)
				-- card:setSkillName("_clearthemeridians_fc")
				card:setSkillName("clearthemeridians_fc")
				return card
			end
		end
	end, 
}

clearthemeridians = sgs.CreateTriggerSkill{
	name = "clearthemeridians",
	events = {sgs.PreCardUsed, sgs.PreCardResponded, sgs.GameStart},
	view_as_skill = clearthemeridiansvs,
	on_trigger = function(self, event, player, data)
		if event == sgs.GameStart then
			local room = player:getRoom()
			-- player:gainMark("@pulse", 3)
            
			for j=1, 3, 1 do
				local card_id = room:drawCard()
				player:addToPile("pulsepile", card_id)
			end
			for i = 1,2,1 do
				if not player:isAlive() then break end
				room:fillAG(player:getPile("pulsepile"), player)
				local cid = room:askForAG(player, player:getPile("pulsepile"), false, self:objectName())
				room:clearAG(player)
				player:getPile("pulsepile"):removeOne(cid)
				room:obtainCard(player, sgs.Sanguosha:getCard(cid))
				-- room:throwCard(sgs.Sanguosha:getCard(cid), nil)
			end
		else
			local room = player:getRoom()
			local use = data:toCardUse()
			local card
			if event == sgs.PreCardUsed then
				local use = data:toCardUse()
				card = use.card
			else
				card = data:toCardResponse().m_card
			end
			if card and card:getSkillName() == "clearthemeridians" then
				local n = math.min(2, math.ceil(player:getMark("@pulse")/2))
				player:gainMark("@pulse", 1)
				if player:getMark("@pulse") >= 5 then
							
					n = 0
					player:loseAllMarks("@pulse")
					local Set = function(list)
						local set = {}
						for _, l in ipairs(list) do set[l] = true end
						return set
					end
					local basic = {"slash", "peach", "cancel"}
					if not (Set(sgs.Sanguosha:getBanPackages()))["maneuvering"] then
						table.insert(basic, 2, "thunder_slash")
						table.insert(basic, 2, "fire_slash")
						table.insert(basic, 4, "analeptic")
					end
					for _, patt in ipairs(basic) do
						local poi = sgs.Sanguosha:cloneCard(patt, sgs.Card_NoSuit, -1)
						if (patt == "peach" and not player:isWounded()) then
							table.removeOne(basic, "peach")
						end
						if player:getPhase() == sgs.Player_NotActive then
							table.removeOne(basic, "analeptic")
						end
					end
					local choice = room:askForChoice(player, self:objectName(), table.concat(basic, "+"))
					if choice ~= "cancel" then
						room:setPlayerProperty(player, "clearthemeridians_fc", sgs.QVariant(choice))
						room:askForUseCard(player, "@@clearthemeridians_fc", "@use_card_" .. choice, -1, sgs.Card_MethodUse, false)
						room:setPlayerProperty(player, "clearthemeridians_fc", sgs.QVariant())
					end
				end
				-- if n ~=0 then room:drawCards(player, n) end
				return true
			end
		end
	end
}
ctrClear = sgs.CreateTriggerSkill{
	name = "#ctrClear" ,
	events = {sgs.EventLoseSkill} ,
	on_trigger = function(self, event, player, data)
		if event == sgs.EventLoseSkill then
			if data:toString() == "clearthemeridians" then
				local room = player:getRoom()
				player:removePileByName("pulsepile")
				player:loseAllMarks("@pulse")
			end
		end
	end ,
	can_trigger = function(self, target)
		return target
	end ,
}

-- 擅武

goodatwepCard = sgs.CreateSkillCard{
	name = "goodatwep",
	target_fixed = false,
	will_throw = true,
	filter = function(self, targets, to_select)
			return to_select:objectName() ~= sgs.Self:objectName() and sgs.Self:inMyAttackRange(to_select) and to_select:getPile("goodatwepile"):isEmpty() and not (to_select:isAllNude() or to_select:getMark("GoodatwepMark") > 0)
		end,
		
	on_use = function(self, room, source, targets)
		for _, target in pairs(targets) do
			local room = source:getRoom()
			if target:getEquip(0) and not source:getEquip(0) then
				local choice = room:askForChoice(source, "goodatwep", "gogetit+cancel")
				if choice == "gogetit" then
					if source:getMark("@SuperLimitBreak") == 0 or (source:getMark("@SuperLimitBreak") > 0 and not source:isWounded()) then
						room:loseHp(source, 1)
					end
					room:obtainCard(source, target:getEquip(0))
				end
			end
			local card_id = room:askForCardChosen(source, target, "hej", self:objectName())
			room:setPlayerMark(target, "GoodatwepMark", 1)
			target:addToPile("goodatwepile", card_id, false)
		end
		-- local log = sgs.LogMessage()
		-- log.type = "#PoisonMaggotsLogGetCard"
		-- log.card_str = card:toString()
		-- room:sendLog(log)
		
	end
}

goodatwep = sgs.CreateZeroCardViewAsSkill{ -- 這樣寫可以直接按
	name = "goodatwep",
	view_as = function()
		return goodatwepCard:clone()
	end,
	enabled_at_play = function(self,player)
		-- return not player:hasUsed("#changesexual")
		-- return player:getEquip(0) -- 代表有裝備武器
		return true
	end
}

goodatwepClear = sgs.CreateTriggerSkill{
	name = "#goodatwepClear" ,
	events = {sgs.EventLoseSkill, sgs.Death, sgs.EventPhaseStart, sgs.Damage} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish and player:hasSkill("goodatwep") then
			-- local room = player:getRoom()
			for _,p in sgs.qlist(room:getOtherPlayers(player)) do
				room:setPlayerMark(p, "GoodatwepMark", 0)
				if not p:getPile("goodatwepile"):isEmpty() then
					local thepile = p:getPile("goodatwepile")
					room:obtainCard(p, thepile:first(), false)
				end
			end
		elseif event == sgs.Death then
			local death = data:toDeath()
			-- if death.who:objectName() == player:objectName() then
			if death.who:hasSkill("goodatwep") then
				-- local room = player:getRoom()
				for _,p in sgs.qlist(room:getOtherPlayers(player)) do
					if not p:getPile("goodatwepile"):isEmpty() then
						local thepile = p:getPile("goodatwepile")
						room:obtainCard(p, thepile:first(), false)
					end
				end
			end
		elseif event == sgs.EventLoseSkill then
			if data:toString() == "goodatwep" then
				-- local room = player:getRoom()
				for _,p in sgs.qlist(room:getOtherPlayers(player)) do
					if not p:getPile("goodatwepile"):isEmpty() then
						local thepile = p:getPile("goodatwepile")
						room:obtainCard(p, thepile:first(), false)
					end
				end
			end
		end
		if (event == sgs.Damage) then
			local damage = data:toDamage()
			local target = damage.to
			local thePile = target:getPile("goodatwepile")
			if player:hasSkill("goodatwep") and player:isAlive() and not target:getPile("goodatwepile"):isEmpty() then
				local card_id = thePile:first()
				local card = sgs.Sanguosha:getCard(card_id)
				thePile:removeOne(card_id)
				room:moveCardTo(card, player, sgs.Player_PlaceHand)
			end
		end
		return false
	end ,
	can_trigger = function(self, target)
		return target
	end ,
}
--扶弱
helptheweakCard = sgs.CreateSkillCard{ -- table.insert(hplist, p:getHp())
	name = "helptheweak",
	target_fixed = false,
	will_throw = false,
	filter = function(self, targets, to_select)
		return to_select:isWounded() and sgs.Self:getHp() >= to_select:getHp() and sgs.Self:getHandcardNum() >= to_select:getHandcardNum()
	end,
	on_use = function(self,room,player,targets)
		-- local who = room:getCurrentDyingPlayer()
		-- if not who then return end
		local room = player:getRoom()
		local theRecover = sgs.RecoverStruct()
		theRecover.recover = 1
		theRecover.who = player
		room:recover(targets[1] ,theRecover)
		if targets[1]:objectName() == player:objectName() then
			room:drawCards(player, 1)
			room:throwCard(self, player)
		else
			if player:getMark("@SuperLimitBreak") > 0 then room:drawCards(player, 1) end
			room:moveCardTo(self, targets[1], sgs.Player_PlaceHand)
		end
		
	end
	-- on_use = function(self, room, source, targets)
		-- room:throwCard(self, source)
		-- if source:isAlive() then
			-- local count = self:subcardsLength()
			-- room:drawCards(source, count)
		-- end
	-- end
}
	

helptheweak = sgs.CreateViewAsSkill{
	name = "helptheweak",
	n = 2,
	view_filter = function(self, selected, to_select)
		if #selected == 0 then
			return not to_select:isEquipped()
		elseif #selected == 1 then
			local card = selected[1]
			if card:isRed() then return not (to_select:isEquipped() or to_select:isRed()) end
			if card:isBlack() then return not (to_select:isEquipped() or to_select:isBlack()) end
		else
			return false
		end
	end,
	view_as = function(self, cards)
		if #cards == 2 then
			local cardA = cards[1]
			local cardB = cards[2]
			-- local suit = cardA:getSuit()
			local aa = helptheweakCard:clone()
			-- local aa = sgs.Sanguosha:cloneCard("archery_attack", suit, 0);
			aa:addSubcard(cardA)
			aa:addSubcard(cardB)
			aa:setSkillName(self:objectName())
			return aa
		end
	end,
	enabled_at_play = function(self,player)
		if not player:isKongcheng() then
			local hcn = player:getHandcards()
			local r = 0
			local b = 0
			for _,card in sgs.qlist(hcn) do
				if card:isRed() then
					r = r + 1
				elseif card:isBlack() then
					b = b + 1
				end
			end
			if r > 0 and b > 0 then
				return true
			else
				return false
			end
		else
			return false
		end
	end
}

--木流木馬的卡組就是在卡祖名前面加一&即可生效
-- @skill_invalidity
-- 加上这个标记就能非锁定技无效，不过面板还是能看到。
-- on_use = function(self, room, source, targets)
-- for _, target in pairs(targets) do
-- room:setPlayerMark(target, "@skill_invalidity", 1)
-- end
-- end
-- 技能卡部分这样应该就能对所有选中的人生效了。

--舊版：可以不出牌，或出一張牌視為使用無懈可擊
--反制：你可以將非基本牌和無懈可擊以外的牌視作無懈可擊使用。若發動技能時，你的手牌是全場最少(或之一)，你摸一张牌。
-- countertrickCard=sgs.CreateSkillCard
-- {
	-- name = "countertrick",
	-- target_fixed = true,
	-- will_throw = true,

	-- on_use = function(self, room, source, targets)
		-- local mynum = source:getHandcardNum()
		-- local getless = false
		-- for _,p in sgs.qlist(room:getAlivePlayers()) do
			-- if mynum > p:getHandcardNum() then getless = true break end
		-- end
		-- if not getless then source:drawCards(1) end
	-- end,
-- }
-- luashipocard = sgs.CreateSkillCard{
	-- name = "luashipo",
	-- target_fixed = true,
	-- will_throw = false,
	-- on_use = function(self, room, source, targets)
		-- room:broadcastSkillInvoke("luashipo", math.random(1, 2))
		-- source:addToPile("lizhan", self)
	-- end
-- }

countertrickVS = sgs.CreateViewAsSkill{
	name="countertrick",
	n=1,
	expand_pile = "wooden_ox",
	
	view_filter = function(self, selected, to_select)
		return not (to_select:isKindOf("BasicCard") or to_select:isKindOf("Nullification"))
	end,

	view_as = function(self, cards)
		if #cards == 1 then
			-- local view_as_card = countertrickCard:clone()
			-- view_as_card:addSubcard(cards[1]:getId())
			-- view_as_card:setSkillName(self:objectName())
			-- return view_as_card
			local ncard = sgs.Sanguosha:cloneCard("nullification", cards[1]:getSuit(), cards[1]:getNumber())
			ncard:addSubcard(cards[1])
			ncard:setSkillName(self:objectName())
			return ncard
		end
	end,

	enabled_at_play=function(self, player)
		return false
	end,

	enabled_at_response=function(self,player,pattern)
		if not player:isNude() then
			return pattern == "nullification"
		else
			return false
		end
	end,

	enabled_at_nullification = function(self, player)
		if not player:isNude() then
			local hcn = player:getHandcards()
			for _,card in sgs.qlist(hcn) do
				if not (card:isKindOf("BasicCard") or card:isKindOf("Nullification")) then
					return true
				end
			end
			if player:getEquips():length() > 0 then return true end
		end
		return false
	end
}

countertrick = sgs.CreateTriggerSkill{
	name = "countertrick",
	events = {sgs.PreCardUsed, sgs.CardUsed},
	view_as_skill = countertrickVS,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local use = data:toCardUse()
		if event == sgs.PreCardUsed then
			if use.card and use.card:getSkillName() == "countertrick" then
				if use.card:isKindOf("Nullification") then
					room:broadcastSkillInvoke("countertrick", 1)
				end
			end
		else
			if use.card and use.card:isKindOf("Nullification") then
				local mynum = player:getHandcardNum()
				local getless = false
				for _,p in sgs.qlist(room:getAlivePlayers()) do
					if mynum > p:getHandcardNum() then getless = true break end
				end
				if not getless then player:drawCards(1) end
			end
		end
		return false
	end
}

-- 小提醒：無雙這技能可以改變回應該打出的牌。斷腸：移除目標所有技能，傾城：丟一張裝備卡，目標一項技能到下回合開始不能使用。纏怨：無效目標ALL技能
--[[ 技能存放：變換技能型武將技_備份
	技能名：谋断（转化技）
	相关武将：☆SP·吕蒙
	描述：通常状态下，你拥有标记“武”并拥有技能“激昂”和“谦逊”。当你的手牌数为2张或以下时，你须将你的标记翻面为“文”，将该两项技能转化为“英姿”和“克己”。任一角色的回合开始前，你可弃一张牌将标记翻回。
	引用：LuaMouduanStart、LuaMouduan、LuaMouduanClear
	状态：1217验证通过

LuaMouduanStart = sgs.CreateTriggerSkill{
	name = "#LuaMouduan-start" ,
	events = {sgs.GameStart} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		player:gainMark("@wu")
		room:acquireSkill(player, "jiang")
		room:acquireSkill(player, "qianxun")
	end ,
}
LuaMouduan = sgs.CreateTriggerSkill{
	name = "LuaMouduan" ,
	events = {sgs.EventPhaseStart, sgs.CardsMoveOneTime} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local lvmeng = room:findPlayerBySkillName(self:objectName())
		if event == sgs.CardsMoveOneTime then
			local move = data:toMoveOneTime()
			if move.from and (move.from:objectName() == player:objectName()) and (player and player:isAlive() and player:hasSkill(self:objectName()))
					and (player:getMark("@wu") > 0) and (player:getHandcardNum() <= 2) then
				player:loseMark("@wu")
				player:gainMark("@wen")
				room:handleAcquireDetachSkills(player, "-jiang|-qianxun|yingzi|keji")
			end
		elseif (player:getPhase() == sgs.Player_RoundStart) and lvmeng and (lvmeng:getMark("@wen") > 0)
				and lvmeng:canDiscard(lvmeng, "he") then
			if room:askForCard(lvmeng, "..", "@LuaMouduan", sgs.QVariant(), self:objectName()) then
				if lvmeng:getHandcardNum() > 2 then
					lvmeng:loseMark("@wen")
					lvmeng:gainMark("@wu")
					room:handleAcquireDetachSkills(lvmeng, "-yingzi|-keji|jiang|qianxun")
				end
			end
		end
		return false
	end ,
	can_trigger = function(self, target)
		return target
	end
}
LuaMouduanClear = sgs.CreateTriggerSkill{
	name = "#LuaMouduan-clear" ,
	events = {sgs.EventLoseSkill} ,
	on_trigger = function(self, event, player, data)
		if data:toString() == "LuaMouduan" then
			local room = player:getRoom()
			if player:getMark("@wu") > 0 then
				room:detachSkillFromPlayer(player, "jiang")
				room:detachSkillFromPlayer(player, "qianxun")
			elseif player:getMark("@wen") > 0 then
				room:detachSkillFromPlayer(player, "yingzi")
				room:detachSkillFromPlayer(player, "keji")
			end
		end
		return false
	end ,
	can_trigger = function(self, target)
		return target
	end
}
]]--
-- or target:hasSkill("PoisonMaggots"))
-- JSPwonyi:addSkill(LuaWangzun)

gdancerva = sgs.CreateZeroCardViewAsSkill{
	name = "gdancer",
	view_as = function(self)
	    local pattern = sgs.Self:property("gduse"):toString()
		local acard = sgs.Sanguosha:cloneCard(pattern, sgs.Card_NoSuit, -1)
		acard:setSkillName("gdancercard")
		return acard
    end,
	enabled_at_play = function(self,player)
		return false
	end,
	enabled_at_response = function(self, player, pattern)
		return pattern == "@@gdancer"
	end,
}

gdancer = sgs.CreateTriggerSkill
{
	name = "gdancer",
	events = {sgs.TargetConfirming},
	view_as_skill = gdancerva,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local use = data:toCardUse()
		if use.card and (use.card:isNDTrick() or use.card:isKindOf("Slash")) and use.to:contains(player) and use.from ~= player --  and use.card:isNDTrick()
		and room:askForSkillInvoke(player, self:objectName(), data) then
			room:broadcastSkillInvoke("gdancer",math.random(1,2))
			-- local red = room:askForCard(player, ".|red|.|hand", "@gdancer:"..use.card:objectName(), data, sgs.Card_MethodDiscard, nil, false, self:objectName(), false)
			local judge = sgs.JudgeStruct()
				judge.pattern = ".|red"
				judge.good = true
				judge.reason = self:objectName()
				judge.who = player
				judge.play_animation = false
				-- room:setEmotion(player, "armor/EightDiagram");
				room:judge(judge)
			if judge:isGood() then
				-- local jink = sgs.Sanguosha:cloneCard("jink", sgs.Card_NoSuit, 0)
				-- jink:setSkillName(self:objectName())
				-- room:provide(jink)
				-- return true
				-- end
			-- if red then
				local acard = sgs.Sanguosha:cloneCard(use.card:objectName(), sgs.Card_NoSuit, 0)
				if acard:isAvailable(player) then
					if use.card:objectName() == "ex_nihilo" or use.card:objectName() == "amazing_grace"
					or use.card:objectName() == "savage_assault" or use.card:objectName() == "archery_attack"
					or use.card:objectName() == "god_salvation" then
						local u = sgs.CardUseStruct()
						local acard = sgs.Sanguosha:cloneCard(use.card:objectName(), sgs.Card_NoSuit, -1)
						acard:setSkillName("gdancercard")
						u.card = acard
						u.from = player
						room:useCard(u)
					else
						if use.card:objectName() == "collateral" then
							local boolean = false
							for _,p in sgs.qlist(room:getOtherPlayers(player)) do
								if p:getWeapon() then
									boolean = true
									break
								end
							end
							if boolean then
								room:setPlayerProperty(player, "gduse", sgs.QVariant(use.card:objectName()))
								room:askForUseCard(player, "@@gdancer", "@use_card_" .. use.card:objectName())
								room:setPlayerProperty(player, "gduse", sgs.QVariant())
							else
								return false
							end
						else
							room:setPlayerProperty(player, "gduse", sgs.QVariant(use.card:objectName()))
							room:askForUseCard(player, "@@gdancer", "@use_card_" .. use.card:objectName())
							room:setPlayerProperty(player, "gduse", sgs.QVariant())
						end
					end
				end
				use.to = sgs.SPlayerList()
				data:setValue(use)
			else
				local count = player:getLostHp()
				if count > 2 then count = 2 end
				room:drawCards(player, count + 1)
			end
		end
		return false
	end
}

goldentearCard = sgs.CreateSkillCard{
	name = "goldentearCard",
	target_fixed = true,
	on_use = function(self,room,player,targets)
		local who = room:getCurrentDyingPlayer()
		local room = player:getRoom()
		if not who then return end
		local theRecover = sgs.RecoverStruct()
		local count = self:subcardsLength()
		theRecover.recover = count
		theRecover.who = player
		room:recover(who,theRecover)
		room:setPlayerMark(player, "Goldentearused", 1)
	end
}

goldentear = sgs.CreateViewAsSkill{
	name = "goldentear",
	n = 999,
	view_filter = function(self, selected, to_select)
		-- if #selected == 0 then
			-- return to_select:isKindOf("Jink")
			return not (to_select:isKindOf("Peach") or to_select:isRed())
		-- end
		-- return false
	end,
	view_as = function(self, cards)
		if #cards > 0 then
			local fakeMOMO_card = goldentearCard:clone()
			for _,card in pairs(cards) do
				fakeMOMO_card:addSubcard(card)
			end
			fakeMOMO_card:setSkillName("goldentear")
			return fakeMOMO_card
		end
		-- if #cards == 1 then
			-- local card = cards[1]
			-- local suit = card:getSuit()
			-- local point = card:getNumber()
			-- local id = card:getId()
			-- local peach = sgs.Sanguosha:cloneCard("peach", suit, point)
			-- peach:setSkillName(self:objectName())
			-- peach:addSubcard(id)
			-- return peach
		-- end
		-- return nil
	end,
	enabled_at_play = function(self, player)
		return false
	end,
	enabled_at_response = function(self, player, pattern)
		-- local phase = player:getPhase()
		-- if phase == sgs.Player_NotActive then
		if player:getMark("Goldentearused") > 0 then
			return false
		else
			return string.find(pattern, "peach")
		end
		-- end
		-- return false
	end
}

--【萌妹纸动画】
gdsvoice = sgs.CreateTriggerSkill{
	name = "gdsvoice",
	events = {sgs.AfterDrawInitialCards},
	-- events = {sgs.AfterDrawInitialCards, sgs.EventPhaseStart, sgs.ChoiceMade}, --妹子好吵，關起來。只要把綠色重新解放，即可重新召喚妹子
	global = true,
	can_trigger = function(self, player)
	    return true
	end,
	on_trigger = function(self, event, player, data)
	    local room = player:getRoom()
	if event == sgs.AfterDrawInitialCards then
	    -- if player:getState() ~= "robot" then
			-- room:setPlayerFlag(player, "skip_anime")
			-- room:setPlayerMark(player, "For_sence_anime", 1)
			-- room:setPlayerProperty(player, "emotion", sgs.QVariant("yuudachi"))
			-- local emotion = player:property("emotion"):toString()
			-- if player:hasSkill("crushingimpact") then
				-- room:broadcastSkillInvoke("gdsvoice", 6)
			-- else
				-- room:broadcastSkillInvoke("gdsvoice", 3)
			-- end
			-- local json = require("json")
			-- local jsonValue = {
			-- player:objectName(),
			-- emotion
			-- }
			-- local wholist = sgs.SPlayerList()
            -- wholist:append(player)
			-- room:doBroadcastNotify(wholist,sgs.CommandType.S_COMMAND_SET_EMOTION, json.encode(jsonValue))

			if room:askForSkillInvoke(player, "allknow", data) then --詢問是否要看全身分
				local list = room:getAlivePlayers()
				for _,t in sgs.qlist(list) do
					local log = sgs.LogMessage()
					log.type = "#allknow_log"
					log.from = t
					log.arg = t:getRole()
					room:sendLog(log)
				end
			end
			
        -- end
	end
	-- if event == sgs.EventPhaseStart then
	    -- if player:getPhase() == sgs.Player_Start then
			-- if player:getState() ~= "robot" and player:getMark("For_sence_anime") <= 0 then
				-- room:setPlayerFlag(player, "skip_anime")
				-- room:setPlayerMark(player, "For_sence_anime", 1)
				-- room:setPlayerProperty(player, "emotion", sgs.QVariant("yuudachi"))
				-- local emotion = player:property("emotion"):toString()
				-- if player:hasSkill("crushingimpact") then
					-- room:broadcastSkillInvoke("gdsvoice", 6)
				-- else
					-- room:broadcastSkillInvoke("gdsvoice", 3)
				-- end
				-- local json = require("json")
				-- local jsonValue = {
				-- player:objectName(),
				-- emotion
				-- }
				-- local wholist = sgs.SPlayerList()
				-- wholist:append(player)
				-- room:doBroadcastNotify(wholist,sgs.CommandType.S_COMMAND_SET_EMOTION, json.encode(jsonValue))
				-- return false
			-- end
			-- room:setEmotion(player,"light")
    	    -- if player:getState() ~= "robot" and math.random(1,10) <= 2 and not player:hasFlag("skip_anime") then
			    -- local emotion = player:property("emotion"):toString()
				-- room:broadcastSkillInvoke("gdsvoice",math.random(1,2))
			    -- local json = require("json")
				-- local jsonValue = {
				-- player:objectName(),
				-- emotion
				-- }
				-- local wholist = sgs.SPlayerList()
				-- wholist:append(player)
				-- room:doBroadcastNotify(wholist,sgs.CommandType.S_COMMAND_SET_EMOTION, json.encode(jsonValue))
            -- end
		-- end
		-- if player:getPhase() == sgs.Player_Finish then
		    -- room:setEmotion(player,"dark")
		-- end
	-- end
	-- if event == sgs.ChoiceMade then
	    -- if player:getState() ~= "robot" and math.random(1,25) == 1 then
		    -- local emotion = player:property("emotion"):toString()
			-- room:broadcastSkillInvoke("gdsvoice",math.random(4,5))
			-- local json = require("json")
			-- local jsonValue = {
			-- player:objectName(),
			-- emotion
			-- }
			-- local wholist = sgs.SPlayerList()
			-- wholist:append(player)
			-- room:doBroadcastNotify(wholist,sgs.CommandType.S_COMMAND_SET_EMOTION, json.encode(jsonValue))
        -- end
	-- end
	end,
}
--【↑萌妹纸动画】

healingwaterCard = sgs.CreateSkillCard{
	name = "healingwaterCard" ,
	-- target_fixed = true ,
	target_fixed = false,
	will_throw = true,
	filter = function(self, targets, to_select)
		return #targets < 2 and (to_select:objectName() ~= sgs.Self:objectName())
	end, 
	feasible = function(self, targets)
		return #targets <= 2
	end, 
	on_use = function(self, room, source, targets)
		-- local players = room:getOtherPlayers(source)
		source:setFlags("healingwaterUsing")
		-- for _, player in sgs.qlist(players) do
		for _,player in pairs(targets) do
			if player:isAlive() then
				room:cardEffect(self, source, player)
			end
		end
		source:setFlags("-healingwaterUsing")
	end ,
	on_effect = function(self, effect)
		local room = effect.to:getRoom()
		local length = effect.to:getEquips():length() + effect.to:getHandcardNum()
		local limitdis = effect.from:getHp()
		-- local count = 0
		-- if length == limitdis then return false end
		if length <= limitdis then
			room:drawCards(effect.to, limitdis)
		else
			local x = 0
			while length > limitdis do
				local card_id = room:askForCardChosen(effect.from, effect.to, "he", "healingwater")
				room:obtainCard(effect.from, card_id)
				length = effect.to:getEquips():length() + effect.to:getHandcardNum()
				x = x + 1
				if length <= limitdis or x >= 5 then break end
			end
		end
	end
}

healingwater = sgs.CreateViewAsSkill{
	name = "healingwater" ,
	n = 0,
	view_as = function()
		return healingwaterCard:clone()
	end ,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#healingwaterCard")
	end
}

waterfairy = sgs.CreateTriggerSkill{
	name = "waterfairy",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.DamageInflicted},
	on_trigger = function(self, event, player, data)
		local damage = data:toDamage()
		return damage.nature == sgs.DamageStruct_Fire
	end
}
waterfairymc = sgs.CreatePhaseChangeSkill{
	name = "#waterfairymc", 
	on_phasechange = function(self, player)
		local room = player:getRoom()
		if player:getPhase() == sgs.Player_Discard then
			if player:isNude() then return false end
			local hcn = player:getCards("h")
			local bool = false
			if hcn:length() > 0 then
			for _,card in sgs.qlist(hcn) do
				if card:getSuit() == sgs.Card_Heart then
					bool = true
					break
				end
			end
			end
			if player:getEquips():length() > 0 and not bool then
				for _, ecard in sgs.qlist(player:getEquips()) do
					if ecard:getSuit() == sgs.Card_Heart then
						bool = true
						break
					end
				end
			end
			
			if player:isWounded() and bool and room:askForCard(player, ".|heart|.", "@waterfairymc") then
			-- local askcard = room:askForCard(player, ".|heart|.|hand", "@waterfairymc")
				-- local beneficiary = room:askForPlayerChosen(player, room:getAlivePlayers(), "waterfairy")
				-- if beneficiary:isWounded() then
					room:setPlayerMark(player, "WaterfairyMaxcards", 0)
					local theRecover = sgs.RecoverStruct()
					theRecover.recover = 1
					theRecover.who = player
					room:recover(player, theRecover)
				-- else
					-- local count = player:getHp()
					-- room:setPlayerMark(player, "WaterfairyMaxcards", count)
				-- end
			else
				local count = player:getHp()
				room:setPlayerMark(player, "WaterfairyMaxcards", count)
			end
		end
	end
}
--手牌上限公用技能(公廁)
maxCardSkill = sgs.CreateMaxCardsSkill{
	name = "#maxCardSkill" ,
	extra_func = function(self, target)
		
		local getnum = 0
		
		if target:hasSkill("lovesweet") then 
			-- local n = 0
			for _, card in sgs.qlist(target:getHandcards()) do
				if target:hasSkill("lovesweet") and target:getPhase() == sgs.Player_Discard then
					-- if card:getSuit() == sgs.Card_Heart then n = n + 1 end
					if card:getSuit() == sgs.Card_Heart then getnum = getnum + 1 end
				end
			end
			-- return n
		end

		if target:hasSkill("waterfairy") then -- 水靈最大手牌
			-- return target:getMark("WaterfairyMaxcards")
			getnum = getnum + target:getMark("WaterfairyMaxcards")
		end
		if target:hasSkill("okanemochi") and target:getMark("okanemochi_maxh") > 0 then -- 家資最大手牌
			getnum = getnum + target:getMark("okanemochi_maxh")
		end
		if target:hasSkill("zerodifference") or target:hasFlag("Yuejianbuff") then -- 手牌視為生命上限類
			-- return target:getLostHp()
			getnum = getnum + target:getLostHp()
		end
		if target:hasSkill("witty") and (target:getOffensiveHorse() or target:getDefensiveHorse()) then -- 巧智最大手牌
			-- return 1
			getnum = getnum + 1
		end
		if target:hasSkill("likebooks") and not target:getPile("books"):isEmpty() then -- 閱歷
			-- return target:getPile("books"):length()
			getnum = getnum + target:getPile("books"):length()
		end
		if target:getMark("@sizukana_mark") > 0 then -- 是否獲得止水
		    -- return 1
			getnum = getnum + 1
		end
		-- if target:getPile("Maggots"):isEmpty() and (not target:hasSkill("PoisonMaggots")) then -- 判斷沒被寄生的對象
		    -- return 0
		-- end
		if target:hasSkill("PoisonMaggots") then -- 判斷是否蟲主
		    -- return 2
			getnum = getnum + 2
		end
		if not target:getPile("Maggots"):isEmpty() and not target:hasFlag("ForAllyMaggot") then -- 判斷是否被寄生且沒有友善標記
			-- return -target:getPile("Maggots"):length()
			getnum = getnum - target:getPile("Maggots"):length()
		end
		if not target:getPile("Maggots"):isEmpty() and target:hasFlag("ForAllyMaggot") then -- 判斷是否被寄生且有友善標記
			-- return target:getPile("Maggots"):length()
			getnum = getnum + target:getPile("Maggots"):length()
		end
		if target:hasSkill("braveheart") and target:getMark("@SuperLimitBreak") > 0 then -- 驍勇界破
			getnum = getnum + target:getLostHp() + 1
		end
		if target:getMark("@yuri_hengjiang") > 0 then -- 是否獲被百合橫江
			getnum = getnum - target:getMark("@yuri_hengjiang")
		end
		if target:getGeneralName() == "bloodymarry" and target:getMark("Hponeguys") > 0 then -- 血腥瑪麗最大手牌
			getnum = getnum + target:getMark("Hponeguys")
		end
		if target:getMark("AddMaxHandCards") > 0 then -- 碎閃標記最大手牌
			getnum = getnum + target:getMark("AddMaxHandCards")
		end
		if target:hasSkill("hb_yitain") and target:getMark("@SuperLimitBreak") > 0 and not target:isKongcheng() then -- 倚天
			local n = 0
			for _,c in sgs.qlist(target:getHandcards()) do
				if c:isKindOf("Jink") then
					n=n+1
				end
			end
			getnum = getnum + n
		end
		return getnum
	end
}

-- 窺視

peekingCard = sgs.CreateSkillCard
{
	name = "peeking",
	target_fixed = false,
	-- once = false,
	will_throw = false,
	filter = function(self,targets,to_select,player)
		return (#targets < 1) and (to_select:isKongcheng() == false) and (to_select:objectName() ~= sgs.Self:objectName())
	end,
	on_effect = function(self,effect)
		local from = effect.from
		local to = effect.to
		local room = from:getRoom()
		local x = 0
		local allcard = DummyCard:clone()
		room:setPlayerMark(to ,"peeking_AI" ,1)
		room:setPlayerFlag(to, "peekingUsing")
		local choice = room:askForChoice(from, self:objectName(), "BasicCard+EquipCard+TrickCard")
		room:setPlayerMark(to ,"peeking_AI" ,0)
		local log = sgs.LogMessage()
		log.type = "$peeking_log"
		log.from = from
		log.to:append(to)
		log.arg = choice
		room:sendLog(log)
		for _, card in sgs.qlist(to:getHandcards()) do
			if card:isKindOf(choice) then
				-- room:throwCard(card ,to ,from)
				allcard:addSubcard(card)
				x = x + 1
			end
		end
		-- if not to:isKongcheng() then
			local card_ids = to:handCards()
			-- room:fillAG(card_ids, from) --以前不會用showAllCards
			-- local choice_id = room:askForAG(from, card_ids, true, self:objectName())
			-- room:clearAG(from)
			room:showAllCards(to)
		-- end
		if x >= 4 then
			room:broadcastSkillInvoke("gdsvoice", 8)
			room:sendCompulsoryTriggerLog(from, self:objectName())
			local skills = to:getVisibleSkillList()
			local detachList = {}
			for _,skill in sgs.qlist(skills) do
				if not skill:inherits("SPConvertSkill") and not skill:isAttachedLordSkill() then
					table.insert(detachList,"-"..skill:objectName())
				end
			end
			room:handleAcquireDetachSkills(to, table.concat(detachList,"|"))
		end
		if x == 0 then room:broadcastSkillInvoke("gdsvoice", 7) end
		if choice == "BasicCard" then
			-- local dolow = math.min(4, x+1)
			from:drawCards(1)
			if x >= 3 then
				room:throwCard(allcard ,to ,from)
			end
			x = 0
		end
		if choice == "TrickCard" then
			if x > 0 then
				room:throwCard(allcard ,to ,from)
			end
			if x >= 2 then
				room:loseHp(to)
			end
			x = 0
		end
		if choice == "EquipCard" then
			-- if x >= 2 then
				-- if ecards:length() > 0 then
					-- for _,ec in sgs.qlist(ecards) do
						-- allcard:addSubcard(ec)
					-- end
				-- end
			-- end
			if x > 0 then
				room:throwCard(allcard ,to ,from)
			end
			for i=1, x, 1 do
				local ecards = to:getCards("e")
				if ecards:length() > 0 and from:canDiscard(to, "e") then
					local card_id = room:askForCardChosen(from, to, "e", "peeking")
					room:throwCard(card_id, to, from)
				else
					break
				end
			end
			x = 0
		end
		return false
	end,
}

peeking = sgs.CreateViewAsSkill{
	name = "peeking",
	n=0,
	view_filter=function()
		return false
	end,
	view_as=function(self, cards)        
		return peekingCard:clone()
	end,
	enabled_at_play=function(self,player) 
		return not player:hasUsed("#peeking")
	end,
	enabled_at_response=function(self,player,pattern)
		return false
	end,
}


bloodfight = sgs.CreateFilterSkill{
	name = "bloodfight",
	view_filter = function(self,to_select)
		local room = sgs.Sanguosha:currentRoom()
		local place = room:getCardPlace(to_select:getEffectiveId())
		return (not to_select:isKindOf("Duel")) and (place == sgs.Player_PlaceHand)
		-- return (not to_select:isKindOf("Duel")) and (place == sgs.Player_PlaceHand or place == sgs.Player_PlaceEquip)
		-- return not (to_select:isKindOf("Duel") and to_select:isKindOf("Slash"))
	end,
	view_as = function(self, originalCard)
		local slash = sgs.Sanguosha:cloneCard("thunder_slash", originalCard:getSuit(), originalCard:getNumber())
		slash:setSkillName(self:objectName())
		local card = sgs.Sanguosha:getWrappedCard(originalCard:getId())
		card:takeOver(slash)
		return card
	end
}

--公共廁所_公廁_增加殺次數
slashtimesskill = sgs.CreateTargetModSkill{
	name = "slashtimesskill",
	frequency = sgs.Skill_NotCompulsory,
	residue_func = function(self, player)
		if player:hasSkill("bloodfight") then
			return player:getLostHp()	
		end
		if  player:hasSkill("moveliketrigger") then
			return 1
		end
		return 0
	end
}

warlikeva = sgs.CreateOneCardViewAsSkill{
	name = "warlike",
	view_filter = function(self,to_select)
		-- if to_select:isEquipped() then return false end
		-- local value = sgs.Self:getMark("warlikeva")
		-- if value == 1 then
			return to_select:isKindOf("TrickCard")
		-- elseif value == 2 then
			-- return to_select:isRed()
		-- end
		-- return false
	end,
	view_as = function(self, card)
		local duel = sgs.Sanguosha:cloneCard("duel", card:getSuit(), card:getNumber())
		duel:addSubcard(card)
		duel:setSkillName("warlike")
		return duel
	end,
	enabled_at_play = function(self, player)
		return not player:isKongcheng()
	end
}

warlike = sgs.CreateTriggerSkill{
	name = "warlike",
	events = {sgs.EventPhaseStart, sgs.CardUsed},
	view_as_skill = warlikeva,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.CardUsed then
			local use = data:toCardUse()
			if use.card and use.card:isKindOf("Duel") and use.card:getSkillName() == "warlike" and not player:hasSkill("bloodfight") then
				-- room:broadcastSkillInvoke("warlike")
				room:acquireSkill(player, "bloodfight")
				if player:getMark("@SuperLimitBreak") > 0 and use.to:length() > 0 then
					for _, p in sgs.qlist(use.to) do
						-- player:gainMark("&test")
						local warlike_skills = p:getTag("warlikeSkills"):toString():split("+")
						local skills = p:getVisibleSkillList()
						for _, skill in sgs.qlist(skills) do
							if not skill:isAttachedLordSkill() then
								room:addPlayerMark(p, "Qingcheng"..skill:objectName())
								table.insert(warlike_skills, skill:objectName())
							end
						end
						p:setTag("warlikeSkills", sgs.QVariant(table.concat(warlike_skills, "+")))
						p:gainMark("&bloodfight")
					end
				end
			end
		end
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish and player:hasSkill("bloodfight") then
			room:drawCards(player, player:getLostHp() + 1, self:objectName())
			room:detachSkillFromPlayer(player, "bloodfight")
			
			if player:getMark("@SuperLimitBreak") > 0 then
				local list = room:getAlivePlayers()
				for _,t in sgs.qlist(list) do
					if t:getMark("&bloodfight") > 0 then
						local warlike_skills = t:getTag("warlikeSkills"):toString():split("+")
						for _, skill_name in ipairs(warlike_skills) do
							room:removePlayerMark(t, "Qingcheng"..skill_name)
						end
						t:setTag("warlikeSkills", sgs.QVariant())
						t:loseAllMarks("&bloodfight")
					end
				end
			end
			
		end

	end
}
warlikeClear = sgs.CreateTriggerSkill{
	name = "#warlikeClear" ,
	events = {sgs.EventLoseSkill} ,
	on_trigger = function(self, event, player, data)
		if data:toString() == "warlike" and player:hasSkill("bloodfight") then
			local room = player:getRoom()
			room:detachSkillFromPlayer(player, "bloodfight")
			local list = room:getAlivePlayers()
			for _,t in sgs.qlist(list) do
				if t:getMark("&bloodfight") > 0 then
					local warlike_skills = t:getTag("warlikeSkills"):toString():split("+")
					for _, skill_name in ipairs(warlike_skills) do
						room:removePlayerMark(t, "Qingcheng"..skill_name)
					end
					t:setTag("warlikeSkills", sgs.QVariant())
					t:loseAllMarks("&bloodfight")
				end
			end
		end
		return false
	end ,
	can_trigger = function(self, target)
		return target
	end
}

arkora = sgs.CreateTriggerSkill{
	name = "arkora" ,
	events = {sgs.TargetSpecified} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		-- if event == sgs.CardResponded then
	        	-- local resp = data:toCardResponse()
	        	-- if resp.m_card:getSkillName() == "longdan" and resp.m_who and (not resp.m_who:isKongcheng()) then
		            	-- local _data = sgs.QVariant()
				-- _data:setValue(resp.m_who)
		                -- if player:askForSkillInvoke(self:objectName(), _data) then
		                	-- local card_id = room:askForCardChosen(player, resp.m_who, "h", self:objectName())
		                	-- local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_EXTRACTION, player:objectName())
		                	-- room:obtainCard(player, sgs.Sanguosha:getCard(card_id), reason, false)
		                -- end
	        	-- end
	        -- else
	            local use = data:toCardUse()
	            if use.card:isKindOf("Slash") or use.card:isKindOf("Duel") then
	                for _, p in sgs.qlist(use.to) do
	                	if p:isKongcheng() then continue end
	                	local _data = sgs.QVariant()
						_data:setValue(p)
						p:setFlags("arkoraTarget")
	                	local invoke = player:askForSkillInvoke(self:objectName(), _data)
	                	p:setFlags("-arkoraTarget")
	                	if invoke then
							room:broadcastSkillInvoke("arkora")
							local card_id = room:askForCardChosen(player, p, "h", self:objectName())
							local card = sgs.Sanguosha:getCard(card_id)
							-- local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_DISCARD, player:objectName())
							-- room:obtainCard(player, sgs.Sanguosha:getCard(card_id), reason, false)
							-- room:throwCard(card ,reason ,nil)
							room:throwCard(card_id ,p ,player)
							if card:isKindOf("EquipCard") then
								local acard = room:askForCard(p, "Jink", "@arkoraask", sgs.QVariant(), sgs.Card_MethodResponse)
								if not acard then
									room:damage(sgs.DamageStruct("arkoraDamage", player, p, 1, sgs.DamageStruct_Normal))
								end
							end
						end
	                end
	            end
	        -- end
	        return false
	end
}
--[[
--碎沖：選擇一名目標並棄置一張殺或延時錦囊，然後翻開牌堆上自身失去生命數量的牌。每有一張：裝備牌，對方受到來自於你的X點傷害(X為對方裝備數量)；錦囊牌，你摸兩張牌；基本牌，對方流失一點生命。
crushingimpactCard = sgs.CreateSkillCard{
	name = "crushingimpactCard" ,
	target_fixed = false,
	will_throw = true,
	filter = function(self, targets, to_select)
		return #targets < 1 and to_select:objectName() ~= sgs.Self:objectName()
	end, 
	feasible = function(self, targets)
		return #targets == 1
	end, 
	on_use = function(self, room, source, targets)
		source:setFlags("crushingimpactUsing")
		for _,player in pairs(targets) do
			if player:isAlive() then
				room:cardEffect(self, source, player)
			end
		end
		source:setFlags("-crushingimpactUsing")
	end ,
	on_effect = function(self, effect)
		local room = effect.from:getRoom()
		-- local damagecause = effect.to:getEquips():length()
		local cardIds = sgs.IntList()
		-- if room:askForChoice(effect.from, "crushingimpact", "losehp+cancel") == "losehp" then
			-- room:loseHp(effect.from, 1)
			-- local gcount = effect.from:getHp() + 2
			local gcount = 5
			local gcard = room:getNCards(gcount)
			room:askForGuanxing(effect.from,gcard)
		-- end
		-- local findcard = effect.from:getLostHp()
		-- if findcard == 0 then findcard = 1 end
		-- if damagecause == 0 then damagecause = 1 end
		-- for i=1, findcard, 1 do
		local findcard = 1
		for i=1, findcard, 1 do
			local id = room:drawCard()
			cardIds:append(id)
		end
		assert(cardIds:length() == findcard)
		local move = sgs.CardsMoveStruct()
		move.card_ids = cardIds
		move.to_place = sgs.Player_PlaceTable
		move.reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_TURNOVER, effect.from:objectName(), "", "crushingimpact", "")
		room:moveCardsAtomic(move, true)
		room:getThread():delay()
		local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_NATURAL_ENTER, "", "crushingimpact", "")
		local count = findcard - 1
		for i=0, count, 1 do
			local card_id = cardIds:at(i)
			local card = sgs.Sanguosha:getCard(card_id)
			if card:isKindOf("BasicCard") then
				room:loseHp(effect.to, 1)
				room:throwCard(card, reason, nil)
			elseif card:isKindOf("TrickCard") then
				-- effect.from:drawCards(2)
				room:obtainCard(effect.from, card, true)
			else
				local acards = effect.to:getCards("e")
				local damagecause = effect.to:getEquips():length()
				if damagecause == 0 then damagecause = 1 end
				if acards:length() > 0 then
					local allcard = DummyCard:clone()
					for _,card in sgs.qlist(acards) do
							allcard:addSubcard(card)
					end
					room:throwCard(allcard, effect.to, effect.from)
				end
				room:damage(sgs.DamageStruct("crushingimpactDamage", effect.from, effect.to, damagecause, sgs.DamageStruct_Normal))
				room:throwCard(card, reason, nil)
			end
			
		end
	end
}
crushingimpact = sgs.CreateOneCardViewAsSkill{
	name = "crushingimpact",
	expand_pile = "wooden_ox",
	view_filter = function(self,to_select)
		-- return to_select:isKindOf("DelayedTrick") or to_select:isKindOf("Slash")
		return not to_select:isEquipped()
	end,
	view_as = function(self, card)
		local acard = crushingimpactCard:clone()
		acard:addSubcard(card)
		acard:setSkillName("crushingimpact")
		return acard
	end,
	enabled_at_play = function(self,player)
		return not (player:hasUsed("#crushingimpactCard") or player:isKongcheng())
	end,
	enabled_at_response = function(self, player, pattern)
		return false
	end,

}
]]
--正版碎沖=>碎閃：階段技，選擇一名目標棄置其一張手牌。若該牌為【桃】或【酒】，妳直接使用之(不算入次數限制)。若非，本回合與該牌同花色的手牌不計入你的手牌數量，且若其手牌加裝備數量大於等於你的持有數，則其流失1點生命。

kurashinfurashuCard = sgs.CreateSkillCard{
	name = "kurashinfurashu",
	target_fixed = false,
	will_throw = false,
	filter = function(self, targets, to_select, player)
		return to_select:objectName() ~= player:objectName() and to_select:getHandcardNum() > 0 and #targets < 1
	end,
	on_use = function(self, room, source, targets)
		source:setFlags("kurashinfurashuUsing")
		for _,player in pairs(targets) do
			if player:isAlive() and not player:isKongcheng() then
				room:cardEffect(self, source, player)
			end
		end
		source:setFlags("-kurashinfurashuUsing")
	end ,
	on_effect = function(self, effect)
		local room = effect.to:getRoom()
		local card_id = room:askForCardChosen(effect.from, effect.to, "h", "kurashinfurashu")
		local rc = sgs.Sanguosha:getCard(card_id)
		if not card_id then return false end
		room:addPlayerMark(effect.from, "&kurashinfurashu+:+"..rc:getSuitString().."_char-Clear")
		-- local c = sgs.Sanguosha:cloneCard(use.card:objectName(), sgs.Card_NoSuit, 0)
		-- c:deleteLater()
		-- c:setSkillName(self:objectName())
		
		-- if room:askForChoice(effect.from, self:objectName(), "kf_givecard+kf_losthp") == "kf_givecard" then
			-- local slash = sgs.Sanguosha:cloneCard("slash")
			-- slash:deleteLater()
			-- local cards = effect.to:getCards("hej")
			-- for _,card in sgs.qlist(cards) do
				-- if card:getSuit() == rc:getSuit() then
					-- slash:addSubcard(card)
				-- end
			-- end
			-- if slash:subcardsLength() > 0 then
				-- room:giveCard(effect.to, effect.from, slash, self:objectName())
			-- end
		-- else
		local n = 0
		for _,c in sgs.qlist(effect.from:getHandcards()) do
			if c:getSuit() == rc:getSuit() then
				n = n+1
			end
		end
		local log = sgs.LogMessage()
		log.type = "#kurashi_log"
		log.from = effect.from
		log.arg = rc:getSuitString()
		-- log.arg2 = rc:getColorString()
		-- log.card_str = card:toString()
		room:sendLog(log)
		room:setPlayerMark(effect.from, "AddMaxHandCards", n)
		if not rc:isKindOf("Analeptic") and not rc:isKindOf("Peach") then
			room:throwCard(card_id, effect.to, effect.from)
			if effect.from:getCards("he"):length() <= effect.to:getCards("he"):length() then room:loseHp(effect.to) end
		else
			-- if effect.from:getMark("@SuperLimitBreak") > 0 then
				room:moveCardTo(rc, effect.from, sgs.Player_PlaceTable)
				if rc:isKindOf("Analeptic") then --給AI判斷，因為選角色不能帶入DATA
					room:setPlayerMark(effect.from, "kurashu_ai_a", 1)
				else
					room:setPlayerMark(effect.from, "kurashu_ai_p", 1)
				end
				local target = room:askForPlayerChosen(effect.from, room:getAlivePlayers(), "kurashinfurashu")
				if target then
					room:useCard(sgs.CardUseStruct(rc, effect.from, target), false)
				end
				room:setPlayerMark(effect.from, "kurashu_ai_a", 0)
				room:setPlayerMark(effect.from, "kurashu_ai_p", 0)
			-- else
				-- room:useCard(sgs.CardUseStruct(rc, effect.from, effect.from), false)
			-- end
		end
		-- end
	end
}

kurashinfurashuVA = sgs.CreateZeroCardViewAsSkill{
	name = "kurashinfurashu",
	view_as = function(self)
		local acard = kurashinfurashuCard:clone()
		acard:setSkillName(self:objectName())
		return acard
	end,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#kurashinfurashu")
	end
}

kurashinfurashu = sgs.CreateTriggerSkill{ 
	name = "kurashinfurashu",
	events = {sgs.EventPhaseEnd},
	view_as_skill = kurashinfurashuVA,
	can_trigger = function(self, target)
		return target and target:hasSkill("kurashinfurashu")
	end,
	on_trigger=function(self,event,player,data)
		
		if player:getPhase() == sgs.Player_Finish and player:getMark("AddMaxHandCards") > 0 then
			local room = player:getRoom()
			room:setPlayerMark(player, "AddMaxHandCards", 0)
		end
		return false
	end,
}

--無阻
optimistic = sgs.CreateTriggerSkill{
name = "optimistic",
frequency = sgs.Skill_Compulsory,
events = {sgs.TurnedOver, sgs.ChainStateChanged},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.TurnedOver then
			local tlist = sgs.SPlayerList()
			if not player:faceUp() then
				room:broadcastSkillInvoke("optimistic", 2)
				player:drawCards(1, "optimistic")
				player:turnOver()
				for _,t in sgs.qlist(room:getOtherPlayers(player)) do
					tlist:append(t)
				end
				if tlist:isEmpty() then return false end
			end
		else
			if player:isChained() then
				room:broadcastSkillInvoke("optimistic", 1)
				player:setChained(false)
				room:broadcastProperty(player, "chained")
				room:setEmotion(player, "chain")
				room:getThread():trigger(sgs.ChainStateChanged, room, player)
				player:drawCards(1, "optimistic")
				local tlist = sgs.SPlayerList()
				for _,t in sgs.qlist(room:getOtherPlayers(player)) do
					tlist:append(t)
				end
				if tlist:isEmpty() then return false end
			end
		end
		return false
	end
} 

optimisticps = sgs.CreateProhibitSkill{ --公用技能(公廁)_免疫特定卡牌
	name = "#optimisticps",
	is_prohibited = function(self, from, to, card)
		return ((to:hasSkill("optimistic") or to:hasSkill("ys_qianjie")) and card:isKindOf("DelayedTrick")) 
		or (to:hasSkill("miyadokyo") and to:objectName() ~= from:objectName() and to:getMark("&liketoask") == 0 and card:isKindOf("TrickCard") 
		and not (card:isKindOf("AOE") or card:isKindOf("AmazingGrace") or card:isKindOf("GodSalvation") or card:isKindOf("DelayedTrick")))
		or (to:hasSkill("japenknifejile") and card:isKindOf("Weapon")) -- 鬼薙
	end
}

-- 這招可以抵擋所有使用卡片(包括對妳發動的技能卡，像強襲、反間)的效果(除了自己使用的之外)。群體效果卡的話，對妳無效
-- 關於技能卡，她僅能阻擋on_effect的發動，無法阻止on_use_備份
optimisticinvisible = sgs.CreateTriggerSkill{
	name = "#optimisticinvisible",
	events = {sgs.CardUsed, sgs.DamageInflicted},
	global = true,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.CardUsed then
			local handcard = false
			local use = data:toCardUse()
			handcard = data:toCardUse().m_isHandcard
			if use.card:isKindOf("SkillCard") or use.card:isKindOf("Peach") or use.card:isKindOf("AmazingGrace") or use.card:isKindOf("GodSalvation") or use.card:isKindOf("Dismantlement") or use.card:isKindOf("Snatch") or use.card:isKindOf("IronChain") or use.card:isKindOf("Zhujinqiyuan") then return false end
			-- if not handcard then return false end -- 強襲的效果是使用一張武器牌或流失體力對目標造成傷害，若對方選擇流失體力，這條程式碼必須去掉才能抵擋那次強襲
			for _,p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
				if p:isNude() then break end
				local length = p:getEquips():length() + p:getHandcardNum()
				-- if length > p:getHp() and (p:getHp() == 1 or (p:getMark("@SuperLimitBreak") > 0 and p:getHp() <= 2)) then
				if length > p:getHp() and p:getHp() == 1 then
					if not (room:getCurrent() and room:getCurrent():objectName() == p:objectName()) and use.to:contains(p) and not (p:objectName() == player:objectName()) then  --尽量用getCurrent，考虑到明鉴类技能
						if math.random(1,5) == 1 then
							room:broadcastSkillInvoke("optimistic", 1)
						end
						-- local use = data:toCardUse()
						local nullified_list = use.nullified_list
						table.insert(nullified_list, p:objectName())
						use.nullified_list = nullified_list
						data:setValue(use)
					end
				else
					break
				end
			end
			return false
		else
			local damage = data:toDamage()
			local length = damage.to:getEquips():length() + damage.to:getHandcardNum()
			-- if damage.damage > 0 and damage.to:hasSkill("optimistic") and length > damage.to:getHp() and (damage.to:getHp() == 1 or (damage.to:getMark("@SuperLimitBreak") > 0 and damage.to:getHp() <= 2)) then
			if (damage.damage > 0 and damage.to:hasSkill("optimistic") and length > damage.to:getHp() and damage.to:getHp() == 1) or
			(damage.damage > 1 and damage.to:hasSkill("optimistic") and damage.to:getMark("@SuperLimitBreak") > 0) then
				if math.random(1, 100) < 45 then room:broadcastSkillInvoke("optimistic", math.random(1, 2)) end
				-- room:sendCompulsoryTriggerLog(damage.to, "optimistic")
				local log = sgs.LogMessage()
				log.type = "#bloody_log"
				log.from = damage.to
				log.arg = tonumber(damage.damage)
				log.arg2 = "optimistic"
				room:sendLog(log)
				return true
			end
		end
	end
}

-- feedingpoisoningbf = sgs.CreateTriggerSkill{
	-- name = "feedingpoisoningbf" ,
	-- frequency = sgs.Skill_Compulsory ,
	-- events = {sgs.DamageCaused, sgs.EventPhaseStart} ,
	-- can_trigger = function(self, target) -- 讓每個目標都做一次觸發。假設有三個人在場而你有技能，而此際能觸發時會每個人都檢查一次，所以觸發三次
    	-- return target
	-- end,
	-- on_trigger = function(self, event, player, data)
		-- local room = player:getRoom()
		-- if event == sgs.DamageCaused then
			-- local damage = data:toDamage()
			-- if (player:distanceTo(damage.to) == 1) and damage.card and damage.by_user and (not damage.chain) and (not damage.transfer) and damage.from:hasSkill(self:objectName()) then
				-- if player:askForSkillInvoke(self:objectName(), data) then
					-- local x = damage.damage + damage.from:getLostHp()
					-- damage.to:gainMark("@poison", x)
					-- room:addPlayerMark(player, "@bossExp", 10)
					-- if player:isWounded() then
						-- local theRecover = sgs.RecoverStruct()
						-- theRecover.recover = 1
						-- theRecover.who = player
						-- room:recover(player ,theRecover)
					-- end
					-- return true
				-- end
			-- end
		-- end
		-- if (event == sgs.EventPhaseStart) and (player:getPhase() == sgs.Player_Finish) then
			-- if player:getMark("@poison") > 0 then
				-- room:loseHp(player, 1)
				-- player:loseMark("@poison")
			-- end
		-- end
		-- return false
	-- end
-- }
bffeedingpoisoning = sgs.CreateTriggerSkill{
	name = "bffeedingpoisoning" ,
	frequency = sgs.Skill_NotFrequent ,
	events = {sgs.DamageCaused, sgs.CardsMoveOneTime} ,
	-- can_trigger = function(self, target) -- 讓每個目標都做一次觸發。假設有三個人在場而你有技能，而此際能觸發時會每個人都檢查一次，所以觸發三次
    	-- return target -- 譬如"无言"技能，當他使用群體傷害錦囊，他必須每個人都做一次技能判定，因此這個選項要有。而"OLD潛襲"則是不需要，因為他只需判定你自己
	-- end,
	on_trigger = function(self, event, player, data)
		if event == sgs.DamageCaused then
			local damage = data:toDamage()
			if ((player:distanceTo(damage.to) == 1) or (damage.to:distanceTo(player) == 1)) and damage.by_user and (not damage.chain) and (not damage.transfer) then
				player:getRoom():setTag("bffeedingpoisoning", data)
				if player:askForSkillInvoke(self:objectName(), data) then
					local room = player:getRoom()
					local x = damage.damage
					damage.to:gainMark("@poison", x)
					damage.prevented = true
					data:setValue(damage)
					return true
				end
				player:getRoom():removeTag("bffeedingpoisoning", data)
			end
		end
		if event == sgs.CardsMoveOneTime then
			local room = player:getRoom()
			local move = data:toMoveOneTime()
			if move.from and move.from_places:contains(sgs.Player_PlaceHand) and move.from:getMark("@poison") > 0 then
				local i = 0
				for _, cid in sgs.qlist(move.card_ids) do
					i = i + 1
				end
				for _, p in sgs.qlist(room:getAllPlayers()) do
					if p:objectName() == move.from:objectName() then
						-- if player:isWounded() then
							-- local count = math.min(i, player:getLostHp())
							-- local theRecover = sgs.RecoverStruct()
							-- theRecover.recover = count
							-- theRecover.who = player
							-- room:recover(player ,theRecover)
						-- end
						if p:getMark("@poison") < i then i = p:getMark("@poison") end
						player:drawCards(i)
						p:loseMark("@poison", i)
						room:loseHp(p, i)
						i = 0
						break
					end
				end
			end
		end
		return false
	end
}

trapCard = sgs.CreateSkillCard{
	name = "trapva", 
	target_fixed = false,
	will_throw = false,
	filter = function(self, targets, to_select) 
		if #targets == 0 then
			local bifalist = to_select:getPile("trappile")
			if (bifalist:isEmpty()) or (bifalist:length() + self:getSubcards():length() <= 3) then
				return to_select:objectName() ~= sgs.Self:objectName()
			end
		end
		return false
	end,
	on_use = function(self, room, source, targets)
		local ids = self:getSubcards()
		local n = ids:length()
		local source = source:getRoom()
		room:broadcastSkillInvoke("trapva", 1)
		for _,id in sgs.qlist(ids) do
			targets[1]:addToPile("trappile", id, false)
		end
	end
}

trapva = sgs.CreateViewAsSkill{
	name = "trapva",
	n = 3,
	view_filter = function(self, selected, to_select)
		return not to_select:isKindOf("EquipCard")
	end, 
	view_as = function(self, cards)
		if #cards > 0 then
			local acard = trapCard:clone()
			for _,card in pairs(cards) do
				acard:addSubcard(card)
			end
			acard:setSkillName(self:objectName())
			return acard
		end
	end, 
	enabled_at_play = function(self, player)
		return true
	end, 
	enabled_at_response = function(self, player, pattern)
		return false
	end
}

trap = sgs.CreateTriggerSkill{
	name = "#trap",
	events = {sgs.CardUsed, sgs.JinkEffect, sgs.NullificationEffect}, 
	global = true,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.CardUsed) then
			local use = data:toCardUse()
			local card = use.card
			local handcard = use.m_isHandcard
			local user
			if card:isKindOf("Jink") or not (card and ((card:getTypeId() == sgs.Card_TypeBasic) or (card:getTypeId() == sgs.Card_TypeTrick)) and (card:getHandlingMethod() == sgs.Card_MethodUse)) then
				return false
			end
			if use.from:getPile("trappile"):isEmpty() then
				return false
			else
				user = use.from
				local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_REMOVE_FROM_PILE, nil, "trapva", nil)
				local id = user:getPile("trappile"):first()
				local pilef = sgs.Sanguosha:getCard(id)
				if pilef:getTypeId() == card:getTypeId() then
					room:throwCard(pilef, reason, nil)
				else
					return false
				end
			end
			local cardName = card:isKindOf("Slash") and "slash" or card:objectName()
			for _,mstar in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
				if not (mstar:objectName() == player:objectName()) then  --在自己的回合也能使用
					room:broadcastSkillInvoke("trapva", math.random(2, 3))
					local msg = sgs.LogMessage()
					msg.type, msg.from, msg.arg, msg.arg2 = "#trapEffect", mstar, cardName, "trapva"
					msg.to:append(player)
					room:sendLog(msg)
					
					if card:isKindOf("Nullification") then
						player:setFlags("trapNullifiedNullification")
						room:obtainCard(mstar, card)
					else
						local nullified_list = use.nullified_list
						table.insert(nullified_list, "_ALL_TARGETS")
						use.nullified_list = nullified_list
						data:setValue(use)
						if card:isKindOf("BasicCard") then
							mstar:drawCards(1)
						elseif handcard then
							room:obtainCard(mstar, card)
						else
							mstar:drawCards(1)
						end
						room:setTag("SkipGameRule",sgs.QVariant(true))
					end
				end
			end
		elseif (event == sgs.JinkEffect) then
			if not player:getPile("trappile"):isEmpty() then
				local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_REMOVE_FROM_PILE, nil, "trapva", nil)
				local id = player:getPile("trappile"):first()
				local jcard = sgs.Sanguosha:getCard(id)
				if not jcard:isKindOf("BasicCard") then
					return false
				else
					local card = data:toCard()
					room:throwCard(jcard, reason, nil)
					room:broadcastSkillInvoke("trapva", math.random(2, 3))
					local log = sgs.LogMessage()
					log.type = "#nolearn_log"
					log.from = player
					log.arg = "trapva"
					log.card_str = card:toString()
					room:sendLog(log)
					return true
				end
			else
				return false
			end
		elseif (event == sgs.NullificationEffect) and player:hasFlag("trapNullifiedNullification") then
			player:setFlags("-trapNullifiedNullification")
			return true
		end
		return false
	end
}

taichi = sgs.CreateTriggerSkill{
	name = "taichi",
	events = {sgs.TargetConfirmed},
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
		local use = data:toCardUse()
		if not (use.card:isKindOf("Slash") or use.card:isKindOf("TrickCard")) then return false end
		if not player:isAlive() then return false end
		-- for _,p in sgs.qlist(use.to) do @taichi
			-- local d = sgs.QVariant()
			-- d:setValue(p)
		if use.to:contains(player) then --  and use.from ~= player
			player:setFlags("taichiused")
			if player:getMark("@taichi") > 0 and (not player:isAllNude()) and room:askForSkillInvoke(player,self:objectName()) then 
				room:broadcastSkillInvoke("taichi", math.random(1, 2))
				if player:isNude() and player:canDiscard(player,"j") then 
					local card_id = room:askForCardChosen(player, player, "j", self:objectName())
					room:throwCard(card_id, player)
					player:loseMark("@taichi", 1)
					player:drawCards(2)
				elseif player:canDiscard(player,"j") and room:askForSkillInvoke(player,"taichi_disjugde") then
					local card_id = room:askForCardChosen(player, player, "j", self:objectName())
					room:throwCard(card_id, player)
					player:loseMark("@taichi", 1)
					player:drawCards(2)
				elseif player:canDiscard(player,"he") then
					room:askForDiscard(player,self:objectName(),1,1,false,true)
					player:loseMark("@taichi", 1)
					player:drawCards(2)
				end
			end
		end
		-- end
		return false
	end
}

taichirebirth = sgs.CreateTriggerSkill -- 死亡或更換回合時，將本技能的效果無效
{
	name = "#taichirebirth",
	events = {sgs.EventPhaseStart},
	can_trigger = function(self, target) -- 若打開這個，任何人用卡之前都可以發動
    	return target
	end,
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
		if (event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish) then
			for _,mstar in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
				if mstar:hasFlag("taichiused") then
					room:setPlayerFlag(mstar,"-taichiused")
					mstar:gainMark("@taichi", 1)
				end
			end
		end
		return false
	end,
}


sincerecard = sgs.CreateSkillCard
{
	name = "sincerecard",
	target_fixed = false,
	will_throw = true,
	filter = function(self,targets,to_select,player)
		return (#targets < 1) and (to_select:objectName() ~= sgs.Self:objectName())
	end,
	on_effect = function(self,effect)
		local from = effect.from
		local to = effect.to
		local room = from:getRoom()
		local skills = to:getVisibleSkillList()
		local yoursskill = from:getVisibleSkillList()
		local skill_list = {}
		local your_list = {}
		for _,skill in sgs.qlist(skills) do
			if not skill:inherits("SPConvertSkill") and not skill:isAttachedLordSkill() then
				table.insert(skill_list, skill:objectName())
			end
		end
		for _,ys in sgs.qlist(yoursskill) do
			if not ys:inherits("SPConvertSkill") and not ys:isAttachedLordSkill() then
				table.insert(your_list, ys:objectName())
			end
		end
		if from:isWounded() then
			-- local count = math.ceil(from:getLostHp()/2)
			from:drawCards(1)
			local theRecover = sgs.RecoverStruct()
			theRecover.recover = 1
			theRecover.who = from
			room:recover(from ,theRecover)
		else
			-- room:broadcastSkillInvoke("sincere", 2)
			from:drawCards(2)
		end
		if #skill_list == 0 then return false end
		local lose_sname = room:askForChoice(from, "sincere", table.concat(your_list, "+"))
		room:handleAcquireDetachSkills(from, "-"..lose_sname)
		local skill_name = room:askForChoice(from, "sincere", table.concat(skill_list, "+"))
		room:handleAcquireDetachSkills(to, "-"..skill_name)
		room:acquireSkill(from, skill_name)
		-- return true
	end,
	
	priority = -2
}

sincere = sgs.CreateViewAsSkill{
	name = "sincere",
	n=0,
	view_filter=function()
		return false
	end,
	view_as=function(self, cards)        
		return sincerecard:clone()
	end,
	enabled_at_play=function(self,player) 
		return (not player:hasUsed("#sincerecard"))
	end,
	enabled_at_response=function(self,player,pattern)
		return false
	end,
}

bhcard = sgs.CreateSkillCard
{
	name = "bhcard",
	target_fixed = false,
	will_throw = true,
	filter = function(self,targets,to_select,player)
		-- return (#targets < 1) and (to_select:objectName() ~= sgs.Self:objectName())
		return (#targets < 1)
	end,
	on_effect = function(self,effect)
		local from = effect.from
		local to = effect.to
		local room = from:getRoom()
		-- if not from:isLord() or not from:isRenegade() then
			if not to:isLord() then
				if from:hasSkill("bh") then
					if from:getMark("@burnheart") > 0 then
						local people = 0
						for _,p in sgs.qlist(room:getOtherPlayers(from))do
							if p:isAlive() then 
								people = people + 1
							end
						end
						if people < 3 then return false end
						-- room:setPlayerFlag(from, "FenxinTarget")
						local ai_data = sgs.QVariant()
						ai_data:setValue(to)
						-- if room:askForSkillInvoke(from, self:objectName(), ai_data) then
							from:loseMark("@burnheart")
							local role1 = room:askForChoice(from, "sincere", "loyalist+rebel+renegade")
							to:setRole(role1)
							room:setPlayerProperty(to, "role", sgs.QVariant(role1))
						-- end
						return false
					end
				end
			end
		-- end
		return false
	end,
}
bhVS = sgs.CreateViewAsSkill{
	name = "bh",
	n=0,
	view_filter=function()
		return false
	end,
	view_as=function(self, cards)        
		return bhcard:clone()
	end,
	enabled_at_play=function(self,player) 
		return player:getMark("@burnheart") ~= 0
	end,
	enabled_at_response=function(self,player,pattern)
		return false
	end,
}

bh = sgs.CreateTriggerSkill{
	name = "bh" ,
	frequency = sgs.Skill_Limited,
	limit_mark = "@burnheart",
	events = {},
	view_as_skill = bhVS,
	
	on_trigger = function()
		return false
	end
}

--王令

bh_xcard = sgs.CreateSkillCard
{
	name = "bh_x",
	target_fixed = false,
	will_throw = true,
	filter = function(self,targets,to_select,player)
		return (#targets < 1)
	end,
	on_effect = function(self,effect)
		local from = effect.from
		local to = effect.to
		local room = from:getRoom()
		local heros = {}
		local hero = {}
		if to:isLord() or room:askForChoice(from, self:objectName(), "show+changehero") == "changehero" then
			for _,name in ipairs(sgs.Sanguosha:getLimitedGeneralNames()) do
				table.insert(heros, name)
			end
			for _,p in sgs.qlist(room:getAllPlayers(true)) do
				if table.contains(heros, p:getGeneralName()) then
					table.removeOne(heros, p:getGeneralName())
				end
			end
			for i = 1, 6 do
				local first = heros[math.random(1, #heros)]
				table.insert(hero, first)
				table.removeOne(heros, first)
			end
			local general = room:askForGeneral(from, table.concat(hero, "+"))
			local log = sgs.LogMessage()
			log.type = "#bh_x_log"
			log.from = from
			log.to:append(to)	
			log.arg = general
			room:sendLog(log)
			room:changeHero(to, general, false, false)
			if to:isWounded() then
				local theRecover = sgs.RecoverStruct()
				theRecover.recover = to:getLostHp()
				theRecover.who = to
				room:recover(to, theRecover)	
			end
		else
			local n = to:getHandcardNum()
			room:killPlayer(to)
			room:revivePlayer(to)
			to:drawCards(n)
		end

		if room:askForChoice(from, self:objectName(), "continue+cancel") == "cancel" then
			room:setPlayerMark(from, "@lord", 0)
			room:detachSkillFromPlayer(from, "bh_x")
		end
		return false
	end,
}
bh_xVS = sgs.CreateViewAsSkill{
	name = "bh_x",
	n=0,
	view_filter=function()
		return false
	end,
	view_as=function(self, cards)        
		return bh_xcard:clone()
	end,
	enabled_at_play=function(self,player) 
		return player:getMark("@lord") ~= 0
	end,
	enabled_at_response=function(self,player,pattern)
		return false
	end,
}

bh_x = sgs.CreateTriggerSkill{
	name = "bh_x" ,
	frequency = sgs.Skill_Limited,
	limit_mark = "@lord",
	events = {},
	view_as_skill = bh_xVS,
	
	on_trigger = function()
		return false
	end
}

--坦肚 階段技，你可以宣言一種花色然後展示所有手牌，之後你棄置該所有花色的牌並棄置一名目標X張牌或令其摸X張牌，你獲得X個某標記。
franklyCard = sgs.CreateSkillCard
{
	name = "franklyCard",
	once = true,
	will_throw = true,
	filter = function(self,targets,to_select,player)
		return (#targets < 1)
	end,
	on_effect=function(self,effect)
		local from = effect.from
		local to = effect.to
		local room = from:getRoom()	
		local cards = from:getHandcards()
		local a = 0
		room:showAllCards(from)
		local suit = room:askForSuit(from, "frankly")
		for _,dis in sgs.qlist(cards) do
			if dis:getSuit() == suit then
				room:throwCard(dis, from, from)
				a=a+1
			end
		end
		if a>0 then
			from:gainMark("@defensive_distance_test", a)
			room:addPlayerMark(from, "&frankly-Clear", a)
			if room:askForChoice(from, "frankly", "draw+discard", ToData(to)) == "draw" then
				to:drawCards(a)
			else
				for i=1, a, 1 do
					if from:canDiscard(to, "jhe") then
						local id = room:askForCardChosen(from, to, "jhe", "frankly", false, sgs.Card_MethodDiscard)
						room:throwCard(id, to, from)
					end
				end
			end
		end
		return false
	end,
}

frankly = sgs.CreateViewAsSkill{
	name = "frankly",
	n=0,
	view_filter=function()
		return false
	end,
	view_as=function(self, cards)        
		return franklyCard:clone()
	end,
	enabled_at_play=function(self,player) 
		return (not player:hasUsed("#franklyCard"))
	end,
	enabled_at_response=function(self,player,pattern)
		return false
	end,
}

--[[
--n_shefuCancel2是一個技能，能夠在你使用卡片時，增加一位受害者同時減少一位受害者。備用
n_shefuCancel2 = sgs.CreateTriggerSkill{
name = "n_shefuCancel2",
events = {sgs.PreCardUsed},
	-- can_trigger = function(self, target) -- 若打開這個，別人用卡你也可以控制受害者及非受害者。
    	-- return target
	-- end,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local use = data:toCardUse()
		local user = room:findPlayerBySkillName(self:objectName())
		if not use.card or use.card:isKindOf("SkillCard") then return false end
		if room:askForSkillInvoke(user, self:objectName(), data) then
			local removed = room:askForPlayerChosen(user, room:getAlivePlayers(), "qiaoshui:remove", "@qiaoshui-remove:::" .. use.card:objectName())
			use.to:removeOne(removed)
			local extra = room:askForPlayerChosen(user, room:getAlivePlayers(), "qiaoshui:add", "@qiaoshui-add:::" .. use.card:objectName())
			use.to:append(extra)
			data:setValue(use)
		end
	end
}
]]
--與共：你的殺、桃或非延時錦囊牌(借刀殺人、無懈可擊除外)可以額外指定至多X名目標，同時減少至多X名目標。X為某標記數量。回合結束時你失去所有某標記。
flexibleCard = sgs.CreateSkillCard{
	name = "flexible", 
	filter = function(self, targets, to_select)
		if sgs.Self:getMark("@defensive_distance_test") > sgs.Self:getMark("fake_flexible") then
			return #targets < sgs.Self:getMark("@defensive_distance_test")
		elseif sgs.Self:getMark("@defensive_distance_test") < sgs.Self:getMark("fake_flexible") then
			return #targets < sgs.Self:getMark("fake_flexible")
		else
			return #targets < sgs.Self:getMark("@defensive_distance_test")
		end
		-- return #targets < sgs.Self:getMark("@luanz") and to_select:getMark(self:objectName()) == 0
	end, 
	on_effect = function(self, effect)
		local from = effect.from
		local to = effect.to
		local room = from:getRoom()	
		-- room:addPlayerMark(effect.to, self:objectName())
		if from:getMark("friendlyTime") > 0 then
			room:removePlayerMark(to, self:objectName())
			room:addPlayerMark(to, "friendly")
		else
			room:removePlayerMark(to, "friendly")
			room:addPlayerMark(to, self:objectName())
		end
	end
}
flexibleVS = sgs.CreateZeroCardViewAsSkill{
	name = "flexible", 
	response_pattern = "@@flexible", 
	view_as = function()
		return flexibleCard:clone()
	end
}
flexible = sgs.CreateTriggerSkill{
	name = "flexible", 
	events = {sgs.PreCardUsed, sgs.EventPhaseStart}, 
	view_as_skill = flexibleVS, 
	on_trigger = function(self, event, player, data, room)
		if event == sgs.PreCardUsed then
			local use = data:toCardUse()
			if use.from:objectName() == player:objectName() and player:getMark("@defensive_distance_test") > 0 and (use.card:isKindOf("Slash") or use.card:isKindOf("Peach") or (use.card:isNDTrick() and not use.card:isKindOf("Collateral") and not use.card:isKindOf("Nullification"))) then
				-- for _, p in sgs.qlist(use.to) do
					-- room:addPlayerMark(p, self:objectName())
				-- end
				room:setTag("flexible", data)
				room:askForUseCard(player, "@@flexible", "@flexiblelog")
				room:addPlayerMark(player, "friendlyTime")
				room:askForUseCard(player, "@@flexible", "@flexiblelog2")
				room:removeTag("flexible")
				for _, p in sgs.qlist(room:getAllPlayers()) do
					if p:getMark(self:objectName()) > 0 and not room:isProhibited(player, p, use.card) then
						room:removePlayerMark(p, self:objectName())
						use.to:append(p)
					elseif p:getMark("friendly") > 0 and not room:isProhibited(player, p, use.card) then
						room:removePlayerMark(p, "friendly")
						use.to:removeOne(p)
					end
				end
				room:removePlayerMark(player, "friendlyTime")
				room:sortByActionOrder(use.to)
				data:setValue(use)
			end
		end
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish and player:getMark("@defensive_distance_test") ~= 0 then
			if player:getHandcardNum() < player:getMark("@defensive_distance_test") then
				local n = player:getMark("@defensive_distance_test") - player:getHandcardNum()
				player:drawCards(n, self:objectName())
			end
			player:loseAllMarks("@defensive_distance_test")
		end
	end, 
	can_trigger = function(self, target)
		return target and target:hasSkill(self:objectName()) and target:isAlive() and target:getMark("@defensive_distance_test") ~= 0
	end
}

--[[
	技能名：狐性
	相关武将：紺
	描述：鎖定技。當你的判定牌為黑色牌時，你重新做一次判定並獲得那張牌。當你成為黑色牌的目標時，你立刻獲得該牌(但不取消指定)，當你成為紅色牌目標時，做一次判定。
	引用：LuaNosZhenlie
	状态：1217验证通过
]]--
foxnature = sgs.CreateTriggerSkill{
	name = "foxnature" ,
	events = {sgs.AskForRetrial} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local judge = data:toJudge()
		if judge.who:objectName() ~= player:objectName() then return false end
		local jcard
		room:broadcastSkillInvoke("foxnature", math.random(2, 3))
		while true do
			jcard = judge.card
			if jcard:isBlack() then
				local card_id = room:drawCard()
				local card = sgs.Sanguosha:getCard(card_id)
				room:getThread():delay()
				room:retrial(card, player, judge, self:objectName())
				player:obtainCard(jcard)
			else
				break
			end
		end
		return false
	end
}

foxnatureobtain = sgs.CreateTriggerSkill{
	name = "#foxnatureobtain" ,
	events = {sgs.CardEffected, sgs.TargetConfirmed},
	frequency = sgs.Skill_Compulsory,
	on_trigger = function(self, event, player, data, room)
		if event == sgs.CardEffected then
			local effect = data:toCardEffect()
			if effect.card:isKindOf("DelayedTrick") then return false end
			if effect.card:isKindOf("SkillCard") then return false end
			if effect.card and effect.card:isRed() and effect.to:hasSkill(self:objectName()) and effect.from:objectName() ~= player:objectName() then
				local judge = sgs.JudgeStruct()
				judge.pattern = ".|heart"
				judge.good = true
				judge.reason = "foxnature"
				judge.who = effect.to
				judge.play_animation = true
				room:judge(judge)
				if judge:isGood() then
					local jcard = judge.card
					effect.to:obtainCard(jcard)
				end
			end
			if effect.card and effect.card:isBlack() and effect.to:hasSkill(self:objectName()) and effect.from:objectName() ~= player:objectName() then
				-- room:setPlayerCardLimitation(effect.to, "use,response", "Jink", false)
				room:broadcastSkillInvoke("foxnature", 1)
				room:obtainCard(effect.to, effect.card)
			end
		else
			if player and player:isAlive() and player:hasSkill(self:objectName()) then
				local room = player:getRoom()
				local use = data:toCardUse()
				local card = use.card 
				if not use.card:isKindOf("DelayedTrick") then return false end
				if use.card:isKindOf("SkillCard") then return false end
				if use.to:contains(player) and (use.from:objectName() ~= player:objectName()) then
					if use.card:isBlack() then -- 增加判斷SKILLCARD，依然可以拿亂擊牌(因為那是轉化)，而技能卡拿不了(強襲棄置的黑色武器牌)
						player:setFlags("-foxnatureobtainTarget")
						player:setFlags("foxnatureobtainTarget")
						if player:hasFlag("foxnatureobtainTarget") then -- 搶走其使用牌
							room:broadcastSkillInvoke("foxnature", 1)				
							room:obtainCard(player, card)
						end
					end
					-- player:gainMark("@book")
					if card:isRed() then -- 增加判斷SKILLCARD，依然可以拿亂擊牌(因為那是轉化)，而技能卡拿不了(強襲棄置的黑色武器牌)
						local judge = sgs.JudgeStruct()
						judge.pattern = ".|heart"
						judge.good = true
						judge.reason = "foxnature"
						judge.who = player
						judge.play_animation = true
						room:judge(judge)
						if judge:isGood() then
							local jcard = judge.card
							player:obtainCard(jcard)
						end
					end
				end
			end
		end
		return false
	end, 
	can_trigger = function(self, target)
		return target and target:hasSkill(self:objectName())
	end
}
--底下的寫法會導致視為技的效果失效(譬如高順禁酒，打出酒視為殺，目標為你時你收走酒，殺沒有生效，反而是你喝了酒)
-- foxnatureobtain = sgs.CreateTriggerSkill{
	-- name = "#foxnatureobtain" ,
	-- events = {sgs.TargetConfirmed} ,
	-- on_trigger = function(self, event, player, data)
		-- local room = player:getRoom()
		-- if event == sgs.TargetConfirmed then
			-- if player and player:isAlive() and player:hasSkill(self:objectName()) then
				-- local use = data:toCardUse()
				-- local card = use.card 
				-- if use.to:contains(player) and (use.from:objectName() ~= player:objectName()) then
					-- if use.card:isBlack() and not use.card:isKindOf("SkillCard") then -- 增加判斷SKILLCARD，依然可以拿亂擊牌(因為那是轉化)，而技能卡拿不了(強襲棄置的黑色武器牌)
							-- player:setFlags("-foxnatureobtainTarget")
							-- player:setFlags("foxnatureobtainTarget")
							-- if player:hasFlag("foxnatureobtainTarget") then -- 搶走其使用牌
								-- room:broadcastSkillInvoke("foxnature", 1)
								-- room:moveCardTo(card, player, sgs.Player_PlaceHand, true)	
								-- room:setTag("SkipGameRule",sgs.QVariant(true))
								--↑避免某些技能直接把黑色裝備丟到你身上，而導致裝備穿上卻在手牌，使用該牌也不會消失的BUG(這意味著，可以靠榮智加這BUG牌，用一張牌打出五張萬箭)但如此會取消目標。					
								-- room:obtainCard(player, card)
							-- end
					-- end
				-- end
			-- end
		-- end
		-- return false
	-- end ,
	-- can_trigger = function(self, target)
		-- return target
	-- end
-- }

--榮智

clevercard = sgs.CreateSkillCard
{
	name = "clever",	
	target_fixed = true,	
	will_throw = false,
on_use = function(self, room, source, targets)
        local room = source:getRoom()
		local count = source:getLostHp() + 2
		source:gainMark("@cleverkon", count)
	for _,card in sgs.qlist(self:getSubcards()) do
		-- local cardname = card:objectName()
		-- source:addMark(cardname)
		source:addToPile("clevercards", card, true)
    end		
end,
}

clevervs=sgs.CreateViewAsSkill{
name="clever",
n=1,
response_or_use = true,
	view_filter=function(self, selected, to_select)
		if sgs.Self:getPile("clevercards"):length() > 0 then
			local cardid = sgs.Self:getPile("clevercards"):first()
			local cardname = sgs.Sanguosha:getCard(cardid):objectName()
			if (#selected >= 1) or to_select:hasFlag("using") then return false end
			if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
				if sgs.Self:isWounded() and cardname == "peach" then
					return not to_select:isEquipped()
				elseif sgs.Slash_IsAvailable(sgs.Self) and (cardname =="slash" or cardname =="thunder_slash" or cardname =="fire_slash") then
					if sgs.Self:getWeapon() and (to_select:getEffectiveId() == sgs.Self:getWeapon():getId())
							and to_select:isKindOf("Crossbow") then
						return sgs.Self:canSlashWithoutCrossbow()
					else
						return not to_select:isEquipped()
					end
				end
			elseif (sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE)
					or (sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE) then
				local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
				if pattern == "jink" and cardname == "jink" then
					return not to_select:isEquipped()
				elseif pattern == "nullification" and cardname == "nullification" then
					return not to_select:isEquipped()
				elseif string.find(pattern, "peach") and cardname == "peach" then
					return not to_select:isEquipped()
				elseif pattern == "slash" and  (cardname == "slash" or cardname == "thunder_slash" > 0 or cardname == "fire_slash" > 0) then
					return not to_select:isEquipped()
				end
			end
			-- if cardname == "indulgence" or cardname == "snatch" or cardname == "savage_assault" or cardname == "archery_attack" or cardname == "dismantlement"
			-- or cardname == "fire_attack" or cardname == "collateral" or cardname == "duel" or cardname == "supply_shortage" or cardname == "god_salvation" or cardname == "lightning" then
			local realcard = sgs.Sanguosha:getCard(cardid)
			if realcard:isKindOf("TrickCard") then
				return not to_select:isEquipped()
			else
				return false
			end
		else
			return #selected < 1 and not (to_select:isKindOf("EquipCard") or to_select:isKindOf("Analeptic") or to_select:isKindOf("IronChain") or to_select:isKindOf("ExNihilo") or to_select:isKindOf("AmazingGrace") or to_select:isKindOf("Dongzhuxianji"))
		end
	end,
	view_as = function(self, cards)		
		if #cards>0 then
			if sgs.Self:getPile("clevercards"):length() > 0 then
				-- sgs.Self:loseMark("@cleverkon", 1)
				local card = cards[1]
				local new_card = nil
				local cardid = sgs.Self:getPile("clevercards"):first()
				local cardname = sgs.Sanguosha:getCard(cardid):objectName()
				if cardname == "indulgence" then
					new_card = sgs.Sanguosha:cloneCard("Indulgence", sgs.Card_SuitToBeDecided, 0)
				else
					new_card = sgs.Sanguosha:cloneCard(cardname, sgs.Card_SuitToBeDecided, 0)
				end
				if new_card then
					-- room:removePlayerMark(sgs.Self,"@cleverkon",1)
					new_card:setSkillName("clever")
					for _, c in ipairs(cards) do
						new_card:addSubcard(c)
					end
				end
				return new_card
			else
				-- local cardname = cards[1]:objectName()
				-- local count = sgs.Self:getLostHp() + 1
				-- sgs.Self:addMark(cardname)
				-- sgs.Self:addMark("@cleverkon", count)
				acard=clevercard:clone()
				acard:addSubcard(cards[1])
				acard:setSkillName("clever")
				return acard
			end
		end
	end,
	enabled_at_play = function(self, player)
		return player:getMark("@cleverkon") > 0
	end,
	enabled_at_response = function(self, player, pattern)
		if player:getPile("clevercards"):isEmpty() then return false end
		local cardid = player:getPile("clevercards"):first()
		local cardname = sgs.Sanguosha:getCard(cardid):objectName()
		return player:getMark("@cleverkon") > 0
				and (((pattern == "slash") and (cardname == "slash" or cardname == "fire_slash" or cardname == "thunder_slash"))
				or ((pattern == "jink") and cardname == "jink")
				or (string.find(pattern, "peach") and cardname == "peach" and (not player:hasFlag("Global_PreventPeach")))
				or ((pattern == "nullification") and cardname == "nullification"))
	end ,
	enabled_at_nullification = function(self, player)
		if player:getPile("clevercards"):isEmpty() then return false end
		local cardid = player:getPile("clevercards"):first()
		local cardname = sgs.Sanguosha:getCard(cardid):objectName()
		return cardname == "nullification" and player:getMark("@cleverkon") > 0 and not player:isKongcheng()
	end
}
			
clever = sgs.CreateTriggerSkill{
	name = "clever",
	events = {sgs.EventPhaseStart, sgs.CardUsed, sgs.PreCardResponded, sgs.EventLoseSkill},
	view_as_skill = clevervs,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.CardUsed) or (event == sgs.PreCardResponded) then
			local card = nil
			if event == sgs.CardUsed then
				card = data:toCardUse().card
			else
				local response = data:toCardResponse()
				card = response.m_card
			end
			if card and card:getSkillName() == "clever" then
				player:loseMark("@cleverkon")
			end
		end
		if event == sgs.EventPhaseStart then
			if not player:hasSkill("clever") then return false end
			local invoke = false
			if (event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_RoundStart) then
				invoke = true
			end
			if not invoke then return false end
			room:setPlayerMark(player, "@cleverkon", 1)
			player:clearOnePrivatePile("clevercards")
		end
		if event == sgs.EventLoseSkill and data:toString() == "clever" then
			player:clearOnePrivatePile("clevercards")
		end
		return false

	end
}


lovesweet = sgs.CreateTriggerSkill{
	name = "lovesweet" ,
    events = {sgs.CardUsed} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.CardUsed then
			local use = data:toCardUse()
			if not use.from or not use.card or not use.card:isKindOf("Peach") or use.card:getTypeId() == 0 then return false end
			for _,source in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
				if source:hasSkill("Subetewonomikonmu") or source:hasSkill("Kuitsukusu") then
					if source:getMark("@wrath") == 0 then
						room:detachSkillFromPlayer(source, "Subetewonomikonmu")
						room:detachSkillFromPlayer(source, "Kuitsukusu")
					else
						room:moveCardTo(use.card, source, sgs.Player_PlaceHand, true)
						source:loseMark("@wrath")
						if source:getMark("@wrath") == 0 then
							room:detachSkillFromPlayer(source, "Subetewonomikonmu")
							room:detachSkillFromPlayer(source, "Kuitsukusu")
						end
					end
				else
					local count = source:getLostHp() + 1
					source:gainMark("@wrath", count)
					if source:getMark("@wrath") > 5 then
						room:broadcastSkillInvoke("lovesweet", math.random(1, 2))
						room:acquireSkill(source, "Subetewonomikonmu")
						room:acquireSkill(source, "Kuitsukusu")
					end
				end
			end
		end
		return false
	end,
	can_trigger = function(self, target)
		return target and not target:hasSkill(self:objectName())
	end
}
magicat = sgs.CreateTriggerSkill{
	name = "magicat",
	events = {sgs.EventPhaseStart},
	can_trigger = function(self, player)
		return player:isAlive()
	end,
	on_trigger = function(self, event, player, data)
		if player:getPhase() == sgs.Player_Finish then
			local room = player:getRoom()
			for _,owner in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
				if owner and owner:objectName()~=player:objectName() and owner:canSlash(player, false) then
					if not owner:faceUp() and room:askForSkillInvoke(owner, self:objectName()) then
						room:broadcastSkillInvoke("magicat", math.random(1, 2))
						owner:turnOver()
						if not player:isNude() then
							local id = room:askForCardChosen(owner, player, "he", "magicat", false, sgs.Card_MethodNone)
							room:obtainCard(owner, id)
						end
						room:loseHp(player)
						if owner:isWounded() then
							local theRecover = sgs.RecoverStruct()
							theRecover.recover = 1
							theRecover.who = owner
							room:recover(owner ,theRecover)
						end
					elseif owner:faceUp() and (not owner:isNude()) and room:askForCard(owner, "..", "@magicat") then
						if owner:canDiscard(player, "he") and room:askForChoice(owner, "magicat", "draw+discard", ToData(player)) == "discard" then
							room:broadcastSkillInvoke("magicat", math.random(3, 4))
							local id = room:askForCardChosen(owner, player, "he", "magicat", false, sgs.Card_MethodDiscard)
							room:throwCard(id, player, owner)
						else
							room:broadcastSkillInvoke("magicat", math.random(5, 6))
							player:drawCards(2)
						end
					end
				end
			end
		end
		return false
	end,
}
-- jiahuo = sgs.CreateTriggerSkill{
-- name = "jiahuo",
-- frequency = sgs.Skill_Compulsory,
-- events = {sgs.AskForPeachesDone},
-- on_trigger = function(self, event, player, data)
-- local room = player:getRoom()
-- local dying = data:toDying()
-- local damage = dying.damage
-- if not damage then
-- damage = sgs.DamageStruct()
-- damage.to = player
-- end
-- damage.from = room:askForPlayerChosen(player, room:getAlivePlayers(), self:objectName())
-- dying.damage = damage
-- data:setValue(dying)
-- return false
-- end,
-- can_trigger = function(self, target)
-- if target then
-- return target:hasSkill(self:objectName())
-- end
-- return false
-- end,
-- priority = 4,
-- }--指定目標為兇手(備份)
--[[ 大吉的cpp
class Daji : public TriggerSkill
{
public:
    Daji() :TriggerSkill("daji")
    {
        events << Damaged << EventPhaseStart << TargetConfirmed << DamageInflicted;
        frequency = Compulsory;
    }

    bool triggerable(const ServerPlayer *target) const
    {
        return target != NULL;
    }

    bool trigger(TriggerEvent triggerEvent, Room* room, ServerPlayer *player, QVariant &data) const
    {
        QList<ServerPlayer *> players = room->getAlivePlayers();
        bool has_frantic = player->getMark("@frantic") > 0;

        if (TriggerSkill::triggerable(player) && triggerEvent == EventPhaseStart && player->getPhase() == Player::Finish) {
            room->broadcastSkillInvoke(objectName());
            if (has_frantic)
                player->drawCards(players.length());
            else
                player->drawCards(player->getMaxHp());
        }

        if (has_frantic) {
            if (TriggerSkill::triggerable(player) && player->isWounded() && triggerEvent == TargetConfirmed) {
                CardUseStruct use = data.value<CardUseStruct>();
                if (use.to.length() == 1 && player == use.to.first()) {
                    room->broadcastSkillInvoke(objectName());
                    use.nullified_list << player->objectName();
                    data = QVariant::fromValue(use);
                }
            }
        }

        if (TriggerSkill::triggerable(player) && triggerEvent == DamageInflicted) {
            DamageStruct damage = data.value<DamageStruct>();
            if (damage.damage > 1) {
                room->broadcastSkillInvoke(objectName());
                damage.damage = damage.damage - 1;
                data = QVariant::fromValue(damage);

                LogMessage log;
                log.type = "#TriggerSkill";
                log.from = player;
                log.arg = objectName();
                room->sendLog(log);
                return false;
            }
        }
        return false;
    }
};
]]
reedshipvs = sgs.CreateOneCardViewAsSkill{
	name = "reedship",
	-- filter_pattern = ".|black|.|hand",
	filter_pattern = ".|black|.",
	response_pattern = "@@reedship",
	response_or_use = true,
	view_as = function(self, card)
		local acard = sgs.Sanguosha:cloneCard("slash", card:getSuit(), card:getNumber())
		acard:addSubcard(card)
		acard:setSkillName(self:objectName())
		return acard
    end
}

reedship = sgs.CreateTriggerSkill{
	name = "reedship",
	-- events = {sgs.TargetConfirming, sgs.PreCardUsed},
	events = {sgs.TargetConfirming, sgs.CardUsed},
	view_as_skill = reedshipvs,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local use = data:toCardUse()
		if event == sgs.TargetConfirming then
			local hasblack = false
			if use.from:objectName() == player:objectName() then return false end 
			if not player:isNude() then
				local acn = player:getCards("he")
				for _,card in sgs.qlist(acn) do
					if card:isBlack() then
						hasblack = true
						break
					end
				end
			else
				return false
			end
			if hasblack and use.card and (use.card:isNDTrick() or (use.card:isRed() and use.card:isKindOf("Slash"))) and use.to:contains(player)
				and room:askForSkillInvoke(player, self:objectName(), data) then
				if room:askForUseCard(player, "@@reedship", "@reedship") then
					use.to = sgs.SPlayerList()
					data:setValue(use)
				end
			end
		else
			local use = data:toCardUse()
			if use.card and use.card:isKindOf("Slash") and use.card:isBlack() then
				local list = room:getAlivePlayers()
				local guys = sgs.SPlayerList()
				for _,t in sgs.qlist(list) do
					guys:append(t)
				end
				local target = room:askForPlayerChosen(player, guys, "reedship", "liketoask_choiceplayer")
				target:drawCards(1)
			end
		end
	end
}

phantomcard = sgs.CreateSkillCard
{
	name = "phantom",
	target_fixed = false,
	-- once = false,
	will_throw = true,
	filter = function(self,targets,to_select,player)
		return (#targets < 1) and (to_select:getMark("@meiying") > 0) and (to_select:objectName() ~= sgs.Self:objectName())
	end,
	on_effect = function(self,effect)
		local from = effect.from
		local to = effect.to
		local room = from:getRoom()
		local count = to:getMark("@meiying")
		local acard = room:askForCard(to, ".|diamond|.", "@phantomask", sgs.QVariant(), sgs.Card_MethodDiscard,
                effect.from,
                false, self:objectName(), true)
		if to and not acard then
			-- to:gainMark("@skill_invalidity", 1)
			room:setPlayerMark(to, "@skill_invalidity", 1)
			if from:getMark("@waked") > 0 then
				room:damage(sgs.DamageStruct("phantomDamage", from, to, count, sgs.DamageStruct_Normal))
			else
				room:damage(sgs.DamageStruct("phantomDamage", from, to, 1, sgs.DamageStruct_Normal))
			end
			to:loseMark("@meiying", count)
			-- if count > 1 then
				-- if from:isWounded() then 
					-- local theRecover = sgs.RecoverStruct()
					-- theRecover.recover = 1
					-- theRecover.who = from
					-- room:recover(from, theRecover)
				-- else
					-- from:drawCards(1)
				-- end
			-- end
			from:gainMark("@meiying",count)
		-- else
			-- from:drawCards(count)
		elseif acard and from:getMark("@SuperLimitBreak") > 0 then
			from:drawCards(count)
		end
		return false
	end,
}

phantomvs = sgs.CreateViewAsSkill{
	name = "phantom",
	n=0,
	view_filter=function()
		return false
	end,
	view_as=function(self, cards)        
		return phantomcard:clone()
	end,
	enabled_at_play=function(self,player) 
		return (not player:hasUsed("#phantom"))
	end,
	enabled_at_response=function(self,player,pattern)
		return false
	end,
}
phantom = sgs.CreateTriggerSkill{
	name = "phantom" ,
	-- events = {sgs.GameStart, sgs.DamageInflicted, sgs.EventPhaseStart},
	events = {sgs.GameStart, sgs.TargetConfirming, sgs.EventPhaseStart},
	view_as_skill = phantomvs,
	on_trigger = function(self, event, player, data)
		if event == sgs.GameStart then
			local room = player:getRoom()
			local others = room:getOtherPlayers(player)
			for _,p in sgs.qlist(others) do
				p:gainMark("@meiying", 1)			
			end
		end
		if event == sgs.TargetConfirming then
			-- local damage = data:toDamage()
			-- if not damage.from then return false end
			-- damage.from:gainMark("@meiying", damage.damage)
			local room = player:getRoom()
			local use = data:toCardUse()
			if use.from and not use.card:isKindOf("SkillCard") and use.to:contains(player) and use.from:getMark("@meiying") < 2 and use.from:objectName() ~= player:objectName() then
				use.from:gainMark("@meiying", 1)
			end
		end
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish and player:hasSkill("phantom") then
			local room = player:getRoom()
			for _,p in sgs.qlist(room:getOtherPlayers(player)) do
				room:setPlayerMark(p, "@skill_invalidity", 0)
			end
		end
		return false
	end
}
inheritedthefather = sgs.CreateTriggerSkill{
	name = "inheritedthefather",
	events = {sgs.EventPhaseStart},
	frequency = sgs.Skill_Wake,
	waked_skills = "longdan",
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.EventPhaseStart then
			room:setPlayerMark(player, "inheritedthefather", 1)
			room:changeMaxHpForAwakenSkill(player, 0, self:objectName())
			room:setPlayerMark(player, self:objectName(), 1)
			player:gainMark("@meiying", 2)
			room:drawCards(player, math.max(player:getLostHp(), 1))
			-- if room:changeMaxHpForAwakenSkill(player) and player:getMark("inheritedthefather") == 1 then
			-- if player:getMark("inheritedthefather") == 1 then
				room:broadcastSkillInvoke("inheritedthefather", math.random(1, 2))
				-- room:doSuperLightbox("jzhaoxiang","inheritedthefather") --新版不支援
				room:acquireSkill(player, "longdan")
				if player:isWounded() then
					local recover = sgs.RecoverStruct()
					recover.who = player
					recover.recover = 1
					room:recover(player, recover)
				end
				-- room:acquireSkill(player, "chongzhen")
				-- room:setPlayerMark(player, "@meiying", 0)
			-- end
		end
		return false
	end ,
	can_trigger = function(self, target)
		return target and target:hasSkill("inheritedthefather")
				and target:isAlive()
				and target:getMark(self:objectName()) == 0
				and target:getPhase() == sgs.Player_Finish
				and (target:getMark("@meiying") >= 3 or target:canWake(self:objectName()))
	end
}

ihtf_effect = sgs.CreateTriggerSkill{
	name = "#ihtf_effect",
	events = {sgs.CardUsed, sgs.PreCardResponded},
	
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.CardUsed) or (event == sgs.PreCardResponded) then
			local card = nil
			if event == sgs.CardUsed then
				card = data:toCardUse().card
			else
				local response = data:toCardResponse()
				card = response.m_card
			end
			if card and string.find(card:getSkillName(), "longdan") then
				player:drawCards(1)
				player:loseMark("@meiying")
			end
		end
		return false
	end ,
	can_trigger = function(self, target)
		return target and target:hasSkill("inheritedthefather")
				and target:isAlive()
				and target:getMark("@meiying") > 0
				and target:getMark("inheritedthefather") > 0
	end
}
-- hotfightlm = sgs.CreateTriggerSkill{
	-- name = "#hotfightlm",
	-- events = {sgs.CardUsed, sgs.JinkEffect, sgs.PreCardResponded, sgs.SlashMissed},
	-- on_trigger = function(self, event, player, data)
		-- local room = player:getRoom()
		-- if (event == sgs.CardUsed) or (event == sgs.PreCardResponded) then
			-- local card = nil
			-- if event == sgs.CardUsed then
				-- card = data:toCardUse().card
			-- else
				-- local response = data:toCardResponse()
				-- card = response.m_card
			-- end
			-- if card and not card:isKindOf("SkillCard") and card:getSkillName() == "hotfight" then
				-- player:setFlags("-hotfightJink")
				-- player:setFlags("hotfightJink")
				-- player:loseMark("@hotfightmark")
			-- end
			-- if player:getMark("@hotfightmark") < 5 and card and (card:isKindOf("Slash") or card:isKindOf("Jink")) and not card:isKindOf("SkillCard") and card:getSkillName() ~= "hotfight" then
				-- player:setFlags("-hotfightJink")
				-- player:setFlags("hotfightJink")
				-- player:gainMark("@hotfightmark")
			-- end
		-- end
		-- if event == sgs.JinkEffect then
			-- local card = data:toCard()
			-- if card and not card:isKindOf("SkillCard") and card:getSkillName() == "hotfight" and not player:hasFlag("hotfightJink") then
				-- player:loseMark("@hotfightmark")
			-- elseif player:getMark("@hotfightmark") < 5 and not player:hasFlag("hotfightJink") then
				-- player:gainMark("@hotfightmark")
			-- end
			-- player:hasFlag("-hotfightJink")
		-- end
		-- if event == sgs.SlashMissed then
			-- local effect = data:toSlashEffect()
			-- if player:getMark("@hotfightmark") < 5 and effect.slash:getSkillName() ~= "hotfight" then
				-- player:gainMark("@hotfightmark")

			-- end
		-- end
		-- return false
	-- end
-- }
--惜卡：鎖定技。每次妳使用或打出一張牌便進行一次判定，若判定牌色與使用牌色相同，妳回收判定牌。
cardcollecter = sgs.CreateTriggerSkill{
	name = "cardcollecter",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.CardUsed, sgs.CardResponded, sgs.FinishJudge},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.FinishJudge then
			local judge = data:toJudge()
			if judge.reason == self:objectName() then
				local card = judge.card
				if card:isBlack() and player:hasFlag("Gbc") then
					player:obtainCard(card)
					player:setFlags("-Gbc")
					return true
				end
				if card:isRed() and player:hasFlag("Grc") then
					player:obtainCard(card)
					player:setFlags("-Grc")
					return true
				end
			end
		else
			local card
			local color = ""
			if event == sgs.CardUsed then
				local cu = data:toCardUse()
				card = cu.card
				if not card then return end
				if card:isKindOf("Jink") and player:hasFlag("CCrj") then player:setFlags("-CCrj") return end
			end
			if event == sgs.CardResponded then
				local response = data:toCardResponse()
				card = response.m_card
				if card:isKindOf("Jink") then player:setFlags("CCrj") end
				if not card then return end
			end
			if card:getSuit() == sgs.Card_NoSuit or not card:isKindOf("BasicCard") then return end
			room:broadcastSkillInvoke("cardcollecter", math.random(1, 2))
			player:setFlags("-Gbc")
			player:setFlags("-Grc")
			if card:isRed() then color = ".|red" player:setFlags("Grc") else color = ".|black" player:setFlags("Gbc") end
			local judge = sgs.JudgeStruct()
			judge.pattern = color
			judge.good = true
			judge.reason = self:objectName()
			judge.who = player
			judge.time_consuming = true
			room:judge(judge)
			-- if judge:isGood() then
				-- player:gainMark("@bear")
				-- player:setFlags("Gfc")
			-- end
		end
		return false
		
	end
}
--]]
--怕生
introvert = sgs.CreateTriggerSkill{
	name = "introvert",
	frequency = sgs.Skill_NotFrequent,
	events = {sgs.TargetConfirmed},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.TargetConfirmed then
			local use = data:toCardUse()
			if use.card and use.from:objectName() ~= player:objectName() and use.to and use.to:contains(player) and player:hasSkill(self:objectName()) and not use.from:hasFlag("introvert_vis") then
				if use.card:isKindOf("Peach") or use.card:isKindOf("Analeptic") or use.card:isKindOf("AmazingGrace") or use.card:isKindOf("GodSalvation") or use.card:isKindOf("WoodenOx") or use.card:isKindOf("SkillCard") then return false end
				if use.card:isKindOf("EquipCard") then	
					local elog = sgs.LogMessage()
					elog.type = "#introvert_elog"
					elog.from = use.from
					room:sendLog(elog)
				end
				if not room:askForSkillInvoke(player, self:objectName(), data) then return false end
				use.from:setFlags("introvert_vis")
				local nullified_list = use.nullified_list
				table.insert(nullified_list, player:objectName())
				use.nullified_list = nullified_list
				data:setValue(use)
				room:broadcastSkillInvoke("introvert", math.random(1, 3))
				local log = sgs.LogMessage()
				log.type = "#introvert_log"
				log.from = player
				room:sendLog(log)
				if use.card:isKindOf("DelayedTrick") then
					room:throwCard(use.card, player)
					-- room:setTag("SkipGameRule",sgs.QVariant(true))
				end
				if use.card:isKindOf("EquipCard") then
					-- local removed = room:askForPlayerChosen(user, room:getAlivePlayers(), "qiaoshui:remove", "@qiaoshui-remove:::" .. use.card:objectName())
					use.to:removeOne(player)
					-- local extra = room:askForPlayerChosen(user, room:getAlivePlayers(), "qiaoshui:add", "@qiaoshui-add:::" .. use.card:objectName())
					use.to:append(use.from)
					data:setValue(use)
				end
			end
		end
		return false
	end
}
introvertClear = sgs.CreateTriggerSkill{
	name = "#introvertClear" ,
	events = {sgs.EventPhaseStart} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish then
			-- local room = player:getRoom()
			for _,p in sgs.qlist(room:getAlivePlayers()) do
				-- if p:hasFlag("introvert_vis") then
					p:setFlags("-introvert_vis")
				-- end
			end
		end
		return false
	end ,
	can_trigger = function(self, target)
		return target
	end ,
}

zhixi = sgs.CreateTriggerSkill{
	name = "zhixi",
	events = sgs.DamageInflicted,
	
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()		
		if player:hasSkill("zhixi") and not player:isAllNude() then
			local card = room:askForCard(player, ".|black|.", "@zhixi", data, sgs.Card_MethodDiscard,
                    damage.from, false, self:objectName())

			if not card then return false end

			local others = room:getOtherPlayers(player)

			local tar = room:askForPlayerChosen(player, others, "zhixi", "zhixi_choiceplayer", true, true)
			if tar then
				tar:addMark("AI_zhixi")
				if room:askForChoice(player, "zhixi", "draw+discard", ToData(tar)) == "draw" then
					room:broadcastSkillInvoke("zhixi", math.random(1, 2))
					local count = tar:getLostHp()
					if count <= 0 then count = 1 end
					if not tar:faceUp() then tar:turnOver() tar:drawCards(1) else tar:drawCards(count) end
					
				else
					room:broadcastSkillInvoke("zhixi", math.random(3, 4))
					if tar:isKongcheng() then
						-- room:damage(sgs.DamageStruct("zhixiDamage", player, tar, 1, sgs.DamageStruct_Normal))
						room:loseHp(tar)
					else
						local hcn = tar:getHandcardNum()*0.5
						local discount = math.ceil(hcn)
						for i = 1,discount,1 do
							local card = room:askForCardChosen(player, tar, "h", self:objectName())
							room:throwCard(card, tar, player)
						end
						-- if discount > 2 then room:damage(sgs.DamageStruct("zhixiDamage", player, tar, 1, sgs.DamageStruct_Normal)) end
						if discount > 2 then room:loseHp(tar) end
					end
				end
				room:setPlayerMark(tar, "AI_zhixi", 0)
			else
				room:broadcastSkillInvoke("zhixi", math.random(3, 4))
			end
			-- if card:getSuit() ~= sgs.Card_Spade then return false end
			-- room:throwCard(card, player)
			local log = sgs.LogMessage()
			log.type = "#zhixi_log"
			log.from = player
			log.arg = "zhixi"
			room:sendLog(log)
			if not player:faceUp() then
				player:turnOver() 
				player:drawCards(1+player:getLostHp())
			end
			damage.prevented = true
			data:setValue(damage)
			return true
		end
		return false
	end,
}
--逆勇：鎖定技。你不會跳過回合、不會被翻面，結束階段如果你的手牌少於生命值，你摸兩張牌然後受到一點無來源的傷害，若沒有，則獲得【突襲】(舊版)直到下次回合結束。
y_sousetsu = sgs.CreateTriggerSkill{
	name = "y_sousetsu",
	events = {sgs.EventPhaseSkipping, sgs.EventPhaseStart, sgs.TurnedOver},
	-- events = {sgs.EventPhaseStart, sgs.TurnedOver},
	frequency = sgs.Skill_Compulsory,
	priority = -998,
	on_trigger = function(self,event,player,data,room)

		if event == sgs.EventPhaseSkipping then
    		room:sendCompulsoryTriggerLog(player,self:objectName())
	    	return true
    	elseif event == sgs.EventPhaseStart then
    	-- if event == sgs.EventPhaseStart then
			if player:getPhase() == sgs.Player_Finish then
				if player:getHp() > player:getHandcardNum() then
					room:sendCompulsoryTriggerLog(player,self:objectName())
					player:drawCards(2)
					room:damage(sgs.DamageStruct("y_sousetsuDamage", nil, player, 1, sgs.DamageStruct_Normal))
					if player:hasSkill("nostuxi") then room:detachSkillFromPlayer(player,"nostuxi") end
				elseif not player:hasSkill("nostuxi") then
					room:acquireSkill(player,"nostuxi")
				end
			end
    	elseif event == sgs.TurnedOver then
    		room:sendCompulsoryTriggerLog(player,self:objectName())
	    	room:setPlayerProperty(player,"faceup",sgs.QVariant(true))
			return true
		end
		return false
	end
}

-- 騷亂_備份：無聊做出來的技能。指定一名目標對其造成一點火焰傷害，然後視為他隨機對身邊距離為一的對象打出一張火殺，接著再換其對距離為一的目標打出一張火殺，如此反覆一直到殺五次或無法繼續為止。(你不會成為此殺的對象。)
purgatoryfireCard = sgs.CreateSkillCard{
	name = "purgatoryfireCard" ,
	target_fixed = false,
	will_throw = true,
	filter = function(self, targets, to_select)
		return #targets < 1 and to_select:objectName() ~= sgs.Self:objectName()
	end, 
	feasible = function(self, targets)
		return #targets == 1
	end, 
	on_use = function(self, room, source, targets)
		source:setFlags("purgatoryfireUsing")
		for _,player in pairs(targets) do
			if player:isAlive() then
				room:cardEffect(self, source, player)
			end
		end
		source:setFlags("-purgatoryfireUsing")
	end ,
	on_effect = function(self, effect)
		local room = effect.from:getRoom()
		local ntarget = effect.to
		local chosentars = {}
		room:damage(sgs.DamageStruct("purgatoryfire", effect.from, effect.to, 1, sgs.DamageStruct_Fire))
		room:getThread():delay(500)
		local others = room:getOtherPlayers(effect.from)
		for i=1, 5, 1 do
			chosentars = {}
			for _,t in sgs.qlist(others) do
				-- ntarget = ntarget:getNextAlive()
				-- if ntarget == targets[1] then break end
				if ntarget:distanceTo(t) <= 1 and ntarget:isAlive() and ntarget:objectName() ~= t:objectName() then
					table.insert(chosentars, t)
					-- local slash = sgs.Sanguosha:cloneCard("fire_slash", sgs.Card_NoSuit, 0)
					-- slash:setSkillName("purgatoryfire")
					-- room:useCard(sgs.CardUseStruct(slash, ntarget, t), false)
					-- ntarget = t
					-- break
				end
			end
			if #chosentars == 0 then break end
			if #chosentars > 1 then
				ran = math.random(1, 2)
				local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
				slash:setSkillName("purgatoryfire")
				room:useCard(sgs.CardUseStruct(slash, ntarget, chosentars[ran]), false)
				ntarget = chosentars[ran]
			else
				local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
				slash:setSkillName("purgatoryfire")
				room:useCard(sgs.CardUseStruct(slash, ntarget, chosentars[1]), false)
				ntarget = chosentars[1]
			end
			room:getThread():delay(500)
			-- if n > 3 then n = 3 end
			-- source:loseMark("@mana", 2)
			-- for i = 1,n,1 do
				-- room:damage(sgs.DamageStruct("ChainLightningDamage", source, targets[i], 1, sgs.DamageStruct_Thunder))
				-- room:getThread():delay(400)
			-- end
		end
	end
}
purgatoryfire = sgs.CreateOneCardViewAsSkill{
	name = "purgatoryfire",
	expand_pile = "wooden_ox",
	view_filter = function(self,to_select)
		return true
	end,
	view_as = function(self, card)
		local acard = purgatoryfireCard:clone()
		acard:addSubcard(card)
		acard:setSkillName("purgatoryfire")
		return acard
	end,
	enabled_at_play = function(self,player)
		-- return not (player:hasUsed("#crushingimpactCard") or player:isKongcheng())
		return true
	end,
	enabled_at_response = function(self, player, pattern)
		return false
	end,
}

distancechange = sgs.CreateDistanceSkill{ -- 改距離_公廁
	name = "#distancechange",
	correct_func = function(self, from, to)
		if from:hasSkill("yusha") then -- 你與其他角色距離
			return -from:getHandcardNum()
		end
		if from:hasSkill("sportsw") then
			return -1
		end
		if from:hasSkill("blooddry") then
			return -from:getLostHp()
		end
		-- if from:hasSkill("harvest") then
		if from:getGeneralName() == "bloodymarry" then
			return -1*from:getMark("Hponeguys")
		end
		if from:hasSkill("semeruki") then
			return -math.max(0, from:getPile("pulsepile"):length())
		end
		-- if to:hasSkill("awayfromthemundane") then -- 其他角色與你距離
			-- return math.max(0,(3 - to:getPile("learned"):length()))
		-- end
	end,
}

yusha = sgs.CreateTriggerSkill{
	name = "yusha",
	frequency = sgs.Skill_Compulsory ,
	-- events = {sgs.PreDamageDone, sgs.PreHpLost, sgs.FinishJudge, sgs.DrawNCards},
	events = {sgs.Damaged, sgs.HpLost, sgs.AskForPeaches, sgs.PreHpLost, sgs.FinishJudge},
	
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.FinishJudge then
			local judge = data:toJudge()
			if judge.reason == self:objectName() then
				local card = judge.card
				player:obtainCard(card)
				return true
			end
		elseif event == sgs.PreHpLost then
			room:sendCompulsoryTriggerLog(player, "yusha")
			local judge = sgs.JudgeStruct()
			judge.pattern = ".|red"
			judge.good = true
			judge.play_animation = true
			judge.who = player
			judge.reason = self:objectName()
			room:judge(judge)
			if judge:isGood() then
				room:broadcastSkillInvoke("yusha", 1)
				if event == sgs.PreHpLost then
					return true
				end
			else
				room:broadcastSkillInvoke("yusha", 3)
				-- player:gainMark("@yushamark")
				return false
			end
		elseif (event == sgs.HpLost or event == sgs.Damaged or event == sgs.AskForPeaches) and player:getMaxHp() > 2 and player:getHp() <= 1 then
			if event == sgs.AskForPeaches then room:broadcastSkillInvoke("yusha", 2)
			else room:broadcastSkillInvoke("yusha", 4) end
			room:loseMaxHp(player, 1, self:objectName())
			local n = player:getMaxHp()-player:getHp()
			room:recover(player,sgs.RecoverStruct(player, nil, n))
			if player:getMark("@SuperLimitBreak") > 0 then
				player:drawCards(player:getMaxHp(), self:objectName())
				-- player:drawCards(n, self:objectName())
			end
		-- elseif event == sgs.DrawNCards then
			-- local x = player:getMark("@yushamark")
			-- player:loseAllMarks("@yushamark")
			-- local count = data:toInt() + x
			-- data:setValue(count)
				-- if event == sgs.AskForPeaches and player:hasSkill("unlock") and player:getMark("@kiyoi_coin") > 2 then
			-- local dying = data:toDying()
			-- if dying.who:objectName() == player:objectName() then
				-- player:loseMark("@kiyoi_coin", 3)
				-- local num = 1 - player:getHp()
				-- player:drawCards(num)
				-- room:recover(player, sgs.RecoverStruct(player, nil, num))
			-- end
		-- end
		end
		return false
	end
}

tomowodaji = sgs.CreateTriggerSkill{
	name = "tomowodaji",
	-- events = {sgs.PreDamageDone},
	events = {sgs.DamageInflicted},

	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()
		local killer = damage.from
		for _, yuna in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
			local exbool = yuna:getTag(player:objectName()):toBool()
			if player:objectName() == yuna:objectName() or yuna:hasFlag(player:objectName()) or exbool then continue end
				local log = sgs.LogMessage()
				log.type = "#tomowodaji_log"
				log.from = damage.from
				log.to:append(damage.to)
				log.arg = damage.damage
				room:sendLog(log)
			if room:askForSkillInvoke(yuna,self:objectName(),data) then
				-- damage.damage = math.max(0, damage.damage - 1)
				room:loseHp(yuna, 1)
				if damage.from and killer:objectName() ~= yuna:objectName() then
					room:setPlayerFlag(yuna,"tomowodaji")
					room:askForUseSlashTo(yuna, killer, "#tomowodaji_slash")
				end
				room:setPlayerFlag(yuna,"-tomowodaji")
				local log = sgs.LogMessage()
				log.type = "#tomowodaji_log2"
				log.from = damage.from
				log.to:append(damage.to)
				log.arg = "tomowodaji"
				room:sendLog(log)
				damage.prevented = true
                data:setValue(damage)
                return true
			else
				local choice = room:askForChoice(yuna, self:objectName(), "excludeforever+exclude+cancel")
				if choice == "excludeforever" then
					yuna:setTag(player:objectName(), sgs.QVariant(true))
				elseif choice == "exclude" then
					yuna:setFlags(player:objectName())
				end
			end
		end
		return false
	end,
	can_trigger = function(self, target)
		return target and not (target:hasSkill("yusha") or target:hasSkill("tomowodaji"))
	end
}

--鬼薙：你的武器視為殺。你的武器欄無裝備時，你的攻擊距離+3。你的第一張殺指定目標時，你摸當前生命數的牌(若為本技能轉換之殺，則加摸該武器攻擊距離數)。命中目標時，你可以令其無法從手牌打出或使用錦囊牌直到下次其回合結束。若被閃避，你獲得【業刀】：你的黑牌視為殺。對手每次閃避殺，獲得一枚+1標記。若殺命中你將額外造成+1標記數量的傷害。當殺結束後，你失去【業刀】技能、所有+1標記。

japenknifeslashe = sgs.CreateFilterSkill{
	name = "japenknifeslashe" ,
	view_filter = function(self, card)
		-- return card:isBlack() or (card:isRed() and sgs.Self:getMark("@SuperLimitBreak") > 0)
		return card:isBlack() and not card:isKindOf("Weapon")
	end ,
	view_as = function(self, card)
		local slash = sgs.Sanguosha:cloneCard("slash", card:getSuit(), card:getNumber())
		slash:setSkillName(self:objectName())
		local wrap = sgs.Sanguosha:getWrappedCard(card:getId())
		wrap:takeOver(slash)
		return wrap
	end
}

japenknifeslashe2 = sgs.CreateFilterSkill{
	name = "#japenknifeslashe2" ,
	mute = true,
	view_filter = function(self, card)
		return card:isKindOf("Weapon")
	end ,
	view_as = function(self, card)-- 只要別用room和gainMark(改addMark可)，基本上都可用
		local slash = sgs.Sanguosha:cloneCard("slash", card:getSuit(), card:getNumber())
		-- sgs.Self:setMark(card:getClassName(), card:getId()) 
		-- slash:setSkillName("japenknifeslashe2_" .. card:getClassName())
		-- slash:setFlags(card:getClassName())
		slash:setTag("jnb_wtype", sgs.QVariant(card:getClassName())) --採用沒有room的setTag
		slash:setSkillName("japenknifeslashe2")
		local wrap = sgs.Sanguosha:getWrappedCard(card:getId())
		wrap:takeOver(slash)
		return wrap
	end
}

japenknifejile = sgs.CreateTriggerSkill{
	name = "japenknifejile",
	events = {sgs.CardOffset, sgs.DamageCaused, sgs.TargetConfirmed},
	on_trigger = function(self, event, player, data) 
		local room = player:getRoom()
		if event == sgs.TargetConfirmed then
			local use = data:toCardUse()
			local room = player:getRoom()
			if use.card:isKindOf("Slash") and use.from:objectName() == player:objectName() and player:getPhase() == sgs.Player_Play and player:hasSkill("japenknifejile") then
				if not player:hasFlag("JPB_FS") then
					player:setFlags("JPB_FS")
					local num = math.min(player:getHp(), 3)
					if player:getMark("@SuperLimitBreak") > 0 and use.card:getSkillName() == "japenknifeslashe2" then
						local wep_skillname = use.card:getTag("jnb_wtype"):toString()
						if wep_skillname ~= nil then
							if wep_skillname == "Wutiesuolian" then --新武器用不了sgs.weapon_range，估計是資料沒登入，只好這樣惡補
								num = math.max(num ,3)
							elseif wep_skillname == "Wuxinghelingshan" then
								num = math.max(num ,4)
							elseif sgs.weapon_range[wep_skillname] == nil then --若有更多新武器沒登入，那全部視距離為3
								num = math.max(num ,3)
							else
								num = math.max(num ,sgs.weapon_range[wep_skillname])
							end
							use.card:removeTag("jnb_wtype")
						end
					end
					-- local wep_skillname = use.card:getSkillName()
					-- if wep_skillname ~= nil and wep_skillname:startsWith("japenknifeslashe2") then --使用skillname紀錄的話，log出現的文字將無法翻譯成中文
						-- local wep_str = wep_skillname:split("_")
						-- num = num+sgs.weapon_range[wep_str[2]]
					-- end
					-- for _, p in sgs.qlist(use.to) do
						-- num = num + p:getCards("he")
					-- end
					player:drawCards(num)
				end
			end
		end
		if event == sgs.CardOffset then
			local effect = data:toCardEffect()
			if player:canSlash(effect.to, false) and not player:getWeapon() and effect.card:isKindOf("Slash") then
				if not player:hasFlag("JPBladeUse") and not player:hasSkill("japenknifeslashe") then
					-- room:acquireSkill(player, "japenknifeslashe")
					room:filterCards(player, player:getCards("h"), true)
					for _,c in sgs.list(player:getHandcards())do
						if c:isRed() or c:getSkillName()=="japenknifeslashe" then continue end
						local toc = sgs.Sanguosha:cloneCard("slash",2,c:getNumber())
						toc:setSkillName("japenknifeslashe")
						local wrap = sgs.Sanguosha:getWrappedCard(c:getEffectiveId())
						wrap:takeOver(toc)
						room:notifyUpdateCard(player,c:getEffectiveId(),wrap)
					end
					player:setFlags("JPBladeUse")
				end
				player:gainMark("@defensive_distance_test")
				local use = room:askForUseSlashTo(effect.from, effect.to, "#bladeeffecct", false, true)
				if player:hasFlag("JPBladeUse") then
					-- room:detachSkillFromPlayer(player, "japenknifeslashe")
					local hw = sgs.CardList()
					for _,c in sgs.list(player:getHandcards())do
						if (c:isBlack() and not c:isKindOf("EquipCard")) or c:getSkillName()=="japenknifeslashe"
						then hw:append(c) end
					end
					if hw:length()>0 then
						room:filterCards(player,hw,true)
					end
					player:setFlags("-JPBladeUse")
				end
				if not use and player:getMark("@defensive_distance_test") > 0 then 
					-- if player:isWounded() then
						-- local cnt = player:getMark("@defensive_distance_test") - player:getLostHp()
						-- if cnt > 0 then 
							-- local theRecover = sgs.RecoverStruct()
							-- theRecover.recover = player:getLostHp()
							-- theRecover.who = player
							-- room:recover(player, theRecover)
							-- player:drawCards(cnt)
						-- else
							-- local theRecover = sgs.RecoverStruct()
							-- theRecover.recover = player:getMark("@defensive_distance_test")
							-- theRecover.who = player
							-- room:recover(player, theRecover)
						-- end
					-- else
						-- player:drawCards(player:getMark("@defensive_distance_test"))
					-- end
					player:loseAllMarks("@defensive_distance_test")
				end
			end
		end
		if event == sgs.DamageCaused then
			local damage = data:toDamage()
			if damage.from:objectName() == player:objectName() and damage.card and damage.card:isKindOf("Slash") then
				if room:askForSkillInvoke(player, "japenknifejile", data) then
					room:broadcastSkillInvoke("japenknifejile", math.random(1, 2))
					local jpjileis = damage.to:getTag(self:objectName()):toString():split("+")
					if table.contains(jpjileis, "TrickCard") then return false end
					table.insert(jpjileis,"TrickCard")
					damage.to:setTag(self:objectName(), sgs.QVariant(table.concat(jpjileis, "+")))
					local _type = "TrickCard".."|.|.|hand" --只是手牌
					room:setPlayerCardLimitation(damage.to, "use,response", _type, true)
					if damage.to:getMark("@jpjile") == 0 then
						room:addPlayerMark(damage.to, "@jpjile")
					end
					if damage.card:isKindOf("Slash") and player:getMark("@defensive_distance_test") > 0 then
						damage.damage = damage.damage + player:getMark("@defensive_distance_test")
						data:setValue(damage)
						player:loseAllMarks("@defensive_distance_test")
					end
				else
					--舊版
					-- player:gainMark("@defensive_distance_test")
					-- if player:isWounded() then
						-- local cnt = player:getMark("@defensive_distance_test") - player:getLostHp()
						-- if cnt > 0 then 
							-- local theRecover = sgs.RecoverStruct()
							-- theRecover.recover = player:getLostHp()
							-- theRecover.who = player
							-- room:recover(player, theRecover)
							-- player:drawCards(cnt)
						-- else
							-- local theRecover = sgs.RecoverStruct()
							-- theRecover.recover = player:getMark("@defensive_distance_test")
							-- theRecover.who = player
							-- room:recover(player, theRecover)
						-- end
					-- else
						-- player:drawCards(player:getMark("@defensive_distance_test"))
					-- end
					player:loseAllMarks("@defensive_distance_test")
				end
			end
		end
		return false
	end, 
}
japenknifejileClear = sgs.CreateTriggerSkill{
	name = "#japenknifejileClear",
	events = {sgs.EventPhaseChanging,sgs.Death},
	priority = 5,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.EventPhaseChanging then
			local change = data:toPhaseChange()
			for _,p in sgs.qlist(room:findPlayersBySkillName("japenknifejile")) do
				if p:hasFlag("JPB_FS") then p:setFlags("-JPB_FS") end -- p:gainMark("&test") 曾在這裡測試，使用過殺一定會發生
			end
			if not (change.to == sgs.Player_NotActive and player:getMark("@jpjile") > 0) then 
				return false 
			end
			local jpjilei_list = player:getTag("japenknifejile"):toString():split("+")
			if #jpjilei_list > 0 then
				for _,jileity in ipairs(jpjilei_list) do
					room:removePlayerCardLimitation(player, "use,response", jileity.."|.|.|hand$1")
					room:setPlayerMark(player, "@jpjile", 0)
				end
				player:removeTag("japenknifejile")
			end
		elseif event == sgs.Death then
			local death = data:toDeath()
			if death.who:objectName() ~= player:objectName() or player:objectName() ~= room:getCurrent():objectName() then
				return false
			end
			local players = room:getAllPlayers()
			for _,p in sgs.qlist(players) do
				local jpjilei_list = p:getTag("japenknifejile"):toString():split("+")
				if #jpjilei_list > 0 then
					for _,jileity in ipairs(jpjilei_list) do
						room:removePlayerCardLimitation(p, "use,response", jileity.."|.|.|hand$1")
						room:setPlayerMark(p, "@jpjile", 0)
					end
					p:removeTag("japenknifejile")
				end
			end
		end
		
		return false
	end,
	can_trigger = function(self, target)
		return target
	end
}


-- japenknifepro = sgs.CreateProhibitSkill
-- {
	-- name = "#japenknifepro",
	-- is_prohibited = function(self, from, to, card)
		-- if card:isKindOf("Weapon") and to:hasSkill("japenknifejile") then
			-- return true
		-- end
	-- end
-- }
--骷髏：你成為殺的或非延時錦囊牌的對象時，你可以棄一張牌點數X以上的牌、摸一张牌然後翻面，並令來源也翻面。你背面朝上時，錦囊牌對你無效。(X為13減去來源的裝備數+手牌+你失去的生命，最少為一)
-- skeleton = sgs.CreateTriggerSkill { --舊得寫法，但這種寫法有個問題，面對青剛劍時，如果發動此技能，妳的防具將永遠無效。不知道怎麼消青鋼標記，所以改寫法。
	-- name = "skeleton",
	-- frequency = sgs.Skill_NotFrequent,
	-- events = {sgs.CardEffected},
	
	-- on_trigger = function(self, event, player, data)
		-- local room = player:getRoom()
		-- if event == sgs.CardEffected then
			-- local effect = data:toCardEffect()
			-- if effect.from == player or effect.to ~= player or not effect.card then return false end
			-- local num = 13 - (effect.from:getHandcardNum() + effect.from:getEquips():length())
			-- if num <= 0 then num = 1 end
			-- if effect.card:isKindOf("Slash") or effect.card:isNDTrick() then
				-- if player:getState() == "robot" and room:askForSkillInvoke(player, "skeleton", data) then -- 為了讓AI別對隊友使用，並增加其分辨慮
					-- if not player:isKongcheng() and room:askForCard(player, ".|.|"..num.."~".."13|hand", "@skeleton") then
						-- player:turnOver()
						-- effect.from:turnOver()
						-- room:broadcastSkillInvoke("skeleton", math.random(1, 2))
						-- player:drawCards(1)
					-- end
				-- elseif player:getState() ~= "robot" then
					-- if not player:isKongcheng() and room:askForCard(player, ".|.|"..num.."~".."13|hand", "@skeleton") then
						-- player:turnOver()
						-- effect.from:turnOver()
						-- room:broadcastSkillInvoke("skeleton", math.random(1, 2))
						-- player:drawCards(1)
					-- end
				-- end
				-- if not player:faceUp() then
					-- local msg = sgs.LogMessage()
					-- msg.type = "#skeletoninvisible"
					-- msg.from = effect.from
					-- msg.arg = effect.card:objectName()
					-- msg.to:append(effect.to)
					-- room:sendLog(msg)
					-- return true
				-- end
			-- end
		-- end
		-- return false
	-- end,
-- }
skeleton = sgs.CreateTriggerSkill{
	name = "skeleton",
	frequency = sgs.Skill_NotFrequent,
	events = {sgs.TargetConfirmed},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.TargetConfirmed then
			local use = data:toCardUse()
			local room = player:getRoom()
			if use.from and use.card and use.from:objectName() ~= player:objectName() and use.to and use.to:contains(player) and player:hasSkill(self:objectName()) 
			and (use.card:isKindOf("Slash") or use.card:isNDTrick()) then
				local num = 13 - (use.from:getHandcardNum() + use.from:getEquips():length())
				if num <= 0 then num = 1 end
				if player:getState() == "robot" and room:askForSkillInvoke(player, "skeleton", data) then -- 為了讓AI別對隊友使用，並增加其分辨慮
					if not player:isKongcheng() and room:askForCard(player, ".|.|"..num.."~".."13|hand", "@skeleton", sgs.QVariant(), sgs.Card_MethodDiscard,
                use.from,
                false, self:objectName(), true) then
						player:turnOver()
						use.from:turnOver()
						room:broadcastSkillInvoke("skeleton", math.random(1, 2))
						player:drawCards(1)
					end
				elseif player:getState() ~= "robot" then
					if not player:isKongcheng() and room:askForCard(player, ".|.|"..num.."~".."13|hand", "@skeleton", sgs.QVariant(), sgs.Card_MethodDiscard,
                use.from,
                false, self:objectName(), true) then
						player:turnOver()
						use.from:turnOver()
						room:broadcastSkillInvoke("skeleton", math.random(1, 2))
						player:drawCards(1)
					end
				end

				if not player:faceUp() then
					local msg = sgs.LogMessage()
					msg.type = "#skeletoninvisible"
					msg.from = use.from
					msg.arg = use.card:objectName()
					msg.to:append(player)
					room:sendLog(msg)
					local nullified_list = use.nullified_list
					table.insert(nullified_list, player:objectName())
					use.nullified_list = nullified_list
					data:setValue(use)
				end
			end
		end
		return false
	end
}

--行異：你的桃可以在你受傷時立刻使用。回合開始，你可以將判定階段與棄牌階段互換，但你必須將出牌階段改為摸牌階段。
strangeguy = sgs.CreateTriggerSkill{
	name = "strangeguy",
	frequency = sgs.Skill_NotFrequent,
	events = {sgs.Damaged, sgs.EventPhaseChanging},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.Damaged then
			for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
				-- if p:objectName() == data:toDamage().to:objectName() and room:askForUseCard(p, "peach", "@strangeguy") then
					-- room:broadcastSkillInvoke(self:objectName())
				-- end
				if p:objectName() == data:toDamage().to:objectName() then
					room:askForUseCard(p, "peach", "#strangeguy")
				end
			end
		else
			local change = data:toPhaseChange()
			-- sgs.Player_Judge
			-- sgs.Player_Draw
			-- sgs.Player_Play
			-- sgs.Player_Discard
			if change.to == sgs.Player_Judge then
				if not player:isSkipped(sgs.Player_Judge) then
					if player:askForSkillInvoke(self:objectName(), sgs.QVariant("ChangeJudgeToDiscard")) then
						room:broadcastSkillInvoke("strangeguy", math.random(1, 3))
						change.to = sgs.Player_Discard
						player:setFlags("strangeguyEffected")
						data:setValue(change)
					end
				end
			elseif change.to == sgs.Player_Play and player:hasFlag("strangeguyEffected") then
				if not player:isSkipped(sgs.Player_Play) then
					change.to = sgs.Player_Draw
					data:setValue(change)
				end
			elseif change.to == sgs.Player_Discard and player:hasFlag("strangeguyEffected") then
				if not player:isSkipped(sgs.Player_Discard) then
					change.to = sgs.Player_Judge
					player:setFlags("-strangeguyEffected")
					data:setValue(change)
				end
			else
				return false
			end
		end
	end,
	can_trigger = function(self, target)
		return target and target:hasSkill("strangeguy")
	end
}
--深林 deepforest：鎖定技。若牌堆數少於X張，場上所有人技能失效，你摸牌前可以發動八張牌的觀星。(X為遊戲人數x13)
deepforest = sgs.CreateTriggerSkill{
	name = "deepforest",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.CardsMoveOneTime, sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data, room)
		local room = player:getRoom()
		if event == sgs.CardsMoveOneTime then	
			local move = data:toMoveOneTime()
			if move.from_places:contains(sgs.Player_DrawPile) or move.to_place == sgs.Player_DrawPile then
				local x = room:getDrawPile():length()
				local y = room:getDiscardPile():length()
				local others = room:getOtherPlayers(player)
				if player:getMark("&CardCountByDeepforest") == 0 then
					local num_total = math.ceil((x+y)*0.25)
					local count = num_total + 7*(others:length() + 1)
					room:setPlayerMark(player, "&CardCountByDeepforest", count)
				end
				local marknum = player:getMark("&CardCountByDeepforest")
				if player:getMark("@SuperLimitBreak") > 0 and player:isAlive() and player:isWounded() then
					marknum = marknum + player:getLostHp()*25
				end
				if x < marknum then
					if player:getMark("Intheforest") <= 0 then
						room:broadcastSkillInvoke("deepforest", 1)
						player:setFlags("DFsoundeffect")
						room:setPlayerMark(player, "Intheforest", 1)
						room:setPlayerMark(player, "&deepforest", 1)
						room:setEmotion(player, "skill/yuri_deepforest")
						-- room:doSuperLightbox("shitsinoult", "deepforest")
					end
					-- player:gainMark("@smoke")
					for _,p in sgs.qlist(others) do
						if p:getMark("@smoke") == 0 then
							local deepforest_skills = p:getTag("deepforestSkills"):toString():split("+")
							local skills = p:getVisibleSkillList()
							-- player:gainMark("@smoke")
							for _, skill in sgs.qlist(skills) do
									room:addPlayerMark(p, "Qingcheng"..skill:objectName())
									table.insert(deepforest_skills, skill:objectName())
								-- for _, skill in sgs.qlist(skills) do
									-- if not skill:inherits("SPConvertSkill") and not skill:isAttachedLordSkill() and not (Set(SAinvalid_skills))[skill:objectName()] then
										-- room:addPlayerMark(to, "Qingcheng"..skill:objectName())
										-- table.insert(SAinvalid_skills, skill:objectName())
									-- end
								-- end
							end
							room:setPlayerMark(p, "@smoke", 1)
							p:setTag("deepforestSkills", sgs.QVariant(table.concat(deepforest_skills, "+")))
						end
					end
				else
					-- if player:getMark("Intheforest") > 0 and not player:getPile("tobenaturecards"):isEmpty() then player:clearOnePrivatePile("tobenaturecards") end
					if player:getMark("Intheforest") > 0 and not player:getPile("wooden_ox"):isEmpty() 
					and not (player:getTreasure() and player:getTreasure():isKindOf("WoodenOx")) then
						player:clearOnePrivatePile("wooden_ox")
					end
					room:setPlayerMark(player, "Intheforest", 0)
					room:setPlayerMark(player, "&deepforest", 0)
					for _,p in sgs.qlist(others) do
						if p:getMark("@smoke") > 0 then
							local deepforest_skills = p:getTag("deepforestSkills"):toString():split("+")
							for _, skill_name in ipairs(deepforest_skills) do
								room:removePlayerMark(p, "Qingcheng"..skill_name)
							end
							p:setTag("deepforestSkills", sgs.QVariant())
							room:setPlayerMark(p, "@smoke", 0)
						end
					end
				end
			end
		end
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Start then
			if player:getMark("Intheforest") > 0 then
				local looknum = math.max(room:getDiscardPile():length(), 50)/10
				if looknum > 15 then looknum = 15 end
				local count = math.ceil(looknum)
				local cards = room:getNCards(count)
				if not player:hasFlag("DFsoundeffect") then
					room:broadcastSkillInvoke("deepforest", math.random(2, 3))
				end
				room:askForGuanxing(player,cards)
			end
			-- if not player:getPile("tobenaturecards"):isEmpty() then
				-- local dc = player:getLostHp() + 1
				-- while dc > 0 do
					-- local cid = player:getPile("tobenaturecards"):last()
					-- local card = sgs.Sanguosha:getCard(cid)
					-- room:obtainCard(player, card)
					-- dc = dc - 1
					-- if player:getPile("tobenaturecards"):isEmpty() or dc <= 0 then
						-- dc = 0
						-- break
					-- end
				-- end
			-- end
		end
		return false
	end
}
deepforestClear = sgs.CreateTriggerSkill{
	events = {sgs.Death, sgs.EventLoseSkill} ,
	name = "#deepforestClear" ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.Death then
			local death = data:toDeath()
			if death.who:hasSkill("deepforest") then
				for _,p in sgs.qlist(room:getAlivePlayers()) do
					if p:getMark("@smoke") > 0 then
						local deepforest_skills = p:getTag("deepforestSkills"):toString():split("+")
						for _, skill_name in ipairs(deepforest_skills) do
							room:removePlayerMark(p, "Qingcheng"..skill_name)
						end
						p:setTag("deepforestSkills", sgs.QVariant())
						room:setPlayerMark(p, "@smoke", 0)
					end
				end
			end
		elseif event == sgs.EventLoseSkill then
			if data:toString() == "deepforest" then
				if not player:getPile("wooden_ox"):isEmpty() and not (player:getTreasure() and player:getTreasure():isKindOf("wooden_ox")) then
					-- player:clearOnePrivatePile("tobenaturecards")
					player:clearOnePrivatePile("wooden_ox")
				end
			end
		end
		return false
	end ,
	can_trigger = function(self, target)
		return target
	end ,
}
--自然 tobenature：階段技，你指定一名目標(在深林的效果發動期間，你可以指定任意數量的目標。)，令其將手牌放置於牌堆頂或摸牌直到與你手牌量相同，若其原手牌數大於你，其受到那差距的傷害。(目標不能是自己)
--新自然：階段技， 你指定一名目標(在深林的效果發動期間，你可以指定任意數量的目標。令其將牌至於你的武將牌上視為木牛流馬牌，或令其摸牌。若其摸的牌超過你當前生命值且你已受傷，改為其摸一张牌，你恢復一點體力。
tobenatureCard = sgs.CreateSkillCard{
	name = "tobenature" ,
	filter = function(self, targets, to_select)
		if sgs.Self:getMark("Intheforest") > 0 then
			return #targets < 10 and (to_select:objectName() ~= sgs.Self:objectName()) and to_select:getHandcardNum() ~= sgs.Self:getHandcardNum()
		else
			return #targets == 0 and (to_select:objectName() ~= sgs.Self:objectName()) and to_select:getHandcardNum() ~= sgs.Self:getHandcardNum()
		end
	end ,
	feasible = function(self, targets)
		if sgs.Self:getMark("Intheforest") > 0 then
			return #targets <= 10
		else
			return #targets <= 1
		end
	end, 
	on_use = function(self, room, source, targets)
		source:setFlags("tobenatureUsing")
		for _,player in pairs(targets) do
			if player:isAlive() then
				room:cardEffect(self, source, player)
			end
		end
		source:setFlags("-tobenatureUsing")
	end ,
	on_effect = function(self, effect)
		local room = effect.from:getRoom()
		local length = effect.to:getHandcardNum()
		-- local limitdis = effect.to:getHp()
		local limitdis = effect.from:getHandcardNum()
		local count = limitdis - length
		if length < limitdis then
			if effect.from:isWounded() and count > effect.from:getHp() then
				room:drawCards(effect.to, 1)
				room:recover(effect.from, sgs.RecoverStruct(effect.from))
			else
				room:drawCards(effect.to, count)
			end
			-- for i = 1,count,1 do
				-- local id = room:drawCard()
				-- if not effect.from:isAlive() then break end
				-- effect.from:addToPile("wooden_ox", id)
			-- end
		end
		if length > limitdis then
			while length > limitdis do
				local card = room:askForCard(effect.to, ".|.|.|hand", "@tobenatureAsk", sgs.QVariant(), sgs.Card_MethodNone)
				if effect.from:getPile("wooden_ox"):length() < 5 then
					effect.from:addToPile("wooden_ox", card)
				else
					room:throwCard(card, effect.to)
				end
				length = effect.to:getHandcardNum()
				if length <= limitdis then break end
			end
			if effect.from:getMark("Intheforest") > 0 then
				room:damage(sgs.DamageStruct("tobenatureDamage", effect.from, effect.to, 1, sgs.DamageStruct_Thunder))
			end
		end
	end
}	
tobenature = sgs.CreateZeroCardViewAsSkill{
	name = "tobenature" ,
	view_as = function()
		return tobenatureCard:clone()
	end ,
	enabled_at_play = function(self, target)
		return not target:hasUsed("#tobenature")
	end
}


--讓木牛流馬的牌被棄置也會留在武將牌上。
tobenatureuma = sgs.CreateTriggerSkill{
name = "tobenatureuma",
frequency = sgs.Skill_Compulsory,
events = sgs.CardsMoveOneTime,

on_trigger = function(self, event, player, data, room)
	local move = data:toMoveOneTime()
	if (move.from_places:contains(sgs.Player_PlaceSpecial) and move.from:objectName() == player:objectName()) and move.to_place ~= sgs.Player_PlaceSpecial and not (move.reason.m_reason == sgs.CardMoveReason_S_REASON_USE or move.reason.m_reason == sgs.CardMoveReason_S_REASON_LETUSE or move.reason.m_reason == sgs.CardMoveReason_S_REASON_RESPONSE) then
		local card = move.card_ids
		if not card then return false end
		player:addToPile("wooden_ox", card)
	end
	return false
end,
priority = -5
}
-- 花咲：行動階段開始時，你可以展示三張花色相同的手牌，然後翻開牌堆第一張牌，若與展示牌花色相同，你獲得此牌，不同，則在翻一次。最多翻三次。
-- 堆嶺 heapridge：當你獲得牌，且手牌有四張以上花色相同的牌時，你可以將四張同花色的牌至於武將牌上視為"槓bars"牌，然後你摸一张牌。若你已擁有四副槓牌(16張牌)以上，而你以此法摸上來的牌花色與任一張槓牌花色相同，你的所屬陣營獲得遊戲勝利。(失去該技能不會讓你失去槓牌。)
heapridgecard = sgs.CreateSkillCard{
	name = "heapridge", 
	target_fixed = true,
	will_throw = false,
	on_use = function(self, room, source, targets)
		local room = source:getRoom()
		local ids = self:getSubcards()
		source:setFlags("preparenextdraw")
		for _,id in sgs.qlist(ids) do
			-- targets[1]:addToPile("Maggots", id, true)
			source:addToPile("bars", id, true)
		end
		if source:isWounded() then room:recover(source, sgs.RecoverStruct(source)) end
		-- source:drawCards(1)
		local id = room:drawCard()
		local suit = sgs.Sanguosha:getCard(id):getSuit()
		room:obtainCard(source, sgs.Sanguosha:getCard(id))
		local who = false
		-- if not source:getPile("bars"):isEmpty() and source:hasFlag("preparenextdraw") then
		if not source:getPile("bars"):isEmpty() and source:getPile("bars"):length() >= 16 and source:hasFlag("preparenextdraw") then
			local bar_list = source:getPile("bars")
			-- local n = bar_list:length()
			for _,card_id in sgs.qlist(bar_list) do
				if (sgs.Sanguosha:getCard(card_id):getSuit() == suit) then
					who = true
					break
				end
			end
			if who then
				room:sendCompulsoryTriggerLog(source, self:objectName())
				room:broadcastSkillInvoke("zerodifference", 2)
				room:doLightbox("$heapridge")
				room:setEmotion(source, "skill/yuri_heapridge")
				room:getThread():delay(2500)
				-- room:doSuperLightbox("sakiult","heapridge")
				if string.find("lord+loyalist", source:getRole()) then
					room:gameOver("lord+loyalist")
				else
					room:gameOver(source:getRole())
				end
			end
		end
		source:setFlags("-preparenextdraw")
	end
}

heapridgevs = sgs.CreateViewAsSkill{
	name="heapridge",
	n = 4, 
	view_filter = function(self, selected, to_select)
		if #selected == 0 then
			return not to_select:isEquipped()
		elseif #selected >= 1 then
			local cs = selected[1]:getSuit()
			return not (to_select:isEquipped() or to_select:getSuit() ~= cs)
		else
			return false
		end
	end, 
	view_as = function(self, cards)
		if #cards == 4 then
			local acard = heapridgecard:clone()
			for _,card in pairs(cards) do
				acard:addSubcard(card)
			end
			acard:setSkillName(self:objectName())
			return acard
		end
	end, 
	enabled_at_play = function(self, player)
		return false
	end, 
	enabled_at_response = function(self, player, pattern)
		return pattern == "@@heapridge"
	end
}

heapridge = sgs.CreateTriggerSkill{
	name = "heapridge",
	frequency = sgs.Skill_Compulsory,
	view_as_skill = heapridgevs,
	events = {sgs.CardsMoveOneTime},
	on_trigger = function(self, event, player, data)
		local card_id = -1
		local room = player:getRoom()
		local move = data:toMoveOneTime()
		local dest = move.to
		local ids = sgs.IntList()
		local diamonds = 0
		local hearts = 0
		local spades = 0
		local clubs = 0
		if dest then
			if dest:objectName() ~= player:objectName() then return false end
			local cards = player:getHandcards()
			if move.to_place == sgs.Player_PlaceHand then
				for _,c in sgs.qlist(cards) do
					if c:getSuit() == sgs.Card_Club then
						clubs = clubs + 1
					elseif c:getSuit() == sgs.Card_Heart then
						hearts = hearts + 1
					elseif c:getSuit() == sgs.Card_Spade then
						spades = spades + 1
					else
						diamonds = diamonds + 1
					end
				end
			end
		end
		if diamonds >= 4 or clubs >= 4 or hearts >= 4 or spades >= 4 then
			room:askForUseCard(player, "@@heapridge", "@heapridge")
		end
		return false
	end,
	priority = 2
}
-- 天資 zerodifference：回合結束時，若你有任三張相同花色的手牌，你展示所有牌，然後翻開堆頂，若有與其花色相同的牌，你獲得之，否則棄置再翻(最多翻三次)。若沒有，且你的手牌不是場上最多，你可以將手牌補至與最多手牌者相同數量(以此法補進的牌最多五張，一張一張摸而非一起摸)。
zerodifference = sgs.CreatePhaseChangeSkill{
	name = "zerodifference",
	frequency = sgs.Skill_Frequent,
	on_phasechange = function(self, player)
		if player:getPhase() == sgs.Player_Finish then
			local room = player:getRoom()
			local fuckup = true
			local threeD = 0
			local threeH = 0
			local threeS = 0
			local threeC = 0
			for _,c in sgs.qlist(player:getHandcards()) do
				if c:getSuit() == sgs.Card_Club then
					threeC = threeC+1
				end
				if c:getSuit() == sgs.Card_Spade then
					threeS = threeS+1
				end
				if c:getSuit() == sgs.Card_Heart then
					threeH = threeH+1
				end
				if c:getSuit() == sgs.Card_Diamond then
					threeD = threeD+1
				end
			end
			if threeC > 2 or threeS > 2 or threeH > 2 or threeD > 2 then
				room:showAllCards(player)
				local num = 0
				local maxc = 3+player:getLostHp()
				while num < maxc do
					-- if #basic == 4 then break end
					local id = room:drawCard()
					local move = sgs.CardsMoveStruct(id, nil, sgs.Player_PlaceTable, sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_TURNOVER, player:objectName(), self:objectName(), ""))
					room:moveCardsAtomic(move, true)
					room:getThread():delay(700)
					local card = sgs.Sanguosha:getCard(id)
					if (card:getSuit() == sgs.Card_Club and threeC > 2) or (card:getSuit() == sgs.Card_Spade and threeS > 2) or (card:getSuit() == sgs.Card_Heart and threeH > 2) or (card:getSuit() == sgs.Card_Diamond and threeD > 2) then
						fuckup = false
						room:obtainCard(player, card)
						break
					end
					num = num+1
				end
			end
			if fuckup then
				local others = room:getOtherPlayers(player)
				local maxhands = 0
				local lhp = player:getLostHp()
				local sakihand = player:getHandcardNum()
				for _,p in sgs.qlist(others) do
					if maxhands < p:getHandcardNum() then
						maxhands = p:getHandcardNum()
					end
				end
				-- if maxhands - sakihand <= 0 then return false end
				if maxhands - sakihand <= 0 and lhp <= 0 then return false end
				if room:askForSkillInvoke(player, self:objectName()) then
					local count = math.min((maxhands - sakihand), 5)
					local hcount = math.min(player:getLostHp(), 5)
					room:broadcastSkillInvoke("zerodifference", 1)
					if hcount <= count then
						for i = 1,count,1 do
							player:drawCards(1, self:objectName())
						end
					else
						for i = 1,hcount,1 do
							player:drawCards(1, self:objectName())
						end
					end
				end
			 end
		end
		return false
	end
}

lovesong = sgs.CreateTriggerSkill{
	name = "lovesong" ,
	events = {sgs.AfterDrawNCards, sgs.DamageCaused} ,
	on_trigger = function(self, event, player, data)
		if event == sgs.AfterDrawNCards then
			local draw = data:toDraw()
			if draw.reason ~= "InitialHandCards" then return false end
			local room = player:getRoom()
			local others = room:getOtherPlayers(player)
			local lover
			for _,p in sgs.qlist(others) do
				if string.find(p:getGeneralName(), "ronomiyokaruta") or string.find(p:getGeneral2Name(), "ronomiyokaruta") then
					lover = p
					break
				end
			end
			if lover and not player:isLord() and lover:getRole() ~= "renegade" then
				local role1
				if lover:isLord() then
					role1 = "loyalist"
				else
					role1 = lover:getRole()
				end
				if player:getRole() == role1 then return false end
				if player:hasSkill("lovesong") then
					-- if player:getState() == "robot" then
						local ai_data = sgs.QVariant()
						ai_data:setValue(player)
					-- end
					room:broadcastSkillInvoke("lovesong", 1)
					player:setRole(role1)
					room:setPlayerProperty(player, "role", sgs.QVariant(role1))
					room:setPlayerMark(player, "lovesong", 1)
					return false
				end
			end
		-- end 
		else
			local room = player:getRoom()
			local damage = data:toDamage()
			if string.find(damage.to:getGeneralName(), "ronomiyokaruta") or string.find(damage.to:getGeneral2Name(), "ronomiyokaruta") then
				local to = damage.to
				if to:getRole() ~= "renegade" and (player:getRole() == to:getRole() or (to:isLord() and player:getRole() == "loyalist") or (player:isLord() and to:getRole() == "loyalist")) then
					damage.damage = damage.damage - 1
					if damage.damage <= 0 then damage.prevented = true
                data:setValue(damage)
                return true end
					data:setValue(damage)
				end
			end
		end
		return false
	end
}

-- 護主：當一名目標成為單體非延時錦囊或殺的目標時，你可以棄置一張牌代替成為對象。當你因此而受傷或流失生命，忠受效果發動時，你額外摸X張牌。
-- X為原目標已損失的生命，最多為3。

--忠受：你受到傷害時，將傷害來源的一張手牌或裝備移到場上一名目標的手上，如果來源沒有牌，你令選擇的對象摸2張牌。
--如果是流失生命，則你摸兩張牌。
loyalm = sgs.CreateTriggerSkill{
	name = "loyalm",
	events = {sgs.Damaged},
	can_trigger = function(self, target)
		return target
	end,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.Damaged and player:isAlive() and player:hasSkill(self:objectName()) then
			local damage = data:toDamage()
			local from = damage.from
			if from:objectName() == player:objectName() then return false end
			for i = 0, damage.damage - 1, 1 do
				if room:askForSkillInvoke(player, self:objectName(), data) then
					room:broadcastSkillInvoke("loyalm", math.random(1, 3))
					if player:canDiscard(from, "he") then
						local id = room:askForCardChosen(player, from, "he", self:objectName(), false, sgs.Card_MethodNone)
						local to = room:askForPlayerChosen(player, room:getAlivePlayers(), self:objectName())
						room:moveCardTo(sgs.Sanguosha:getCard(id), to, sgs.Player_PlaceHand, sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_GIVE, from:objectName(), to:objectName(), self:objectName(), ""))
					else
						-- room:recover(player, sgs.RecoverStruct(player))
						local to = room:askForPlayerChosen(player, room:getAlivePlayers(), self:objectName())
						to:drawCards(2)
					end
				else
					player:drawCards(1)
				end
			end
		end
		return false
	end
}

--舊震懾：他與你或你與他距離為一或你下一家角色在摸牌階段摸牌後，若其體力值大於等於你，你可以令其給予你一張錦囊牌，否則跳過出牌階段。
-- deterrence = sgs.CreateTriggerSkill{ 
	-- name="deterrence",
	-- frequency=sgs.Skill_NotFrequent,
	-- events={sgs.EventPhaseEnd},
	-- can_trigger = function(self, target)
			-- return target and not target:hasSkill("deterrence")
		-- end,
	-- on_trigger=function(self,event,player,data)
		-- local room = player:getRoom()
		-- local Amae = room:findPlayerBySkillName(self:objectName())
		-- local ntarget = Amae:getNextAlive()
		-- if not Amae:isAlive() then return false end
		-- if player:getPhase() == sgs.Player_Draw and player:getHp() >= Amae:getHp() and (player:distanceTo(Amae) <= 1 or Amae:distanceTo(player) <= 1 or player:objectName() == ntarget:objectName()) and room:askForSkillInvoke(Amae, "deterrence", data) then
			-- local cards = player:getHandcards()
			-- local hastrick = false
			-- local card = nil
			-- for _,c in sgs.qlist(cards) do
				-- if c:isKindOf("TrickCard") then
					-- hastrick = true
					-- break
				-- end
			-- end
			-- if hastrick then
				-- card = room:askForExchange(player, "deterrence", 1,1, true, "@deterrenceAsk", false, "TrickCard")
			-- end
			-- if card == nil then
				-- player:skip(sgs.Player_Play)
			-- else
				-- local move2 = sgs.CardsMoveStruct()
				-- move2.card_ids:append(card:getEffectiveId())
				-- move2.to = Amae
				-- move2.to_place = sgs.Player_PlaceHand
				-- room:moveCardsAtomic(move2, false)
			-- end
			-- return false
		-- end
	-- end,
-- }
--[[
	技能名：撈月（锁定技）
	相关武将：天江
	描述：每当你的手牌数少於三，你须從氣牌堆中摸牌补至三张。
	引用：LuaXNosJuejing
	状态：1217验证通过
]]--

scoopthemoonup = sgs.CreateTriggerSkill{
	name = "scoopthemoonup",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.CardsMoveOneTime},
	on_trigger = function(self, event, player, data)
		if event == sgs.CardsMoveOneTime then
			local move = data:toMoveOneTime()
			local source = move.from
			local target = move.to
			if not source or source:objectName() ~= player:objectName() then
				if not target or target:objectName() ~= player:objectName() then
					return false
				end
			end
			if move.to_place ~= sgs.Player_PlaceHand then
				if not move.from_places:contains(sgs.Player_PlaceHand) then
					return false
				end
			end
			-- if player:getPhase() == sgs.Player_Discard then
				-- return false
			-- end
		end
		local count = player:getHandcardNum()
		if count == 3 then
			return false
		elseif count < 3 then
			local room = player:getRoom()
			local DiscardPile = room:getDiscardPile()
			if DiscardPile:length() <= 0 then return false end
			local counter = 0
			local lastnum = DiscardPile:length()
			if math.random(1, 10) > 6 then
				room:broadcastSkillInvoke("scoopthemoonup", math.random(1, 2))
			end
			for i = 1,3-count,1 do
				for _,cid in sgs.qlist(DiscardPile) do
					counter = counter + 1
					if counter == lastnum then
						local gain_card = sgs.Sanguosha:getCard(cid)
						room:moveCardTo(gain_card, player, sgs.Player_PlaceHand, true)
					end
				end
				counter = 0
				lastnum = DiscardPile:length()
				if lastnum <= 0 then break end
			end
		end
		return false
	end
}
-- 震懾：他與你或你與他距離為一的角色在摸牌階段摸牌後，若其體力值大於你，你可以令其在摸牌階段不摸牌，翻開牌堆頂上三張牌，取得其中的點數大於等於8的牌，如果剩餘的牌點數和於8以下(若全收則算0)，其必須打出一張錦囊牌否則跳過出牌階段。
deterrence = sgs.CreateTriggerSkill{
	name = "deterrence",
	frequency = sgs.Skill_NotFrequent,
	events = {sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data)
		if player:getPhase() == sgs.Player_Draw then
			local room = player:getRoom()
			for _, Amae in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
				local pdata = sgs.QVariant()
				pdata:setValue(player)
				if player:getHp() > Amae:getHp() and (player:distanceTo(Amae) <= 1 or Amae:distanceTo(player) <= 1) and room:askForSkillInvoke(Amae, "deterrence", pdata) then
					local ids = room:getNCards(3, false)
					local move = sgs.CardsMoveStruct()
					move.card_ids = ids
					move.to = player
					move.to_place = sgs.Player_PlaceTable
					move.reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_TURNOVER, player:objectName(), self:objectName(), nil)
					room:moveCardsAtomic(move, true)
					local dummy = DummyCard:clone()
					local dis = DummyCard:clone()
					local total = 0
					room:broadcastSkillInvoke("deterrence", math.random(1, 3))
					for _, id in sgs.qlist(ids) do
						if sgs.Sanguosha:getCard(id):getNumber() >= 8 then
							dummy:addSubcard(id)
						else
							dis:addSubcard(id)
							total = total + sgs.Sanguosha:getCard(id):getNumber()
						end
					end
					room:getThread():delay(800)		
					if total > 0 then
						local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_NATURAL_ENTER,
							player:objectName(), "deterrence", nil)
						room:throwCard(dis, reason, nil)
					else
						room:loseHp(player)
					end
					-- if total <= 8 then -- 跳過遊戲階段的判斷處，因太狂被砍
						-- if not room:askForCard(player, "TrickCard", "@deterrenceAsk", sgs.QVariant(), sgs.Card_MethodDiscard) then
							-- player:skip(sgs.Player_Play)
						-- end
					-- end
					if player:isAlive() then
						room:obtainCard(player, dummy)
					else
						local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_NATURAL_ENTER,
							player:objectName(), "deterrence", nil)
						room:throwCard(dummy, reason, nil)
					end
					-- player:loseAllMarks("ai_koromo")
					return true
				end
			end
			return false
		end
	end,
	can_trigger = function(self, target)
		return target and not target:hasSkill("deterrence")
	end,
}

--[[
	技能名：好勝
	相关武将：
	描述：每名目標一回合限一次。出牌階段你可以與一名目標拚點，贏了你可以獲得目標一張牌(包括判定區)，並失去所有X標記摸其量/2的牌(向下取整最少為一)，若你輸了你可以獲得一點X標記再拚點一次。
	引用：wannawin
	状态：1217验证通过
]]--
wannawinCard = sgs.CreateSkillCard{
	name = "wannawin",
	target_fixed = false,
	will_throw = true,
	filter = function(self, targets, to_select)
		if #targets == 0 then
			return to_select:objectName() ~= sgs.Self:objectName() and not (to_select:isKongcheng() or to_select:getMark("Wannawinmark") > 0)
		end
		return false
	end,
	on_effect = function(self, effect)
		local source = effect.from
		local target = effect.to
		local room = source:getRoom()
		local success = source:pindian(target, "wannawin", self)
		local data = sgs.QVariant()
		room:setPlayerMark(target, "Wannawinmark", 1)
		data:setValue(target)
		while not success do
			if target:isKongcheng() then
				break
			elseif source:isKongcheng() then
				break
			elseif source:askForSkillInvoke("wannawin", data) then
				success = source:pindian(target, "wannawin")
			else
				break
			end
		end
	end
}
wannawinvs = sgs.CreateViewAsSkill{
	name = "wannawin",
	n = 1,
	view_filter = function(self, selected, to_select)
		return not to_select:isEquipped()
	end,
	view_as = function(self, cards)
		if #cards == 1 then
			local wannawinCard = wannawinCard:clone()
			wannawinCard:addSubcard(cards[1])
			return wannawinCard
		end
	end,
	enabled_at_play = function(self, player)
		-- return not player:hasUsed("#wannawinCard")
		return true
	end
}
wannawin = sgs.CreateTriggerSkill{
	name = "wannawin",	
	events = {sgs.Pindian, sgs.EventPhaseStart},
	view_as_skill = wannawinvs,
	on_trigger = function(self, event, player, data)

		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish then
			local room = player:getRoom()
			for _,p in sgs.qlist(room:getOtherPlayers(player)) do
				room:setPlayerMark(p, "Wannawinmark", 0)
				-- room:setPlayerMark(p, "@book", 1)
			end
		elseif event == sgs.Pindian then
			local room = player:getRoom()
			local pindian = data:toPindian()
			if pindian.reason == "wannawin" then
				-- if pindian.from_card:getNumber() > pindian.to_card:getNumber() then
				if pindian.from_number > pindian.to_number then
					if not pindian.to:isAllNude() then
						local id = room:askForCardChosen(player, pindian.to, "jhe", "wannawin", false, sgs.Card_MethodNone)
						room:obtainCard(player, id)
					end
					-- local count = math.floor(player:getMark("@wannawin")/2)
					-- if count == 0 then count = 1 end
					-- player:drawCards(count)
					player:loseAllMarks("@wannawin")
				else
					player:gainMark("@wannawin")
				end
			end
		end
		return false
	end,
	can_trigger = function(self, target)
		return target:isAlive()
	end,
	priority = -1
}
--[[
	技能名：王牌
	相关武将：
	描述：鎖定技。你的拚點牌亮出後+2X(X為X標記數量)。當你打出或使用一張數字為A或13的牌(包括拚點牌且計算拚點加上去的點數，若拚點牌原本符合規則，加上點數後不符合的情況則視為符合)，你摸兩張牌。
	引用：theace
	状态：1217验证通过
]]--
theace = sgs.CreateTriggerSkill{
	name = "theace" ,
	frequency = sgs.Skill_Compulsory,
	-- events = {sgs.PindianVerifying, sgs.CardUsed, sgs.JinkEffect, sgs.PreCardResponded, sgs.EventPhaseStart} ,
	events = {sgs.PindianVerifying, sgs.CardUsed, sgs.PreCardResponded} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.CardUsed) or (event == sgs.PreCardResponded) then
			local card = nil
			if event == sgs.CardUsed then
				card = data:toCardUse().card
			else
				local response = data:toCardResponse()
				card = response.m_card
			end
			if card and not card:isKindOf("SkillCard") and (card:getNumber() == 1 or card:getNumber() == 13) then
				player:setFlags("-AceJink")
				player:setFlags("AceJink")
				room:sendCompulsoryTriggerLog(player, self:objectName())
				room:broadcastSkillInvoke("theace", math.random(1, 3))
				player:drawCards(1)
			end
		end
		if event == sgs.PindianVerifying then
			local pindian = data:toPindian()
			if player:getMark("@wannawin") > 0 then
				local to_add = player:getMark("@wannawin")*2
				pindian.from_number = pindian.from_number + to_add
			end
			if pindian.from_card:getNumber() == 1 or pindian.from_card:getNumber() == 13 or pindian.from_number == 13 then
				room:sendCompulsoryTriggerLog(player, self:objectName())
				room:broadcastSkillInvoke("theace", math.random(1, 3))
				player:drawCards(1)
			end
			data:setValue(pindian)
		end
		-- if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish then
			-- for _,p in sgs.qlist(room:getOtherPlayers(player)) do
				-- room:setPlayerMark(p, "Wannawinmark", 0)
			-- end
		-- end
		return false
	end ,
	can_trigger = function(self, target)
		return target and target:hasSkill("theace")
	end
}

--熱鬥：鎖定技。你每使用或打出一張殺，你獲得一點炙灼標記，若此殺被閃避，你額外獲得一點標記(以熱鬥打出的不算)。你可以棄置一枚灼熱標記視為使用或打出一張閃或火殺(以此使用的火殺不受次數限制)，或阻止敵人恢復體力，或跳過判定階段(若你擁有延時錦囊)並獲得那張延時錦囊。
-- hotfightCard = sgs.CreateSkillCard
-- {
	-- name = "hotfight",
	-- target_fixed = false,
	-- will_throw = false,
	-- filter = function(self,targets,to_select)
		-- if #targets < 1 then
			-- return sgs.Self:inMyAttackRange(to_select)
		-- end
		-- return false
	-- end,
	-- on_effect = function(self,effect)
		-- local from = effect.from
		-- local to = effect.to
		-- local room = from:getRoom()
		-- if to:isAlive() then 		
			-- local slash = sgs.Sanguosha:cloneCard("fire_slash",sgs.Card_NoSuit, 0)
		    -- slash:setSkillName("hotfight")
			-- local use = sgs.CardUseStruct()
			-- use.from = from
			-- use.to:append(to)
			-- use.card = slash
			-- room:useCard(use, false)
		-- end
	-- end,
-- }
hotfightvs = sgs.CreateZeroCardViewAsSkill{
	name = "hotfight",
	view_as = function(self)
		-- local acard = sgs.Sanguosha:cloneCard("fire_slash", sgs.Card_NoSuit, -1)
		-- acard:setSkillName(self:objectName())
		-- return acard
		local usereason = sgs.Sanguosha:getCurrentCardUseReason()
		if (usereason == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE) or (usereason == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE) then
			local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
			if pattern == "slash" then
				local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
				slash:setSkillName(self:objectName())
				return slash
			else
				local jink = sgs.Sanguosha:cloneCard("jink", sgs.Card_NoSuit, 0)
				jink:setSkillName(self:objectName())
				return jink
			end
		else
			local fslash = sgs.Sanguosha:cloneCard("fire_slash", sgs.Card_NoSuit, 0)
			fslash:setSkillName(self:objectName())
			return fslash
		end
		
	end,
	enabled_at_play = function(self, player)
		-- local card = sgs.Sanguosha:cloneCard("collateral", sgs.Card_NoSuit, 0)
		return player:getMark("@hotfightmark") > 0 and sgs.Slash_IsAvailable(player)
	end,
	enabled_at_response = function(self, target, pattern)
		return target:getMark("@hotfightmark") > 0 and ((pattern == "slash") or (pattern == "jink"))
	end
}
hotfight = sgs.CreateTriggerSkill{
	name = "hotfight",
	-- frequency = sgs.Skill_Compulsory,
	events = {sgs.PreHpRecover, sgs.EventPhaseStart},
	view_as_skill = hotfightvs,
	can_trigger = function(self, target)
    	return target
	end,
	on_trigger=function(self,event,player,data)
		local room = player:getRoom()
		local pdata = sgs.QVariant()
		pdata:setValue(player)
		for _,owner in sgs.list(room:findPlayersBySkillName(self:objectName()))do
			if (event == sgs.PreHpRecover) and owner:getMark("@hotfightmark") > 0 then
				local rec = data:toRecover()
				-- if (rec.who ~= owner) and room:askForSkillInvoke(owner, self:objectName(), sgs.QVariant(player:objectName())) then
				if (rec.who ~= owner) and room:askForSkillInvoke(owner, self:objectName(), pdata) then
					owner:loseMark("@hotfightmark")
					local log = sgs.LogMessage()
					log.type = "#hotfightlog"
					log.from = owner
					room:sendLog(log)
					return true
					-- rec.recover = rec.recover - 1
					-- if rec.recover < 0 then rec.recover = 0 end
					-- data:setValue(rec)
				end
			end
			if player:getPhase() == sgs.Player_Start and owner:objectName() == player:objectName() and player:getCards("j"):length() > 0
			and owner:getMark("@hotfightmark") > 0 and room:askForSkillInvoke(owner, self:objectName(), pdata) then
				-- local recov = sgs.RecoverStruct()
				-- recov.who = owner
				-- room:recover(player, recov)
				player:loseMark("@hotfightmark")
				player:skip(sgs.Player_Judge)
				-- if owner:getPhase() == sgs.Player_Start then 
				local cards = player:getJudgingArea()
				for _,cd in sgs.qlist(cards) do
					player:obtainCard(cd)
				end
				-- end
			end
		end
		return false
	end,
}
hotfightlm = sgs.CreateTriggerSkill{
	name = "#hotfightlm",
	events = {sgs.CardUsed, sgs.PreCardResponded, sgs.CardOffset},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.CardUsed) or (event == sgs.PreCardResponded) then
			local card = nil
			if event == sgs.CardUsed then
				card = data:toCardUse().card
			else
				local response = data:toCardResponse()
				card = response.m_card
			end
			if card and not card:isKindOf("SkillCard") and card:getSkillName() == "hotfight" then
				player:loseMark("@hotfightmark")
			end
			if player:getMark("@hotfightmark") < 5 and card and (card:isKindOf("Slash") or card:isKindOf("Jink")) and not card:isKindOf("SkillCard") and card:getSkillName() ~= "hotfight" then
				player:gainMark("@hotfightmark")
			end
		end
		if event == sgs.CardOffset then
			local effect = data:toCardEffect()
			if player:getMark("@hotfightmark") < 5 and effect.card:isKindOf("Slash") and effect.card:getSkillName() ~= "hotfight" then
				player:gainMark("@hotfightmark")
				-- if player:askForSkillInvoke(self:objectName(), data) then
					-- local to_throw = room:askForCardChosen(player, effect.to, "he", self:objectName(), false, sgs.Card_MethodDiscard)
					-- room:throwCard(sgs.Sanguosha:getCard(to_throw), effect.to, player)
				-- end
			end
		end
		return false
	end
}

fakebody = sgs.CreateTriggerSkill{
	name = "fakebody",
	events = {sgs.Damaged},
	can_trigger = function(self, target)
		return target and target:hasSkill(self:objectName())
	end,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		-- if event == sgs.Damaged and player:isAlive() and player:hasSkill(self:objectName()) then
		local damage = data:toDamage()
		local from = damage.from
		local count = from:getHp() - player:getHp()
		-- if player:isAlive() and player:getHandcardNum() < from:getHandcardNum() and count > 0
		if from and player:isAlive() and count >= 0 and player:getCards("he"):length() >= count and player:askForSkillInvoke(self:objectName(), data) then
		-- and player:getHandcardNum() >= count and room:askForDiscard(player, self:objectName(), count, count, true) then
			if count > 0 and room:askForDiscard(player,self:objectName(),count,count,true,true) then
				local theRecover = sgs.RecoverStruct()
				theRecover.recover = count
				theRecover.who = player
				room:recover(player, theRecover)
				room:loseHp(from, count)
				if from:hasSkill("chanyuan") then
					player:drawCards(1)
				else
					room:acquireSkill(from, "chanyuan")
				end
			elseif count == 0 then
				if from:hasSkill("chanyuan") then
					player:drawCards(1)
				else
					player:drawCards(1)
					room:acquireSkill(from, "chanyuan")
				end
			end
		end
		return false
	end
}

--演技
actingcard = sgs.CreateSkillCard
{
	name = "actingcard",
	target_fixed = false,
	will_throw = true,
	filter = function(self,targets,to_select,player)
		return (#targets < 1) and (to_select:objectName() ~= sgs.Self:objectName())
	end,
	on_effect = function(self,effect)
		local from = effect.from
		local to = effect.to
		local room = from:getRoom()
		local skills = to:getVisibleSkillList()
		-- local yoursskill = from:getVisibleSkillList()
		local skill_list = {}
		-- local your_list = {}
		room:setPlayerFlag(from, "-actingUsed")
		room:setPlayerFlag(from, "actingUsed")
		for _,skill in sgs.qlist(skills) do
			if not skill:inherits("SPConvertSkill") and not skill:isAttachedLordSkill() then
				-- table.insert(skill_list, skill:objectName())
				room:acquireSkill(from, skill:objectName())
				room:setPlayerMark(from, "acting"..skill:objectName(), 1)
			end
		end
	end,
	
	priority = -2
}

actingvs = sgs.CreateViewAsSkill{
	name = "acting",
	n=0,
	view_filter=function()
		return false
	end,
	view_as=function(self, cards)        
		return actingcard:clone()
	end,
	enabled_at_play=function(self,player) 
		return not player:hasFlag("actingUsed")
	end,
	enabled_at_response=function(self,player,pattern)
		return false
	end,
}

acting = sgs.CreateTriggerSkill{
	name = "acting",
	events = {sgs.EventPhaseEnd},
	view_as_skill = actingvs,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.EventPhaseEnd and player:getPhase() == sgs.Player_Draw then
			if not player:hasSkill("acting") then return false end
			-- local yoursskill = player:getVisibleSkillList()
			-- for _,ys in sgs.qlist(yoursskill) do
				-- if not ys:inherits("SPConvertSkill") and not ys:isAttachedLordSkill() and not ys:objectName() == "acting" then
					-- room:handleAcquireDetachSkills(player, "-"..ys:objectName())
				-- end
			-- end
			local skills = player:getVisibleSkillList()
			local detachList = {}
			for _,skill in sgs.qlist(skills) do
				if not skill:inherits("SPConvertSkill") and not skill:isAttachedLordSkill() and skill:objectName() ~= "acting" and skill:objectName() ~= "liketoplay" and player:getMark("acting"..skill:objectName()) > 0 then
					table.insert(detachList,"-"..skill:objectName())
					room:setPlayerMark(player, "acting"..skill:objectName(), 0)
				end
			end
			room:handleAcquireDetachSkills(player, table.concat(detachList,"|"))
		end
		return false

	end
}
-- 好玩
liketoplaycard = sgs.CreateSkillCard{
	name = "liketoplaycard",
	target_fixed = true,

	on_use = function(self, room, source, targets)
		
		local room = source:getRoom()
		if source:hasFlag("actingUsed") then
			source:drawCards(1,"liketoplay")
			room:setPlayerFlag(source, "-actingUsed")
		else
			source:drawCards(2,"liketoplay")
		end
	end
}
liketoplay = sgs.CreateViewAsSkill{
	name = "liketoplay" ,
	
	view_as = function()
		return liketoplaycard:clone()
	end ,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#liketoplaycard")
	end
}
--通曉 你可以摸兩張牌，然後選兩張牌任意排列在牌堆上，鎖定技，你的非延時錦囊牌不能以無懈可擊回應，你每使用或打出一張錦囊牌，你摸一张牌。

proficientcard = sgs.CreateSkillCard{
	name = "proficientcard",
	target_fixed = true,

	on_use = function(self, room, source, targets)
		local room = source:getRoom()
		source:drawCards(2,"proficient")
		local to_exchange = nil
		-- to_exchange = source:wholeHandCards()
		to_exchange = room:askForExchange(source, "proficient", 2,2, true, "@proficient", false)
		local ids = to_exchange:getSubcards()
		local card = nil
		local card_ids = sgs.IntList()
		for _,id in sgs.qlist(ids) do
			card = sgs.Sanguosha:getCard(id)
			if card:isKindOf("EquipCard") then
				room:throwCard(id, source)
			else
				card_ids:append(id)
				room:moveCardTo(card, source, sgs.Player_DrawPile, false)
			end
		end
		to_exchange:deleteLater()
		room:askForGuanxing(source, card_ids, sgs.Room_GuanxingUpOnly)
	end
}
proficient = sgs.CreateViewAsSkill{
	name = "proficient" ,
	
	view_as = function()
		return proficientcard:clone()
	end ,
	enabled_at_play = function(self, player)
		return true
	end
}

wisdom_ie = sgs.CreateTriggerSkill{
	name = "#wisdom_ie",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.CardUsed, sgs.CardResponded},
	on_trigger = function(self, event, player, data)
		local card
		if event == sgs.CardUsed then
			local use = data:toCardUse()
			card = use.card
			if card:isKindOf("TrickCard") and card:isNDTrick() then
				local no_offset_list = use.no_offset_list
				table.insert(no_offset_list, "_ALL_TARGETS")
				use.no_offset_list = no_offset_list
				data:setValue(use)
			end
			
		else
			local response = data:toCardResponse()
			card = response.m_card
		end
		if card and card:isKindOf("TrickCard") then
			player:drawCards(1,"proficient")
		end
		return false
	end
}

-- 終局：限定技，若你體力值唯一，你可以失去本技能，獲得技能開朗、摸三張牌，並令除自己以外全場每一名角色翻面、失去身上所有牌，該效果不會將其轉回正面。。

endingchoiceCard = sgs.CreateSkillCard{
	name = "endingchoiceCard" ,
	target_fixed = true ,
	on_use = function(self, room, source, targets)
		room:removePlayerMark(source, "@jueji")
		room:doLightbox("$tamaoendingchoice", 3000) --這是顯示字
		-- room:doSuperLightbox("tamao","endingchoice")--新版不支援
		-- room:getThread():delay(700)
		local players = room:getOtherPlayers(source)
		source:setFlags("endingchoiceUsing")
		for _, player in sgs.qlist(players) do
			if player:isAlive() then
				room:cardEffect(self, source, player)
			end
		end
		source:setFlags("-endingchoiceUsing")
	end ,
	on_effect = function(self, effect)
		local room = effect.to:getRoom()
		if (not effect.from) or effect.from:isDead() then return end
		if effect.from:hasSkill("endingchoice") then
			room:detachSkillFromPlayer(effect.from, "endingchoice")
			room:acquireSkill(effect.from, "cheerful")
			room:acquireSkill(effect.from, "iris")
			effect.from:drawCards(3)
		end
		-- local acards = effect.to:getCards("jhe")
		-- if acards:length() > 0 then
			-- effect.to:throwAllCards()
		-- end
		if effect.to:faceUp() then effect.to:turnOver() end
	end
}

endingchoiceVS = sgs.CreateViewAsSkill{
	name = "endingchoice" ,
	n = 0,
	view_as = function()
		return endingchoiceCard:clone()
	end ,
	enabled_at_play = function(self, player)
		return player:getMark("@jueji") >= 1 and player:getHp() == 1
	end
}
endingchoice = sgs.CreateTriggerSkill{
	name = "endingchoice" ,
	frequency = sgs.Skill_Limited,
	limit_mark = "@jueji",
	events = {},
	view_as_skill = endingchoiceVS,
	
	on_trigger = function()
	end
}
--舊慎思 寫法說明_在oneffect中 effect.from:setFlags 這種寫法將被無效，需用room:setPlayerFlag替代
-- 你可以丟棄一張手牌翻開牌堆上兩張牌，然後令一名目標獲得其中與棄置牌不同類型的牌，每一種牌類一回合僅能丟棄一次，若目標不為自己，下個回合開始前該技能無法指定同一個目標。
-- thinkhardCard = sgs.CreateSkillCard{
	-- name = "thinkhard" ,
	-- target_fixed = false,
	-- will_throw = true,
	-- filter = function(self, targets, to_select)
		-- return #targets < 1 and not to_select:hasFlag("thinkhardUsed")
	-- end, 
	-- feasible = function(self, targets)
		-- return #targets == 1
	-- end, 
	-- on_use = function(self, room, source, targets)
		-- source:setFlags("thinkhardUsing")
		-- for _,player in pairs(targets) do
			-- if player:isAlive() then
				-- room:cardEffect(self, source, player)
			-- end
		-- end
		-- source:setFlags("-thinkhardUsing")
	-- end ,
	-- on_effect = function(self, effect)
		-- local room = effect.from:getRoom()
		-- local subid = self:getSubcards():first()
		-- local scard = sgs.Sanguosha:getCard(subid)
		-- local cards = {}
		-- local cardIds = sgs.IntList()
		-- local count = 2
		-- for i=1, count, 1 do
			-- local id = room:drawCard()
			-- cardIds:append(id)
		-- end
		-- assert(cardIds:length() == count)
		-- local move = sgs.CardsMoveStruct()
		-- move.card_ids = cardIds
		-- move.to_place = sgs.Player_PlaceTable
		-- move.reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_TURNOVER, effect.from:objectName(), "", "thinkhard", "")
		-- room:moveCardsAtomic(move, true)
		-- room:getThread():delay()
		-- local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_NATURAL_ENTER, "", "thinkhard", "")
		-- local ctype = ".."
		-- if scard:isKindOf("BasicCard") then
			-- ctype = "BasicCard"
			-- room:setPlayerFlag(effect.from, "ThinkhardB")
		-- end
		-- if scard:isKindOf("TrickCard") then 
			-- ctype = "TrickCard" 
			-- room:setPlayerFlag(effect.from, "ThinkhardT")
		-- end
		-- if scard:isKindOf("EquipCard") then
			-- ctype = "EquipCard" 
			-- room:setPlayerFlag(effect.from, "ThinkhardE")
		-- end
		-- if effect.to:objectName() ~= effect.from:objectName() then room:setPlayerFlag(effect.to, "thinkhardUsed") end
		-- for i=0, count-1, 1 do
			-- local card_id = cardIds:at(i)
			-- local card = sgs.Sanguosha:getCard(card_id)
			-- if not card:isKindOf(ctype) then
				-- table.insert(cards, card)
			-- else
				-- room:throwCard(card, reason, nil)
			-- end
		-- end
		-- if #cards > 0 then
			-- for _,c in pairs(cards) do
				-- if effect.to:isAlive() then
					-- room:obtainCard(effect.to, c, true)
				-- end
			-- end
		-- end
	-- end
-- }

-- thinkhard = sgs.CreateOneCardViewAsSkill{
	-- name = "thinkhard",
	-- expand_pile = "wooden_ox",
	-- view_filter = function(self,to_select)    
		-- if to_select:isKindOf("BasicCard") and sgs.Self:hasFlag("ThinkhardB") then return false end      
		-- if to_select:isKindOf("TrickCard") and sgs.Self:hasFlag("ThinkhardT") then return false end      
		-- if to_select:isKindOf("EquipCard") and sgs.Self:hasFlag("ThinkhardE") then return false end
		-- return true		
	-- end,
	-- view_as = function(self, card)
		-- local acard = thinkhardCard:clone()
		-- acard:addSubcard(card)
		-- acard:setSkillName("thinkhard")
		-- return acard
	-- end,
	-- enabled_at_play = function(self,player)
		-- return not (player:hasFlag("ThinkhardT")and player:hasFlag("ThinkhardB") and player:hasFlag("ThinkhardE"))
	-- end,
	-- enabled_at_response = function(self, player, pattern)
		-- return false
	-- end,

-- }
-- 鳶尾：一名角色在回合內獲得手牌時，你可以棄置一張紅牌獲得那些牌。若獲得的牌中包含紅心牌，你摸一张牌。

iris = sgs.CreateTriggerSkill{
	name = "iris" ,
	events = {sgs.CardsMoveOneTime},

	on_trigger = function(self, event, player, data)
		if event == sgs.CardsMoveOneTime then
			local room = player:getRoom()
			local move = data:toMoveOneTime()
			if move.to and move.to:objectName() ~= player:objectName() and move.to:getPhase() == sgs.Player_Play and move.to:isAlive() and move.to_place == sgs.Player_PlaceHand then
				local allecard = DummyCard:clone()
				local haveh = false
				for _,cid in sgs.qlist(move.card_ids) do
					local card = sgs.Sanguosha:getCard(cid)
					allecard:addSubcard(card)
					if card:getSuit() == sgs.Card_Heart then
						haveh = true
					end
				end
				if room:askForCard(player, ".|red|.", "@iris_re", sgs.QVariant(), sgs.Card_MethodDiscard, player) then 
					room:obtainCard(player, allecard, false)
					if haveh then
						player:drawCards(1)
					end
				end
			end
		end
		return false
	end
}

-- 舊鳶尾：每當你使用或打出一張紅心牌你摸一张牌。當以下情況發生時，你可以令一目標打出一張紅色手牌否則受到一點傷害，傷害不會觸發非鎖定技。
-- 1.一名角色在回合外獲得手牌(將自動鎖定該角色)。2.你在回合外失去一張紅心牌。

-- iris = sgs.CreateTriggerSkill{
	-- name = "iris" ,
	-- events = {sgs.CardsMoveOneTime, sgs.CardUsed, sgs.CardResponded},

	-- on_trigger = function(self, event, player, data)
		-- local room = player:getRoom()
		-- if player:getMark("iris_turn_check") == 0 then
			-- for _,p in sgs.qlist(room:getAllPlayers()) do
				-- if p:getMark("@clock_time") > 0 then
					-- room:setPlayerMark(player, "iris_turn_check", 1)
					-- break
				-- end
			-- end
		-- end
		-- if event == sgs.CardsMoveOneTime then
			-- local move = data:toMoveOneTime()
			-- if move.from and player:objectName() == move.from:objectName() and player:getPhase() == sgs.Player_NotActive and (move.from_places:contains(sgs.Player_PlaceHand) or move.from_places:contains(sgs.Player_PlaceEquip)) then
				-- local list = room:getAlivePlayers()
				-- local guys = sgs.SPlayerList()
				-- for _,t in sgs.qlist(list) do
					-- if not t:hasSkill(self:objectName()) then
						-- guys:append(t)
					-- end
				-- end
				-- if guys:length() == 0 then return false end
				-- for _,cid in sgs.qlist(move.card_ids) do
					-- local card = sgs.Sanguosha:getCard(cid)
					-- if card:getSuit() == sgs.Card_Heart then
						-- local tar = room:askForPlayerChosen(player, guys, self:objectName(), "@iris_choiceplayer", true, true)
						-- if not tar then return false end
						-- if not room:askForCard(tar, ".|red|.|hand", "@iris_re", sgs.QVariant(), sgs.Card_MethodDiscard, player) then 
							-- room:setPlayerMark(tar, "@skill_invalidity", 1)
							-- room:damage(sgs.DamageStruct(self:objectName(),player,tar))
							-- room:setPlayerMark(tar, "@skill_invalidity", 0)
						-- end
					-- end
				-- end
			-- end
			-- if player:getMark("iris_turn_check") == 0 then return false end
			-- if move.to:objectName() ~= player:objectName() and move.to:getPhase() == sgs.Player_NotActive and move.to and move.to:isAlive() and move.to_place == sgs.Player_PlaceHand then
				-- local msg = sgs.LogMessage()
				-- msg.type, msg.arg, msg.arg2 = "#iris", "iris", move.to:getGeneralName()
				-- room:sendLog(msg)
				-- for _,p in sgs.qlist(room:getAllPlayers()) do
					-- if p:objectName() == move.to:objectName() then
						-- room:setPlayerMark(p, "AI_iris", 1)
						-- if room:askForSkillInvoke(player, self:objectName(), data) then
							-- if not room:askForCard(p, ".|red|.|hand", "@iris_re", sgs.QVariant(), sgs.Card_MethodDiscard, player) then 
								-- room:setPlayerMark(p, "@skill_invalidity", 1)
								-- room:damage(sgs.DamageStruct(self:objectName(),player,p))
								-- room:setPlayerMark(p, "@skill_invalidity", 0)
							-- end
						-- end
						-- break
					-- end
				-- end
			-- end
		-- elseif event == sgs.CardUsed or event == sgs.CardResponded then
			-- local card = nil
			-- if event == sgs.CardUsed then
				-- card = data:toCardUse().card
			-- else
				-- local response = data:toCardResponse()
				-- card = response.m_card
			-- end
			-- if (not card) or card:getSuit() ~= sgs.Card_Heart or card:isKindOf("EquipCard") or (card:getHandlingMethod() ~= sgs.Card_MethodUse and card:getHandlingMethod() ~= sgs.Card_MethodResponse) then return false end
			-- player:drawCards(1)
		-- end
		-- return false
	-- end
-- }


shywithpeople = sgs.CreateDistanceSkill{
	name = "shywithpeople" ,
	correct_func = function(self, from, to)
		local correct = 0
		if from:hasSkill(self:objectName()) or to:hasSkill(self:objectName()) then
			
			correct = correct + 2
		end
		if from:hasSkill("hidethepath") then correct = correct - 998 end
		return correct
	end
}
--甜伴：改為取消獲得，不取消則只獲得一個，沒有標記將不再翻面，回合開始即可選能力，而非進入出牌階段才可選(優點：加快節奏，不像以前必須跳過一回合。)
sweetsis = sgs.CreateTriggerSkill{
	name = "sweetsis",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.EventPhaseStart, sgs.GameStart},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.GameStart then
			player:gainMark("@cupcake", 3)
		end
		-- if sgs.event == EventPhaseStart and player:getPhase() == sgs.Player_Play then
		if sgs.event == EventPhaseStart and player:getPhase() == sgs.Player_Start then
			if not player:hasSkill(self:objectName()) then return false end
			-- if not player:getPile("hightention"):isEmpty() then
				-- room:broadcastSkillInvoke("nfever", math.random(1, 3))
				-- while not player:getPile("hightention"):isEmpty() do
					-- local cid = player:getPile("hightention"):last()
					-- local card = sgs.Sanguosha:getCard(cid)
					-- room:obtainCard(player, card)
					-- if player:getPile("hightention"):isEmpty() then
						-- break
					-- end
				-- end
			-- end
			local hadskill_list = player:getVisibleSkillList()
			local detachList = {}
			for _,dskill in sgs.qlist(hadskill_list) do
				if dskill:objectName() == "angel" or dskill:objectName() == "moveliketrigger" or dskill:objectName() == "dressing" or dskill:objectName() == "nfever" or dskill:objectName() == "toleranceIsAVirtue" or dskill:objectName() == "hidethepath" then
					table.insert(detachList,"-"..dskill:objectName())
				end
			end
			room:handleAcquireDetachSkills(player, table.concat(detachList,"|"))
			player:gainMark("@cupcake")
			if player:getMark("@cupcake") > 0 then
				local x = player:getMark("@cupcake")
				local your_list = {}
				local skill_list = {"angel" ,"moveliketrigger" ,"dressing" ,"nfever" ,"toleranceIsAVirtue", "hidethepath"}
				if x > 6 then x = 6 end
				for i = 0, x, 1 do
					if i == 0 then
						table.insert(your_list, "cancel")
					else
						table.insert(your_list, i)
					end
				end
				local choicen =room:askForChoice(player, "sweetsis", table.concat(your_list, "+"))
--若用if判斷choicen為0，即便選了零也無效，若條件改<1，則直接算你錯誤程式碼。使用not和==nil也無效，改成文字後就修復了，顯然選擇出的字雖然是數字但也不太算是數字。
                if choicen == "cancel" then 
					player:gainMark("@cupcake", 2)
					return false
				end
				choicen =  tonumber(choicen)
				player:loseMark("@cupcake", choicen)
				for i = 1, choicen, 1 do
					local hadskill_list = player:getVisibleSkillList()
					for _,skill in sgs.qlist(hadskill_list) do
						if skill:objectName() == "angel" or skill:objectName() == "moveliketrigger" or skill:objectName() == "dressing" or skill:objectName() == "nfever" or skill:objectName() == "toleranceIsAVirtue" or skill:objectName() == "hidethepath" then
							table.removeOne(skill_list, skill:objectName())
						end
					end
					local skill_name = room:askForChoice(player, "sweetsis", table.concat(skill_list, "+"))
					if skill_name == "angel" then room:broadcastSkillInvoke("sweetsis", 1) end
					if skill_name == "moveliketrigger" then room:broadcastSkillInvoke("sweetsis", 2) end
					if skill_name == "dressing" then room:broadcastSkillInvoke("sweetsis", 3) end
					if skill_name == "nfever" then room:broadcastSkillInvoke("sweetsis", 4) end
					if skill_name == "toleranceIsAVirtue" then room:broadcastSkillInvoke("sweetsis", 5) end
					if skill_name == "hidethepath" then room:broadcastSkillInvoke("sweetsis", 6) end
					room:acquireSkill(player, skill_name)
				end
			end
		end
		if sgs.event == EventPhaseStart and player:getPhase() == sgs.Player_Finish then
			if player:hasSkill("toleranceIsAVirtue") then
				if not player:hasSkill("nfever") then
					room:acquireSkill(player, "nfever")
				end
				room:broadcastSkillInvoke("toleranceIsAVirtue", math.random(1, 2))
			end
			-- if player:getMark("@cupcake") == 0 then 
				-- player:gainMark("@cupcake", 2 + player:getLostHp()*2)
				-- player:turnOver()
			-- end
		end
		return false
	end
}

-- sweetsisClear = sgs.CreateTriggerSkill{
	-- events = {sgs.EventLoseSkill} ,
	-- name = "#sweetsisClear" ,
	-- on_trigger = function(self, event, player, data)
		-- local room = player:getRoom()
		-- if event == sgs.EventLoseSkill then
			-- if data:toString() == "sweetsis" then
				-- if not player:getPile("hightention"):isEmpty() then
					-- player:clearOnePrivatePile("hightention")
				-- end
			-- end
		-- end
		-- return false
	-- end ,
	-- can_trigger = function(self, target)
		-- return target
	-- end ,
-- }
--天使：你的桃恢復能力+1，妳的紅心牌視作桃。

angelvs = sgs.CreateViewAsSkill{
	name = "angel",
	n = 1,
	view_filter = function(self, selected, to_select)
		if #selected == 0 then
			return to_select:getSuit() == sgs.Card_Heart and not to_select:isKindOf("Peach")
		end
		return false
	end,
	view_as = function(self, cards)
		if #cards == 1 then
			local card = cards[1]
			local suit = card:getSuit()
			local point = card:getNumber()
			local id = card:getId()
			local peach = sgs.Sanguosha:cloneCard("peach", suit, point)
			peach:setSkillName(self:objectName())
			peach:addSubcard(id)
			return peach
		end
		return nil
	end,
	enabled_at_play = function(self, player)
		if not player:isNude() then
			local hcn = player:getHandcards()
			local n = player:getEquips()
			local x = 0
			for _,card in sgs.qlist(hcn) do
				if card:getSuit() == sgs.Card_Heart then
					x = x + 1
				end
			end
			for _,e in sgs.qlist(n) do
				if e:getSuit() == sgs.Card_Heart then
					x = x + 1
				end
			end
			if x > 0 then return player:isWounded() end
		end
		return false
	end,
	enabled_at_response = function(self, player, pattern)
		-- local phase = player:getPhase()
		-- if phase == sgs.Player_NotActive then
			return string.find(pattern, "peach")
		-- end
		-- return false
	end
}
angel = sgs.CreateTriggerSkill{
	name = "angel" ,
	events = {sgs.PreHpRecover, sgs.CardUsed, sgs.CardResponded} ,
	view_as_skill = angelvs,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.PreHpRecover then
			local rec = data:toRecover()
			if rec.card and (rec.card:isKindOf("Peach")) then
				for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
					if p:hasFlag("Angeltar") then
						rec.recover = rec.recover + 1
						p:setFlags("-Angeltar")
					end
				end
				data:setValue(rec)
			end
		end
		if event == sgs.CardUsed or event == sgs.CardResponded then
			local card = nil
			
			if event == sgs.CardUsed then
				card = data:toCardUse().card
			else
				local response = data:toCardResponse()
				card = response.m_card
			end
			local use = data:toCardUse()
			if card and use.from:hasSkill("angel") and card:isKindOf("Peach") then
				use.from:setFlags("Angeltar")
			end
		end
		return false
	end,
	can_trigger = function(self, target)
		return target
	end
}
--好動 鎖定技。妳的殺無視距離限制，且妳可以額外使用一張殺，並至多指定兩人。
moveliketrigger = sgs.CreateTargetModSkill{--or (from:isMale() and from:hasSkill("changesexual")))
	name = "moveliketrigger",
	pattern = "Slash",
	extra_target_func = function(self, player, card)
		if player and player:hasSkill("moveliketrigger") then
			return 1
		end
	end,
	distance_limit_func = function(self, player, card)
		if player and player:hasSkill("moveliketrigger") then
			return 998
		end
	end
}
--打扮 妳可以棄置X張手牌，選擇一名角色X張裝備牌移至另一名角色身上。
dressingcard = sgs.CreateSkillCard{
    name = "dressing",
    will_throw = true,
    target_fixed = false,
    filter = function(self,targets,to_select,player)
        if #targets == 0 then
			return (to_select:objectName() ~= sgs.Self:objectName()) and to_select:getEquips():length() > 0 and to_select:getEquips():length() >= self:getSubcards():length()
		end
		return false
    end,
    on_effect=function(self,effect)          
        local room = effect.from:getRoom()
		local count = self:subcardsLength()
		for i = 1, count, 1 do
			if effect.to:getEquips():length() == 0 then break end
			local card_id = room:askForCardChosen(effect.from, effect.to, "e", self:objectName())
			local card = sgs.Sanguosha:getCard(card_id)
			local place = room:getCardPlace(card_id)
			local tos = sgs.SPlayerList()
			local list = room:getAlivePlayers()
			for _,p in sgs.qlist(list) do
				if p:objectName() ~= effect.to:objectName() then
					tos:append(p)
				end
			end
			if (not tos:isEmpty()) then
				local to = room:askForPlayerChosen(effect.from, tos, "dressing", ("dressing_moveto:%s"):format(card:objectName()), false, false)
				if card:isKindOf("Weapon") and to:getWeapon() ~= nil then room:throwCard(to:getWeapon(), to, to) end
				if card:isKindOf("DefensiveHorse") and to:getDefensiveHorse() ~= nil then room:throwCard(to:getDefensiveHorse(), to, to) end
				if card:isKindOf("OffensiveHorse") and to:getOffensiveHorse() ~= nil then room:throwCard(to:getOffensiveHorse(), to, to) end
				if card:isKindOf("Armor") and to:getArmor() ~= nil then room:throwCard(to:getArmor(), to, to) end
				if card:isKindOf("Treasure") and to:getTreasure() ~= nil then room:throwCard(to:getTreasure(), to, to) end
				room:moveCardTo(card, to, place, true)
			end
		end
	 end
}

dressing = sgs.CreateViewAsSkill{
	name = "dressing",
	n = 999,
	view_filter = function(self, selected, to_select)
		return not to_select:isEquipped()
	end,
	view_as = function(self, cards)
		if #cards > 0 then
			local d_card = dressingcard:clone()
			for _,card in pairs(cards) do
				d_card:addSubcard(card)
			end
			d_card:setSkillName("dressing")
			return d_card
		end
	end,
	enabled_at_play = function(self, player)
		return true
	end,
	enabled_at_response = function(self, player, pattern)
		return false
	end
}
--奮勇：每次妳成為目標，摸一张牌。
nfever = sgs.CreateTriggerSkill{
	name = "nfever" ,
	events = {sgs.TargetConfirming, sgs.ChainStateChanged} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.ChainStateChanged then
			if player:isChained() and player:getHandcardNum() > player:getHp() then
				room:broadcastSkillInvoke("nfever", math.random(1, 3))
				player:setChained(false)
				room:broadcastProperty(player, "chained")
				room:setEmotion(player, "chain")
				room:getThread():trigger(sgs.ChainStateChanged, room, player)
			end
		end
		local use = data:toCardUse()
		-- if use.card and use.to:contains(player) and player:hasSkill("sweetsis") and player:hasSkill("nfever") and not use.card:isKindOf("SkillCard") then
		if use.card and use.to:contains(player) and player:hasSkill("nfever") and not use.card:isKindOf("SkillCard") then
			player:drawCards(1)
			-- if player:getPile("hightention"):length() < 5 then
				-- local id = room:drawCard()
				-- player:addToPile("hightention", id)
			-- else
			if player:getHandcardNum() > player:getHp() then
				-- if not player:faceUp() then
					-- room:broadcastSkillInvoke("nfever", math.random(1, 3))
					-- player:turnOver()
				-- end
				-- if player:isChained() then
					-- room:broadcastSkillInvoke("nfever", math.random(1, 3))
					-- player:setChained(false)
					-- room:broadcastProperty(player, "chained")
					-- room:setEmotion(player, "chain")
					-- room:getThread():trigger(sgs.ChainStateChanged, room, player)
				-- end
				if player:getCards("j"):length() > 0 then
					room:broadcastSkillInvoke("nfever", math.random(1, 3))
					local ecards = player:getCards("j")
					local allecard = DummyCard:clone()
					for _,dis in sgs.qlist(ecards) do
						allecard:addSubcard(dis)
					end
					room:throwCard(allecard, player)
				end
			end
		end
		return false
	end
}
--有容：妳的手牌上限+3，回合結束時妳請來小依陪同。
toleranceIsAVirtue = sgs.CreateMaxCardsSkill{
	name = "toleranceIsAVirtue" ,
	extra_func = function(self, target)
		if target:hasSkill("toleranceIsAVirtue") then 
			return 3
		end
	end
}
--匿蹤：妳與其他人的距離改為一，妳的菱形牌可以當作順手牽羊使用。(修改距離的部分和"避俗"合併)
hidethepath = sgs.CreateOneCardViewAsSkill{
	name = "hidethepath", 
	-- filter_pattern = ".|diamond|.|hand",
	filter_pattern = ".|diamond",
	response_or_use = true,
	view_as = function(self, originalCard) 
		local snatch = sgs.Sanguosha:cloneCard("snatch", originalCard:getSuit(), originalCard:getNumber())
		snatch:addSubcard(originalCard:getId())
		snatch:setSkillName(self:objectName())
		return snatch
	end, 
	enabled_at_play = function(self, player)
		if not player:isNude() then
			local hcn = player:getHandcards()
			local n = player:getEquips()
			local x = 0
			for _,card in sgs.qlist(hcn) do
				if card:getSuit() == sgs.Card_Diamond then
					x = x + 1
				end
			end
			for _,e in sgs.qlist(n) do
				if e:getSuit() == sgs.Card_Diamond then
					x = x + 1
				end
			end
			if x > 0 then return true end
		end
		return false
	end
}

-- yuejianef = sgs.CreateTriggerSkill{
	-- name = "#yuejianef" ,
	-- events = {sgs.TargetConfirming} ,
	-- on_trigger = function(self, event, player, data)
		-- local room = player:getRoom()
		-- local use = data:toCardUse()
		-- if use.card and not use.from:hasFlag("NO_yuejian_buff") and not (use.to:contains(use.from) and use.to:length() <=1 ) and not use.card:isKindOf("SkillCard") then
			-- use.from:setFlags("NO_yuejian_buff")
		-- end
		-- return false
	-- end,
	-- can_trigger = function(self, target)
		-- return target
	-- end
-- }
-- yuejian = sgs.CreateTriggerSkill{
	-- name = "yuejian",
	-- frequency = sgs.Skill_NotFrequent,
	-- events = {sgs.EventPhaseChanging},
	-- on_trigger = function(self, event, player, data, room)
			-- local room = player:getRoom()
			-- local change = data:toPhaseChange()
			-- local from = room:findPlayerBySkillName(self:objectName())
			-- if change.to == sgs.Player_Discard and not player:hasFlag("NO_yuejian_buff") and room:askForSkillInvoke(from, self:objectName()) then
				-- if not player:isSkipped(sgs.Player_Discard) then
					-- player:setFlags("Yuejianbuff")
					-- player:setFlags("-NO_yuejian_buff")
				-- end
			-- else
				-- return false
			-- end
			-- return false
	-- end,
	-- can_trigger = function(self, target)
		-- return target
	-- end
-- }

turnedcard = sgs.CreateSkillCard{
	name = "turned",
	target_fixed = false,
	will_throw = false,
	once = true,
	
	filter = function(self, targets, to_select, player)
		if to_select:objectName() == player:objectName() then return false end
		if #targets > 0 then return false end
		return not to_select:isKongcheng()
	end,
	
	on_use = function(self, room, source, targets)
		local from = source
		local to   = targets[1]
		local card_id = room:askForCardChosen(from, to, "h", "turned")
		local n = 0
		room:obtainCard(from, card_id, false)
		n = n + 1
		if not to:isKongcheng() then
			-- local choice = room:askForChoice(from, self:objectName(), "yes_sw+no_sw")
			-- if choice == "yes_sw" then
				card_id = room:askForCardChosen(from, to, "h", "turned")
				room:obtainCard(from, card_id, false)
				n = n + 1
			-- end
		end

		local to_goback = nil
		if from:getMark("@SuperLimitBreak") > 0 then n = n-1 end
		if n > 0 then
			to_goback = room:askForExchange(from, "turned", n, n)
			room:moveCardTo(to_goback, to, sgs.Player_PlaceHand, false)
		end
		room:setPlayerFlag(from, "turnedused")
	end,	
}

turned = sgs.CreateViewAsSkill{
	name = "turned",	
	n = 0,
	
	view_as = function()
		return turnedcard:clone()		
	end,
	
	enabled_at_play = function(self, player)
		return not player:hasUsed("#turned")
	end,
}

-- dmganima = sgs.CreateTriggerSkill{
	-- name = "dmganima",
	-- frequency = sgs.Skill_Compulsory,
	-- events = {sgs.PreDamageDone},
	-- priority = -4,
	-- global = true,
	-- on_trigger = function(self, event, player, data)
		-- local room = player:getRoom()
		-- local damage = data:toDamage()
		-- if damage.damage > 0 then 
			-- room:setEmotion(player, "destroy")
		-- end
		-- return false
	-- end,
	-- can_trigger = function(self, target)
		-- return target
	-- end
-- }
--樂團：當你的手牌數大於體力值，你可以棄置所有手牌，然後摸等同於體力值的牌。之後你額外獲得行動階段。
lovetoevo = sgs.CreateTriggerSkill{
	name = "lovetoevo" ,
	events = {sgs.TurnStart} ,
	on_trigger = function(self, event, player, data)
		if not player then return false end
		local room = player:getRoom()
		if player and player:getHandcardNum() > player:getHp() then
			if player:askForSkillInvoke(self:objectName()) then
				room:broadcastSkillInvoke("lovetoevo", math.random(1, 6))
				player:throwAllHandCards()
				player:drawCards(player:getHp())
				player:gainAnExtraTurn()
			end
		end
		return false
	end ,
}
--畢業
graduation = sgs.CreateTriggerSkill{
	name = "graduation",
	frequency = sgs.Skill_Wake,
	waked_skills = "songforatsu,newmember",
	events = {sgs.TurnStart},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if player:getMark("@SuperLimitBreak")> 0 and player:isWounded() then
			player:gainMark("@k-on", 1+player:getLostHp())
		else
			player:gainMark("@k-on", 1)
		end
		
		if player:getMark("@k-on") > 4 or player:canWake(self:objectName()) then
			room:broadcastSkillInvoke("graduation", 1)
			room:setEmotion(player, "skill/yuri_graduation")
			room:addPlayerMark(player, self:objectName())
			room:changeMaxHpForAwakenSkill(player, -1, self:objectName())
			room:acquireSkill(player, "songforatsu")
			room:acquireSkill(player, "newmember")
			if player:isWounded() then
				local count = player:getLostHp()
				if count > 2 then count = 2 end
				local recover = sgs.RecoverStruct()
				recover.who = player
				recover.recover = count
				room:recover(player, recover)
			end
		end
	end,
	can_trigger = function(self, target)
		if target:getMark(self:objectName()) == 0 and target:hasSkill("graduation") then
			return true
		end
		return false
	end
}
--終曲：一名目標瀕死求桃時，你可以棄置等同於其最大生命的輕音標記，令其取消求桃，並將體力值恢復至一點

songforatsu = sgs.CreateTriggerSkill{
	name = "songforatsu",
	events = sgs.AskForPeaches,
	-- view_as_skill = songforatsuVA,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local dying = data:toDying()
		local who = dying.who
		-- if who:objectName() == user:objectName() then return end
		for _, user in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
			if who:getMaxHp() > user:getMark("@k-on") then continue end
			if not (player:hasFlag("Songforatsuno") or player:hasFlag("Songforatsuyes")) and room:askForSkillInvoke(user, self:objectName(), data) then
				user:loseMark("@k-on", who:getMaxHp())
				room:broadcastSkillInvoke("songforatsu", math.random(1, 8))
				for _,p in sgs.qlist(room:getAlivePlayers()) do
					room:setPlayerFlag(p,"Songforatsuno")
					-- p:gainMark("@book")
				end
			elseif not (player:hasFlag("Songforatsuno") or player:hasFlag("Songforatsuyes")) then
				for _,p in sgs.qlist(room:getAlivePlayers()) do
					room:setPlayerFlag(p,"Songforatsuyes")
					-- p:gainMark("@bear")
				end
			end
			if player:hasFlag("Songforatsuno") then
				-- player:loseAllMarks("@book")
				-- room:setPlayerFlag(who,"-Songforatsuno")
				local num = 1 - who:getHp()
				room:recover(who, sgs.RecoverStruct(user, nil, num))
				for _,p in sgs.qlist(room:getAlivePlayers()) do
					room:setPlayerFlag(p,"-Songforatsuno")
					-- p:loseAllMarks("@book")
				end
				return true
			elseif player:hasFlag("Songforatsuyes") then
				-- player:loseAllMarks("@bear")
				room:setPlayerFlag(player,"-Songforatsuyes")
				return
			end
		end
	end,
	can_trigger = function()
		return true 
	end
}
--再臨：鎖定技。每當你受到傷害時，你獲得一枚輕音標記，如果你的輕音標記少於四點，你摸一张牌。
newmember = sgs.CreateTriggerSkill{
	name = "newmember",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.Damaged},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()
		local x = damage.damage
		for i = 0, x - 1, 1 do
			if not player:isAlive() then return end
			player:gainMark("@k-on")
			if player:getMark("@k-on") < 4 then player:drawCards(1) end
		end
		return false
	end
}


yindun = sgs.CreateTriggerSkill
{
	name = "yindun",
	events = {sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data)
	    local room = player:getRoom()
	if player:getPhase() == sgs.Player_Finish and room:askForSkillInvoke(player, self:objectName(), data) then
	    room:broadcastSkillInvoke(self:objectName())
		player:drawCards(1)
		player:turnOver()
	end
	end,
}

yindunp = sgs.CreateProhibitSkill
{
	name = "#yindunp",
	is_prohibited = function(self, from, to, card)
		if(to and to:hasSkill("yindun") and not to:faceUp()) then
			return card:isKindOf("Slash")
		end
	end,
}

anshalist = {}
ansha = sgs.CreateTriggerSkill{
    name = "ansha",
    events = {sgs.CardsMoveOneTime,sgs.EventPhaseEnd},
    priority = -1,
    can_trigger = function(self, player)
        return true
    end,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
		local allplayers = room:findPlayersBySkillName(self:objectName())
	if event == sgs.CardsMoveOneTime then
		local move = data:toMoveOneTime()
		if room:getCurrent():getPhase() ~= sgs.Player_Discard then return false end
		for _,card_id in sgs.qlist(move.card_ids) do
			local flag = bit32.band(move.reason.m_reason, sgs.CardMoveReason_S_MASK_BASIC_REASON)
			if flag == sgs.CardMoveReason_S_REASON_DISCARD and room:getCardPlace(card_id) == sgs.Player_DiscardPile then
                table.insert(anshalist, card_id)
			end
        end
	end
	if event == sgs.EventPhaseEnd then
        if #anshalist == 0 or player:getPhase() ~= sgs.Player_Discard then return false end
		while #anshalist > 0 do
	        table.remove(anshalist)
	    end
		for _,selfplayer in sgs.qlist(allplayers) do
            if selfplayer:objectName() == player:objectName() or
			selfplayer:faceUp() or
			selfplayer:isNude() then continue end
			if room:askForSkillInvoke(selfplayer, self:objectName(), data) then
				room:broadcastSkillInvoke(self:objectName())
				room:askForDiscard(selfplayer, "ansha", 1, 1, false, true)
				if not selfplayer:faceUp() then
					selfplayer:turnOver()
				end
				room:doAnimate(1, selfplayer:objectName(), player:objectName())
				room:loseHp(player)
			end
		end
	end
    end,
}
-- 百剛烈：受到傷害時棄置目標一張裝備牌與手牌，若對方沒有裝備，則造成一點傷害。
yuriganglie = sgs.CreateTriggerSkill{
	name = "yuriganglie",
	events = {sgs.Damaged},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.Damaged then
			if player:isAlive() and player:hasSkill(self:objectName()) then
				local damage = data:toDamage()
				local from = damage.from
				if (not from) or from:objectName() == player:objectName() then return end
				for i = 0, damage.damage - 1, 1 do
					if from:isDead() then return end
					if room:askForSkillInvoke(player, self:objectName(), data) then
						room:broadcastSkillInvoke("ganglie", math.random(1, 2))
						if from:getCards("e"):length() < 1 then
							room:damage(sgs.DamageStruct(self:objectName(), player, from))
						else
							if player:canDiscard(from, "e") then
								local id = room:askForCardChosen(player, from, "e", self:objectName(), false, sgs.Card_MethodDiscard)
								room:throwCard(id, from, player)
								if player:canDiscard(from, "h") then
									local hid = room:askForCardChosen(player, from, "h", self:objectName(), false, sgs.Card_MethodDiscard)
									room:throwCard(hid, from, player)
								end
							end
						end
					end
				end
			end
		end
		return false
	end
}

--驍勇

braveheart = sgs.CreateTriggerSkill{   
	frequency = sgs.Skill_Compulsory,       
	name = "braveheart",            
	events = {sgs.DrawNCards},
	on_trigger = function(self, event, player, data)        
		local room = player:getRoom()     
		local draw = data:toDraw()
		if draw.reason ~= "draw_phase" then return false end                   
		if player:getLostHp() > 0 then
			-- room:broadcastSkillInvoke("braveheart")
			local n = player:getLostHp()+1
			if n > 3 then n = 3 end
			-- room:setPlayerMark(player, "BraveheartCounter", n)
			draw.num = draw.num + n
			data:setValue(draw)        
       end
   end
}

--歷練

fightingexper = sgs.CreateTriggerSkill{
	name = "fightingexper",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.HpChanged},
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
		local int = 0
		if player:getPile("fc"):length() > 4 then return end
		if data:toDamage() and data:toDamage().damage > 0 then
			int = data:toDamage().damage
		elseif data:toInt() > 0 then
			int = data:toInt()
		end
		if int > 0 then
			for i = 1,int,1 do
				local cid = room:drawCard()
				if player:getPile("fc"):length() >= 5 then break end
				player:addToPile("fc", cid)
			end
			if player:getPile("fc"):length() > 0 and not player:hasSkill("hubi") then room:acquireSkill(player, "hubi") end
			if player:getPile("fc"):length() > 1 and not player:hasSkill("braveheart") then room:acquireSkill(player, "braveheart") end
			if player:getPile("fc"):length() > 2 and not player:hasSkill("yuri_hagaku") then room:acquireSkill(player, "yuri_hagaku") end
			if player:getPile("fc"):length() > 3 and not player:hasSkill("yuriganglie") then room:acquireSkill(player, "yuriganglie") end
			if player:getPile("fc"):length() > 4 and not player:hasSkill("fightingclimax") then room:acquireSkill(player, "fightingclimax") end
			-- if player:getPile("fc"):length() == 5 and player:isWounded() then room:recover(player,sgs.RecoverStruct(player,self)) end
			-- if player:getMark("@SuperLimitBreak") > 0 and player:getPile("fc"):length() > 4 and not player:hasSkill("goldentear") then room:acquireSkill(player, "goldentear") end
		end
	end
}
--熊嵐
fightingclimaxcard = sgs.CreateSkillCard{
	name = "fightingclimax",
	target_fixed = true,
	will_throw = false,
	on_use = function(self, room, source, targets)
		local room = source:getRoom()
		local fc = source:getPile("fc")
		local card = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
		local tos = room:getOtherPlayers(source)
		card:addSubcards(fc)
		room:obtainCard(source, card)
		-- room:doSuperLightbox("kumaarasu","fightingclimax")
		room:setEmotion(source, "skill/yuri_fightingclimax")
		room:getThread():delay(700)
		for _, to in sgs.qlist(tos) do
			if to:isAlive() then
				room:setPlayerMark(to, "@all_skill_invalidity", 1)
				local LSinvalid_skills = to:getTag("LSinvalidSkills"):toString():split("+")
				local skills = to:getVisibleSkillList()
				for _, skill in sgs.qlist(skills) do
					room:addPlayerMark(to, "Qingcheng"..skill:objectName())
					table.insert(LSinvalid_skills, skill:objectName())
				end
				to:setTag("LSinvalidSkills", sgs.QVariant(table.concat(LSinvalid_skills, "+")))
				room:setPlayerMark(to, "Equips_Nullified_to_Yourself", 1)
			end
		end
	end,
}

fightingclimaxvs = sgs.CreateZeroCardViewAsSkill{
	name = "fightingclimax",
	view_as = function(self)
	    local acard = fightingclimaxcard:clone()
		acard:setSkillName(self:objectName())
		return acard
	end,
	enabled_at_play = function(self, player)
		return player:getPile("fc"):length() == 5
	end
}

fightingclimax = sgs.CreateTriggerSkill{
	name = "fightingclimax",
	frequency = sgs.Skill_Limited,
	view_as_skill = fightingclimaxvs,
	events={sgs.EventPhaseStart,sgs.Death,sgs.TargetConfirming},
	can_trigger = function(self, target)
    	return true
	end,
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if event == sgs.Death and data:toDeath().who:hasSkill(self:objectName()) then
			for _,p in sgs.qlist(room:getOtherPlayers(player)) do
			-- room:removePlayerMark(damage.to, "Equips_Nullified_to_Yourself")
				if p:getMark("@all_skill_invalidity") > 0 then
					room:setPlayerMark(p, "@all_skill_invalidity", 0)
					local LSinvalid_skills = p:getTag("LSinvalidSkills"):toString():split("+")
					for _, skill_name in ipairs(LSinvalid_skills) do
						room:removePlayerMark(p, "Qingcheng"..skill_name)
					end
					p:setTag("LSinvalidSkills", sgs.QVariant())
				end
				if p:getMark("Equips_Nullified_to_Yourself") > 0 then
					room:setPlayerMark(p, "Equips_Nullified_to_Yourself", 0)
				end
			end
		end
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish then
			if player:getMark("@all_skill_invalidity") > 0 then
				room:setPlayerMark(player, "@all_skill_invalidity", 0)
				local LSinvalid_skills = player:getTag("LSinvalidSkills"):toString():split("+")
				for _, skill_name in ipairs(LSinvalid_skills) do
					room:removePlayerMark(player, "Qingcheng"..skill_name)
				end
				player:setTag("LSinvalidSkills", sgs.QVariant())
			end
			if player:getMark("Equips_Nullified_to_Yourself") > 0 then
				room:setPlayerMark(player, "Equips_Nullified_to_Yourself", 0)
			end
		end
		return false
	end,
}
LSEClear = sgs.CreateTriggerSkill{ -- can_trigger標示 target的技能不能當公廁
	name = "#LSEClear" ,
	events = {sgs.EventLoseSkill} ,
	on_trigger = function(self, event, player, data)
		if data:toString() == "fightingclimax" then
			local room = player:getRoom()
			for _,p in sgs.qlist(room:getOtherPlayers(player)) do
				if p:getMark("@all_skill_invalidity") > 0 then
					room:setPlayerMark(p, "@all_skill_invalidity", 0)
					local LSinvalid_skills = p:getTag("LSinvalidSkills"):toString():split("+") -- 當禪院被使用時，這個要開(有用)
					for _, skill_name in ipairs(LSinvalid_skills) do
						room:removePlayerMark(p, "Qingcheng"..skill_name)
					end
					p:setTag("LSinvalidSkills", sgs.QVariant())
					room:setPlayerMark(p, "Equips_Nullified_to_Yourself", 0)
				end
			end
		end
	end,
	can_trigger = function(self, target)
		return target
	end ,
}	

--抗末：階段技，你可以選出棄牌堆中所有團體錦囊和寶物然後洗牌，你摸一其中一張，並將其他的置入棄牌堆。若棄牌堆沒牌則沒有效果。【超界突破】：若已受傷則可摸兩張。

new_againstdisCard = sgs.CreateSkillCard{
	name = "new_againstdis" ,
	target_fixed = true ,
	on_use = function(self, room, source, targets)
		local list = sgs.IntList()
		for _,id in sgs.qlist(room:getDiscardPile()) do
            local card = sgs.Sanguosha:getCard(id)
            if card:isKindOf("AOE") or card:isKindOf("Treasure") or card:isKindOf("AmazingGrace") or card:isKindOf("GodSalvation") then
				list:append(id)
			end
        end
		if not list:isEmpty() then
			local slash = sgs.Sanguosha:cloneCard("slash")
			slash:deleteLater()
			local x = 1
			if source:getMark("@SuperLimitBreak") > 0 and source:isWounded() then x=2 end
			for i = 1,x,1 do
				if list:isEmpty() then break end
				local id = list:at(math.random(0, list:length() - 1))
				list:removeOne(id)
				slash:addSubcard(id)
			end
			if slash:subcardsLength() > 0 then
				room:obtainCard(source, slash)
			end
		end
	end
}
new_againstdis = sgs.CreateZeroCardViewAsSkill{
	name = "new_againstdis",
	view_as = function()
		return new_againstdisCard:clone()
	end , 
	enabled_at_play = function(self,player)
		return not player:hasUsed("#new_againstdis")
		-- return true
	end
}


--舊抗末 againstdis：你可以用一張牌替代判定。若更改的為你的判定，則其他人無法改動此判定。
-- againstdis = sgs.CreateTriggerSkill{
    -- name = "againstdis",
    -- events = sgs.AskForRetrial ,        
    -- frequency = sgs.Skill_NotFrequent,
	-- can_trigger = function(self, target)
		-- if (target and target:isAlive() and target:hasSkill(self:objectName())) then
			-- if target:isKongcheng() then
				-- if target:getEquips():length() > 0 then return true end
				-- return false
			-- else
				-- return true
			-- end
		-- end
	-- end,
    -- on_trigger = function(self, event, player, data)
		-- local room = player:getRoom()
		-- local maji = room:findPlayerBySkillName("againstdis")
		-- local judge = data:toJudge()
		-- if maji and maji:isAlive() then
			-- local prompt_list = {
				-- "@againstdis-card" ,
				-- judge.who:objectName() ,
				-- self:objectName() ,
				-- judge.reason ,
				-- tostring(judge.card:getEffectiveId())
			-- }
			-- local prompt = table.concat(prompt_list, ":")
			-- local card = room:askForCard(player, "..", prompt, data, sgs.Card_MethodResponse, judge.who, true)
			-- if card then
				-- room:broadcastSkillInvoke("againstdis", math.random(1, 2))
				-- room:retrial(card, player, judge, self:objectName(), false)
			-- else
				-- return
			-- end
			-- if judge.who:objectName() ~= maji:objectName() then return end
			-- local log = sgs.LogMessage()
			-- log.type = "#gdnr_log"
			-- log.from = maji
			-- log.arg = "againstdis"
			-- room:sendLog(log)
			-- return true
        -- end
	-- end, 
    -- priority = 6,
-- }
--巧智 witty：你可以棄置一張群體錦囊選擇任意數量的目標，其摸一张牌。當你的單體錦囊指定你以外的目標時，可以令目標打出一張閃，否則受到一點傷害。
wittyCard = sgs.CreateSkillCard{
	name = "witty" ,
	target_fixed = false,
	will_throw = true,
	filter = function(self, targets, to_select)
		return true
	end, 
	feasible = function(self, targets)
		return true
	end, 
	on_use = function(self, room, source, targets)
		source:setFlags("wittyUsing")
		-- room:drawCards(source, 1)
		for _,player in pairs(targets) do
			if player:isAlive() then
				room:cardEffect(self, source, player)
			end
		end
		source:setFlags("-wittyUsing")
	end ,
	on_effect = function(self, effect)
		local room = effect.to:getRoom()
		room:drawCards(effect.to, 1)
	end
}
wittyVA = sgs.CreateOneCardViewAsSkill{
	name = "witty",
	expand_pile = "wooden_ox",
	view_filter = function(self,to_select)
		return to_select:isKindOf("DelayedTrick") or to_select:isKindOf("AmazingGrace") or to_select:isKindOf("ArcheryAttack") or to_select:isKindOf("SavageAssault") or to_select:isKindOf("GodSalvation")
	end,
	view_as = function(self, card)
		local acard = wittyCard:clone()
		acard:addSubcard(card)
		acard:setSkillName("witty")
		return acard
	end,
	enabled_at_play = function(self,player)
		-- return not (player:hasUsed("#wittyCard") or player:isKongcheng())
		return true
	end,
	enabled_at_response = function(self, player, pattern)
		return false
	end,
}
witty = sgs.CreateTriggerSkill{
	name = "witty",
	frequency = sgs.Skill_NotFrequent,
	view_as_skill = wittyVA, 
	events = {sgs.CardUsed},
	on_trigger = function(self, event, player, data)
		local card = nil
		local room = player:getRoom()
		local use = data:toCardUse()
		card = use.card
		if card:isKindOf("Weapon") then
			-- if room:askForSkillInvoke(player, self:objectName(), data) then
				-- local to = use.to:first()
				local to = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName(), "zhixi_choiceplayer", true, true)
				-- room:throwCard(card, nil)
				if to then
					local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
					slash:setSkillName(self:objectName())
					local use = sgs.CardUseStruct()
					use.card = slash
					use.from = player
					use.to:append(to)
					room:useCard(use)
					if card:isKindOf("GaleShell") and not to:isAlive() then room:throwCard(card, nil) end
				end
			-- end
		end
		-- if card:isKindOf("OffensiveHorse") or card:isKindOf("DefensiveHorse") then
			
		-- end
		if card:isKindOf("Armor") or card:isKindOf("Treasure") then
			local n = math.max(player:getLostHp() ,1)
			if n > 2 then n = 2 end
			player:drawCards(n)
		end
		return false
	end
}
--鋼盔 helmet：鎖定技。只有屬性殺對妳有效。
helmet = sgs.CreateTriggerSkill{
	name = "helmet",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.CardEffected},
	on_trigger = function(self, event, player, data)
		local effect = data:toCardEffect()
		local room = player:getRoom()
		-- if effect.slash:isRed() or effect.slash:isKindOf("ThunderSlash") or effect.slash:isKindOf("FireSlash") then
		if effect.card:isKindOf("Slash") and not (effect.card:isKindOf("ThunderSlash") or effect.card:isKindOf("FireSlash")) then
			room:sendCompulsoryTriggerLog(player, self:objectName())
			room:setEmotion(player, "armor/renwang_shield")
			room:broadcastSkillInvoke("helmet")
			return true
		end
	end,
	can_trigger = function(self, target)
		return target ~= nil and target:isAlive() and target:hasSkill(self:objectName())
	end
}

--天吃 eatforlike：鎖定技。你的錦囊牌視作桃。

eatforlike = sgs.CreateFilterSkill{
	name = "eatforlike", 
	view_filter = function(self,to_select)
		local room = sgs.Sanguosha:currentRoom()
		local place = room:getCardPlace(to_select:getEffectiveId())
		return (to_select:isKindOf("TrickCard") and not to_select:isKindOf("IronChain")) and (place == sgs.Player_PlaceHand)
	end,
	view_as = function(self, originalCard)
		local peach = sgs.Sanguosha:cloneCard("peach", originalCard:getSuit(), originalCard:getNumber())
		peach:setSkillName(self:objectName())
		local card = sgs.Sanguosha:getWrappedCard(originalCard:getId())
		card:takeOver(peach)
		return card
	end
}

--終合 yuriforever ：鎖定技。摸完初始牌後若千都在場，你將轉變為與其同屬陣營，若其為內奸，則其轉變為與你同陣營。若你們同為內奸，則一起變為反賊。
yuriforever = sgs.CreateTriggerSkill{
	name = "yuriforever" ,
	events = {sgs.AfterDrawNCards} ,
	-- events = {sgs.EventPhaseStart} ,
	on_trigger = function(self, event, player, data)
		local draw = data:toDraw()
		if draw.reason ~= "InitialHandCards" then return false end
		local room = player:getRoom()
		local others = room:getOtherPlayers(player)
		local lover
		
		-- if player:getMark("@book") >= 1 then return false end --小場景測試用
		-- player:gainMark("@book")
		for _,p in sgs.qlist(others) do
			if string.find(p:getGeneralName(), "chito") or string.find(p:getGeneral2Name(), "chito") then
				lover = p
				break
			end
		end
		if lover then
			room:broadcastSkillInvoke("yuriforever", math.random(1, 2))
			room:setEmotion(player, "skill/yuri_yuriforever")
			-- room:doSuperLightbox("yuriforever","yuriforever")
			-- room:getThread():delay(1000)
		else
			room:detachSkillFromPlayer(player, "yuriforever")
		end
		if lover:getRole() == "renegade" and lover:getRole() == player:getRole() then
			room:addPlayerMark(player, "yuriforever")
			room:addPlayerMark(lover, "yuriforever")
			-- if lover:getState() == "robot" then
				local ai_data = sgs.QVariant()
				ai_data:setValue(lover)
			-- end
			-- if player:getState() == "robot" then
				local ai_data2 = sgs.QVariant()
				ai_data2:setValue(player)
			-- end
			lover:setRole("rebel")
			room:setPlayerProperty(lover, "role", sgs.QVariant("rebel"))
			player:setRole("rebel")
			room:setPlayerProperty(player, "role", sgs.QVariant("rebel"))
			return false
		elseif lover:getRole() == "renegade" and not player:isLord() then
			room:addPlayerMark(lover, "yuriforever")
			-- if lover:getState() == "robot" then
				local ai_data = sgs.QVariant()
				ai_data:setValue(lover)
			-- end
			local prole = player:getRole()
			lover:setRole(prole)
			room:setPlayerProperty(lover, "role", sgs.QVariant(prole))
			return false
		end
		if (not lover) or lover:getRole() == player:getRole() then return false end
		local role1
		if lover:isLord() then
			role1 = "loyalist"
		elseif (not player:isLord()) and lover:getRole() ~= "renegade"  then
			role1 = lover:getRole()
		end
		if player:isLord() then
			if lover:getRole() == "loyalist" then return false end
			room:addPlayerMark(lover, "yuriforever")
			-- if lover:getState() == "robot" then
				local ai_data = sgs.QVariant()
				ai_data:setValue(lover)
			-- end
			role1 = "loyalist"
			lover:setRole(role1)
			room:setPlayerProperty(lover, "role", sgs.QVariant(role1))
			return false
		end
		if lover:getRole() == "renegade" then end
		if player:getRole() == role1 then return false end
		if player:hasSkill("yuriforever") then
			room:addPlayerMark(player, "yuriforever")
			-- if player:getState() == "robot" then
				local ai_data = sgs.QVariant()
				ai_data:setValue(player)
			-- end
			-- room:broadcastSkillInvoke("yuriforever", 1)
			player:setRole(role1)
			room:setPlayerProperty(player, "role", sgs.QVariant(role1))
			return false
		end
		return false
	end
}

--健將 sportsw：鎖定技。你與其他人的距離-1。回合開始必須進行一次判定，若為紅色，視為你擁有鐵騎tieji。若為黑色，視為你擁有鞬出yuri_jianchu。每次使用或打出一張殺可以使你摸一张牌。

sportsw = sgs.CreateTriggerSkill
{
	name = "sportsw",
	events = {sgs.CardUsed, sgs.CardResponded, sgs.EventPhaseStart},
    frequency = sgs.Skill_Frequent,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.CardUsed then
			local card = data:toCardUse().card
			if card:isKindOf("Slash") and room:askForSkillInvoke(player, self:objectName()) then
				-- room:broadcastSkillInvoke("sportsw")
				player:drawCards(1) 
			end 
        elseif event == sgs.CardResponded then
			local cd = data:toCardResponse().m_card
			if cd:isKindOf("Slash") and room:askForSkillInvoke(player, self:objectName()) then
				-- room:broadcastSkillInvoke("sportsw")
				player:drawCards(1) 
			end
		end
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Start and player:hasSkill("sportsw") then
			room:broadcastSkillInvoke("sportsw")
			local judge = sgs.JudgeStruct()
			judge.pattern = "."
			-- judge.good = true
			judge.reason = self:objectName()
			judge.who = player
			room:judge(judge)
			if judge.card:isRed() then
				room:acquireNextTurnSkills(player, "sportsw","LuaJTieji")
			else
				room:acquireNextTurnSkills(player, "sportsw","yuri_jianchu")
			end
		end
	end,
}

LuaJTieji = sgs.CreateTriggerSkill{
	name = "LuaJTieji",
	events = {sgs.TargetSpecified, sgs.FinishJudge} ,
	on_trigger = function(self, event, player, data)
		if event == sgs.TargetSpecified then
			local room = player:getRoom()
			local use = data:toCardUse()
			if not use.card:isKindOf("Slash") then return false end
			local jink_table = sgs.QList2Table(player:getTag("Jink_" .. use.card:toString()):toIntList())
			local index = 1
			for _, p in sgs.qlist(use.to) do
				if not player:isAlive() then break end
				local _data = sgs.QVariant()
				_data:setValue(p)
				if player:askForSkillInvoke(self:objectName(), _data) then
					room:broadcastSkillInvoke("tieji", math.random(1, 4))
					room:setPlayerMark(p, "@skill_invalidity", 1)
					room:setPlayerMark(p, "LuaJTiejiMark", 1)
					-- room:addPlayerMark(p, "LuaJTiejiMark")
					p:setFlags("LuaJTiejiTarget")
					local judge = sgs.JudgeStruct()
					judge.pattern = "."
					judge.good = true
					judge.reason = self:objectName()
					judge.who = player
					room:judge(judge)
					-- if judge:isGood() then
						-- jink_table[index] = 0
					-- end
					p:setFlags("-LuaJTiejiTarget")
					-- if not p:canDiscard(p, "he") or not room:askForCard(p, ".|"..judge.pattern, "@tieji-discard:::"..judge.pattern, data, sgs.Card_MethodDiscard) then
					if not p:canDiscard(p, "he") or not room:askForCard(p, ".|"..judge.pattern, "@luajtieji-discard:::"..judge.pattern, data, sgs.Card_MethodDiscard) then
						local log = sgs.LogMessage()
						log.type = "#NoJink"
						log.from = p
						room:sendLog(log)
						jink_table[index] = 0
					end
				end
				index = index + 1
			end
			local jink_data = sgs.QVariant()
			jink_data:setValue(Table2IntList(jink_table))
			player:setTag("Jink_" .. use.card:toString(), jink_data)
			return false
		else
			local judge = data:toJudge()
            if judge.reason == self:objectName() then
                judge.pattern = judge.card:getSuitString()
            end
		end
	end,
	-- can_trigger = function(self, target)
		-- return target ~= nil and target:isAlive() and target:hasSkill(self:objectName())
	-- end
}
LuaJTiejiClear = sgs.CreateTriggerSkill{
	name = "#LuaJTiejiClear",
	events = {sgs.EventPhaseChanging,sgs.Death},
	priority = 5,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.EventPhaseChanging then
			local change = data:toPhaseChange()
			if change.to ~= sgs.Player_NotActive then 
				return false 
			end
		elseif event == sgs.Death then
			local death = data:toDeath()
			if death.who:objectName() ~= player:objectName() or player:objectName() ~= room:getCurrent():objectName() then
				return false
			end
		end
		for _,p in sgs.qlist(room:getAlivePlayers()) do
			if p:getMark("LuaJTiejiMark") > 0 then
				room:setPlayerMark(p, "@skill_invalidity", 0)
				room:setPlayerMark(p, "LuaJTiejiMark", 0)
			end
		end
		return false
	end,
	can_trigger = function(self, target)
		return target
	end
}

--偶劇
thedollsCard = sgs.CreateSkillCard{
	name = "thedolls", 
	filter = function(self, targets, to_select)
		return #targets < 3 and to_select:getMark("@thedollsmark") > 0 and not to_select:isAllNude()
		-- return #targets < sgs.Self:getMark("@luanz") and to_select:getMark(self:objectName()) == 0
	end, 
	on_effect = function(self, effect)
		local from = effect.from
		local to = effect.to
		local room = from:getRoom()	
		local cid = room:askForCardChosen(from, to, "jhe", self:objectName())
		room:obtainCard(from, cid)
		room:setPlayerMark(to, "@thedollsmark", 0)
	end
}
thedollsVS = sgs.CreateZeroCardViewAsSkill{
	name = "thedolls", 
	response_pattern = "@@thedolls", 
	view_as = function()
		return thedollsCard:clone()
	end
}
thedolls = sgs.CreateTriggerSkill{
	name = "thedolls", 
	events = {sgs.CardUsed, sgs.EventPhaseStart}, 
	view_as_skill = thedollsVS, 
	on_trigger = function(self, event, player, data, room)
		if event == sgs.CardUsed then
			local use = data:toCardUse()
			if use.from and use.from:isAlive() and not (use.card:isKindOf("EquipCard") or use.card:isKindOf("SkillCard")) then
				for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
					if use.to:contains(p) and use.from:getMark("@thedollsmark") < 1 then
						room:setPlayerMark(use.from, "@thedollsmark", 1)
					end
					if use.from:objectName() == p:objectName() then
						local tos = use.to
						for _, to in sgs.qlist(tos) do
							if to:getMark("@thedollsmark") < 1 then
								room:setPlayerMark(to, "@thedollsmark", 1)
							end
						end
					end
				end
			end
		end
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish and player:hasSkill(self:objectName()) then
			local list = room:getAlivePlayers()
			local can = false
			for _, p in sgs.qlist(list) do
				if p:getMark("@thedollsmark") > 0 then can = true break end
			end
			if can then
				room:askForUseCard(player, "@@thedolls", "@thedollslog")
			end
		end
		return false
	end, 
	can_trigger = function(self, target)
		-- return target and target:hasSkill(self:objectName()) and target:isAlive() and target:getMark("@defensive_distance_test") ~= 0
		return target and target:isAlive()
	end
}

--開朗 cheerful：鎖定技。你受到的傷害不會大於一，你不會流失生命。
cheerful = sgs.CreateTriggerSkill{
	name = "cheerful",
	frequency = sgs.Skill_Compulsory ,
	-- events = {sgs.PreDamageDone, sgs.PreHpLost, sgs.FinishJudge, sgs.DrawNCards},
	events = {sgs.PreDamageDone, sgs.PreHpLost},
	
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.PreDamageDone or event == sgs.PreHpLost then
			-- room:broadcastSkillInvoke("cheerful", math.random(1, 2))
			if event == sgs.PreHpLost then
				room:setEmotion(player, "armor/silver_lion")
				room:sendCompulsoryTriggerLog(player, "cheerful")
				return true
			else
				local damage = data:toDamage()
				if damage.damage > 1 and damage.to:hasSkill("cheerful") then
				room:sendCompulsoryTriggerLog(damage.to, "cheerful")
				room:setEmotion(damage.to, "armor/silver_lion")
				damage.damage = 1
				data:setValue(damage)
				end
			end
		end
		return false
	end,
	can_trigger = function(self, target)
		return target and target:hasSkill("cheerful")
	end
}
--百王 銀屏

yuri_xuejiCard = sgs.CreateSkillCard{
	name = "yuri_xueji" ,
	filter = function(self, targets, to_select)
		return #targets < math.max(sgs.Self:getLostHp()+1, 2)
	end,
	-- about_to_use = function(self, room, use)
		-- local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_THROW, use.from:objectName(), "", self:objectName(), "")
		-- room:moveCardTo(self, use.from, nil, sgs.Player_DiscardPile, reason, true)
		-- skill(self, room, use.from, true)
		-- for _, p in sgs.qlist(use.to) do
			-- room:doAnimate(1, use.from:objectName(), p:objectName())
		-- end
		-- room:addPlayerMark(use.from, self:objectName().."engine")
		-- if use.from:getMark(self:objectName().."engine") > 0 then
			-- for _, p in sgs.qlist(use.to) do
				-- if not p:isChained() then
					-- p:setChained(true)
					-- room:broadcastProperty(p, "chained")
					-- room:setEmotion(p, "chain")
					-- room:getThread():trigger(sgs.ChainStateChanged, room, p)
				-- else
					-- p:setChained(false)
					-- room:broadcastProperty(p, "chained")
					-- room:setEmotion(p, "chain")
					-- room:getThread():trigger(sgs.ChainStateChanged, room, p)
				-- end
			-- end
			-- room:removePlayerMark(use.from, self:objectName().."engine")
		-- end
	-- end
	on_effect = function(self, effect)
		local from, to, room = effect.from, effect.to, effect.from:getRoom()
		room:setPlayerChained(to)
	end
}
yuri_xueji = sgs.CreateOneCardViewAsSkill{
	name = "yuri_xueji" ,
	filter_pattern = ".|black!" ,
	view_as = function(self, card)
		local first = yuri_xuejiCard:clone()
		first:addSubcard(card:getId())
		first:setSkillName(self:objectName())
		return first
	end,
	enabled_at_play = function(self, player)
		return player:canDiscard(player, "he") and not player:hasUsed("#yuri_xueji")
	end
}

yuri_huxiao = sgs.CreateTriggerSkill{	--yun	用的旧版的
	name = "yuri_huxiao",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.Damage},
	on_trigger = function(self, event, player, data, room)
		local damage = data:toDamage()
		-- if damage.nature == sgs.DamageStruct_Fire then
			room:broadcastSkillInvoke(self:objectName())
			damage.from:drawCards(damage.damage, self:objectName())
		-- end
	end
}

yuri_wuji = sgs.CreateOneCardViewAsSkill{
	name = "yuri_wuji",
	response_or_use = true,
	expand_pile = "wooden_ox",
	view_filter = function(self, card)
		if not card:isRed() then return false end
		if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
			local fslash = sgs.Sanguosha:cloneCard("fire_slash", sgs.Card_SuitToBeDecided, -1)
			fslash:addSubcard(card:getEffectiveId())
			fslash:deleteLater()
			return fslash:isAvailable(sgs.Self)
		end
		return true
	end,
	view_as = function(self, card)
		local fslash = sgs.Sanguosha:cloneCard("fire_slash", card:getSuit(), card:getNumber())
		fslash:addSubcard(card:getId())
		fslash:setSkillName(self:objectName())
		return fslash
	end,
	enabled_at_play = function(self, player)
		return sgs.Slash_IsAvailable(player)
	end, 
	enabled_at_response = function(self, player, pattern)
		return pattern == "slash"
	end
}

-- yurikindomhero = sgs.CreateTriggerSkill{
	-- name = "yurikindomhero",
	-- events = {sgs.EventPhaseStart},
	-- frequency = sgs.Skill_Limited,
	-- limit_mark = "@yurikindomhero",
	-- on_trigger = function(self, event, player, data, room)
		-- local xp = player:getMark("meiying")	--yun
		-- if player:getPhase() == sgs.Player_RoundStart and player:getMark("@meiying") > 0 and player:getMark("@yurikindomhero") > 0 and room:askForSkillInvoke(player, self:objectName(), sgs.QVariant("up:"..xp)) then
			-- room:addPlayerMark(player, self:objectName().."engine")
			-- if player:getMark(self:objectName().."engine") > 0 then
				-- player:loseAllMarks("@meiying")
				-- player:loseAllMarks("meiying")	--yun
				-- local yurikindomheros = {}
				-- local yurikindomhero = {}
				-- for _,name in ipairs(sgs.Sanguosha:getLimitedGeneralNames()) do
					-- if sgs.Sanguosha:getGeneral(name):getKingdom() == "shu" then
						-- table.insert(yurikindomheros, name)
					-- end
				-- end
				-- for _,p in sgs.qlist(room:getAllPlayers(true)) do
					-- if table.contains(yurikindomheros, p:getGeneralName()) then
						-- table.removeOne(yurikindomheros, p:getGeneralName())
					-- end
				-- end
				-- for i = 1, 5 do
					-- local first = yurikindomheros[math.random(1, #yurikindomheros)]
					-- table.insert(yurikindomhero, first)
					-- table.removeOne(yurikindomheros, first)
				-- end
				-- room:removePlayerMark(player, "@yurikindomhero")
				-- room:doSuperLightbox("zhaoxiang", self:objectName())	--yun
				-- local general = room:askForGeneral(player, table.concat(yurikindomhero, "+"))
				-- ChoiceLog(player, general)
				-- room:changeHero(player, general, false, false)
				-- local can_invoke = true
				-- local x = 0
				-- for _, p in sgs.qlist(room:getAllPlayers(true)) do
					-- x = x + 1
					-- if p:isAlive() and player:getHp() > p:getHp() then	--yun
						-- can_invoke = false
					-- end
				-- end
				-- room:setPlayerProperty(player, "maxhp", sgs.QVariant(math.min(x, xp)))	--yun
				-- if can_invoke and player:isWounded() then
					-- room:recover(player, sgs.RecoverStruct(player))
				-- end
				-- room:removePlayerMark(player, self:objectName().."engine")
			-- end
		-- end
		-- return false
	-- end
-- }


-- 皙秀C++ 锁定技，当你成为其他角色使用的牌的目标时，若你装备区内有与此牌花色相同的牌，你摸一张牌；当你装备区内的最后一张牌因被其他角色弃置而移动前，取消之。 
-- class Xixiu : public TriggerSkill
-- {
-- public:
    -- Xixiu() : TriggerSkill("xixiu")
    -- {
        -- events << TargetConfirming << BeforeCardsMove;
        -- frequency = Compulsory;
    -- }

    -- bool trigger(TriggerEvent event, Room *room, ServerPlayer *player, QVariant &data) const
    -- {
        -- if (event == TargetConfirming) {
            -- CardUseStruct use = data.value<CardUseStruct>();
            -- if (use.card->isKindOf("SkillCard") || !use.to.contains(player) || !use.from || use.from == player) return false;
            -- if (!use.card->hasSuit()) return false;
            -- Card::Suit suit = use.card->getSuit();
            -- foreach (const Card *card, player->getEquips()) {
                -- if (card->getSuit() != suit) continue;
                -- room->sendCompulsoryTriggerLog(player, this);
                -- player->drawCards(1, objectName());
                -- return true;
            -- }
        -- } else {
            -- if (player->getEquips().length() != 1) return false;
            -- CardsMoveOneTimeStruct move = data.value<CardsMoveOneTimeStruct>();
            -- if (move.from != player || !move.from_places.contains(Player::PlaceEquip)) return false;
            -- if ((move.reason.m_reason & CardMoveReason::S_MASK_BASIC_REASON) == CardMoveReason::S_REASON_DISCARD) {
                -- QString from = move.reason.m_playerId;
                -- if (from.isEmpty() || from == player->objectName()) return false;
                -- int equip_id = player->getEquipsId().first();
                -- foreach (int id, move.card_ids) {
                    -- if (id != equip_id) continue;
                    -- room->sendCompulsoryTriggerLog(player, this);
                    -- move.card_ids.removeOne(id);
                    -- data = QVariant::fromValue(move);
                    -- return false;
                -- }
            -- }
        -- }
        -- return false;
    -- }
-- };
--呵護：你的牌被移動時，置入你的手牌。
itmine = sgs.CreateTriggerSkill
{
	name = "itmine",
	events = {sgs.BeforeCardsMove},
	frequency = sgs.Skill_Compulsory, 
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.BeforeCardsMove then
			local move = data:toMoveOneTime()
			if move.from:getSeat()~=player:getSeat() or move.from:objectName()~=player:objectName() then return false end
			if player:getPhase() == sgs.Player_Play then return false end
			if not (move.from_places:contains(sgs.Player_PlaceEquip) or move.from_places:contains(sgs.Player_PlaceHand)) then return false end
			local reason=move.reason.m_reason
			if reason==sgs.CardMoveReason_S_REASON_USE or reason==sgs.CardMoveReason_S_REASON_RESPONSE or reason==sgs.CardMoveReason_S_REASON_RULEDISCARD then return false end
			-- if not (reason==sgs.CardMoveReason_S_REASON_USE or reason==sgs.CardMoveReason_S_REASON_RESPONSE or reason==sgs.CardMoveReason_S_REASON_RULEDISCARD) then
			-- if reason==sgs.CardMoveReason_S_REASON_GIVE or reason==sgs.CardMoveReason_S_REASON_ROB or reason==sgs.CardMoveReason_S_REASON_SWAP
			-- or reason==sgs.CardMoveReason_S_REASON_EXTRACTION or reason==sgs.CardMoveReason_S_REASON_TRANSFER 
			-- or reason==sgs.CardMoveReason_S_REASON_GOTCARD or reason==sgs.CardMoveReason_S_REASON_UNKNOWN 
			-- or reason==sgs.CardMoveReason_S_REASON_RULEDISCARD or reason==sgs.CardMoveReason_S_REASON_THROW or reason==sgs.CardMoveReason_S_REASON_DISMANTLE then
				-- local movecards = {}
				-- for _,cid in sgs.qlist(move.card_ids) do
					-- local card = sgs.Sanguosha:getCard(cid)
					-- table.insert(movecards, card)
				-- end
				-- if #movecards > 1 then --開啟，可以讓你知道被影響的是啥卡。
					-- local x = 0
					-- local y = #movecards
					-- for _,mc in ipairs(movecards) do
						-- x = x + 1
						-- if x == 1 then
							-- local log=sgs.LogMessage()
							-- log.type ="#itmine_log2"
							-- log.card_str = mc:toString()
							-- room:sendLog(log)
						-- elseif x == y then
							-- local log=sgs.LogMessage()
							-- log.type ="#itmine_log4"
							-- log.card_str = mc:toString()
							-- room:sendLog(log)
						-- else
							-- local log=sgs.LogMessage()
							-- log.type ="#itmine_log3"
							-- log.card_str = mc:toString()
							-- room:sendLog(log)
						-- end
					-- end
				-- else
					-- local log=sgs.LogMessage()
					-- log.type ="#itmine_log"
					-- log.card_str = movecards[1]:toString()
					-- room:sendLog(log)
				-- end
				-- local card_id = room:askForCard(cj, ".|spade|.", "@machiko", sgs.QVariant(), sgs.Card_MethodNone)
				-- if not card_id then return false end
				-- room:showCard(cj, card_id)
				-- for i = 0, move.card_ids:length() - 1 do --把卡片放回原處的寫法(使用原始的for)
					-- if move.from_places:at(i) == sgs.Player_PlaceEquip or move.from_places:at(i) == sgs.Player_PlaceHand then
						-- local card = sgs.Sanguosha:getCard(move.card_ids:at(i))
						-- move.to = player
						-- move.to_place = move.from_places:at(i)
						-- move.reason.m_reason = sgs.CardMoveReason_S_REASON_NATURAL_ENTER
						-- data:setValue(move)
					-- end
				-- end
				local card_ids = sgs.IntList()
				for _, card_id in sgs.qlist(move.card_ids) do
					card_ids:append(card_id)
				end
				if card_ids:isEmpty() then
					return false
				else
					for _, id in sgs.qlist(card_ids) do
						if move.card_ids:contains(id) then
							-- move.from_places:removeAt(listIndexOf(move.card_ids, id))
							move.card_ids:removeOne(id)
							-- move.card_ids:removeOne(move.card_ids:at(i))
							data:setValue(move)
						end
					end
				end
				-- for _, id in sgs.qlist(move.card_ids) do --用這種寫法，一張牌還可以，劫營5張，結果只有三個標記，有兩張牌被偷，怪怪的。
					-- player:gainMark("&test")
					-- move.card_ids:removeOne(id)
					-- data:setValue(move)
				-- end
				

				-- move.to_place = sgs.Player_DiscardPile -- 原效果：將取得改為棄置
				-- move.reason.m_reason = sgs.CardMoveReason_S_REASON_THROW
				-- data:setValue(move)
				-- local cardname = sgs.Sanguosha:getCard():objectName()
				return false
			-- end
		end
		return false
	end,        
}
-- 圍困：限定技，你可以選擇一名手牌數量大於你的角色，令其受到一點傷害並獲得困頓：鎖定技：你的棄牌階段移至摸牌階段之前，當你進入瀕死狀態時失去本技能。
ys_jueyancard = sgs.CreateSkillCard{
	name = "ys_jueyan",
	target_fixed = false,
	will_throw = false,
	filter = function(self, targets, to_select, player)
		return to_select:objectName() ~= player:objectName() and to_select:getHandcardNum() > player:getHandcardNum() and #targets < 1
	end,
	on_use = function(self, room, source, targets)
		room:broadcastSkillInvoke("maprecord", 1)
		source:loseMark("@ys_jueyan", 1)
		room:damage(sgs.DamageStruct("ys_jueyan", source, targets[1], 1, sgs.DamageStruct_Normal))
		room:acquireSkill(targets[1], "ys_jueyan_effect")
	end
}

ys_jueyanVS = sgs.CreateZeroCardViewAsSkill{
	name = "ys_jueyan",
	view_as = function(self)
		local acard = ys_jueyancard:clone()
		acard:setSkillName(self:objectName())
		return acard
	end,
	enabled_at_play = function(self, player)
		return player:getMark("@ys_jueyan") > 0
	end
}

ys_jueyan = sgs.CreateTriggerSkill{
	name = "ys_jueyan" ,
	frequency = sgs.Skill_Limited,
	limit_mark = "@ys_jueyan",
	events = {},
	view_as_skill = ys_jueyanVS,
	on_trigger = function()
	end
}

ys_jueyan_effect = sgs.CreateTriggerSkill{
	name = "ys_jueyan_effect" ,
	-- events = {sgs.EventPhaseChanging, sgs.Dying} ,
	events = {sgs.EventPhaseChanging} ,
	frequency = sgs.Skill_Compulsory, 
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.EventPhaseChanging then
			local change = data:toPhaseChange()
			if change.to == sgs.Player_Draw then
				if not player:isSkipped(sgs.Player_Draw) then
					player:setFlags("DiscardDone")
					change.to = sgs.Player_Discard
					data:setValue(change)
				end
			elseif change.to == sgs.Player_Play then
				room:broadcastSkillInvoke("ys_jueyan", math.random(1, 4))
				if not player:isSkipped(sgs.Player_Play) then
					if player:hasFlag("DiscardDone") then
						player:setFlags("-DiscardDone")
						change.to = sgs.Player_Draw
						data:setValue(change)
					else
						change.to = sgs.Player_Discard
						data:setValue(change)
					end
					player:setFlags("PlayDone")
				end
			elseif change.to == sgs.Player_Discard then
				if not player:isSkipped(sgs.Player_Discard) then
					if player:hasFlag("PlayDone") then
						player:setFlags("-PlayDone")
						change.to = sgs.Player_Play
						data:setValue(change)
					elseif player:hasFlag("DiscardDone") then
						player:setFlags("-DiscardDone")
						change.to = sgs.Player_Draw
						data:setValue(change)
					end
				end
			else
				return false
			end
		-- elseif event == sgs.Dying then
			-- room:detachSkillFromPlayer(player, "ys_jueyan_effect")
		end
		return false
	end
}

ys_qianjie = sgs.CreateTriggerSkill
{
	name = "ys_qianjie",
	events = {sgs.BeforeCardsMove},
	frequency = sgs.Skill_Compulsory, 
	on_trigger = function(self, event, player, data)
		if event == sgs.BeforeCardsMove then
			local room = player:getRoom()
			-- local cj = room:findPlayerBySkillName(self:objectName())
			local move = data:toMoveOneTime()
			if not move.from or move.from:getSeat()~=player:getSeat() or move.from:objectName()~=player:objectName() then return false end
			-- if player:getPhase() == sgs.Player_Play then return false end
			if not (move.from_places:contains(sgs.Player_PlaceEquip) or move.from_places:contains(sgs.Player_PlaceHand)) then return false end
			local reason=move.reason.m_reason
			if reason~=sgs.CardMoveReason_S_REASON_PINDIAN then return false end
			room:broadcastSkillInvoke(self:objectName(), math.random(1, 2))
			local movecards = {}
			for _,cid in sgs.qlist(move.card_ids) do
				local card = sgs.Sanguosha:getCard(cid)
				table.insert(movecards, card)
			end
			move.to = player
			move.to_place = sgs.Player_PlaceHand
			move.reason.m_reason = sgs.CardMoveReason_S_REASON_GIVE
			data:setValue(move)
			return true
		end
		return false
	end,        
}

ys_huairou = sgs.CreatePhaseChangeSkill{
	name = "ys_huairou" ,
	on_phasechange = function(self, player)
		local room = player:getRoom()
		if player:getPhase() == sgs.Player_Start and not player:isKongcheng() then
			local target = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName(), "ys_huairou-invoke", true, true)
			if target then
				room:broadcastSkillInvoke(self:objectName(), math.random(1, 2))
				if not player:hasSkill("noslianying") then
					-- room:acquireSkill(player, "lianying")
					room:acquireNextTurnSkills(player, "ys_huairou","noslianying")
				end
				room:obtainCard(target, player:wholeHandCards(), sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_GIVE, player:objectName(), target:objectName(), self:objectName(), ""), false)
			end
		end
		return false
	end
}
--[[
--廢棄該角色
--從諫

ys_congjianCard = sgs.CreateSkillCard{
	name = "ys_congjian",
	will_throw = false,
	filter = function(self, targets, to_select)
		return #targets == 0 and to_select:getMark(self:objectName()) > 0
	end,
	on_use = function(self, room, source, targets)
		if source:objectName() ~= targets[1]:objectName() then
			room:obtainCard(targets[1], self, sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_GIVE, source:objectName(), targets[1]:objectName(), self:objectName(), ""), false)
		else
			room:throwCard(self, source)
		end
		local x = 1
		if sgs.Sanguosha:getCard(self:getSubcards():first()):isKindOf("EquipCard") then
			x = 2
		end
		source:drawCards(x, self:objectName())
	end
}
ys_congjianVS = sgs.CreateOneCardViewAsSkill{
	name = "ys_congjian",
	filter_pattern = ".",
	view_as = function(self, card)
		local first = ys_congjianCard:clone()
		first:addSubcard(card:getId())
		first:setSkillName(self:objectName())
		return first
	end,
	response_pattern = "@@ys_congjian", 
	enabled_at_play = function(self, player)
		return false
	end
}
ys_congjian = sgs.CreateTriggerSkill{
	name = "ys_congjian",
	view_as_skill = ys_congjianVS,
	events = {sgs.TargetConfirmed},
	on_trigger = function(self, event, player, data, room)
		local use = data:toCardUse()
		if use.card:isKindOf("TrickCard") and use.from:objectName() ~= player:objectName() and use.to and use.to:contains(player) then
			local targets = use.to
			-- targets:removeOne(player)
			for _, p in sgs.qlist(targets) do
				room:addPlayerMark(p, self:objectName())
			end
			room:askForUseCard(player, "@@ys_congjian", "@ys_congjian", -1, sgs.Card_MethodNone)
			for _, p in sgs.qlist(targets) do
				room:removePlayerMark(p, self:objectName())
			end
		end
		return false
	end
}

--雄起
ys_xionchijink = sgs.CreateFilterSkill{
	name = "ys_xionchijink" ,
	view_filter = function(self, card)
		return card:isKindOf("EquipCard")
	end ,
	view_as = function(self, card)
		local jink = sgs.Sanguosha:cloneCard("jink", card:getSuit(), card:getNumber())
		jink:setSkillName(self:objectName())
		local wrap = sgs.Sanguosha:getWrappedCard(card:getId())
		wrap:takeOver(jink)
		return wrap
	end
}
ys_xionchiCard = sgs.CreateSkillCard{
	name = "ys_xionchi",
	mute = true,
	target_fixed = false,
	will_throw = true,
	filter = function(self, targets, to_select)
		return true
	end,
	feasible = function(self, targets)
		return true
	end,
	about_to_use = function(self, room, cardUse)
		local use = cardUse
		if not use.to:contains(use.from) then
			use.to:append(use.from)
		end
		room:removePlayerMark(use.from, "@arise")
		self:cardOnUse(room, use)
	end,
	on_use = function(self, room, source, targets)
		-- room:doSuperLightbox("mateng", "ys_xionchi")
		room:setEmotion(source, "skill/xiongyi")
		-- room:broadcastSkillInvoke("xiongyi", math.random(1, 2))
		local rec = sgs.RecoverStruct()
		rec.who = source
		room:recover(source, rec)
		for _,p in ipairs(targets) do
			p:drawCards(1)
		end
	end
}
ys_xionchiVS = sgs.CreateZeroCardViewAsSkill{
	name = "ys_xionchi",
	view_as = function(self, cards)
		return ys_xionchiCard:clone()
	end,
	enabled_at_play = function(self, player)
		return player:getMark("@arise") >= 1
	end
}
ys_xionchi = sgs.CreateTriggerSkill{
	name = "ys_xionchi",
	frequency = sgs.Skill_Limited,
	events = {sgs.GameStart},
	limit_mark = "@arise",
	view_as_skill = ys_xionchiVS,
	on_trigger = function()
	end
}
--雄亂

ys_xiongluanCard = sgs.CreateSkillCard{
	name = "ys_xiongluan",
	mute = true,
	target_fixed = false,
	will_throw = true,
	filter = function(self, targets, to_select)
		return to_select:objectName() ~= sgs.Self:objectName()
	end,
	feasible = function(self, targets)
		return true
	end,
	on_use = function(self, room, source, targets)
		room:removePlayerMark(source, "@fuck_caocao")
		for _,p in ipairs(targets) do
			local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
			slash:setSkillName("ys_xiongluan_slash")
			local use = sgs.CardUseStruct()
			use.card = slash
			use.from = source
			use.to:append(p)
			room:useCard(use)
			slash:deleteLater()
		end
		source:drawCards(1)
		local cards = source:getCards("ej")
		local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
		dummy:addSubcards(cards)
		room:throwCard(dummy, nil)
		room:acquireSkill(source, "ys_xionchi")
		room:acquireSkill(source, "ys_xionchijink")
		room:detachSkillFromPlayer(source, "ys_xiongluan")
		dummy:deleteLater()
	end
}
ys_xiongluanVS = sgs.CreateZeroCardViewAsSkill{
	name = "ys_xiongluan",
	view_as = function(self, cards)
		return ys_xiongluanCard:clone()
	end,
	enabled_at_play = function(self, player)
		return player:getMark("@fuck_caocao") >= 1
	end
}
ys_xiongluan = sgs.CreateTriggerSkill{
	name = "ys_xiongluan",
	frequency = sgs.Skill_Limited,
	events = {sgs.GameStart},
	limit_mark = "@fuck_caocao",
	view_as_skill = ys_xiongluanVS,
	on_trigger = function()
	end
}
]]
--閱歷：摸牌階段你多摸一张牌，然後你必須將一張牌置於武將牌上稱為“書”(最多三張)。
likebooks = sgs.CreateTriggerSkill{               
	name = "likebooks",            
	events = {sgs.DrawNCards, sgs.AfterDrawNCards},                 
	on_trigger = function(self, event, player, data)        
		if event == sgs.DrawNCards then
			local draw = data:toDraw()
			if draw.reason ~= "draw_phase" then return false end
			local room = player:getRoom()                        
			if not room:askForSkillInvoke(player, self:objectName()) then return end
			player:setFlags("likebooks")
			room:broadcastSkillInvoke("likebooks", math.random(1, 2))
			draw.num = draw.num + 1
			data:setValue(draw)
		elseif event == sgs.AfterDrawNCards then
			local draw = data:toDraw()
			if draw.reason ~= "draw_phase" then return false end
			if player:getPile("books"):length() > 2 then return end
			if not player:hasFlag("likebooks") or player:isKongcheng() then return end
			local room = player:getRoom()                    
			-- local id = room:askForExchange(player, "likebooks", player:getHandcardNum(), 1, false, "@likebooks")
			local id = room:askForExchange(player, "likebooks", 1, 1, false, "@likebooks")
			player:addToPile("books", id)  
		end
   end
}
--同樂：1.當一名角色結束階段，你可以棄置一張書令其摸X張牌(X為其手牌數與最大體力值之差，最少一張，最多三張。)，然後其選擇一項：轉正(如果橫置)或恢復體力。
--2.當一名角色被翻面，你可以棄置一張書令其翻回正面。
happinesstoeveryone = sgs.CreateTriggerSkill
{
	name = "happinesstoeveryone",
	events = {sgs.EventPhaseStart, sgs.TurnedOver},
	can_trigger = function(self, player)
		return true
	end,
        
	on_trigger = function(self, event, player, data)
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish then
			local room = player:getRoom()
			for _, ueser in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
				if (not ueser or ueser:objectName() == player:objectName()) then continue end
				if ueser:getPile("books"):isEmpty() then return end
				if not room:askForSkillInvoke(ueser, self:objectName()) then continue end
				room:fillAG(ueser:getPile("books"), ueser)
				local id = room:askForAG(ueser, ueser:getPile("books"), false, self:objectName())
				room:clearAG(ueser)
				if not id then continue end
				if ueser:getMark("@SuperLimitBreak") > 0 then 
					room:obtainCard(ueser, id)
				else
					local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_REMOVE_FROM_PILE, "", nil, self:objectName(), "")
					room:throwCard(sgs.Sanguosha:getCard(id), reason, nil)
				end
				room:broadcastSkillInvoke("happinesstoeveryone", math.random(1, 3))
				if player:isChained() and not player:isWounded() then
					player:setChained(false)
					room:broadcastProperty(player, "chained")
					room:setEmotion(player, "chain")
					room:getThread():trigger(sgs.ChainStateChanged, room, player)
					player:drawCards(1)
				elseif player:isWounded() and not player:isChained() then
					local theRecover = sgs.RecoverStruct()
					theRecover.recover = 1
					theRecover.who = ueser
					room:recover(player, theRecover)	
				elseif not player:isChained() and not player:isWounded() then
					local count = player:getMaxHp() - player:getHandcardNum()
					if count <= 0 then count = 1 end
					if count > 3 then count = 3 end
					player:drawCards(count)
					return
				else --這邊剩兩個都有的可能
					local choice = room:askForChoice(player,self:objectName(),"reset+recover")
					if choice == "reset" then
						player:setChained(false)
						room:broadcastProperty(player, "chained")
						room:setEmotion(player, "chain")
						room:getThread():trigger(sgs.ChainStateChanged, room, player)
						player:drawCards(1)
					else
						local theRecover = sgs.RecoverStruct()
						theRecover.recover = 1
						theRecover.who = ueser
						room:recover(player, theRecover)
					end			
				end	
			end
		end
		if event == sgs.TurnedOver then
			local room = player:getRoom()
			if not player:faceUp() then
				for _, ueser in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
					if ueser:getPile("books"):isEmpty() then continue end
					if not room:askForSkillInvoke(ueser, self:objectName()) then continue end
					room:broadcastSkillInvoke("happinesstoeveryone", math.random(1, 3))
					room:fillAG(ueser:getPile("books"), ueser)
					local id = room:askForAG(ueser, ueser:getPile("books"), false, self:objectName())
					room:clearAG(ueser)
					local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_REMOVE_FROM_PILE, "", nil, self:objectName(), "")
					room:throwCard(sgs.Sanguosha:getCard(id), reason, nil)
					player:turnOver()
					break
				end
			end
		end 
	end
}

--渴血：鎖定技。每次你的回合結束，你流失一點體力。你可以令與你距離為一的目標無法閃避你的殺。你與其他人的距離-X(X為妳失去的生命)。
blooddry = sgs.CreateTriggerSkill{
	name = "blooddry" ,
	events = {sgs.TargetSpecified, sgs.EventPhaseStart} ,
	frequency = sgs.Skill_Compulsory,
	on_trigger = function(self, event, player, data)
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish then
			local room = player:getRoom()
			room:loseHp(player)
		else
			local use = data:toCardUse()
			if not use.card or not use.card:isKindOf("Slash") then return false end
			local jink_table = sgs.QList2Table(player:getTag("Jink_" .. use.card:toString()):toIntList())
			local index = 1
			for _, p in sgs.qlist(use.to) do
				if not player:isAlive() then break end
				-- local _data = sgs.QVariant()
				-- _data:setValue(p)
				-- if player:distanceTo(p) <= 1 and player:askForSkillInvoke(self:objectName(), _data) then
				if player:hasFlag("useBDEflag") then
					player:setFlags("-useBDEflag")
					jink_table[index] = 0
				end
				index = index + 1
			end
			local jink_data = sgs.QVariant()
			jink_data:setValue(Table2IntList(jink_table))
			player:setTag("Jink_" .. use.card:toString(), jink_data)
		end
		return false
	end
}
BDeffect = sgs.CreateTriggerSkill{
	name = "#BDeffect",
	frequency=sgs.Skill_NotFrequent,
	events={sgs.EventPhaseStart,sgs.Death,sgs.TargetConfirming},
	can_trigger = function(self, target)
    	return true
	end,
	on_trigger=function(self,event,player,data)
		local room=player:getRoom()
		if event == sgs.Death and data:toDeath().who:hasSkill("blooddry") then
			for _,p in sgs.qlist(room:getOtherPlayers(player)) do
				p:setFlags("-BDEflag")
				if p:getMark("@all_skill_invalidity") > 0 then
					room:setPlayerMark(p, "@all_skill_invalidity", 0)
					local BDinvalid_skills = p:getTag("BDinvalidSkills"):toString():split("+") -- 當禪院被使用時，這個要開(有用)
					for _, skill_name in ipairs(BDinvalid_skills) do
						room:removePlayerMark(p, "Qingcheng"..skill_name)
					end
					p:setTag("BDinvalidSkills", sgs.QVariant())
				end
				if p:getMark("Armor_Nullified") > 0 then
					room:setPlayerMark(p, "Armor_Nullified", 0)
				end
			end
		end
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish then
			for _,p in sgs.qlist(room:getAlivePlayers()) do
				if p:hasFlag("BDEflag") then
					p:setFlags("-BDEflag")
					room:setPlayerMark(p, "@all_skill_invalidity", 0)
					local BDinvalid_skills = p:getTag("BDinvalidSkills"):toString():split("+") -- 當禪院被使用時，這個要開(有用)
					for _, skill_name in ipairs(BDinvalid_skills) do
						room:removePlayerMark(p, "Qingcheng"..skill_name)
					end
					p:setTag("BDinvalidSkills", sgs.QVariant())
					room:setPlayerMark(p, "Armor_Nullified", 0)
				end
			end
		elseif event == sgs.TargetConfirming then
			-- local room = player:getRoom()
			local use = data:toCardUse()
			local tos = use.to
			if use.card:isKindOf("Slash") and use.from:hasSkill("blooddry") and use.from:isAlive() then
				
				for _, to in sgs.qlist(tos) do
					-- local _data = sgs.QVariant()
					-- _data:setValue(to)
					if use.from:distanceTo(to) <= 1 and (use.from:hasFlag("useBDEflag") or use.from:askForSkillInvoke("blooddry", data)) then
						-- if not use.card:hasFlag("drank") then --這個可以讓牌有酒殺效果
							-- room:setCardFlag(use.card, "drank")
							-- use.card:setTag("drank", sgs.QVariant(1))--裡面的數字為傷害增加量
						-- end
						if to:getMark("@fog") > 0 then room:setPlayerMark(to, "@fog", 0) end
						if to:getMark("@orange") > 0 then room:setPlayerMark(to, "@orange", 0) end
						if to:getMark("kuanshi_start") > 0 then room:setPlayerMark(to, "kuanshi_start", 0) end
						if not use.from:hasFlag("useBDEflag") then
							room:broadcastSkillInvoke("blooddry", math.random(1, 2))
							use.from:setFlags("useBDEflag")
						end
						to:setFlags("BDEflag")
						room:setPlayerMark(to, "@all_skill_invalidity", 1)
						local BDinvalid_skills = to:getTag("BDinvalidSkills"):toString():split("+") -- 纏怨的方式，有效，看情況替換
						local skills = to:getVisibleSkillList()
						for _, skill in sgs.qlist(skills) do
							-- if not skill:inherits("SPConvertSkill") and not skill:isAttachedLordSkill() and not (Set(BDinvalid_skills))[skill:objectName()] then
								room:addPlayerMark(to, "Qingcheng"..skill:objectName())
								table.insert(BDinvalid_skills, skill:objectName())
							-- end
						end
						to:setTag("BDinvalidSkills", sgs.QVariant(table.concat(BDinvalid_skills, "+")))
						room:setPlayerMark(to, "Armor_Nullified", 1)
					end
				end
			end
		end
		return false
	end,
}
BDEClear = sgs.CreateTriggerSkill{ -- can_trigger標示 target的技能不能當公廁
	name = "#BDEClear" ,
	events = {sgs.EventLoseSkill} ,
	on_trigger = function(self, event, player, data)
		if data:toString() == "blooddry" then
			local room = player:getRoom()
			for _,p in sgs.qlist(room:getOtherPlayers(player)) do
				if p:hasFlag("BDEflag") then
					p:setFlags("-BDEflag")
					room:setPlayerMark(p, "@all_skill_invalidity", 0)
					local BDinvalid_skills = p:getTag("BDinvalidSkills"):toString():split("+") -- 當禪院被使用時，這個要開(有用)
					for _, skill_name in ipairs(BDinvalid_skills) do
						room:removePlayerMark(p, "Qingcheng"..skill_name)
					end
					p:setTag("BDinvalidSkills", sgs.QVariant())
					room:setPlayerMark(p, "Armor_Nullified", 0)
				end
			end
		end
	end,
	can_trigger = function(self, target)
		return target
	end ,
}	
-- 血噬：妳可以流失一點體力視為打出一張雷殺。當你的殺造成傷害時，若目標手牌數量大於你，妳可以獲取其手牌直到其手牌數量等同於你的體力值。

suckbloodVS = sgs.CreateZeroCardViewAsSkill{
	name = "suckblood",
	view_as = function(self)
		local usereason = sgs.Sanguosha:getCurrentCardUseReason()
		if (usereason == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE) or (usereason == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE) then
			local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
			if pattern == "slash" then
				local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
				slash:setSkillName(self:objectName())
				return slash
			end
		else
			local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
			slash:setSkillName(self:objectName())
			return slash
		end
		
	end,
	enabled_at_play = function(self, player)
		return player:getHp() > 0 and sgs.Slash_IsAvailable(player)
	end,
	enabled_at_response = function(self, target, pattern)
		return target:getHp() > 0 and (pattern == "slash")
	end
}
suckblood = sgs.CreateTriggerSkill{
	name = "suckblood",
	view_as_skill = suckbloodVS,
	events = {sgs.Damage, sgs.CardUsed, sgs.PreCardResponded},
	on_trigger = function(self, event, player, data, room)
		if (event == sgs.CardUsed) or (event == sgs.PreCardResponded) then
			local room = player:getRoom()
			local card = nil
			if event == sgs.CardUsed then
				card = data:toCardUse().card
			else
				local response = data:toCardResponse()
				card = response.m_card
			end
			if card and not card:isKindOf("SkillCard") and card:getSkillName() == "suckblood" then
				room:loseHp(player)
			end
		else
			local damage = data:toDamage()
			if not (damage.card or damage.from or damage.to or damage.to:isAlive()) then return false end
			if damage.card:isKindOf("Slash") and damage.from:hasSkill("suckblood") and damage.from:getHp() < damage.to:getHandcardNum() and room:askForSkillInvoke(damage.from, self:objectName(), data) then
				-- room:broadcastSkillInvoke(self:objectName())
				local room = damage.from:getRoom()
				local count = damage.to:getHandcardNum() - damage.from:getHp()
				if count == 0 then return false end
				-- damage.to:addMark("@skill_invalidity")
				for i = 1, count, 1 do
					if damage.to:isKongcheng() then break end
					local cid = room:askForCardChosen(damage.from, damage.to, "h", self:objectName())
					room:obtainCard(damage.from, cid, false)
				end
				if damage.from:isWounded() then
					local num = math.ceil(count/2)
					if num > damage.from:getLostHp() then num = damage.from:getLostHp() end
					local theRecover = sgs.RecoverStruct()
					theRecover.recover = num
					theRecover.who = damage.from
					room:recover(damage.from, theRecover)
				end
			end
		end
		return false
	end
}
--血源詛咒(所有不死系百合角都有)：鎖定技。每次你受到傷害或流失體力便獲得一點死戰標記。如果你的死戰標記2以上，妳不會受到傷害、流失生命，也不會再增加死戰標記。妳的出牌階段開始時，妳失去所有死戰標記。
bloody = sgs.CreateTriggerSkill{
	name = "bloody" ,
	frequency = sgs.Skill_Compulsory ,
	events = {sgs.PreHpLost, sgs.DamageInflicted, sgs.EventPhaseStart} ,
	on_trigger = function(self, event, player, data)
		-- if (event == sgs.DamageInflicted or event == sgs.PreHpLost) and player:getPhase() == sgs.Player_NotActive then
		if (event == sgs.DamageInflicted or event == sgs.PreHpLost) and player:getPhase() ~= sgs.Player_Play then
			if event == sgs.PreHpLost then
				local lose = data:toInt()
				if player:getMark("@struggle") > 1 then
					local room = player:getRoom()
					room:broadcastSkillInvoke(self:objectName() ,math.random(1, 4))
					local log = sgs.LogMessage()
					log.type = "#bloody_log"
					log.from = player
					log.arg = lose
					log.arg2 = "bloody"
					room:sendLog(log)
					return true 
				end
				player:gainMark("@struggle", lose)
			else
				local damage = data:toDamage()
				if player:getMark("@struggle") > 1 then
					local room = player:getRoom()
					room:broadcastSkillInvoke(self:objectName() ,math.random(1, 4))
					local log = sgs.LogMessage()
					log.type = "#bloody_log"
					log.from = player
					log.arg = tonumber(damage.damage)
					log.arg2 = "bloody"
					room:sendLog(log)
					damage.prevented = true
					data:setValue(damage)
					return true
				end
				player:gainMark("@struggle", damage.damage)
			end
		elseif (event == sgs.EventPhaseStart) and (player:getPhase() == sgs.Player_Play) then
			local x = player:getMark("@struggle")
			if x > 1 then
				player:drawCards(1)
			end
			player:loseAllMarks("@struggle")
		end
		return false
	end
}

--鞬出移植
yuri_jianchu = sgs.CreateTriggerSkill{
	name = "yuri_jianchu", 
	events = {sgs.TargetSpecified, sgs.ConfirmDamage, sgs.CardFinished},	--yun
	on_trigger = function(self, event, player, data)
		if event == sgs.TargetSpecified then
			local use = data:toCardUse()
			local room = player:getRoom()
			if use.card:isKindOf("Slash") then
				local index = 1
				local jink_table = sgs.QList2Table(player:getTag("Jink_" .. use.card:toString()):toIntList())
				for _, p in sgs.qlist(use.to) do
					if not player:isAlive() then break end
					local _data = sgs.QVariant()
					_data:setValue(p)
					if player:canDiscard(p, "he") and room:askForSkillInvoke(player, self:objectName(), _data) then
						room:broadcastSkillInvoke(self:objectName(), math.random(1, 2))
						room:addPlayerMark(player, self:objectName().."engine")
						if player:getMark(self:objectName().."engine") > 0 then
							local id = room:askForCardChosen(player, p, "he", self:objectName(), false, sgs.Card_MethodDiscard)
							room:throwCard(sgs.Sanguosha:getCard(id), p, player)
							if sgs.Sanguosha:getCard(id):isKindOf("EquipCard") then
								jink_table[index] = 0
							else
								if player:getAI() or player:getState() == "robot" then
									if use.card:hasFlag("drank") then room:addPlayerMark(player, "yuri_jianchu-Clear") end
								end
								local ids = sgs.IntList()
								if use.card:isVirtualCard() then
									ids = use.card:getSubcards()
								else
									ids:append(use.card:getEffectiveId())
								end
								if ids:length() > 0 then
									local all_place_table = true
									for _, id in sgs.qlist(ids) do
										if room:getCardPlace(id) ~= sgs.Player_PlaceTable then
											all_place_table = false
											break
										end
									end
									if all_place_table then
										p:obtainCard(use.card)
									end
								end
							end
							room:removePlayerMark(player, self:objectName().."engine")
						end
					end
					index = index+1
				end
				local jink_data = sgs.QVariant()
				jink_data:setValue(Table2IntList(jink_table))
				player:setTag("Jink_" .. use.card:toString(), jink_data)
			end
			return false
		end
		if event == sgs.CardFinished then
			if player:getMark("yuri_jianchu-Clear") > 0 then player:getRoom():setPlayerMark(player, "yuri_jianchu-Clear", 0) end
		end
		if event == sgs.ConfirmDamage then
			if player:getAI() or player:getState() == "robot" then
				local damage = data:toDamage()
				local room = player:getRoom()
				local card = damage.card
				if not card then return false end
				if card:isKindOf("Slash") and player:getMark("yuri_jianchu-Clear") > 0 then
					damage.damage = damage.damage + 1
					data:setValue(damage)
					return false
				end
			end
			return false
		end
		return false
	end
}

--良姻：當一名角色將牌置於武將牌後，你可以令一名手牌數或體力小於妳的角色摸一张牌；當一名角色從武將牌上/旁獲得牌後，你可以令一名手牌數或體力大於你的角色棄置一張牌。

yuri_liangyin = sgs.CreateTriggerSkill{
	name = "yuri_liangyin", 
	events = {sgs.CardsMoveOneTime}, 
	on_trigger = function(self, event, player, data, room)
		local move = data:toMoveOneTime()
		local players = sgs.SPlayerList()
		room:setPlayerMark(player, "yl_draw", 0)
		if move.from and move.to_place == sgs.Player_PlaceSpecial and not move.from:hasFlag("Fake_Move") then	--yun
			for _, p in sgs.qlist(room:getAlivePlayers()) do
				if p:getHandcardNum() < player:getHandcardNum() or p:getHp() < player:getHp() then
					room:setPlayerMark(player, "yl_draw", 1)
					players:append(p)
				end
			end
			if not players:isEmpty() then
				local to = room:askForPlayerChosen(player, players, self:objectName(), self:objectName().."-invoke", true, true)
				if to then
					room:broadcastSkillInvoke(self:objectName(), 1)
					to:drawCards(1, self:objectName())
				end
			end
		elseif move.to and move.to_place == sgs.Player_PlaceHand and move.from_places:contains(sgs.Player_PlaceSpecial) and not move.to:hasFlag("Fake_Move") then	--yun
			for _, p in sgs.qlist(room:getAlivePlayers()) do
				if (p:getHandcardNum() > player:getHandcardNum() or p:getHp() > player:getHp()) and not p:isNude() then
					players:append(p)
				end
			end
			if not players:isEmpty() then
				local to = room:askForPlayerChosen(player, players, self:objectName(), self:objectName().."-invoke_dis", true, true)
				if to then
					room:broadcastSkillInvoke(self:objectName(), 2)
					room:askForDiscard(to, self:objectName(), 1, 1, false, true)
				end
			end
		end
		return false
	end
}
--空笙：準備階段開始時，你可以令一名自己之外的角色獲得空笙，之後你可以將至多兩張牌置於武將牌上，稱為“聲”，結束階段開始時，妳獲得所有“聲”。若你不是空笙的原持有者，你失去空笙。
yuri_kongshengCard = sgs.CreateSkillCard{
	name = "yuri_kongsheng" ,
	will_throw = false,
	target_fixed = true,
	on_use = function(self, room, source, targets)
		source:addToPile("music", self)
	end
}
yuri_kongshengVS = sgs.CreateViewAsSkill{
	name = "yuri_kongsheng",
	n = 2,
    expand_pile = "music",
	response_pattern = "@yuri_kongsheng",
	view_filter = function(self, selected, to_select)
		return not sgs.Self:getPile("music"):contains(to_select:getEffectiveId())
	end,
	view_as = function(self, cards)
		if #cards ~= 0 then
			local card = yuri_kongshengCard:clone()
			for _, c in ipairs(cards) do
				card:addSubcard(c)
			end
			return card
		end
		return nil
	end,
	enabled_at_response = function(self, player, pattern)
		return pattern == "@yuri_kongsheng"
	end
}
yuri_kongsheng = sgs.CreatePhaseChangeSkill{
	name = "yuri_kongsheng",
	view_as_skill = yuri_kongshengVS,
	on_phasechange = function(self, player)
		local room = player:getRoom()
		if player:getPhase() == sgs.Player_Start then
			-- if player:getGeneralName() == "yuri_zhoufei" then
				-- local ori
				-- for _,t in sgs.qlist(room:getAlivePlayers()) do
					-- if t:getMark("yk_ori") > 0 then
						-- ori = t
						-- break
					-- end
				-- end
				if player:getMark("yk_ori") > 0 then
					local fri = room:askForPlayerChosen(player, room:getOtherPlayers(player), "yuri_kongsheng", "yuri_kongsheng_choiceplayer", true, true)
					if fri then
						room:acquireSkill(fri, "yuri_kongsheng")
					end
				else
					room:setPlayerMark(player, "yk_frim", 1)
				end
			-- end
			if not player:isNude() then
				room:askForUseCard(player, "@yuri_kongsheng", "@yuri_kongsheng", -1, sgs.Card_MethodNone)
			end
			
		elseif player:getPhase() == sgs.Player_Finish then
			if not player:getPile("music"):isEmpty() then
				local dummy = sgs.Sanguosha:cloneCard("slash")
				dummy:addSubcards(player:getPile("music"))
				room:obtainCard(player, dummy, false)
			end

			local fri
			for _,t in sgs.qlist(room:getAlivePlayers()) do
				if t:getMark("yk_frim") > 0 then
					fri = t
				end
				if fri then break end
			end
			if player:getMark("yk_frim") > 0 then
				room:setPlayerMark(player, "yk_frim", 0)
				if player:getGeneralName() ~= "yuri_zhoufei" then
					room:detachSkillFromPlayer(player, "yuri_kongsheng")
				end
			end
		end
	end
}
yuri_kongsheng_mark = sgs.CreateTriggerSkill{ 
	name = "#yuri_kongsheng_mark",
	events = {sgs.GameStart},
	on_trigger = function(self, event, player, data, room)
		local room = player:getRoom()
		room:setPlayerMark(player, "yk_ori", 1)
	end
}

--飛翼零式改
shuangpaocard = sgs.CreateSkillCard{
	name = "shuangpao",
	target_fixed = true,
	will_throw = false,
	on_use = function(self, room, source, targets)
		room:loseHp(source)
		local log = sgs.LogMessage()
        log.from = source
		log.arg = self:objectName()
        log.type = "#shuangpao"
        room:sendLog(log)
	end
}

shuangpaovs = sgs.CreateViewAsSkill{
	name = "shuangpao",
	n = 0,
	view_as = function(self, cards)
	if #cards == 0 then
		local acard = shuangpaocard:clone()
		acard:setSkillName("shuangpao")
		return acard
		end
	end,
	enabled_at_play = function(self,player)
		return not player:hasUsed("#shuangpao")
	end,
	enabled_at_response = function(self, player, pattern)
		return false
	end,
}

shuangpao = sgs.CreateTriggerSkill{
	name = "shuangpao",
	events = {sgs.DamageCaused},
	view_as_skill = shuangpaovs,
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
		local damage = data:toDamage()
		if damage.chain or damage.transfer or (not damage.by_user) then return false end
		if player:distanceTo(damage.to) > 1 and damage.card:isKindOf("Slash") and player:hasUsed("#shuangpao") then
			damage.damage = damage.damage + 1
		    data:setValue(damage)
			return false
		end
	end,
}


--收割：鎖定技。妳與其他角色的距離-X，你的殺可以額外指定X名目標，摸牌階段妳額外摸X張牌(最多三張)。(X為場上體力值一半以下的角色。)

--關於harvest_counter：因天生技的關係本技能不和可視技能做連貫，開啟global的話可以當公廁有效果，但這角色不存在就不需要這技能，所以不打算當公廁。
--經測試斷腸、纏怨都無法阻止天生技。
--原本以為要寫sgs.Death來判斷死人，或改if條件式<=1 -> ==1，不過經測試人死了就會自動扣除，大概是room:getAlivePlayers()的關係。
harvest = sgs.CreateTriggerSkill{   
	frequency = sgs.Skill_Compulsory,       
	name = "#harvest",            
	events = {sgs.DrawNCards ,sgs.AskForPeaches},
	on_trigger = function(self, event, player, data)        
		local room = player:getRoom() 
		if event == sgs.DrawNCards then
			local draw = data:toDraw()
			if draw.reason ~= "draw_phase" then return false end
			local count = 0
			for _, p in sgs.qlist(room:getAlivePlayers()) do
				if p:getHp() <= math.floor(p:getMaxHp()/2) then
					count = count + 1
				end
			end
			room:setPlayerMark(player, "Hponeguys", count)
			if count > 3 then count = 3 end
			if count > 0 then
				draw.num = draw.num + 3
				data:setValue(draw)        
		   end
		else
			local dying = data:toDying()
			if dying.who:objectName() ~= player:objectName() then
				return false
			end
			if player:getHp() > 0 then return false end
			local count = 0
			for _, t in sgs.qlist(room:getAlivePlayers()) do
				if t:getHp() <= math.floor(t:getMaxHp()/2) then
					count = count + 1
				end
			end
			if count > 0 then
				for _, p in sgs.qlist(room:getAlivePlayers()) do
					if p:getGeneralName() == "bloodymarry" then
						room:setPlayerMark(p, "Hponeguys", count)
					end
				end
			end
			if player:getMark("Hponeguys") > 1 and player:getMark("@SuperLimitBreak") > 0 and player:getGeneralName() == "bloodymarry" then
				room:sendCompulsoryTriggerLog(player, "harvest")
				room:recover(player, sgs.RecoverStruct(player, nil, 1 - player:getHp()))
			end
			player:setFlags("harvest_count_aw")
		end
		return false
   end
}

harvest_counter = sgs.CreateTriggerSkill{ 
	name = "#harvest_counter",
	events = {sgs.Damaged, sgs.HpLost, sgs.HpRecover},
	-- global = true,
	on_trigger = function(self, event, player, data, room)
		-- local room = player:getRoom()
		-- player:gainMark("@bear")
		if player:getHp() > 1 and not event == sgs.HpRecover then return end
		if player:hasFlag("harvest_count_aw") then player:setFlags("-harvest_count_aw") return end
		local count = 0
		for _, t in sgs.qlist(room:getAlivePlayers()) do
			-- if t:getHp() <= 1 then
			if t:getHp() <= math.floor(t:getMaxHp()/2) then
				count = count + 1
			end
		end
		if count > 0 then
			for _, p in sgs.qlist(room:getAlivePlayers()) do
				if p:getGeneralName() == "bloodymarry" then
					room:setPlayerMark(p, "Hponeguys", count)
				end
			end
		end
		return false
	end,
	can_trigger = function(self, target)
		return true --改成target也無傷大雅
	end
}

-- harvest_ud = sgs.CreateTriggerSkill{
	-- name = "#harvest_ud",
	-- frequency = sgs.Skill_Compulsory,
	-- events = {sgs.AskForPeaches},
	-- on_trigger = function(self, event, player, data)
		-- local room = player:getRoom()
		-- local dying = data:toDying()
		-- if dying.who:objectName() ~= player:objectName() then
			-- return false
		-- end
		-- if player:getHp() > 0 then return false end
		-- local count = 0
		-- for _, t in sgs.qlist(room:getAlivePlayers()) do
			-- if t:getHp() <= 1 then
				-- count = count + 1
			-- end
		-- end
		-- if count > 0 then
			-- for _, p in sgs.qlist(room:getAlivePlayers()) do
				-- if p:getGeneralName() == "bloodymarry" then
					-- room:setPlayerMark(p, "Hponeguys", count)
				-- end
			-- end
		-- end
		-- if player:getMark("Hponeguys") > 1 and player:getGeneralName() == "bloodymarry" then
			-- room:sendCompulsoryTriggerLog(player, "harvest")
			-- room:recover(player, sgs.RecoverStruct(player, nil, 1 - player:getHp()))
		-- end
		-- player:setFlags("harvest_count_aw")
		-- return false
	-- end
-- }
--[[
	描述：當你成為來源非自身之錦囊牌的目標時，妳可以立刻使用一張殺。當妳判定區有牌時，妳棄置之。
]]--
whosfromhell = sgs.CreateTriggerSkill{
	name = "whosfromhell" ,
	frequency = sgs.Skill_Compulsory,
	events = {sgs.TargetConfirmed} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local use = data:toCardUse()
		if use.card and use.from:objectName() ~= player:objectName() and use.card:isKindOf("TrickCard") and not use.card:isKindOf("SkillCard") and use.to:contains(player) then
			if use.card:isKindOf("DelayedTrick") and not use.card:isKindOf("YanxiaoCard") then
				room:throwCard(use.card, nil)
			end
			room:askForUseCard(player, "slash", "@askforslash")
		end
		return false
	end
}

protectdestroy = sgs.CreateTriggerSkill{
	name = "#protectdestroy",
	frequency = sgs.Skill_NotFrequent,
	events = {sgs.TargetConfirmed},
	on_trigger = function(self, event, player, data)
		if event == sgs.TargetConfirmed then
			local room = player:getRoom()
			local use = data:toCardUse()
			if use.from and player:objectName() == use.from:objectName() then
				if player:isAlive() and player:getGeneralName() == "bloodymarry" then
					local slash = use.card
					if slash:isKindOf("Slash") then
						for _,p in sgs.qlist(use.to) do
							local ai_data = sgs.QVariant()
							ai_data:setValue(p)
							--以下用了新函數hasEquipArea()
							if (p:getArmor() or p:getDefensiveHorse() or p:getOffensiveHorse() or p:hasEquipArea(1)) and player:askForSkillInvoke("protectdestroy", ai_data) then
								local log = sgs.LogMessage()
								log.from = player
								log.to:append(p)
								log.arg = "protectdestroy"
								log.type = "#protectdestroy_log"
								room:sendLog(log)
								if p:hasEquipArea(1) then
									p:throwEquipArea(1)
								end
								if p:getArmor() then
									room:throwCard(p:getArmor():getRealCard(), p, player)
								end	
								if p:getDefensiveHorse() then
									room:throwCard(p:getDefensiveHorse():getRealCard(), p, player)
								end
								if p:getOffensiveHorse() then
									room:throwCard(p:getOffensiveHorse():getRealCard(), p, player)
								end
							end
						end
					end
				end
			end
		end
		return false
	end,
	can_trigger = function(self, target)
		return target
	end
}

--界孫尚香：結姻

marriedCard = sgs.CreateSkillCard{ -- table.insert(hplist, p:getHp())
	name = "married",
	target_fixed = false,
	will_throw = false,
	filter = function(self, targets, to_select)
		return to_select:objectName() ~= sgs.Self:objectName()
	end,
	on_use = function(self,room,player,targets)
		local room = player:getRoom()
		local much
		local less
		if targets[1]:getHp() >= player:getHp() then
			much = targets[1]
			less = player
		else
			much = player
			less = targets[1]
		end
		if less:isWounded() then
			local theRecover = sgs.RecoverStruct()
			theRecover.recover = 1
			theRecover.who = player
			room:recover(less ,theRecover)
		end
		much:drawCards(1)
		local card_id = self:getSubcards():first()
		local card = sgs.Sanguosha:getCard(card_id)
		if card:isKindOf("EquipCard") and not targets[1]:isProhibited(targets[1], card) then
			local equip = card:getRealCard():toEquipCard()
			local equip_index = equip:location()
			if targets[1]:getEquip(equip_index) == nil then
				room:moveCardTo(self, targets[1], sgs.Player_PlaceEquip)
			else
				room:throwCard(targets[1]:getEquip(equip_index), nil)
				-- room:throwCard(player:getEquip(i-1), nil)
				room:moveCardTo(self, targets[1], sgs.Player_PlaceEquip)
			end
		else
			room:moveCardTo(self, targets[1], sgs.Player_PlaceHand)
		end
		
	end
}
	

married = sgs.CreateViewAsSkill{
	name = "married",
	n = 2,
	view_filter = function(self, selected, to_select)
		return #selected < 1
	end,
	view_as = function(self, cards)
		if #cards == 1 then
			local mac = marriedCard:clone()
			mac:addSubcard(cards[1])
			mac:setSkillName(self:objectName())
			return mac
		end
	end,
	enabled_at_play = function(self,player)
		return not player:isNude() and not player:hasUsed("#married")
	end
} 


--比翼 當妳成為錦囊牌的目標時，妳可以摸一张牌。若摸牌後手牌數量大於等於二，則必須棄置一張牌。
--友情提示：sgs.CardEffected為觸發條件時，askForCard、askForDisCard、askForCardChosen 全部無效
withwings = sgs.CreateTriggerSkill{
	name = "withwings",
	frequency = sgs.Skill_Frequent,
	events = {sgs.TargetConfirmed},
	on_trigger = function(self,event,player,data)
		if event == sgs.TargetConfirmed and player and player:isAlive() and player:hasSkill(self:objectName()) then
			local room = player:getRoom()
			
			local use = data:toCardUse()
			local card = use.card
			if use.to:contains(player) and not (card:isKindOf("AmazingGrace") or card:isKindOf("EquipCard") or card:isKindOf("SkillCard")) then 
				if player:getMark("wwagree") > 0 or room:askForSkillInvoke(player, self:objectName(), data) then
					room:addPlayerMark(player, "wwagree")
					player:drawCards(1)
					if player:getHandcardNum() > 2 then
						room:askForDiscard(player, "withwings", 1, 1, false, true, "#withwings-discard")
					end
					local num = player:getMark("wwagree")
					room:removePlayerMark(player, "wwagree", num)
				end
			end
		end
		return false
	end,
}

--雙飛：階段技，妳可以將兩張黑色手牌視為五穀豐登使用，或將兩張紅牌視為桃園結義使用。妳的桃園結義或五穀豐登最多可以取消X+1名目標。(X為當前手牌量，若本技能與"與共"同時發動，則計算數量較高者)

flyaway = sgs.CreateViewAsSkill{
	name = "flyaway" ,
	n = 2 ,
	view_filter = function(self, selected, card)
		if #selected == 0 then
			return not card:isEquipped()
		elseif #selected == 1 then
			local scard = selected[1]
			if scard:isRed() then
				return not card:isEquipped() and card:isRed()
			else
				return not card:isEquipped() and card:isBlack()
			end
		end
		return false
	end ,
	view_as = function(self, cards)
		if #cards ~= 2 then
			return nil 
		end
		local card = cards[1]
		local new_card = nil
		if card:getSuit() == sgs.Card_Spade or card:getSuit() == sgs.Card_Club then
			new_card = sgs.Sanguosha:cloneCard("amazing_grace", sgs.Card_SuitToBeDecided, 0)
		else
			new_card = sgs.Sanguosha:cloneCard("god_salvation", sgs.Card_SuitToBeDecided, 0)
		end
		if new_card then
			new_card:setSkillName(self:objectName())
			for _, c in ipairs(cards) do
				new_card:addSubcard(c)
			end
		end
		return new_card
	end ,
	enabled_at_play = function(self, player)
		return not player:isKongcheng()
	end
}
--flyaway_effect借用了千矢"與共"技能的技能卡
flyaway_effect = sgs.CreateTriggerSkill{
	name = "#flyaway_effect", 
	events = {sgs.PreCardUsed}, 
	view_as_skill = flexibleVS, 
	on_trigger = function(self, event, player, data, room)
		if event == sgs.PreCardUsed then
			local use = data:toCardUse()
			if use.from:objectName() == player:objectName() and (use.card:isKindOf("AmazingGrace") or use.card:isKindOf("GodSalvation")) then
				local num = player:getHandcardNum() + 1
				room:addPlayerMark(player, "friendlyTime")
				room:addPlayerMark(player, "fake_flexible", num)
				room:askForUseCard(player, "@@flexible", "@flexiblelog2")
				for _, p in sgs.qlist(room:getAllPlayers()) do
					if p:getMark("friendly") > 0 and not room:isProhibited(player, p, use.card) then
						room:removePlayerMark(p, "friendly")
						use.to:removeOne(p)
					end
				end
				room:removePlayerMark(player, "friendlyTime")
				room:removePlayerMark(player, "fake_flexible", num)
				room:sortByActionOrder(use.to)
				data:setValue(use)
			end
		end
	end, 
	can_trigger = function(self, target)
		return target and target:hasSkill("flyaway") and target:isAlive()
	end
}
--近戰：你手上的錦囊牌可以當作殺或閃使用。當你打出一張閃，可以立刻使用一張殺，此殺自動指定來源，且無視其非鎖定技。

meleemaster = sgs.CreateViewAsSkill{
	name = "meleemaster" ,
	n = 1 ,
	expand_pile = "wooden_ox",
	view_filter = function(self, selected, to_select)
		if #selected > 0 then return false end
			return to_select:isKindOf("TrickCard")
	end ,
	view_as = function(self, cards)
		if #cards ~= 1 then return nil end
		
		local originalCard = cards[1]
		local usereason = sgs.Sanguosha:getCurrentCardUseReason()
		if (usereason == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE) or (usereason == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE) then
			local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
			if pattern == "slash" then
				local slash = sgs.Sanguosha:cloneCard("slash", originalCard:getSuit(), originalCard:getNumber())
				slash:addSubcard(originalCard)
				slash:setSkillName(self:objectName())
				return slash
			else
				local jink = sgs.Sanguosha:cloneCard("jink", originalCard:getSuit(), originalCard:getNumber())
				jink:addSubcard(originalCard)
				jink:setSkillName(self:objectName())
				return jink
			end
		else
			local slash = sgs.Sanguosha:cloneCard("slash", originalCard:getSuit(), originalCard:getNumber())
			slash:addSubcard(originalCard)
			slash:setSkillName(self:objectName())
			return slash
		end
		
	end ,
	enabled_at_play = function(self, target)
		return sgs.Slash_IsAvailable(target)
	end,
	enabled_at_response = function(self, target, pattern)
		return (pattern == "slash") or (pattern == "jink")
	end
}

meleemaster_s = sgs.CreateTriggerSkill
{
	name = "#meleemaster_s",
	frequency = sgs.Skill_NotFrequent,
	events = {sgs.CardResponded, sgs.CardUsed},
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
		if event == sgs.CardResponded then
			local response = data:toCardResponse()
			local target = response.m_who
			local card = response.m_card
			if not card:isKindOf("Jink") then return false end
			-- target:addMark("@skill_invalidity")
			local slash = room:askForUseCard(player, "slash", "@askforslash")
			if slash and player:getMark("@SuperLimitBreak") > 0 then
				player:drawCards(1)
			end
		elseif event == sgs.CardUsed then
			local use = data:toCardUse()
			if use.card and use.card:isKindOf("Jink") then
				local slash = room:askForUseCard(player, "slash", "@askforslash")
				if slash and player:getMark("@SuperLimitBreak") > 0 then
					player:drawCards(1)
				end
			end
		end
		-- target:removeMark("@skill_invalidity")
	end,
}
-- 未來：鎖定技。與自己距離或自己與其距離二以下的角色在回合開始前，你可以觀看牌堆上兩張牌，當以下情況發生，在當前角色摸牌階段結束後，你可以摸X張牌。(X為符合狀況的數量，每個狀況不能重複計算)
-- 1.其中有殺，而你手牌沒有閃。
-- 2.其中有錦囊牌，而你手牌沒有無懈可擊。
-- 3.其中有裝備牌。


thefuture = sgs.CreateTriggerSkill
{
	name = "thefuture",
	frequency = sgs.Skill_Compulsory,
	-- events = {sgs.EventPhaseStart, sgs.AfterDrawNCards},
	events = {sgs.EventPhaseStart},
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
		for _, yuno in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
			if event == sgs.EventPhaseStart and player:objectName() ~= yuno:objectName() and (player:distanceTo(yuno) < 2 or  yuno:distanceTo(player) < 2) then
				if player:getPhase() == sgs.Player_Start then
					-- room:addPlayerMark(player, "@book", 1)
					local card_ids = room:getNCards(2) --生成一个sgs.IntList()，返回牌顶两张牌的ID。此方法将两张牌从牌顶移走。
					room:fillAG(card_ids, yuno)
					local choice_id = room:askForAG(yuno, card_ids, true, self:objectName())
					local hasjink = false
					local hasnull = false
					local num = 0
					for _,c in sgs.list(yuno:getHandcards()) do
						if c:isKindOf("Jink") then
							hasjink = true
						end
						if c:isKindOf("Nullification") then
							hasnull = true
						end
						if hasnull and hasjink then
							break
						end
					end
					local cardA = sgs.Sanguosha:getCard(card_ids:first())
					local cardB = sgs.Sanguosha:getCard(card_ids:last())
					
					if (cardA:isKindOf("Slash") or cardB:isKindOf("Slash")) and not hasjink then num = num + 1 end
					if (cardA:isKindOf("TrickCard") or cardB:isKindOf("TrickCard")) and not hasnull then num = num + 1 end
					if (cardA:isKindOf("EquipCard") or cardB:isKindOf("EquipCard")) then num = num + 1 end
					-- if cardA:isKindOf("Slash") and not hasjink then num = num + 1 end
					-- if cardA:isKindOf("TrickCard") and not hasnull then num = num + 1 end
					-- if cardA:isKindOf("EquipCard") then num = num + 1 end
					-- if cardB:isKindOf("Slash") and not hasjink then num = num + 1 end
					-- if cardB:isKindOf("TrickCard") and not hasnull then num = num + 1 end
					-- if cardB:isKindOf("EquipCard") then num = num + 1 end
					room:setPlayerMark(yuno, "thefuturecounter", 0)
					if num > 0 then 
						room:addPlayerMark(yuno, "thefuturecounter", num)
						if math.random(1, 5) > 3 then room:broadcastSkillInvoke("thefuture", math.random(1, 3)) end
					end
					if card_ids:length() == 1 then --牌顶只有一张
						room:moveCardTo(sgs.Sanguosha:getCard(card_ids:first()), yuno, sgs.Player_DrawPile, false)
					else
						room:moveCardTo(sgs.Sanguosha:getCard(card_ids:last()), yuno, sgs.Player_DrawPile, false)
						room:moveCardTo(sgs.Sanguosha:getCard(card_ids:first()), yuno, sgs.Player_DrawPile, false)
					end
					room:clearAG(yuno)
				end
				if player:getPhase() == sgs.Player_Play and yuno:getMark("thefuturecounter") > 0 then
					yuno:drawCards(yuno:getMark("thefuturecounter"))
					room:setPlayerMark(yuno, "thefuturecounter", 0)
				end
			end
		end
		return false
	end,
	can_trigger = function(self, player)
	    return true
	end,
}
-- 默契：鎖定技。受到傷害或流失體力時，翻開牌堆頂三張牌。將至少兩張相同花色的牌加入手牌，其餘棄置。若都沒有則全部棄置，摸一张牌。
tacitunderstanding = sgs.CreateTriggerSkill {
	name = "tacitunderstanding",
	events = {sgs.HpLost, sgs.Damaged},
	frequency = sgs.Skill_Compulsory,
	-- priority = function(self, event, priority)
		-- return self:getPriority(event)
	-- end,
	-- can_trigger = function(self, target)
		-- return target
	-- end,
	on_trigger = function(self, event, player, data)
		
		if (event == sgs.HpLost or event == sgs.Damaged) and player and player:isAlive() and player:hasSkill(self:objectName()) then
			local room = player:getRoom()
			local x = 0
			if event == sgs.HpLost then
				x = data:toInt()
			else
				-- room:addPlayerMark(player, "@book")
				local damage = data:toDamage()
				x = damage.damage
			end
			if x > 0 then
				room:broadcastSkillInvoke("tacitunderstanding", math.random(1, 2))
				for i = 1, x, 1 do
					room:sendCompulsoryTriggerLog(player, self:objectName())
					-- player:drawCards(2)
					local cardIds = room:getNCards(3) --取代下面那一長串綠色東西
					-- local cardIds = sgs.IntList()
					-- for j = 1, 3, 1 do
						-- local id = room:drawCard()
						-- cardIds:append(id)
					-- end
					-- assert(cardIds:length() == 3)
					local move = sgs.CardsMoveStruct()
					move.card_ids = cardIds
					move.to_place = sgs.Player_PlaceTable
					move.reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_TURNOVER, player:objectName(), "", "tacitunderstanding", "")
					room:moveCardsAtomic(move, true)
					room:getThread():delay()
					local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_NATURAL_ENTER, "", "tacitunderstanding", "")
					local id0 = cardIds:at(0)
					local id1 = cardIds:at(1)
					local id2 = cardIds:at(2)
					local card0 = sgs.Sanguosha:getCard(id0)
					local card1 = sgs.Sanguosha:getCard(id1)
					local card2 = sgs.Sanguosha:getCard(id2)
					local suit0 = card0:getSuit()
					local suit1 = card1:getSuit()
					local suit2 = card2:getSuit()
					if suit0 == suit1 and suit1 == suit2 then
						room:obtainCard(player, card0, true)
						room:obtainCard(player, card1, true)
						room:obtainCard(player, card2, true)
					elseif suit0 == suit2 then
						room:obtainCard(player, card0, true)
						room:obtainCard(player, card2, true)
						room:throwCard(card1, reason, nil)
					elseif suit1 == suit2 then
						room:obtainCard(player, card2, true)
						room:obtainCard(player, card1, true)
						room:throwCard(card0, reason, nil)
					elseif suit0 == suit1 then
						room:obtainCard(player, card1, true)
						room:obtainCard(player, card0, true)
						room:throwCard(card2, reason, nil)
					else
						room:throwCard(card0, reason, nil)
						room:throwCard(card1, reason, nil)
						room:throwCard(card2, reason, nil)
						player:drawCards(1)
					end
				end
			end
		end
		return false
	end
}

-- 偶像：階段技，你可以棄置兩張同花色牌，從最多棄置兩名角色的牌。若兩張皆是紅色，你恢復一點體力。

weareidleCard = sgs.CreateSkillCard{
	name = "weareidle",
	filter = function(self, targets, to_select)
		if #targets >= 2 or to_select:objectName() == sgs.Self:objectName() then return false end
		return not to_select:isAllNude()
	end,
	on_use = function(self, room, source, targets)
		room:setPlayerMark(source, "weareidle_two", 0)
		if #targets == 2 then
			room:setPlayerMark(source, "weareidle_two", 1)
		end
		for _,player in pairs(targets) do
			if player:isAlive() then
				room:cardEffect(self, source, player)
			end
		end
	end,
	on_effect = function(self, effect)
		local room = effect.from:getRoom()
		if effect.from:isAlive() and not effect.to:isAllNude() then
			local card_id = room:askForCardChosen(effect.from, effect.to, "hej", "weareidle")
			local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_EXTRACTION, effect.from:objectName())
			
			-- if effect.from:getMark("weareidle_two") > 0 then
				-- effect.from:addMark("weareidle_using")
				-- if effect.from:getMark("weareidle_using") > 1 then
					-- room:setPlayerMark(effect.from, "weareidle_using", 0)
					-- if sgs.Sanguosha:getCard(self:getSubcards():first()):isRed() then
						-- room:recover(effect.from, sgs.RecoverStruct(effect.from, nil, 1))
					-- else
						-- effect.from:drawCards(1)
					-- end
				-- end
			-- else
				-- if sgs.Sanguosha:getCard(self:getSubcards():first()):isRed() then
					-- room:recover(effect.from, sgs.RecoverStruct(effect.from, nil, 1))
				-- else
					-- effect.from:drawCards(1)
				-- end
			-- end
				-- room:obtainCard(effect.from, sgs.Sanguosha:getCard(card_id), reason, false)
				if  not effect.from:hasFlag("wri_used") then
					if sgs.Sanguosha:getCard(self:getSubcards():first()):isRed() then
						room:recover(effect.from, sgs.RecoverStruct(effect.from, nil, 1))
					else
						effect.from:drawCards(1)
					end
					effect.from:setFlags("wri_used")
				else
					effect.from:setFlags("-wri_used")
				end
				room:throwCard(card_id, effect.to, effect.from)
		end
	end
}

weareidle = sgs.CreateViewAsSkill{
	name = "weareidle",
	n = 2,
	view_filter = function(self, selected, to_select)
		if #selected == 0 then
			return not to_select:isEquipped()
		elseif #selected == 1 then
			local card = selected[1]
			if to_select:getSuit() == card:getSuit() then
				return not to_select:isEquipped()
			end
		else
			return false
		end
	end,
	view_as = function(self, cards)
		if #cards == 2 then
			local wric = weareidleCard:clone()
			wric:addSubcard(cards[1])
			wric:addSubcard(cards[2])
			return wric
		end
	end,
	enabled_at_play = function(self, player)
		return not player:isKongcheng() and not player:hasUsed("#weareidle")
		-- return not player:isKongcheng()
	end
}
		-- if #cards == 1 then
			-- local mac = marriedCard:clone()
			-- mac:addSubcard(cards[1])
			-- mac:setSkillName(self:objectName())
			-- return mac
		-- end
solidarity = sgs.CreateTriggerSkill{
	name = "solidarity$" ,
	events = {sgs.Damage} ,
	on_trigger = function(self, event, player, data)
		if event == sgs.Damage and player:isLord() then
			local room = player:getRoom()
			local damage = data:toDamage()
			local target = damage.to
			if not target or target:objectName() == player:objectName() or target:getKingdom() ~= "wei" then return false end
			if damage.damage > 0 then
				local players = sgs.SPlayerList()
					players:append(player)
					players:append(target)
					room:sortByActionOrder(players)
					room:broadcastSkillInvoke("solidarity", math.random(1, 2))
				for i = 1, damage.damage, 1 do
					if not target:isAlive() or not player:isAlive() then return false end
					local value = sgs.QVariant()
						value:setValue(target)
					if room:askForSkillInvoke(player,self:objectName(),value) then
						room:drawCards(players,1,self:objectName())
					end
				end
			end
		end
	end
}
-- 祝福：鎖定技。每當你需要打出殺或閃時，可以進行一次判定，若為黑桃則視為你打出了該牌，其餘則摸一张牌。
migonoinori = sgs.CreateTriggerSkill{
	name = "migonoinori",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.CardAsked},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local pattern = data:toStringList()[1]
		if pattern == "jink" or pattern == "slash" then
			if player:askForSkillInvoke("migonoinori") then
				room:broadcastSkillInvoke("migonoinori", math.random(1, 3))
				local judge = sgs.JudgeStruct()
				-- judge.pattern = ".|red"
				judge.pattern = ".|spade"
				judge.good = true
				judge.reason = "migonoinori"
				judge.who = player
				judge.play_animation = true
				room:judge(judge)
				if judge:isGood() then
					room:setEmotion(player, "armor/EightDiagram");
					if pattern == "jink" then
						local jink = sgs.Sanguosha:cloneCard("jink", sgs.Card_NoSuit, 0)
						jink:setSkillName("migonoinorijink")
						room:provide(jink)
					else
						local isUse = data:toStringList()[3] == "use"
						if isUse then return end
						local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
						slash:setSkillName("migonoinorislash")
						room:provide(slash)
					end
					return true
				else
					player:drawCards(1)
				end
			end
			return false
		end
		return false
	end,
	can_trigger = function(self, target)
		return target and target:isAlive() and target:hasSkill(self:objectName())
	end
}
-- 傾聽：判定階段結束後，你可以將一張牌至於牌堆頂、獲得判定牌。
listentonature = sgs.CreateTriggerSkill{
	name = "listentonature",
	events = {sgs.FinishJudge},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local judge = data:toJudge()
		local card = judge.card
		local all = room:getAllPlayers()
		local pattern = ".|black|."

		for _,p in sgs.qlist(all) do
			if p:hasSkill(self:objectName()) then
				if not p:isNude() then
					local card_id = card:getEffectiveId()
					room:setPlayerMark(p, "ltn_mark", card_id)  --ai
					
					if p:getMark("@SuperLimitBreak") > 0 then pattern = "."  end
					local newcard = room:askForExchange(p, self:objectName(), 1, 1, true, "@listentonature", true, pattern)
					if not newcard then return end
					
					if newcard then
						room:broadcastSkillInvoke("listentonature", math.random(1, 2))
						p:obtainCard(card)
						room:setPlayerMark(p, "ltn_mark", 0)
						room:throwCard(newcard, p)
						-- room:moveCardTo(newcard, p, sgs.Player_DrawPile, false)
						judge.card = newcard
					else
					    room:setPlayerMark(p, "ltn_mark", 0)
					end
				end
			end
		end
	end,
	can_trigger = function(self, target)
		return true
	end,
	priority = 2,
}

-- 守望：自己以外，一名體力值一以上的角色恢復一點體力時，你可以棄置一張黑牌，令其受到一點無來由的雷電傷害。一名體力值小於一的角色恢復體力時，你可以摸一张牌。
imwatching = sgs.CreateTriggerSkill{
    name = "imwatching",
	-- frequency = sgs.Skill_Frequent,
    events = {sgs.HpRecover, sgs.EventPhaseChanging, sgs.Death},
	can_trigger = function(self, player)
		return player
	end,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
		for _, owner in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
			if not owner or player:objectName() == owner:objectName() then continue end
			if event == sgs.EventPhaseChanging then
				local change = data:toPhaseChange()
				if not (change.to == sgs.Player_NotActive and player:getMark("&imwatching") > 1) then 
					return false 
				end
				local n = player:getHandcardNum()+player:getEquips():length()
				-- if owner:getMark("@SuperLimitBreak") > 0 and n > 0 then
				if n > 0 then
					local gbnum = math.max(n-player:getMark("&imwatching"), 0)
					local excard = room:askForExchange(player,self:objectName(),n,n,true)
					room:obtainCard(owner, excard, false)
					excard = room:askForExchange(owner,self:objectName(),n,gbnum,true)
					room:obtainCard(player, excard, false)
				else
					owner:drawCards(player:getMark("&imwatching"))
				end
				if player:isAlive() then room:setPlayerMark(player, "&imwatching", 0) end
			elseif event == sgs.Death then
				local death = data:toDeath()
				if death.who:objectName() ~= owner:objectName() or owner:objectName() ~= room:getCurrent():objectName() then
					return false
				end
				local players = room:getAllPlayers()
				for _,p in sgs.qlist(players) do
					if p:getMark("&imwatching") > 0 then room:setPlayerMark(p, "&imwatching", 0) end
				end
			elseif event == sgs.HpRecover then
				local pdata = sgs.QVariant()
				pdata:setValue(player)

				if player:getMark("&imwatching") > 0 and owner:getMark("@SuperLimitBreak") > 0 then
						local x = math.max(player:getMark("&imwatching"), 1)
						owner:drawCards(x)
				end
				if player:getMark("&imwatching")  < 3 and player:isAlive() then
					player:gainMark("&imwatching")
				end

				if player:getHp() > 1 then
					player:setFlags("Imw_target") -- 為了讓AI分辨敵友，只好多此一舉
					if room:askForSkillInvoke(owner, "imwatching", pdata) then -- 為了讓AI分辨敵友，只好多此一舉
						local bc = room:askForCard(owner, ".|black|.", "@imwatching", sgs.QVariant(), sgs.Card_MethodDiscard)
						
						room:addPlayerMark(player, "@skill_invalidity", 1)
						if bc then
							room:broadcastSkillInvoke("imwatching", math.random(1, 2))
							room:damage(sgs.DamageStruct("imwatching", nil, player, 1, sgs.DamageStruct_Thunder))
						end
						room:removePlayerMark(player, "@skill_invalidity", 1)
					end
				end
			end
		end
		
		return false
    end
}

--守望界限突破

imwatchingEx = sgs.CreateTriggerSkill{
name = "#imwatchingEx",
events = sgs.Death,
frequency = sgs.Skill_Compulsory,
on_trigger = function(self, event, player, data, room)
	local death = data:toDeath()
	if death.who:objectName() == player:objectName() or player:getMark("@SuperLimitBreak") == 0 or death.who:getMark("&imwatching")  == 0 then return false end
	-- if death.damage and death.damage.from and death.damage.from:objectName() == player:objectName() then
	player:drawCards(death.who:getMark("&imwatching"))
	return false
end
}


-- 壓制：一名目標使用殺、決鬥、順手牽羊時，你可以棄置一張黑牌，令其棄置一張與使用牌相同花色的牌，否則使用的牌無效。若其指定你，則無視攻擊距離。

bougairensha = sgs.CreateTriggerSkill{
	name = "bougairensha",
	events = {sgs.TargetConfirming},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local use = data:toCardUse()
		-- if not use.from or use.from:isDead() or use.from:hasSkill("bougairensha") or use.to:length() ~= 1 then return end
		if not use.from or use.from:isDead() or use.from:hasSkill("bougairensha") then return end
		if not use.card or use.card:isKindOf("SkillCard") then return end
		if not (use.card:isKindOf("Slash") or use.card:isKindOf("Duel") or use.card:isKindOf("Snatch")) then return end
		for _, inori in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
		-- if use.to:contains(inori) or inori:inMyAttackRange(use.from) then
			if inori then
				-- if not inori:isNude() and room:askForCard(inori, ".|club|.", "@bougairensha", newdata, sgs.Card_MethodDiscard) then
				room:setTag("bougairensha", data)
				if not inori:isNude() and room:askForCard(inori, ".|black|.", "@bougairensha", data, sgs.Card_MethodDiscard) then
					room:broadcastSkillInvoke("bougairensha", math.random(1, 2))
					
					local ids = sgs.IntList()
					if use.card:isVirtualCard() then
						ids = use.card:getSubcards()
					else
						ids:append(use.card:getEffectiveId())
					end
					-- local uc = sgs.Sanguosha:getCard(ids:first()) --舊版壓制
					-- local pattern = uc:getSuitString() --舊版壓制
					-- room:setPlayerMark(use.from, "bes_mark", ids:first()) --舊版壓制
					-- if not room:askForCard(use.from, ".|"..pattern.."|.|hand", "@bougairensha_es", sgs.QVariant(), sgs.Card_MethodDiscard) then --舊版壓制
						-- room:setPlayerFlag(use.from, "Global_PlayPhaseTerminated")
					-- end
					if not use.card:isKindOf("DelayedTrick") then
						local nullified_list = use.nullified_list
						table.insert(nullified_list, player:objectName())
						use.nullified_list = nullified_list
						data:setValue(use)
					else
						if ids:length() > 0 then
							room:throwCard(use.card, room:getCardOwner(use.card:getEffectiveId()), inori)
						end
					end
					-- room:setPlayerMark(use.from, "bes_mark", 0) --舊版壓制
					break
				end
				room:removeTag("bougairensha")
			end
		end
		return false
	end,
	can_trigger = function(self, player)
		return player
	end,
}

-- 寧靜：鎖定技。你的菱形牌均視為梅花牌。回合結束，可以令一名目標摸一张牌，然後獲得一枚“止水”標記(每名角色限兩個止水標記，每個止水標記增加手牌上限一張)。

-- sizukana = sgs.CreateFilterSkill{
	-- name = "sizukana",
	-- view_filter = function(self, to_select)
		-- return to_select:getSuit() == sgs.Card_Spade
	-- end,
	-- view_as = function(self, card)
		-- local id = card:getEffectiveId()
		-- local new_card = sgs.Sanguosha:getWrappedCard(id)
		-- new_card:setSkillName(self:objectName())
		-- new_card:setSuit(sgs.Card_Club)
		-- new_card:setModified(true)
		-- return new_card
	-- end
-- }

sizukana = sgs.CreatePhaseChangeSkill{
	name = "sizukana",
	frequency = sgs.Skill_Compulsory,
	on_phasechange = function(self, player)
		if player:getPhase() == sgs.Player_Finish then
			local room = player:getRoom()
			room:broadcastSkillInvoke("sizukana", 1)
			if not room:askForSkillInvoke(player, "sizukana") then return false end
			local list = room:getAlivePlayers()
			local fri = room:askForPlayerChosen(player, list, "sizukana", "@sizukana_choiceplayer")
			if fri then 
				if fri:getMark("@sizukana_mark") < 1 then fri:gainMark("@sizukana_mark", 1) end
				for _,t in sgs.qlist(list) do
					if t:getMark("@sizukana_mark") > 0 then
						t:drawCards(1, "sizukana")
					end
				end
			end
		end
		return false
	end
}
sizukana_global = sgs.CreateTriggerSkill{
	name = "#sizukana_global" ,
	mute = true,
	frequency = sgs.Skill_Compulsory ,
	events = {sgs.DrawNCards},
	can_trigger = function(self, target)
		return target:isAlive() and target:getMark("@sizukana_mark") > 0
	end,
	on_trigger = function(self, event, player, data)
		local draw = data:toDraw()
		if draw.reason ~= "draw_phase" then return false end
		local room = player:getRoom()
		local inori = room:findPlayerBySkillName("sizukana")
		if inori:getMark("@SuperLimitBreak") == 0 then return false end
		-- if event == sgs.DamageInflicted and player:getMark("@sizukana_mark") > 0 then
			-- local damage = data:toDamage()
			-- if damage.damage >= player:getHp() then
				-- player:loseAllMarks("@sizukana_mark")
			-- end

		-- elseif (event == sgs.DrawNCards) then
			draw.num = draw.num + 1
			data:setValue(draw)
		-- end
		return false
	end
}
-- 燃心：鎖定技。當你受到火焰傷害時，你恢復那個數值的體力，若滿體力，則摸牌。
		-- if event == sgs.DamageCaused then
			-- local damage = data:toDamage()
			-- if ((player:distanceTo(damage.to) == 1) or (damage.to:distanceTo(player) == 1)) and damage.by_user and (not damage.chain) and (not damage.transfer) then
				-- if player:askForSkillInvoke(self:objectName(), data) then
					-- local room = player:getRoom()
					-- local x = damage.damage + damage.from:getLostHp()
					-- damage.to:gainMark("@poison", x)
					-- return true
				-- end
			-- end
		-- end
moekogoro = sgs.CreateTriggerSkill{
	name = "moekogoro",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.DamageInflicted},
	on_trigger = function(self, event, player, data)
		local damage = data:toDamage()
		if damage.nature == sgs.DamageStruct_Fire then
			local x = damage.damage
			local room = player:getRoom()
			room:sendCompulsoryTriggerLog(damage.to, "moekogoro")
			while x > 0 do
				x = x - 1
				if player:isWounded() then
					local theRecover = sgs.RecoverStruct()
					theRecover.recover = 1
					theRecover.who = player
					room:recover(player ,theRecover)
				else
					player:drawCards(1, "moekogoro")
				end
			end
			return true
		end
		-- if player:getMark("") and damage.nature == sgs.DamageStruct_Ice or (damage.from:getWeapon() and damage.from:getWeapon():getClassName() == "IceSword") then
			-- local room = player:getRoom()
			-- local log = sgs.LogMessage()
			-- log.type = "#bloody_log"
			-- log.from = player
			-- log.arg = tonumber(damage.damage)
			-- log.arg2 = "moekogoro"
			-- room:sendLog(log)
			-- return true
		-- end
		return false
	end
}

-- 炙動：每個目標限一次。你的回合中，選擇一名自己以外的目標進行判定，若為紅心，則恢復一點體力，若為菱形，則摸一张牌。你摸X張牌。(X為此技能指定的目標數量)

hononozoukiCard = sgs.CreateSkillCard{
	name = "hononozouki",
	target_fixed = false,
	will_throw = true,
	filter = function(self, targets, to_select)
			return to_select:objectName() ~= sgs.Self:objectName() and to_select:getMark("hononozouki_used") < 1
		end,
		
	on_use = function(self, room, source, targets)
		for _,p in ipairs(targets) do
			room:setPlayerMark(p, "hononozouki_used", 1)
			local judge = sgs.JudgeStruct()
			judge.pattern = ".|red"
			judge.good = true
			judge.reason = "hononozouki"
			judge.who = p
			judge.play_animation = true
			room:judge(judge)
			if judge:isGood() then
				if judge.card:getSuit() == sgs.Card_Heart then	
					if p:isWounded() then
						local theRecover = sgs.RecoverStruct()
						theRecover.recover = 1
						theRecover.who = p
						room:recover(p ,theRecover)
					else
						p:drawCards(2)
					end
				else
					p:drawCards(1)
				end
			end
		end
		source:drawCards(#targets)

	end
}


hononozoukivs = sgs.CreateZeroCardViewAsSkill{
	name = "hononozouki",
	view_as = function()
		return hononozoukiCard:clone()
	end,
	enabled_at_play = function(self,player)
		-- return not player:hasUsed("#changesexual")
		return true
	end
}

hononozouki = sgs.CreateTriggerSkill{
	name = "hononozouki",	
	events = {sgs.EventPhaseStart},
	view_as_skill = hononozoukivs,
	on_trigger = function(self, event, player, data)
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish then
			local room = player:getRoom()
			for _,p in sgs.qlist(room:getOtherPlayers(player)) do
				room:setPlayerMark(p, "hononozouki_used", 0)
			end
		end
		return false
	end,
	can_trigger = function(self, target)
		return target:isAlive()
	end,
	-- priority = -1
}
-- 紅蓮：你的紅色錦囊牌在指定目標後，可以視為紅色火殺使用。
hononochikara = sgs.CreateTriggerSkill{
	name = "hononochikara",
	frequency = sgs.Skill_NotFrequent,
	events = {sgs.CardUsed},
	
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		-- local source = room:findPlayerBySkillName(self:objectName())
		if event == sgs.CardUsed then
			local use = data:toCardUse()
			-- use.from:gainMark("@bear")
			if use.card:isKindOf("TrickCard") and use.card:isRed() and not use.card:isKindOf("Nullification") then
				-- local target_data = sgs.QVariant()
				-- target_data:setValue(use.from)
				-- use.from:setTag("LuaTrickOrTreatCardUse", data)
				if not room:askForSkillInvoke(use.from, self:objectName(), data) then return false end
				-- room:doAnimate(1, source:objectName(), use.from:objectName())
				room:broadcastSkillInvoke("hononochikara", math.random(1, 2))
				local Slash = sgs.Sanguosha:cloneCard("fire_slash", sgs.Card_NoSuit, use.card:getNumber())
				if not use.card:isVirtualCard() then
					Slash:addSubcard(use.card)
				elseif use.card:subcardsLength() > 0 then
					for _, id in sgs.qlist(use.card:getSubcards()) do Slash:addSubcard(id) end
				end
				use.card = Slash
				use.card:setSkillName(self:objectName())
				data:setValue(use)
				local log = sgs.LogMessage()
				log.from = use.from
				log.type = "#UseCard"
				log.card_str = use.card:toString()
				room:sendLog(log)
			end
			return false
		end
	end,
	
	-- can_trigger = function(self, target)
		-- return target:isAlive() and target:hasSkill(self:objectName())
	-- end,
}


--榮慧_判定開始前，可以用一張牌與判定牌交換
wisdom_s = sgs.CreateTriggerSkill{
	name = "wisdom_s" ,
	events = {sgs.AskForRetrial} ,
	can_trigger = function(self, target)
		if not (target and target:isAlive() and target:hasSkill(self:objectName())) then return false end
		if target:isNude() then
			return false
		else
			return true
		end
	end ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local judge = data:toJudge()
		local prompt_list = {
			"@wisdom-card" ,
			judge.who:objectName() ,
			self:objectName() ,
			judge.reason ,
			tostring(judge.card:getEffectiveId())
		}
		local prompt = table.concat(prompt_list, ":")
		local card = room:askForCard(player, "..", prompt, data, sgs.Card_MethodResponse, judge.who, true)
		if card then
			if judge.reason == "chikuwasama" and card:isRed() then
				player:setFlags("used_wisdom_red")
			end
			if judge.reason == "chikuwasama" and card:isBlack() then
				player:setFlags("used_wisdom_black")
			end
			if not (player:hasFlag("used_wisdom_black") or player:hasFlag("used_wisdom_red")) then
				room:broadcastSkillInvoke("wisdom_s", math.random(1, 2))
			end
			room:retrial(card, player, judge, self:objectName(), true)
			if player:getMark("@SuperLimitBreak") > 0 and player:isWounded() and card:getSuit() == sgs.Card_Heart and card:isKindOf("BasicCard") then
				player:setFlags("Wisdom_s_Using")
				local c = sgs.Sanguosha:cloneCard("peach", sgs.Card_NoSuit, 0)
				room:useCard(sgs.CardUseStruct(c, player, player), false)
				player:setFlags("-Wisdom_s_Using")
			end
		end
		return false
	end
}

-- 竹輪：鎖定技。場上所有人用使用桃時，進行一次判定，若是紅色，則你與其各摸一张牌，黑色，則令其棄置一張牌。當卡片因聰慧效果而更改判定時，不論之後是否繼續改判，效果依舊根據聰慧的改判卡判定。
chikuwasama = sgs.CreateTriggerSkill{
	name = "chikuwasama" ,
	frequency = sgs.Skill_Compulsory,
	events = {sgs.PreHpRecover} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		for _, asuka in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
			if asuka and asuka:hasFlag("Wisdom_s_Using") then continue end
			if (event == sgs.PreHpRecover) then
				local rec = data:toRecover()
				if (asuka:getMark("@SuperLimitBreak") > 0 and rec.recover > 0) or (rec.card and rec.card:isKindOf("Peach")) then
					if math.random(1, 10) < 4 then
						room:broadcastSkillInvoke("chikuwasama", math.random(1, 2))
					end
					local log = sgs.LogMessage()
					log.from = asuka
					log.to:append(player)
					log.arg = "chikuwasama"
					log.type = "#chikuwasama_log"
					room:sendLog(log)
					local judge = sgs.JudgeStruct()
					judge.pattern = ".|red"
					judge.good = true
					judge.reason = "chikuwasama"
					judge.who = player
					judge.play_animation = true
					room:judge(judge)
					if judge:isBad() or asuka:hasFlag("used_wisdom_black") then
						if asuka:hasFlag("used_wisdom_black") then
							asuka:setFlags("-used_wisdom_black")
							room:broadcastSkillInvoke("wisdom_s", 3)
							local log2 = sgs.LogMessage()
							log2.arg = "wisdom_s"
							log2.type = "#chikuwasama_log2"
							room:sendLog(log2)
						end
						if not player:isNude() then
							room:askForDiscard(player,self:objectName(),1,1,false,true)
						end
						-- if asuka:getMark("@SuperLimitBreak") > 0 and not player:hasSkill("chanyuan") then
							-- room:acquireSkill(player, "chanyuan")
						-- end
						-- if asuka:getMark("@SuperLimitBreak") > 0 and not asuka:hasSkill("guhuo") then
							-- asuka:setFlags("kaeriuchiAcq:guhuo")
							-- room:acquireSkill(asuka, "guhuo")
						-- end
						asuka:drawCards(1)
						return false
					end
					if judge:isGood() or asuka:hasFlag("used_wisdom_red") then
						if asuka:hasFlag("used_wisdom_red") then
							room:broadcastSkillInvoke("wisdom_s", 3)
							asuka:setFlags("-used_wisdom_red")
							local log2 = sgs.LogMessage()
							log2.arg = "wisdom_s"
							log2.type = "#chikuwasama_log2"
							room:sendLog(log2)
						end
						if asuka:objectName() ~= player:objectName() then
							asuka:drawCards(1)
						end
						player:drawCards(1)
					end
					-- rec.recover = rec.recover + 1
					-- data:setValue(rec)
				end
			end
		end
		return false
	end ,
	can_trigger = function(self, target)
		return target
	end
}

-- 預知：鎖定技。你成為殺的目標時，必須棄置一張牌摸一张牌，然後殺對妳無效。(沒牌棄則依然有效)

yochi = sgs.CreateTriggerSkill{
	name = "yochi",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.TargetConfirming},
	on_trigger = function(self, event, player, data)
		local use = data:toCardUse()
		local room = player:getRoom()
		if use.card and use.card:isKindOf("Slash") and use.to:contains(player) and player:canDiscard(player, "he") then
			
			room:sendCompulsoryTriggerLog(player, self:objectName())
			room:askForDiscard(player,self:objectName(),1,1,false,true)
			player:drawCards(1)
			room:setEmotion(player, "jink")
			if math.random(1, 10) < 4 then
				room:broadcastSkillInvoke("yochi", math.random(1, 2))
			end
			local nullified_list = use.nullified_list
            table.insert(nullified_list, player:objectName())
            use.nullified_list = nullified_list
            data:setValue(use)
		else
			return false
		end
	end,
	can_trigger = function(self, target)
		return target ~= nil and target:isAlive() and target:hasSkill(self:objectName())
	end
}
-- 預見：你的回合中，你可以觀看任一角色的手牌。
yomiCard = sgs.CreateSkillCard{
	name = "yomi",
	filter = function(self, targets, to_select)
		if to_select:objectName() ~= sgs.Self:objectName() and (#targets == 0) then
			return not to_select:isKongcheng()
		end
	end,
	on_use = function(self, room, source, targets)
		room:showAllCards(targets[1], source)
		targets[1]:setFlags("yomi_AI")
	end,
}
yomi = sgs.CreateZeroCardViewAsSkill{
	name = "yomi",
	view_as = function(self, cards)
		return yomiCard:clone()
	end,
	enabled_at_play = function(self, player)
		local others = player:getSiblings()
		for _,p in sgs.qlist(others) do
			if not p:isKongcheng() then
				return true
			end
		end
		return false
	end
}

--感知：每回合限一次。指定一名目標，令其無法打出基本牌、錦囊牌，直到其回合開始。

kanchiCard = sgs.CreateSkillCard{
	name = "kanchi",
	filter = function(self, targets, to_select)
		if to_select:objectName() ~= sgs.Self:objectName() and (#targets == 0) then
			return to_select:getMark("@cant_use_tb") == 0
		end
	end,
	on_use = function(self, room, source, targets)
		local room = source:getRoom()
		-- local _type = choice.."|.|.|hand" --只是手牌
		room:setPlayerCardLimitation(targets[1], "use,response", "BasicCard", false)--如果用true則無視底下那個清除用技能，必須等到目標下個回合結束，效果才消失 
		room:setPlayerCardLimitation(targets[1], "use,response", "TrickCard", false)
		room:addPlayerMark(targets[1], "@cant_use_tb")
		room:addPlayerMark(targets[1], "&kanchi+to+#"..source:objectName().."-Clear")

	end,
}

kanchi = sgs.CreateZeroCardViewAsSkill{
	name = "kanchi",
	view_as = function(self, cards)
		return kanchiCard:clone()
	end,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#kanchi")
	end
}

kanchi_clear = sgs.CreateTriggerSkill{
	name = "#kanchi_clear",
	events = {sgs.EventPhaseChanging,sgs.Death},
	priority = 5,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.EventPhaseChanging then
			local change = data:toPhaseChange()
			if change.to ~= sgs.Player_NotActive then 
				return false 
			end
		elseif event == sgs.Death then
			local death = data:toDeath()
			if death.who:objectName() ~= player:objectName() or player:objectName() ~= room:getCurrent():objectName() then
				return false
			end
		end
		local players = room:getAllPlayers()
		for _,p in sgs.qlist(players) do
			if p:getMark("@cant_use_tb") > 0 then
				room:removePlayerCardLimitation(p, "use,response", "BasicCard")
				room:removePlayerCardLimitation(p, "use,response", "TrickCard")
				room:setPlayerMark(p, "@cant_use_tb", 0)
				-- p:gainMark("@book")
			end
		end
		return false
	end,
	can_trigger = function(self, target)
		return target
	end
}

--百王版本_歸心：每当你受到1点伤害后，你可以對所有角色做出選擇：棄置其一張牌令其摸一张牌，或你獲得其一張牌。若你獲得的牌數大於失去的生命，或你背面朝上，則你翻面。

yuri_guixin = sgs.CreateMasochismSkill{
	name = "yuri_guixin" ,
	on_damaged = function(self, player, damage)
		local room = player:getRoom()
		local n = player:getMark("GuixinTimes")--这个标记为了ai
		player:setMark("GuixinTimes", 0)
		local data = sgs.QVariant()
		data:setValue(damage)
		local players = room:getOtherPlayers(player)
		for i = 0, damage.damage - 1, 1 do
			player:addMark("GuixinTimes")
			if player:askForSkillInvoke(self:objectName(), data) then
				room:broadcastSkillInvoke("yuri_guixin", math.random(1, 2))
				local gct = 0
				local pdata = sgs.QVariant()
				for _, p in sgs.qlist(players) do
					if p:isAlive() and (not p:isAllNude()) then
						pdata:setValue(p)
						
						p:setFlags("yuri_guixinUsing")
						local log = sgs.LogMessage()
						log.type = "#yg_log"
						log.from = player
						log.to:append(p)
						log.arg = "yuri_guixin"
						room:sendLog(log)
						local card_id = room:askForCardChosen(player, p, "hej", self:objectName())
						if room:askForChoice(player, "yuri_guixin", "yg_dis+yg_obtain", pdata) == "yg_obtain" then
							local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_EXTRACTION, player:objectName())
							-- local card_id = room:askForCardChosen(player, p, "hej", self:objectName())
							room:obtainCard(player, sgs.Sanguosha:getCard(card_id), reason, room:getCardPlace(card_id) ~= sgs.Player_PlaceHand)
							gct = gct + 1
						else
							-- local card_id = room:askForCardChosen(player, p, "hej", self:objectName())
							room:throwCard(sgs.Sanguosha:getCard(card_id), p, player)
							p:drawCards(1)
						end
					end
				end
				if gct > player:getLostHp() or not player:faceUp() then
					player:turnOver()
				end
			else
				break
			end
		end
		player:setMark("GuixinTimes", n)
	end
}

-- 巨資：鎖定技。回合開始時，你摸X張牌，該回合手牌上限增加X，X根據以下條件計算。
-- 1.已受傷：X+1
-- 2.手牌數三張以下：X+1
-- 3.X+延時錦囊牌的數量

okanemochi = sgs.CreatePhaseChangeSkill{
	name = "okanemochi",
	frequency = sgs.Skill_Compulsory,
	on_phasechange = function(self, player)
		if player:getPhase() == sgs.Player_Start then
			local room = player:getRoom()
			local n = 0
			room:setPlayerMark(player, "okanemochi_maxh", 0)
			if player:isWounded() then n=n+1 end
			if player:getHandcardNum() < 3 then n=n+1 end
			n = n + player:getCards("j"):length()
			if n > 0 then
				room:broadcastSkillInvoke("okanemochi", math.random(1, 2))
				player:drawCards(n, self:objectName())
				room:setPlayerMark(player, "okanemochi_maxh", n)
				room:setPlayerMark(player, "&okanemochi-Clear", n)
			end
		end
		return false
	end
}

-- 謀策：轉換技。你可以棄置一張牌，輪流發動以下效果：@ChangeSkill1 1.令一名目標受到一點傷害摸一张牌。2.令一名目標恢復一點體力棄置兩張牌。3.對自己造成一點傷害摸三張牌。
barakurosakuCard = sgs.CreateSkillCard{
	name = "barakurosaku", 
	filter = function(self, targets, to_select) 
		if sgs.Self:getMark("@ChangeSkill3") > 0 then
			return to_select:objectName() == sgs.Self:objectName()
		else
			return #targets == 0
		end
	end, 
	on_use = function(self, room, source, targets)
		local log = sgs.LogMessage()
		log.arg = "barakurosaku"
		log.arg2 = 3 + source:getMark("okanemochi_maxh") - source:usedTimes("#barakurosaku")
		log.type = "#barakurosaku_log"
		room:sendLog(log)
		room:setPlayerMark(source, "barakurosaku_used", 0)
		if source:getMark("@ChangeSkill1") > 0 and source:getMark("barakurosaku_used") == 0 then
			room:setPlayerMark(source, "@ChangeSkill1", 0)
			room:setPlayerMark(source, "@ChangeSkill2", 1)
			room:damage(sgs.DamageStruct(self:objectName(), source, targets[1]))
			targets[1]:drawCards(1, self:objectName())
			room:setPlayerMark(source, "barakurosaku_used", 1)
			if math.random(1, 10) < 3 then room:broadcastSkillInvoke("okanemochi", 3) end
		end
		if source:getMark("@ChangeSkill2") > 0 and source:getMark("barakurosaku_used") == 0 then
			room:setPlayerMark(source, "@ChangeSkill2", 0)
			room:setPlayerMark(source, "@ChangeSkill3", 1)
			room:recover(targets[1], sgs.RecoverStruct(source, nil, 1))
			room:askForDiscard(targets[1],self:objectName(),2,2,false,true)
			room:setPlayerMark(source, "barakurosaku_used", 1)
			if math.random(1, 10) < 3 then room:broadcastSkillInvoke("okanemochi", 4) end
		end
		if source:getMark("@ChangeSkill3") > 0 and source:getMark("barakurosaku_used") == 0 then
			room:setPlayerMark(source, "@ChangeSkill3", 0)
			room:setPlayerMark(source, "@ChangeSkill1", 1)
			room:damage(sgs.DamageStruct(self:objectName(), source, source))
			local num = math.min(5, 2+source:getLostHp())
			source:drawCards(num, self:objectName())
			room:setPlayerMark(source, "barakurosaku_used", 1)
			if math.random(1, 10) < 3 then room:broadcastSkillInvoke("okanemochi", 5) end
		end
	end
}
barakurosakuVS = sgs.CreateOneCardViewAsSkill{
	name = "barakurosaku", 
	filter_pattern = ".", 
	view_as = function(self, card) 
		local cards = barakurosakuCard:clone()
		cards:addSubcard(card)
		return cards
	end, 
	enabled_at_play = function(self, player)
		return not player:isNude() and player:usedTimes("#barakurosaku") < 3 + player:getMark("okanemochi_maxh")
	end
}
barakurosaku = sgs.CreateTriggerSkill{ 
	name = "barakurosaku",
	view_as_skill = barakurosakuVS, 
	events = {sgs.GameStart},
	on_trigger = function(self, event, player, data, room)
		room:addPlayerMark(player, "@ChangeSkill1")
end
}


-- 監管，一名角色於棄牌階段沒棄牌，且其手牌和裝備合計數大於等於你，你可以棄置其一張牌(不觸發非鎖定技)。棄置超過一張牌時，妳可以令其摸一张牌。
kanshi = sgs.CreateTriggerSkill{
	name = "kanshi",
	frequency = sgs.Skill_NotFrequent,
	events = {sgs.CardsMoveOneTime},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if player then
				if player:getPhase() == sgs.Player_Discard then
					local n = 0
					local move = data:toMoveOneTime()
					if move.card_ids:length() < 2 then return false end
					for _,card_id in sgs.qlist(move.card_ids) do
						local flag = bit32.band(move.reason.m_reason, sgs.CardMoveReason_S_MASK_BASIC_REASON)
						if flag == sgs.CardMoveReason_S_REASON_DISCARD then
							n = n + 1
						end
					end
					room:setPlayerMark(player, "kanshi_count", n)
					-- room:setPlayerMark(player, "@book", n)
				end
			-- end
		end
		return false
	end,
	can_trigger = function(self, target)
		return target
	end
}

kanshi_e = sgs.CreateTriggerSkill{
	name = "#kanshi_e",
	frequency = sgs.Skill_Frequent,
	events = {sgs.EventPhaseEnd},
	on_trigger = function(self, event, player, data)
		if not player:isDead() then
			local room = player:getRoom()
			local pdata = sgs.QVariant()
			pdata:setValue(player)
			for _, user in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
				if not player:isAllNude() and player:getMark("kanshi_count") == 0 and player:getCards("he"):length() >= user:getCards("he"):length() and room:askForSkillInvoke(user, "kanshi_dis", pdata) then
					local log = sgs.LogMessage()
					log.type = "#kanshi_dis_log"
					log.to:append(player)
					log.arg = "kanshi"
					room:sendLog(log)
					room:broadcastSkillInvoke("kanshi", math.random(1, 2))
					local card_id = room:askForCardChosen(user, player, "jhe", "kanshi", false, sgs.Card_MethodDiscard)
					room:addPlayerMark(player, "@skill_invalidity")
					room:throwCard(sgs.Sanguosha:getCard(card_id), player, user)
					room:removePlayerMark(player, "@skill_invalidity")
				end
				if player:getMark("kanshi_count") > 1 and room:askForSkillInvoke(user, "kanshi", pdata) then
					local num = math.floor(player:getMark("kanshi_count")/2)
					if num == 0 then return false end
					room:broadcastSkillInvoke("kanshi", math.random(3, 4))
					player:drawCards(num)
				end
			end
			room:setPlayerMark(player, "kanshi_count", 0)
		end
		return false
	end,
	can_trigger = function(self, target)
		if target then
			return target:getPhase() == sgs.Player_Discard
		end
		return false
	end
}

-- 幻術：鎖定技。回合結束時，你從牌堆將一張牌至於武將牌上，稱為"幻影"，並獲得原有的幻影牌。幻影不可見。當你成為殺或非延時錦囊牌的目標時，若該牌與幻影牌花色相同，妳免疫該牌，不同，則妳摸一张牌加入幻影牌(最多兩張)。

genjutsu = sgs.CreateTriggerSkill{
	name = "genjutsu" ,
	frequency = sgs.Skill_Compulsory,
	events = {sgs.TargetConfirmed, sgs.EventPhaseStart},
	-- events = {sgs.TargetConfirmed},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
			if event == sgs.TargetConfirmed then
			local use = data:toCardUse()
				-- if use.to:contains(player) and use.from:objectName() ~= player:objectName() and not player:getPile("gensou"):isEmpty() then
				if use.to:contains(player) and use.from:objectName() ~= player:objectName() then
					if use.card:isKindOf("Slash") or use.card:isKindOf("TrickCard") then
					
						local suit = use.card:getSuit()
						local block = false
						 for _,card_id in sgs.qlist(player:getPile("gensou")) do
							if (sgs.Sanguosha:getCard(card_id):getSuit() == suit) then
								block = true
								break
							end
						end
						
						local maxnum = 2
						if player:getMark("@SuperLimitBreak") > 0 then maxnum = 4 end
						
						if block then
							if math.random(1, 10) < 3 then room:broadcastSkillInvoke("genjutsu", math.random(5, 6)) end
							player:setFlags("-genjutsuTarget")
							player:setFlags("genjutsuTarget")
							if player:isAlive() and player:hasFlag("genjutsuTarget") then
								if use.card:isKindOf("DelayedTrick") then
									use.to = sgs.SPlayerList()
									data:setValue(use)
								else
									player:setFlags("-genjutsuTarget")
									local nullified_list = use.nullified_list
									table.insert(nullified_list, player:objectName())
									use.nullified_list = nullified_list
									data:setValue(use)
								end
							end
							local log = sgs.LogMessage()
							log.type = "#genjutsu_log"
							log.from = player
							log.card_str = use.card:toString()
							log.arg = self:objectName()
							room:sendLog(log)
						elseif player:getPile("gensou"):length() < maxnum then
							room:broadcastSkillInvoke("genjutsu", math.random(3, 4))
							room:sendCompulsoryTriggerLog(player, self:objectName())
							local id = room:drawCard()
							player:addToPile("gensou", id, false)
							-- player:drawCards(1)
						end
					end
				end
			end
			
			if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish then
				room:sendCompulsoryTriggerLog(player, self:objectName())
				if not player:getPile("gensou"):isEmpty() then
					for _,card_id in sgs.qlist(player:getPile("gensou")) do
						local card = sgs.Sanguosha:getCard(card_id)
						if card:isKindOf("EquipCard") or card:isKindOf("BasicCard") then
							local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_EXCHANGE_FROM_PILE, player:objectName())
							room:obtainCard(player, card, reason, false)
						elseif card:isKindOf("TrickCard") then
							local slash = sgs.Sanguosha:cloneCard("slash", card:getSuit(), card:getNumber())
							slash:addSubcard(card)
							slash:setSkillName("genjutsuslash")
							room:setCardFlag(slash, "SlashIgnoreArmor")
							slash:deleteLater()
							local list = room:getOtherPlayers(player)
							local guys = sgs.SPlayerList()
							for _,t in sgs.qlist(list) do
								if player:canSlash(t, slash) and not room:isProhibited(player, t, slash) then
									guys:append(t)
								end
							end
							local target = room:askForPlayerChosen(player, guys, self:objectName(), "@askforslash", true, true)
							if target then
								-- room:setPlayerMark(target, "Armor_Nullified", 1)
								room:useCard(sgs.CardUseStruct(slash, player, target), false)
								-- room:setPlayerMark(target, "Armor_Nullified", 0)
							else
								room:throwCard(card, nil)
							end
						end
					end
				end
				room:broadcastSkillInvoke("genjutsu", math.random(1, 2))
				local id = room:drawCard()
                player:addToPile("gensou", id, false)
			end
		return false
	end
}

-- 意志：鎖定技。鎖定技。遊戲開始時你獲得三枚硬幣。你判定區的兵糧寸斷、樂不思蜀判定效果反轉。當你的牌被其他人棄置或獲得時，選擇一名目標令其摸失去數量的牌。


tsuyoiishiki = sgs.CreateTriggerSkill{
	name = "tsuyoiishiki",
	events = {sgs.GameStart, sgs.StartJudge, sgs.BeforeCardsMove},
	frequency = sgs.Skill_Compulsory,
	on_trigger = function(self, event, player, data, room)
		if event == sgs.GameStart then
			room:sendCompulsoryTriggerLog(player, self:objectName())
			player:gainMark("@kiyoi_coin", 3)
			room:broadcastSkillInvoke("tsuyoiishiki", 1)
			return true
		elseif event == sgs.StartJudge then
			local judge = data:toJudge()
			if judge.reason == "indulgence" or judge.reason == "supply_shortage" then
				room:broadcastSkillInvoke("tsuyoiishiki", 3)
				judge.good = not judge.good
			end
			room:sendCompulsoryTriggerLog(player, self:objectName())
		elseif event == sgs.BeforeCardsMove then
			local move = data:toMoveOneTime()
			if move.reason.m_reason == sgs.CardMoveReason_S_REASON_JUDGE or move.reason.m_reason == sgs.CardMoveReason_S_REASON_USE then return false end
			if move.from and move.from:objectName() == player:objectName() and (move.from_places:contains(sgs.Player_PlaceHand) or move.from_places:contains(sgs.Player_PlaceEquip) or move.from_places:contains(sgs.Player_PlaceJudge)) and ((move.to_place == sgs.Player_DiscardPile and move.reason.m_reason == sgs.CardMoveReason_S_REASON_DISMANTLE and move.reason.m_playerId ~= move.reason.m_targetId) or (move.to and move.to:isAlive() and move.from:objectName() ~= move.to:objectName() and move.reason.m_reason ~= sgs.CardMoveReason_S_REASON_PREVIEWGIVE and move.reason.m_reason ~= sgs.CardMoveReason_S_REASON_GIVE)) then
				-- if not room:askForSkillInvoke(player, self:objectName(), data) then return false end
				room:broadcastSkillInvoke("tsuyoiishiki", 2)
				local fri = room:askForPlayerChosen(player, room:getAlivePlayers(), self:objectName())
				fri:drawCards(move.card_ids:length())
			end
		end
		return false
	end
}

-- 解鎖：本技能有三種效果。1.你可以棄置一枚硬幣，獲得技能"窺視"、"反制"直到下個回合行動階段。2.當你陷入瀕死階段，必須消耗三枚硬幣，將體力恢復至一點，然後你摸恢復量的牌。3.每當一名目標陷入瀕死，你獲得一枚硬幣(最多五枚)。若你瀕死時，

unlockCard = sgs.CreateSkillCard{
	name = "unlock",
	target_fixed = true,
	on_use = function(self, room, source, targets)
		source:loseMark("@kiyoi_coin")
		room:cardEffect(self, source, source)
	end,
	on_effect = function(self, effect)
		local room = effect.to:getRoom()
		-- effect.to:drawCards(1)
		room:setEmotion(effect.to, "skill/yuri_unlock")
		room:acquireNextTurnSkills(effect.to, "unlock","peeking")
		room:acquireNextTurnSkills(effect.to, "unlock","countertrick")
	end
}

unlockVS = sgs.CreateZeroCardViewAsSkill{ -- 這樣寫可以直接按
	name = "unlock",
	view_as = function()
		return unlockCard:clone()
	end,
	enabled_at_play = function(self,player)
		return not player:hasUsed("#unlock") and player:getMark("@kiyoi_coin") > 0
	end
}

unlock = sgs.CreateTriggerSkill{
	name = "unlock" ,
	view_as_skill = unlockVS, 
	frequency = sgs.Skill_Limited,
	events = { sgs.EnterDying, sgs.AskForPeaches} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.EnterDying then
			for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
				-- if p:objectName() ~= player:objectName() then
					room:addPlayerMark(player, self:objectName().."engine")
					if player:getMark(self:objectName().."engine") > 0 and p:getMark("@kiyoi_coin") < 5 then
						room:sendCompulsoryTriggerLog(player, self:objectName())
						p:gainMark("@kiyoi_coin")
						room:removePlayerMark(player, self:objectName().."engine")
					end
				-- end
			end
		end
		if event == sgs.AskForPeaches and player:hasSkill("unlock") and player:getMark("@kiyoi_coin") > 2 then
			local dying = data:toDying()
			if dying.who:objectName() == player:objectName() then
				player:loseMark("@kiyoi_coin", 3)
				local num = 1 - player:getHp()
				player:drawCards(num)
				room:recover(player, sgs.RecoverStruct(player, nil, num))
			end
		end
		return false
	end ,
	can_trigger = function(self, target)
		return target
	end ,
}

--[[
	技能名：新死战（锁定技）
	相关武将：倚天·古之恶来
	描述：當你受到傷害時，無效那次傷害，然後獲得等同於傷害數量的死戰標記(死戰標記最多四枚，若超過則依舊會受傷)，你每獲得一枚死戰標記，便摸兩張牌。回合結束後，若你回合中有使用過殺造成傷害，你必須失去所有死戰標記，然後流失該數量的生命(最多流失三點)。
	引用：LuaSizhan
	状态：1217验证通过
]]--
yuri_sizhan = sgs.CreateTriggerSkill{
	name = "yuri_sizhan" ,
	frequency = sgs.Skill_Compulsory ,
	events = {sgs.DamageInflicted, sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data)
		if event == sgs.DamageInflicted and player:getMark("@struggle") < 4 then
			local damage = data:toDamage()
			local n = 4 - player:getMark("@struggle")
			-- if n ~= 0 and damage.damage >= player:getHp() then
			if n ~= 0 then
				local room = player:getRoom()
				room:sendCompulsoryTriggerLog(player, "yuri_sizhan")
				room:broadcastSkillInvoke("yuri_sizhan", math.random(1, 2))
				if damage.damage > n then
					damage.damage = damage.damage - n
					player:drawCards(n)
					player:gainMark("@struggle", n)
					data:setValue(damage)
				else
					player:drawCards(damage.damage)
					player:gainMark("@struggle", damage.damage)
					damage.prevented = true
					data:setValue(damage)
					return true
				end
			end
		elseif (event == sgs.EventPhaseStart) and (player:getPhase() == sgs.Player_Finish) then
			local x = player:getMark("@struggle")
			local room = player:getRoom()
			if x > 0 and player:hasFlag("YS_active") then
				player:loseAllMarks("@struggle")
				x = math.min(3, x)
				room:loseHp(player, x)
				player:setFlags("-YS_active")
			end
			player:setFlags("-shenli")
		end
		return false
	end
}
yuri_sizhan_d = sgs.CreateTriggerSkill{
	name = "#yuri_sizhan_d", 
	frequency = sgs.Skill_Frequent, 
	events = {sgs.DamageDone}, 
	on_trigger = function(self, event, player, data)
		if event == sgs.DamageDone then
			local damage = data:toDamage()
			if damage.from and damage.from:getPhase() == sgs.Player_Play and damage.card and damage.card:isKindOf("Slash") and not damage.from:hasFlag("YS_active") then
				damage.from:setFlags("YS_active")
			end
		end
		return false
	end
}

-- 武絕：你可以將黑牌當雷殺、紅牌當火殺使用或打出。當你沒有手牌，基本牌造成的傷害減少一點，若你沒有裝備牌，錦囊牌、無來由的傷害無效。

buuzetsuVA = sgs.CreateOneCardViewAsSkill{
	name = "buuzetsu",
	response_or_use = true,
	expand_pile = "wooden_ox",
	view_filter = function(self, card)
		if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
			local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
			slash:addSubcard(card:getEffectiveId())
			slash:deleteLater()
			return slash:isAvailable(sgs.Self)
		end
		return true
	end,
	view_as = function(self, card)
		local slash = nil
		if card:isRed() then
			slash = sgs.Sanguosha:cloneCard("fire_slash", card:getSuit(), card:getNumber())
		else
			slash = sgs.Sanguosha:cloneCard("thunder_slash", card:getSuit(), card:getNumber())
		end
		if slash then
			slash:addSubcard(card:getId())
			slash:setSkillName(self:objectName())
			return slash
		end
	end,
	enabled_at_play = function(self, player)
		return sgs.Slash_IsAvailable(player)
	end, 
	enabled_at_response = function(self, player, pattern)
		return pattern == "slash"
	end
}
buuzetsu = sgs.CreateTriggerSkill{
	name = "buuzetsu",
	-- frequency = sgs.Skill_Compulsory,
	view_as_skill = buuzetsuVA,
	events = {sgs.DamageInflicted},
	
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.DamageInflicted then
			local damage = data:toDamage()
			-- if player:getEquips():length() == 0 and (damage.card and damage.card:isKindOf("TrickCard")) or not damage.card then
				-- room:sendCompulsoryTriggerLog(player, self:objectName())
				-- room:broadcastSkillInvoke("buuzetsu", math.random(1, 4))
				-- return true
			-- end
			if (damage.card and damage.card:isKindOf("TrickCard")) or not damage.from then
				room:sendCompulsoryTriggerLog(player, self:objectName())
				room:broadcastSkillInvoke("buuzetsu", math.random(1, 4))
				damage.prevented = true
				data:setValue(damage)
				return true
			elseif player:getMark("@SuperLimitBreak") > 0 and player:isKongcheng() then
				room:sendCompulsoryTriggerLog(player, self:objectName())
				room:broadcastSkillInvoke("buuzetsu", math.random(1, 4))
				if damage.damage > 1 then
					player:drawCards(damage.damage)
					damage.damage = damage.damage - 1
					data:setValue(damage)
				else
					player:drawCards(1)
					damage.prevented = true
					data:setValue(damage)
					return true
				end
			end
			
		end
		return false
	end,
	can_trigger = function(self, target)
		return target and target:hasSkill("buuzetsu")
	end,
	priority = -5 --被免在火殺藤甲前發生。
}
-- 恩癒：階段技，你可以失去一項技能或棄置一張牌，選擇一名受傷目標摸失去生命數量的牌(最多三張)。若你選擇失去技能，其額外恢復一點體力，你摸兩張牌。

zurunoonkaeshiCard = sgs.CreateSkillCard{
	name = "zurunoonkaeshi", 
	filter = function(self, targets, to_select) 
		return #targets < 1 and to_select:isWounded()
	end,
	on_effect = function(self, effect)
		local room = effect.to:getRoom()
		local from = effect.from
		local to = effect.to
		if self:getSubcards():isEmpty() then 
			local yourskill = from:getVisibleSkillList()
			local your_list = {}
			for _,ys in sgs.qlist(yourskill) do
				if not ys:inherits("SPConvertSkill") and not ys:isAttachedLordSkill() then
					table.insert(your_list, ys:objectName())
				end
			end
			local lose_sname = room:askForChoice(from, "zurunoonkaeshi", table.concat(your_list, "+"))
			room:handleAcquireDetachSkills(from, "-"..lose_sname)
		end
		-- if to:objectName() ~= from:objectName() then
			-- local n = math.min(3, to:getLostHp())
			to:drawCards(1)
		-- else
			room:recover(to, sgs.RecoverStruct(from, nil, 1))
		-- end
		if self:getSubcards():isEmpty() then
			-- room:recover(to, sgs.RecoverStruct(from, nil, 1))
			from:drawCards(2)
		end
		-- if not from:hasSkill("jilei") and from:isWounded() then
			-- room:acquireSkill(from, "jilei")
		-- end
	end
}
zurunoonkaeshi = sgs.CreateViewAsSkill{
	name = "zurunoonkaeshi", 
	n = 1, 
	expand_pile = "wooden_ox",
	enabled_at_play = function(self, player)
		return not player:hasUsed("#zurunoonkaeshi")
	end,
	view_filter = function(self, selected, to_select)
		return #selected == 0
	end, 
	view_as = function(self, cards) 
		if #cards == 0 then
			return zurunoonkaeshiCard:clone()
		elseif #cards == 1 then
			local card = zurunoonkaeshiCard:clone()
			card:addSubcard(cards[1])
			return card
		else 
			return nil
		end
	end
}

-- 俳句：行動階段外，當你失去牌時，你可以將那張牌至於武將牌上視為"俳字"。當你蒐集X張"俳字"時(X為575循環，每當巡過一輪，你恢復一點體力)，指定五名以內的目標，令其獲得其中的一張牌，其餘牌棄置。你可以棄置一名目標等同棄置量的牌，若大於三，則該目標翻面(無法藉此翻回正面)。

haiguCard = sgs.CreateSkillCard{
	name = "haigu", 
	mute = true,
	filter = function(self, targets, to_select)
		return #targets < 5
	end, 
	on_effect = function(self, effect)
		local from = effect.from
		local to = effect.to
		local room = from:getRoom()	
		
		local id = room:askForAG(to, from:getPile("haigu_pile"), false, "haigu")
		room:takeAG(to, id, false)
		from:getPile("haigu_pile"):removeOne(id)
		to:obtainCard(sgs.Sanguosha:getCard(id))
		
	end
}
haigueVS = sgs.CreateZeroCardViewAsSkill{
	name = "haigu", 
	response_pattern = "@@haigu", 
	view_as = function()
		return haiguCard:clone()
	end
}

haigu = sgs.CreateTriggerSkill{
	name = "haigu",
	frequency = sgs.Skill_Frequent,
	view_as_skill = haigueVS,
	mute = true,
	events = {sgs.CardsMoveOneTime, sgs.DamageDone, sgs.EventLoseSkill},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.CardsMoveOneTime or event == sgs.DamageDone) and not player:hasFlag("haigu_used") then
			local active = false
			if event == sgs.CardsMoveOneTime then
				local move = data:toMoveOneTime()
				if (move.from and (move.from:objectName() == player:objectName()) and (move.from_places:contains(sgs.Player_PlaceHand) or move.from_places:contains(sgs.Player_PlaceEquip))) and not (move.to and (move.to:objectName() == player:objectName() and (move.to_place == sgs.Player_PlaceHand or move.to_place == sgs.Player_PlaceEquip))) then
					if not player:askForSkillInvoke("haigu", data) then return end
					for _, card_id in sgs.qlist(move.card_ids) do
						player:addToPile("haigu_pile", card_id)
					end
					active = true
				end
			end
			
			if event == sgs.DamageDone then
				local damage = data:toDamage()
				if damage.damage == 0 or not player:askForSkillInvoke("haigu", data) then return end
				for i = 1, damage.damage ,1 do
					local id = room:drawCard()
					player:addToPile("haigu_pile", id)
				end
				active = true
			end
			if not active then return end
			
			local n = math.max(5 ,player:getMark("haigu575"))
			if not player:getPile("haigu_pile"):isEmpty() and player:getPile("haigu_pile"):length() < n then room:broadcastSkillInvoke("haigu", math.random(3, 4)) end
			if player:getPile("haigu_pile"):length() >= n then
				player:setFlags("haigu_used")
				-- player:addMark("haigu_times")
				-- if player:getMark("haigu_times") >= 3 then
					-- room:setPlayerMark(player, "haigu_times", 0)
					if player:isWounded() then
						room:recover(player, sgs.RecoverStruct(player, nil, 1))
					end
				-- end
				if player:getMark("haigu575") == 0 then
					room:setPlayerMark(player, "haigu575", 7)
				elseif player:getMark("haigu575") == 7 then
					room:setPlayerMark(player, "haigu575", 0)
				end
				room:fillAG(player:getPile("haigu_pile"))
				room:broadcastSkillInvoke("haigu", 5)
				room:askForUseCard(player, "@@haigu", "#haigulog")
				room:clearAG()
				local n = math.max(5 ,player:getMark("haigu575"))
				player:setSkillDescriptionSwap("haigu", "%arg1", n)
				room:changeTranslation(player,"haigu",1)
				if not player:getPile("haigu_pile"):isEmpty() then
					local targets = sgs.SPlayerList()
					for _,p in sgs.qlist(room:getAlivePlayers()) do
						if not p:isAllNude() and player:canDiscard(p, "jhe") then
							targets:append(p)
						end
					end
					local t = room:askForPlayerChosen(player, targets, "haigu", "#haigu_pc", true, true)
					if t then
						local x = player:getPile("haigu_pile"):length()
						room:broadcastSkillInvoke("haigu", math.random(1, 2))
						for i = 1,x,1 do
							if t:isAllNude() or not player:canDiscard(t, "jhe") then break end
							local id = room:askForCardChosen(player, t, "jhe", self:objectName())
							room:throwCard(sgs.Sanguosha:getCard(id), t, player)
						end
						-- if player:getPile("haigu_pile"):length() > 3 and t:faceUp() then
							-- t:turnOver()
						-- end
					end

				end
				for _, card_id in sgs.qlist(player:getPile("haigu_pile")) do
					room:throwCard(sgs.Sanguosha:getCard(card_id), nil)
				end
				player:setFlags("-haigu_used")
			end
			-- end
		end
		if event == sgs.EventLoseSkill then
			if data:toString() == self:objectName() then
				-- player:removePileByName("haigu_pile") --新版似乎沒有此寫法
				for _, card_id in sgs.qlist(player:getPile("haigu_pile")) do
					room:throwCard(sgs.Sanguosha:getCard(card_id), nil)
				end
			end
		end

	end,
	can_trigger = function(self, target)
		-- return target and target:isAlive() and target:hasSkill(self:objectName())
		return target and target:isAlive() and target:hasSkill(self:objectName()) and target:getPhase() ~= sgs.Player_Play
	end,
	 priority = -8,
}

--百王神憤
--百憤：階段技，當你的暴怒標記為四點以上，你可以翻面、棄置所有標記，並根據標記數量發動效果↓4點以上：棄置所有目標裝備卡。五點以上：棄置所有目標的全部手牌。
--六點以上：對所有目標造成一點傷害。七點以上：效果結束後，你摸X張牌、恢復X點體力(X為暴怒標記數量減六)

SubetewonomikonmuCard = sgs.CreateSkillCard{
	name = "SubetewonomikonmuCard" ,
	target_fixed = true ,
	on_use = function(self, room, source, targets)
		source:setFlags("SubetewonomikonmuUsing")
		local marknum = source:getMark("@wrath")
		source:loseAllMarks("@wrath")
		room:broadcastSkillInvoke("Subetewonomikonmu", math.random(1, 2))
		room:doSuperLightbox("shenlvbu2","Subetewonomikonmu")
		room:getThread():delay(300)
		local players = room:getOtherPlayers(source)
		if marknum >= 6 then
			for _, player in sgs.qlist(players) do
				room:damage(sgs.DamageStruct("Subetewonomikonmu", source, player))
				room:getThread():delay(300)
			end
		end
		if marknum >= 4 then
			for _, player in sgs.qlist(players) do
				player:throwAllEquips()
				room:getThread():delay(300)
			end
		end
		if marknum >= 5 then
			for _, player in sgs.qlist(players) do
				player:throwAllHandCards()
				room:getThread():delay(300)
			end
		end
		if marknum >= 7 then
			source:drawCards(marknum-6)
			room:recover(source, sgs.RecoverStruct(source, nil, marknum-6))
		end
		source:turnOver()
		source:setFlags("-SubetewonomikonmuUsing")
	end
}
Subetewonomikonmu = sgs.CreateZeroCardViewAsSkill{
	name = "Subetewonomikonmu",
	view_as = function()
		return SubetewonomikonmuCard:clone()
	end , 
	enabled_at_play = function(self,player)
		return player:getMark("@wrath") >= 4 and not player:hasUsed("#SubetewonomikonmuCard")
	end
}

--百王狂暴
--狂食：鎖定技。當你造成傷害或受到傷害時，獲得那個數量的暴怒標記，然後獲得棄牌堆中的一張紅心牌。

Kuitsukusu = sgs.CreateTriggerSkill{
	name = "Kuitsukusu" ,
	events = {sgs.Damage, sgs.Damaged} ,
	frequency = sgs.Skill_Compulsory ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()
		local dmg = damage.damage
		if dmg > 0 then
			player:gainMark("@wrath", dmg)
			local realcard
			for _,id in sgs.qlist(room:getDiscardPile()) do
				local c = sgs.Sanguosha:getCard(id)
				if c:getSuit() == sgs.Card_Heart then
					realcard = c
					break
				end
			end
			if realcard then room:obtainCard(player, realcard) end
		end
		return false
	end
}

--博洛：妳的黑牌可以當無懈可擊打出，回合結束時，妳可以進行一次判定，若為黑色，妳獲得該牌(最多連續三次)。

yuri_hagakuVS = sgs.CreateOneCardViewAsSkill{
	name = "yuri_hagaku",
	filter_pattern = ".|black|.",
	response_pattern = "nullification",
	expand_pile = "wooden_ox",
	-- enabled_at_response = function(self,player,pattern)
		-- return string.find(pattern,"jink")
	-- end,
	enabled_at_nullification = function(self, player)
		return not player:isAllNude()
	end,
	enabled_at_play = function()
		return false
	end,
	view_as = function(self,card) 
		local ncard = sgs.Sanguosha:cloneCard("nullification", card:getSuit(), card:getNumber())
		ncard:addSubcard(card)
		ncard:setSkillName(self:objectName())
		return ncard
		-- local jink = sgs.Sanguosha:cloneCard("jink")
		-- jink:setSkillName(self:objectName())
		-- jink:addSubcard(card)
		-- return jink
	end
}
yuri_hagaku = sgs.CreateTriggerSkill{
	name = "yuri_hagaku",
	view_as_skill = yuri_hagakuVS,
	events = {sgs.EventPhaseStart,sgs.FinishJudge},
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
		if player:getMark("@SuperLimitBreak") == 0 then return false end
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish then
			local times = 0
			room:broadcastSkillInvoke("luoshen")--播放配音
			while times < 3 and player:askForSkillInvoke(self:objectName()) do
				local judge = sgs.JudgeStruct()
				judge.pattern = ".|black"
				judge.good = true
				judge.reason = self:objectName()
				judge.who = player
				judge.time_consuming = true
				room:judge(judge)
				-- if judge:isBad() then break end
				times = times+1
			end
		elseif event == sgs.FinishJudge then
			local judge = data:toJudge()
			if judge.reason == self:objectName() then
				local card = judge.card
				if card:isBlack() then
					player:obtainCard(card)
				end
			end
		end
		return false
	end
}

--務樸：你可以棄置一張非基本牌然後摸一张牌。你不會受到殺、決鬥、萬劍齊發、南蠻入侵、火攻以外造成的傷害。

gopuguCard = sgs.CreateSkillCard{
	name = "gopugu" ,
	target_fixed = true,
	will_throw = true,
	filter = function(self, targets, to_select)
		return to_select:objectName() == sgs.Self:objectName()
	end, 
	feasible = function(self, targets)
		return true
	end, 
	on_use = function(self, room, source, targets)
		source:setFlags("gopuguUsing")
		room:cardEffect(self, source, source)
		source:setFlags("-gopuguUsing")
	end ,
	on_effect = function(self, effect)
		local room = effect.to:getRoom()
		room:drawCards(effect.to, 1)
	end
}
gopuguVA = sgs.CreateOneCardViewAsSkill{
	name = "gopugu",
	expand_pile = "wooden_ox",
	view_filter = function(self,to_select)
		return not to_select:isKindOf("BasicCard")
	end,
	view_as = function(self, card)
		local acard = gopuguCard:clone()
		acard:addSubcard(card)
		acard:setSkillName("gopugu")
		return acard
	end,
	enabled_at_play = function(self,player)
		return true
	end,
	enabled_at_response = function(self, player, pattern)
		return false
	end,
}

gopugu = sgs.CreateTriggerSkill{
	name = "gopugu" ,
	-- frequency = sgs.Skill_Compulsory ,
	view_as_skill = gopuguVA, 
	events = {sgs.DamageInflicted} ,
	on_trigger = function(self, event, player, data)
		local damage = data:toDamage()
		-- if player:getGeneralName() ~= "miyoshikarin" then return false end
		if (damage.card and (damage.card:isKindOf("Slash") or damage.card:isKindOf("Duel") 
		or damage.card:isKindOf("SavageAssault") or damage.card:isKindOf("ArcheryAttack") or damage.card:isKindOf("FireAttack"))) then
			return false
		else
			room:broadcastSkillInvoke("gopugu_sound", math.random(1, 2))
			local room = player:getRoom()
			local log = sgs.LogMessage()
			log.type = "#bloody_log"
			log.from = player
			log.arg = tonumber(damage.damage)
			log.arg2 = self:objectName()
			room:sendLog(log)
			return true
		end
	end
}

--斬雙：你的殺指定目標後，你能選擇一項：1. 棄置其一張牌。 2.視為再對其打出一張同類型的無色殺。3.棄置兩張手牌然後兩個皆發動(不足也可發動)。
								
kirisou = sgs.CreateTriggerSkill{
	name = "kirisou",
	events = {sgs.TargetSpecified} ,
	on_trigger = function(self, event, player, data)
		if event == sgs.TargetSpecified then
			local room = player:getRoom()
			local use = data:toCardUse()
			if use.card:getSkillName() == self:objectName() or not use.card:isKindOf("Slash") then return false end
			for _, p in sgs.qlist(use.to) do
				if not player:isAlive() then break end
				local _data = sgs.QVariant()
				_data:setValue(p)
				if player:askForSkillInvoke(self:objectName(), _data) then
					room:setTag("kirisou", data)
					local choice = room:askForChoice(player, self:objectName(), "kirisou_e1+kirisou_e2+kirisou_ea", _data)
					room:removeTag("kirisou")
					if choice == "kirisou_e1" then
						room:broadcastSkillInvoke("kirisou", math.random(1, 3))
					end
					if player:canDiscard(p, "he") and (choice == "kirisou_e1" or choice == "kirisou_ea") then
						local id = room:askForCardChosen(player, p, "he", self:objectName(), false, sgs.Card_MethodDiscard)
						room:throwCard(sgs.Sanguosha:getCard(id), p, player)
					end
					if choice == "kirisou_e2" or choice == "kirisou_ea" then
						-- player:gainMark("&"..use.card:objectName())
						local c = sgs.Sanguosha:cloneCard(use.card:objectName(), sgs.Card_NoSuit, 0)
						c:setSkillName(self:objectName())
						c:deleteLater()
						room:useCard(sgs.CardUseStruct(c, player, p), false)
					end
					if choice == "kirisou_ea" then
						local num = player:getHandcardNum()
						if num > 0 then
							if num > 2 then num = 2 end
							room:askForDiscard(player,self:objectName(),num,num,false,false)
							-- local dcard = room:askForDiscard(player,self:objectName(),num,num,false,false)
							-- if dcard then room:throwCard(dcard, player) end
						end
					end
				end
			end
			return false
		end
	end,
}

kirisou_umaretuski = sgs.CreateTriggerSkill{
	name = "#kirisou_umaretuski",
	events = {sgs.TargetSpecifying} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if player:getMark("@SuperLimitBreak") == 0 or player:getGeneralName() ~= "miyoshikarin" or player:getWeapon() then return false end
		if event == sgs.TargetSpecifying then
			local use = data:toCardUse()
			if use.card:isKindOf("Slash") then
				for _,to in sgs.qlist(use.to) do
					local todata = sgs.QVariant()
					todata:setValue(to)
					
					if room:askForSkillInvoke(player,"kirisou_umaretuski",sgs.QVariant("choice:"..to:objectName())) then
						room:setEmotion(player, "weapon/double_sword")
						if not room:askForDiscard(to,"kirisou_umaretuski",1,1,true,false,"@kirisou_umaretuski:"..player:objectName()) then 
							player:drawCards(1,self:objectName()) 
						end
					end
				end
				data:setValue(use)
			end
		end
		return false
	end,
}

--真百：你可以將任何牌當作無岩石錦囊、基本排用。

genshunoYURICard = sgs.CreateSkillCard {
	name = "genshunoYURICard",
    will_throw = false,
	handling_method = sgs.Card_MethodNone,
	filter = function(self, targets, to_select, player)
		local players = sgs.PlayerList()
		for i = 1 , #targets do
			players:append(targets[i])
		end
		if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
			local card = nil
			if self:getUserString() and self:getUserString() ~= "" then
				card = sgs.Sanguosha:cloneCard(self:getUserString():split("+")[1])
				card:deleteLater()
				return card and card:targetFilter(players, to_select, player) and not player:isProhibited(to_select, card, players)
			end
		elseif sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE then
			return false
		end
		local _card = player:getTag("genshunoYURI"):toCard()
		if _card == nil then
			return false
		end
		local card = sgs.Sanguosha:cloneCard(_card)
		card:setCanRecast(false)
		card:deleteLater()
		return card and card:targetFilter(players, to_select, player) and not player:isProhibited(to_select, card, players)
	end ,
	feasible = function(self, targets)
		local players = sgs.PlayerList()
		for i = 1 , #targets do
			players:append(targets[i])
		end
		if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
			local card = nil
			if self:getUserString() and self:getUserString() ~= "" then
				card = sgs.Sanguosha:cloneCard(self:getUserString():split("+")[1])
				card:deleteLater()
				return card and card:targetsFeasible(players, sgs.Self)
			end
		elseif sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE then
			return true
		end
		local _card = sgs.Self:getTag("genshunoYURI"):toCard()
		if _card == nil then
			return false
		end
		local card = sgs.Sanguosha:cloneCard(_card)
		card:setCanRecast(false)
		card:deleteLater()
		return card and card:targetsFeasible(players, sgs.Self)
	end ,
	on_validate = function(self, card_use)
		local yuji = card_use.from
		local room = yuji:getRoom()
		local to_guhuo = self:getUserString()
		-- yuji:gainMark("&"..to_guhuo.."Look")
		-- if to_guhuo == "slash" and sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
		-- if to_guhuo == "slash" then
			-- local guhuo_list = {}
			-- table.insert(guhuo_list, "slash")
			-- table.insert(guhuo_list, "normal_slash")
			-- table.insert(guhuo_list, "thunder_slash")
			-- table.insert(guhuo_list, "fire_slash")
			-- table.insert(guhuo_list, "ice_slash")
			-- to_guhuo = room:askForChoice(yuji, "guhuo_slash", table.concat(guhuo_list, "+"))
			-- yuji:setTag("GuhuoSlash", sgs.QVariant(to_guhuo))
		-- end
			local card = sgs.Sanguosha:getCard(self:getSubcards():first())
			local user_str = ""
			if to_guhuo == "slash"  then
				if card:isKindOf("Slash") then
					user_str = card:objectName()
				else
					user_str = "slash"
				end
			elseif to_guhuo == "normal_slash" then
				user_str = "slash"
			else
				user_str = to_guhuo
			end
			local use_card = sgs.Sanguosha:cloneCard(user_str, card:getSuit(), card:getNumber())
			use_card:setSkillName("genshunoYURI")
			use_card:addSubcard(self:getSubcards():first())
			use_card:deleteLater()
			local tos = card_use.to
			for _, to in sgs.qlist(tos) do
				local skill = room:isProhibited(yuji, to, use_card)
				if skill then
					card_use.to:removeOne(to)
				end
			end
			-- yuji:gainMark("&"..to_guhuo.."Look")
			if math.random(1, 10) < 4 then room:broadcastSkillInvoke("genshunoYURISound", math.random(1, 2)) end
			local current = room:getCurrent()
			if current then
				if yuji:getMark("genshunoYURI-".. current:getPhase().."Clear") == 0 then room:addPlayerMark(yuji, "genshunoYURI-".. current:getPhase().."Clear")  room:addPlayerMark(yuji, "&genshunoYURI-".. current:getPhase().."Clear") end
			end
			return use_card
		-- else
			-- return nil
		-- end
	end ,
	on_validate_in_response = function(self, yuji)
		local room = yuji:getRoom()
		local to_guhuo = ""
		if self:getUserString() == "peach+analeptic" then
			local guhuo_list = {}
			table.insert(guhuo_list, "peach")
			local sts = sgs.GetConfig("BanPackages", "")
			if not string.find(sts, "maneuvering") then
				table.insert(guhuo_list, "analeptic")
			end
			to_guhuo = room:askForChoice(yuji, "guhuo_saveself", table.concat(guhuo_list, "+"))
			-- yuji:setTag("GuhuoSaveSelf", sgs.QVariant(to_guhuo))
		elseif self:getUserString() == "slash" then
			local guhuo_list = {}
			table.insert(guhuo_list, "slash")
			local sts = sgs.GetConfig("BanPackages", "")
			if not string.find(sts, "maneuvering") then
				table.insert(guhuo_list, "normal_slash")
				table.insert(guhuo_list, "thunder_slash")
				table.insert(guhuo_list, "fire_slash")
				table.insert(guhuo_list, "ice_slash")
			end
			to_guhuo = room:askForChoice(yuji, "guhuo_slash", table.concat(guhuo_list, "+"))
			-- yuji:setTag("GuhuoSlash", sgs.QVariant(to_guhuo))
		else
			to_guhuo = self:getUserString()
		end
		-- if guhuo(self, yuji) then
			local card = sgs.Sanguosha:getCard(self:getSubcards():first())
			local user_str = ""
			if to_guhuo == "slash" then
				if card:isKindOf("Slash") then
					user_str = card:objectName()
				else
					user_str = "slash"
				end
			elseif to_guhuo == "normal_slash" then
				user_str = "slash"
			else
				user_str = to_guhuo
			end
			local use_card = sgs.Sanguosha:cloneCard(user_str, card:getSuit(), card:getNumber())
			use_card:setSkillName("genshunoYURI")
			use_card:addSubcard(self)
			use_card:deleteLater()
			if sgs.Sanguosha:getCurrentCardUseReason()==sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
				local current = room:getCurrent()
				if current then
					if yuji:getMark("genshunoYURI-".. current:getPhase().."Clear") == 0 then room:addPlayerMark(yuji, "genshunoYURI-".. current:getPhase().."Clear")  room:addPlayerMark(yuji, "&genshunoYURI-".. current:getPhase().."Clear") end
				end
			end
			if math.random(1, 10) < 4 then room:broadcastSkillInvoke("genshunoYURISound", math.random(1, 2)) end
			return use_card
		-- else
			-- return nil
		-- end
	end
}
genshunoYURI = sgs.CreateOneCardViewAsSkill{
	name = "genshunoYURI",
	filter_pattern = ".",
	response_or_use = true,
	enabled_at_response = function(self, player, pattern)
		local current = false
		local players = player:getAliveSiblings()
		players:append(player)
		for _, p in sgs.qlist(players) do
			if p:getPhase() ~= sgs.Player_NotActive then
				current = true
				break
			end
		end
		if not current then return false end
		if player:isNude() or string.sub(pattern, 1, 1) == "." or string.sub(pattern, 1, 1) == "@" then
            return false
		end
		for _,target in sgs.list(player:getAliveSiblings())do
			if target:hasFlag("CurrentPlayer") and target:getPhase() ~= sgs.Player_NotActive then 
				if player:getMark("genshunoYURI-".. target:getPhase().."Clear") > 0 then return false end
			end
		end
        if pattern == "peach" and player:getMark("Global_PreventPeach") > 0 then return false end
        if string.find(pattern, "[%u%d]") then return false end--阻止基本牌模式
		return true
	end,
	enabled_at_play = function(self, player)
		local current = false
		local players = player:getAliveSiblings()
		players:append(player)
		for _, p in sgs.qlist(players) do
			if p:getPhase() ~= sgs.Player_NotActive then
				current = true
				break
			end
		end
		if not current then return false end
		-- return not player:isNude()
		return not player:isNude() and player:getMark("genshunoYURI-"..player:getPhase().."Clear") == 0
	end,
	view_as = function(self, cards)
		if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE or sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
			local card = genshunoYURICard:clone()
			card:setUserString(sgs.Sanguosha:getCurrentCardUsePattern())
			card:addSubcard(cards)
			return card
		end
		local c = sgs.Self:getTag("genshunoYURI"):toCard()
        if c then
            local card = genshunoYURICard:clone()
			card:setUserString(c:objectName())
            -- if not string.find(c:objectName(), "slash") then
                -- card:setUserString(c:objectName())
            -- else
				-- local slash_str = sgs.Self:getTag("GuhuoSlash"):toString()
				-- if slash_str == "fire_slash" then 
					-- card:setUserString("fire_slash")
				-- else
					-- card:setUserString("slash")
				-- end
			-- end
			card:addSubcard(cards)
			return card
        else
			return nil
		end
	end,
	enabled_at_nullification = function(self, player)
		-- local current = player:getRoom():getCurrent()
		-- if not current or current:isDead() or current:getPhase() == sgs.Player_NotActive then return false end
		-- return not player:isKongcheng() and not player:hasFlag("GuhuoUsed")
		return not player:isNude()
	end
}
genshunoYURI:setGuhuoDialog("lr")

--百染：鎖定技。當你造成、受到傷害時，你摸一张牌，然後令傷害來源或受傷者獲得一枚感染標記(最多一枚)。
-- 已帶有感染標記的目標使用桃、酒、無中生有、洞燭先機、裝備牌等對自身有益的牌時，你可以令其失去標記，然後你也成為目標(若為裝備則你成為受益者)。

yuriKansen = sgs.CreateTriggerSkill{
	name = "yuriKansen" ,
	frequency = sgs.Skill_Compulsory, 
	events = {sgs.Damage,sgs.Damaged} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()
		local target = nil
		if event == sgs.Damage then
			target = damage.to
		else
			target = damage.from
		end
		if not target or target:objectName() == player:objectName() then return false end
		if player:isAlive() and target:getMark("&yuriKansen") > 0 then player:drawCards(1) end
		if target:isAlive() and target:getMark("&yuriKansen") < 1 then target:gainMark("&yuriKansen") end
		return false
	end
}
yuriKansenEffect = sgs.CreateTriggerSkill{
	name = "#yuriKansenEffect",
	events = {sgs.TargetSpecifying},
	can_trigger = function(self,target)
		return target:isAlive() and target:getMark("&yuriKansen") > 0
	end,
	on_trigger = function(self,event,player,data,room)
		local use = data:toCardUse()
		for _,owner in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
			if ((use.card:isKindOf("Peach") and owner:isWounded()) or use.card:isKindOf("Analeptic") or use.card:isKindOf("ExNihilo") or use.card:isKindOf("Dongzhuxianji") or use.card:isKindOf("EquipCard")) and not use.to:contains(owner) and owner:objectName() ~= player:objectName() then
				local log = sgs.LogMessage()
				log.type = "#yuriKansenEffect_log"
				log.from = use.from
				log.card_str = use.card:toString()
				room:sendLog(log)
				if room:askForSkillInvoke(owner, "yuriKansen", data) then
					player:loseAllMarks("&yuriKansen")
					if use.card:isKindOf("EquipCard") then
						use.to = sgs.SPlayerList()
					end
					use.to:append(owner)
					data:setValue(use)
				end
			end
		end
		return false
	end,
}


-- 矜持：鎖定技。回合開始與回合結束，妳必須將手牌補至X+1張，若X+1低於自己的手牌數量，則不動作。(X為所有角色手牌最多的數量，最多為25)

restrained = sgs.CreateTriggerSkill{
	name = "restrained" ,
	frequency = sgs.Skill_Compulsory, 
	events = {sgs.EventPhaseStart, sgs.EventPhaseEnd},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.EventPhaseStart then
			if player:getPhase() ~= sgs.Player_Start then return false end
		else
			if player:getPhase() ~= sgs.Player_Discard then return false end
		end
		room:sendCompulsoryTriggerLog(player, self)
		local maxcard = 0
		local wuNum = 0
		for _, p in sgs.qlist(room:getOtherPlayers(player)) do
			if p:isAlive() and p:getKingdom() == "wu" then
				wuNum = wuNum+1
			end
		end
		-- player:gainMark("@book")
		for _, p in sgs.qlist(room:getOtherPlayers(player)) do
			local handCards = p:getHandcardNum()
			if player:isLord() and player:hasSkill("ienoimei") and p:getKingdom() == "wu" then handCards = handCards + wuNum end
			if not p:isKongcheng() and handCards > maxcard then
				maxcard = handCards
			end
		end
		maxcard = maxcard + 1
		-- player:gainMark("@book", maxcard)
		if player:getHandcardNum() < maxcard then
			local n = maxcard - player:getHandcardNum()
			player:drawCards(n, self:objectName())
		end
		return false
	end
}
-- 吳勢力的角色在你眼中，其手牌數量+X。(X為場上存活的吳勢力角色)
ienoimei = sgs.CreateTriggerSkill{
	name = "ienoimei$" ,
	frequency = sgs.Skill_Compulsory, 
	events = {},
	on_trigger = function(self, event, player, data, room)
		return false
	end
}



--[[
	-- 技能名：無束
	主公技。妳以外的蜀勢力的武將翻面或橫置時，其可以交給你一張手牌，然後取消翻面或橫置。
-- ]]--
jiyuunokuni = sgs.CreateTriggerSkill{
name = "jiyuunokuni$",
frequency = sgs.Skill_Compulsory,
events = {sgs.TurnedOver, sgs.ChainStateChanged},
	can_trigger = function(self, player)
		return (not player:hasSkill(self:objectName())) and not player:isKongcheng() and player:getKingdom() == "shu"
	end,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local king = room:findPlayerBySkillName(self:objectName())
		if not king:isLord() then return false end
		if event == sgs.TurnedOver then
		
			if not player:faceUp() then
				-- room:broadcastSkillInvoke("jiyuunokuni", 2)
				--以下這句為給AI使用
				local ai_data = sgs.QVariant()
				ai_data:setValue(king)
				if ((player:getAI() or player:getState() == "robot") and not room:askForSkillInvoke(player, self:objectName(), ai_data)) then
					return false
				end
				
				local card
				if (player:getAI() or player:getState() == "robot") and not player:isKongcheng() then 
					card = room:askForExchange(player, self:objectName(), 1, 1, false, "@jiyuunokuni-give:" .. king:objectName()) --AI的強制執行
				else
					card = room:askForExchange(player, self:objectName(), 1, 1, false, "@jiyuunokuni-give:" .. king:objectName(), true)
				end
				if card then
					room:getThread():delay(250)
					room:giveCard(player, king, card, self:objectName(), false)
					player:turnOver()
				end
			end
		else
			if player:isChained() then
				--以下這句為給AI使用
				local ai_data = sgs.QVariant()
				ai_data:setValue(king)
				if ((player:getAI() or player:getState() == "robot") and not room:askForSkillInvoke(player, self:objectName(), ai_data)) then
					return false
				end
				
				-- room:broadcastSkillInvoke("jiyuunokuni", 1)
				-- local card = room:askForExchange(player, self:objectName(), 1, 1, false, "@jiyuunokuni-give:" .. king:objectName(), true)
				local card
				if (player:getAI() or player:getState() == "robot") and not player:isKongcheng() then 
					card = room:askForExchange(player, self:objectName(), 1, 1, false, "@jiyuunokuni-give:" .. king:objectName()) --AI的強制執行
				else
					card = room:askForExchange(player, self:objectName(), 1, 1, false, "@jiyuunokuni-give:" .. king:objectName(), true)
				end
				if card then
					room:getThread():delay(250)
					room:giveCard(player, king, card, self:objectName(), false)
					player:setChained(false)
					room:broadcastProperty(player, "chained")
					room:setEmotion(player, "chain")
					room:getThread():trigger(sgs.ChainStateChanged, room, player)
				end
			end
		end
		return false
	end
} 


-- 奮進：行動階段結束時，若你至少有一張牌，妳可以將最多2張手牌放置到2名武將的頭上，視為【冶具】牌。
-- 帶有【冶具】牌的武將將於行動開始階段時棄置【冶具】牌，從摸牌堆頂十張牌中，隨機獲得1張裝備牌或錦囊牌，其餘的牌棄置，若無則摸牌。
-- 若目標為妳，額外獲得跳過判定階段的效果。【超界突破】：棄置【冶具】改為獲得。
hunnshinCard = sgs.CreateSkillCard{
	name = "hunnshin",
	target_fixed = false,
	will_throw = true,
	filter = function(self, targets, to_select)
		-- return #targets == self:subcardsLength()
		if #targets < self:subcardsLength() then
			return to_select:getPile("MWCreate"):isEmpty()
		else
			return false
		end
	end,
	on_use = function(self, room, source, targets)
		-- local thread = room:getThread()
		local ids = self:getSubcards()
		for _,p in ipairs(targets) do
			if p:isAlive() then
				for _,id in sgs.qlist(ids) do
					p:addToPile("MWCreate", id, true)
					ids:removeOne(id)
					break
				end
				-- room:cardEffect(self, source, p)
				-- thread:delay()
			end
		end
	end
}
hunnshinVS = sgs.CreateViewAsSkill{
	name = "hunnshin",
	n = 2,
	view_filter = function(self, selected, to_select)
		return not to_select:isEquipped()
	end, 
	view_as = function(self, cards)
		if #cards > 0 then
			local acard = hunnshinCard:clone()
			for _,card in pairs(cards) do
				acard:addSubcard(card)
			end
			acard:setSkillName(self:objectName())
			return acard
		end
	end,
	enabled_at_play = function(self, player)
		return false
	end,
	enabled_at_response = function(self, player, pattern)
		return pattern == "@@hunnshin"
	end
}

hunnshin = sgs.CreateTriggerSkill
{
	name = "hunnshin",
	view_as_skill = hunnshinVS,
	events = {sgs.EventPhaseStart, sgs.EventPhaseEnd, sgs.EventPhaseChanging},
	can_trigger = function(self, player)
		return (not player:getPile("MWCreate"):isEmpty()) or player:hasSkill(self:objectName())
	end,
        
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Play and not player:getPile("MWCreate"):isEmpty() then
			player:removePileByName("MWCreate")
			-- room:sendCompulsoryTriggerLog(player, self:objectName())
			-- local e_ids = sgs.IntList() --從前，可以獲得裝備和錦囊時的程式碼
			-- local t_ids = sgs.IntList()
			-- for _,id in sgs.qlist(room:getDrawPile()) do
				-- local card = sgs.Sanguosha:getCard(id)
				-- if card:isKindOf("EquipCard") then 
					-- e_ids:append(id)
				-- elseif card:isKindOf("TrickCard") then
					-- t_ids:append(id)
				-- end
			-- end
			local piletothrow = sgs.IntList()
			local num = 0
			local ids = sgs.IntList()
			for _,id in sgs.qlist(room:getDrawPile()) do
				local card = sgs.Sanguosha:getCard(id)
				if card:isKindOf("EquipCard") or card:isKindOf("TrickCard") then 
					ids:append(id)
				end
				piletothrow:append(id)
				num = num+1
				if num >= 10 then break end
			end
			local slash = sgs.Sanguosha:cloneCard("slash")
			slash:deleteLater()
			local cardtothrow = sgs.Sanguosha:cloneCard("slash")
			cardtothrow:deleteLater()
			-- if not e_ids:isEmpty() then
				-- local eid = e_ids:at(math.random(0, e_ids:length() - 1))
				-- slash:addSubcard(eid)
			-- else
				-- player:drawCards(1)
			-- end
			-- if not t_ids:isEmpty() then
				-- local tid = t_ids:at(math.random(0, t_ids:length() - 1))
				-- slash:addSubcard(tid)
			-- else
				-- player:drawCards(1)
			-- end
			-- player:gainMark("@cupcake")
			
			--只摸一张牌
			-- if not ids:isEmpty() then
				-- local cid = ids:at(math.random(0, ids:length() - 1))
				-- slash:addSubcard(cid)
				-- piletothrow:removeOne(cid)
			-- end
			
			--摸兩張牌
			for i = 1, 2 do
				if ids:isEmpty() then break end
				local id = ids:at(math.random(0, ids:length() - 1))
				ids:removeOne(id)
				piletothrow:removeOne(id)
				slash:addSubcard(id)
			end
			for _,id in sgs.qlist(piletothrow) do
				cardtothrow:addSubcard(id)
			end
			room:throwCard(cardtothrow, player)
			if slash:subcardsLength() > 0 then
				room:obtainCard(player, slash, false)
			end
			local needDraw = 2-slash:subcardsLength()
			if needDraw > 0 then
				player:drawCards(needDraw)
			end
		end
		if event == sgs.EventPhaseEnd and player:getPhase() == sgs.Player_Play and not player:isKongcheng() then
			room:askForUseCard(player, "@@hunnshin", "@hunnshin")
		end
		if event == sgs.EventPhaseChanging and not player:getPile("MWCreate"):isEmpty() then
			local user = room:findPlayerBySkillName("hunnshin")
			if player:objectName() ~= user:objectName() then return false end
			local change = data:toPhaseChange()
			if change.to == sgs.Player_Judge then
				room:sendCompulsoryTriggerLog(player, self:objectName())
				-- room:notifySkillInvoked(user, self:objectName())
				player:skip(change.to)
			end
		end
		return false
	end
}

-- 奮明(舊版)：鎖定技。你必定跳過判定階段。
-- 任何武將的行動階段開始時，若你的手牌少於四張，你可以將手牌補至四張，若其中有裝備牌且對應裝備區無牌時，則可直接裝備。若其中有延時錦囊，且判定區不存在同類型的牌時，直接對自己使用。
-- 若你這麼做，行動階段結束時，你棄置所有手牌，若棄置的牌中有桃，你恢復一點體力。有酒，可以視為對一名武將打出一張殺。

--[[
hunnmei = sgs.CreateTriggerSkill
{
	name = "hunnmei",
	events = {sgs.EventPhaseStart, sgs.EventPhaseEnd, sgs.EventPhaseChanging},
	can_trigger = function(self, player)
		return true
	end,
        
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local user = room:findPlayerBySkillName("hunnmei")
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Play then
			while true do
				if user:getHandcardNum() < 4 then user:drawCards(4-user:getHandcardNum()) end
				for _,c in sgs.list(user:getHandcards()) do
					if not c:hasFlag("hunnmei"..user:objectName()) then
						local choices = {}
						table.insert(choices, c:objectName())
						table.insert(choices, "cancel")
						if c:isKindOf("EquipCard") and room:askForChoice(user, "hunnmei", table.concat(choices, "+")) ~= "cancel" then
							room:useCard(sgs.CardUseStruct(c, user, user))
						end
						if c:isKindOf("DelayedTrick") then
							local can_put = true
							local place
							for _,d in sgs.list(user:getCards("j")) do
								if c:objectName() == d:objectName() then
									can_put = false
									break
								end
							end
							if can_put then
								room:getThread():delay(500)
								room:useCard(sgs.CardUseStruct(c, user, user))
							end
						end
						room:setCardFlag(c, "hunnmei"..user:objectName())
					end
				end
				if user:getHandcardNum() >= 4 then break end
			end		
		end
		if event == sgs.EventPhaseEnd and player:getPhase() == sgs.Player_Play then
			
			for _,c in sgs.list(user:getHandcards()) do
				if c:isKindOf("Peach") and user:isWounded() then
					local recover = sgs.RecoverStruct()
					recover.who = user
					room:recover(user, recover)
					room:setEmotion(user, "peach")
					room:getThread():delay(500)
				end
				if c:isKindOf("Analeptic") then
					local tars = sgs.SPlayerList()
					local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
					slash:setSkillName(self:objectName())
					for _,p in sgs.qlist(room:getOtherPlayers(user)) do
						if user:canSlash(p, slash, false) then -- false表示無視距離
							tars:append(p)
						end
					end
					slash:deleteLater()
					if tars:length() > 0 then
						local p = room:askForPlayerChosen(user, tars, self:objectName(), "hunnmei_choiceplayer")
						room:useCard(sgs.CardUseStruct(slash, user, p), true)
					end
				end
			end
			user:throwAllHandCards()
		end
		if event == sgs.EventPhaseChanging then
			local change = data:toPhaseChange()
			if user:objectName() == player:objectName() and change.to == sgs.Player_Judge then
				user:skip(change.to)
			end
		end
		return false
	end
}
]]--

-- 天輔：鎖定技。回合結束階段，若你的手牌數在2以下，你可以棄置任意區域的X張牌進行X次判定(X至多為3)，效果持續到下次自己的回合開始。
-- 1. 基本牌：非延時錦囊對妳無效。
-- 2. 錦囊牌：殺對妳無效。
-- 3. 武器牌：重新做一次判定。
-- 不論結果為何，你皆獲得那張牌。【超界突破】：改為進行X+1次判定(X至多為4)。

tennsainohojyou = sgs.CreateTriggerSkill{
	name = "tennsainohojyou",
	frequency = sgs.Skill_Compulsory ,
	-- events = {sgs.EventPhaseStart, sgs.FinishJudge, sgs.TargetConfirmed, sgs.DamageInflicted, sgs.PreHpLost},
	events = {sgs.EventPhaseStart, sgs.FinishJudge, sgs.TargetConfirmed, sgs.PreHpLost},
	
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.EventPhaseStart then
			-- local lostn = math.min(3, math.max(1, player:getLostHp()))
			if player:getPhase() == sgs.Player_Finish and player:getHandcardNum() <= 2 and not player:isAllNude() then
				local x = player:getCards("jhe"):length()
				local numlist = {}
				if x > 3 then x = 3 end
				for i = 0, x, 1 do
					if i == 0 then
						table.insert(numlist, "cancel")
					else
						table.insert(numlist, i)
					end
				end
				local choicen = room:askForChoice(player, "tennsainohojyou", table.concat(numlist, "+"))
				if choicen == "cancel" then return false end
					room:addPlayerMark(player, "tennsainohojyou_E", choicen)
					-- player:gainMark("@cupcake" ,choicen)
					
					local times = 0
					while true do
						local losecard = room:askForCardChosen(player, player, "jhe", self:objectName())
						room:throwCard(losecard, player)
						times = times+1
						if times >= player:getMark("tennsainohojyou_E") then --這裡如果直接拿times跟choicen比，直接失效給妳看
							break
						end
					end
					times = 0
					if player:getMark("@SuperLimitBreak") > 0 then room:addPlayerMark(player, "tennsainohojyou_E", 1) end
					while true do
						local judge = sgs.JudgeStruct()
						judge.pattern = "."
						judge.good = true
						judge.reason = self:objectName()
						judge.who = player
						judge.time_consuming = true
						room:judge(judge)
						times = times+1
						if times >= player:getMark("tennsainohojyou_E") then
							room:setPlayerMark(player, "tennsainohojyou_E", 0)
							break
						end
					end
					room:broadcastSkillInvoke("tennsainohojyou", math.random(1, 2))
				-- end
			elseif player:getPhase() == sgs.Player_Start then
				room:setPlayerMark(player, "@tennsainohojyou_B", 0)
				room:setPlayerMark(player, "@tennsainohojyou_T", 0)
				room:setPlayerMark(player, "tennsainohojyou_E", 0)
			end
		end
		if event == sgs.FinishJudge then
			local judge = data:toJudge()
			if judge.reason == self:objectName() then
				local card = judge.card
				if card:isKindOf("BasicCard") then
					room:setPlayerMark(player, "@tennsainohojyou_B", 1)
				elseif card:isKindOf("TrickCard") then
					room:setPlayerMark(player, "@tennsainohojyou_T", 1)
				else
					room:addPlayerMark(player, "tennsainohojyou_E", 1)
				end
				player:obtainCard(card)
			end
		end
		if event == sgs.TargetConfirmed then
			local use = data:toCardUse()
			if use.card and use.from and use.from:objectName() ~= player:objectName() and use.to and use.to:contains(player) and player:hasSkill(self:objectName()) then
				if use.card:isKindOf("SkillCard") or use.card:isKindOf("DelayedTrick") then return false end
				if (use.card:isKindOf("Slash") and player:getMark("@tennsainohojyou_B") > 0) or 
					(use.card:isKindOf("TrickCard") and player:getMark("@tennsainohojyou_T") > 0) then
					local nullified_list = use.nullified_list
					table.insert(nullified_list, player:objectName())
					use.nullified_list = nullified_list
					data:setValue(use)
					-- room:broadcastSkillInvoke("introvert", math.random(1, 3))
					-- local log = sgs.LogMessage()
					-- log.type = "#introvert_log"
					-- log.from = player
					-- room:sendLog(log)
					-- if use.card:isKindOf("DelayedTrick") then --延時錦囊這一版就算不丟也會自動丟
						-- room:throwCard(use.card, player)
					-- end
					room:sendCompulsoryTriggerLog(player, self:objectName())
				end
			end
		end
		-- if player:getMark("@tennsainohojyou_E") > 0 and (event == sgs.DamageInflicted or event == sgs.PreHpLost) then
			-- if event == sgs.PreHpLost then
				-- room:sendCompulsoryTriggerLog(player, "tennsainohojyou")
				-- return true
			-- else
				-- local damage = data:toDamage()
				-- local fhcn = damage.from:getHandcardNum()
				-- local thp = player:getHp()
				-- if fhcn >= thp then
					-- room:sendCompulsoryTriggerLog(player, "tennsainohojyou")
					-- return true
				-- end

			-- end
		-- end
		return false
	end,
	can_trigger = function(self, target)
		return target and target:hasSkill("tennsainohojyou")
	end
}


--領惑：一名目標的行動階段開始，妳可以與其交換全身所有牌。若你這麼做，其行動階段結束時，妳與其交換全身所有牌。
yuryounowaku = sgs.CreateTriggerSkill{
	name = "yuryounowaku",
	frequency = sgs.Skill_NotFrequent,
	events = {sgs.EventPhaseStart, sgs.EventPhaseEnd},
	on_trigger = function(self, event, player, data)
		-- if (event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Play) or (event == sgs.EventPhaseEnd and player:getPhase() == sgs.Player_Play) then
		if player:getPhase() == sgs.Player_Play then
			local room = player:getRoom()
			local source = room:findPlayerBySkillName(self:objectName())
			if player:isAllNude() and source:isAllNude() then return false end
			local ai_data = sgs.QVariant()
			ai_data:setValue(player)
			if source and ((player:hasFlag("Yuryounowaku") and event == sgs.EventPhaseEnd) or
			(event == sgs.EventPhaseStart and room:askForSkillInvoke(source, self:objectName(), ai_data))) then
				if event == sgs.EventPhaseStart then player:setFlags("Yuryounowaku") end
				if event == sgs.EventPhaseEnd then player:setFlags("-Yuryounowaku") end
				
				local pallcard = nil
				local sallcard = nil
				local plist = DummyCard:clone()
				plist:deleteLater()
				local slist = DummyCard:clone()
				slist:deleteLater()
				if not player:isAllNude() then
					pallcard = player:getCards("jhe") 
					for _,id in sgs.qlist(pallcard) do
						plist:addSubcard(id)
					end
				end
				if not source:isAllNude() then
					sallcard = source:getCards("jhe")
					for _,id in sgs.qlist(sallcard) do
						slist:addSubcard(id)
					end
				end
				if pallcard then room:moveCardTo(plist, source, sgs.Player_PlaceHand, false) end
				if sallcard then room:moveCardTo(slist, player, sgs.Player_PlaceHand, false) end
			end
		end
		return false
	end,
	can_trigger = function(self, target)
		if target then
			return not target:hasSkill(self:objectName())
		end
		return false
	end,
	priority = -2
}

-- 觀百：天生技。場上的女性角色受到同性的指定後，妳摸一张牌，並將一張牌至於武將牌上視為"觀"牌(至多10張，超過則失效)。
-- 場上一名武將受到傷害或流失生命時，妳可以令其選一張觀牌獲得。若體力減少者是妳，則必須獲得一張觀牌。
-- 鎖定技：回合及結束，妳可以發動X+1張牌的觀星。摸牌階段結束後，妳可以用任意數量的牌交換等量的觀牌。

yurimibirth = sgs.CreateTriggerSkill{
	name = "#yurimibirth",
	-- events = {sgs.TargetConfirmed, sgs.Damaged, sgs.HpLost, sgs.EventPhaseStart, sgs.PreHpLost, sgs.DamageInflicted},
	events = {sgs.TargetConfirmed, sgs.Damaged, sgs.HpLost, sgs.CardsMoveOneTime, sgs.EventPhaseChanging},
	can_trigger = function(self, target)
		return target ~= nil
	end,
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
		-- if event == sgs.Death then --是否觸發死亡時效果
			-- if player:getGeneralName() == "murosakimiyo" then
				-- local tskill = sgs.Sanguosha:getTriggerSkill("#yuri_hengjiang_draw") --執行摸牌跟清除標記
				-- if tskill then tskill:trigger(event, room, player, data) end
			-- end
			-- return false
		-- end
		local yurifan = nil
		for _, p in sgs.qlist(room:getAlivePlayers()) do
			if p:getGeneralName() == "murosakimiyo" then
			-- if p:getGeneralName() == "testguy" then
				yurifan = p
				break
			end
		end
		if yurifan == nil then return false end
		local pmax = 6
		if event == sgs.TargetConfirmed and player:isFemale() then
			local use = data:toCardUse()
			if not use.card or not use.to:contains(player) or not player:isFemale() or use.from:isMale() then return false end
			if use.card:isKindOf("SkillCard") or not (use.card:isKindOf("BasicCard") or use.card:isKindOf("TrickCard") or use.card:isKindOf("EquipCard")) then return false end
			
			if yurifan:getMark("@SuperLimitBreak") > 0 then pmax = 8 end
			if not yurifan:isAlive() or yurifan:getPile("yurimipile"):length() >= pmax then return false end
			yurifan:drawCards(1)
			if yurifan:isNude() then return false end
			-- if math.random(1, 100) < 30 and use.card:getSkillName() ~= "yurimibirth" then --底下超界為了防止聲音加的條件
			if math.random(1, 100) < 30 then
				room:broadcastSkillInvoke("yurimi", math.random(1, 2))
			end
			local cid = room:askForExchange(yurifan, "yurimi", 1, 1, true, "@yurimi_topile", false, ".")
			if cid then yurifan:addToPile("yurimipile", cid, false) end
			-- if use.to:contains(player) then
			-- end
		end
		--以下為，男性腳色回合開始可以給你一張手牌當觀，若不給，其回合中你不會減少體力。
		-- if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Start then
			-- if yurifan:hasFlag("yurimi_invisible") then yurifan:setFlags("-yurimi_invisible") end
			-- if player:isMale() and yurifan:getPile("yurimipile"):length() < pmax then
				-- if not player:isKongcheng() and room:askForChoice(player, "yurimi", "givetoyurimipile=" .. yurifan:objectName() .. "+cancel") ~= "cancel" then
					-- local card = player:getHandcards():at(math.random(0, player:getHandcardNum() - 1))
					-- if card then 
						-- yurifan:addToPile("yurimipile", card, false)
					-- end
				-- else
					-- yurifan:setFlags("yurimi_invisible")
				-- end
			-- end
		-- end
		-- if (event == sgs.PreHpLost or event == sgs.DamageInflicted) and player:hasFlag("yurimi_invisible") then
			-- local lose
			-- if event == sgs.PreHpLost then
				-- lose = data:toInt()
			-- else
				-- local damage = data:toDamage()
				-- lose = tonumber(damage.damage)
			-- end
			-- local log = sgs.LogMessage()
			-- log.type = "#bloody_log"
			-- log.from = player
			-- log.arg = lose
			-- log.arg2 = "yurimi"
			-- room:sendLog(log)
			-- return true
		-- end
		-- if event == sgs.EventPhaseChanging or event == sgs.CardsMoveOneTime or event == sgs.Death then
		if event == sgs.EventPhaseChanging then
			local change = data:toPhaseChange()
			if change.to ~= sgs.Player_NotActive then return false end
			local tskill = sgs.Sanguosha:getTriggerSkill("#yuri_hengjiang_draw") --執行摸牌跟清除標記
			if tskill then tskill:trigger(event, room, player, data) end
		end
		if event == sgs.CardsMoveOneTime then
			local move = data:toMoveOneTime()
			if move.from and player:objectName() == move.from:objectName() and player:getPhase() == sgs.Player_Discard and bit32.band(move.reason.m_reason,sgs.CardMoveReason_S_MASK_BASIC_REASON) == sgs.CardMoveReason_S_REASON_DISCARD then
				local tskill = sgs.Sanguosha:getTriggerSkill("#yuri_hengjiang_draw") --執行摸牌跟清除標記
				if tskill then tskill:trigger(event, room, player, data) end
			end
		end
		if event == sgs.Damaged or event == sgs.HpLost then
			if not player:isAlive() then return false end
			local vocal = true
			if player:objectName() == yurifan:objectName() and event == sgs.Damaged then
				local damage = data:toDamage()
				local from = damage.from
				if (not from) or (from and from:isMale()) then
					room:setPlayerProperty(player, "pingjian_triggerskill", sgs.QVariant("yuri_hengjiang"))
					local tskill = sgs.Sanguosha:getTriggerSkill("yuri_hengjiang") --執行添加標記
					-- local tskill = sgs.Sanguosha:getTriggerSkill("yuri_guixin")
					if tskill then tskill:trigger(event, room, player, data) end
					room:setPlayerProperty(player, "pingjian_triggerskill", sgs.QVariant(""))
					vocal = false
				end
			end
			if yurifan:getPile("yurimipile"):isEmpty() then return false end
			local ai_data = sgs.QVariant()
			ai_data:setValue(player)
			if player:objectName() == yurifan:objectName() or room:askForSkillInvoke(yurifan, "yurimi", ai_data) then
				if vocal then room:broadcastSkillInvoke("yurimi", 3) end
				room:fillAG(yurifan:getPile("yurimipile"), player)
				local id = room:askForAG(player, yurifan:getPile("yurimipile"), false, "yurimi")
				room:clearAG(player)
				room:obtainCard(player, id, false)

				--以下是覺得太強的界線突破
				-- if yurifan:getMark("@SuperLimitBreak") > 0 then
					-- local rc = sgs.Sanguosha:getCard(id)
					-- if rc:getSuit() == sgs.Card_Club then yurifan:addMark("lb_yurimi_c") end
					-- if rc:getSuit() == sgs.Card_Spade then yurifan:addMark("lb_yurimi_s") end
					-- if rc:getSuit() == sgs.Card_Heart then yurifan:addMark("lb_yurimi_h") end
					-- if rc:getSuit() == sgs.Card_Diamond then yurifan:addMark("lb_yurimi_d") end
					
					-- if yurifan:getMark("lb_yurimi_c") > 1 or yurifan:getMark("lb_yurimi_s") > 1 or yurifan:getMark("lb_yurimi_h") > 1 or yurifan:getMark("lb_yurimi_d") > 1 then
						-- if yurifan:getHp() <= 1 then
							-- local momo = sgs.Sanguosha:cloneCard("peach", sgs.Card_NoSuit, 0)
							-- momo:deleteLater()
							-- momo:setSkillName("yurimibirth")
							-- room:useCard(sgs.CardUseStruct(momo, yurifan, yurifan), false)
						-- else
							-- local c = sgs.Sanguosha:cloneCard("ex_nihilo", sgs.Card_NoSuit, 0)
							-- c:deleteLater()
							-- c:setSkillName("yurimibirth")
							-- room:useCard(sgs.CardUseStruct(c, yurifan, yurifan), false)
						-- end
						-- if yurifan:getMark("lb_yurimi_c") > 1 then room:setPlayerMark(yurifan, "lb_yurimi_c", 0) end
						-- if yurifan:getMark("lb_yurimi_s") > 1 then room:setPlayerMark(yurifan, "lb_yurimi_s", 0) end
						-- if yurifan:getMark("lb_yurimi_h") > 1 then room:setPlayerMark(yurifan, "lb_yurimi_h", 0) end
						-- if yurifan:getMark("lb_yurimi_d") > 1 then room:setPlayerMark(yurifan, "lb_yurimi_d", 0) end
					-- end
				-- end
				-- player:gainMark("&test")
			end
		end
		
		return false
	end
}

yurimicard = sgs.CreateSkillCard{
	name = "yurimi",
	will_throw = false,
	handling_method = sgs.Card_MethodNone,
	target_fixed = true,
	mute = true,
	on_use = function(self, room, source, targets)
		local pile = source:getPile("yurimipile")
		local subCards = self:getSubcards()
		local to_handcard = sgs.IntList()
		local to_pile = sgs.IntList()
		local set = source:getPile("yurimipile")
		for _,id in sgs.qlist(subCards) do
			set:append(id)
		end
		for _,id in sgs.qlist(set) do
			if not subCards:contains(id) then
				to_handcard:append(id)
			elseif not pile:contains(id) then
				to_pile:append(id)
			end
		end
		assert(to_handcard:length() == to_pile:length())
		if to_pile:length() == 0 or to_handcard:length() ~= to_pile:length() then return end
		room:notifySkillInvoked(source, "yurimi")
		source:addToPile("yurimipile", to_pile, false)
		local to_handcard_x = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
		to_handcard_x:deleteLater()
		for _,id in sgs.qlist(to_handcard) do
			to_handcard_x:addSubcard(id)
		end
		local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_EXCHANGE_FROM_PILE, source:objectName())
		room:obtainCard(source, to_handcard_x, reason, false)
	end,
}

yurimiVA = sgs.CreateViewAsSkill{
	name = "yurimi", 
	n = 998,
	response_pattern = "@@yurimi",
	expand_pile = "yurimipile",
	view_filter = function(self, selected, to_select)
		if #selected < sgs.Self:getPile("yurimipile"):length() then
			return true
		end
		return false
	end,
	view_as = function(self, cards)
		if #cards == sgs.Self:getPile("yurimipile"):length() then
			local c = yurimicard:clone()
			for _,card in ipairs(cards) do
				c:addSubcard(card)
			end
			return c
		end
		return nil
	end,
}

yurimi = sgs.CreateTriggerSkill{
	name = "yurimi",
	events = {sgs.EventPhaseStart, sgs.EventPhaseEnd},
	view_as_skill = yurimiVA,
	can_trigger = function(self, player)
		return player:isAlive() and player:getPile("yurimipile"):length() > 0
	end,
	on_trigger = function(self, event, player, data)
		if event == sgs.EventPhaseStart and (player:getPhase() == sgs.Player_Start or player:getPhase() == sgs.Player_Finish) then
			local room = player:getRoom()
			-- if room:askForSkillInvoke(player, self:objectName(), data) then
				local count = player:getPile("yurimipile"):length()
				if count > 8 then
					count = 8
				end
				local cards = room:getNCards(count)
				room:askForGuanxing(player,cards)
				-- if player:getPhase() == sgs.Player_Finish then
					-- if math.random(1, 100) < 40 then
						-- room:broadcastSkillInvoke("yurimi", 4)
					-- end
					-- room:askForUseCard(player, "@@yurimi", "@yurimi-exchange", -1, sgs.Card_MethodNone)
				-- end
			-- end
		end
		if event == sgs.EventPhaseEnd and player:getPhase() == sgs.Player_Draw then
			local room = player:getRoom()
			if math.random(1, 100) < 40 then
				room:broadcastSkillInvoke("yurimi", 4)
			end
			room:askForUseCard(player, "@@yurimi", "@yurimi-exchange", -1, sgs.Card_MethodNone)
		end
		return false
	end
}

-- 百江_百合版橫江：當你受到傷害時，可以選擇一名目標獲得該傷害數的百橫標記，每有一枚標記手牌上限-1。然後其回合結束時，若沒有棄牌，你恢復一點體力。若有或你滿體力，則你摸X張牌。(X為其橫江標記數)

-- yuri_hengjiang = sgs.CreateTriggerSkill{
	-- name = "yuri_hengjiang",
	-- events = {sgs.Damaged},
	-- can_trigger = function(self, target)
		-- return target
	-- end,
	-- on_trigger = function(self, event, player, data)
		-- local room = player:getRoom()
		-- if event == sgs.Damaged then
			-- if player:isAlive() and player:hasSkill(self:objectName()) then
				-- local damage = data:toDamage()
				-- local target = room:askForPlayerChosen(player, room:getOtherPlayers(player), "yuri_hengjiang", "yuri_hengjiang_choiceplayer")
				-- for i = 0, damage.damage - 1, 1 do
					-- room:setPlayerMark(player,"yuri_hengjiang_who",1)
					-- room:addPlayerMark(target,"@yuri_hengjiang")
				-- end
			-- end
		-- end
		-- return false
	-- end
-- }
yuri_hengjiang = sgs.CreateMasochismSkill{
	name = "yuri_hengjiang" ,
	on_damaged = function(self, player, damage)
		local room = player:getRoom()
		if player:isAlive() and damage.damage > 0 then
			local target = room:askForPlayerChosen(player, room:getOtherPlayers(player), "yuri_hengjiang", "yuri_hengjiang_choiceplayer", true)
			--上面最後那個true代表可以取消
			if target then
				room:broadcastSkillInvoke("yuri_hengjiang", math.random(1, 2))
				room:setPlayerMark(player,"yuri_hengjiang_who",1)
				local log = sgs.LogMessage()
				log.type = "#yuri_hengjiang_log"
				log.from = player
				log.to:append(target)
				log.arg = tonumber(damage.damage)
				log.arg2 = "yuri_hengjiang"
				room:sendLog(log)
				for i = 0, damage.damage - 1, 1 do
					room:addPlayerMark(target,"@yuri_hengjiang")
				end
			end
		end
		return false
	end
}
yuri_hengjiang_draw = sgs.CreateTriggerSkill{
	name = "#yuri_hengjiang_draw",
	events = {sgs.CardsMoveOneTime, sgs.EventPhaseChanging},
	-- events = {sgs.CardsMoveOneTime, sgs.EventPhaseChanging, sgs.Death},
	
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.CardsMoveOneTime then
			local move = data:toMoveOneTime()
			if move.from and player:objectName() == move.from:objectName() and player:getPhase() == sgs.Player_Discard and bit32.band(move.reason.m_reason,sgs.CardMoveReason_S_MASK_BASIC_REASON) == sgs.CardMoveReason_S_REASON_DISCARD then
				player:setFlags("YuriHengjiangDiscarded")
			end
		elseif event == sgs.EventPhaseChanging then
			local change = data:toPhaseChange()
			if change.to ~= sgs.Player_NotActive then return false end
			if player:getMark("@yuri_hengjiang") > 0 then
				local invoke = false
				if not player:hasFlag("YuriHengjiangDiscarded") then
					invoke = true
				end
				player:setFlags("-YuriHengjiangDiscarded")
				local zangba = nil
				for _, p in sgs.qlist(room:getAlivePlayers()) do
					if p:getMark("yuri_hengjiang_who") > 0 then
						zangba = p
						break
					end
				end
				-- room:setPlayerMark(zangba,"yuri_hengjiang_who",0) --不用清除沒差吧
				
				if not zangba then
					room:setPlayerMark(player,"@yuri_hengjiang",0)
					return false 
				end
				room:sendCompulsoryTriggerLog(zangba, "yuri_hengjiang")
				if invoke and zangba:isWounded() then
					local theRecover = sgs.RecoverStruct()
					theRecover.recover = 1
					theRecover.who = zangba
					room:recover(zangba, theRecover)
				else
					-- zangba:drawCards(player:getMark("@yuri_hengjiang"))
					zangba:drawCards(1)
					-- if player:getMark("@yuri_hengjiang") > 1 then
						-- room:loseHp(player)
					-- 美夜特殊效果_加一張手牌為觀
					local pmax = 6
					if zangba:getMark("@SuperLimitBreak") > 0 then pmax = 8 end
					if zangba:getGeneralName() == "murosakimiyo" and zangba:isAlive() and zangba:getPile("yurimipile"):length() < pmax and not zangba:isNude() then
						if math.random(1, 100) < 30 then
							room:broadcastSkillInvoke("yurimi", math.random(1, 2))
						end
						local cid = room:askForExchange(zangba, "yurimi", 1, 1, true, "@yurimi_topile", false, ".")
						if cid then zangba:addToPile("yurimipile", cid, false) end
					end
					if zangba:getMark("@SuperLimitBreak") > 0 then player:loseMark("@yuri_hengjiang", 1) end --  界限突破時，棄牌者才棄置標記
				end
				-- room:setPlayerMark(player,"@yuri_hengjiang",0)
				if zangba:getMark("@SuperLimitBreak") == 0 then player:loseMark("@yuri_hengjiang", 1) end -- 這一改版，界限突破時，棄牌者才棄置標記
			end
		-- elseif event == sgs.Death then --死亡時標記翻倍
			-- local death = data:toDeath()
			-- if death.who:getMark("yuri_hengjiang_who") > 0 then
				-- for _, p in sgs.qlist(room:getAlivePlayers()) do
					-- if p:getMark("@yuri_hengjiang") > 0 then
						-- local i = p:getMark("@yuri_hengjiang")*2
						-- room:setPlayerMark(p,"@yuri_hengjiang", i)
					-- end
				-- end
			-- end
		end
		return false
	end,

	can_trigger = function(self, target)
		return target ~= nil
	end
}


-- 都鄉：鎖定技。當你沒有"好知"標記，你不是其他人使用的單體非延時錦囊牌的合法目標。當你使用錦囊牌後，你獲得一枚"好知"標記(至多為當前生命x2)。當你是來源非自身之錦囊牌的目標，你失去一枚"好知"標記。
--當你成為團體錦囊的目標時，做一次判定，若為黑色，則你再度成為目標，若為紅色，你取消該目標。
miyadokyo = sgs.CreateTriggerSkill{
	name = "miyadokyo", 
	events = {sgs.PreCardUsed, sgs.CardUsed},
	on_trigger = function(self, event, player, data, room)
		local room = player:getRoom()
		local majis = room:findPlayersBySkillName(self:objectName())
		local use = data:toCardUse()
		if event == sgs.PreCardUsed then
			--避免不知道改判什麼
			local log = sgs.LogMessage()
			log.type = "#liketoask_log"
			log.from = use.from
			log.card_str = use.card:toString()
			room:sendLog(log)
			for _,maji in sgs.qlist(majis) do
				if maji and maji:isAlive() and use.to:contains(maji) and (use.card:isKindOf("AOE") or use.card:isKindOf("AmazingGrace") or use.card:isKindOf("GodSalvation")) then
					-- if p:getMark(self:objectName()) > 0 and not room:isProhibited(player, p, use.card) then
					-- if math.random(1, 100) < 50 then room:broadcastSkillInvoke("miyadokyo", 3) end
					if (maji:getAI() or maji:getState() == "robot") then --方便AI判斷
						if use.card:isKindOf("AOE") then maji:setFlags("majiBad") end
						if use.card:isKindOf("AmazingGrace") then maji:setFlags("majiGood") end
						if use.card:isKindOf("GodSalvation") then maji:setFlags("majiHeal") end
					end
					local judge = sgs.JudgeStruct()
					judge.pattern = "."
					-- judge.good = true
					judge.reason = self:objectName()
					judge.who = maji
					judge.play_animation = false
					room:judge(judge)
					if judge.card:isBlack() then
						use.to:append(maji)
					elseif judge.card:isRed() and use.to:contains(maji) then
						use.to:removeOne(maji)
					end
					room:sortByActionOrder(use.to)
					data:setValue(use)
				end
			end
		end
		if event == sgs.CardUsed and use.card:isKindOf("TrickCard") then
			for _,maji in sgs.qlist(majis) do
				if use.from:objectName() ~= maji:objectName() and maji:getMark("&liketoask") > 0 and use.to:contains(maji) then
					maji:loseMark("&liketoask", 1)
				elseif use.from:objectName() == maji:objectName() and maji:getMark("&liketoask") < maji:getHp() then
					if not (use.card:isKindOf("AOE") or use.card:isKindOf("AmazingGrace") or use.card:isKindOf("GodSalvation")) and math.random(1, 100) < 30 then room:broadcastSkillInvoke("miyadokyo", math.random(1, 3)) end
					maji:gainMark("&liketoask")
				end
			end
		end
	end, 
	can_trigger = function(self, target)
		return target
	end
}
-- 神樂：鎖定技。場上判定不可被更改。當需要判定時，你摸一张牌，然後可以將一張牌置於堆頂。
goddess_new = sgs.CreateTriggerSkill{
    name = "goddess_new",
    events = {sgs.StartJudge, sgs.AskForRetrial},       
    frequency = sgs.Skill_NotFrequent,
	can_trigger = function(self, target)
		return target
	end,
    on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local majis = room:findPlayersBySkillName(self:objectName())
		if event == sgs.AskForRetrial then
			-- if maji and ((maji:getPile("learned"):length()) >= 3 or maji:hasFlag("goddessturn")) then -- 第一版神樂
			for _,maji in sgs.qlist(majis) do
				if maji and maji:isAlive() then
					local log = sgs.LogMessage()
					log.type = "#gdnr_log"
					log.from = maji
					log.arg = self:objectName()
					room:sendLog(log)
					-- if maji:hasFlag("goddessturn") then maji:setFlags("-goddessturn") end -- 第一版神樂
					return true
				end
			end
		end
		if event == sgs.StartJudge then
			-- local judge = data:toJudge()
			-- maji:gainMark("&" .. judge.reason) --reason出來的文字是小寫 ex supply_shortage
			for _,maji in sgs.qlist(majis) do
				room:sendCompulsoryTriggerLog(maji, self)
				maji:drawCards(1, self:objectName())
				if maji:isDead() or maji:isNude() then continue end
				local card = room:askForCard(maji, "..", "@goddess-put", data, sgs.Card_MethodNone)
				if not card then continue end
				room:moveCardTo(card, nil, sgs.Player_DrawPile, sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_PUT, player:objectName(), self:objectName(), ""))
			end
		end
		return false 
	end, 
    priority = 6,
}
--[[
經撰：階段技，你可以將任意數量的手牌至於武將牌上，視為“太平經”。一場遊戲最多僅能獲取十張“太平經”。
回合開始，如果你已經獲取過“太平經”，妳可以選擇以下一項發動，但無法連續兩回合發動同一效果。效果直到下次你的回合開始。
金：場上所有武將，在使用三張牌後直接結束階段。
木：場上所有武將在其回合結束時，可以棄置一張手牌，摸兩張牌。
水：場上所有武將的恢復時，受恢復者可棄置一張紅色手牌，令恢復力+1。
火：造成屬性傷害時，來源可以棄置一張黑桃手牌，令傷害+1。
土：造成非屬性傷害時，受害者可以棄置一張梅花手牌，令傷害-1。
本技能效果發生時，你可以選擇：1.無效該次效果，2.本次效果無須棄牌。若你有選擇以上其中之一，你棄置一張“太平經”。

X獻經：限定技，若你有“太平經”，你可以令一名目標棄置身上所有牌，獲取你所有的“太平經”牌，或棄置你所有的“太平經”牌，獲得纏怨。]]


keishoukakiCard = sgs.CreateSkillCard{
	name = "keishoukaki" ,
	will_throw = false ,
	target_fixed = true ,
	mute = true,
	handling_method = sgs.Card_MethodNone,
	on_use = function(self, room, source, targets)
		local room = source:getRoom()
		source:addToPile("taiheikei", self)
		room:addPlayerMark(source, "taiheikei_hiddenmark", self:getSubcards():length())
		-- room:addPlayerMark(source, "taiheikei_phacsecount", self:getSubcards():length())
		if source:getMark("taiheikei_hiddenmark") > 10 then
			room:setPlayerMark(source, "taiheikei_hiddenmark", 10)
		end
	end
}
keishoukakiVS = sgs.CreateViewAsSkill{
	name = "keishoukaki" ,
	n = 999,
	enabled_at_play = function(self, player)
		return player:getMark("taiheikei_hiddenmark") < 10
	end ,
	view_filter = function(self, selected, to_select)
		-- local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
		-- if pattern == "@@keishoukaki" then
			-- return to_select:isKindOf("Slash")
			return not to_select:isEquipped() and (#selected < (10 - sgs.Self:getMark("taiheikei_hiddenmark")))
		-- end
	end,
	view_as = function(self, cards)
		-- local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
		-- if pattern == "@@keishoukaki" then
			if #cards == 0 then return nil end
			local acard = keishoukakiCard:clone()
			for _, c in ipairs(cards) do
				acard:addSubcard(c)
			end
			acard:setSkillName(self:objectName())
			return acard
		-- end
	end,
}
keishoukaki = sgs.CreateTriggerSkill{
	name = "keishoukaki" ,
	events = {sgs.EventPhaseStart, sgs.ChoiceMade},
	view_as_skill = keishoukakiVS ,
	on_trigger = function(self, event, player, data)
		local keishoukakiType = {"kana", "moku", "mizu", "hono", "daiji"}
		-- if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Start and not player:getPile("taiheikei"):isEmpty() then
		if event == sgs.EventPhaseStart then
			if player:getPhase() == sgs.Player_Start then
				local room = player:getRoom()
				-- if player:getMark("taiheikei_phacsecount") > 0 then room:setPlayerMark(player, "taiheikei_phacsecount", 0) end
				local current = player:getTag("keishoukaki"):toString()
				local choices = {}
				for _, effect in ipairs(keishoukakiType) do
					if effect ~= current then
						table.insert(choices, effect)
					end
				end
				player:setFlags("KeishoukakiZokusei") --給AI看
				local choice = room:askForChoice(player, self:objectName(), table.concat(choices, "+"))
				if not (current == "" or current == nil) then
					player:loseMark("&" .. current)
				end
				if choice == "kana" then--播放配音
					room:broadcastSkillInvoke("keishoukaki", 1)
				elseif choice == "moku" then
					room:broadcastSkillInvoke("keishoukaki", 2)
				elseif choice == "mizu" then
					room:broadcastSkillInvoke("keishoukaki", 3)
				elseif choice == "hono" then
					room:broadcastSkillInvoke("keishoukaki", 4)
				elseif choice == "daiji" then
					room:broadcastSkillInvoke("keishoukaki", 5)
				end
				player:gainMark("&" .. choice)
				player:setTag("keishoukaki", sgs.QVariant(choice))
			-- elseif player:getPhase() == sgs.Player_Finish and player:getMark("taiheikei_phacsecount") > 0 then
				-- player:drawCards(player:getMark("taiheikei_phacsecount"))
				-- player:setMark("taiheikei_phacsecount", 0)
			end
		end
		if event == sgs.ChoiceMade then
			local datastr = data:toString()
			if datastr == "skillChoice:keishoukaki:active_effect" or datastr == "skillChoice:keishoukaki:cancel_effect" then
				player:drawCards(1)
			end
		end
		return false
	end
}

keishoukakiEffect = sgs.CreateTriggerSkill{
	name = "#keishoukakiEffect" ,
	events = {sgs.PreHpRecover, sgs.DamageInflicted, sgs.EventPhaseChanging, sgs.CardFinished} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local user = room:findPlayerBySkillName("keishoukaki")
		if not user then return false end
		local acard
		local choice = nil
		local currect_type = user:getTag("keishoukaki"):toString()
		if event == sgs.PreHpRecover and currect_type == "mizu" then --水效果
		-- if event == sgs.PreHpRecover then --水效果
			local rec = data:toRecover()
			-- if rec.card and (rec.card:isKindOf("Peach")) then
				local ai_data = sgs.QVariant()
				ai_data:setValue(player)
				if not user:getPile("taiheikei"):isEmpty() then
					local log = sgs.LogMessage()
					log.type = "#taiheikei_pre_log"
					log.from = player
					log.arg = "mizu"
					log.arg2 = "keishoukaki"
					room:sendLog(log)
					player:setFlags("mizu_AI") --給AI用
					choice = room:askForChoice(user, "keishoukaki", "cancel_effect+active_effect+cancel", ai_data)
					if choice ~= "cancel" then
						local card_id = user:getPile("taiheikei"):first()
						room:throwCard(card_id, nil)
					end
					if choice == "cancel_effect" then return false end
				end
				if choice ~= "active_effect" then
					acard = room:askForCard(player, ".|red|.|hand", "@mizu_recover_ask", ai_data, sgs.Card_MethodDiscard)
				end
				if choice == "active_effect" or acard then
					rec.recover = rec.recover + 1
					local log = sgs.LogMessage()
					log.type = "#mizu_log"
					log.from = user
					log.arg = rec.recover
					log.arg2 = "keishoukaki"
					room:sendLog(log)
					data:setValue(rec)
				end
			-- end
		elseif event == sgs.DamageInflicted then
			local damage = data:toDamage()
			local ai_data = sgs.QVariant()
			ai_data:setValue(damage)
			if currect_type == "daiji" then --土效果
				if damage.nature == sgs.DamageStruct_Normal and damage.damage > 0 then
					if not user:getPile("taiheikei"):isEmpty() then
						local log = sgs.LogMessage()
						log.type = "#taiheikei_pre_log"
						log.from = damage.to
						log.arg = "daiji"
						log.arg2 = "keishoukaki"
						room:sendLog(log)
						damage.to:setFlags("daiji_AI") --給AI用
						choice = room:askForChoice(user, "keishoukaki", "cancel_effect+active_effect+cancel", ai_data)
						if choice ~= "cancel" then
							local card_id = user:getPile("taiheikei"):first()
							room:throwCard(card_id, nil)
						end
						if choice == "cancel_effect" then return false end
					end
					if choice ~= "active_effect" then
						acard = room:askForCard(damage.to, ".|black|.|hand", "@daiji_damage_ask", ai_data, sgs.Card_MethodDiscard)
					end
					if choice == "active_effect" or acard then
						damage.damage = damage.damage - 1
						local log = sgs.LogMessage()
						log.type = "#daiji_log"
						log.from = user
						log.arg = tonumber(damage.damage)
						log.arg2 = "keishoukaki"
						room:sendLog(log)
						if damage.damage == 0 then
							return true
						else
							data:setValue(damage)
						end
					end
				end
			end
			if currect_type == "hono" then --火效果
				if damage.nature ~= sgs.DamageStruct_Normal and damage.damage > 0 then
					if not user:getPile("taiheikei"):isEmpty() then
						local log = sgs.LogMessage()
						log.type = "#taiheikei_pre_log"
						log.from = damage.from
						log.arg = "hono"
						log.arg2 = "keishoukaki"
						room:sendLog(log)
						damage.to:setFlags("hono_AI") --給AI用
						choice = room:askForChoice(user, "keishoukaki", "cancel_effect+active_effect+cancel", ai_data)
						if choice ~= "cancel" then
							local card_id = user:getPile("taiheikei"):first()
							room:throwCard(card_id, nil)
						end
						if choice == "cancel_effect" then return false end
					end
					if choice ~= "active_effect" then
						acard = room:askForCard(damage.from, ".|spade|.|hand", "@hono_damage_ask", ai_data, sgs.Card_MethodDiscard)
					end
					if choice == "active_effect" or acard then
						damage.damage = damage.damage + 1
						local log = sgs.LogMessage()
						log.type = "#hono_log"
						log.from = user
						log.arg = tonumber(damage.damage)
						log.arg2 = "keishoukaki"
						room:sendLog(log)
						data:setValue(damage)
					end
				end
			end
		elseif event == sgs.EventPhaseChanging then
		-- elseif event == sgs.EventPhaseChanging then
			local change = data:toPhaseChange() 
			-- if change.to == sgs.Player_NotActive and player:getMark("@jpjile") > 0 then 
			if change.to == sgs.Player_NotActive then
				if player:getMark("&kana_counter") > 0 then room:setPlayerMark(player, "&kana_counter", 0) end
				-- if player:getMark("taiheikei_phacsecount") > 0 then room:setPlayerMark(player, "taiheikei_phacsecount", 0) end
				if player:hasFlag("NoKanaEffect") then player:setFlags("-NoKanaEffect") end
				if currect_type == "moku" then --木效果
					local ai_data = sgs.QVariant()
					ai_data:setValue(player)
					if not user:getPile("taiheikei"):isEmpty() then
						local log = sgs.LogMessage()
						log.type = "#taiheikei_pre_log"
						log.from = player
						log.arg = "moku"
						log.arg2 = "keishoukaki"
						room:sendLog(log)
						player:setFlags("moku_AI") --給AI用
						choice = room:askForChoice(user, "keishoukaki", "cancel_effect+active_effect+cancel", ai_data)
						if choice ~= "cancel" then
							local card_id = user:getPile("taiheikei"):first()
							room:throwCard(card_id, nil)
						end
						if choice == "cancel_effect" then return false end
					end
					if choice ~= "active_effect" then
						acard = room:askForCard(player, ".|.|.|hand", "@moku_draw_ask", ai_data, sgs.Card_MethodDiscard)
					end
					if choice == "active_effect" or acard then
						local log = sgs.LogMessage()
						log.type = "#moku_log"
						log.from = user
						log.arg = 2
						log.arg2 = "keishoukaki"
						room:sendLog(log)
						player:drawCards(2)
					end
				end
			end
		elseif event == sgs.CardFinished and currect_type == "kana" then --金效果
		-- elseif event == sgs.CardFinished then --金效果
			local use = data:toCardUse()
			local card = use.card
			if card and card:getTypeId() ~= 0 and not card:isKindOf("SkillCard") and player:objectName() == use.from:objectName() and player:getPhase() == sgs.Player_Play then
				if use.from:hasFlag("NoKanaEffect") then return false end
				local ai_data = sgs.QVariant()
				ai_data:setValue(player)
				if use.from:getMark("&kana_counter") == 0 and not user:getPile("taiheikei"):isEmpty() then
					local log = sgs.LogMessage()
					log.type = "#taiheikei_pre_log"
					log.from = use.from
					log.arg = "kana"
					log.arg2 = "keishoukaki"
					room:sendLog(log)
					player:setFlags("kana_AI") --給AI用
					choice = room:askForChoice(user, "keishoukaki", "cancel_effect+cancel", ai_data)
					if choice == "cancel_effect" then
						local card_id = user:getPile("taiheikei"):first()
						room:throwCard(card_id, nil)
						use.from:setFlags("NoKanaEffect")
						return false
					end
				end
				-- player:drawCards(1,self:objectName())
				room:addPlayerMark(player,"&kana_counter")
				if player:getMark("&kana_counter") >= 3 then
					local log = sgs.LogMessage()
					log.type = "#kana_log"
					log.from = user
					log.arg = 3
					log.arg2 = "keishoukaki"
					room:sendLog(log)
					room:setPlayerMark(player, "&kana_counter", 0)
					room:setPlayerFlag(player,"Global_PlayPhaseTerminated")
				end
			end
		end
		return false
	end ,
	can_trigger = function(self, target)
		return target
	end
}

-- 邀棋：鎖定技。遊戲開始，你令全場獲得“落子”技能，並獲得一枚【落子：黑】標記。場上所有武將成為落子標記相同之武將的目標時，棄置一張手牌(若目標是你，則不棄牌)。不同，摸兩張牌棄置一張牌。

taigyokunoyousei = sgs.CreateTriggerSkill{
	name = "taigyokunoyousei",
	frequency = sgs.Skill_Compulsory, 
	events = {sgs.GameStart, sgs.TargetConfirming, sgs.TargetConfirmed},
	on_trigger = function(self, event, player, data, room)
		local room = player:getRoom()
		if event == sgs.GameStart then
			if player:hasSkill("taigyokunoyousei") then room:broadcastSkillInvoke("taigyokunoyousei", math.random(1, 2)) end
			if not player:hasSkill("gomaoku") then room:acquireSkill(player,"gomaoku") end
			if player:getMark("&gomaoku_black") == 0 then player:gainMark("&gomaoku_black") end
			-- for _,p in sgs.qlist(room:getAlivePlayers()) do
				-- if p:hasSkill("taigyokunoyousei") then room:broadcastSkillInvoke("taigyokunoyousei", math.random(1, 2)) end
				-- if not p:hasSkill("gomaoku") then room:acquireSkill(p,"gomaoku") end
				-- if p:getMark("&gomaoku_black") == 0 then p:gainMark("&gomaoku_black") end
			-- end
		elseif event == sgs.TargetConfirming then
			local use = data:toCardUse()
			local from = use.from
			if not use.card or use.card:isKindOf("SkillCard") then return false end
			if not from:hasFlag("TaigyokuSound") then
				from:setFlags("TaigyokuSound")
				if math.random(1, 100) < 20 then room:broadcastSkillInvoke("taigyokunoyousei", math.random(3, 4)) end
			end
			for _, to in sgs.qlist(use.to) do
				if to:hasFlag("TaigyokuZumi") then break end
				to:setFlags("TaigyokuZumi")
				if (to:getMark("&gomaoku_black") == 1 and from:getMark("&gomaoku_black") == 1) or (to:getMark("&gomaoku_red") == 1 and from:getMark("&gomaoku_red") == 1) then
					-- if not to:isKongcheng() and not (to:hasSkill("taigyokunoyousei") and to:objectName() == from:objectName()) then room:askForDiscard(to, "taigyokunoyousei", 1, 1, false, false) end
					if not (to:isKongcheng() and to:hasSkill("taigyokunoyousei")) and to:objectName() ~= from:objectName() then room:askForDiscard(to, "taigyokunoyousei", 1, 1, false, false) end
				elseif (to:getMark("&gomaoku_black") == 1 and from:getMark("&gomaoku_red") == 1) or (to:getMark("&gomaoku_red") == 1 and from:getMark("&gomaoku_black") == 1) then
					to:drawCards(2, "taigyokunoyousei")
					if not to:isKongcheng() then room:askForDiscard(to, "taigyokunoyousei", 1, 1, false, true) end
				end
			end
		elseif event == sgs.TargetConfirmed then
			local use = data:toCardUse()
			local from = use.from
			if from:hasFlag("TaigyokuSound") then from:setFlags("-TaigyokuSound") end
			
			for _, to in sgs.qlist(use.to) do
				if to:hasFlag("TaigyokuZumi") then to:setFlags("-TaigyokuZumi") end
			end
		end
		return false
	end,
	can_trigger = function(self, target)
		return target
	end
}

--落子：階段技，1.當你擁有【落子：黑】標記時，可以棄置一張紅色手牌，獲得【落子：紅】、失去【落子：黑】。
--2.當你擁有【落子：紅】標記時，可以棄置一張黑色手牌，獲得【落子：黑】、失去【落子：紅】。
--標記更換前，你令持有【邀棋】技能者選擇一項 ：1.摸一张牌；2.自己的落子標記換成另一種顏色。若使用者擁有【邀棋】，則必定摸牌。

gomaokuCard = sgs.CreateSkillCard{
	name = "gomaoku", 
	will_throw = true,
	target_fixed = true,
	-- mute = true,
	filter = function(self, targets, to_select) 
		return #targets < 1
	end,
	on_use = function(self, room, source, targets)
		source:setFlags("gomaokuUsing")
		room:cardEffect(self, source, source)
		source:setFlags("-gomaokuUsing")
	end ,
	on_effect = function(self, effect)
		local room = effect.from:getRoom()
		local from = effect.from
		for _,p in sgs.qlist(room:getAlivePlayers()) do
			if p:hasSkill("taigyokunoyousei") then
				if p:objectName() == from:objectName() then 
					p:drawCards(1)
					break
				end
				local ai_data = sgs.QVariant()
				ai_data:setValue(from)
				if room:askForChoice(p, "taigyokunoyousei", "draw+change_goma", ai_data) == "draw" then
					p:drawCards(1)
				else
					if p:getMark("&gomaoku_black") > 0 then
						p:gainMark("&gomaoku_red")
						p:loseMark("&gomaoku_black")
					elseif p:getMark("&gomaoku_red") > 0 then
						p:gainMark("&gomaoku_black")
						p:loseMark("&gomaoku_red")
					end
				end
			end
		end
		if from:getMark("&gomaoku_black") > 0 then
			from:gainMark("&gomaoku_red")
			from:loseMark("&gomaoku_black")
		elseif from:getMark("&gomaoku_red") > 0 then
			from:gainMark("&gomaoku_black")
			from:loseMark("&gomaoku_red")
		end
	end
}
gomaoku = sgs.CreateViewAsSkill{
	name = "gomaoku", 
	n = 1, 
	expand_pile = "wooden_ox",
	enabled_at_play = function(self, player)
		return not player:hasUsed("#gomaoku") and not player:isKongcheng()
	end,
	view_filter = function(self, selected, to_select)
		-- return #selected > 0
		return #selected == 0 and not to_select:isEquipped() and ((to_select:isRed() and sgs.Self:getMark("&gomaoku_black") == 1) or (to_select:isBlack() and sgs.Self:getMark("&gomaoku_red") == 1))
	end, 
	view_as = function(self, cards) 
		if #cards == 1 then
			local card = gomaokuCard:clone()
			card:addSubcard(cards[1])
			return card
		else 
			return nil
		end
	end
}
--[[
	技能名：倚天
	相关武将：倚天劍
	描述：鎖定技。若你沒裝備武器，你的攻擊距離等同你的當前生命。你的殺被閃抵銷且該閃置入棄牌堆時，你獲得該閃，其餘情況你摸一张牌。你的閃不會算入手牌數量。
	引用：LuaYTZhenwei
	状态：1217验证通过
]]
hb_yitain = sgs.CreateTriggerSkill{
	name = "hb_yitain" ,
	frequency = sgs.Skill_Compulsory, 
	events = {sgs.CardOffset} ,
	on_trigger = function(self, event, player, data)
		local effect = data:toCardEffect()
		local room = player:getRoom()
		if not effect.card:isKindOf("Slash") then return false end
		if effect.offset_card and (room:getCardPlace(effect.offset_card:getEffectiveId()) == sgs.Player_DiscardPile) then
			player:obtainCard(effect.offset_card)
		elseif player:getMark("@SuperLimitBreak") > 0 then
			player:drawCards(1, "hb_yitain")
		end
		return false
	end
}
-- 鬥陣：當你打出一張閃，你可以令一名在攻擊範圍內自己以外的目標打出一張閃，否則受到來自於你的一點傷害。
hb_konoyaiba_uketemiyo = sgs.CreateTriggerSkill{
	name = "hb_konoyaiba_uketemiyo",
	events = {sgs.CardResponded},
	on_trigger = function(self, event, player, data)
		
		if event == sgs.CardResponded then
			local room = player:getRoom()
			local card = data:toCardResponse().m_card
			if card and (card:isKindOf("Jink") or card:isKindOf("Slash")) and not card:isKindOf("SkillCard") then
				local list = room:getOtherPlayers(player)
				local guys = sgs.SPlayerList()
				for _,t in sgs.qlist(list) do
					if (player:inMyAttackRange(t) or (player:distanceTo(t) <= player:getHp() and not player:getWeapon())) and player:getHp() <= t:getHp() then guys:append(t) end
					-- guys:append(t)
				end	
				if guys:length() == 0 then return false end
				local str
				if card:isKindOf("Jink") then
					str = "@hb_konoyaiba_uketemiyo:slash"
				else
					str = "@hb_konoyaiba_uketemiyo:jink"
				end
				local tar = room:askForPlayerChosen(player, guys, self:objectName(), str, true, true)
				if tar and tar:isAlive() then
					local acard
					if card:isKindOf("Jink") then
						acard = room:askForCard(tar, "Slash", "@konayaiba-discard:slash::" .. player:getGeneralName(), sgs.QVariant(), sgs.Card_MethodResponse)
					else
						acard = room:askForCard(tar, "Jink", "@konayaiba-discard:jink::" .. player:getGeneralName(), sgs.QVariant(), sgs.Card_MethodResponse)
					end
					if not acard then
						room:damage(sgs.DamageStruct("hb_konoyaiba_uketemiyoDamage", player, tar, 1, sgs.DamageStruct_Normal))
					end
				end				
			end
		end
		return false
	end
}

-- 肉濘：鎖定技。每次你受到通常傷害時，若為一點則無效之，然後你獲得一枚死戰標記。若兩點以上或為屬性傷害，該傷害增加死戰標記數，再令其傷害翻倍，然後棄置所有死戰標記。若傷害來源的生命值少於你，你令其摸一张牌。回合結束時，若你的最大生命值大於6，且至少損失了兩點生命，你必須恢復一點生命然後失去一點最大生命值，重複此流程直到生命全滿。
nikuhei = sgs.CreateTriggerSkill{
	name = "nikuhei",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.PreDamageDone, sgs.DamageInflicted, sgs.EventPhaseEnd},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.EventPhaseEnd and player:getPhase() == sgs.Player_Finish and player:getLostHp() > 1 and player:getMaxHp() > 3 then
			while player:getMaxHp() > 3 do
				room:recover(player, sgs.RecoverStruct(player))
				if player:isWounded() then room:loseMaxHp(player, 1) end
				if not player:isWounded() then break end
				room:getThread():delay(250)
			end
		end
		if event == sgs.DamageInflicted or event == sgs.PreDamageDone then
			local damage = data:toDamage()
			if event == sgs.DamageInflicted then
				if damage.damage > 0 and player:getHp() > damage.from:getHp() then damage.from:drawCards(1) end
				if damage.damage > 0 and damage.damage < 2 and damage.nature == sgs.DamageStruct_Normal then
					player:gainMark("@struggle", damage.damage)
					local log = sgs.LogMessage()
					log.type = "#bloody_log"
					log.from = player
					log.arg = damage.damage
					log.arg2 = self:objectName()
					room:sendLog(log)
					return true
				end
			end
			if event == sgs.PreDamageDone and ((damage.damage > 0 and damage.nature ~= sgs.DamageStruct_Normal) or damage.damage >= 2) then
				if player:getMark("@struggle") > 0 then
					damage.damage = damage.damage + player:getMark("@struggle")
					player:loseAllMarks("@struggle")
				end
				local log = sgs.LogMessage()
				log.type = "#Revenge_log2"
				log.from = player
				log.arg = damage.damage*2
				log.arg2 = self:objectName()
				room:sendLog(log)
				damage.damage = damage.damage*2
				data:setValue(damage)
			end
			-- player:gainMark("&test")
		end
		return false
	end,
	priority = -10
}

-- 天才：妳可以流失一點生命發動以下技能之一：【百合包-泰然】、【百合包-絕策】、

-- 百合包泰然：鎖定技。行動階段結束時，你將生命恢復至體力上限，然後摸該數量的牌背面蓋置於武將牌上，稱為“泰然牌”(不可翻看，至多六張)。你的回合開始時，獲得所有“泰然牌”，若其中有殺，則你流失“殺”數量的生命。
--百合包絕策：回合結束時，你可以選擇一名角色，若其手牌數大於當前生命，你令其棄置至與當前生命相同，若非，則受到一點來自於你的傷害。

--[[
-- 肉牆：鎖定技。你與其距離為一的角色受你及其自己之外的角色的非延時錦囊、殺、桃指定時，你代替成為目標(無法對借刀殺人生效)。
nikuhei_p = sgs.CreateTriggerSkill{--這種強制更改目標的效果對AI不友善
	name = "nikuhei_p",
	events = {sgs.PreCardUsed},
	frequency = sgs.Skill_Compulsory,
	can_trigger = function(self, player)
		return player and player:isAlive()
	end,
	on_trigger = function(self, event, player, data, room)
		local use = data:toCardUse()
		local room = player:getRoom()
		if use.to:length() == 0 then return false end
		-- if use.to:length() == 1 and use.to:first():objectName() == use.from:objectName() then return false end
		if (use.card:isKindOf("Slash") or use.card:isKindOf("Peach") or (use.card:isNDTrick() and not use.card:isKindOf("Collateral") and not use.card:isKindOf("Nullification"))) then
			local nikus = room:findPlayersBySkillName("nikuhei")
			local tanks = sgs.SPlayerList()
			local ori_tars = sgs.SPlayerList()
			local will_remove = sgs.SPlayerList()
			for _,t in sgs.qlist(use.to) do
				ori_tars:append(t)
			end
			for _,p in sgs.qlist(nikus) do
				for _,t in sgs.qlist(use.to) do
					if p:objectName() ~= t:objectName() and p:objectName() ~= use.from:objectName() and t:objectName() ~= use.from:objectName() 
					and not will_remove:contains(t) and p:isAlive() and p:hasSkill("nikuhei") and p:distanceTo(t) <= 1 then
						tanks:append(p)
						will_remove:append(t)
					end
				end
			end
			if tanks:length() == 0 then return false end
			for _,p in sgs.qlist(tanks) do
				use.to:append(p)
			end
			for _,p in sgs.qlist(will_remove) do
				if use.to:contains(p) then use.to:removeOne(p) end
			end
			local log = sgs.LogMessage()
			log.type = "#nikuhei_p_log"
			log.from = use.from
			log.to = use.to
			log.card_str = use.card:toString()
			log.arg = self:objectName()
			room:sendLog(log)
			log.type = "#nikuhei_p_log2"
			log.to = ori_tars
			room:sendLog(log)
			room:sortByActionOrder(use.to)
			data:setValue(use)
		end
		return false
	end
}
]]
-- 王肉：主公技。每位角色的行動階段開始時，若其已受傷，且你的當前生命大於其當前生命，你可以流失一點體力，令其摸兩張牌。

-- kingsmeat = sgs.CreateTriggerSkill{
	-- name = "kingsmeat$" ,
	-- events = {sgs.EventPhaseStart} ,
	-- on_trigger = function(self, event, player, data)
		-- if player:getPhase() == sgs.Player_Play then
		-- local room = player:getRoom()
		-- local mk = room:findPlayerBySkillName(self:objectName())
		-- if mk:isAlive() and mk:getHp() > player:getHp() then
		-- return false
	-- end ,
	-- can_trigger = function(self, target)
		-- return target
	-- end
-- }
-- 王肉：主公技。當基本牌或錦囊牌卡片使用結束，若你曾為該目標，且使用者不為你，你可以令使用者摸一张牌，如果你的生命值小於等於使用者，你額外恢復一點生命。
nikuhei_k = sgs.CreateTriggerSkill{
	name = "nikuhei_k$",
	events = {sgs.CardFinished},
	can_trigger = function(self, player)
		return player
	end,
	on_trigger = function(self, event, player, data, room)
		local use = data:toCardUse()
		local room = player:getRoom()
		local mk
		for _,p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
			if p:isLord() then
				mk = p
				break
			end
		end
		if mk and use.from and mk:objectName() ~= use.from:objectName() and mk:isAlive() 
		and (use.card:isKindOf("BasicCard") or use.card:isKindOf("TrickCard")) and use.to:contains(mk) then
			local ai_data = sgs.QVariant()
			ai_data:setValue(use.from)
			if room:askForSkillInvoke(mk, self:objectName(), ai_data) then
				use.from:drawCards(1)
				if mk:getHp() <= use.from:getHp() and mk:isWounded() then
					room:recover(mk, sgs.RecoverStruct(mk))
				end
			end
		end
		return false
	end
}

-- 鎖定技。你造成的傷害若為一點以下，則無效那次傷害，若超過一點，則增加一點傷害。
-- 備份_舊寧靜：鎖定技。你的棄牌階段結束後，摸兩張牌，若手牌數量超過體力上限，則棄置超過的數量。每次你以此法棄置手牌便獲得一枚止水標記，當標記超過自己當前生命，你棄置所有標記，令一名目標恢復一點體力。

-- sizukana = sgs.CreatePhaseChangeSkill{
	-- name = "sizukana",
	-- frequency = sgs.Skill_Compulsory,
	-- on_phasechange = function(self, player)
		-- if player:getPhase() == sgs.Player_Finish then
			-- local room = player:getRoom()
			-- player:drawCards(2, self:objectName())
			-- local x = player:getHandcardNum() - math.min(5, player:getMaxHp())
			-- if x > 0 then room:askForDiscard(player, self:objectName(), x, x) player:gainMark("@sizukana_mark", x) end
			-- if player:getMark("@sizukana_mark") > player:getHp() then
				-- local list = room:getAlivePlayers()
				-- local guys = sgs.SPlayerList()
				-- for _,t in sgs.qlist(list) do
					-- if t:isWounded() then
						-- guys:append(t)
					-- end
				-- end
				-- if guys:length() == 0 or not room:askForSkillInvoke(player, self:objectName()) then return false end
				-- local fri = room:askForPlayerChosen(player, guys, "sizukana", "@sizukana_choiceplayer")
				-- if fri then 
					-- room:broadcastSkillInvoke("sizukana", 1)
					-- player:loseAllMarks("@sizukana_mark")
					-- local theRecover = sgs.RecoverStruct()
					-- theRecover.recover = 1
					-- theRecover.who = fri
					-- room:recover(fri, theRecover)
				-- end
			-- else
				-- room:broadcastSkillInvoke("sizukana", math.random(2, 3))
			-- end
		-- end
		-- return false
	-- end
-- }
--[[
-- 神樂(舊版)
goddess = sgs.CreateTriggerSkill{
	name = "goddess", 
	frequency = sgs.Skill_Compulsory,  
	events = {sgs.StartJudge},
	on_trigger = function(self, event, player, data) 
		local room = player:getRoom()
		-- local judge = data:toJudge()
		-- local victim = judge.who
		if event == sgs.StartJudge then
			local maji = room:findPlayerBySkillName(self:objectName())
			-- if maji and not (maji:getPile("learned"):isEmpty() or maji:getPile("learned"):length() < 3) then -- 第一版神樂
			if maji and maji:isAlive() then
				local log = sgs.LogMessage()
				log.type = "#gd_log"
				log.from = maji
				log.arg = "goddess"
				room:sendLog(log)
				
				-- local Lpile = maji:getPile("learned")-- 第一版神樂s
				-- room:fillAG(Lpile, maji)
				-- local id = room:askForAG(maji, Lpile, false, self:objectName())
				-- room:clearAG(maji)
				-- room:moveCardTo(sgs.Sanguosha:getCard(id), maji, sgs.Player_DrawPile)
				-- local count = maji:getPile("learned"):length() + 1
				-- local cards = room:getNCards(count)
				-- maji:setFlags("goddessturn") -- 本記號是為了防止3張學習牌，被剪去1發動該技能時，"黨改判技能"判定小於3而不發動
				-- room:askForGuanxing(maji,cards)
				room:broadcastSkillInvoke("goddess",math.random(1,2))
				room:askForGuanxing(maji, room:getNCards(5), sgs.Room_GuanxingUpOnly)
				maji:drawCards(1)
			end
		end
		return false
	end, 
	can_trigger = function(self, target)
		return target
	end
}
]]



--你可以防止当前判定牌的判定结果被你的后续角色(按照行动顺序)所改变_備份

-- noretrialStart = sgs.CreateTriggerSkill{ -- 加了can_trigger後，此技能被取代
	-- name = "#noretrialStart" ,
	-- events = {sgs.GameStart} ,
	-- on_trigger = function(self, event, player, data)
		-- local room = player:getRoom()
		-- local list = room:getAlivePlayers()
		-- for _,t in sgs.qlist(list) do
			-- if not t:hasSkill(self:objectName()) then
				-- room:acquireSkill(t, "#gdnoretrial")
			-- end
		-- end
	-- end ,
-- }
--[[
	技能名：好知(舊時代雨宿町的招式，現在暫且不用)
	相关武将：雨宿 町
	描述：任意目標出牌時，你可以選一張牌給予指定的目標，並獲重牌堆上方獲得一張“學習牌”放置於武將牌上，最多八張。當八張時還新增“學習牌”，你選擇一張既有的“學習牌”放入手牌。當你的學習牌到達五張，你可以使用技能【用學】(丟棄一張“學習牌”令目標使用的牌無效。(目標不能是自己，無懈可擊不會被無效))。
	引用：LuaQixing、LuaQixingStart
	状态：1217验证通过
]]
--[[
liketoask = sgs.CreateTriggerSkill{
	name = "liketoask" ,
    events = {sgs.CardUsed, sgs.JinkEffect, sgs.PreCardResponded, sgs.NullificationEffect} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local source = room:findPlayerBySkillName(self:objectName())
		local thepile = source:getPile("&learned")
		local cid = -1
		
		if event == sgs.CardUsed then
			local use = data:toCardUse()
			local ctype = ".."
			if not use.from or not use.card or use.card:getTypeId() == 0 then return false end
			if use.card:isKindOf("EquipCard") then
                    local log = sgs.LogMessage()
					log.type = "#liketoask_log"
					log.from = use.from
					log.card_str = use.card:toString()
					room:sendLog(log)
					ctype = "EquipCard"
			end
			if thepile:length() >= 3 and room:askForSkillInvoke(source, "@advice_nolearn", data) then -- 不進行學習，選擇無效卡牌
				local ud = use.card
				local log = sgs.LogMessage()
				log.type = "#nolearn_log"
				log.from = use.from
				log.arg = "@advice_nolearn"
				log.card_str = ud:toString()
				room:sendLog(log)
				if (thepile:length() > 1) then
					room:fillAG(thepile, source)
					cid = room:askForAG(source, thepile, false, self:objectName())
					room:clearAG(source)
				else
					cid = thepile:first()
				end
				if use.card:isKindOf("Nullification") then
					room:broadcastSkillInvoke("liketoask",math.random(3,4))
					source:setFlags("inNullification")
					room:throwCard(sgs.Sanguosha:getCard(cid), source)
					return false
				else
					room:broadcastSkillInvoke("liketoask",math.random(3,4))
					local nullified_list = use.nullified_list
					table.insert(nullified_list, "_ALL_TARGETS")
					use.nullified_list = nullified_list
					data:setValue(use)
					room:throwCard(sgs.Sanguosha:getCard(cid), source)
					local ids = sgs.IntList()
					if use.card:isVirtualCard() then
						ids = use.card:getSubcards()
					else
						ids:append(use.card:getEffectiveId())
					end
					if ids:length() > 0 then
						room:throwCard(use.card, room:getCardOwner(use.card:getEffectiveId()), source)
					end
					room:setTag("SkipGameRule",sgs.QVariant(true))
					return false
				end
			end
			
			if source:isNude() then return false end
		    local cardsnum = source:getHandcards():length()
			local cardEnum = source:getEquips():length()
			local n = 0
			
			for _,c in sgs.list(source:getHandcards()) do
                if c:getTypeId() == use.card:getTypeId() then 
				    break
                else
				    n = n + 1
			    end
            end
			if n >= cardsnum and (not use.card:isKindOf("EquipCard") or cardEnum == 0) then
			    return false
			end
			if use.card:isKindOf("BasicCard") then ctype = "BasicCard" end
			if use.card:isKindOf("TrickCard") then ctype = "TrickCard" end
			-- if use.card:isKindOf("EquipCard") then ctype = "EquipCard" end

			-- local invoked = room:askForCard(source, ctype, "@liketoask", data, self:objectName())
			local invoked = room:askForExchange(source, self:objectName(), 1,1, true, "@liketoask", true, ctype) -- 改成這個，就不會再扔牌，而是直接給
			if invoked then
				room:broadcastSkillInvoke("liketoask", 2)
			    local id = room:drawCard()
                -- local suit = sgs.Sanguosha:getCard(id):getSuit() -- 同花色則去除該牌.1
                -- local duplicate = false; -- 同花色則去除該牌.boolean
                -- for _,card_id in sgs.qlist(source:getPile("learned")) do -- 同花色則去除該牌.2
                    -- if (sgs.Sanguosha:getCard(card_id):getSuit() == suit) then
                        -- duplicate = true
                        -- break
                    -- end
                -- end
				local list = room:getAlivePlayers()
                local guys = sgs.SPlayerList()
				-- local all = room:getOtherPlayers(source)
					for _,t in sgs.qlist(list) do
						if not t:hasSkill(self:objectName()) then
							guys:append(t)
						end
					end
				if guys:length() == 0 then return false end
				local target = room:askForPlayerChosen(source, guys, "liketoask", "liketoask_choiceplayer")
				room:moveCardTo(invoked, target, sgs.Player_PlaceHand)
				if source:getPile("&learned"):length() < 6 then -- 額外牌組的限制，超過就選牌替換
					source:addToPile("&learned", id)
				else
						if (thepile:length() > 1) then
							room:fillAG(thepile, source)
							cid = room:askForAG(source, thepile, false, self:objectName())
							room:clearAG(source)
						else
							cid = thepile:first()
						end
						-- room:moveCardTo(sgs.Sanguosha:getCard(cid), source, sgs.Player_PlaceHand)
						room:obtainCard(source, sgs.Sanguosha:getCard(cid), false)
						source:addToPile("&learned", id)

					-- end
                -- source:addToPile("learned", id)
                -- if (duplicate) then -- 同花色則去除該牌.3end
                    -- local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_REMOVE_FROM_PILE,"", self:objectName(), "")
                    -- room:throwCard(sgs.Sanguosha:getCard(id), reason, nil)
                end
				-- room:setTag("SkipGameRule",sgs.QVariant(true))
			end
		elseif event == sgs.JinkEffect then
			local card = data:toCard()
			if not card then return false end
			if thepile:length() >= 3 and room:askForSkillInvoke(source, "@advice_nolearn", data) then -- 不進行學習，選擇無效卡牌
				local log = sgs.LogMessage()
				log.type = "#nolearn_log"
				log.from = player
				log.arg = "@advice_nolearn"
				log.card_str = card:toString()
				room:sendLog(log)
				if (thepile:length() > 1) then
					room:fillAG(thepile, source)
					cid = room:askForAG(source, thepile, false, self:objectName())
					room:clearAG(source)
				else
					cid = thepile:first()
				end
				room:broadcastSkillInvoke("liketoask",math.random(3,4))
				room:throwCard(sgs.Sanguosha:getCard(cid), source)
				room:throwCard(card, room:getCardOwner(card:getEffectiveId()), source)
				return true
			end
			
			if source:isNude() then return false end
			local cardsnum = source:getHandcards():length()
			local n = 0
			for _,c in sgs.list(source:getHandcards()) do
                if c:getTypeId() == card:getTypeId() then 
				    break
                else
				    n = n + 1
			    end
            end
			if n >= cardsnum then return false end
			local invoked = room:askForExchange(source, self:objectName(), 1,1, true, "@liketoask", true, "BasicCard")
			if invoked then
				room:broadcastSkillInvoke("liketoask", 2)
				local id = room:drawCard()
				local list = room:getAlivePlayers()
                local guys = sgs.SPlayerList()
					for _,t in sgs.qlist(list) do
						if not t:hasSkill(self:objectName()) then
							guys:append(t)
						end
					end
				if guys:length() == 0 then return false end
				local target = room:askForPlayerChosen(source, guys, "liketoask", "liketoask_choiceplayer")
				if target then room:moveCardTo(invoked, target, sgs.Player_PlaceHand) end
				if source:getPile("&learned"):length() < 6 then -- 額外牌組的限制，超過就選牌替換
					    source:addToPile("&learned", id)
				else
                    local thepile = source:getPile("&learned")
                    local cid = -1
                    if (thepile:length() > 1) then
                        room:fillAG(thepile, source)
                        cid = room:askForAG(source, thepile, false, self:objectName())
                        room:clearAG(source)
                    else
                        cid = thepile:first()
                    end
					room:obtainCard(source, sgs.Sanguosha:getCard(cid), false)
					source:addToPile("&learned", id)
				end
				return false
			end
			
		elseif event == sgs.PreCardResponded then -- 面對卡牌回應，因為回應種類也有可能是技能，所以不做無效了，此外，也做不出來啊
			local response = data:toCardResponse()
		    local card = response.m_card
			-- local victim = data:toCardResponse() -- 會找到自己
			local ctype = ".."
			if card:isKindOf("Jink") and response.m_isRetrial == false and response.m_isUse == true then return false end -- response.m_isUse 可以判斷是否為使用(萬箭齊發的不算，以閃回應殺則算)
			-- if not card or card:getTypeId() == 0 or card:isKindOf("Jink") then return false end
			if not card or card:getTypeId() == 0 then return false end
			if source:isNude() then return false end
		    local cardsnum = source:getHandcards():length()
			local cardEnum = source:getEquips():length()
			local n = 0
			
			for _,c in sgs.list(source:getHandcards()) do
                if c:getTypeId() == card:getTypeId() then 
				    break
                else
				    n = n + 1
			    end
            end
			if n >= cardsnum and (not card:isKindOf("EquipCard") or cardEnum == 0) then
			    return false
			end
			if card:isKindOf("BasicCard") then ctype = "BasicCard" end
			if card:isKindOf("TrickCard") then ctype = "TrickCard" end
			if card:isKindOf("EquipCard") then ctype = "EquipCard" end

			local invoked = room:askForExchange(source, self:objectName(), 1,1, true, "@liketoask", true, ctype)
			if invoked then
				room:broadcastSkillInvoke("liketoask", 2)
			    local id = room:drawCard()
				local list = room:getAlivePlayers()
                local guys = sgs.SPlayerList()
					for _,t in sgs.qlist(list) do
						if not t:hasSkill(self:objectName()) then
							guys:append(t)
						end
					end
				if guys:length() == 0 then return false end
				local target = room:askForPlayerChosen(source, guys, "liketoask", "liketoask_choiceplayer")
				room:moveCardTo(invoked, target, sgs.Player_PlaceHand)
				if source:getPile("&learned"):length() < 6 then -- 額外牌組的限制，超過就選牌替換
					source:addToPile("&learned", id)
					return true
				else
						if (thepile:length() > 1) then
							room:fillAG(thepile, source)
							cid = room:askForAG(source, thepile, false, self:objectName())
							room:clearAG(source)
						else
							cid = thepile:first()
						end
						room:obtainCard(source, sgs.Sanguosha:getCard(cid), false)
						source:addToPile("&learned", id)

                end
			end
			
			elseif event == sgs.NullificationEffect then
			
			if source:hasFlag("inNullification") then
				source:setFlags("-inNullification")
				return true
			else
				return false
			end
			
		end
		return false
	end,
	can_trigger = function(self, target)
		return target and not target:hasSkill(self:objectName())
	end
	-- priority = 1,
}

liketoask2 = sgs.CreateTriggerSkill{
	name = "#liketoask2" ,
	events = {sgs.Damaged} ,
	frequency = sgs.Skill_Compulsory ,
	on_trigger = function(self, event, player, data) -- player即是傷者
		local damage = data:toDamage()
	    local room = player:getRoom()
		local thepile = player:getPile("&learned")
		-- local pilenum = thepile:length()
		local n = damage.damage
		-- if damage.damage <= 1 then
		room:broadcastSkillInvoke("liketoask", 1)
		for i = 1,n,1 do
			local id = room:drawCard()
			if not player:isAlive() then break end
			-- local card_id = Maggots_list:first()
			-- local card = sgs.Sanguosha:getCard(card_id)
			
			-- room:moveCardTo(card, MaggotMom, sgs.Player_PlaceHand)
			
			if thepile:length() < 6 then -- 額外牌組的限制，超過就選牌替換
				player:addToPile("&learned", id)
				thepile = player:getPile("&learned") -- 面對2點以上傷害，必須要更新牌組，否則數值會錯
			else
				local cid = -1
				if (thepile:length() > 1) then
					room:fillAG(thepile, player)
					cid = room:askForAG(player, thepile, false, self:objectName())
					room:clearAG(player)
				else
					cid = thepile:first()
				end
				thepile:removeOne(cid)
				-- room:moveCardTo(sgs.Sanguosha:getCard(cid), player, sgs.Player_PlaceHand)
				room:obtainCard(player, sgs.Sanguosha:getCard(cid), false)
				player:addToPile("&learned", id)
				thepile = player:getPile("&learned")
				-- pilenum = 6
			end
		end
		-- end
			
	end,
	can_trigger = function(self, target)
		return target and target:hasSkill(self:objectName())
	end
}
--舊離塵
awayfromthemundane = sgs.CreateProhibitSkill{
	name = "awayfromthemundane",
	is_prohibited = function(self, from, to, card)
		if to:getPile("&learned"):length() < 4 then
			return to:hasSkill(self:objectName()) and (card:isKindOf("Snatch") or card:isKindOf("Duel") or card:isKindOf("Dismantlement"))
		else
			return false
		end
	end
}
]]
--備份技能1：阶段技，出牌阶段，你可以把一张牌当作本阶段上一张打出的牌使用（装备牌及【无懈可击】除外）
--[[
ynongquanskill = sgs.CreateViewAsSkill{
	name = "ynongquan",
	n = 1,
	view_filter = function(self, selected, to_select)
		return true
	end,
	expand_pile = "wooden_ox",
	view_as = function(self,cards)
		if #cards == 0 then return nil end
		local card_id = sgs.Self:getMark("ynongquan")
		local card = sgs.Sanguosha:getCard(card_id)
		local acard = cards[1]
		local new_card = sgs.Sanguosha:cloneCard(card:objectName(), acard:getSuit(), acard:getNumber())
		new_card:addSubcard(cards[1])
		new_card:setSkillName(self:objectName())
		return new_card
	end,
	enabled_at_play = function()
		return sgs.Self:hasFlag("ynongquan")
	end,
}

ynongquan = sgs.CreateTriggerSkill{
	name = "ynongquan",
	view_as_skill = ynongquanskill,
	events = {sgs.CardUsed, sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local card = data:toCardUse().card
		if (player:getPhase() ~= sgs.Player_Play) then return false end
		if event == sgs.CardUsed and not player:hasFlag("ynongquanused") then
			if card:isKindOf("EquipCard") or card:isKindOf("Nullification") or card:isKindOf("Lightning") then
				return false
			end
			if card:isKindOf("Peach") or card:isKindOf("Analeptic") or card:isKindOf("Slash") 
			  or card:isNDTrick() or card:isKindOf("DelayedTrick") then
				if card:isKindOf("Slash") and not (player:hasWeapon("crossbow") or player:hasSkill("paoxiao")) then
					room:setPlayerFlag(player, "-ynongquan")
					return false
				end

			if card:isKindOf("Slash") then
				if player:hasWeapon("Crossbow") or player:hasSkill("paoxiao") then
					room:setPlayerFlag(player, "ynongquan")
					local card_id = card:getEffectiveId()
					room:setPlayerMark(player, "ynongquan", card_id)
				else
					room:setPlayerFlag(player, "-ynongquan")
					return false
				end
			end
			room:setPlayerFlag(player, "ynongquan")
			local card_id = card:getEffectiveId()
			room:setPlayerMark(player, "ynongquan", card_id)
			if card:getSkillName() == "ynongquan" then
				room:broadcastSkillInvoke("ynongquan")
				room:setPlayerFlag(player, "ynongquanused")
				room:setPlayerFlag(player, "-ynongquan")
			end
		else
			room:setPlayerFlag(player, "-ynongquan")
		end
	end
end,
}

--備份_茜色：明日架與優持有【茜色】：<font color=\"#E88114\"><b>天生技</font></b>。妳不會失去技能。當妳獲得技能時，可以放棄獲得，視為使用一張<font color=\"#FF4500\"><b>無中生有</b></font>。

kaeriuchi = sgs.CreateTriggerSkill{
	name = "#kaeriuchi",
	events = {sgs.EventAcquireSkill, sgs.EventLoseSkill},
	priority = -998,
	on_trigger = function(self,event,player,data,room)
		if player:getGeneralName() ~= "asukatoyuu" then return false end
		local skillget = data:toString()
		if event == sgs.EventAcquireSkill then
			if player:hasSkill(self:objectName()) then
				if skillget == "#kaeriuchi" or skillget == "wisdom_s" or skillget == "chikuwasama" then return false end
				if player:hasFlag("kaeriuchiAcq:"..skillget) then
					player:setFlags("-kaeriuchiAcq:"..skillget)
					return false
				end
				if room:askForSkillInvoke(player, "@kaeriuchi", sgs.QVariant("kaeriuchi:"..skillget)) or player:getState() == "robot" then --懶得做AI
					player:setFlags("kaeriuchiLose:"..skillget)
					room:detachSkillFromPlayer(player,skillget)
					local c = sgs.Sanguosha:cloneCard("ex_nihilo", sgs.Card_NoSuit, 0)
					c:setSkillName(self:objectName())
					room:useCard(sgs.CardUseStruct(c, player, player), false)
					-- player:drawCards(2)
				end
			end
		else
			if player:hasFlag("kaeriuchiLose:"..skillget) then
				player:setFlags("-kaeriuchiLose:"..skillget)
			else
				player:setFlags("kaeriuchiAcq:"..skillget)
				room:acquireSkill(player,skillget)
			end
		end
		return false
	end,
}

-- FROM 仙包：每当你成为其他角色使用的普通锦囊牌的目标时，你可以令此牌当作【杀】结算且不计入次数，当此【杀】被你抵消时，你摸两张牌。
kejiexianaoce = sgs.CreateTriggerSkill{
	name = "kejiexianaoce",
	frequency = sgs.Skill_NotFrequent, 
	events = {sgs.TargetConfirming,sgs.SlashMissed},
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
		if event == sgs.TargetConfirming and (player:hasSkill(self:objectName())) then
			local use = data:toCardUse()
			local room = player:getRoom()
			if event == sgs.TargetConfirming and use.to:contains(player) then
				if (use.card:isNDTrick()) and (use.from ~= player) then 
					if player:askForSkillInvoke("kejiexianaoce-use", data) then
						room:broadcastSkillInvoke(self:objectName())
						local slash = sgs.Sanguosha:cloneCard("slash", use.card:getSuit(), use.card:getNumber())
						use.card = slash
						room:setCardFlag(use.card, self:objectName())
						data:setValue(use)
						slash:deleteLater()  
					end
				end
			end
			return false
		end
		if event == sgs.SlashMissed then
			local effect = data:toSlashEffect()
			if effect.slash:hasFlag("kejiexianaoce") and effect.to:hasSkill(self:objectName()) then
				effect.to:drawCards(2)
			end
		end
	end,
	can_trigger = function(self, target)
		return target
	end,
}
--FROM 鬼包 限定技，当你进入濒死状态时，你可以获得7枚“灯”，若如此做，你始终终止你的濒死结算并存活，每当你受到伤害后或每轮开始时，你弃置1枚“灯”，当你失去所有“灯”后，你死亡。
kejieguiqideng = sgs.CreateTriggerSkill{
	name = "kejieguiqideng",
	events = {sgs.EnterDying},
	frequency = sgs.Skill_Limited,
	limit_mark = "@kejieguiqideng",
	on_trigger = function(self, event, player, data, room)
		if (player:getMark("@kejieguiqideng") == 0) and (player:getMark("@kedeng") > 0) then
			room:setPlayerFlag(player,"-Global_Dying")
			return true
		end
		if (player:getMark("@kejieguiqideng") > 0) and (room:askForSkillInvoke(player, self:objectName(), data)) then
			room:broadcastSkillInvoke(self:objectName(),math.random(1,2))
			room:doSuperLightbox("kejieguizhugeliangtwo", "kejieguiqideng")
			player:gainMark("@kedeng",7)
			room:removePlayerMark(player,"@kejieguiqideng")
			room:setPlayerFlag(player,"-Global_Dying")
			return true
		end
	end,
}

kejieguiqidengex = sgs.CreateTriggerSkill{
	name = "kejieguiqidengex",
	global = true,
	events = {sgs.RoundStart,sgs.Damaged,sgs.MarkChanged},
	frequency = sgs.Skill_Compulsory,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.RoundStart) or (event == sgs.Damaged) then
			if player:getMark("@kedeng") > 0 then
				room:broadcastSkillInvoke("kejieguiqideng",3)
				player:loseMark("@kedeng")
			end
		end
		if (event == sgs.MarkChanged) then --居然有這條件
			local mark = data:toMark()
			if mark.name == "@kedeng" then
				if mark.count == 0 then
					room:broadcastSkillInvoke("kejieguijingmu",2)
					room:killPlayer(player)
				end
			end
		end
	end,
}
if not sgs.Sanguosha:getSkill("kejieguiqidengex") then skills:append(kejieguiqidengex) end

--当你受到【酒】【杀】或因“连环状态”传导的伤害时，你可以弃置一张手牌并重置武将牌，若如此做，视为你脱离了因此伤害进入的濒死状态，然后此伤害-1。
kejieyaotongquetwo = sgs.CreateTriggerSkill{
	name = "kejieyaotongquetwo" ,
	events = {sgs.DamageInflicted} ,
	frequency = sgs.Skill_NotFrequency,
	on_trigger = function(self, event, player, data)
		local damage = data:toDamage()
		local room = player:getRoom()
		if (damage.card and damage.card:isKindOf("Slash") and damage.card:hasFlag("drank"))
		or (damage.chain) then
			if not player:isKongcheng() and room:askForSkillInvoke(player,self:objectName(), data) then
				local discard = room:askForDiscard(player, self:objectName(), 1, 1, true,false, "kejieyaotongquetwo-dis") 
				if discard then
					room:broadcastSkillInvoke("kejieyaoquwutwo")
					room:setPlayerProperty(player, "chained", sgs.QVariant(false))
					local death = sgs.DeathStruct()
					death.who = player
					death.damage = damage
					local _data = sgs.QVariant()
					 _data:setValue(death)
					room:getThread():delay(500)
					room:getThread():trigger(sgs.QuitDying, room, player, _data)
					local hurt = damage.damage
					if hurt == 1 then
						return true
					end
					if hurt >1 then
					    damage.damage = hurt -1
					    data:setValue(damage)
					end
				end
			end
		end
	end
}
]]
--支援系統


assistxcard = sgs.CreateSkillCard{
	name = "assistx",
	target_fixed = true,
	will_throw = false,
	handling_method = sgs.Card_MethodNone,
	about_to_use = function(self, room, use)
		local source = use.from
		-- local zb = source:property("assist"):toString()
		-- if zb == "" then
			-- zb = self:getUserString()
		-- end
		-- if zb ~= "" then
			local skill_list = {"itmine", "godbow", "fakebody", "wisdom_s", "purgatoryfire", "sincere", "optimistic", "bh", "bh_x", "changehand", "anotherhand", "getSuperLimitBreak"} --支援技能表
			local choice = room:askForChoice(source, "assistx", table.concat(skill_list, "+"))
			if choice == "changehand" or choice == "anotherhand" then
				local yurikindomheros = {}
				local yurikindomhero = {}
				for _,name in ipairs(sgs.Sanguosha:getLimitedGeneralNames()) do
					if sgs.Sanguosha:getGeneral(name):getPackage() == "yuri" then
						table.insert(yurikindomheros, name)
					end
				end
				for _,p in sgs.qlist(room:getAllPlayers(true)) do
					if table.contains(yurikindomheros, p:getGeneralName()) then
						table.removeOne(yurikindomheros, p:getGeneralName())
					end
				end
				for i = 1, 6 do
					local first = yurikindomheros[math.random(1, #yurikindomheros)]
					table.insert(yurikindomhero, first)
					table.removeOne(yurikindomheros, first)
				end
				local general = room:askForGeneral(source, table.concat(yurikindomhero, "+"))
				if general == "jiyori" then
					room:broadcastSkillInvoke("gdsvoice", 6)
				end
				if choice == "anotherhand" then
					room:changeHero(source, general, false, false, true, false)
				else
					room:changeHero(source, general, false, false)
					if source:isWounded() then
						local theRecover = sgs.RecoverStruct()
						theRecover.recover = source:getLostHp()
						theRecover.who = source
						room:recover(source, theRecover)	
					end
				end
			elseif choice == "getSuperLimitBreak" then
				local tar = room:askForPlayerChosen(source, room:getAlivePlayers(), self:objectName())
				if tar then
					tar:gainMark("@SuperLimitBreak")
					if tar:hasSkill("tobenature") and not tar:hasSkill("tobenatureuma") then
						room:acquireSkill(tar, "tobenatureuma")
					end
					if tar:hasSkill("zhixi") and not tar:hasSkill("y_sousetsu") then
						if tar:getMaxHp() > 3 then room:loseMaxHp(tar, 1) end
						room:acquireSkill(tar, "y_sousetsu")
					end
				end
				
			else
				if choice and not source:hasSkill(choice) then
					source:loseMark("@imperialjadeseal")
					room:acquireSkill(source, choice)
					if choice == "optimistic" then
						room:broadcastSkillInvoke("gdsvoice", 6)
					end
				end
			end
			-- end
		-- end
	end
}

assistx = sgs.CreateZeroCardViewAsSkill{
	name = "assistx&",
	view_as = function(self)
		local acard = assistxcard:clone()
		return acard
    end,
	enabled_at_play = function(self, player)
		return player:getMark("@imperialjadeseal") > 0
	end
}
assistcore = sgs.CreateTriggerSkill{
	name = "assistcore",
	events = {sgs.AfterDrawInitialCards, sgs.EventPhaseStart},
	global = false,--add
	priority = 100,
	can_trigger = function(self, player)
	    return true
	end,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if player:getMark("MeowPass") == 1  then return false end
		if player:getState() == "robot" then return false end
		if event == sgs.AfterDrawInitialCards then
			if player:getState() ~= "robot" then
				if player:getMark("@imperialjadeseal") == 0 then player:gainMark("@imperialjadeseal") end
				if player:getMark("@imperialjadeseal") > 0 then
					room:attachSkillToPlayer(player, "assistx")
					room:setPlayerMark(player, "MeowPass", 1)
				end
			end
		elseif event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Start and player:getMark("@imperialjadeseal") < 1 then
			player:gainMark("@imperialjadeseal")
			room:attachSkillToPlayer(player, "assistx")
			room:setPlayerMark(player, "MeowPass", 1)
		end

		return false
	end
}


local sgskills = sgs.SkillList()
if not sgs.Sanguosha:getSkill("clearthemeridians_fc") then 
	sgskills:append(clearthemeridians_fc)
end
if not sgs.Sanguosha:getSkill("#bs_ohb") then 
	sgskills:append(bs_ohb)
end
if not sgs.Sanguosha:getSkill("#sa_snatch") then 
	sgskills:append(sa_snatch)
end
if not sgs.Sanguosha:getSkill("#maxCardSkill") then 
	sgskills:append(maxCardSkill) 
end
if not sgs.Sanguosha:getSkill("gdsvoice") then sgskills:append(gdsvoice) end
if not sgs.Sanguosha:getSkill("godbow") then sgskills:append(godbow) end
if not sgs.Sanguosha:getSkill("bloodfight") then sgskills:append(bloodfight) end
if not sgs.Sanguosha:getSkill("#optimisticps") then sgskills:append(optimisticps) end
-- if not sgs.Sanguosha:getSkill("#equippro_dh") then sgskills:append(equippro_dh) end
if not sgs.Sanguosha:getSkill("slashtimesskill") then sgskills:append(slashtimesskill) end
if not sgs.Sanguosha:getSkill("#distancechange") then sgskills:append(distancechange) end
if not sgs.Sanguosha:getSkill("japenknifeslashe") then sgskills:append(japenknifeslashe) end
if not sgs.Sanguosha:getSkill("angel") then sgskills:append(angel) end
if not sgs.Sanguosha:getSkill("moveliketrigger") then sgskills:append(moveliketrigger) end
if not sgs.Sanguosha:getSkill("dressing") then sgskills:append(dressing) end
if not sgs.Sanguosha:getSkill("toleranceIsAVirtue") then sgskills:append(toleranceIsAVirtue) end
if not sgs.Sanguosha:getSkill("hidethepath") then sgskills:append(hidethepath) end
if not sgs.Sanguosha:getSkill("nfever") then sgskills:append(nfever) end
-- if not sgs.Sanguosha:getSkill("dmganima") then sgskills:append(dmganima) end
if not sgs.Sanguosha:getSkill("newmember") then sgskills:append(newmember) end
if not sgs.Sanguosha:getSkill("songforatsu") then sgskills:append(songforatsu) end
-- if not sgs.Sanguosha:getSkill("#songforatsucost") then sgskills:append(songforatsucost) end
-- extension:insertRelatedSkills("songforatsu", "#songforatsucost")
if not sgs.Sanguosha:getSkill("assistx") then sgskills:append(assistx) end
if not sgs.Sanguosha:getSkill("assistcore") then sgskills:append(assistcore) end
if not sgs.Sanguosha:getSkill("purgatoryfire") then sgskills:append(purgatoryfire) end
if not sgs.Sanguosha:getSkill("#saoshep") then sgskills:append(saoshep) end
if not sgs.Sanguosha:getSkill("yuriganglie") then sgskills:append(yuriganglie) end
if not sgs.Sanguosha:getSkill("braveheart") then sgskills:append(braveheart) end
if not sgs.Sanguosha:getSkill("fightingclimax") then sgskills:append(fightingclimax) end
if not sgs.Sanguosha:getSkill("#LSEClear") then sgskills:append(LSEClear) end
extension:insertRelatedSkills("fightingclimax", "#LSEClear")
if not sgs.Sanguosha:getSkill("LuaJTieji") then sgskills:append(LuaJTieji) end
if not sgs.Sanguosha:getSkill("#LuaJTiejiClear") then sgskills:append(LuaJTiejiClear) end
extension:insertRelatedSkills("LuaJTieji", "#LuaJTiejiClear")
if not sgs.Sanguosha:getSkill("itmine") then sgskills:append(itmine) end
if not sgs.Sanguosha:getSkill("ys_jueyan_effect") then sgskills:append(ys_jueyan_effect) end
-- if not sgs.Sanguosha:getSkill("ys_xionchi") then sgskills:append(ys_xionchi) end
-- if not sgs.Sanguosha:getSkill("ys_xionchijink") then sgskills:append(ys_xionchijink) end
if not sgs.Sanguosha:getSkill("bh_x") then sgskills:append(bh_x) end
if not sgs.Sanguosha:getSkill("sincere") then sgskills:append(sincere) end
if not sgs.Sanguosha:getSkill("bh") then sgskills:append(bh) end
if not sgs.Sanguosha:getSkill("yuri_jianchu") then sgskills:append(yuri_jianchu) end
if not sgs.Sanguosha:getSkill("iris") then sgskills:append(iris) end
if not sgs.Sanguosha:getSkill("tobenatureuma") then sgskills:append(tobenatureuma) end
if not sgs.Sanguosha:getSkill("y_sousetsu") then sgskills:append(y_sousetsu) end
if not sgs.Sanguosha:getSkill("Subetewonomikonmu") then sgskills:append(Subetewonomikonmu) end
if not sgs.Sanguosha:getSkill("Kuitsukusu") then sgskills:append(Kuitsukusu) end
if not sgs.Sanguosha:getSkill("yuri_hagaku") then sgskills:append(yuri_hagaku) end
if not sgs.Sanguosha:getSkill("yuri_hengjiang") then sgskills:append(yuri_hengjiang) end
if not sgs.Sanguosha:getSkill("#yuri_hengjiang_draw") then sgskills:append(yuri_hengjiang_draw) end
if not sgs.Sanguosha:getSkill("fakebody") then sgskills:append(fakebody) end
if not sgs.Sanguosha:getSkill("gomaoku") then sgskills:append(gomaoku) end
extension:insertRelatedSkills("yuri_hengjiang", "#yuri_hengjiang_draw")
-- if not sgs.Sanguosha:getSkill("#harvest_counter") then sgskills:append(harvest_counter) end
sgs.Sanguosha:addSkills(sgskills)

wangzouen:addSkill(PoisonMaggots)
-- wangzouen:addSkill(ParasiticMaggots)
wangzouen:addSkill(MaggotsShield)
wangzouen:addSkill(maggotsavethelord)
wangzouen:addSkill(maggotschagelife)
-- wangzouen:addSkill(mclthrowcardpart)

JSPwonyi:addSkill(LuaZhenlie)
JSPwonyi:addSkill(LuaZhenlie_buff)
extension:insertRelatedSkills("LuaZhenlie", "#LuaZhenlie_buff")
JSPwonyi:addSkill(LuaRevenge)
JSPwonyi:addSkill(LuaRevengeforcard)
extension:insertRelatedSkills("LuaRevenge", "#LuaRevengeforcard")
-- JSPwonyi:addSkill(LuaDoNotEatMOMO)
-- JSPwonyi:addSkill(LuaDoNotEatMOMO2)
-- JSPwonyi:addSkill(independent)
-- JSPwonyi:addSkill(independent2)

-- amayadorimachi:addSkill(liketoask)
-- amayadorimachi:addSkill(liketoask2)
-- extension:insertRelatedSkills("liketoask", "#liketoask2")
-- amayadorimachi:addSkill(goddess)
-- amayadorimachi:addSkill(gdnoretrial)
-- extension:insertRelatedSkills("goddess", "#gdnoretrial")
-- amayadorimachi:addSkill(awayfromthemundane) 
amayadorimachi:addSkill(miyadokyo)
amayadorimachi:addSkill(goddess_new)

sugawakaki:addSkill(magictrick)
sugawakaki:addSkill(Sizhanfort)
sugawakaki:addSkill(S2izhanfort)
extension:insertRelatedSkills("magictrick", "#Sizhanfort")
extension:insertRelatedSkills("magictrick", "#S2izhanfort")

-- shampoo:addSkill(breakingSeal)
-- shampoo:addSkill(bsClear)
-- shampoo:addSkill(equippro_dh) 
-- shampoo:addSkill(bs_wab) 
-- shampoo:addSkill(bs_ohjon)  
-- shampoo:addSkill(bs_treasure)

shampoo:addSkill(clearthemeridians)
shampoo:addSkill(ctrClear)
shampoo:addSkill(semeruki)
extension:insertRelatedSkills("clearthemeridians", "#ctrClear")

ranma:addSkill(changesexual)
ranma:addSkill(changesexualforai)
extension:insertRelatedSkills("changesexual", "#changesexualforai")
ranma:addSkill(sexualadvantage)
ranma:addSkill(SAeffect)
ranma:addSkill(SAEClear)
extension:insertRelatedSkills("sexualadvantage", "#SAeffect")
extension:insertRelatedSkills("sexualadvantage", "#SAEClear")


akane:addSkill(goodatwep) 
akane:addSkill(goodatwepClear) 
extension:insertRelatedSkills("goodatwep", "#goodatwepClear")
akane:addSkill(helptheweak)

rapunzel:addSkill(gdancer)
rapunzel:addSkill(goldentear)

lenuje:addSkill(healingwater) 
lenuje:addSkill(waterfairy) 
lenuje:addSkill(waterfairymc)
extension:insertRelatedSkills("waterfairy", "#waterfairymc")

pyluluco:addSkill(peeking)
pyluluco:addSkill(countertrick) 

tama:addSkill(warlike)
tama:addSkill(warlikeClear) 
tama:addSkill(arkora) 
tama:addRelateSkill("bloodfight") 

-- jiyori:addSkill(crushingimpact)
jiyori:addSkill(kurashinfurashu)
jiyori:addSkill(optimistic)
jiyori:addSkill(optimisticinvisible)
extension:insertRelatedSkills("optimistic", "#optimisticinvisible")

thethief:addSkill(trapva)
thethief:addSkill(trap)
extension:insertRelatedSkills("trapva", "#trap")
thethief:addSkill(taichi)
thethief:addSkill(taichirebirth)
extension:insertRelatedSkills("taichi", "#taichirebirth")

takayamaharuka:addSkill(genshunoYURI) 
takayamaharuka:addSkill(yuriKansen)
takayamaharuka:addSkill(yuriKansenEffect)
extension:insertRelatedSkills("yuriKansen", "#yuriKansenEffect")

chiya:addSkill(frankly)
chiya:addSkill(flexible)

nono:addSkill(machiko) 
nono:addSkill(independent) 

kon:addSkill(clever) 
kon:addSkill(foxnature) 
kon:addSkill(foxnatureobtain) 
extension:insertRelatedSkills("foxnature", "#foxnatureobtain")

koumae:addSkill(lovesweet)
koumae:addSkill(magicat) 
koumae:addRelateSkill("Subetewonomikonmu")
koumae:addRelateSkill("Kuitsukusu")

jsunru:addSkill(reedship) 

jzhaoxiang:addSkill(phantom) 
jzhaoxiang:addSkill(inheritedthefather) 
jzhaoxiang:addSkill(ihtf_effect) 
extension:insertRelatedSkills("inheritedthefather", "#ihtf_effect")

jcaojie:addSkill(zhixi)
-- jcaojie:addSkill(y_sousetsu)

yukiyuna:addSkill(yusha)
yukiyuna:addSkill(tomowodaji)

ronomiyokaruta:addSkill(skeleton)
ronomiyokaruta:addSkill(strangeguy)

shirokenrirchiyo:addSkill(japenknifejile)
shirokenrirchiyo:addSkill(japenknifejileClear)
-- shirokenrirchiyo:addSkill(japenknifepro)
shirokenrirchiyo:addSkill(japenknifeslashe2)
shirokenrirchiyo:addRelateSkill("japenknifeslashe")
extension:insertRelatedSkills("japenknifejile", "#japenknifejileClear")
-- extension:insertRelatedSkills("japenknifejile", "#japenknifepro")
extension:insertRelatedSkills("japenknifejile", "#japenknifeslashe2")

shitsino:addSkill(deepforest)
shitsino:addSkill(deepforestClear)
extension:insertRelatedSkills("deepforest", "#deepforestClear")
shitsino:addSkill(tobenature)

saki:addSkill(heapridge)
saki:addSkill(zerodifference)

hatarugimanri:addSkill(lovesong)
hatarugimanri:addSkill(loyalm)

koromo:addSkill(scoopthemoonup)
koromo:addSkill(deterrence)

agari:addSkill(wannawin) 
agari:addSkill(theace)

-- jyuji:addSkill("guhuo")
jyuji:addSkill(keishoukaki)
jyuji:addSkill(keishoukakiEffect)
extension:insertRelatedSkills("keishoukaki", "#keishoukakiEffect")

koyori:addSkill(hotfight)
koyori:addSkill(hotfightlm)
extension:insertRelatedSkills("hotfight", "#hotfightlm")

chikaryu:addSkill(acting)
chikaryu:addSkill(liketoplay)

tamao:addSkill(proficient)
tamao:addSkill(wisdom_ie)
extension:insertRelatedSkills("proficient", "#wisdom_ie")
tamao:addSkill(endingchoice)
tamao:addRelateSkill("cheerful")
tamao:addRelateSkill("iris")

miyako:addSkill(shywithpeople)
miyako:addSkill(sweetsis)

-- bianhuanghou:addSkill(new_wanwei)

treefairy:addSkill(bffeedingpoisoning)
treefairy:addSkill(turned)

konbuandrebuild:addSkill(lovetoevo)
konbuandrebuild:addSkill(graduation)

maiza:addSkill(cardcollecter)
maiza:addSkill(introvert)
maiza:addSkill(introvertClear)
extension:insertRelatedSkills("introvert", "#introvertClear")

yurikuma:addSkill(fightingexper)
-- yurikuma:addSkill(yuri_hagaku)

yuuri:addSkill(eatforlike)
yuuri:addSkill(sportsw)
yuuri:addRelateSkill("LuaJTieji")
yuuri:addRelateSkill("yuri_jianchu")
yuuri:addSkill(yuriforever)

chito:addSkill(new_againstdis)
chito:addSkill(witty)
chito:addSkill(helmet)

anias:addSkill(thedolls)
anias:addSkill(cheerful)

yuri_guanyinping:addSkill(yuri_xueji)
yuri_guanyinping:addSkill(yuri_huxiao)
yuri_guanyinping:addSkill(yuri_wuji)

ys_lukang:addSkill(ys_jueyan)
ys_lukang:addSkill(ys_qianjie)
ys_lukang:addSkill(ys_huairou)

-- ys_zhangxiu:addSkill(ys_xiongluan)
-- ys_zhangxiu:addSkill(ys_congjian)

sofy:addSkill(likebooks)
sofy:addSkill(happinesstoeveryone)
sofy:addSkill(bloody)

elly:addSkill(blooddry)
elly:addSkill(BDeffect)
elly:addSkill(BDEClear)
extension:insertRelatedSkills("blooddry", "#BDeffect")
extension:insertRelatedSkills("blooddry", "#BDEClear")
elly:addSkill(suckblood)
elly:addSkill("bloody")

yuri_zhoufei:addSkill(yuri_liangyin)
yuri_zhoufei:addSkill(yuri_kongsheng)
yuri_zhoufei:addSkill(yuri_kongsheng_mark)
extension:insertRelatedSkills("yuri_kongsheng", "#yuri_kongsheng_mark")

bloodymarry:addSkill(harvest)
bloodymarry:addSkill(whosfromhell)
bloodymarry:addSkill(harvest_counter)
-- bloodymarry:addSkill(harvest_ud)
bloodymarry:addSkill(protectdestroy)

yuri_jsunshangxiang:addSkill(married)
yuri_jsunshangxiang:addSkill("xiaoji")

nulltopeta:addSkill(withwings)
nulltopeta:addSkill(flyaway)
nulltopeta:addSkill(flyaway_effect)
extension:insertRelatedSkills("flyaway", "#flyaway_effect")

gasaitoyuki:addSkill(meleemaster)
gasaitoyuki:addSkill(meleemaster_s)
gasaitoyuki:addSkill(thefuture)
extension:insertRelatedSkills("meleemaster", "#meleemaster_s")

tsuuitotina:addSkill(tacitunderstanding)
tsuuitotina:addSkill(weareidle)
tsuuitotina:addSkill(solidarity)

tsujimikadokuon:addSkill(migonoinori)
tsujimikadokuon:addSkill(listentonature)

rinnene:addSkill(imwatching)
rinnene:addSkill(imwatchingEx)
extension:insertRelatedSkills("imwatching", "#imwatchingEx")

huukatoinori:addSkill(bougairensha)
huukatoinori:addSkill(sizukana)
huukatoinori:addSkill(sizukana_global)
extension:insertRelatedSkills("sizukana", "#sizukana_global")

lio:addSkill(moekogoro)
lio:addSkill(hononozouki)
lio:addSkill(hononochikara)

asukatoyuu:addSkill(wisdom_s)
asukatoyuu:addSkill(chikuwasama)
-- asukatoyuu:addSkill(kaeriuchi)

eratosoniya:addSkill(yochi)
eratosoniya:addSkill(yomi)
eratosoniya:addSkill(kanchi)
eratosoniya:addSkill(kanchi_clear)
extension:insertRelatedSkills("kanchi", "#kanchi_clear")

yuri_caocao:addSkill(yuri_guixin)
yuri_caocao:addSkill("feiying")

kamiyamasakuya:addSkill(okanemochi)
kamiyamasakuya:addSkill(barakurosaku)

hashirinio:addSkill(kanshi)
hashirinio:addSkill(kanshi_e)
extension:insertRelatedSkills("kanshi", "#kanshi_e")
hashirinio:addSkill(genjutsu)

mizushimakiyoi:addSkill(tsuyoiishiki)
mizushimakiyoi:addSkill(unlock)
mizushimakiyoi:addRelateSkill("peeking")
mizushimakiyoi:addRelateSkill("countertrick")


yuri_yitandianwei:addSkill("shenli")
yuri_yitandianwei:addSkill(yuri_sizhan)
yuri_yitandianwei:addSkill(yuri_sizhan_d)
extension:insertRelatedSkills("yuri_sizhan", "#yuri_sizhan_d")

sadoharamai:addSkill(zurunoonkaeshi)
sadoharamai:addSkill(buuzetsu)

matsuobasho:addSkill(haigu)

miyoshikarin:addSkill(kirisou)
miyoshikarin:addSkill(gopugu)
miyoshikarin:addSkill(kirisou_umaretuski)

mirokuyumiko:addSkill(restrained)
mirokuyumiko:addSkill(ienoimei)

ainisutoyufi:addSkill(hunnshin)
ainisutoyufi:addSkill(tennsainohojyou)
ainisutoyufi:addSkill(jiyuunokuni)

yurinosakibasu:addSkill(yuryounowaku)

murosakimiyo:addSkill(yurimibirth)
murosakimiyo:addSkill(yurimi)
murosakimiyo:addRelateSkill("yuri_hengjiang")

yuri_ruyi:addSkill(taigyokunoyousei)
yuri_ruyi:addRelateSkill("gomaoku")

yuri_yitanjian:addSkill(hb_yitain)
yuri_yitanjian:addSkill(hb_konoyaiba_uketemiyo)

nikuou:addSkill(nikuhei)
-- nikuou:addSkill(nikuhei_p)
nikuou:addSkill(nikuhei_k)

-- testguy:addSkill(nikuhei)


return {extension, extension_h}