extension_e = sgs.Package("sfofl_e", sgs.Package_GeneralPack)
extension_s = sgs.Package("sfofl_s", sgs.Package_GeneralPack)
extension_gai = sgs.Package("sfofl_gai", sgs.Package_GeneralPack)
extension_war = sgs.Package("sfofl_war", sgs.Package_GeneralPack)
extension_card = sgs.Package("sfoflCard", sgs.Package_CardPack)
extension_young = sgs.Package("sfofl_young", sgs.Package_GeneralPack)
extension_youngcard = sgs.Package("sfofl_youngCard", sgs.Package_CardPack)
local hide_boss = false --隐藏Boss武将
local skills = sgs.SkillList()
--借用大佬的 但找不到出處了
function ChangeGeneral(room, player, skill_onwer_general_name)
	local generals = {}
	for _,name in ipairs(sgs.Sanguosha:getLimitedGeneralNames()) do
		if not sgs.Sanguosha:isGeneralHidden(name) and not table.contains(generals, name) then
			table.insert(generals, name)
		end
	end
	for _,p in sgs.qlist(room:getAlivePlayers()) do
		if table.contains(generals, p:getGeneralName()) then
			table.removeOne(generals, p:getGeneralName())
		end
		if table.contains(generals, p:getGeneral2Name()) then
			table.removeOne(generals, p:getGeneral2Name())
		end
	end
	local x = player:getMaxHp()
	local y = player:getHp()
	room:changeHero(player, generals[math.random(1, #generals)], false, false, player:getGeneral2Name() and player:getGeneral2Name() == skill_onwer_general_name)
	room:setPlayerProperty(player, "maxhp", sgs.QVariant(x))
	room:setPlayerProperty(player, "hp", sgs.QVariant(y))
end

do
	require "lua.config"
	local config = config
	local kingdoms = config.kingdoms
	table.insert(kingdoms, "west")
end
sgs.LoadTranslationTable {
	["west"] = "西",
}



Table2IntList = function(theTable)
	local result = sgs.IntList()
	for i = 1, #theTable, 1 do
		result:append(theTable[i])
	end
	return result
end
sgs.LoadTranslationTable {
    ["sfofl_e"] = "线下官盗E系列",
    ["sfofl_s"] = "线下官盗S系列",
    ["sfofl_gai"] = "线下官盗线下化",
    ["sfofl_war"] = "线下官盗战役篇",
    ["sfoflCard"] = "线下官盗",
    ["sfofl_young"] = "畅玩青春版",
    ["sfofl_youngCard"] = "畅玩青春版",
}

-- common prompt
sgs.LoadTranslationTable {
    ["#skill_add_damage"] = "%from的技能【<font color=\"yellow\"><b> %arg </b></font>】被触发，%from对%to造成的伤害增加至%arg2点。", -- add
    ["#skill_add_damage_byother1"] = "%from的技能【<font color=\"yellow\"><b> %arg </b></font>】被触发，", -- add
    ["#skill_add_damage_byother2"] = "%from 对%to造成的伤害增加至%arg点。", -- add
    ["#skill_cant_jink"] = "%from的技能【<font color=\"yellow\"><b> %arg </b></font>】被触发，%to 不能使用【闪】响应 %from 对 %to 使用的【杀】。", -- add
    ["#BecomeTargetBySkill"] = "%from的技能【<font color=\"yellow\"><b> %arg </b></font>】被触发，%to 成为了 %card 的目标", -- add
    ["#ArmorNullifyDamage"] = "%from 的防具【%arg】效果被触发，抵消 %arg2 点伤害", -- add
    ["#SkillNullifyDamage"] = "%from 的技能【%arg】效果被触发，抵消 %arg2 点伤害", -- add
    ["#ChooseSkill"] = "%from 的技能 %arg 选择了 %arg2",
    ["$NoRespond"] = "%from 的“%arg”被触发， %to 不能响应 %from 使用的【%card】",
    ["$NoRespond_All"] = "%from 的“%arg”效果被触发，%card 不能被响应",
}

--S系列
sgs.LoadTranslationTable {

    ["sfofl_guanyu"] = "关羽[官盗]",
    ["&sfofl_guanyu"] = "关羽",
    ["#sfofl_guanyu"] = "神武绝伦",
    ["~sfofl_guanyu"] = "",
    ["illustrator:sfofl_guanyu"] = "木美人",
    ["information:sfofl_guanyu"] = "S2065 三国杀武将传之关羽",

    ["sfofl_zhonghun"] = "忠魂",
    [":sfofl_zhonghun"] = "每当你使用或打出一张红色牌时，你可以亮出牌堆顶的一张牌，若此牌为红色，你获得之。",

    --S2065 三国杀武将传之关羽

    ["sfofl_longyufei"] = "龙羽飞[官盗]",
    ["&sfofl_longyufei"] = "龙羽飞",
    ["#sfofl_longyufei"] = "将星之魂",
    ["~sfofl_longyufei"] = "",
    ["illustrator:sfofl_longyufei"] = "",
    ["information:sfofl_longyufei"] = "S1044  三国杀标准版龙魂",

    ["sfofl_longyi"] = "龙裔",
    [":sfofl_longyi"] = "你可以将所有手牌当任意一张基本牌使用或打出。若其中有锦囊牌，你摸一张牌；若其中有装备牌，此牌不可被响应。",
    ["$longyi_norespond"] = "%from 使用的 %arg 因 <font color='yellow'><b>“龙裔”</b></font> 的效果不可被响应。",
    ["sfofl_longyi_slash"] = "龙裔【杀】",
    ["sfofl_zhenjue"] = "阵绝",
    [":sfofl_zhenjue"] = "当前回合角色的结束阶段，若你没有手牌，你可以令其选择一项：1.弃置一张牌；2.你摸一张牌。",
    ["@sfofl_zhenjue"] = "阵绝：你可以弃置一张牌或令 %src 摸一张牌",
    --S1044  三国杀标准版龙魂

    ["sfofl_zhouyu"] = "周瑜[官盗]",
    ["&sfofl_zhouyu"] = "周瑜",
    ["#sfofl_zhouyu"] = "少年英姿",
    ["~sfofl_zhouyu"] = "",
    ["illustrator:sfofl_zhouyu"] = "",
    ["information:sfofl_zhouyu"] = "S1062 三国杀武将传之周瑜",

    ["sfofl_shiyin"] = "识音",
    [":sfofl_shiyin"] = "当你于回合内获得手牌时，你可以展示这些牌，然后根据花色数令你本回合下一张牌获得对应效果：不少于1，不能被响应；不少于2，造成的伤害+ 1；不少于3，使用时摸一张牌。",
    --S1062 三国杀武将传之周瑜

    ["sfofl_caozhi"] = "曹植[官盗]",
    ["&sfofl_caozhi"] = "曹植",
    ["#sfofl_caozhi"] = "少年英姿",
    ["~sfofl_caozhi"] = "",
    ["illustrator:sfofl_caozhi"] = "",
    ["information:sfofl_caozhi"] = "S2081 三国杀武将传之曹植",

    ["sfofl_liushang"] = "流觞",
    [":sfofl_liushang"] = "锁定技，摸牌阶段，你摸X+1张牌，然后在每名其他角色武将牌上放置一张手牌。其他角色的准备阶段，其选择一项：获得其武将牌上的流觞牌且本回合不能对你造成伤害；或弃置此牌（X为埸上存活角色数且至少为3）。",
    ["sfofl_qibu"] = "七步",
    [":sfofl_qibu"] = "限定技，当你进入濒死状态时，你翻开牌堆顶的七张牌，每有一张红桃牌，你回复1点体力，然后获得其中的梅花牌。",

    --S2081 三国杀武将传之曹植

    ["sfofl_guojia"] = "郭嘉[官盗]",
    ["&sfofl_guojia"] = "郭嘉",
    ["#sfofl_guojia"] = "乱世奇佐",
    ["~sfofl_guojia"] = "",
    ["illustrator:sfofl_guojia"] = "",
    ["information:sfofl_guojia"] = "S1059 三国杀S1-乱世七佐 郭嘉",

    ["sfofl_qizuo"] = "奇佐",
    [":sfofl_qizuo"] = "当你攻击范围内的角色受到或造成伤害时，你可以弃置一张牌并判定，若结果与此牌颜色相同，你可以令此伤害+1或-1。",
    ["@sfofl_qizuo"] = "你可以对 %src 发动奇佐",
    ["sfofl_qizuo:add"] = "令此伤害+1",
    ["sfofl_qizuo:minus"] = "令此伤害-1",
    --S1059 三国杀S1-乱世七佐 郭嘉

    ["sfofl_2_guojia"] = "郭嘉[官盗]",
    ["&sfofl_2_guojia"] = "郭嘉",
    ["#sfofl_2_guojia"] = "旷世奇才",
    ["~sfofl_2_guojia"] = "",
    ["illustrator:sfofl_2_guojia"] = "",
    ["information:sfofl_2_guojia"] = "S2070 三国杀S2-武将传之旷世奇才 郭嘉",
    ["sfofl_quanmou"] = "全谋",
    [":sfofl_quanmou"] = "当一名其他角色使用的锦囊牌结算后，若你为此牌指定的目标之一，你可以弃置一张与此牌颜色相同的手牌，然后获得之。",
    ["@sfofl_quanmou"] = "全谋:你可以弃置一张与此牌颜色相同的手牌，然后获得之。",


    --S2070 三国杀S2-武将传之旷世奇才 郭嘉
    
    ["sfofl_zhaoyun"] = "赵云[官盗]",
    ["&sfofl_zhaoyun"] = "赵云",
    ["#sfofl_zhaoyun"] = "寒光凛然",
    ["~sfofl_zhaoyun"] = "",
    ["illustrator:sfofl_zhaoyun"] = "",
    ["information:sfofl_zhaoyun"] = "S2067 三国杀S2-武神赵子龙传 赵云",
    ["sfofl_qijin"] = "七进",
    [":sfofl_qijin"] = "摸牌阶段，你可以改为亮出牌堆顶的七张牌，然后获得其中一种颜色的所有牌。",
    ["sfofl_qichu"] = "七出",
    [":sfofl_qichu"] = "<font color=\"green\"><b>每名其他角色的回合限一次，</b></font>当你需要使用或打出一张基本牌时，你可以观看牌堆顶的两张牌，然后可以使用或打出其中一张相应的基本牌。",
    ["sfofl_longxin"] = "龙心",
    [":sfofl_longxin"] = "判定阶段开始时，你可以弃置一张装备牌，然后弃置你的判定区里的一张牌。",
    ["sfofl_longxin-ask"] = "你可以弃置一张装备牌，弃置自己判定区内的一张牌",

    --S2067 三国杀S2-武神赵子龙传 赵云

    ["sfofl_lubu"] = "吕布[官盗]",
    ["&sfofl_lubu"] = "吕布",
    ["#sfofl_lubu"] = "武的化身",
    ["~sfofl_lubu"] = "",
    ["illustrator:sfofl_lubu"] = "7点Game",
    ["information:sfofl_lubu"] = "S1068 三国杀S1-主公杀",
    ["sfofl_sheji"] = "射戟",
    [":sfofl_sheji"] = "出牌阶段限一次，你可以将所有手牌当一张无距离限制的【杀】使用，此【杀】对目标角色造成伤害后，若其装备区里有武器牌或坐骑牌，你获得之。",

    ["sfofl_dongzhuo"] = "董卓[官盗]",
    ["&sfofl_dongzhuo"] = "董卓",
    ["#sfofl_dongzhuo"] = "魔王",
    ["~sfofl_dongzhuo"] = "",
    ["illustrator:sfofl_dongzhuo"] = "巴萨小马",
    ["information:sfofl_dongzhuo"] = "S1068 三国杀S1-主公杀",
    ["sfofl_hengzheng"] = "横征",
    [":sfofl_hengzheng"] = "回合开始时，若你没有手牌或体力值为1，你可以获得每名角色区域里的一张牌。",

--   全新场景技能：【奋战】锁定技，结束阶段，若你本回合造成过伤害，你获得1枚「战」标记（至多3枚），否则移除所有「战」。准备阶段，你摸「战」数量的牌。
    --S1068 三国杀S1-主公杀  

    ["sfofl_jiaxu"] = "贾诩[官盗]",
    ["&sfofl_jiaxu"] = "贾诩",
    ["#sfofl_jiaxu"] = "亂武天下",
    ["~sfofl_jiaxu"] = "",
    ["illustrator:sfofl_jiaxu"] = "木美人",
    ["information:sfofl_jiaxu"] = "S2079 三国杀S2-乱武天下 贾诩",

    ["sfofl_yice"] = "遗策",
    [":sfofl_yice"] = "锁定技，当你使用/打出/弃置的牌进入弃牌堆后，你将这些牌以任意顺序置于你的武将牌上，称为“策”。若这些“策”中有点数相同的牌，则你获得这两张牌中的所有牌，将这两张牌置于牌堆两端。若场上没有处于濒死状态的角色，则你对一名角色造成1点伤害。",
    ["sfofl_yice_up"] = "置于牌堆頂",
    ["sfofl_yice_down"] = "置于牌堆底",
    ["sfofl_yice_damage"] = "遗策：对一名角色造成1点伤害",
    ["sfofl_yice_guanxing"] = "选择置于牌堆两端的牌",
    
    --S2079 三国杀S2-乱武天下 贾诩

    ["sfofl_jin_simayi"] = "司马懿[官盗]",
    ["&sfofl_jin_simayi"] = "司马懿",
    ["#sfofl_jin_simayi"] = "鹰视狼顾",
    ["~sfofl_jin_simayi"] = "",
    ["illustrator:sfofl_jin_simayi"] = "绘聚艺堂",
    ["information:sfofl_jin_simayi"] = "S1067 三国杀S1-鹰视狼顾之司马懿",
    ["sfofl_quanyi"] = "权弈",
    [":sfofl_quanyi"] = "出牌阶段限一次，你可以与一名角色拼点（你可以用牌堆顶的牌拼点），根据对方拼点牌的花色，赢的角色依次执行以下效果：红桃，其获得没赢的角色区域里的一张牌；方块，其对没赢的角色造成1点伤害；黑桃，其失去1点体力；梅花，其弃置两张牌。",
    ["sfofl_jadeseal"] = "玉玺",
    [":sfofl_jadeseal"] = "装备牌/宝物<br/><b>宝物技能</b>：锁定技，当你受到伤害后，你可以声明一种花色，然后令伤害来源显示所有手牌并弃置其中与该花色相同的所有牌。",
    --S1067 三国杀S1-鹰视狼顾之司马懿

    ["sfofl_2_jiaxu"] = "贾诩[官盗]",
    ["&sfofl_2_jiaxu"] = "贾诩",
    ["#sfofl_2_jiaxu"] = "控魂驱魄",
    ["~sfofl_2_jiaxu"] = "",
    ["illustrator:sfofl_2_jiaxu"] = "光域",
    ["information:sfofl_2_jiaxu"] = "S1066 三国杀S1-控魂驱魄之贾诩",
    ["sfofl_qupo"] = "驱魄",
    [":sfofl_qupo"] = "一名角色的回合开始时，你可以将一张牌交给另一名其他角色，若此牌为：黑色，当前回合角色使用【杀】指定该角色以外的目标时，当前回合角色失去1点体力；红色，该角色本回合第一次受到伤害时，其失去1点体力。",
    ["@sfofl_qupo"] = "你可以发动“驱魄”",
    ["sfofl_baoquan"] = "保全",
    [":sfofl_baoquan"] = "当你受到伤害时，你可以弃置一张锦囊牌并防止此伤害。",
    ["@sfofl_baoquan"] = "你可以发动“保全”防止此伤害",
    ["sfofl_horsetailwhisk"] = "拂尘",
    [":sfofl_horsetailwhisk"] = "装备牌/防具<br/><b>防具技能</b>：出牌阶段限一次，你可以将一张手牌放置在拂尘上。当牌数为2或以上时，你可以将拂尘上的牌使用或打出：若牌数为2，该牌视为【闪】；若牌数为3，该牌视为【无懈可击】；若牌数为4或以上，该牌视为【闪】或【无懈可击】。",
    -- S1066 三国杀S1-控魂驱魄之贾诩  
    
    ["sfofl_plainclothes"] = "便衣",
    [":sfofl_plainclothes"] = "装备牌/防具<br/><b>防具技能</b>：锁定技，你每回合内第一次成为【杀】的目标时，此牌对你无效。",
    -- S1051三国杀S1-白衣渡江

    ["sfofl_token"] = "丞相之令",
    [":sfofl_token"] = "装备牌/宝物<br/><b>宝物技能</b>：你获得“观星”，若你已拥有“观星”，则将其描述中的X改为5。",
    -- S1046三国杀S1-六出祁山
    ["sfofl_qixinglight_slash"] = "七星灯【杀】",
    ["sfofl_qixinglight_select"] = "七星灯",
    ["sfofl_qixinglight"] = "七星灯",
    ["@sfofl_qixinglight"] = "你可以将所有手牌或七星灯当 %src 使用或打出。",
    [":sfofl_qixinglight"] = "装备牌/宝物<br/><b>宝物技能</b>：每回合每种牌名限一次，你可以将所有手牌或七星灯当一张基本牌或【无懈可击】使用或打出。",
    -- S1052三国杀S1-祈星之力

    ["sfofl_2_zhouyu"] = "周瑜[官盗]",
    ["&sfofl_2_zhouyu"] = "周瑜",
    ["#sfofl_2_zhouyu"] = "英才盖世",
    ["~sfofl_2_zhouyu"] = "",
    ["illustrator:sfofl_2_zhouyu"] = "z种风彦",
    ["information:sfofl_2_zhouyu"] = "S2080 三国杀S2-英才盖世之周瑜",
    ["sfofl_noise"] = "杂音",
    ["sfofl_2_shiyin"] = "识音",
    [":sfofl_2_shiyin"] = "游戏开始时，你可以将一张手牌正面向上置于武将牌上，称为“杂音”标记，与其花色相同的牌称为“杂音”牌；出牌阶段开始时，你可以用一张手牌替换“杂音”标记。",
    ["sfofl_quwu"] = "曲误",
    [":sfofl_quwu"] = "锁定技，你不能使用或打出“杂音”牌且“杂音”牌对你无效。",
    ["sfofl_liaozou"] = "聊奏",
    [":sfofl_liaozou"] = "出牌阶段，你可以展示所有手牌，若其中没有杂音牌，你摸一张牌。",
    -- S2080 三国杀S2-英才盖世之周瑜

    ["sfofl_tigertally"] = "虎豹兵符",
    [":sfofl_tigertally"] = "装备牌/宝物<br/><b>宝物技能</b>：你可以将一张其他装备牌当【杀】使用或打出，若此牌为：武器，此【杀】不可被响应；坐骑，此【杀】不计次数；防具，你摸一张牌。",
    -- S1045 三国杀S1-虎豹骑

    ["sfofl_lyre"] = "七弦琴",
    [":sfofl_lyre"] = "装备牌·武器\
	攻击范围：0\
	攻击效果：你每有一张手牌，你的攻击范围+1；你攻击范围外的角色对你造成伤害后，你可以弃置该角色一张牌。",
    [":sfofl_lyre1"] = "装备牌·武器\
	攻击范围：%src \
	攻击效果：你每有一张手牌，你的攻击范围+1；你攻击范围外的角色对你造成伤害后，你可以弃置该角色一张牌。",

    ["sfofl_zhugeliang"] = "诸葛亮[官盗]",
    ["&sfofl_zhugeliang"] = "诸葛亮",
    ["#sfofl_zhugeliang"] = "空城退敌",
    ["~sfofl_zhugeliang"] = "",
    ["illustrator:sfofl_zhugeliang"] = "",
    ["information:sfofl_zhugeliang"] = "S1058 三国杀空城计",
    ["sfofl_qixing"] = "祈星",
    [":sfofl_qixing"] = "出牌阶段开始时，你可以将你的手牌摸至七张，若如此做，回合结束时，你弃置所有手牌，且本回合你连续使用两张类别相同的牌时，你失去1点体力。",
    --S1058 三国杀空城计

    ["sfofl_2_guanyu"] = "关羽[官盗]",
    ["&sfofl_2_guanyu"] = "关羽",
    ["#sfofl_2_guanyu"] = "汉寿亭侯",
    ["~sfofl_2_guanyu"] = "",
    ["illustrator:sfofl_2_guanyu"] = "",
    ["information:sfofl_2_guanyu"] = "S1074 过关斩将",
    ["sfofl_nuchen"] = "怒嗔",
    [":sfofl_nuchen"] = "魏势力技，出牌阶段限一次，你可以展示一名其他角色的一张手牌，然后选择一项：1.弃置一张花色相同的牌并对其造成1点伤害；2.获得此牌。",
    ["sfofl_yijue"] = "义绝",
    [":sfofl_yijue"] = "蜀势力技，出牌阶段限一次，你可以与一名角色拼点，若你赢，本回合其不能使用或打出手牌，没赢，你可以令其回复1点体力。",
    --S1074 过关斩将

    ["sfofl_2_zhaoyun"] = "赵云[官盗]",
    ["&sfofl_2_zhaoyun"] = "赵云",
    ["#sfofl_2_zhaoyun"] = "单骑救主",
    ["~sfofl_2_zhaoyun"] = "",
    ["illustrator:sfofl_2_zhaoyun"] = "",
    ["information:sfofl_2_zhaoyun"] = "S2067 三国杀武将传武神赵子龙",
    ["sfofl_huiqiang"] = "回枪",
    [":sfofl_huiqiang"] = "当你使用的【杀】被目标角色使用的【闪】抵消后，你可以对其使用一张【杀】。",
    ["sfofl_huiqiang-slash"] = "你可以发动“回枪”再对 %src 使用一张【杀】",
    ["sfofl_huntu"] = "魂突",
    [":sfofl_huntu"] = "出牌阶段限一次，当你使用的【杀】对目标角色造成伤害后，你可以对其使用一张【杀】。",
    --S2067 三国杀武将传武神赵子龙

    ["sfofl_2_zhugeliang"] = "诸葛亮[官盗]",
    ["&sfofl_2_zhugeliang"] = "诸葛亮",
    ["#sfofl_2_zhugeliang"] = "谋定天下",
    ["~sfofl_2_zhugeliang"] = "",
    ["illustrator:sfofl_2_zhugeliang"] = "",
    ["information:sfofl_2_zhugeliang"] = "S2066 三国杀武将传卧龙诸葛亮",
    ["sfofl_zhiji"] = "智激",
    [":sfofl_zhiji"] = "出牌阶段限一次，你可以弃置两张手牌并选择两名不同势力的角色，视为两名角色对对方使用一张【杀】。",
    ["sfofl_jiefeng"] = "借风",
    [":sfofl_jiefeng"] = "你可以弃置两张手牌，然后亮出牌堆顶的5张牌，若其中有两张红色牌，则视为你使用一张【万箭齐发】。",
    --S2066 三国杀武将传卧龙诸葛亮

    ["sfofl_2_simayi"] = "司马懿[官盗]",
    ["&sfofl_2_simayi"] = "司马懿",
    ["#sfofl_2_simayi"] = "大军师",
    ["~sfofl_2_simayi"] = "",
    ["illustrator:sfofl_2_simayi"] = "",
    ["information:sfofl_2_simayi"] = "S2068大军师司马懿",
    ["sfofl_zhonghu"] = "冢虎",
    [":sfofl_zhonghu"] = "你的回合外有角色死亡时，你可以立即终止当前角色回合，并且游戏轮次跳至你的回合。",
    --S2068大军师司马懿

    ["sfofl_machao"] = "马超[官盗]",
    ["&sfofl_machao"] = "马超",
    ["#sfofl_machao"] = "西凉雄师",
    ["~sfofl_machao"] = "",
    ["illustrator:sfofl_machao"] = "",
    ["information:sfofl_machao"] = "S2069 三国杀武将传西凉雄狮马超",
    ["sfofl_weihou"] = "威侯",
    [":sfofl_weihou"] = "当你进行判定时，你可以展示牌堆顶的两张牌，弃置其中一张并选择另一张作为你本次的判定牌。",
    --S2069 三国杀武将传西凉雄狮马超

    ["sfofl_caopi"] = "曹丕[官盗]",
    ["&sfofl_caopi"] = "曹丕",
    ["#sfofl_caopi"] = "霸业天子",
    ["~sfofl_caopi"] = "",
    ["information:sfofl_caopi"] = "S2075 三国杀霸业天子曹丕",
    ["sfofl_jianwei"] = "僭位",
    [":sfofl_jianwei"] = "限定技，回合开始时，你可以失去1点体力，然后与一名其他角色交换区域内所有牌。",
    ["@sfofl_jianwei"] = "僭位",
    ["sfofl_jianwei-invoke"] = "你可以发动“僭位”<br/> <b>操作提示</b>: 选择一名其他角色→点击确定<br/>",
    --S2075 三国杀霸业天子曹丕

    ["sfofl_3_simayi"] = "司马懿[官盗]",
    ["&sfofl_3_simayi"] = "司马懿",
    ["#sfofl_3_simayi"] = "冢虎",
    ["~sfofl_3_simayi"] = "",
    ["information:sfofl_3_simayi"] = "S2073 三国杀虎啸龙吟",
    ["sfofl_huxiao"] = "虎啸",
    [":sfofl_huxiao"] = "回合开始时，你可以进行一次判定，若为基本牌或非延时锦囊牌，本回合内你可以将相同点数或花色的手牌当此判定牌使用。",

    ["sfofl_3_zhugeliang"] = "诸葛亮[官盗]",
    ["&sfofl_3_zhugeliang"] = "诸葛亮",
    ["#sfofl_3_zhugeliang"] = "卧龙",
    ["~sfofl_3_zhugeliang"] = "",
    ["information:sfofl_3_zhugeliang"] = "S2073 三国杀虎啸龙吟",
    ["sfofl_longyin"] = "龙吟",
    [":sfofl_longyin"] = "你可以将任意点数和为13的牌当做任意基本牌或非延时锦囊牌使用或打出，<font color=\"green\"><b>每回合限一次</b></font>。",
    --S2073 三国杀虎啸龙吟

    ["sfofl_2_lvbu"] = "吕布[官盗]",
    ["&sfofl_2_lvbu"] = "吕布",
    ["#sfofl_2_lvbu"] = "血修罗",
    ["~sfofl_2_lvbu"] = "",
    ["illustrator:sfofl_2_lvbu"] = "干橘子",
    ["information:sfofl_2_lvbu"] = "S2076武将传 血修罗吕布",
    ["sfofl_wushuang"] = "无双",
    [":sfofl_wushuang"] = "锁定技，当你使用【杀】指定目标后，其使用【闪】抵消此【杀】的方式改为需连续使用两张【闪】；当你使用【决斗】指定目标后，或当你成为【决斗】的目标后，你令其打出【杀】响应此【决斗】的方式改为需连续打出两张【杀】。<br>" ..
  "二级：增加效果：当其他角色弃置的【决斗】进入弃牌堆后，你获得之。<br>" ..
  "三级：增加效果：你使用【杀】伤害基数值+1，目标角色每使用一张【闪】进行响应，此【杀】对其造成的伤害-1。",
    [":sfofl_wushuang1"] = "锁定技，当你使用【杀】指定目标后，其使用【闪】抵消此【杀】的方式改为需连续使用两张【闪】；当你使用【决斗】指定目标后，或当你成为【决斗】的目标后，你令其打出【杀】响应此【决斗】的方式改为需连续打出两张【杀】。当其他角色弃置的【决斗】进入弃牌堆后，你获得之。<br>" ..
  "三级：增加效果：你使用【杀】伤害基数值+1，目标角色每使用一张【闪】进行响应，此【杀】对其造成的伤害-1。",
    [":sfofl_wushuang2"] = "锁定技，当你使用【杀】指定目标后，其使用【闪】抵消此【杀】的方式改为需连续使用两张【闪】；当你使用【决斗】指定目标后，或当你成为【决斗】的目标后，你令其打出【杀】响应此【决斗】的方式改为需连续打出两张【杀】。当其他角色弃置的【决斗】进入弃牌堆后，你获得之。你使用【杀】伤害基数值+1，目标角色每使用一张【闪】进行响应，此【杀】对其造成的伤害-1。",
    ["sfofl_xiuluo"] = "修罗",
    [":sfofl_xiuluo"] = "当你杀死一名角色后，你可以减1点体力上限，修改“无双”。",
    --S2076武将传 血修罗吕布

    ["sfofl_zhugedan"] = "诸葛诞[官盗]",
    ["&sfofl_zhugedan"] = "诸葛诞",
    ["~sfofl_zhugedan"] = "",
    ["information:sfofl_zhugedan"] = "S4028 三国杀S4-用间篇",
    ["sfofl_juyi"] = "举义",
    [":sfofl_juyi"] = "觉醒技，准备阶段，若你已受伤且体力上限大于存活角色数，你摸等同于你体力上限数量的牌，然后获得“崩坏”。",

    ["sfofl_zhenji"] = "甄姬[官盗]",
    ["&sfofl_zhenji"] = "甄姬",
    ["~sfofl_zhenji"] = "",
    ["information:sfofl_zhenji"] = "S4028 三国杀S4-用间篇",
    ["sfofl_luoshen"] = "洛神",
    [":sfofl_luoshen"] = "准备阶段，你可以判定，并获得生效后的判定牌，然后若你本次以此法获得的牌颜色均相同，你可以重复此流程。",
    
    ["sfofl_sp_jiaxu"] = "SP贾诩[官盗]",
    ["&sfofl_sp_jiaxu"] = "SP贾诩",
    ["~sfofl_sp_jiaxu"] = "",
    ["information:sfofl_sp_jiaxu"] = "S4028 三国杀S4-用间篇",
    ["sfofl_2_jianshu"] = "间书",
    [":sfofl_2_jianshu"] = "出牌阶段限一次，你可以将一张手牌交给一名其他角色，然后选择另一名其他角色，令这两名角色拼点：没赢的角色失去1点体力。",
    ["@sfofl_2_jianshu-pindian"] = "间书：你选择另一名其他角色与 %src 拼点",
    --S4028用间篇

    ["sfofl_shenjiangwei"] = "神姜维[官盗]",
    ["&sfofl_shenjiangwei"] = "神姜维",
    ["#sfofl_shenjiangwei"] = "怒麟布武",
    ["~sfofl_shenjiangwei"] = "",
    ["illustrator:sfofl_shenjiangwei"] = "匠人绘",
    ["information:sfofl_shenjiangwei"] = "S0-004 三国杀S0-神威九伐",
    ["@sfofl_jiufa"] = "九伐：你选择并获得其中点数重复[ %src ]的牌各一张",
    ["sfofl_jiufa"] = "九伐",
	[":sfofl_jiufa"] = "当你使用或打出的牌结算完成后，若你的武将牌上没有与之牌名相同的牌，你可以将这些牌置于你的武将牌上。此时若你以此法置于武将牌上的牌中包括至少九种牌名，你移去这些牌，然后展示牌堆顶的九张牌，获得其中点数重复的牌各一张。",

    --天才包移植
    ["sfofl_2_shenmachao"] = "神马超[官盗]",
    ["&sfofl_2_shenmachao"] = "神马超",
    ["#sfofl_2_shenmachao"] = "神威天将军",
    ["illustrator:sfofl_2_shenmachao"] = "君桓文化",
    ["designer:sfofl_2_shenmachao"] = "线下官盗,Nyarz",
    ["information:sfofl_2_shenmachao"] = "S0-004 三国杀S0-神威九伐",
    ["undershouli"] = "狩骊",
    [":undershouli"] = "锁定技，游戏开始时，所有角色依次选择一项：1.使用一张坐骑牌，然后摸一张牌；2.随机从游戏外使用一张坐骑指示物。你可以将场上的一张进攻坐骑当【杀】、防御马当【闪】使用或打出，以此法失去坐骑的角色本回合非锁定技失效，你与其本回合受到的伤害+1且改为雷电伤害。",
    ["$undershoulida"] = "%arg 受到的伤害因 %arg2 由 %arg3 点增加到了 %arg4 点并改为了雷电伤害。",
	["$undershouli1"] = "敢缚苍龙擒猛虎，一枪纵横定天山！",
	["$undershouli2"] = "马踏祁连山河动，兵起玄黄奈何天！",
    ["underhengwu"] = "横骛",
    [":underhengwu"] = "你使用或打出牌时，若场上有与此牌花色相同的装备牌，你可以弃置任意张与此牌花色相同的牌（可以不弃）并摸等于你弃置的牌数与场上与此牌花色相同的牌的装备牌的数量之和的牌。",
    ["@underhengwu"] = "你可以弃置任意张 %src 牌并摸等于（弃置数量 + %arg ）张牌",
	["$underhengwu1"] = "雷部显圣，引赤电为翼、铸霹雳成枪！",
	["$underhengwu2"] = "一骑破霄汉，饮马星河、醉卧广寒！",
    --线下神马超的“狩骊”指示物
	["_horsede"] = "+1指示物",
    ["_horseof"] = "-1指示物",
	  --阵亡
	["~sfofl_2_shenmachao"] = "七情难掩，六欲难消，何谓之神？",
    --S0-004神威九伐 神将篇

    --雖然不是在這產品第一次出的線下化處理 但看到了順便寫了
    ["sfofl_nanhualaoxian"] = "南华老仙[官盗]",
    ["&sfofl_nanhualaoxian"] = "南华老仙",
    ["#sfofl_nanhualaoxian"] = "冯虚御风",
    ["~sfofl_nanhualaoxian"] = "",
    ["illustrator:sfofl_nanhualaoxian"] = "青岛君桓",
    ["information:sfofl_nanhualaoxian"] = "S7006T 三国杀E7：肃问",
    ["sfofl_yufeng"] = "御风",
    [":sfofl_yufeng"] = "出牌阶段限一次，你可以进行判定，若结果为黑桃，你令一名其他角色跳过其下个回合的出牌阶段和弃牌阶段；红桃，你令一名其他角色跳过其下个回合的摸牌阶段；梅花或方块，你摸一张牌并重置“御风”。",
    ["@sfofl_tianshu"] = "天书：你可以弃置一张牌",
    ["sfofl_tianshu"] = "天书",
    [":sfofl_tianshu"] = "出牌阶段开始时，若埸上没有太平要术，你可以弃置一张牌，然后将太平要术置入一名角色的装备区。",

    ["sfofl_zhengxuan"] = "郑玄[官盗]",
    ["&sfofl_zhengxuan"] = "郑玄",
    ["#sfofl_zhengxuan"] = "兼采定道",
    ["~sfofl_zhengxuan"] = "",
    ["illustrator:sfofl_zhengxuan"] = "Monkey",
    ["information:sfofl_zhengxuan"] = "S7006T 三国杀E7：肃问",
    ["sfofl_zhengjing"] = "整经",
    [":sfofl_zhengjing"] = "出牌阶段限一次，你可以将牌堆中每种类别的各一张牌扣置于一名角色的武将牌一侧，该角色于其下个回合开始时获得这些牌，并跳过本回合的判定阶段和摸牌阶段。",

    ["sfofl_peixiu"] = "裴秀[官盗]",
    ["&sfofl_peixiu"] = "裴秀",
    ["#sfofl_peixiu"] = "晋图开秘",
    ["~sfofl_peixiu"] = "",
    ["illustrator:sfofl_peixiu"] = "鬼画府",
    ["information:sfofl_peixiu"] = "S7006T 三国杀E7：肃问",
    ["sfofl_juezhi"] = "爵制",
    [":sfofl_juezhi"] = "出牌阶段，你可以弃置至少两张牌，然后展示牌堆顶等量的牌，并获得其中一张。",

    ["sfofl_yongcai"] = "雍闿[官盗]",
    ["&sfofl_yongcai"] = "雍闿",
    ["#sfofl_yongcai"] = "惑动南中",
    ["~sfofl_yongcai"] = "",
    ["illustrator:sfofl_yongcai"] = "HIM",
    ["information:sfofl_yongcai"] = "S7006T 三国杀E7：肃问",
    ["sfofl_xiaofan_damage"] = "嚣反",
    ["sfofl_xiaofan"] = "嚣反",
    [":sfofl_xiaofan"] = "蜀势力角色不以此法受到伤害后，你可以对其造成1点伤害，然后变更势力至吴；吴势力角色失去装备牌后，你与其各摸一张牌，然后变更势力至群；群势力角色造成伤害后，你可以获得伤害牌，然后变更势力至蜀。",
    ["sfofl_jiaohu"] = "骄扈",
    [":sfofl_jiaohu"] = "蜀势力技，摸牌阶段，你多摸X张牌（X为一号位已损失体力值+1）。",
    ["sfofl_quanpan"] = "劝叛",
    [":sfofl_quanpan"] = "吴势力技，当你获得装备牌后，你可以展示其中一张并交给一名其他角色。",
    ["sfofl_huoluan"] = "惑亂",
    [":sfofl_huoluan"] = "群势力技，你与蜀势力角色相互造成伤害+1。",

    ["sfofl_chezhou"] = "车胄[官盗]",
    ["&sfofl_chezhou"] = "车胄",
    ["#sfofl_chezhou"] = "反受其害",
    ["~sfofl_chezhou"] = "",
    ["illustrator:sfofl_chezhou"] = "YanBai",
    ["information:sfofl_chezhou"] = "S7006T 三国杀E7：肃问",
    ["sfofl_anmou"] = "暗谋",
    [":sfofl_anmou"] = "锁定技，游戏开始时，你秘密选择一名其他角色，你与其互相使用牌无次数限制。",
    ["sfofl_tousuan"] = "偷算",
    [":sfofl_tousuan"] = "锁定技，若你或“暗谋”角色首次对对方造成伤害时，此伤害+1且伤害来源摸三张牌，然后你失去此技能。",
    --S7006T 三国杀E7：肃问


}
--三国杀畅玩青春版
sgs.LoadTranslationTable {
    ["sfofl_young_xiahoudun"] = "夏侯惇[青春]",
    ["&sfofl_young_xiahoudun"] = "夏侯惇",
    ["#sfofl_young_xiahoudun"] = "独眼的罗刹",
    ["~sfofl_young_xiahoudun"] = "",
    ["information:sfofl_young_xiahoudun"] = "三国杀畅玩青春版",
    ["sfofl_young_ganglie"] = "刚烈",
    [":sfofl_young_ganglie"] = "其他角色对你造成伤害后，你可以令其弃置一张手牌。",

    ["sfofl_young_sunquan"] = "孙权[青春]",
    ["&sfofl_young_sunquan"] = "孙权",
    ["#sfofl_young_sunquan"] = "年轻的贤君",
    ["~sfofl_young_sunquan"] = "",
    ["information:sfofl_young_sunquan"] = "三国杀畅玩青春版",
    ["sfofl_young_zhiheng"] = "制衡",
    [":sfofl_young_zhiheng"] = "出牌阶段限一次，你可以弃置一张手牌，再摸一张牌。",

    ["sfofl_young_lvbu"] = "吕布[青春]",
    ["&sfofl_young_lvbu"] = "吕布",
    ["#sfofl_young_lvbu"] = "武的化身",
    ["~sfofl_young_lvbu"] = "",
    ["information:sfofl_young_lvbu"] = "三国杀畅玩青春版",
    ["sfofl_young_wushuang"] = "无双",
    [":sfofl_young_wushuang"] = "你使用的【杀】需要两张【闪】才能抵消（单出一张无效）。",

    ["sfofl_young_blade"] = "青龙偃月刀[青春]",
    [":sfofl_young_blade"] = "装备牌·武器\
	攻击范围：3\
	攻击效果：如果你使用的【杀】被抵消，本回合你可以再使用一张【杀】。",

    ["sfofl_young_halberd"] = "方天画戟[青春]",
    [":sfofl_young_halberd"] = "装备牌·武器\
	攻击范围：4\
	攻击效果：你可以将一张【杀】同时对两名其他角色使用。",

    ["sfofl_young_eight_diagram"] = "八卦阵[青春]",
	[":sfofl_young_eight_diagram"] = "装备牌/防具<br /><b>防具技能</b>：其他角色对你使用【杀】和【万箭齐发】时，你可以弃置牌堆顶的一张牌，如果弃置红色牌，你抵消此【杀】或【万箭齐发】。",
}
--真武试炼
sgs.LoadTranslationTable {
    
    --本來想做個boss 模式 還是算了
    ["sfofl_4_zhugeliang"] = "诸葛亮[官盗]",
    ["&sfofl_4_zhugeliang"] = "诸葛亮",
    ["#sfofl_4_zhugeliang"] = "谋定天下",
    ["~sfofl_4_zhugeliang"] = "",
    ["illustrator:sfofl_4_zhugeliang"] = "第七个桔子",
    ["information:sfofl_4_zhugeliang"] = "S1037 真武试炼诸葛亮传",

    ["sfofl_wentian"] = "问天",
    [":sfofl_wentian"] = "锁定技，摸牌阶段开始时，你改为亮出牌堆顶的四张牌，然后获得其中一种花色的所有牌。剩余牌以任意顺序放回牌堆顶或牌堆底。根据你获得的花色，直到你的下回合开始，你拥有以下效果。\
    黑桃，雪：你视为装备【诸葛连弩】；\
    红桃，晴：你回复1点体力，摸一张牌；\
    梅花，雾：你视为装备【八卦阵】；\
    方块，风：你每造成1点伤害，你可以摸一张牌。",
    [":sfofl_wentian1"] = "锁定技，摸牌阶段开始时，你改为亮出牌堆顶的 %arg1 张牌，然后获得其中一种花色的所有牌。剩余牌以任意顺序放回牌堆顶或牌堆底。根据你获得的花色，直到你的下回合开始，你拥有以下效果。\
    黑桃，雪：你视为装备【诸葛连弩】；\
    红桃，晴：你回复1点体力，摸一张牌；\
    梅花，雾：你视为装备【八卦阵】；\
    方块，风：你每造成1点伤害，你可以摸一张牌。",
    ["sfofl_wentian_spade"] = "问天：雪",
    ["sfofl_wentian_heart"] = "问天：晴",
    ["sfofl_wentian_club"] = "问天：雾",
    ["sfofl_wentian_diamond"] = "问天：风",
    ["sfofl_kefu"] = "克复",
    [":sfofl_kefu"] = "你每对其他角色造成4点伤害，问天的牌数+1。",

    ["sfofl_3_guanyu"] = "关羽[官盗]",
    ["&sfofl_3_guanyu"] = "关羽",
    ["#sfofl_3_guanyu"] = "美髯公",
    ["~sfofl_3_guanyu"] = "",
    ["illustrator:sfofl_3_guanyu"] = "魔奇士",
    ["information:sfofl_3_guanyu"] = "S1014 真武试炼关羽传",
    ["sfofl_tuodao"] = "拖刀",
    [":sfofl_tuodao"] = "锁定技，你使用黑色【杀】时，你摸一张牌；红色【杀】时，此【杀】伤害+1。",

    ["sfofl_caocao"] = "曹操[官盗]",
    ["&sfofl_caocao"] = "曹操",
    ["#sfofl_caocao"] = "魏武帝",
    ["~sfofl_caocao"] = "",
    ["illustrator:sfofl_caocao"] = "Town",
    ["information:sfofl_caocao"] = "S1026 真武试炼曹操传",
    ["sfofl_xiongcai"] = "雄才",
    [":sfofl_xiongcai"] = "你造成1点伤害后，你可以摸一张牌。",

    ["sfofl_3_zhaoyun"] = "赵云[官盗]",
    ["&sfofl_3_zhaoyun"] = "赵云",
    ["#sfofl_3_zhaoyun"] = "武动乾坤",
    ["~sfofl_3_zhaoyun"] = "",
    ["illustrator:sfofl_3_zhaoyun"] = "depp",
    ["information:sfofl_3_zhaoyun"] = "S1031 真武试炼赵云传",
    ["sfofl_2_qijin"] = "七进",
    [":sfofl_2_qijin"] = "觉醒技，结束阶段，若你本回合造成了2点或更多伤害，你减1点体力上限，获得“冲阵”。",
    ["sfofl_2_qichu"] = "七出",
    [":sfofl_2_qichu"] = "觉醒技，当你的体力值第一次为2点及以下时，你获得“义从”并抽两张牌。",

    ["sfofl_sunce"] = "孙策[官盗]",
    ["&sfofl_sunce"] = "孙策",
    ["#sfofl_sunce"] = "江东小霸王",
    ["~sfofl_sunce"] = "",
    ["illustrator:sfofl_sunce"] = "小肚皮",
    ["information:sfofl_sunce"] = "S1021 真武试炼孙策传",
    ["sfofl_baye"] = "霸业",
    [":sfofl_baye"] = "你可以将两张手牌当红色【杀】使用或打出。",

}
--三国杀特殊模式【龙虎斗】
sgs.LoadTranslationTable {
    --S1038 三国杀特殊模式【龙虎斗 关羽VS吕布】
    ["sfofl_boss_guanyu"] = "关羽[官盗]",
    ["&sfofl_boss_guanyu"] = "关羽",
    ["#sfofl_boss_guanyu"] = "军神对决",
    ["illustrator:sfofl_boss_guanyu"] = "-biou09",
    ["information:sfofl_boss_guanyu"] = "S1038 三国杀特殊模式 龙虎斗 关羽VS吕布",
    ["sfofl_boss_change_guanyu"] = "形态转换",
    [":sfofl_boss_change_guanyu"] = "当你的“武魂”牌只有一种颜色时，你进入历战状态。",
    ["sfofl_boss_wuhun"] = "武魂",
    [":sfofl_boss_wuhun"] = "游戏开始时，你将牌堆顶九张牌放在你的武将牌上，称为“武魂”牌。",
    ["sfofl_boss_wenjiu"] = "温酒",
    [":sfofl_boss_wenjiu"] = "摸牌阶段，你可以放弃摸牌，然后将三张“武魂”牌加入手牌，并将牌堆顶三张牌置入“武魂”牌。",
    ["@sfofl_boss_wenjiu"] = "温酒：你可以改为将三张“武魂”牌加入手牌，并将牌堆顶三张牌置入“武魂”牌。",
    ["sfofl_boss_wusheng"] = "武圣",
    [":sfofl_boss_wusheng"] = "你的“武魂”牌中黑色牌最多时，你可以将一张黑色牌当【过河拆桥】使用；红色牌最多时，你可以将一张红色牌当【杀】使用或打出。",

    ["sfofl_boss_zhongyi"] = "忠义",
    [":sfofl_boss_zhongyi"] = "摸牌阶段，你额外摸两张牌，若你的“武魂”牌为同一花色，则改为摸五张牌。",
    ["sfofl_boss_ruiyi"] = "锐意",
    [":sfofl_boss_ruiyi"] = "出牌阶段限一次，你可以选择一项：①用任意张“武魂”牌替换等量手牌；②弃置任意张与“武魂”牌颜色不同的手牌然后摸等量的牌。",
    ["sfofl_boss_xiaoyong"] = "骁勇",
    [":sfofl_boss_xiaoyong"] = "若你使用的【杀】与你“武魂”牌颜色相同，则无次数限制；若你的“武魂”牌为同一花色，则你使用与你“武魂”牌花色相同的【杀】造成伤害时摸一张牌。",

    ["sfofl_boss_lvbu"] = "吕布[官盗]",
    ["&sfofl_boss_lvbu"] = "吕布",
    ["#sfofl_boss_lvbu"] = "武动乾坤",
    ["illustrator:sfofl_boss_lvbu"] = "-moon",
    ["information:sfofl_boss_lvbu"] = "S1038 三国杀特殊模式 龙虎斗 关羽VS吕布",
    ["sfofl_boss_zhanyi"] = "战意",
    ["sfofl_boss_change_lvbu"] = "形态转换",
    [":sfofl_boss_change_lvbu"] = "当你的“战意”牌数量大于等于3时，你进入历战状态。",
    ["sfofl_boss_hanzhan"] = "酣战",
    [":sfofl_boss_hanzhan"] = "你每造成1点伤害，你可以将牌堆顶的一张牌置于你的武将牌上，称为“战意”牌。",
    ["sfofl_boss_feijun"] = "飞军",
    [":sfofl_boss_feijun"] = "出牌阶段，每种花色限一次，当你使用或打出一张牌时，若此牌花色与你装备区中的牌花色相同，则你摸一张牌。",

    ["sfofl_boss_wushuang"] = "无双",
    [":sfofl_boss_wushuang"] = "锁定技，你使用的【杀】伤害+1，被指定的角色每使用一张【闪】可抵消1点伤害；你使用的【决斗】不可被响应。",
    ["sfofl_boss_wushuang-jink"] = "%src 对你造成伤害，你可使用【闪】抵消1点伤害",
    ["sfofl_boss_hanzhan_2"] = "酣战",
    [":sfofl_boss_hanzhan_2"] = "当你使用或打出与“战意”牌花色相同的牌时，摸一张牌。",
    ["sfofl_boss_xiuluo"] = "修罗",
    [":sfofl_boss_xiuluo"] = "出牌阶段限一次，你可以弃置一张“战意”牌并选择一项：①摸四张牌，并将两张手牌作为“战意”牌放在你的武将牌上然后结束出牌阶段；②弃置一名角色所有装备牌；③弃置一名角色一半的手牌（向下取整）。",
    ["sfofl_boss_xiuluo_Draw"] = "摸四张牌，并将两张手牌作为“战意”牌放在你的武将牌上然后结束出牌阶段",
    ["sfofl_boss_xiuluo_Discard_equip"] = "弃置一名角色所有装备牌",
    ["sfofl_boss_xiuluo_Discard_handcard"] = "弃置一名角色一半的手牌（向下取整）",

    ["sfofl_boss_zhangfei"] = "张飞[官盗]",
    ["&sfofl_boss_zhangfei"] = "张飞",
    ["#sfofl_boss_zhangfei"] = "万夫不当",
    ["information:sfofl_boss_zhangfei"] = "S1039 三国杀特殊模式 龙虎斗 关羽VS张飞",
    ["sfofl_boss_change_zhangfei"] = "形态转换",
    [":sfofl_boss_change_zhangfei"] = "当你的“杀意”牌达到五张或体力值小于等于4时，进入历战形态。",
    ["sfofl_boss_shayi"] = "杀意",
    [":sfofl_boss_shayi"] = "你的回合内，你的【杀】进入弃牌堆时，你可以将其放在你的武将牌上，称为“杀意”牌。",
    ["sfofl_boss_beizhan"] = "备战",
    [":sfofl_boss_beizhan"] = "摸牌阶段，你每有一张红色“杀意”牌，额外摸一张牌。",
    ["sfofl_boss_shajue-invoke"] = "你可以发动“杀绝”<br/> <b>操作提示</b>: 选择一名其他角色→点击确定<br/>",
    ["@sfofl_boss_shajue"] = "杀绝：你可以弃置任意张“杀意”牌",
    ["sfofl_boss_shajue"] = "杀绝",
    [":sfofl_boss_shajue"] = "出牌阶开始时，你可以将弃置任意张“杀意”牌，根据你弃置的数量，你于本回合获得以下效果：一张或以上，摸两张牌；两张或以上，获得咆哮；三张或以上，获得一名其他角色手牌区与装备区各一张牌。",
    ["sfofl_boss_numu"] = "怒目",
    [":sfofl_boss_numu"] = "以你为目标的【杀】未对你造成伤害时，你可以摸一张牌，然后将一张手牌当做“杀意”牌放在你武将牌上。",

}

--E系列
sgs.LoadTranslationTable {
    
    ["sfofl_zhonghui"] = "钟会[官盗]",
    ["&sfofl_zhonghui"] = "钟会",
    ["#sfofl_zhonghui"] = "统定河山",
    ["~sfofl_zhonghui"] = "",
    ["illustrator:sfofl_zhonghui"] = "磐蒲",
    ["information:sfofl_zhonghui"] = "E7005T 决战巅峰",
    ["sfofl_mouchuan"] = "谋川",
    [":sfofl_mouchuan"] = "每轮开始时，你可以摸两张牌并交给一名其他角色一张牌，然后你与其依次展示一张手牌，若颜色：相同，你本轮获得技能“道合”；不同，你本轮获得技能“志异”。",
    ["@sfofl_mouchuan"] = "谋川：交给 %src 一张牌",
    ["sfofl_zizhong"] = "自重",
    [":sfofl_zizhong"] = "锁定技，当你使用或打出一张你本轮未使用过的非装备牌时，你摸X-2张牌；你的手牌上限+X。（X为你的技能数）",
    ["sfofl_jizun"] = "极尊",
    [":sfofl_jizun"] = "觉醒技，当你脱离濒死状态时，你获得技能“清算”；若你已拥有“清算”，则改为回复体力至体力上限。",
    ["sfofl_qingsuan"] = "清算",
    [":sfofl_qingsuan"] = "主公技，锁定技，你对与你势力不同且本局游戏对你造成过伤害的角色使用牌无距离和次数限制。",
    ["sfofl_daohe"] = "道合",
    [":sfofl_daohe"] = "出牌阶段限一次，你可以令一名其他角色交给你至少一张手牌，然后其回复1点体力。",
    ["@sfofl_daohe"] = "道合：你交给 %src 至少一张手牌，然后回复1点体力。",
    ["sfofl_zhiyiz"] = "志异",
    [":sfofl_zhiyiz"] = "出牌阶段限一次，你可以令一名角色摸一张牌，然后你对其造成1点伤害。",
    --E7005T 决战巅峰


    ["sfofl_zhouji"] = "周姬[官盗]",
    ["&sfofl_zhouji"] = "周姬",
    ["#sfofl_zhouji"] = "江东的红莲",
    ["illustrator:sfofl_zhouji"] = "xerez",
    ["information:sfofl_zhouji"] = "E14001T 三国杀E14：至宝 ",
    ["@sfofl_yanmouz"] = "炎谋：你可以使用其中一张【火攻】或火【杀】",
    ["sfofl_yanmouz"] = "炎谋",
    [":sfofl_yanmouz"] = "当其他角色的【火攻】、火【杀】因弃置或判定而置入弃牌堆后，你可以获得之；当你获得牌后，你可以使用其中一张【火攻】或火【杀】。",
    ["sfofl_zhanyan"] = "绽焰",
    [":sfofl_zhanyan"] = "出牌阶段限一次，你可以令你攻击范围内的所有角色依次选择一项：1.你对其造成1点火焰伤害；2.将手牌或弃牌堆中的一张【火攻】或火【杀】置于牌堆顶。选择完成后，你摸X张牌（X为被选择次数较少的项被选择的次数）。",
    ["sfofl_yuhuo"] = "驭火",
    [":sfofl_yuhuo"] = "锁定技，防止你受到的火焰伤害；你手牌中的【火攻】和火【杀】不计入手牌上限。",
    ["@sfofl_zhanyan"] = "绽焰：将一张【火攻】或火【杀】置于牌堆顶，点“取消”则受到 %src 造成1点火焰伤害",
    --E14001T 三国杀E14：至宝

    ["sfofl_ehuan"] = "鄂焕[官盗]",
    ["&sfofl_ehuan"] = "鄂焕",
    ["#sfofl_ehuan"] = "牙门汉将",
    ["illustrator:sfofl_ehuan"] = "小强",
    ["information:sfofl_ehuan"] = "E9003T 三国杀E9匡鼎炎汉",
    ["sfofl_diwan"] = "敌万",
    [":sfofl_diwan"] = "每回合限一次，当你使用【杀】指定目标后，你可以摸X张牌（X为此牌的目标数）。",
    ["sfofl_suiluan"] = "随乱",
    [":sfofl_suiluan"] = "群势力技，你使用【杀】可以多指定至多两个目标，若如此做，此【杀】结算后，所有目标角色依次可以对你使用一张【杀】，当你以此法受到伤害后，你变更势力至蜀。",
    ["@sfofl_suiluan"] = "随乱：你可以为此 %src 额外指定至多两个目标",
    ["@sfofl_suiluan_target"] = "随乱：你可以对 %src 使用一张【杀】",
    ["@sfofl_conghan"] = "从汉：你可以对 %src 使用一张【杀】",
    ["sfofl_conghan"] = "从汉",
    [":sfofl_conghan"] = "蜀势力技，当一号位造成伤害后，你可以对受到此伤害的角色使用一张【杀】。",
    --E9003T 三国杀E9匡鼎炎汉

    ["sfofl_sunlang"] = "孙狼[官盗]",
    ["&sfofl_sunlang"] = "孙狼",
    ["#sfofl_sunlang"] = "恶惮远役",
    ["illustrator:sfofl_sunlang"] = "六道目",
    ["information:sfofl_sunlang"] = "S9003T 三国杀匡鼎炎汉",
    ["sfofl_benshi"] = "奔矢",
    [":sfofl_benshi"] = "锁定技，若你的装备区没有武器牌，你的攻击范围+1；你使用【杀】时，你攻击范围内所有角色均成为目标。",

    ["sfofl_guannin"] = "关宁[官盗]",
    ["&sfofl_guannin"] = "关宁",
    ["#sfofl_guannin"] = "承义秉文",
    ["illustrator:sfofl_guannin"] = "黯荧岛工作室",
    ["information:sfofl_guannin"] = "S9003T 三国杀匡鼎炎汉",
    ["@sfofl_longsong"] = "龙诵：你可以交给或获得一名其他角色一张红色牌，然后你本阶段视为拥有该角色的“出牌阶段”的技能直到你发动之。",
    ["sfofl_longsong"] = "龙诵",
    [":sfofl_longsong"] = "出牌阶段开始时，你可以交给或获得一名其他角色一张红色牌，然后你本阶段视为拥有该角色的“出牌阶段”的技能直到你发动之。\
    <font color=\"red\"><b>有的时候可能发动后不会失去，属正常bug，不用报给作者，修不了谢谢！！！</b></font>",

    ["sfofl_liuli"] = "刘理[官盗]",
    ["&sfofl_liuli"] = "刘理",
    ["#sfofl_liuli"] = "安平王",
    ["illustrator:sfofl_liuli"] = "黯荧岛工作室",
    ["information:sfofl_liuli"] = "S9003T 三国杀匡鼎炎汉",
    ["sfofl_dehua"] = "德化",
    [":sfofl_dehua"] = "锁定技，每轮开始时，你选择一种你可以使用的伤害牌的牌名，视为使用此牌，然后你不能再使用手牌中与之牌名相同的牌（你的手牌上限+X，X为因此不能使用的牌名数），然后若所有伤害牌的牌名均被选择过，你失去此技能，然后本局游戏你的伤害牌不计手牌上限。",
    ["@sfofl_dehua"] = "德化：你视为使用【%src】",
    ["sfofl_dehua_slash"] = "德化",
    ["sfofl_dehua_lose"] = "德化",
    ["sfofl_fuli-invoke"] = "你可以发动“抚黎”，令一名角色攻击范围减至0<br/> <b>操作提示</b>: 选择一名角色→点击确定<br/>",
    ["sfofl_fuli"] = "抚黎",
    [":sfofl_fuli"] = "出牌阶段限一次，你可以展示所有手牌，选择其中有的一种类别全部弃置，然后摸X张牌（X为所有弃置的牌的牌名称字数之合，且不能超过全场手牌数最多角色的手牌数），若你因此弃置了伤害牌，则你可以令一名角色攻击范围减至0直到你的下个回合开始。",
    --S9003T 三国杀E9匡鼎炎汉 三国杀匡鼎炎汉E9003 新版

    ["sfofl_lijue"] = "李傕[官盗]",
    ["&sfofl_lijue"] = "李傕",
    ["#sfofl_lijue"] = "奸谋恶勇",
    ["illustrator:sfofl_lijue"] = "小牛",
    ["information:sfofl_lijue"] = "E0044 兵临城下",
	["sfofl_langxi"] = "狼袭",
	[":sfofl_langxi"] = "准备阶段，你可以选择一名体力值小于你的角色，你对其造成X点伤害（X为你与其体力值之差，至多为2。）",
	["@langxi-invoke"] = "你可以发动“狼袭”",
    -- E0044兵临城下

    ["sfofl_2_caocao"] = "曹操[官盗]",
    ["&sfofl_2_caocao"] = "曹操",
    ["#sfofl_2_caocao"] = "谯水击蛟",
    ["illustrator:sfofl_2_caocao"] = "墨心绘意",
    ["information:sfofl_2_caocao"] = "E0033 兵合一处",
    ["sfofl_xiandao"] = "献刀",
    [":sfofl_xiandao"] = "每回合限一次，你赠予其他角色牌后，你可以令其本回合不能使用此花色的牌，然后若此牌为：锦囊牌，你摸两张牌；装备牌，你获得其另一张牌；武器牌，你对其造成1点伤害。",
    ["sfofl_sancai"] = "散财",
    [":sfofl_sancai"] = "出牌阶段限一次，你可以展示所有手牌，若均为同一类别，你可以将其中一张牌赠予其他角色。",
    ["sfofl_yibing"] = "义兵",
    [":sfofl_yibing"] = "当你于摸牌阶段外获得牌后，你可以将这些牌当无距离次数限制的【杀】使用，此【杀】结算结束前，你不能发动“义兵”。",-- 高达插结的权宜之策
    ["@sfofl_sancai"] = "散财：你可以将其中一张牌赠予其他角色",
    ["sfofl_yibing-invoke"] = "义兵：你可以将这些牌当无距离次数限制的【杀】使用（直接选择【杀】的目标）",
    --E0033 兵合一处

    ["sfofl_jiling"] = "纪灵[官盗]",
    ["&sfofl_jiling"] = "纪灵",
    ["#sfofl_jiling"] = "仲家的主将",
    ["illustrator:sfofl_jiling"] = "铁杵文化",
    ["information:sfofl_jiling"] = "E3005 至臻-权谋",
    ["sfofl_shuangren"] = "双刃",
    [":sfofl_shuangren"] = "出牌阶段，你可以与一名角色拼点。若你赢，你可以依次视为使用X张【杀】；若你没赢，本回合你的【杀】视为K点的【闪】（X为你本回合拼点赢的次数）。",
    ["sfofl_shuangren-slash"] = "双刃：你可以视为使用【杀】（第 %src 张，共 %dest 张）",
    ["#sfofl_shuangrenFilter"] = "双刃",
    --E3005 至臻-权谋

    ["sfofl_tianchuan"] = "田钏[官盗]",
    ["&sfofl_tianchuan"] = "田钏",
    ["#sfofl_tianchuan"] = "潜行之狐",
    ["illustrator:sfofl_tianchuan"] = "苍月白龙",
    ["information:sfofl_tianchuan"] = "E10全武将尊享 E71002T",
    ["sfofl_huying"] = "狐影",
    [":sfofl_huying"] = "锁定技，游戏开始时，你从游戏外获得两张【刑鞭】；其他角色死亡后，你从游戏外获得一张【刑鞭】。【刑鞭】不计入你的手牌上限；其他角色计算与你的距离+X（X为你场上的【刑鞭】数）。",
    ["@sfofl_qianjing"] = "潜荆：你可以将手牌中的一张【刑鞭】置入一名角色的任意装备栏",
    ["sfofl_qianjingEquipCard"] = "潜荆",
    ["sfofl_qianjingequip"] = "潜荆",
    ["sfofl_qianjingEquip"] = "潜荆",
    ["sfofl_qianjing"] = "潜荆",
    [":sfofl_qianjing"] = "你可以将场上或手牌中的一张【刑鞭】当不计次数的【杀】使用。当你造成或受到伤害后，你可以将手牌中的一张【刑鞭】置入一名角色的任意装备栏，若其为你，你摸一张牌。",
    ["sfofl_bianchi:losehp"] = "失去2点体力",
    ["sfofl_bianchi:usecard"] = "%src 观看你所有手牌并令你使用其中至多两张牌",
    ["@sfofl_bianchi"] = "鞭笞：你可以使用 %src 所有手牌其中至多两张牌",
    ["#sfofl_bianchi"] = "鞭笞",
    ["sfofl_bianchi"] = "鞭笞",
    -- [":sfofl_bianchi"] = "限定技，结束阶段，你可以弃置场上所有【刑鞭】，并令因此失去牌的其他角色依次选择一项：1.你操控其执行一个额外的出牌阶段且至多使用两张牌；2.失去2点体力",
    [":sfofl_bianchi"] = "限定技，结束阶段，你可以弃置场上所有【刑鞭】，并令因此失去牌的其他角色依次选择一项：1.你观看其所有手牌并令其使用其中至多两张牌；2.失去2点体力",
    ["_sfofl_xingbian"] = "刑鞭",
    ["sfofl_xingbian"] = "刑鞭",
    [":_sfofl_xingbian"] = "装备/任意装备栏 黑桃5\
锁定技，你装备区内每有一张【刑鞭】，你的攻击范围便+1；你的出牌阶段开始时，田钏指定一名其他角色，结束阶段，若你此回合未对其使用【杀】或未对其造成伤害，你对自己造成1点伤害。",
    [":sfofl_xingbian"] = "装备/任意装备栏 黑桃5\
锁定技，你装备区内每有一张【刑鞭】，你的攻击范围便+1；你的出牌阶段开始时，田钏指定一名其他角色，结束阶段，若你此回合未对其使用【杀】或未对其造成伤害，你对自己造成1点伤害。",
    ["_sfofl_xingbian_weapon"] = "刑鞭",
    [":_sfofl_xingbian_weapon"] = "装备牌·武器 \
    攻击范围：1\
    武器技能：锁定技，你装备区内每有一张【刑鞭】，你的攻击范围便+1；你的出牌阶段开始时，田钏指定一名其他角色，结束阶段，若你此回合未对其使用【杀】或未对其造成伤害，你对自己造成1点伤害。",
    ["_sfofl_xingbian_armor"] = "刑鞭",
    [":_sfofl_xingbian_armor"] = "装备/防具\
    防具技能：锁定技，你装备区内每有一张【刑鞭】，你的攻击范围便+1；你的出牌阶段开始时，田钏指定一名其他角色，结束阶段，若你此回合未对其使用【杀】或未对其造成伤害，你对自己造成1点伤害。",
    ["_sfofl_xingbian_offensivehorse"] = "刑鞭",
    [":_sfofl_xingbian_offensivehorse"] = "装备/坐骑\
    坐骑技能：锁定技，你装备区内每有一张【刑鞭】，你的攻击范围便+1；你的出牌阶段开始时，田钏指定一名其他角色，结束阶段，若你此回合未对其使用【杀】或未对其造成伤害，你对自己造成1点伤害。",
    ["_sfofl_xingbian_defensivehorse"] = "刑鞭",
    [":_sfofl_xingbian_defensivehorse"] = "装备/坐骑\
    坐骑技能：锁定技，你装备区内每有一张【刑鞭】，你的攻击范围便+1；你的出牌阶段开始时，田钏指定一名其他角色，结束阶段，若你此回合未对其使用【杀】或未对其造成伤害，你对自己造成1点伤害。",
    ["_sfofl_xingbian_treasure"] = "刑鞭",
    [":_sfofl_xingbian_treasure"] = "装备/宝物\
    宝物技能：锁定技，你装备区内每有一张【刑鞭】，你的攻击范围便+1；你的出牌阶段开始时，田钏指定一名其他角色，结束阶段，若你此回合未对其使用【杀】或未对其造成伤害，你对自己造成1点伤害。",
    --E10全武将尊享 E71002T

    ["sfofl_changshi"] = "常侍",
    ["sfofl_changshi-invoke"] = "你可以发动“常侍”<br/> <b>操作提示</b>: 选择一名有“常侍”标记角色→点击确定<br/>",
    [":sfofl_changshi"] = "游戏开始时，你获得一张“常侍”标记，当你失去“常侍”标记时，你减1点体力上限。<br>\
    拥有“常侍”标记的角色拥有以下技能：<br>1号位的弃牌阶段开始时，你可以摸一张牌，令其本回合手牌上限+1。当你受到致命伤害时，你可以弃置“常侍”标记，将此伤害转移给另一名有“常侍”标记的角色。",

    ["sfofl_zhangrang"] = "张让[官盗]",
    ["&sfofl_zhangrang"] = "张让",
    ["#sfofl_zhangrang"] = "妄尊帝父",
    ["illustrator:sfofl_zhangrang"] = "凡果",
    ["information:sfofl_zhangrang"] = "E11001T蛇年限定礼盒",
    ["sfofl_taoluan"] = "滔乱",
    [":sfofl_taoluan"] = "出牌阶段限X次，你可以将一张牌当任意基本牌或普通锦囊牌使用（X为场上有“常侍”标记的角色数，每种牌名每回合限一次）。",

    ["sfofl_zhaozhong"] = "赵忠[官盗]",
    ["&sfofl_zhaozhong"] = "赵忠",
    ["#sfofl_zhaozhong"] = "宦刑啄心",
    ["illustrator:sfofl_zhaozhong"] = "凡果",
    ["information:sfofl_zhaozhong"] = "E11001T蛇年限定礼盒",
    ["@sfofl_chiyan"] = "鸱嚥：你将任意张牌置于武将牌上直到回合结束",
    ["sfofl_chiyan"] = "鸱嚥",
    [":sfofl_chiyan"] = "当你使用【杀】指定一个目标后，你可以令目标角色和你依次将任意张牌置于各自的武将牌上直到回合结束，若其手牌数不大于你，其本回合受到的伤害+1；不小于你，其本回合不能使用手牌。",

    ["sfofl_sunzhang"] = "孙璋[官盗]",
    ["&sfofl_sunzhang"] = "孙璋",
    ["#sfofl_sunzhang"] = "唯利是从",
    ["illustrator:sfofl_sunzhang"] = "鬼画府",
    ["information:sfofl_sunzhang"] = "E11001T蛇年限定礼盒",
    ["@sfofl_zimou"] = "自谋：交给 %src 一张牌或弃置 %src 一张牌",
    ["sfofl_zimou"] = "自谋",
    [":sfofl_zimou"] = "锁定技，出牌阶段开始时，你令所有其他角色依次选择一项：1.交给你一张牌；2.弃置你一张牌，然后你对其造成1点伤害。",

    ["sfofl_bilan"] = "毕岚[官盗]",
    ["&sfofl_bilan"] = "毕岚",
    ["#sfofl_bilan"] = "糜财广筑",
    ["illustrator:sfofl_bilan"] = "鬼画府",
    ["information:sfofl_bilan"] = "E11001T蛇年限定礼盒",
    ["@sfofl_picai"] = "庀材：将一张手牌置于牌堆顶",
    ["sfofl_picai"] = "庀材",
    [":sfofl_picai"] = "出牌阶段限一次，你可以令至多X名角色依次将一张手牌置于牌堆顶，然后你亮出牌堆顶等量张牌：其中每有一种类型，你摸一张牌，若你摸了三张牌，因此失去牌的角色依次从亮出的牌中选择一张获得（X为你的体力值）。",

    ["sfofl_xiayun"] = "夏恽[官盗]",
    ["&sfofl_xiayun"] = "夏恽",
    ["#sfofl_xiayun"] = "言蔽朝尊",
    ["illustrator:sfofl_xiayun"] = "铁杵文化",
    ["information:sfofl_xiayun"] = "E11001T蛇年限定礼盒",
    ["@sfofl_yaozhuo"] = "谣诼：你可以与一名角色拼点",
    ["sfofl_yaozhuo"] = "谣诼",
    [":sfofl_yaozhuo"] = "出牌阶段限一次或当你受到伤害后，你可以与一名角色拼点：若你赢，其本回合手牌上限-2；若你没赢，你回复1点体力。当你拼点结算完成后，你获得对方的拼点牌。",

    ["sfofl_lisong"] = "栗嵩[官盗]",
    ["&sfofl_lisong"] = "栗嵩",
    ["#sfofl_lisong"] = "道察衕异",
    ["illustrator:sfofl_lisong"] = "铁杵文化",
    ["information:sfofl_lisong"] = "E11001T蛇年限定礼盒",
    ["sfofl_kuijidis"] = "窥机",
    ["#sfofl_kuiji"] = "窥机",
    ["sfofl_kuiji"] = "窥机",
    ["@sfofl_kuiji"] = "窥机：你可以弃置你与%src手牌中共计四张花色各不同的牌",
    [":sfofl_kuiji"] = "出牌阶段限一次，你可以观看一名其他角色的手牌，然后你可以弃置你与其共计四张花色各不相同的手牌。若如此做，弃置牌数较多的角色失去1点体力，弃置牌数较少的角色获得“仇海”直到本轮结束。",

    ["sfofl_duangui"] = "段珪[官盗]",
    ["&sfofl_duangui"] = "段珪",
    ["#sfofl_duangui"] = "断途避圣",
    ["illustrator:sfofl_duangui"] = "鬼画府",
    ["information:sfofl_duangui"] = "E11001T蛇年限定礼盒",
    ["@sfofl_chihe"] = "叱吓：展示两张手牌",
    ["sfofl_chihe"] = "叱吓",
    [":sfofl_chihe"] = "当你使用【杀】指定唯一目标/成为【杀】的唯一目标后，你可以摸两张牌并展示两张手牌，然后你与目标角色/使用者拼点：若你赢，此【杀】伤害+1；若你没赢，你弃置两张牌。",

    ["sfofl_guosheng"] = "郭胜[官盗]",
    ["&sfofl_guosheng"] = "郭胜",
    ["#sfofl_guosheng"] = "诱杀党朋",
    ["illustrator:sfofl_guosheng"] = "鬼画府",
    ["information:sfofl_guosheng"] = "E11001T蛇年限定礼盒",
    ["sfofl_niqu"] = "逆取",
    [":sfofl_niqu"] = "每回合限一次，当一名角色使用或打出【闪】结算后，你可以摸一张牌，然后视为对其使用一张【杀】。",

    ["sfofl_gaowang"] = "高望[官盗]",
    ["&sfofl_gaowang"] = "高望",
    ["#sfofl_gaowang"] = "蛇蝎为药",
    ["illustrator:sfofl_gaowang"] = "鬼画府",
    ["information:sfofl_gaowang"] = "E11001T蛇年限定礼盒",
    ["sfofl_miaoyu"] = "妙语",
    [":sfofl_miaoyu"] = "当一名角色回复体力后，你可以将牌堆顶一张牌交给其，当前回合结束时，其失去X点体力（X为你本回合发动此技能次数）。",

    ["sfofl_hankui"] = "韩悝[官盗]",
    ["&sfofl_hankui"] = "韩悝",
    ["#sfofl_hankui"] = "贪财好贿",
    ["illustrator:sfofl_hankui"] = "鬼画府",
    ["information:sfofl_hankui"] = "E11001T蛇年限定礼盒",
    ["@sfofl_xiaolu"] = "宵赂：视为对另一名角色使用一张仅指定该角色为目标的 %src",
    ["sfofl_xiaolu"] = "宵赂",
    [":sfofl_xiaolu"] = "每名其他角色的出牌阶段限一次，其可以交给你一张牌，然后其视为对另一名角色使用一张仅指定该角色为目标的普通锦囊牌。",
    ["sfofl_xiaoluAttach"] = "宵赂",
    [":sfofl_xiaoluAttach"] = "出牌阶段限一次，你可以交给 韩悝 一张牌，然后你视为对另一名角色使用一张仅指定该角色为目标的普通锦囊牌。",

    --E11001T蛇年限定礼盒

    ["sfofl_l_liuxie"] = "刘协[官盗]",
    ["&sfofl_l_liuxie"] = "刘协",
    ["#sfofl_l_liuxie"] = "汉献帝",
    ["illustrator:sfofl_l_liuxie"] = "鬼画府",
    ["information:sfofl_l_liuxie"] = "E7009T 君霸天下",
    ["sfofl_tianzel-invoke"] = "你可以发动“天择”<br/> <b>操作提示</b>: 选择一名体力值最大或手牌数最多的其他角色→点击确定<br/>",
    ["sfofl_tianzel"] = "天择",
    [":sfofl_tianzel"] = "当你成为【杀】的目标时，你可以弃置两张手牌（不足则全弃，无牌则不弃）并观看牌堆顶四张牌，然后获得其中两张牌。若如此做，你令一名体力值最大或手牌数最多的其他角色也如此做。",
    ["sfofl_zhaoyuan"] = "诏援",
    [":sfofl_zhaoyuan"] = "出牌阶段，你可以将所有手牌交给一名其他角色，然后令该角色与你指定的另一名角色拼点，拼点赢的角色视为使用一张无距离限制的【杀】。",
    --ov_zhuiting

    ["sfofl_l_liuhong"] = "刘宏[官盗]",
    ["&sfofl_l_liuhong"] = "刘宏",
    ["#sfofl_l_liuhong"] = "汉灵帝",
    ["illustrator:sfofl_l_liuhong"] = "匠人绘",
    ["information:sfofl_l_liuhong"] = "E7009T 君霸天下",
    ["sfofl_gezhi:recover"] = "回复1点体力",
    ["sfofl_gezhi:RemoveFromHistory"] = "使用下一张牌无次数限制",
    ["sfofl_gezhi:damage"] = "对一名其他角色造成1点伤害",
    ["@sfofl_gezhi"] = "革制：你可以重铸三种类别的牌各一张",
    ["sfofl_gezhi"] = "革制",
    [":sfofl_gezhi"] = "当你使用牌时，你可以重铸三种类别的牌各一张，然后选择一项：1.回复1点体力；2.使用下一张牌无次数限制；3.对一名其他角色造成1点伤害（每名角色限选一次）。",
    ["sfofl_julian"] = "聚敛",
    [":sfofl_julian"] = "主公技，结束阶段，其他群势力角色依次可以选择摸两张牌，若如此做，你获得其一张牌。",

    ["sfofl_l_yuanshao"] = "袁绍[官盗]",
    ["&sfofl_l_yuanshao"] = "袁绍",
    ["#sfofl_l_yuanshao"] = "高贵的名门",
    ["illustrator:sfofl_l_yuanshao"] = "琛·美弟奇",
    ["information:sfofl_l_yuanshao"] = "E7009T 君霸天下",
    ["sfofl_hefa"] = "合伐",
    [":sfofl_hefa"] = "出牌阶段限一次，你可以将任意张手牌当一张无次数限制、指定等量名角色为目标的【杀】使用，此【杀】伤害后，你将手牌补至手牌上限。",
    --xueyi

    ["sfofl_l_zhangjiao"] = "张角[官盗]",
    ["&sfofl_l_zhangjiao"] = "张角",
    ["#sfofl_l_zhangjiao"] = "天公将军",
    ["illustrator:sfofl_l_zhangjiao"] = "琛·美弟奇",
    ["information:sfofl_l_zhangjiao"] = "E7009T 君霸天下",
    ["sfofl_huanlei-invoke"] = "你可以发动“唤雷”<br/> <b>操作提示</b>: 选择一名其他角色→点击确定<br/>",
    ["sfofl_huanlei"] = "唤雷",
    [":sfofl_huanlei"] = "当你使用或打出【闪】、【闪电】或不因此技能进行判定结算结束后，你可以令一名其他角色进行判定，若结果为♠，你对其造成2点雷电伤害；不为♠，你获得其一张手牌。",
    ["@sfofl_xiandaoz-card"] = "请发动“%dest”来修改 %src 的“%arg”判定",
    ["sfofl_xiandaoz"] = "显道",
    [":sfofl_xiandaoz"] = "当一名角色的判定牌生效前，你可以用一张黑色牌替换之，然后摸一张牌。",
    --huangtian

    ["sfofl_l_sunquan"] = "孙权[官盗]",
    ["&sfofl_l_sunquan"] = "孙权",
    ["#sfofl_l_sunquan"] = "年轻的贤君",
    ["illustrator:sfofl_l_sunquan"] = "大鬼",
    ["information:sfofl_l_sunquan"] = "E7009T 君霸天下",
    ["sfofl_shenglv"] = "衡虑",
    [":sfofl_shenglv"] = "出牌阶段，你可以失去X点体力，弃置任意张手牌，将其中任意张【桃】分配给任意角色，然后摸等量+X张牌（X为你本回合发动此技能次数-1）。",
    --jiuyuan

    ["sfofl_l_sunce"] = "孙策[官盗]",
    ["&sfofl_l_sunce"] = "孙策",
    ["#sfofl_l_sunce"] = "江东的小霸王",
    ["illustrator:sfofl_l_sunce"] = "M云涯",
    ["information:sfofl_l_sunce"] = "E7009T 君霸天下",
    ["sfofl_jiang"] = "激昂",
    [":sfofl_jiang"] = "当你使用红色牌时，你可以摸一张牌。",
    ["sfofl_zhiyang"] = "志扬",
    [":sfofl_zhiyang"] = "你的红色拼点牌点数视为K。当你受到伤害后，你可以令伤害来源对你发动两次“制霸”。",
    --zhiba

    ["sfofl_l_caopi"] = "曹丕[官盗]",
    ["&sfofl_l_caopi"] = "曹丕",
    ["#sfofl_l_caopi"] = "霸业的继承者",
    ["illustrator:sfofl_l_caopi"] = "宋其金",
    ["information:sfofl_l_caopi"] = "E7009T 君霸天下",
    ["sfofl_cuanzun"] = "篡尊",
    [":sfofl_cuanzun"] = "当其他角色死亡时，你可以获得其所有牌并回复1点体力。",
    ["sfofl_liufangc"] = "流放",
    [":sfofl_liufangc"] = "<font color=\"green\"><b>出牌阶段限一次</b></font>或当你受到伤害后，你可以令一名角色摸X张牌并翻面，若X大于1，其进行一次【闪电】判定（X为你已损失的体力值）。",
    --songwei

    ["sfofl_l_caocao"] = "曹操[官盗]",
    ["&sfofl_l_caocao"] = "曹操",
    ["#sfofl_l_caocao"] = "魏武帝",
    ["illustrator:sfofl_l_caocao"] = "Town",
    ["information:sfofl_l_caocao"] = "E7009T 君霸天下",
    ["sfofl_xiongtu"] = "雄图",
    [":sfofl_xiongtu"] = "当你的体力值变化后，你可以从牌堆、弃牌堆、场上、处理区各获得一张伤害牌。",
    --hujia

    ["sfofl_l_liushan"] = "刘禅[官盗]",
    ["&sfofl_l_liushan"] = "刘禅",
    ["#sfofl_l_liushan"] = "无为的真命主",
    ["illustrator:sfofl_l_liushan"] = "凝聚永恒",
    ["information:sfofl_l_liushan"] = "E7009T 君霸天下",    
    ["sfofl_fuxiang"] = "付相",
    [":sfofl_fuxiang"] = "出牌阶段开始前，你可以跳过此阶段，然后弃牌阶段结束时，你可以将此阶段进入弃牌堆的牌交给一名其他角色，其获得一个额外回合。",
    ["@sfofl_lezong"] = "乐纵：使用者需交给你一张 %src，否则 %dest 无效",
    ["sfofl_lezong"] = "乐纵",
    [":sfofl_lezong"] = "锁定技，当你成为【杀】或延时锦囊牌的目标时，使用者需交给你一张相同类别的手牌，否则此牌无效。",
    --ruoyu

    ["sfofl_l_liubei"] = "刘备[官盗]",
    ["&sfofl_l_liubei"] = "刘备",
    ["#sfofl_l_liubei"] = "乱世的枭雄",
    ["illustrator:sfofl_l_liubei"] = "NOVART",
    ["information:sfofl_l_liubei"] = "E7009T 君霸天下",  
    ["sfofl_renwang"] = "仁望",
    [":sfofl_renwang"] = "出牌阶段，你可以将至少两张牌交给一名其他角色，然后回复1点体力且本回合出牌阶段使用【杀】次数上限+1。",
    --jijiang
    --E7009T 君霸天下

    
	["quaxiaojiang"] = "曲阿小将",
	["#quaxiaojiang"] = "神人何惧",
    ["illustrator:quaxiaojiang"] = "荆芥",
    ["information:quaxiaojiang"] = "E9004T 全武将太虚环境",  
	["yingzhen"] = "应阵",
	[":yingzhen"] = "游戏开始时，你选择一名其他角色，然后你与其的一名相邻角色交换座次并与其依次执行一个额外回合。",
	["yuanjue"] = "援绝",
	[":yuanjue"] = "转换技，你可以跳过摸牌阶段，①所有角色的基本牌均视为无次数且不计入次数的【杀】直到此技能转换②你与其他角色互相计算距离视为1且你获得“同忾”直到此技能转换。",
	[":yuanjue1"] = "转换技，你可以跳过摸牌阶段，①所有角色的基本牌均视为无次数且不计入次数的【杀】直到此技能转换<font color=\"#01A5AF\"><s>②你与其他角色互相计算距离视为1且你获得“同忾”直到此技能转换</s></font>。",
	[":yuanjue2"] = "转换技，你可以跳过摸牌阶段，<font color=\"#01A5AF\"><s>①所有角色的基本牌均视为无次数且不计入次数的【杀】直到此技能转换</s></font>②你与其他角色互相计算距离视为1且你获得“同忾”直到此技能转换。",
	["aoyong"] = "鏖勇",
	[":aoyong"] = "持恒技，当你不因此技能摸牌后，你可以选择一项：1.摸一张牌；2.回复1点体力；3.使用一张牌。背水：失去1点体力上限。",
	["tongkai"] = "同忾",
	[":tongkai"] = "当一名角色成为伤害牌的目标后，若你与其距离1以内，你可以摸一张牌，然后交给其一张牌并展示之，若为装备牌，其可以使用之。",
	["yingzhen0"] = "应阵：请选择一名其他角色，与其执行额外回合",
	["yingzhen1"] = "应阵：请选择与一名角色交换座次",
	["aoyong1"] = "摸一张牌",
	["aoyong2"] = "回复1点体力",
	["aoyong3"] = "使用一张牌",
	["aoyong:beishui"] = "背水：失去1点体力上限，执行前面所有项",
	["tongkai0"] = "同忾：请将一张牌交给%src",
	["tongkai1"] = "同忾：你可以使用【%src】",
    --E9004T E9 全武将太虚环境

    ["mengdebenchu"] = "曹操&袁绍",
	["#mengdebenchu"] = "总角之交",
    ["illustrator:mengdebenchu"] = "荆芥",
    ["information:mengdebenchu"] = "E15001T 至臻全武将典藏OL",  
	["guibei"] = "贵卑",
	[":guibei"] = "锁定技，游戏开始时，你摸4张牌，然后你与一号位的上家交换座次。",
	["jiechu"] = "劫出",
	[":jiechu"] = "转换技，①出牌阶段，你可以视为使用一张【顺手牵羊】，结算后成为目标的角色可以对你使用一张【杀】②当你成为【杀】的目标时，你可以弃置一张手牌改变【杀】的花色和属性。",
	[":jiechu1"] = "转换技，①出牌阶段，你可以视为使用一张【顺手牵羊】，结算后成为目标的角色可以对你使用一张【杀】<font color=\"#01A5AF\"><s>②当你成为【杀】的目标时，你可以弃置一张手牌改变【杀】的花色和属性</s></font>。",
	[":jiechu2"] = "转换技，<font color=\"#01A5AF\"><s>①出牌阶段，你可以视为使用一张【顺手牵羊】，结算后成为目标的角色可以对你使用一张【杀】</s></font>②当你成为【杀】的目标时，你可以弃置一张手牌改变【杀】的花色和属性。",
	["daojue"] = "道抉",
	[":daojue"] = "使命技，当你首次受到一种花色造成的伤害时，你防止此伤害，然后选择一项：1.获得造成伤害的牌；2.使用一张指定所有目标的【杀】。\n成功：你因此获得至少3张牌后，失去“劫出”，变更势力至“魏”，然后获得“清正”、“治暗”和“护驾”。\n失败：你因此使用至少3张牌后，失去“劫出”，变更势力至“群”，然后获得“神离”、“诛逆”和“士首”",
	["tuonan"] = "脱难",
	[":tuonan"] = "限定技，你陷入濒死状态时，你可以回复1点体力，然后失去一个有标签的技能。",
	["jiechu0"] = "劫出：你可以对%src使用【杀】",
	["jiechu1"] = "你可以发动“劫出”弃置一张牌改变这张【杀】的花色和属性",
	["daojue0"] = "道抉：你可以使用【杀】或获得造成伤害的【杀】",
    --三国杀E15 至臻全武将典藏OL E15001T

    ["sfofl_guozhao"] = "郭照[官盗]",
    ["&sfofl_guozhao"] = "郭照",
    ["#sfofl_guozhao"] = "碧海青天",
    ["illustrator:sfofl_guozhao"] = "张晓溪",
    ["information:sfofl_guozhao"] = "E8002全武将大合集奢华版（神张飞盒）",
    ["sfofl_pianchong"] = "偏宠",
    [":sfofl_pianchong"] = "摸牌阶段，你可以改为获得牌堆底的一张牌，此牌倒置（标记为“偏宠”），然后你摸一张牌，直到你下回合开始：你每失去一张倒置牌后，摸一张牌；你每失去一张未倒置的手牌后，获得牌堆底的一张牌并倒置。",
    ["sfofl_zunwei:handcard"] = "将手牌数摸至 %src ",
    ["sfofl_zunwei:equip"] = "随机使用牌堆中的装备牌，直到你装备区牌数为 %src ",
    ["sfofl_zunwei:hp"] = "将体力回复至 %src ",
    ["sfofl_zunwei"] = "尊位",
    [":sfofl_zunwei"] = "出牌阶段限一次，你可以选择一项，然后移除该选项：1.将手牌数摸至全场最多；2.随机使用牌堆中的装备牌，直到你装备区牌数为全场最多；3.将体力回复至全场最多。",
    --還以為是線下化 但還有使用牌堆中的装备牌是怎麼回事
    --E8002全武将大合集奢华版（神张飞盒）

    ["sfofl_sunhanhua"] = "孙寒华[官盗]",
    ["&sfofl_sunhanhua"] = "孙寒华",
    ["#sfofl_sunhanhua"] = "挣绽的青莲",
    ["illustrator:sfofl_sunhanhua"] = "匠人绘",
    ["information:sfofl_sunhanhua"] = "E0047 三国杀移动版精装大合集",
    ["sfofl_chongxu:same"] = "相同",
    ["sfofl_chongxu:notsame"] = "不同",
    ["sfofl_chongxu:obtain"] = "获得这两张牌",
    ["sfofl_chongxu"] = "冲虚",
    [":sfofl_chongxu"] = "出牌阶段限一次，你可以猜测牌堆顶两张牌颜色是否相同并展示之，若你猜对，你可以获得这两张牌或修改“妙剑”或修改“莲华”，否则你可以获得其中的一张牌，然后将另一张牌置于牌堆顶。",
    ["sfofl_miaojing"] = "妙剑",
    [":sfofl_miaojing"] = "出牌阶段限一次，你可以将一张【杀】当做刺【杀】使用，或将一张锦囊牌当做【无中生有】使用。<br>二级：出牌阶段限一次，你可以将一张基本牌当做刺【杀】使用，或将一张非基本牌当做【无中生有】使用。\
    <br>三级：出牌阶段限一次，你可以视为使用了一张刺【杀】或视为使用了一张【无中生有】。",
    [":sfofl_miaojing1"] = "出牌阶段限一次，你可以将一张基本牌当做刺【杀】使用，或将一张非基本牌当做【无中生有】使用。\
    <br>三级：出牌阶段限一次，你可以视为使用了一张刺【杀】或视为使用了一张【无中生有】。",
    [":sfofl_miaojing2"] = "出牌阶段限一次，你可以视为使用了一张刺【杀】或视为使用了一张【无中生有】。",
    ["@sfofl_lianhua"] = "莲华：你需弃置一张牌，否则取消 %dest 成为 %src 的目标",
    ["sfofl_lianhua"] = "莲华",
    [":sfofl_lianhua"] = "你成为其他角色使用【杀】的目标时，你摸一张牌。\
    <br>二级：你成为其他角色使用【杀】的目标时，你摸一张牌，然后进行一次判定，若判定结果为黑桃，则取消之。\
    <br>三级：你成为其他角色使用【杀】的目标时，你摸一张牌，除非该角色弃置一张牌，否则取消之。",
    [":sfofl_lianhua1"] = "你成为其他角色使用【杀】的目标时，你摸一张牌，然后进行一次判定，若判定结果为黑桃，则取消之。\
    <br>三级：你成为其他角色使用【杀】的目标时，你摸一张牌，除非该角色弃置一张牌，否则取消之。",
    [":sfofl_lianhua2"] = "你成为其他角色使用【杀】的目标时，你摸一张牌，除非该角色弃置一张牌，否则取消之。",

    --E0047 三国杀移动版精装大合集

    ["sfofl_liuyou"] = "刘繇[官盗]",
    ["&sfofl_liuyou"] = "刘繇",
    ["#sfofl_liuyou"] = "宗英外镇",
    ["information:sfofl_liuyou"] = "E0051 尊享版2023",
    ["@sfofl_kannan"] = "戡难：你可以对 %src 使用一张【杀】",
    ["sfofl_kannan:up"] = "点数+ %src",
    ["sfofl_kannan:down"] = "点数- %src",
    ["sfofl_kannan"] = "戡难",
    [":sfofl_kannan"] = "出牌阶段每名角色限一次，你可以与一名角色拼点，若你赢，此阶段“戡难” 失效；当你拼点后，赢的角色视为使用一张酒；当你的拼点牌翻开时，你可以令此牌点数+X或-X（ X 为埸上角色的势力数）；当你对本回合使用过酒的其他角色造成伤害时，此伤害+1，结算完成后，其可以对你使用一张【杀】。",
    ["#sfofl_kannanUp"] = "%from 发动了“<font color=\"yellow\"><b>戡难</b></font>”，拼点牌点数增加为 %arg",
	["#sfofl_kannanDown"] = "%from 发动了“<font color=\"yellow\"><b>戡难</b></font>”，拼点牌点数减小为 %arg",

    ["sfofl_fanjiangzhangda"] = "范疆张达[官盗]",
    ["&sfofl_fanjiangzhangda"] = "范疆张达",
    ["#sfofl_fanjiangzhangda"] = "暗潮决堰",
    ["information:sfofl_fanjiangzhangda"] = "E0051 尊享版2023",
    ["sfofl_yuanchou"] = "怨仇",
    [":sfofl_yuanchou"] = "锁定技，当你使用牌指定目标后，此牌无视其相同颜色的防具、不能被颜色不同的牌抵消；当你成为牌的目标后，此牌无视你相同颜色的防具、不能被颜色不同的牌抵消。",
    --决生

    ["sfofl_huangquan"] = "黄权[官盗]",
    ["&sfofl_huangquan"] = "黄权",
    ["#sfofl_huangquan"] = "道绝殊途",
    ["information:sfofl_huangquan"] = "E0051 尊享版2023",
    --点虎
    ["@sfofl_jianji"] = "谏计：你可以对“点虎”角色无距离限制使用 %src",
    ["@sfofl_jianji_slash"] = "谏计：你可以将 %src 当【杀】使用",
    ["sfofl_jianji"] = "谏计",
    [":sfofl_jianji"] = "出牌阶段限一次，你可以令一名其他角色摸一张牌然后该角色可以对“点虎”角色无距离限制使用此牌，或将此牌当【杀】使用。",

    ["sfofl_mayunlu"] = "马云騄[官盗]",
    ["&sfofl_mayunlu"] = "马云騄",
    ["#sfofl_mayunlu"] = "剑胆琴心",
    ["information:sfofl_mayunlu"] = "E0051 尊享版2023",
    --马术
    ["@sfofl_fengpo"] = "凤魄：你可以对 %src 发动凤魄",
    ["sfofl_fengpo:sfofl_fengpo1"] = "摸2x %src 张牌",
    ["sfofl_fengpo:sfofl_fengpo2"] = "此牌造成的伤害+ %src",
    ["sfofl_fengpo"] = "凤魄",
    [":sfofl_fengpo"] = "出牌阶段限一次，当你使用【杀】或伤害类锦囊牌指定唯一目标后，你可以弃置任意张方片手牌，然后选择一项：1.摸2X张牌；2.此牌造成的伤害+X（X为你弃置的牌数）。",

    ["sfofl_liyan"] = "李严[官盗]",
    ["&sfofl_liyan"] = "李严",
    ["#sfofl_liyan"] = "矜风流务",
    ["information:sfofl_liyan"] = "E0051 尊享版2023",
    ["sfofl_duliang:judge"] = "%src 进行判定，若结果为红色，其摸两张牌",
    ["sfofl_duliang:draw"] = "令 %src 于下个摸牌阶段多摸一张牌",
    ["sfofl_duliang"] = "督粮",
    [":sfofl_duliang"] = "出牌阶段限一次，你可以获得一名其他角色的一张手牌，然后选择一项：1.该角色进行判定，若结果为红色，其摸两张牌；2.令其于其下个摸牌阶段多摸一张牌。",
    --腹鳞

    ["sfofl_tianyu"] = "田豫[官盗]",
    ["&sfofl_tianyu"] = "田豫",
    ["#sfofl_tianyu"] = "威震北疆",
    ["information:sfofl_tianyu"] = "E0051 尊享版2023",
    --扫狄
    ["sfofl_zhuitao"] = "追讨",
    [":sfofl_zhuitao"] = "每轮开始时，你可以选择一名其他角色，本轮你与其的距离-1。",

    --[[
        杜畿 卧镇京畿
        安东 每回合限一次，当你受到其他角色造成的伤害时，你可以观看其手牌，弃置其中一至两张牌，然后你获得弃置的红桃牌，该角色摸X张牌，若X为2，你防止此伤害（X为你弃置的非红桃牌数）。
        新服界杜畿 应势
    ]]


    ["sfofl_2_caopi"] = "曹丕[官盗]",
    ["&sfofl_2_caopi"] = "曹丕",
    ["#sfofl_2_caopi"] = "霸业的继承者",
    ["information:sfofl_2_caopi"] = "E0051 尊享版2023",
    ["sfofl_xingshanglord"] = "行殇",
    ["sfofl_xingshang"] = "行殇",
    [":sfofl_xingshang"] = "其他角色死亡时，你可以获得其所有牌，若你不为主公，你可以改为回复1点体力。",
    ["sfofl_fangzhu-invoke"] = "你可以发动“放逐”<br/> <b>操作提示</b>: 选择一名其他角色→点击确定<br/>",
    ["@sfofl_fangzhu"] = "放逐: %src令你翻面并摸X张牌，你可以改为弃置X张牌并失去1点体力",
    ["sfofl_fangzhu"] = "放逐",
    [":sfofl_fangzhu"] = "当你受到伤害后，你可以令一名其他角色翻面并摸X张牌，若你不为主公，该角色可以改为弃置X张牌并失去1点体力（X为你已损失的体力值）。",
    --颂威
    --E0051 尊享版2023

    ["sfofl_zhangchangpu"] = "张昌蒲[官盗]",
    ["&sfofl_zhangchangpu"] = "张昌蒲",
    ["#sfofl_zhangchangpu"] = "矜严明训",
    ["information:sfofl_zhangchangpu"] = "KT005：三国杀K系列-全武将大合集2022",
    --严教
    ["sfofl_shengshen"] = "省身",
    [":sfofl_shengshen"] = "当你受到伤害后，你可以摸X张牌，然后令你下一次展示的牌数+X。 (X为你已损失的体力值且严教累计至多+6)",

    ["sfofl_puyuan"] = "蒲元[官盗]",
    ["&sfofl_puyuan"] = "蒲元",
    ["#sfofl_puyuan"] = "淬炼百兵",
    ["information:sfofl_puyuan"] = "KT005：三国杀K系列-全武将大合集2022",
    --天匠
    ["sfofl_zhuren"] = "铸刃",
    [":sfofl_zhuren"] = "出牌阶段限一次，你可以弃置一张手牌并进行判定，若判定结果点数不大于此牌，你获得一张“铸刃”打造的武器牌（花色决定武器名称，点数决定成功率）",

    ["sfofl_gaolan"] = "高览[官盗]",
    ["&sfofl_gaolan"] = "高览",
    ["#sfofl_gaolan"] = "名门的峦柱",
    ["information:sfofl_gaolan"] = "KT005：三国杀K系列-全武将大合集2022",
    ["@xiying_CardLimitation"] = "袭营：你可以选择弃置一张牌或本回合内不能使用或打出牌",
    ["@sfofl_xiying"] = "袭营：你可以弃置一张牌",
    ["sfofl_xiying"] = "袭营",
    [":sfofl_xiying"] = "出牌阶段开始时，你可以弃置一张牌并令所有其他角色选择一项：弃置一张牌；本回合内不能使用或打出牌；若如此做且当前回合结束时，若你本回合造成过伤害，你可以获得弃牌堆中的一张【杀】或伤害类锦囊。",

    ["sfofl_duyu"] = "杜预[官盗]",
    ["&sfofl_duyu"] = "杜预",
    ["#sfofl_duyu"] = "文成武德",
    ["information:sfofl_duyu"] = "KT005：三国杀K系列-全武将大合集2022",
    --武库
    ["sfofl_sanchen"] = "三陈",
	[":sfofl_sanchen"] = "觉醒技，结束阶段开始时，若你有至少三枚“武库”标记，你加1点体力上限，回复1点体力，然后获得技能“灭吴”。",
    ["sfofl_miewu"] = "灭吴",
    [":sfofl_miewu"] = "每名角色的回合限一次，你可以移去一个“武库”，视为使用或打出任意一张基本牌或普通锦囊牌，若如此做，并摸一张牌。",

    ["sfofl_xuchu"] = "许褚[官盗]",
    ["&sfofl_xuchu"] = "许褚",
    ["#sfofl_xuchu"] = "虎痴",
    ["information:sfofl_xuchu"] = "KT005：三国杀K系列-全武将大合集2022",
    ["sfofl_luoyi"] = "裸衣",
    [":sfofl_luoyi"] = "摸牌阶段，你可以少摸任意张牌并展示牌堆顶两倍的牌，然后你可以获得其中的基本牌、武器牌或【决斗】。若如此做，你为伤害来源的【杀】或【决斗】造成的伤害+1直到你的下回合开始。",

    --KT005：三国杀K系列-全武将大合集2022

    ["sfofl_xiacaopi"] = "俠曹丕[官盗]",
    ["&sfofl_xiacaopi"] = "俠曹丕",
    ["#sfofl_xiacaopi"] = "弃旧学新",
    ["information:sfofl_xiacaopi"] = "E1004 三国杀E10:一将成名精选合集",
    ["@sfofl_qinyi"] = "勤艺:你可以视为使用一张未以此法使用的基本牌或普通锦囊牌",
    ["@sfofl_qinyiUse"] = "勤艺:你可以视为使用 %src",
    ["sfofl_qinyi"] = "勤艺",
    [":sfofl_qinyi"] = "每回合你首次造成或受到伤害后，你可以视为使用一张未以此法使用的基本牌或普通锦囊牌。",
    ["sfofl_jixin"] = "技新",
    [":sfofl_jixin"] = "每当你使用你本局游戏未使用过的牌后，你可以摸X张牌并展示，令这些牌不计距离次数和手牌上限（X为此技能本轮使用次数）。",
    ["sfofl_jiwei"] = "继魏",
    [":sfofl_jiwei"] = "觉醒技，每个回合结束时，若本轮“技新”发动次数不小于1号位的当前体力值，你增加1点体力上限并回复所有体力且挑选5个魏势力主公技获得。",

    --E1004 三国杀E10:一将成名精选合集

    ["sfofl_peachchan"] = "小桃[官盗]",
    ["&sfofl_peachchan"] = "小桃",
    ["#sfofl_peachchan"] = "虚拟偶像",
    ["illustrator:sfofl_peachchan"] = "匠人绘",
    ["information:sfofl_peachchan"] = "SX015天书乱斗",
    ["sfofl_taoyan"] = "桃宴",
    [":sfofl_taoyan"] = "回合开始时，你可以令至多两名其他角色各摸一张牌并从游戏外获得一张【桃】。",
    ["_peach"] = "桃",
	[":_peach"] = "基本牌<br/><b>时机</b>：出牌阶段，对已受伤的你使用；一名角色处于濒死状态时对其使用。<br/><b>效果</b>：目标回复1点体力。",
    ["sfofl_yanli"] = "妍丽",
    [":sfofl_yanli"] = "每轮限一次，当一名角色于你的回合外进入濒死状态时，你可以令其回复至1点体力，然后其摸一张牌。",
    
    ["sfofl_jinkchan"] = "小闪[官盗]",
    ["&sfofl_jinkchan"] = "小闪",
    ["#sfofl_jinkchan"] = "虚拟偶像",
    ["illustrator:sfofl_jinkchan"] = "匠人绘",
    ["information:sfofl_jinkchan"] = "SX015天书乱斗",
    ["sfofl_shanwu"] = "闪舞",
    [":sfofl_shanwu"] = "当其他角色成为【杀】的目标时，你可以弃置一张【闪】，取消之。",
    ["sfofl_xianli"] = "娴丽",
    [":sfofl_xianli"] = "每回合限两次，当你失去【闪】时，你可以获得当前回合角色的一张牌。",

    ["sfofl_slashchan"] = "小杀[官盗]",
    ["&sfofl_slashchan"] = "小杀",
    ["#sfofl_slashchan"] = "虚拟偶像",
    ["illustrator:sfofl_slashchan"] = "匠人绘",
    ["information:sfofl_slashchan"] = "SX015天书乱斗",
    ["sfofl_guisha"] = "瑰杀",
    [":sfofl_guisha"] = "当其他角色使用【杀】时，你可以弃置一张牌，令此【杀】不计入次数且造成伤害+1。",
    ["sfofl_shuli"] = "姝丽",
    [":sfofl_shuli"] = "每回合限两次，当其他角色使用【杀】造成伤害后，你可以与其各摸一张牌。",

    ["sfofl_analepticchan"] = "小酒[官盗]",
    ["&sfofl_analepticchan"] = "小酒",
    ["#sfofl_analepticchan"] = "虚拟偶像",
    ["illustrator:sfofl_analepticchan"] = "匠人绘",
    ["information:sfofl_analepticchan"] = "SX015天书乱斗",
    ["sfofl_meiniang"] = "美酿",
    [":sfofl_meiniang"] = "其他角色的出牌阶段开始时，你可以令其视为使用一张无次数限制的【酒】。",
    ["sfofl_yaoli"] = "媱丽",
    [":sfofl_yaoli"] = "当其他角色于其出牌阶段使用【酒】后，你可以令其本回合使用的下一张【杀】不可被响应且可以额外指定一个目标。",


    ["sfofl_indulgencechan"] = "小乐[官盗]",
    ["&sfofl_indulgencechan"] = "小乐",
    ["#sfofl_indulgencechan"] = "虚拟偶像",
    ["illustrator:sfofl_indulgencechan"] = "匠人绘",
    ["information:sfofl_indulgencechan"] = "SX015天书乱斗",
    ["sfofl_leyu"] = "乐虞",
    [":sfofl_leyu"] = "一名角色的回合开始时，你可以弃置三张牌令其进行判定，若结果不为♥，其跳过本回合的出牌阶段。",
    ["sfofl_yuanli"] = "媛丽",
    [":sfofl_yuanli"] = "当一名角色跳过出牌阶段时，你可以与一名其他角色各摸一张牌。",
    --SX015天书乱斗

--E1005 E10于赤壁星空下契约！闪耀战姬们的魔法乱舞
    --[[
    变身技：当你满足技能描述的条件时，你获得对应指示物。当该指示物达到上限时，你可以在对应的时间点进入变身状态；当该指示物消耗至0时，你退出变身状态。

    进入变身状态：你弃置判定区所有牌，用新的武将牌替换原武将牌，两张武将牌的体力值互相单独计算。

    退出变身状态：用原武将牌替换当前武将牌，两张武将牌的体力值互相单独计算。

    吟唱：你需念出武将牌下的引文，然后才能执行技能后续效果。]]


    ["sfofl_magic_zhenji"] = "甄姬[官盗]",
    ["&sfofl_magic_zhenji"] = "甄姬",
    ["#sfofl_magic_zhenji"] = "薄幸的美人",
    ["illustrator:sfofl_magic_zhenji"] = "",
    ["information:sfofl_magic_zhenji"] = "E10于赤壁星空下契约！闪耀战姬们的魔法乱舞",
    --洛神：准备阶段，你可以进行判定，若结果为黑色，你获得该判定牌，然后你可重复此流程；你的手牌上限+X（X为你本回合因“洛神”获得的牌数）。 官正線下
    --倾国：你可以将一张黑色手牌当做【闪】使用或打出。
    ["sfofl_moli_zhenji"] = "魔力",
    [":sfofl_moli_zhenji"] = "变身技（0/5），当你于摸牌阶段外获得牌时，你可以展示之，若为黑色，你获得1点魔力，结束阶段，你进行吟唱并变身。",
    ["sfofl_magic_zhenji_henshin"] = "冻住，不许走！",

    ["sfofl_magic_zhenji_change"] = "甄姬[闪耀战姬]",
    ["&sfofl_magic_zhenji_change"] = "甄姬",
    ["#sfofl_magic_zhenji_change"] = "闪耀战姬",
    ["illustrator:sfofl_magic_zhenji_change"] = "",
    ["information:sfofl_magic_zhenji_change"] = "E10于赤壁星空下契约！闪耀战姬们的魔法乱舞",
    ["sfofl_jinghong"] = "惊鸿",
    [":sfofl_jinghong"] = "称号与你相同的角色不因此技能获得牌后，你可以消耗1点魔力令其判定，若为黑色牌其获得并重复之；你的黑色牌无次数限制且不计入手牌上限。",
    ["sfofl_youlong"] = "游龙",
    [":sfofl_youlong"] = "锁定技，你造成的伤害改为冰冻伤害，受到冰冻伤害的角色直到其下个回合结束：摸牌数-1，你+1，且计算距离时+1，你-1，且不能响应你使用的牌。",
    ["sfofl_haiyou"] = "海佑",
    [":sfofl_haiyou"] = "称号与你相同的角色成为牌的目标时，你可以消耗1点魔力令之无效。",


    ["sfofl_magic_woguotai"] = "吴国太[官盗]",
    ["&sfofl_magic_woguotai"] = "吴国太",
    ["#sfofl_magic_woguotai"] = "武烈皇后",
    ["illustrator:sfofl_magic_woguotai"] = "",
    ["information:sfofl_magic_woguotai"] = "E10于赤壁星空下契约！闪耀战姬们的魔法乱舞",
    --甘露：出牌阶段限一次，你可以令两名角色交换装备区里的牌。若X大于你已损失的体力值，你须在选择角色时弃置X张牌（X为其装备区里的牌数之差）。
    --补益：当一名角色进入濒死状态时，你可以选择其一张牌，若此牌不为基本牌，则其弃置此牌，然后回复1点体力。
    ["sfofl_moli_woguotai"] = "魔力",
    [":sfofl_moli_woguotai"] = "变身技（0/5），游戏开始时或当你场上的牌发生变化时，你获得1点魔力，当你失去牌时，你进行吟唱并变身。",
    ["sfofl_magic_woguotai_henshin"] = "降临吧——属于我的真实姿态！",

    ["sfofl_magic_woguotai_change"] = "吴国太[闪耀战姬]",
    ["&sfofl_magic_woguotai_change"] = "吴国太",
    ["#sfofl_magic_woguotai_change"] = "闪耀战姬",
    ["illustrator:sfofl_magic_woguotai_change"] = "",
    ["information:sfofl_magic_woguotai_change"] = "E10于赤壁星空下契约！闪耀战姬们的魔法乱舞",
    ["sfofl_fengshou-invoke"] = "你可以发动“凤守”<br/> <b>操作提示</b>: 选择距离为1的角色→点击确定<br/>",
    ["@sfofl_fengshou"] = "凤守: 你可以等量名角色受到的火焰伤害+1",
    ["sfofl_fengshou"] = "凤守",
    [":sfofl_fengshou"] = "当你变身后，你可以重新分配与你距离为1的角色的座次，然后消耗任意魔​​力，令等量名角色受到的火焰伤害+1。",
    ["sfofl_susheng"] = "苏生",
    [":sfofl_susheng"] = "当称号与你相同的角色进入濒死状态时，你可以消耗任意魔​​力令其回复等量的体力和魔力，然后你摸等量张牌。",

    ["sfofl_magic_ruiji"] = "芮姬[官盗]",
    ["&sfofl_magic_ruiji"] = "芮姬",
    ["#sfofl_magic_ruiji"] = "柔荑弄钺",
    ["illustrator:sfofl_magic_ruiji"] = "",
    ["information:sfofl_magic_ruiji"] = "E10于赤壁星空下契约！闪耀战姬们的魔法乱舞",
    --妄缘：当你于回合外失去牌后，你可以将牌堆中一张非装备牌置于武将牌上，称为“妄”（每种牌名限一张，至多为游戏人数）。
    --铃音：出牌阶段开始时，你可以获得至多X张“妄”（X为游戏轮数）。然后若“妄”的颜色均相同，本回合你可以将一张武器或防具牌当【决斗】使用，你对其他角色造成的伤害+1。
    --俐影：每回合限一次，当你于摸牌阶段外获得牌后，你可以将这些牌交给一名其他角色，然后你摸一张牌。若你为当前回合角色，你将牌堆中的一张非装备牌置为“妄”。
    ["sfofl_moli_ruiji"] = "魔力",
    [":sfofl_moli_ruiji"] = "变身技（0/5），游戏开始时或当你造成或受到伤害时，你获得1点魔力；当你进入濒死状态时或发动“铃音”后，你进行吟唱并变身。",
    ["sfofl_magic_ruiji_henshin"] = "一天是哥布林，一辈子都是哥布林！",

    ["sfofl_magic_ruiji_change"] = "芮姬[闪耀战姬]",
    ["&sfofl_magic_ruiji_change"] = "芮姬",
    ["#sfofl_magic_ruiji_change"] = "闪耀战姬",
    ["illustrator:sfofl_magic_ruiji_change"] = "",
    ["information:sfofl_magic_ruiji_change"] = "E10于赤壁星空下契约！闪耀战姬们的魔法乱舞",
    ["sfofl_shengcai"] = "圣裁",
    [":sfofl_shengcai"] = "出牌阶段，你可消耗任意魔力，将等量张手牌当做无距离次数限制的【杀】使用，你以此法使用的【杀】造成的伤害+X（X为你本次消耗的魔力数）。",
    ["sfofl_guanghui"] = "光辉",
    [":sfofl_guanghui"] = "锁定技，所有进入变身状态的角色使用牌不能被非变身状态的角色响应；称号与你相同的角色造成伤害时，你获得1点魔力。",

    ["sfofl_magic_lulingqi"] = "吕玲绮[官盗]",
    ["&sfofl_magic_lulingqi"] = "吕玲绮",
    ["#sfofl_magic_lulingqi"] = "无双虓姬",
    ["illustrator:sfofl_magic_lulingqi"] = "",
    ["information:sfofl_magic_lulingqi"] = "E10于赤壁星空下契约！闪耀战姬们的魔法乱舞",
    --帼武：出牌阶段开始时，你可以展示所有手牌，若展示类型数大于0，你获得弃牌堆中的一张【杀】；大于1，此阶段你使用牌无距离限制；大于2，此阶段你使用【杀】或普通锦囊牌可以增加至多两个目标。
    --妆戎：觉醒技，每回合结束时，若你的体力值或手牌数为1，你减1点体力上限并获得“神威”（锁定技，摸牌阶段你多摸两张牌；你的手牌上限+2）和“无双”，然后将体力回复至体力上限，并将手牌摸至体力上限。
    ["sfofl_moli_lulingqi"] = "魔力",
    [":sfofl_moli_lulingqi"] = "变身技（0/5），游戏开始时或当你造成1点伤害时，你获得1点魔力，准备阶段，你进行吟唱并变身。",
    ["sfofl_magic_lulingqi_henshin"] = "Starlight Ascension！",

    ["sfofl_magic_lulingqi_change"] = "吕玲绮[闪耀战姬]",
    ["&sfofl_magic_lulingqi_change"] = "吕玲绮",
    ["#sfofl_magic_lulingqi_change"] = "闪耀战姬",
    ["illustrator:sfofl_magic_lulingqi_change"] = "",
    ["information:sfofl_magic_lulingqi_change"] = "E10于赤壁星空下契约！闪耀战姬们的魔法乱舞",
    ["sfofl_henghui:damage"] = "使用【杀】的次数和造成的伤害+1",
    ["sfofl_henghui:distance"] = "【杀】无距离限制且目标数+2",
    ["sfofl_henghui:draw"] = "摸五张牌并弃置装备区内的所有牌",
    ["sfofl_henghui_first"] = "恒辉①",
    ["sfofl_henghui_sec"] = "恒辉②",
    ["sfofl_henghui"] = "恒辉",
    [":sfofl_henghui"] = "锁定技，当你变身后，你获得任意个效果并消耗等量的魔力：1.使用【杀】的次数和造成的伤害+1；2.【杀】无距离限制且目标数+2；3.摸五张牌并弃置装备区内的所有牌。",
    ["sfofl_moqi"] = "魔契",
    [":sfofl_moqi"] = "魔契：每次变身限一次，出牌阶段，你可以消耗至少3点魔力并失去所有体力，然后你令“恒辉”的所有数值翻倍。若如此做，你保持变身状态直到结束阶段。",

    ["sfofl_magic_dongwan"] = "董绾[官盗]",
    ["&sfofl_magic_dongwan"] = "董绾",
    ["#sfofl_magic_dongwan"] = "蜜言如鸩",
    ["illustrator:sfofl_magic_dongwan"] = "",
    ["information:sfofl_magic_dongwan"] = "E10于赤壁星空下契约！闪耀战姬们的魔法乱舞",
    --生妒：回合开始时，你可以选择一名其他角色，其下个摸牌阶段结束后，你摸等于其摸牌数的牌。
    --介绫：出牌阶段限一次，你可以将两张颜色不同的手牌当一张无距离次数限制的【杀】使用，结算完成后，若此【杀】造成过伤害/未造成过伤害，目标角色失去1点体力/你对目标发动一次“生妒”。
    ["sfofl_moli_dongwan"] = "魔力",
    [":sfofl_moli_dongwan"] = "变身技（0/5），游戏开始时或当你于摸牌阶段外获得牌时，你获得1点魔力，结束阶段，你进行吟唱并变身。",
    ["sfofl_magic_dongwan_henshin"] = "Henshin！",

    ["sfofl_magic_dongwan_change"] = "董绾[闪耀战姬]",
    ["&sfofl_magic_dongwan_change"] = "董绾",
    ["#sfofl_magic_dongwan_change"] = "闪耀战姬",
    ["illustrator:sfofl_magic_dongwan_change"] = "",
    ["information:sfofl_magic_dongwan_change"] = "E10于赤壁星空下契约！闪耀战姬们的魔法乱舞",
    ["sfofl_shengyan"] = "圣焰",
    [":sfofl_shengyan"] = "锁定技，你使用牌时额外结算一次，然后你消耗1点魔力或失去1点体力，对一名其他角色造成1点火焰伤害。",
    ["sfofl_gongming"] = "共鸣",
    [":sfofl_gongming"] = "当你消耗1点魔力后或失去1点体力后，你可以令称号与你相同的角色各摸X张牌（X为你本次变身此技能发动的次数）。",
    
    ["sfofl_lord_goblin"] = "哥布林领主[官盗]",
    ["&sfofl_lord_goblin"] = "哥布林领主",
    ["#sfofl_lord_goblin"] = "疑暴如麟",
    ["illustrator:sfofl_lord_goblin"] = "",
    ["information:sfofl_lord_goblin"] = "E10于赤壁星空下契约！闪耀战姬们的魔法乱舞",
    ["sfofl_yibao"] = "疑暴",
    [":sfofl_yibao"] = "锁定技，你造成或受到伤害后，令伤害角色摸三张牌；若你为伤害来源，随机废除受伤角色的一个装备区，然后你观看其手牌并获得其两张牌。",
    ["sfofl_rulin"] = "如麟",
    [":sfofl_rulin"] = "锁定技，当你将要造成致命伤害时，你防止之并改为减少其1点体力上限，你增加1点体力上限并回复等量体力。",
    ["sfofl_kuangbao"] = "狂暴",
    [":sfofl_kuangbao"] = "锁定技，当你造成或受到伤害时，若伤害来源手牌数大于受伤角色，此伤害+1，且此牌不计入次数。",
    ["sfofl_feisheng"] = "飞升",
    [":sfofl_feisheng"] = "锁定技，每个回合结束时，若你受到过至少2点伤害，你减2点体力上限且本回合结束时进行一个额外的回合。",
     
    ["sfofl_goblin"] = "哥布林[官盗]",
    ["&sfofl_goblin"] = "哥布林",
    ["#sfofl_goblin"] = "残暴掳掠",
    ["illustrator:sfofl_goblin"] = "",
    ["information:sfofl_goblin"] = "E10于赤壁星空下契约！闪耀战姬们的魔法乱舞",
    ["sfofl_shiqiang"] = "恃强",
    [":sfofl_shiqiang"] = "锁定技，你造成或受到伤害时，若受伤角色/伤害来源的手牌数小于/大于你，此伤害+1。",
    ["sfofl_lingruo"] = "凌弱",
    [":sfofl_lingruo"] = "锁定技，当你造成伤害后，你获得受伤角色的一张牌。",
    --E1005 闪耀战姬

    
}

--S7
sgs.LoadTranslationTable {
    --S7001燕幽烽火
    ["sfofl_yuanshao"] = "袁绍[界桥]",     
    ["&sfofl_yuanshao"] = "袁绍",
    ["#sfofl_yuanshao"] = "一往无前",
    ["illustrator:sfofl_yuanshao"] = "铁杵文化",
    ["information:sfofl_yuanshao"] = "S7001 燕幽烽火",
    ["sfofl_sudi"] = "肃敌",
    [":sfofl_sudi"] = "锁定技，攻击范围内包含你的角色响应你使用的牌后，你摸一张牌。",
    ["sfofl_qishe"] = "齐射",
    [":sfofl_qishe"] = "游戏开始时，你从游戏外获得一张【万箭齐发】；结束阶段，你可以从弃牌堆获得一张【万箭齐发】。",
	["_archery_attack"] = "万箭齐发",
	[":_archery_attack"] = "锦囊牌·AOE锦囊<br/><b>时机</b>：出牌阶段，对所有其他角色使用<br/><b>效果</b>：目标需打出一张【闪】，否则你对其造成1点伤害。",
    ["sfofl_linzhen"] = "临阵",
    [":sfofl_linzhen"] = "主公技，锁定技，你视为在其他群势力角色的攻击范围内。",


    ["sfofl_wenchou"] = "文丑[界桥]",
    ["&sfofl_wenchou"] = "文丑",
    ["#sfofl_wenchou"] = "一夫之勇",
    ["illustrator:sfofl_wenchou"] = "铁杵文化",
    ["information:sfofl_wenchou"] = "S7001 燕幽烽火",  
    ["sfofl_xuezhan"] = "血战",
    [":sfofl_xuezhan"] = "锁定技，你的锦囊牌均视为【决斗】；你使用【决斗】不能被【无懈可击】响应。",
    ["sfofl_lizhen"] = "历阵",
    [":sfofl_lizhen"] = "你可以将装备区内的牌当【杀】使用或打出。",

    ["sfofl_gongsunzan"] = "公孙瓒[界桥]",
    ["&sfofl_gongsunzan"] = "公孙瓒",
    ["#sfofl_gongsunzan"] = "白马将军",
    ["illustrator:sfofl_gongsunzan"] = "沉睡千年",
    ["information:sfofl_gongsunzan"] = "S7001 燕幽烽火",    
    ["sfofl_qizhen"] = "骑阵",
    [":sfofl_qizhen"] = "当你使用【杀】结算后，若此【杀】造成伤害，你摸造成伤害值的牌；若未造成伤害，你弃置每名目标角色装备区的一张牌。",
    ["sfofl_mujun"] = "募军",
    [":sfofl_mujun"] = "主公技，限定技，出牌阶段，你可以令一名群势力角色获得“义从”。",
    ["_sfofl_whitehorse_weapon"] = "白马骁骑",
    [":_sfofl_whitehorse_weapon"] = "装备牌·武器\
	<b>攻击范围</b>：0\
	<b>武器技能</b>：当你装备区内牌数不小于1时，你攻击范围+X；不小于2时，你的出杀次数+X；不小于3时，你与其他角色计算距离+X；不小于4时，你摸牌数+X（X为你当前装备区的牌数）。",
    ["_sfofl_whitehorse_armor"] = "白马骁骑",
    [":_sfofl_whitehorse_armor"] = "装备牌·防具\
	<b>防具技能</b>：当你装备区内牌数不小于1时，你攻击范围+X；不小于2时，你的出杀次数+X；不小于3时，你与其他角色计算距离+X；不小于4时，你摸牌数+X（X为你当前装备区的牌数）。",
    ["_sfofl_whitehorse_offensivehorse"] = "白马骁骑",
	[":_sfofl_whitehorse_offensivehorse"] = "装备牌/坐骑<br/><b>坐骑技能</b>：当你装备区内牌数不小于1时，你攻击范围+X；不小于2时，你的出杀次数+X；不小于3时，你与其他角色计算距离+X；不小于4时，你摸牌数+X（X为你当前装备区的牌数）。",
    ["_sfofl_whitehorse_defensivehorse"] = "白马骁骑",
	[":_sfofl_whitehorse_defensivehorse"] = "装备牌/坐骑<br/><b>坐骑技能</b>：当你装备区内牌数不小于1时，你攻击范围+X；不小于2时，你的出杀次数+X；不小于3时，你与其他角色计算距离+X；不小于4时，你摸牌数+X（X为你当前装备区的牌数）。",

    ["sfofl_4_zhaoyun"] = "赵云[界桥]",
    ["&sfofl_4_zhaoyun"] = "赵云",
    ["#sfofl_4_zhaoyun"] = "白马将军",
    ["illustrator:sfofl_4_zhaoyun"] = "路人z",
    ["information:sfofl_4_zhaoyun"] = "S7001 燕幽烽火",   
   
    ["sfofl_gongsunyuan"] = "公孙渊[官盗]",
    ["&sfofl_gongsunyuan"] = "公孙渊",
    ["#sfofl_gongsunyuan"] = "无节燕主",
    ["illustrator:sfofl_gongsunyuan"] = "第七个桔子",
    ["information:sfofl_gongsunyuan"] = "S7001 燕幽烽火",   
    ["sfofl_xuanshi"] = "旋势",
    [":sfofl_xuanshi"] = "出牌阶段限两次，若你的手牌中黑色牌和红色牌数量相同，你可以展示手牌，然后获得一名其他角色的一张牌。",
    ["sfofl_xiongye"] = "凶业",
    [":sfofl_xiongye"] = "主公技，出牌阶段限一次，你可以交给任意名其他群势力角色各一张手牌，然后对这些角色各造成1点伤害。",
    ["@sfofl_xiongye"] = "凶业：你交给 %src 一张手牌，然后对 %src 各造成1点伤害",

    ["sfofl_caorui"] = "曹叡[官盗]",
    ["&sfofl_caorui"] = "曹叡",
    ["#sfofl_caorui"] = "魏明帝",
    ["illustrator:sfofl_caorui"] = "第七个桔子",
    ["information:sfofl_caorui"] = "S7001 燕幽烽火",   
    ["sfofl_mingjian"] = "明鉴",
    [":sfofl_mingjian"] = "其他角色出牌阶段开始时，你可以展示手牌并将其中一种花色的所有牌交给该角色，然后其本回合使用的下一张牌额外结算一次。",
    ["#sfofl_mingjian-invoke"] = "明鉴：你可以交给 %dest 一种花色的手牌，其本回合使用的下一张牌额外结算一次",
    ["@@sfofl_mingjian-turn"] = "明鉴",
    ["sfofl_huituo"] = "恢拓",
    [":sfofl_huituo"] = "当你受到1点伤害后，你可以令一名角色进行一次判定，若结果为红色，该角色回复1点体力；若结果为黑色，该角色摸一张牌。",
    ["sfofl_huituo-invoke"] = "你可以发动“恢拓”。" ,

    ["sfofl_simayi"] = "司马懿[官盗]",
    ["&sfofl_simayi"] = "司马懿",
    ["#sfofl_simayi"] = "总齐八荒",
    ["illustrator:sfofl_simayi"] = "木美人",
    ["information:sfofl_simayi"] = "S7001 燕幽烽火",
    ["sfofl_yanggu"] = "佯固",
    [":sfofl_yanggu"] = "转换技，阳：当你受到伤害后，你可以回复1点体力；阴：你可以将一张手牌当【声东击西】使用。",
    [":sfofl_yanggu1"] = "转换技，阳：当你受到伤害后，你可以回复1点体力；<font color=\"#01A5AF\"><s>阴：你可以将一张手牌当【声东击西】使用。</s></font>",
    [":sfofl_yanggu2"] = "转换技，<font color=\"#01A5AF\"><s>阳：当你受到伤害后，你可以回复1点体力；</s></font>阴：你可以将一张手牌当【声东击西】使用。",
    ["sfofl_zuifu"] = "罪缚",
    [":sfofl_zuifu"] = "每回合限一次，当一名角色于其摸牌阶段外获得牌后，若没有角色处于濒死状态，你可以对其造成1点伤害。",

    ["sfofl_jieqiao"] = "界桥",
    ["sfofl_jieqiao_skill"] = "界桥",
    [":sfofl_jieqiao_skill"] = "锁定技，该地形阵亡时，友方角色弃置所有牌。其他角色的结束阶段，其可以弃置所有手牌，令你获得1点护甲。",

    ["sfofl_jieqiao_quyi_start"] = "image=image/animate/sfofl_jieqiao_quyi.png",
    ["sfofl_jieqiao_quyi"] = "先锋",
    [":sfofl_jieqiao_quyi"] = "每有一个先锋标记，麴义方攻击范围和手牌上限+1。当麴义方需要使用或打出基本牌时，其可以弃置一个标记并视为使用或打出该牌。",
    ["sfofl_yuanshao_start"] = "image=image/animate/sfofl_yuanshao.png",
    ["sfofl_jieqiao_quyiScenario"] = "界桥之战[官盗]",


---------------S7002 荆扬对垒
    ["sfofl_pangtong"] = "庞统[官盗]",
    ["&sfofl_pangtong"] = "庞统",
    ["#sfofl_pangtong"] = "铁索连舟",
    ["illustrator:sfofl_pangtong"] = "DH",
    ["information:sfofl_pangtong"] = "S7002 荆扬对垒",
    ["sfofl_lianhuan"] = "连环",
    [":sfofl_lianhuan"] = "出牌阶段限一次，你可以失去1点体力并视为使用一张【铁索连环】。",
    ["sfofl_suozhou"] = "索舟",
    [":sfofl_suozhou"] = "每回合限一次，当你成为的目标或使用牌时，你可以令所有横置的角色摸一张牌。",
    ["sfofl_yihuo"] = "浴火",
    [":sfofl_yihuo"] = "锁定技，横置的其他角色受到的属性伤害+1，非属性伤害-1。",

    ["sfofl_3_caocao"] = "曹操[官盗]",
    ["&sfofl_3_caocao"] = "曹操",
    ["#sfofl_3_caocao"] = "鲸吞江东",
    ["illustrator:sfofl_3_caocao"] = "M云涯",
    ["information:sfofl_3_caocao"] = "S7002 荆扬对垒",
    ["sfofl_lijun"] = "砺军",
    [":sfofl_lijun"] = "当魏势力角色受到伤害后，你可以令其摸一张牌。",
    ["sfofl_tongbei"] = "统北",
    [":sfofl_tongbei"] = "你对非魏势力角色造成伤害时，你可以令其选择一项：1.此伤害+1；2.交给你一张你声明的类别的牌。",
    ["@sfofl_tongbei"] = "统北:交给 %src 一张 %dest 牌<br/> <b>操作提示</b>: 选择一张手牌→点击确定<br/>",

    ["sfofl_caoren"] = "曹仁[官盗]",
    ["&sfofl_caoren"] = "曹仁",
    ["#sfofl_caoren"] = "镇守南郡",
    ["illustrator:sfofl_caoren"] = "凡果",
    ["information:sfofl_caoren"] = "S7002 荆扬对垒",
    ["sfofl_beirong"] = "备戎",
    [":sfofl_beirong"] = "出牌阶段限一次，你可以重铸至少一张手牌，若你以此法重铸的牌的花色数不小于你的体力值，你横置。",
    ["sfofl_yujun"] = "御军",
    [":sfofl_yujun"] = "一名横置角色受到属性伤害时，你可以翻面并失去1点体力，然后摸三张牌，若如此做，防止此伤害。",
    
    ["sfofl_5_zhugeliang"] = "诸葛亮[官盗]",
    ["&sfofl_5_zhugeliang"] = "诸葛亮",
    ["#sfofl_5_zhugeliang"] = "舌战群儒",
    ["illustrator:sfofl_5_zhugeliang"] = "枭瞳",
    ["information:sfofl_5_zhugeliang"] = "S7002 荆扬对垒",
    ["sfofl_qibian"] = "七辩",
    [":sfofl_qibian"] = "每轮开始时，你将牌堆顶的七张牌置于武将牌上，称为“才”，每轮结束时，你弃置所有的“才”。",
    ["sfofl_qibian_talent"] = "才",
    ["&sfofl_qibian_talent"] = "才",
    ["sfofl_cailue"] = "才略",
    [":sfofl_cailue"] = "你可以使用或打出“才”，然后成为“才”的目标的角色可以弃置你一张牌。",

    ["sfofl_3_zhouyu"] = "周瑜[官盗]",
    ["&sfofl_3_zhouyu"] = "周瑜",
    ["#sfofl_3_zhouyu"] = "红莲灿世",
    ["illustrator:sfofl_3_zhouyu"] = "橙子z君",
    ["information:sfofl_3_zhouyu"] = "S7002 荆扬对垒",
    ["sfofl_sashuang"] = "飒爽",
    [":sfofl_sashuang"] = "结束阶段，你可以获得弃牌堆中本回合进入的每种颜色的牌各一张。",
    ["sfofl_huoce-invoke"] =  "你可以发动“火策”<br/> <b>操作提示</b>: 选择一名角色→点击确定<br/>",
    ["@sfofl_huoce"] =  "火策:弃置一张手牌<br/> <b>操作提示</b>: 选择一张手牌→点击确定<br/>",
    ["sfofl_huoce"] = "火策",
    [":sfofl_huoce"] = "出牌阶段限一次，你可以与一名其他角色同时弃置一张手牌，若这些牌颜色相同，你对一名角色造成1点火焰伤害。",

    ["sfofl_zhangzhao"] = "张昭[官盗]",
    ["&sfofl_zhangzhao"] = "张昭",
    ["#sfofl_zhangzhao"] = "直言劝谏",
    ["illustrator:sfofl_zhangzhao"] = "鬼画府",
    ["information:sfofl_zhangzhao"] = "S7002 荆扬对垒",
    ["sfofl_boyan"] = "驳言",
    [":sfofl_boyan"] = "出牌阶段限两次，你可以与一名其他角色拼点，没赢的角色本回合不能使用手牌，然后摸两张牌。",
    ["sfofl_mushi"] = "慕势",
    [":sfofl_mushi"] = "结束阶段，若所有其他角色手牌数均大于等于其体力值，你可以选择一项：1.获得每名其他角色的各一张牌；2.令所有其他角色将其手牌数调整至其体力值张。",
    ["sfofl_mushi:obtain"] = "获得每名其他角色的各一张牌",
    ["sfofl_mushi:discard"] = "令所有其他角色将其手牌数调整至其体力值张",

    ["sfofl_lusu"] = "鲁肃[官盗]",
    ["&sfofl_lusu"] = "鲁肃",
    ["#sfofl_lusu"] = "独断的外交家",
    ["illustrator:sfofl_lusu"] = "NOVART",
    ["information:sfofl_lusu"] = "S7002 荆扬对垒",
    ["sfofl_dimeng"] = "缔盟",
    [":sfofl_dimeng"] = "当有角色拼点时，你可以交换双方的拼点牌。",
    ["sfofl_2_zhouji"] = "周济",
    [":sfofl_2_zhouji"] = "<font color=\"green\"><b>出牌阶段限X次，</b></font>你可以与一名其他角色拼点，若其赢，其摸两张牌（x为你的体力值）。",

    ["sfofl_huanggai"] = "黄盖[官盗]",
    ["&sfofl_huanggai"] = "黄盖",
    ["#sfofl_huanggai"] = "火神的先驱",
    ["illustrator:sfofl_huanggai"] = "NOVART",
    ["information:sfofl_huanggai"] = "S7002 荆扬对垒",
    ["sfofl_liezhou"] = "烈舟",
    [":sfofl_liezhou"] = "锁定技，你造成的伤害视为火焰伤害；你对一名角色造成伤害后，若其受到伤害前武将牌横置，你摸x张牌（x为你造成的伤害值）。",
    ["sfofl_zhaxiong"] = "诈降",
    [":sfofl_zhaxiong"] = "出牌阶段限一次，你可以失去1点体力上限，令你本回合使用的牌不能被响应。",

    ["sfofl_jianchuan"] = "艦船",
    [":sfofl_jianchuan"] = "装备牌/宝物\
    宝物技能：锁定技，若你处于连环状态，你的攻击距离和手牌上限+2。",
    ["sfofl_louchuan"] = "楼船",
    [":sfofl_louchuan"] = "装备牌/宝物\
        宝物技能：当你对一名角色使用牌时，你可以令其进入连环状态。",
    ["sfofl_yiguzuoqi"] = "一鼓作气",
    [":sfofl_yiguzuoqi"] = "锦囊牌·单目标锦囊<br/><font color=\"#bab8ba\"><b></b></font><br/><b>时机</b>：出牌阶段<br/><b>目标</b>：你<br/><b>效果</b>：你本回合使用牌无距离和次数限制。",
    ["sfofl_barbs"] = "舌战",
    [":sfofl_barbs"] = "出牌阶段限一次，你可以和一名角色拼点，没赢的角色失去1点体力。",

------------------------------------------------------------S7003 徐兖纵横
    ["sfofl_caosong"] = "曹嵩[官盗]",
    ["&sfofl_caosong"] = "曹嵩",
    ["#sfofl_caosong"] = "醉梦折冲",
    ["illustrator:sfofl_caosong"] = "MUMU",
    ["information:sfofl_caosong"] = "S7003 徐兖纵横",
    ["sfofl_lilu"] = "礼赂",
    [":sfofl_lilu"] = "摸牌阶段，你可以放弃摸牌，改为弃置任意张牌并将手牌摸至体力上限（最多摸至5张），然后将至少一张手牌交给一名其他角色；若你交出的牌数大于上次以此法交出的牌数，你增加1点体力上限并回复1点体力。",
    ["sfofl_yizhengc"] = "翊正",
    [":sfofl_yizhengc"] = "回合结束时，你可以选择一名其他角色。直到你的下回合开始，当该角色造成伤害或回复体力时，你减1点体力上限，然后此伤害或回复值+1。",

    ["sfofl_chengyu"] = "程昱[官盗]",
    ["&sfofl_chengyu"] = "程昱",
    ["#sfofl_chengyu"] = "腹藉千军",
    ["illustrator:sfofl_chengyu"] = "Jarvis",
    ["information:sfofl_chengyu"] = "S7003 徐兖纵横",
    ["sfofl_liaofu"] = "燎伏",
    [":sfofl_liaofu"] = "出牌阶段限一次，你可以扣置一张未以此法扣置过的类别的【杀】，其他角色于你的回合外使用【杀】时，你可以移去一张相同的【杀】，对其造成1点此【杀】属性的伤害。",
    ["sfofl_jinshou"] = "烬守",
    [":sfofl_jinshou"] = "结束阶段，若你本回合体力值未变化过，你可以弃置所有手牌并失去1点体力，若如此做，直到你下回合开始，其他角色使用的仅指定你为目标的伤害牌无效。",

    ["sfofl_5_caocao"] = "曹操[官盗]",
    ["&sfofl_5_caocao"] = "曹操",
    ["#sfofl_5_caocao"] = "兴兵血仇",
    ["illustrator:sfofl_5_caocao"] = "墨心绘意",
    ["information:sfofl_5_caocao"] = "S7003 徐兖纵横",
    ["sfofl_jingju"] = "旌聚",
    [":sfofl_jingju"] = "锁定技，你的摸牌阶段摸牌数、攻击范围、出牌阶段使用【杀】次数为X（X为场上魏势力角色数，至多为5）。",
    ["sfofl_sitong"] = "泗恸",
    [":sfofl_sitong"] = "每回合限一次，当一名角色使用的指定另一名魏势力角色为唯一目标的伤害牌结算结束后，你可以视为对其使用一张【杀】。",

    ["sfofl_xunyu"] = "荀彧[官盗]",
    ["&sfofl_xunyu"] = "荀彧",
    ["#sfofl_xunyu"] = "令君劝战",
    ["illustrator:sfofl_xunyu"] = "墨心绘意",
    ["information:sfofl_xunyu"] = "S7003 徐兖纵横",
    ["sfofl_jianjing"] = "谏旌",
    [":sfofl_jianjing"] = "出牌阶段限一次，你可以与一名角色拼点，赢的角色对其攻击范围内一名角色造成1点伤害。",
    ["sfofl_dishou"] = "砥守",
    [":sfofl_dishou"] = "当你受到伤害时，若伤害来源的手牌数和体力值不相等，其选择一项：1.弃置所有手牌；2.失去1点体力，重复此流程直到手牌数和体力值相等或进入濒死状态。",

    ["sfofl_chengong"] = "陈宫[官盗]",
    ["&sfofl_chengong"] = "陈宫",
    ["#sfofl_chengong"] = "刚直壮烈",
    ["illustrator:sfofl_chengong"] = "墨心绘意",
    ["information:sfofl_chengong"] = "S7003 徐兖纵横",
    --mingce
    ["sfofl_jiaozheng"] = "矫诤",
    [":sfofl_jiaozheng"] = "每回合限一次，当你摸牌时，你可以改为令一名角色视为使用一张无距离限制的【杀】。",

    
    ["sfofl_zhangkai"] = "张闿[官盗]",
    ["&sfofl_zhangkai"] = "张闿",
    ["#sfofl_zhangkai"] = "财靡欲壑",
    ["illustrator:sfofl_zhangkai"] = "墨心绘意",
    ["information:sfofl_zhangkai"] = "S7003 徐兖纵横",
    ["sfofl_qingjin"] = "黥金",
    [":sfofl_qingjin"] = "一名角色摸牌阶段结束时，若其此阶段摸牌数大于两张，你可以视为对其使用一张【杀】，若此【杀】未造成伤害，你失去1点体力。",

    
    ["sfofl_3_lvbu"] = "吕布[官盗]",
    ["&sfofl_3_lvbu"] = "吕布",
    ["#sfofl_3_lvbu"] = "令君劝战",
    ["illustrator:sfofl_3_lvbu"] = "第七个桔子",
    ["information:sfofl_3_lvbu"] = "S7003 徐兖纵横",
    ["sfofl_xiaoxi"] = "虓袭",
    [":sfofl_xiaoxi"] = "游戏开始时，你获得7个标记。摸牌阶段，你改为摸标记数的牌，然后移去一个标记。",
    ["sfofl_fenqi"] = "焚骑",
    [":sfofl_fenqi"] = "出牌阶段限一次，你可以移去一个标记，获得一张【一鼓作气】。",

    ["sfofl_zhangmiao"] = "张邈[官盗]",
    ["&sfofl_zhangmiao"] = "张邈",
    ["#sfofl_zhangmiao"] = "据兖以观",
    ["illustrator:sfofl_zhangmiao"] = "凝聚永恒",
    ["information:sfofl_zhangmiao"] = "S7003 徐兖纵横",
    ["sfofl_mouni"] = "谋逆",
    [":sfofl_mouni"] = "回合开始时，你可以令一名其他角色展示所有手牌，对其依次使用其中所有的【杀】直到该角色进入濒死状态。若以此法使用的【杀】均未造成伤害，你结束此回合。",
    ["sfofl_zongfan"] = "纵反",
    ["@sfofl_zongfan"] = "纵反：你可以交给 %src 任意张牌。",
    ["sfofl_zongfan-invoke"] = "你可以发动“纵反”<br/> <b>操作提示</b>: 选择一名其他角色→点击确定<br/>",
    [":sfofl_zongfan"] = "觉醒技，回合结束时，若你本回合发动“谋逆”且有角色进入濒死状态，你交给一名其他角色任意张牌，加X点体力上限并回复X点体力（X为你交给该角色的牌数且最多为5），失去“谋逆”，获得“战孤”。",
    ["sfofl_zhangu"] = "战孤",
    [":sfofl_zhangu"] = "锁定技，回合开始时，若你体力上限大于1且没有手牌或装备区没有牌，你减1点体力上限，然后摸两张牌。",

}

--E5
sgs.LoadTranslationTable {
---E5001荆襄风云
    ["sfofl_shenliubiao"] = "神刘表[荆襄]",
    ["&sfofl_shenliubiao"] = "神刘表",
    ["#sfofl_shenliubiao"] = "称雄荆襄",
    ["illustrator:sfofl_shenliubiao"] = "六道目",
    ["information:sfofl_shenliubiao"] = "E5001荆襄风云",
    ["sfofl_xiongju"] = "雄据",
    [":sfofl_xiongju"] = "锁定技，游戏开始时，你从游戏外获得两张【荆襄盛世】，你的起始手牌+X，手牌上限+X，体力值和体力上限+X（X为场上势力数）。",
    ["sfofl_fujing"] = "富荆",
    [":sfofl_fujing"] = "锁定技，你跳过摸牌阶段，并改为使用一张【荆襄盛世】。依此法获得牌的其他角色本轮首次对你使用牌时需弃置一张牌。",
    ["@sfofl_fujing"] =  "富荆：请选择【荆襄盛世】的目标",
    ["sfofl_yongrong"] = "雍容",
    [":sfofl_yongrong"] = "每回合限一次，你造成/受到伤害时，若受伤角色/伤害来源的手牌小于你，你可以交给其一张牌令此伤害+1/-1。",
    ["@sfofl_yongrong_increase"] =  "雍容：你可以交给 %src 令此伤害+1。",
    ["@sfofl_yongrong_decrease"] =  "雍容：你可以交给 %src 令此伤害-1。",
    ["_sfofl_jingxiang_goldenage"] = "荆襄盛世",
    [":_sfofl_jingxiang_goldenage"] = "锦囊牌·多目标锦囊\
时机：出牌阶段，对X名其他角色使用\
效果：亮出牌堆顶存活人数张牌，这些角色依次获得其中一张（X为全场势力数）。",
    ["sfofl_shenliubiao_card"] = "神刘表专属",

    ["sfofl_shencaoren"] = "神曹仁[荆襄]",
    ["&sfofl_shencaoren"] = "神曹仁",
    ["#sfofl_shencaoren"] = "征南将军",
    ["illustrator:sfofl_shencaoren"] = "六道目",
    ["information:sfofl_shencaoren"] = "E5001荆襄风云",
    ["sfofl_jushouTurnOver"] = "据守",
    ["sfofl_jushou"] = "据守",
    [":sfofl_jushou"] = "结束阶段，你可以翻面并摸Ｘ张牌（X 为场上存活人数）。然后你可以令全场翻面并各摸三张牌，若如此做你弃置场上所有装备，失去“据守”并获得“突围”。",
    ["sfofl_tuwei:draw"] = "令其摸一张牌",
    ["sfofl_tuwei:damage"] = "对其造成１点伤害",
    ["sfofl_tuwei"] = "突围",
    [":sfofl_tuwei"] = "本局游戏每名角色限一次，出牌阶段你可以将弃牌堆的一张装备牌置入一名角色对应的装备区内，然后若其不为你，则你可以令其摸一张牌或对其造成１点伤害。",

    ["sfofl_4_zhouyu"] = "周瑜[荆襄]",
    ["&sfofl_4_zhouyu"] = "周瑜",
    ["#sfofl_4_zhouyu"] = "雄姿英发",
    ["illustrator:sfofl_4_zhouyu"] = "魔骑士",
    ["information:sfofl_4_zhouyu"] = "E5001荆襄风云",
    ["sfofl_xiongzi"] = "雄姿",
    [":sfofl_xiongzi"] = "锁定技，摸牌阶段你额外摸 X 张牌，你的手牌上限 + X （X 为你当前的体力值）。",
    ["sfofl_2_zhanyan"] = "绽焱",
    [":sfofl_2_zhanyan"] = "出牌阶段限一次，你可以令一名其他角色猜测你的红色手牌数量，然后你展示你的手牌并将所有红色手牌交给其，然后你对其造成猜测数与你红色手牌之差的火焰伤害，且至多为３。",

    ["sfofl_4_guanyu"] = "关羽[荆襄]",
    ["&sfofl_4_guanyu"] = "关羽",
    ["#sfofl_4_guanyu"] = "美髯公",
    ["illustrator:sfofl_4_guanyu"] = "鬼画府",
    ["information:sfofl_4_guanyu"] = "E5001荆襄风云",
    ["sfofl_wusheng"] = "武圣",
    [":sfofl_wusheng"] = "你可以将一张红色牌当【杀】/【酒】使用或打出；你使用方片【杀】无距离限制。",

---E5002汉末风云
    ["sfofl_fuyun"] = "浮云[官盗]",
    ["&sfofl_fuyun"] = "浮云",
    ["#sfofl_fuyun"] = "黄天末代",
    ["illustrator:sfofl_fuyun"] = "苍月白龙",
    ["information:sfofl_fuyun"] = "E5002汉末风云",
    ["sfofl_suiqu:hp"] = "回复1点体力",
    ["sfofl_suiqu:maxhp"] = "加1点体力上限",
    ["sfofl_suiqu"] = "随去",
    [":sfofl_suiqu"] = "锁定技，每名角色的弃牌阶段，你弃置所有手牌，若你因此弃置至少一张牌，你选择一项：1.加1点体力上限；2.回复1点体力。",
    ["sfofl_yure"] = "余热",
    [":sfofl_yure"] = "限定技，当你弃置牌后，你可以将此次弃置的牌交给任意名其他角色。",

    ["sfofl_taosheng"] = "陶升[官盗]",
    ["&sfofl_taosheng"] = "陶升",
    ["#sfofl_taosheng"] = "平汉将军",
    ["illustrator:sfofl_taosheng"] = "佚名",
    ["information:sfofl_taosheng"] = "E5002汉末风云",
    ["sfofl_zainei"] = "载内",
    [":sfofl_zainei"] = "限定技，出牌阶段，你可以选择一名其他角色，令你与其的距离视为1，直到你进入濒死状态。",
    ["@sfofl_hanwei"] = "捍卫：你可以使用捍卫牌",
    ["sfofl_hanwei"] = "捍卫",
    [":sfofl_hanwei"] = "出牌阶段限一次，你可以展示并交给一名与你距离为1的其他角色任意张非伤害牌并摸等量张牌，然后其可以使用你交给其的任意张牌。",

    ["sfofl_gaosheng"] = "高升[官盗]",
    ["&sfofl_gaosheng"] = "高升",
    ["#sfofl_gaosheng"] = "地公之锋",
    ["illustrator:sfofl_gaosheng"] = "livsinno",
    ["information:sfofl_gaosheng"] = "E5002汉末风云",
    ["sfofl_xiongshiAttach"] = "凶势",
    [":sfofl_xiongshiAttach"] = "出牌阶段限一次，你可以将一张手牌置于高升的武将牌上。",
    ["sfofl_xiongshi"] = "凶势",
    [":sfofl_xiongshi"] = "<font color=\"green\"><b>每名角色的出牌阶段限一次，</b></font>其可以将一张手牌置于你的武将牌上。",
    ["@sfofl_defeng"] = "地锋：你可以移去 %src 武将牌上的一张牌，令此伤害+1",
    ["sfofl_defeng"] = "地锋",
    [":sfofl_defeng"] = "锁定技，当一名角色将牌置于武将牌上后，你与其各摸一张牌。当你造成或受到伤害时，伤害来源可以移去你武将牌上的一张牌，令此伤害+1。",

    ["sfofl_bairao"] = "白绕[官盗]",
    ["&sfofl_bairao"] = "白绕",
    ["#sfofl_bairao"] = "黑山寇首",
    ["illustrator:sfofl_bairao"] = "君桓文化",
    ["information:sfofl_bairao"] = "E5002汉末风云",
    ["sfofl_huoyin"] = "祸引",
    [":sfofl_huoyin"] = "锁定技，若你在一名角色的攻击范围内，且其也在你的攻击范围内，你对其使用【杀】无次数限制；当你对这些角色造成伤害后，你摸一张牌，然后其选择是否使用这些牌。",
    ["@sfofl_huoyin"] = "祸引：你可以选择是否使用 %src",

    ["sfofl_yanzheng"] = "严政[官盗]",
    ["&sfofl_yanzheng"] = "严政",
    ["#sfofl_yanzheng"] = "献首投降",
    ["illustrator:sfofl_yanzheng"] = "Xiaoi",
    ["information:sfofl_yanzheng"] = "E5002汉末风云",
    ["sfofl_deshi"] = "地逝",
    [":sfofl_deshi"] = "限定技，出牌阶段开始时，若你已受伤，你可以将所有手牌当一张无视距离且伤害为X的【杀】使用（X为你的手牌数）。",
    ["@sfofl_deshi"] = "地逝：你可以将所有手牌当一张无视距离且伤害为 %src 的【杀】使用",
    ["sfofl_xianjiang"] = "献降",
    [":sfofl_xianjiang"] = "锁定技，当你杀死一名角色时，你令另一名其他角色获得死亡角色区域内的所有牌。",

    ["sfofl_bosi"] = "卜巳[官盗]",
    ["&sfofl_bosi"] = "卜巳",
    ["#sfofl_bosi"] = "黄巾渠帅",
    ["illustrator:sfofl_bosi"] = "千秋秋千秋",
    ["information:sfofl_bosi"] = "E5002汉末风云",
    ["sfofl_weiluan"] = "为乱",
    [":sfofl_weiluan"] = "锁定技，准备阶段/摸牌阶段/出牌阶段开始时，你判定，若结果为黑桃，你的攻击范围/摸牌阶段摸牌数/使用【杀】的上限+1。",
    ["sfofl_tianpan"] = "天判",
    [":sfofl_tianpan"] = "锁定技，当你的判定牌生效时，若为：黑桃，你获得之，然后回复1点体力或加1点体力上限；非黑桃，你失去1点体力或减1点体力上限。",
    ["sfofl_tianpan:gainhp"] = "回复1点体力",
    ["sfofl_tianpan:gainmaxhp"] = "加1点体力上限",
    ["sfofl_tianpan:hp"] = "失去1点体力",
    ["sfofl_tianpan:maxhp"] = "减1点体力上限",
    ["sfofl_gaiming"] = "改命",
    [":sfofl_gaiming"] = "<font color=\"green\"><b>每名角色的回合限一次，</b></font>当你的判定牌生效前，若结果不为黑桃，你可以亮出牌堆顶一张牌代替之。",

    ["sfofl_suigu"] = "眭固[官盗]",
    ["&sfofl_suigu"] = "眭固",
    ["#sfofl_suigu"] = "兔入犬城",
    ["illustrator:sfofl_suigu"] = "君桓文化",
    ["information:sfofl_suigu"] = "E5002汉末风云",
    ["sfofl_tunquan"] = "屯犬",
    [":sfofl_tunquan"] = "锁定技，准备阶段，你令你本回合的摸牌阶段摸牌数、手牌上限、本回合首次造成的伤害+1，直到你发动“迁军”。",
    ["sfofl_qianjun"] = "迁军",
    [":sfofl_qianjun"] = "限定技，出牌阶段，你可以将装备区内所有牌交给一名其他角色，并与其交换座次，然后你回复1点体力并获得“乱击”。",

    ["sfofl_heman"] = "何曼[官盗]",
    ["&sfofl_heman"] = "何曼",
    ["#sfofl_heman"] = "截天夜叉",
    ["illustrator:sfofl_heman"] = "千秋秋千秋",
    ["information:sfofl_heman"] = "E5002汉末风云",
    ["sfofl_juedian:hp"] = "失去1点体力",
    ["sfofl_juedian:maxhp"] = "减1点体力上限",
    ["sfofl_juedian:beishui"] = "背水：此【决斗】造成的伤害+1",
    ["sfofl_juedian"] = "决巅",
    [":sfofl_juedian"] = "锁定技，当你每回合首次使用目标唯一的牌造成伤害后，你选择一项并视为对受伤角色使用一张【决斗】：1.失去1点体力；2.减1点体力上限；3.背水：此【决斗】造成的伤害+1。",
    ["sfofl_nitian"] = "逆天",
    [":sfofl_nitian"] = "限定技，出牌阶段，你可以令你本回合使用牌不能被抵消。若如此做，结束阶段，若你本回合未杀死角色，你死亡。",

    ["sfofl_yudu"] = "于毒[官盗]",
    ["&sfofl_yudu"] = "于毒",
    ["#sfofl_yudu"] = "劫富济贫",
    ["illustrator:sfofl_yudu"] = "MUMU",
    ["information:sfofl_yudu"] = "E5002汉末风云",
    ["sfofl_dafu"] = "打富",
    [":sfofl_dafu"] = "当你使用伤害牌指定目标后，你可以令目标角色摸一张牌，然后其不可相应此牌。",
    ["sfofl_jipin"] = "济贫",
    [":sfofl_jipin"] = "当你对手牌数大于你的角色造成伤害后，你可以获得其一张手牌，然后你可以将之交给一名其他角色。",
    ["sfofl_jipin-invoke"] = "你可以发动“济贫”<br/> <b>操作提示</b>: 选择一名其他角色→点击确定<br/>",

    ["sfofl_tangzhou"] = "唐周[官盗]",
    ["&sfofl_tangzhou"] = "唐周",
    ["#sfofl_tangzhou"] = "叛门高足",
    ["illustrator:sfofl_tangzhou"] = "SKY",
    ["information:sfofl_tangzhou"] = "E5002汉末风云",
    ["sfofl_jukou:draw"] = "令 %src 其他角色摸一张牌，然后其本回合不能使用【杀】",
    ["sfofl_jukou:obtain"] = "令 %src 获得武将牌上的所有牌，然后其本回合不能使用手牌",
    ["sfofl_jukou"] = "举寇",
    [":sfofl_jukou"] = "出牌阶段限一次，你可以选择一项：1.令一名其他角色摸一张牌，然后其本回合不能使用【杀】；2.令一名其他角色获得武将牌上的所有牌，然后其本回合不能使用手牌。",
    ["sfofl_shupan"] = "述叛",
    [":sfofl_shupan"] = "限定技，出牌阶段，你可以依次选择两名其他角色，然后你展示前者的手牌，并与后者各摸三张牌。若如此做，前者对后者依次使用手牌中的所有伤害牌，且本回合这两名角色互相使用牌无次数限制。",

    ["sfofl_bocai"] = "波才[官盗]",
    ["&sfofl_bocai"] = "波才",
    ["#sfofl_bocai"] = "黄巾执首",
    ["illustrator:sfofl_bocai"] = "HOOO",
    ["information:sfofl_bocai"] = "E5002汉末风云",
    ["sfofl_kunjun"] = "困军",
    [":sfofl_kunjun"] = "锁定技，你的初始手牌数+4；手牌数小于你的角色不能响应你使用的牌；你不能响应手牌数大于你的角色使用的牌。",
    ["sfofl_yingzhan"] = "营战",
    [":sfofl_yingzhan"] = "锁定技，你造成和受到的属性伤害+1。",
    ["@sfofl_cuiji"] = "摧击：你可以将至少一张手牌当一张雷【杀】对 %src 使用",
    ["sfofl_cuiji"] = "摧击",
    [":sfofl_cuiji"] = "其他角色的出牌阶段开始时，若你的手牌数大于其，你可以将至少一张手牌当一张雷【杀】对其使用，若造成伤害，你摸等量的牌。",

    ["sfofl_dengmao"] = "邓茂[官盗]",
    ["&sfofl_dengmao"] = "邓茂",
    ["#sfofl_dengmao"] = "逆势而行",
    ["illustrator:sfofl_dengmao"] = "HOOO",
    ["information:sfofl_dengmao"] = "E5002汉末风云",
    ["sfofl_paoxi"] = "咆袭",
    [":sfofl_paoxi"] = "锁定技，<font color=\"green\"><b>每名角色的回合各限一次，</b></font>当你连续成为牌指定的目标后，你本回合下次受到的伤害+1；当你连续使用牌指定目标后，你本回合造成的伤害+1。",
    ["sfofl_houying"] = "后应",
    [":sfofl_houying"] = "出牌阶段，你可以弃置两张黑色牌并视为使用一张无次数限制的【杀】，若造成伤害，你摸一张牌。",

    ["sfofl_chengyuanzhi"] = "程远志[官盗]",
    ["&sfofl_chengyuanzhi"] = "程远志",
    ["#sfofl_chengyuanzhi"] = "逆流而动",
    ["illustrator:sfofl_chengyuanzhi"] = "HOOO",
    ["information:sfofl_chengyuanzhi"] = "E5002汉末风云",
    ["sfofl_wuxiao"] = "武嚣",
    [":sfofl_wuxiao"] = "锁定技，每名角色的回合内首次有红色牌进入弃牌堆后，你本回合下次造成和受到的伤害+1。",
    ["sfofl_qianhu"] = "前呼",
    [":sfofl_qianhu"] = "出牌阶段，你可以弃置两张红色牌并视为使用一张【决斗】，若你造成伤害，你摸一张牌。",

    ["sfofl_shenzhangjiao"] = "神张角[官盗]",
    ["&sfofl_shenzhangjiao"] = "神张角",
    ["#sfofl_shenzhangjiao"] = "庇佑万千",
    ["illustrator:sfofl_shenzhangjiao"] = "鬼画府",
    ["information:sfofl_shenzhangjiao"] = "E5002汉末风云",
    ["sfofl_mingdao"] = "瞑道",
    [":sfofl_mingdao"] = "游戏开始时，你可以将一张【众】置入你的装备区，【众】离开你的装备区时销毁。",
    ["sfofl_zhongfu"] = "众附",
    [":sfofl_zhongfu"] = "每轮开始时，你可以声明一种花色，然后令手牌最少的角色依次选择一项：1.将一张牌置于牌堆顶；2.从牌堆底摸一张牌。本轮当以此法失去牌的角色造成伤害后，你可以发动一次“瞑道”。",
    ["@sfofl_zhongfu"] = "众附：你可以将一张牌置于牌堆顶或从牌堆底摸一张牌",
    ["sfofl_zhongfu:sfofl_mingdao"] = "众附：你可以发动一次“瞑道”",
    ["sfofl_dangjing"] = "荡京",
    [":sfofl_dangjing"] = "当你发动“众附”后，若你装备区内的牌为全场最多，你可以令一名角色进行一次判定，若为你“众附”声明的花色，你对其造成1点雷电伤害且可以重复此流程。",
    ["sfofl_dangjing-invoke"] ="你可以发动“荡京”<br/> <b>操作提示</b>: 选择一名角色→点击确定<br/>",
    ["sfofl_sanshou"] = "三首",
    [":sfofl_sanshou"] = "锁定技，你的准备阶段和结束阶段改为出牌阶段，并在此阶段将武将牌改为“张宝”或“张梁”。此阶段结束后把武将牌替换回“张角”。",
    ["_sfofl_YellowTurbanRebels0"] = "众",
    ["_sfofl_YellowTurbanRebels1"] = "众",
    ["_sfofl_YellowTurbanRebels2"] = "众",
    ["_sfofl_YellowTurbanRebels3"] = "众",
    ["_sfofl_YellowTurbanRebels_weapon"] = "众",
    [":_sfofl_YellowTurbanRebels_weapon"] = "装备牌/武器\
    技能：",
    ["_sfofl_YellowTurbanRebels_armor"] = "众",
    [":_sfofl_YellowTurbanRebels_armor"] = "装备牌/防具\
    技能：",
    ["_sfofl_YellowTurbanRebels_offensivehorse"] = "众",
    [":_sfofl_YellowTurbanRebels_offensivehorse"] = "装备牌/-1坐骑\
    技能：",
    ["_sfofl_YellowTurbanRebels_defensivehorse"] = "众",
    [":_sfofl_YellowTurbanRebels_defensivehorse"] = "装备牌/+1坐骑\
    技能：",
    ["sfofl_YellowTurbanRebels"] = "众",
    ["sfofl_YellowTurbanRebels:0"] = "锁定技，你造成/受到的雷电伤害+1/-1。",
    ["sfofl_YellowTurbanRebels:1"] = "锁定技，出牌阶段使用【杀】的次数+1，你使用【杀】无距离限制。",
    ["sfofl_YellowTurbanRebels:2"] = "锁定技，当你受到伤害后，你摸两张牌。",
    ["sfofl_YellowTurbanRebels:3"] = "锁定技，摸牌阶段多摸一张牌，手牌上限+1。",

    ["sfofl_shenzhangbao"] = "神张宝[官盗]",
    ["&sfofl_shenzhangbao"] = "神张宝",
    ["#sfofl_shenzhangbao"] = "庇佑万千",
    ["illustrator:sfofl_shenzhangbao"] = "鬼画府",
    ["information:sfofl_shenzhangbao"] = "E5002汉末风云",
    ["sfofl_zhouyuan"] = "咒怨",
    [":sfofl_zhouyuan"] = "出牌阶段限一次，你可以选择一名其他角色，其将所有黑色/红色手牌扣置于其武将牌上，你将所有红色/黑色手牌置于武将牌上，这些牌称为“咒兵”。出牌阶段结束时，你与其收回“咒兵”。",
    ["sfofl_zhaobing"] = "诏兵",
    [":sfofl_zhaobing"] = "出牌阶段，你可以将“咒兵”如手牌般使用或打出。",
    ["sfofl_zhoubing"] = "咒兵",
    
    ["sfofl_shenzhangliang"] = "神张梁[官盗]",
    ["&sfofl_shenzhangliang"] = "神张梁",
    ["#sfofl_shenzhangliang"] = "庇佑万千",
    ["illustrator:sfofl_shenzhangliang"] = "王强",
    ["information:sfofl_shenzhangliang"] = "E5002汉末风云",
    ["sfofl_jijun:obtain"] = "集军：将判定牌置于武将牌上",
    ["sfofl_jijun"] = "集军",
    [":sfofl_jijun"] = "当你使用牌指定你为目标后，你可以进行判定，然后选择一项：1.获得此牌；2.将判定牌置于武将牌上，称为“方”。",
    ["sfofl_fangtong"] = "方统",
    [":sfofl_fangtong"] = "出牌阶段结束时，若有“方”，你可以重铸一张手牌，若你重铸的牌与你的任意“方”点数之和为36，你可以将对应的“方”置入弃牌堆，然后对一名其他角色造成3点雷电伤害。",
    ["@sfofl_fangtong-invoke"] = "方统：你可以重铸一张手牌",
    ["@sfofl_fangtong"] = "方统：你可以将 %src 与你的任意“方”点数之和为36的“方”置入弃牌堆，然后对一名其他角色造成3点雷电伤害",
    ["sfofl_fang"] = "方",
    
    ["sfofl_shenhuangfusong"] = "神皇甫嵩[官盗]",
    ["&sfofl_shenhuangfusong"] = "神皇甫嵩",
    ["#sfofl_shenhuangfusong"] = "厥功至伟",
    ["illustrator:sfofl_shenhuangfusong"] = "王宁",
    ["information:sfofl_shenhuangfusong"] = "E5002汉末风云",
    ["sfofl_shice"] = "势策",
    [":sfofl_shice"] = "转换技，①当你受到属性伤害时，若你的技能数不大于伤害来源，你可以防止此伤害并视为使用一张【火攻】；②当你不因此技能使用牌指定唯一目标后，你可以令其弃置装备区任意张牌，然后此牌额外结算X次（X为其装备区的牌数）。",
    [":sfofl_shice1"] = "转换技，①当你受到属性伤害时，若你的技能数不大于伤害来源，你可以防止此伤害并视为使用一张【火攻】；<font color=\"#01A5AF\"><s>②当你不因此技能使用牌指定唯一目标后，你可以令其弃置装备区任意张牌，然后此牌额外结算X次（X为其装备区的牌数）。</s></font>",
    [":sfofl_shice2"] = "转换技，<font color=\"#01A5AF\"><s>①当你受到属性伤害时，若你的技能数不大于伤害来源，你可以防止此伤害并视为使用一张【火攻】；</s></font>②当你不因此技能使用牌指定唯一目标后，你可以令其弃置装备区任意张牌，然后此牌额外结算X次（X为其装备区的牌数）。",
    ["@sfofl_shice"] = "势策：你可以防止此伤害并视为使用一张【火攻】",
    ["sfofl_podai"] = "破怠",
    [":sfofl_podai"] = "<font color=\"green\"><b>每轮各限一次，</b></font>一名角色的回合开始或结束时，你可以选择一顶：1.令其描述中含有基本牌名或数字的一个技能失效；2.令其摸三张牌，然后对其造成1点火焰伤害。",
    ["sfofl_podai:skill"] = "令 %src 描述中含有基本牌名或数字的一个技能失效",
    ["sfofl_podai:damage"] = "令 %src 摸三张牌，然后对其造成1点火焰伤害",
    ["sfofl_podaiskill"] = "破怠",

    ["sfofl_shenluzhi"] = "神卢植[官盗]",
    ["&sfofl_shenluzhi"] = "神卢植",
    ["#sfofl_shenluzhi"] = "鏖战广宗",
    ["illustrator:sfofl_shenluzhi"] = "聚一_L.M.YANG",
    ["information:sfofl_shenluzhi"] = "E5002汉末风云",
    ["sfofl_zhengan"] = "桢干",
    [":sfofl_zhengan"] = "每个回合结束时，若本回合有角色交给过其他角色手牌，或计算距离与回合开始时不同，你可以令其中至多两名角色依次可以视为使用一张基本牌。",
    ["@sfofl_zhengan_basic"] = "桢干：你可以视为使用一张 %src ",
    ["sfofl_zhengan_basic"] = "桢干",
    ["@sfofl_zhengan"] = "桢干：你可以令其中至多两名角色依次可以视为使用一张基本牌",
    ["@sfofl_zhenganUse"] = "桢干：你可以视为使用一张基本牌",
    ["sfofl_weizhu"] = "围铸",
    [":sfofl_weizhu"] = "出牌阶段限一次，你可以重铸任意张手牌，获得弃牌堆中等量张装备牌，然后你交给等量名其他角色各一张牌，以此法获得牌的角色本轮计算与除其以外的角色距离-1。",
    ["@sfofl_weizhu"] = "围铸：交给等量名其他角色各一张牌",
    ["@sfofl_weizhu_to"] = "围铸：交给 %src 一张牌",
    ["sfofl_zequan"] = "责权",
    [":sfofl_zequan"] = "你可以将一张装备牌当未以此法使用过的锦囊牌对体力不小于你的其他角色使用。",

    ["sfofl_shenzhujun"] = "神朱儁[官盗]",
    ["&sfofl_shenzhujun"] = "神朱儁",
    ["#sfofl_shenzhujun"] = "围师必阙",
    ["illustrator:sfofl_shenzhujun"] = "鱼仔",
    ["information:sfofl_shenzhujun"] = "E5002汉末风云",
    ["sfofl_cheji"] = "撤击",
    [":sfofl_cheji"] = "出牌阶段限一次，你可以重铸任意张牌，然后令一名其他角色重铸等量张手牌，若其重铸的牌包含：【杀】，你对其造成1点火焰伤害；【闪】，其对你指定的角色视为使用一张【杀】；【桃】，你与其各摸两张牌。",
    ["@sfofl_cheji"] = "撤击：视为对一名角色使用一张【杀】",
    ["sfofl_jicui"] = "急摧",
    [":sfofl_jicui"] = "锁定技，你的回合内，当一名角色使用属性【杀】指定目标后，目标角色需将其X张牌置于武将牌上直到回合结束，此【杀】伤害+1（X为本回合进入过弃牌堆的牌数）。",
    ["sfofl_kuixiang"] = "溃降",
    [":sfofl_kuixiang"] = "<font color=\"green\"><b>每名角色限一次，</b></font>其他角色脱离濒死状态时，你可以对其造成1点伤害，若因此杀死该角色，你摸三张牌。",
    ["sfofl_kuixiang:dying"] = "你可以发动“溃降”对 %src 造成1点伤害，若因此杀死该角色，你摸三张牌",

---E5003长安风云
    ["sfofl_2_lijue"] = "李傕[长安]",
    ["&sfofl_2_lijue"] = "李傕",
    ["#sfofl_2_lijue"] = "奸谋恶勇",
    ["illustrator:sfofl_2_lijue"] = "梦回唐朝",
    ["information:sfofl_2_lijue"] = "E5003长安风云",
    ["sfofl_cuixi"] = "摧袭",
    [":sfofl_cuixi"] = "出牌阶段限两次，你可以弃置任意张手牌，选择两名体力值小于你的角色，你与这些角色依次亮出牌堆顶的一张牌，点数不为最大的角色受到2点伤害。你可以令你的点数+X（X为你弃置的手牌数）。",
    ["sfofl_jujun"] = "聚军",
    [":sfofl_jujun"] = "限定技，出牌阶段，你可以将手牌和体力补至体力上限，若如此做，你不能回复体力直到你杀死一名角色。",

    ["sfofl_guosi"] = "郭汜[长安]",
    ["&sfofl_guosi"] = "郭汜",
    ["#sfofl_guosi"] = "党豺为虐",
    ["illustrator:sfofl_guosi"] = "MUMU",
    ["information:sfofl_guosi"] = "E5003长安风云",
    ["@sfofl_sixi"] = "伺袭：你可以视为使用一张刺【杀】",
    ["sfofl_sixi"] = "伺袭",
    [":sfofl_sixi"] = "出牌阶段限两次，你可以与一名角色拼点：若你赢，你可以视为使用一张刺【杀】；若你没赢，其计算与你的距离+1直到你下回合开始。当一次拼点结算后，你可以获得所有拼点牌。",
    ["sfofl_lvedao"] = "掠盗",
    [":sfofl_lvedao"] = "当你使用【杀】对一名角色造成伤害时，你可以获得其一张牌并令其减1点体力上限，其获得“避凶”。",
    ["sfofl_bixiong"] = "避凶",
    [":sfofl_bixiong"] = "限定技，出牌阶段，你可以弃置两张手牌，加1点体力上限。",

    ["sfofl_fanchou"] = "樊稠[长安]",
    ["&sfofl_fanchou"] = "樊稠",
    ["#sfofl_fanchou"] = "庸生变难",
    ["illustrator:sfofl_fanchou"] = "三道纹",
    ["information:sfofl_fanchou"] = "E5003长安风云",
    ["sfofl_qianmu"] = "浅目",
    [":sfofl_qianmu"] = "<font color=\"green\"><b>每回合各限一次，</b></font>你可以展示并将一张<font color='red'>♦</font>牌当基本牌、<font color='red'>♥</font>牌当锦囊牌使用或打出。",
    ["sfofl_qianmu_saveself"] = "浅目",
    ["sfofl_qianmu_Slash"] = "浅目【杀】",
    ["sfofl_xingwei"] = "兴威",
    [":sfofl_xingwei"] = "当你获得红色牌后，你可以展示之并摸一张牌；准备阶段或当你受到伤害后，你可以获得弃牌堆中的一张红色牌。",

    ["sfofl_zhangji"] = "张济[长安]",
    ["&sfofl_zhangji"] = "张济",
    ["#sfofl_zhangji"] = "武威雄豪",
    ["illustrator:sfofl_zhangji"] = "君桓文化",
    ["information:sfofl_zhangji"] = "E5003长安风云",
    ["@sfofl_silve"] = "伺袭：可以改为获得任意名角色合计至多两张牌",
    ["@sfofl_silve_put"] = "伺袭：将 %src 张牌置于武将牌上",
    ["sfofl_silve_lve"] = "掠",
    ["sfofl_silve"] = "肆掠",
    [":sfofl_silve"] = "摸牌阶段开始时，你可以改为获得任意名角色合计至多两张牌，然后将等量的牌置于武将牌上，称为“掠”。",
    ["sfofl_suibian:damage"] = "移去所有此花色的“掠”，对 %src 造成1点伤害",
    ["sfofl_suibian:draw"] = "与 %src 各摸一张牌",
    ["sfofl_suibian:nullified"] = "失去1点体力令 %src 无效，然后将 %src 交给一名角色并摸一张牌",
    ["@sfofl_suibian"] = "随变：将 %src 交给一名角色并摸一张牌",
    ["sfofl_suibian"] = "随变",
    [":sfofl_suibian"] = "一名角色使用与“掠”花色相同的牌时，你可以选择一项：1.移去所有此花色的“掠”，对其造成1点伤害；2.与其各摸一张牌；3.失去1点体力令此牌无效，然后将此牌交给一名角色并摸一张牌。",

    ["sfofl_wangyun"] = "王允[长安]",
    ["&sfofl_wangyun"] = "王允",
    ["#sfofl_wangyun"] = "忠魂不泯",
    ["illustrator:sfofl_wangyun"] = "L",
    ["information:sfofl_wangyun"] = "E5003长安风云",
    ["@sfofl_lianji"] = "连计：你视为使用 %src",
    ["@sfofl_lianji-damagecard"] = "连计：你令 %src 使用一张你选择的伤害牌",
    ["sfofl_lianjiDamage"] = "连计",
    [":sfofl_lianjiDamage"] = "你可以视为使用一张 王允 选择的伤害牌。",
    ["sfofl_lianji"] = "连计",
    [":sfofl_lianji"] = "出牌阶段限一次，你可以令一名其他角色摸一张牌，然后令其视为使用一张你选择的伤害牌。",
    ["sfofl_moucheng"] = "谋逞",
    [":sfofl_moucheng"] = "觉醒技，一名角色造成伤害后，若本局游戏“连计”造成过至少3点伤害，你增加1点体力上限并失去技能连计，然后回复1点体力并获得“矜功”。",
    ["sfofl_jingongz"] = "矜功",
    [":sfofl_jingongz"] = "出牌阶段限一次，你可以将一张【杀】或装备牌当锦囊牌使用，本回合结束时，若你本回合未造成过伤害，你失去1点体力。",

    ["sfofl_lvbu"] = "吕布[长安]",
    ["&sfofl_lvbu"] = "吕布",
    ["#sfofl_lvbu"] = "武的化身",
    ["illustrator:sfofl_lvbu"] = "SY",
    ["information:sfofl_lvbu"] = "E5003长安风云",
    ["sfofl_liyu"] = "利驭",
    [":sfofl_liyu"] = "出牌阶段限两次，你可以获得一名其他角色的一张牌，若如此做，本回合你使用【杀】或【决斗】造成的伤害+1，然后其视为对你使用一张【决斗】。",

    ["sfofl_shencaocao"] = "神曹操[长安]",
    ["&sfofl_shencaocao"] = "神曹操",
    ["#sfofl_shencaocao"] = "挟圣诏王",
    ["illustrator:sfofl_shencaocao"] = "云涯",
    ["information:sfofl_shencaocao"] = "E5003长安风云",
    ["sfofl_jieao"] = "桀骜",
    [":sfofl_jieao"] = "锁定技，当你翻面时，防止之，然后令所有其他角色依次失去1点体力。",
    ["sfofl_zhaozhao"] = "诏昭",
    [":sfofl_zhaozhao"] = "当你造成或受到1点伤害后，你可以摸一张牌，然后选择一项令伤害来源或受伤角色执行：1.从弃牌堆或场上获得一张装备牌并使用之，此牌置于一个额外装备栏；2.翻面并摸一张牌；3.减1点体力上限。",

    ["sfofl_lijueguosi"] = "神李傕郭汜[长安]",
    ["&sfofl_lijueguosi"] = "神李傕郭汜",
    ["#sfofl_lijueguosi"] = "祸乱长安",
    ["illustrator:sfofl_lijueguosi"] = "旭",
    ["information:sfofl_lijueguosi"] = "E5003长安风云",
    ["@sfofl_sixiong"] = "肆凶：你获得 %src 张“惧”",
    ["sfofl_sixiong:all"] = "所有手牌",
    ["sfofl_sixiong"] = "肆凶",
    [":sfofl_sixiong"] = "出牌阶段开始时，你可以展示所有手牌并弃置其中至少一种颜色的所有牌，若弃置：黑色，你获得等量张“惧”；红色，你对攻击范围内所有其他角色依次造成1点伤害。",
    ["sfofl_weiju_ju"] = "惧",
    ["@sfofl_weiju"] = "威惧：依次将任意张手牌置于其武将牌上直到回合结束",
    ["sfofl_weiju"] = "威惧",
    [":sfofl_weiju"] = "锁定技，准备阶段，所有其他角色依次将任意张手牌置于其武将牌上直到回合结束，称为“惧”。若一名角色的“惧”数不大于其手牌数，你与其互相视为在对方的攻击范围内。",

    ["sfofl_shenjiaxu"] = "神贾诩[长安]",
    ["&sfofl_shenjiaxu"] = "神贾诩",
    ["#sfofl_shenjiaxu"] = "丧尸出笼",
    ["illustrator:sfofl_shenjiaxu"] = "一品咸鱼堡",
    ["information:sfofl_shenjiaxu"] = "E5003长安风云",
    ["sfofl_longmu"] = "籠墓",
    [":sfofl_longmu"] = "锁定技，你的回合内其他角色不能回复体力。当你成为锦囊牌的目标时，取消之。当一名角色死亡后，若你对其发动过此武将牌上的技能且其不为丧尸，用丧尸代替该角色加入游戏。",
    ["sfofl_sangluan-invoke"] = "你可以发动“丧乱”<br/> <b>操作提示</b>: 选择一名其他角色→点击确定<br/>",
    ["sfofl_sangluan-slash"] = "丧乱：令 %src 对你指定的另一名角色使用一张【杀】<br/> <b>操作提示</b>: 选择一名其他角色→点击确定<br/>",
    ["@sfofl_sangluan"] = "丧乱：%src 令你对其指定的一名角色使用一张【杀】，否则你失去1点体力且 %src 回复1点体力",
    ["sfofl_sangluan_slash"] = "丧乱",
    ["sfofl_sangluan"] = "丧乱",
    [":sfofl_sangluan"] = "当你使用伤害牌后，你可以令一名其他角色对你指定的另一名角色使用一张【杀】，否则其失去1点体力且你回复1点体力。",
    ["sfofl_shibao"] = "尸暴",
    [":sfofl_shibao"] = "出牌阶段，你可以令一名丧尸失去所有体力，然后你对其上家和下家各造成1点伤害。",
    ["sfofl_chuce_saveself"] = "出策",
    ["sfofl_chuce_Slash"] = "出策【杀】",
    ["sfofl_chuceuse"] = "出策",
    ["sfofl_chuce"] = "出策",
    ["@sfofl_chuce"] = "出策：你可以视为使用 %src ",
    [":sfofl_chuce"] = "你可以将锦囊牌当任意基本牌或锦囊牌使用（无距离次数限制）。每回合限一次，当其他角色使用锦囊牌时，你可以摸三张牌令此牌无效，然后你可以视为使用之。",

    ["sfofl_zombie"] = "丧尸[长安]",
    ["&sfofl_zombie"] = "丧尸",
    ["#sfofl_zombie"] = "丧尸围城",
    ["illustrator:sfofl_zombie"] = "YanBai",
    ["information:sfofl_zombie"] = "E5003长安风云",
    ["sfofl_ganran"] = "感染",
    [":sfofl_ganran"] = "结束阶段，若你本回合杀死了一名角色且其不为丧尸，用丧尸代替该角色加入游戏，然后你回复所有体力并摸等量张牌。",
    ["sfofl_shibian"] = "尸变",
    [":sfofl_shibian"] = "锁定技，你保留所有技能，阵营和胜利条件变为和贾诩相同。",

    ["sfofl_lianshikui-invoke"] = "你可以发动“炼尸傀”<br/> <b>操作提示</b>: 选择一名丧尸→点击确定<br/>",
    ["LianShiKui"] = "炼尸傀",
    ["_sfofl_lianshikui"] = "炼尸傀",
    ["sfofl_lianshikui"] = "炼尸傀",
    ["_sfofl_lianshikui:hp"] = "回复1点体力",
    ["_sfofl_lianshikui:gainHujia"] = "获得1点护甲",
    [":_sfofl_lianshikui"] = " 装备牌/宝物\
        宝物技能：当一名非丧尸角色失去体力时，你可以令一名丧尸回复1点体力或获得1点护甲；当一名丧尸角色造成伤害时，你可以摸一张牌。",

    ["sfofl_shenwangyun"] = "神王允[长安]",
    ["&sfofl_shenwangyun"] = "神王允",
    ["#sfofl_shenwangyun"] = "百策御军",
    ["illustrator:sfofl_shenwangyun"] = "alien",
    ["information:sfofl_shenwangyun"] = "E5003长安风云",
    ["sfofl_anchao"] = "安朝",
    [":sfofl_anchao"] = "每个回合结束时，本回合每有一名角色使用过虚拟牌或转化牌，你可以摸一张牌并令“定西”可发动次数+1。",
    ["sfofl_dingxi_same"] = "“定西”连续相同",
    ["sfofl_dingxi_can"] = "“定西”可发动次数",
    ["sfofl_dingxi_saveself"] = "定西",
    ["sfofl_dingxi_Slash"] = "定西",
    ["sfofl_dingxi"] = "定西",
    ["#sfofl_dingxi"] = "%from 发动了“%arg2”，声明此牌为 【%arg】，指定的目标为 %to",
	["#sfofl_dingxiNoTarget"] = "%from 发动了“%arg2”，声明此牌为 【%arg】",
    [":sfofl_dingxi"] = "<font color=\"green\"><b>每局游戏限四次，</b></font>当你需使用非装备牌时，你可以展示牌堆顶的一张牌，若与你需使用的牌类别相同，视为你使用你需要的牌；否则你从牌堆底摸一张牌。每连续相同两次，你回复所有体力；每连续相同三次，你对所有其他角色各造成1点伤害。",
    ["sfofl_yurong"] = "御戎",
    [":sfofl_yurong"] = "锁定技，当你每轮首次成为一种牌名的伤害牌的目标时，取消之。",
    [":sfofl_yurong1"] = "锁定技，当你每轮首次成为一种牌名的伤害牌的目标时，取消之。",
    [":sfofl_yurong2"] = "锁定技，当你每轮首次成为一种牌名的伤害牌的目标时，取消之。\
				<font color=\"red\"><b>已记录：%arg11</b></font>",

    ["sfofl_soldier"] = "士兵[长安]",
    ["&sfofl_soldier"] = "士兵",
    ["#sfofl_soldier"] = "奉守殘城",
    ["illustrator:sfofl_soldier"] = "黑桃J",
    ["information:sfofl_soldier"] = "E5003长安风云",
    ["sfofl_gushou"] = "固守",
    [":sfofl_gushou"] = "当你成为【杀】的目标时，你可以摸一张牌并展示，若为基本牌，则你视为使用一张【闪】。",
    ["sfofl_xinkui"] = "心溃",
    [":sfofl_xinkui"] = "锁定技，结束阶段，若敌军角色的数量不少于我方，则你失去1点体力。",

---E5004渭南风云
    ["sfofl_4_caocao"] = "曹操[渭南]",
    ["&sfofl_4_caocao"] = "曹操",
    ["#sfofl_4_caocao"] = "乱世的奸雄",
    ["illustrator:sfofl_4_caocao"] = "小牛",
    ["information:sfofl_4_caocao"] = "E5004渭南风云",
    ["sfofl_dingluan:BearingDownBorder"] = "视为你对 %src 使用一张【大军压境】",
    ["sfofl_dingluan:skill"] = " %src 武将牌上的技能失效直到其回合结束",
    ["sfofl_dingluan"] = "定乱",
    [":sfofl_dingluan"] = "出牌阶段限一次，你可以失去1点体力，令一名其他角色选择一项：1.视为你对其使用一张【大军压境】；2.其武将牌上的技能失效直到其回合结束。",
    ["sfofl_qianjiang-invoke"] = "你可以发动“遣将”<br/> <b>操作提示</b>: 选择一名魏势力角色→点击确定<br/>",
    ["sfofl_qianjiang"] = "遣将",
    [":sfofl_qianjiang"] = "主公技，当一名角色阵亡后，你可以令一名魏势力角色与其交换座次。",
    ["@sfofl_bearing_down_border"] = "大军压境:选择是否将一张牌当一张无距离限制的【杀】对 %src 使用",
    ["BearingDownBorder"] = "大军压境",
    ["_sfofl_bearing_down_border"] = "大军压境",
    [":_sfofl_bearing_down_border"] = "锦囊牌·单目标锦囊\
        时机：出牌阶段，对一名角色使用\
        效果：其他所有角色依次选择是否将一张牌当一张无距离限制的【杀】对其使用。",

    ["sfofl_hansui"] = "韩遂[渭南]",
    ["&sfofl_hansui"] = "韩遂",
    ["#sfofl_hansui"] = "征西将军",
    ["illustrator:sfofl_hansui"] = "磐蒲",
    ["information:sfofl_hansui"] = "E5004渭南风云",
    ["sfofl_jubing"] = "举兵",
    [":sfofl_jubing"] = "每回合限一次，当一名角色受到伤害后，若其在群势力角色的攻击范围内，你可以弃置这些角色各一张牌，视为你对受伤角色使用X张【杀】（X为你以此法弃置的牌数）。",
    ["sfofl_2_xiongju"] = "雄踞",
    [":sfofl_2_xiongju"] = "主公技，与你势力相同的角色视为拥有技能“马术”。",
    ["sfofl_2_xiongju_mashu"] = "马术",
    [":sfofl_2_xiongju_mashu"] = "锁定技，你与其他角色的距离-1。",

    ["sfofl_xuhuang"] = "徐晃[渭南]",
    ["&sfofl_xuhuang"] = "徐晃",
    ["#sfofl_xuhuang"] = "乘虚渡江",
    ["illustrator:sfofl_xuhuang"] = "凝聚永恒",
    ["information:sfofl_xuhuang"] = "E5004渭南风云",
    ["sfofl_zhuying"] = "驻营",
    [":sfofl_zhuying"] = "每名角色的结束阶段，若你本回合未成为过其使用牌的目标，你获得一枚“驻”标记。",
    ["sfofl_chiyuan:prevented"] = "防止此伤害",
    ["sfofl_chiyuan:damage"] = "对 %src 造成1点伤害",
    ["@sfofl_chiyuan"] = "驰援：%src受到伤害，你可以弃置一张牌",
    ["sfofl_chiyuan"] = "驰援",
    [":sfofl_chiyuan"] = "出牌阶段，你可以交给任意名角色各一枚“驻”标记。有“驻”标记的角色受到伤害时，你可以弃置一张牌，然后选择一项：1.防止此伤害，然后移除其一枚“驻”标记；2.对伤害来源造成1点伤害。",

    ["sfofl_yangqiu"] = "杨秋[渭南]",
    ["&sfofl_yangqiu"] = "杨秋",
    ["#sfofl_yangqiu"] = "似若无敌",
    ["illustrator:sfofl_yangqiu"] = "Neko",
    ["information:sfofl_yangqiu"] = "E5004渭南风云",
    ["@sfofl_qifeng"] = "齐锋:你可以视为对 %src 使用一张伤害基数值为 %dest 的【杀】",
    ["sfofl_qifeng"] = "齐锋",
    [":sfofl_qifeng"] = "每个回合结束时，若你本回合失去过牌，你可以视为对其使用一张伤害基数值为X的【杀】（X为你本回合失去过的牌数）。",

    ["sfofl_chengyi"] = "成宜[渭南]",
    ["&sfofl_chengyi"] = "成宜",
    ["#sfofl_chengyi"] = "气高志远",
    ["illustrator:sfofl_chengyi"] = "陈鑫",
    ["information:sfofl_chengyi"] = "E5004渭南风云",
    ["sfofl_dutan"] = "独探",
    [":sfofl_dutan"] = "出牌阶段限一次，你可以视为使用一张指定任意名角色为目标的【决斗】。",

    ["sfofl_houxuan"] = "侯选[渭南]",
    ["&sfofl_houxuan"] = "侯选",
    ["#sfofl_houxuan"] = "合众复相",
    ["illustrator:sfofl_houxuan"] = "陈鑫",
    ["information:sfofl_houxuan"] = "E5004渭南风云",
    ["@sfofl_zhongtao"] = "众讨:你可以将一张牌当【杀】对相同的目标角色使用",
    ["sfofl_zhongtao"] = "众讨",
    [":sfofl_zhongtao"] = "与你距离1以内的角色使用【杀】结算结束后，你可以将一张牌当【杀】对相同的目标角色使用。",

    ["sfofl_zhanghe"] = "张郃[渭南]",
    ["&sfofl_zhanghe"] = "张郃",
    ["#sfofl_zhanghe"] = "料敌机先",
    ["illustrator:sfofl_zhanghe"] = "君桓文化",
    ["information:sfofl_zhanghe"] = "E5004渭南风云",
    ["@sfofl_qiaobian"] = "巧变:你可以将一张牌扣置于你的武将牌上",
    ["sfofl_qiaobian"] = "巧变",
    [":sfofl_qiaobian"] = "其他角色的准备阶段，你可以将一张牌扣置于你的武将牌上，称为“巧”。当其本回合使用牌后，你展示“巧”，若“巧”与此牌类别：相同，其获得“巧”，然后结束出牌阶段；不同，你摸一张牌。本回合结束阶段，你将“巧”收回手牌。",

    ["sfofl_zhuling"] = "朱灵[渭南]",
    ["&sfofl_zhuling"] = "朱灵",
    ["#sfofl_zhuling"] = "良将之亚",
    ["illustrator:sfofl_zhuling"] = "新艺族",
    ["information:sfofl_zhuling"] = "E5004渭南风云",
    ["sfofl_zhanyi"] = "战意",
    [":sfofl_zhanyi"] = "出牌阶段限一次，你可以失去1点体力并弃置一张基本牌或普通锦囊牌，然后你本回合该类别的牌额外结算一次。",

    ["sfofl_3_jiaxu"] = "贾诩[渭南]",
    ["&sfofl_3_jiaxu"] = "贾诩",
    ["#sfofl_3_jiaxu"] = "巧施间策",
    ["illustrator:sfofl_3_jiaxu"] = "匠人绘",
    ["information:sfofl_3_jiaxu"] = "E5004渭南风云",
    ["@sfofl_jianshu-pindian"] = "间书：你选择另一名其他角色与 %src 拼点",
    ["sfofl_jianshu"] = "间书",
    [":sfofl_jianshu"] = "出牌阶段限一次，你可以将一张牌交给一名其他角色，然后选择另一名其他角色，令这两名角色拼点：赢的角色弃置两张牌，没赢的角色失去1点体力。",
    ["@sfofl_zhenlue"] = "缜略:你可以弃置一张牌，令对 %src 此【无懈可击】无效 ",
    ["sfofl_zhenlue"] = "缜略",
    [":sfofl_zhenlue"] = "当一名角色使用【无懈可击】时，你可以弃置一张牌，令此【无懈可击】无效并获得之。",

    ["sfofl_shenmachao"] = "神马超[渭南]",
    ["&sfofl_shenmachao"] = "神马超",
    ["#sfofl_shenmachao"] = "麾骑撚枪",
    ["illustrator:sfofl_shenmachao"] = "君桓文化",
    ["information:sfofl_shenmachao"] = "E5004渭南风云",
    ["sfofl_yuma-invoke"] = "你可以发动“御马”<br/> <b>操作提示</b>: 选择一名角色→点击确定<br/>",
    ["sfofl_yuma"] = "御马",
    [":sfofl_yuma"] = "每回合限一次，当一张坐骑牌进入弃牌堆后，你可以将之置入一名角色的装备区，然后获得其所有手牌。",
    ["@sfofl_qiangshu"] = "枪术:你可以弃置 %src 张牌，令此伤害+ %src",
    ["sfofl_qiangshu"] = "枪术",
    [":sfofl_qiangshu"] = "当你使用【杀】或【决斗】造成伤害时，你可以弃置X张牌，令此伤害+X（X为你的攻击范围-1）。",

    ["sfofl_shenxuchu"] = "神许褚[渭南]",
    ["&sfofl_shenxuchu"] = "神许褚",
    ["#sfofl_shenxuchu"] = "猛虎战骊",
    ["illustrator:sfofl_shenxuchu"] = "鬼画府",
    ["information:sfofl_shenxuchu"] = "E5004渭南风云",
    ["sfofl_bozhan"] = "膊战",
    [":sfofl_bozhan"] = "其他角色的准备阶段，你可以废除一个装备栏，视为对其使用一张【决斗】。",
    ["sfofl_piwei"] = "羆威",
    [":sfofl_piwei"] = "锁定技，摸牌阶段，你多摸X张牌（X为你废除的装备栏数）。",

    ["sfofl_xiaoji"] = "骁骑[渭南]",
    ["&sfofl_xiaoji"] = "骁骑",
    ["#sfofl_xiaoji"] = "关中联军",
    ["illustrator:sfofl_xiaoji"] = "",
    ["information:sfofl_xiaoji"] = "E5004渭南风云",
    ["sfofl_tieti"] = "铁蹄",
    [":sfofl_tieti"] = "锁定技，距离与你为1的角色不可响应你使用的【杀】。",

    ["sfofl_bubing"] = "步兵[渭南]",
    ["&sfofl_bubing"] = "步兵",
    ["#sfofl_bubing"] = "护军甲卫",
    ["illustrator:sfofl_bubing"] = "",
    ["information:sfofl_bubing"] = "E5004渭南风云",
    ["sfofl_guwei"] = "固卫",
    [":sfofl_guwei"] = "距离与你为1的角色成为【杀】的目标时，你可以失去1点护甲，然后你代替成为此牌的目标。",

    ---E5006欧陆风云
    ["sfofl_caesar"] = "凯撒[欧陆]",
    ["&sfofl_caesar"] = "凯撒",
    ["#sfofl_caesar"] = "无冕之皇",
    ["illustrator:sfofl_caesar"] = "",
    ["information:sfofl_caesar"] = "E5006欧陆风云",
    ["sfofl_ducai"] = "独裁",
    [":sfofl_ducai"] = "持恒技，你的回合内使用牌无距离次数限制，其他角色不能使用牌且所有技能失效。",
    ["sfofl_zhitong"] = "治统",
    [":sfofl_zhitong"] = "转换技，当你使用牌时，若目标为①自己，摸两张牌目回复1点体力；②其他角色，你获得其装备区所有牌并对其造成1点伤害。",
    [":sfofl_zhitong1"] = "转换技，当你使用牌时，若目标为①自己，摸两张牌目回复1点体力；<font color=\"#01A5AF\"><s>②其他角色，你获得其装备区所有牌并对其造成1点伤害</s></font>。",
    [":sfofl_zhitong2"] = "转换技，当你使用牌时，若目标为<font color=\"#01A5AF\"><s>①自己，摸两张牌目回复1点体力；</s></font>②其他角色，你获得其装备区所有牌并对其造成1点伤害。",
    ["sfofl_jiquan"] = "集权",
    [":sfofl_jiquan"] = "主公技，锁定技，西势力角色的回合开始时，你回复1点体力并摸一张牌。",

    ["sfofl_macrinus"] = "马克里努斯[欧陆]",
    ["&sfofl_macrinus"] = "马克里努斯",
    ["#sfofl_macrinus"] = "传奇的角斗士",
    ["illustrator:sfofl_macrinus"] = "",
    ["information:sfofl_macrinus"] = "E5006欧陆风云",
    ["sfofl_dengtian"] = "登天",
    ["sfofl_dengtian_cardmax"] = "登天:手牌上限",
    ["sfofl_dengtian_draw"] = "登天:摸牌数",
    ["sfofl_dengtian_damage"] = "登天:伤害",
    [":sfofl_dengtian"] = "锁定技，每轮开始时，你选择以下一个选项的数值+1：\
    1.摸牌阶段摸牌数；2.手牌上限；3。每回合首次造成的伤害数。",
    ["sfofl_mingshu"] = "命数",
    [":sfofl_mingshu"] = "锁定技，当“登天”的某一选项【增加】的数值达到3或以上时，你失去X点体力（X为你的当前体力值）。",
    ["sfofl_juedou"] = "角斗",
    [":sfofl_juedou"] = "当其他角色对你使用【杀】后，若你未受到此【杀】造成的伤害，你可以视为对其使用一张无距离限制的【杀】。",

    ["sfofl_ardashirI"] = "阿尔达希尔一世[欧陆]",
    ["&sfofl_ardashirI"] = "阿尔达希尔一世",
    ["#sfofl_ardashirI"] = "萨珊的创始人",
    ["illustrator:sfofl_ardashirI"] = "",
    ["information:sfofl_ardashirI"] = "E5006欧陆风云",
    ["sfofl_wanwang"] = "万王",
    [":sfofl_wanwang"] = "每轮限一次，其他西势力的角色出牌阶段开始时，你可以代替其执行本阶段。",
    ["sfofl_sashan"] = "萨珊",
    [":sfofl_sashan"] = "锁定技，游戏开始时，你将全场势力改为西。",
    ["sfofl_nagong"] = "纳贡",
    ["@sfofl_nagong"] = "纳贡:你可以交给 %src 一张牌，将势力更改为群直到其下个回合开始",
    [":sfofl_nagong"] = "其他角色的准备阶段，其可以交给你一张牌，然后直到其下个回合开始时，其将势力更改为群。",

    ["sfofl_makang"] = "马抗[欧陆]",
    ["&sfofl_makang"] = "马抗",
    ["#sfofl_makang"] = "马米科尼扬",
    ["illustrator:sfofl_makang"] = "",
    ["information:sfofl_makang"] = "E5006欧陆风云",
    ["sfofl_xiru"] = "西入",
    [":sfofl_xiru"] = "锁定技，摸牌阶段，你的摸牌数+X（X为场上坐骑牌的数量的一半向上取整）。",
    ["@sfofl_zongma"] = "纵马:你可以将一张牌当防御/进攻坐骑牌置入一名角色对应的装备区内",
    ["sfofl_zongma"] = "纵马",
    [":sfofl_zongma"] = "出牌阶段开始时，你可以将一张牌当防御/进攻坐骑牌置入一名角色对应的装备区内，其受到/造成的伤害+1，当其受到/造成伤害时将此牌置入弃牌堆。",
    --mashu

    ["sfofl_romawarrior"] = "罗马力士[欧陆]",--5
    ["&sfofl_romawarrior"] = "罗马力士",
    ["#sfofl_romawarrior"] = "国王的精锐",
    ["illustrator:sfofl_romawarrior"] = "",
    ["information:sfofl_romawarrior"] = "E5006欧陆风云",
    ["sfofl_benyong"] = "贲勇",
    [":sfofl_benyong"] = "锁定技，你使用的牌其他角色需使用点数大于你的牌才能响应。",
    ["sfofl_jiaozi-invoke"] = "你可以发动“缴资”<br/> <b>操作提示</b>: 选择一名其他角色→点击确定<br/>",
    ["sfofl_jiaozi"] = "缴资",
    [":sfofl_jiaozi"] = "当你使用伤害牌结算结束后，你可以将此牌交给一名其他角色。",

    ["sfofl_yujin"] = "于禁[欧陆]",
    ["&sfofl_yujin"] = "于禁",
    ["#sfofl_yujin"] = "魏武之刚",
    ["illustrator:sfofl_yujin"] = "",
    ["information:sfofl_yujin"] = "E5006欧陆风云",
    ["sfofl_jieyue-invoke"] = "你可以发动“节钺”<br/> <b>操作提示</b>: 选择一名角色→点击确定<br/>",
    ["sfofl_jieyue"] = "节钺",
    [":sfofl_jieyue"] = "<font color=\"green\"><b>每轮各限一次，</b></font>结束阶段，你可以令一名角色摸一张牌，若如此做，其选择一项：1.令你摸三张牌；2.失去1点体力，令你执行一个额外的回合。",

    ["sfofl_zhangliao"] = "张辽[欧陆]",
    ["&sfofl_zhangliao"] = "张辽",
    ["#sfofl_zhangliao"] = "前将军",
    ["illustrator:sfofl_zhangliao"] = "",
    ["information:sfofl_zhangliao"] = "E5006欧陆风云",
    ["sfofl_tuxi"] = "突袭",
    [":sfofl_tuxi"] = "当你造成伤害后，你可以摸一张牌，然后获得受伤角色和其​​上下家各一张牌。",

    ["sfofl_yuejin"] = "乐进[欧陆]",
    ["&sfofl_yuejin"] = "乐进",
    ["#sfofl_yuejin"] = "奋强突固",
    ["illustrator:sfofl_yuejin"] = "",
    ["information:sfofl_yuejin"] = "E5006欧陆风云",
    ["sfofl_xiaoguo"] = "骁果",
    [":sfofl_xiaoguo"] = "出牌阶段，你可以弃置一张基本牌，对一名其他角色造成1点伤害，若有角色以此法进入濒死状态，此技能本回合失效。",

    ["sfofl_hubaoduwei"] = "虎豹都尉[欧陆]",
    ["&sfofl_hubaoduwei"] = "虎豹都尉",
    ["#sfofl_hubaoduwei"] = "护卫将军",
    ["illustrator:sfofl_hubaoduwei"] = "",
    ["information:sfofl_hubaoduwei"] = "E5006欧陆风云",
    --镇卫
    ["sfofl_daidi-invoke"] = "你可以发动“待敌”<br/> <b>操作提示</b>: 选择一名角色→点击确定<br/>",
    ["sfofl_daidi"] = "待敌",
    [":sfofl_daidi"] = "每回合限一次，当你成为其他角色牌的目标时，你可以进行一次判定，若颜色和此牌相同，你可以令一名角色获得此判定牌。",

    ["sfofl_shichen"] = "使臣[欧陆]",--3
    ["&sfofl_shichen"] = "使臣",
    ["#sfofl_shichen"] = "奉诏出使",
    ["illustrator:sfofl_shichen"] = "",
    ["information:sfofl_shichen"] = "E5006欧陆风云",
    ["sfofl_dizhaoheal"] = "帝诏", 
    ["sfofl_dizhao"] = "帝诏", 
    [":sfofl_dizhao"] = "<font color=\"green\"><b>每轮各限一次，</b></font>你可以视为使用一张：基本牌，然后令一名其他角色摸一张牌；锦囊牌，然后令一名角色回复1点体力。",

    ["sfofl_cavalry"] = "骑兵[欧陆]",
    ["&sfofl_cavalry"] = "骑兵",
    ["#sfofl_cavalry"] = "凉州铁骑",
    ["illustrator:sfofl_cavalry"] = "",
    ["information:sfofl_cavalry"] = "E5006欧陆风云",
    --mashu
    ["sfofl_jixi"] = "疾袭", 
    [":sfofl_jixi"] = "当你使用【杀】时，若其装备区内的牌数不小于你，你可以选择一项：1.获得其一张牌；2.令此【杀】不可响应并摸一张牌。",

    ["sfofl_batteringram"] = "冲车",
    [":sfofl_batteringram"] = " 装备牌/宝物\
        宝物技能：出牌阶段限一次，当你装备区的牌数不小于2时，你可以弃置装备区内除此牌以外的所有牌，然后对一名角色造成1点伤害。",
    ["sfofl_bladecart"] = "刀车",
    [":sfofl_bladecart"] = " 装备牌/宝物\
        宝物技能：当你成为其他角色伤害牌的目标后，你可以进行一次判定，若花色和该伤害牌一致，你于此牌结算结束后对其造成1点伤害。",


}

--舊戰役篇
sgs.LoadTranslationTable {

    --S1015战役篇01 黄巾之乱-黄天当立
    --S1016战役篇02 虎牢关之战-三英战吕布
    --S1018战役篇03 界桥之战-少年赵子龙
    --S1028战役篇04 长安之乱-十八路诸侯伐董
    --S1023战役篇05 宛城之战-战神典韦
    --S1022战役篇06 下邳之战-吕布之死
    --S1019战役篇07 官渡之战-火烧乌巢
    --S1017战役篇08 赤壁之战-借东风
    --S1029战役篇09 渭水之战-裸衣战马超
    --S1036战役篇10 合肥之战-威震逍遥津
    --S1035战役篇11 襄樊之战-水淹七军
    --S1020战役篇12 定军山之战-黄忠斩夏侯
    --S1024战役篇13 夷陵之战-火烧联营
    --S1025战役篇14 南中平之战-七擒孟获
    --S1030战役篇15 五丈原之战-六出祁山
    --S1034战役篇16 天下一统-三国归晋

    ["sfofl_w_shenzhangliang"] = "神张梁[战役]",
    ["&sfofl_w_shenzhangliang"] = "神张梁",
    ["#sfofl_w_shenzhangliang"] = "人公将军",
    ["information:sfofl_w_shenzhangliang"] = "S1015战役篇01 黄巾之乱-黄天当立",
    ["sfofl_huangjin"] = "黄巾",
    ["sfofl_rengong-invoke"] = "你可以发动“人公”<br/> <b>操作提示</b>: 选择一名其他角色→点击确定<br/>",
    ["sfofl_rengong"] = "人公",
    [":sfofl_rengong"] = "出牌阶段，你可以将任意张牌置于你的武将牌上；你每有一张牌移出游戏时，便可以弃置其他角色的一张牌。",
    ["sfofl_guiji"] = "鬼继",
    [":sfofl_guiji"] = "锁定技，当你死亡时，你所属区域里的牌与武将牌上的牌保留给下一名登场角色。",
    ["sfofl_xueni"] = "血逆",
    [":sfofl_xueni"] = "锁定技，结束阶段，若你的武将牌上有相同点数的牌，你死亡。",

    ["sfofl_w_shenzhangbao"] = "神张宝[战役]",
    ["&sfofl_w_shenzhangbao"] = "神张宝",
    ["#sfofl_w_shenzhangbao"] = "地公将军",
    ["information:sfofl_w_shenzhangbao"] = "S1015战役篇01 黄巾之乱-黄天当立",
    ["sfofl_degong"] = "地公",
    [":sfofl_degong"] = "出牌阶段，你可以用任意张手牌替换武将牌上的牌。",
    ["sfofl_chedian-invoke"] = "你可以发动“掣电”<br/> <b>操作提示</b>: 选择一名体力值不少于你的角色→点击确定<br/>",
    ["sfofl_chedian"] = "掣电",
    [":sfofl_chedian"] = "结束阶段，你可以对一名体力值不少于你的角色造成1点雷电伤害。",

    ["sfofl_w_shenzhangjiao"] = "神张角[战役]",
    ["&sfofl_w_shenzhangjiao"] = "神张角",
    ["#sfofl_w_shenzhangjiao"] = "天公将军",
    ["information:sfofl_w_shenzhangjiao"] = "S1015战役篇01 黄巾之乱-黄天当立",
    ["sfofl_tiangong"] = "天公",
    [":sfofl_tiangong"] = "你可以将武将牌上的牌如手牌般使用或打出。",
    --雷击
    --鬼道
    --挑衅

    --S1015战役篇01 黄巾之乱-黄天当立

    ["sfofl_w_kongrong"] = "孔融[战役]",
    ["&sfofl_w_kongrong"] = "孔融",
    ["#sfofl_w_kongrong"] = "凛然重义",
    ["information:sfofl_w_kongrong"] = "S1016战役篇02 虎牢关之战-三英战吕布",
    ["sfofl_mingshi"] = "名士",
    [":sfofl_mingshi"] = "锁定技，若你的装备区里没有防具牌，属性【杀】对你无效。",
    --礼让

    ["sfofl_w_mateng"] = "马腾[战役]",
    ["&sfofl_w_mateng"] = "马腾",
    ["#sfofl_w_mateng"] = "驰骋西陲",
    ["information:sfofl_w_mateng"] = "S1016战役篇02 虎牢关之战-三英战吕布",
    --马术
    ["sfofl_fubo"] = "伏波",
    [":sfofl_fubo"] = "出牌阶段开始时，你视为使用一张【以逸待劳】。",
    --S1016战役篇02 虎牢关之战-三英战吕布

    
    ["sfofl_w_shenyuanshao"] = "袁绍[战役]",
    ["&sfofl_w_shenyuanshao"] = "袁绍",
    ["#sfofl_w_shenyuanshao"] = "乱箭肃敌",
    ["information:sfofl_w_shenyuanshao"] = "S1018战役篇03 界桥之战-少年赵子龙",
    ["sfofl_buzhan"] = "步战",
    [":sfofl_buzhan"] = "锁定技，你不能装备坐骑牌。你的攻击范围+X（X为你损失的体力值）。",
    ["sfofl_n_linzhen"] = "临阵",
    [":sfofl_n_linzhen"] = "出牌阶段，你可以失去1点体力，若如此做，你可以摸三张牌并将其交给任意名角色。",
    ["sfofl_nujianAttach"] = "弩箭",
    [":sfofl_nujianAttach"] = "当你需要使用或打出【杀】时，袁绍 可以弃置一张“箭”，视为你使用或打出一张【杀】",
    ["@sfofl_nujian"] = "弩箭:你可以弃置一张“箭”，视为 %src 使用或打出一张【杀】",
    ["sfofl_nujian_jian"] = "箭",
    ["sfofl_nujian"] = "弩箭",
    [":sfofl_nujian"] = "出牌阶段，你可以弃置一张装备牌，将牌堆顶两张牌置于你的武将牌上称为“箭”。当一名角色需要使用或打出【杀】时，你可以弃置一张“箭”，视为该角色使用或打出一张【杀】。",

    ["sfofl_w_wenchou"] = "文丑[战役]",
    ["&sfofl_w_wenchou"] = "文丑",
    ["#sfofl_w_wenchou"] = "夔威天下",
    ["information:sfofl_w_wenchou"] = "S1018战役篇03 界桥之战-少年赵子龙",
    --步战
    ["sfofl_2_xuezhan"] = "血战",
    [":sfofl_2_xuezhan"] = "锁定技，当你装备一张装备牌时，将牌堆顶上的一张牌置于你的武将牌上，称为“战”；你的摸牌阶段摸牌数+X（X为“战”的数量）。你可以将“战”和装备牌当【决斗】使用。",

    ["sfofl_w_gongsunzan"] = "公孙瓒[战役]",
    ["&sfofl_w_gongsunzan"] = "公孙瓒",
    ["#sfofl_w_gongsunzan"] = "白马将军",
    ["information:sfofl_w_gongsunzan"] = "S1018战役篇03 界桥之战-少年赵子龙",
    ["@sfofl_2_qizhen"] = "骑阵:你可以对 %src 使用一张杀",
    ["sfofl_2_qizhen-invoke"] = "你可以发动“骑阵”<br/> <b>操作提示</b>: 选择一名角色→点击确定<br/>",
    ["sfofl_2_qizhen"] = "骑阵",
    [":sfofl_2_qizhen"] = "当你使用【杀】结算后，若此【杀】造成伤害，你摸2张牌；若此【杀】被抵消，你可以将此【闪】交给一名角色，若如此做，该角色可以对目标使用一张【杀】。",
    --义从
    --S1018战役篇03 界桥之战-少年赵子龙

    ["sfofl_w_lijue"] = "李傕[战役]",
    ["&sfofl_w_lijue"] = "李傕",
    ["#sfofl_w_lijue"] = "池阳侯",
    ["information:sfofl_w_lijue"] = "S1028战役篇04 长安之乱-十八路诸侯伐董",
    --杨武
    ["sfofl_mojun"] = "魔军",
	[":sfofl_mojun"] = "锁定技，当你使用【杀】对目标角色造成伤害后，其判定，若结果为黑色，你摸一张牌。",
    --S1028战役篇04 长安之乱-十八路诸侯伐董

    ["sfofl_w_dianwei"] = "典韦[战役]",
    ["&sfofl_w_dianwei"] = "典韦",
    ["#sfofl_w_dianwei"] = "古之恶来",
    ["information:sfofl_w_dianwei"] = "S1023战役篇05 宛城之战-战神典韦",
    ["sfofl_sizhan"] = "死战",
	[":sfofl_sizhan"] = "当你受到一次伤害后，你可以与伤害来源拼点：若你赢，你回复1点体力。",
    ["@sfofl_huzhu"] = "护主:交给 %src 一张牌",
    ["sfofl_huzhu"] = "护主",
	[":sfofl_huzhu"] = "其他角色受到1点伤害后，你可以摸一张牌交给其一张牌。",

    ["sfofl_w_caoanmin"] = "曹安民[战役]",
    ["&sfofl_w_caoanmin"] = "曹安民",
    ["#sfofl_w_caoanmin"] = "飘取祸水",
    ["information:sfofl_w_caoanmin"] = "S1023战役篇05 宛城之战-战神典韦",
    ["@sfofl_kuishe"] = "窥舍:你可以对 %src 使用一张【杀】",
    ["sfofl_kuishe"] = "窥舍",
	[":sfofl_kuishe"] = "出牌阶段限一次，你选择一名其他角色的一张牌交给你选择的另一名角色，若如此做，失去牌的角色可以对你使用一张【杀】。",
    --S1023战役篇05 宛城之战-战神典韦

    --S1022战役篇06 下邳之战-吕布之死

    ["sfofl_w_chunyuqiong"] = "淳于琼[战役]",
    ["&sfofl_w_chunyuqiong"] = "淳于琼",
    ["#sfofl_w_chunyuqiong"] = "昔袍今臣",
    ["information:sfofl_w_chunyuqiong"] = "S1019战役篇07 官渡之战-火烧乌巢",
    ["sfofl_wuchao"] = "乌巢",
    [":sfofl_wuchao"] = "锁定技，当你死亡时，你所属区域里的牌与武将牌上的牌保留给下一名登场角色。",
    ["sfofl_wuchaoliang"] = "粮",
    ["sfofl_cangchu"] = "仓储",
    [":sfofl_cangchu"] = "出牌阶段开始时，你可以把牌堆顶两张牌正面向上置于你的武将牌上称为“粮”。若如此做，你视为使用一张【酒】。",
    ["sfofl_liangying"] = "粮营",
    [":sfofl_liangying"] = "锁定技，你受到的火属性伤害+1。回合结束时，你摸两张牌。",

    ["sfofl_w_zhanghe"] = "张郃[战役]",
    ["&sfofl_w_zhanghe"] = "张郃",
    ["#sfofl_w_zhanghe"] = "名门的梁柱",
    ["information:sfofl_w_zhanghe"] = "S1019战役篇07 官渡之战-火烧乌巢",
    --乌巢
    ["sfofl_yuanlue"] = "远略",
    [":sfofl_yuanlue"] = "出牌阶段限一次，若你的装备区里有牌且数量为全埸最多，你可以对一名角色造成1点伤害。",
    ["sfofl_benxi-invoke"] = "你可以发动“奔袭”<br/> <b>操作提示</b>: 选择一名角色→点击确定<br/>",
    ["sfofl_benxi"] = "奔袭",
    [":sfofl_benxi"] = "<font color=\"green\"><b>每名角色限一次，</b></font>一名角色的结束阶段，你可以将埸上一张牌置于你的武将牌上称为“粮”。",

    ["sfofl_w_yuanshao"] = "袁绍[战役]",
    ["&sfofl_w_yuanshao"] = "袁绍",
    ["#sfofl_w_yuanshao"] = "高贵的名门",
    ["information:sfofl_w_yuanshao"] = "S1019战役篇07 官渡之战-火烧乌巢",
    --乌巢
    ["@sfofl_wuduan"] = "无断:你可以弃置一张牌或“粮”",
    ["sfofl_wuduan"] = "无断",
    [":sfofl_wuduan"] = "准备阶段，你可以弃置一张牌或“粮”获得“急攻”和“渐营”直到回合结束。",
    ["sfofl_juezhan"] = "决战",
    [":sfofl_juezhan"] = "锁定技，你可以把武将牌上的“粮”当手牌般使用或打出。",
    ["sfofl_shaomou"] = "少谋",
    [":sfofl_shaomou"] = "当你受到1点伤害时，若你有牌，你需要弃置一张“粮”，视为对伤害来源使用一张【杀】。",

    ["sfofl_w_zhangfei"] = "张飞[战役]",
    ["&sfofl_w_zhangfei"] = "张飞",
    ["#sfofl_w_zhangfei"] = "万夫不当",
    ["information:sfofl_w_zhangfei"] = "S1019战役篇07 官渡之战-火烧乌巢",
    --咆哮
    ["sfofl_w_liubei"] = "刘备[战役]",
    ["&sfofl_w_liubei"] = "刘备",
    ["#sfofl_w_liubei"] = "乱世的枭雄",
    ["information:sfofl_w_liubei"] = "S1019战役篇07 官渡之战-火烧乌巢",
    ["@sfofl_rende"] = "仁德:你可以视为使用 %src",
    ["sfofl_rende_basic"] = "仁德",
    ["sfofl_rende"] = "仁德",
    [":sfofl_rende"] = "出牌阶段，你可以将任意手牌交给其他角色，每回合你以此法给出第二张牌时，你可以视为使用一张基本牌。",
    --S1019战役篇07 官渡之战-火烧乌巢


    ["sfofl_w_caocao"] = "曹操[战役]",
    ["&sfofl_w_caocao"] = "曹操",
    ["#sfofl_w_caocao"] = "魏武霸业",
    ["information:sfofl_w_caocao"] = "S1017战役篇08 赤壁之战-借东风",
    ["@sfofl_lianzhou"] = "连舟:你弃置一张红色牌，否则对 %src 伤害-1",
    ["sfofl_lianzhou"] = "连舟",
    [":sfofl_lianzhou"] = "其他角色使用黑色牌对你造成伤害时，除非该角色弃置一张红色牌，否则此伤害-1。",
    --奸雄
    --英姿
    
    --S1017战役篇08 赤壁之战-借东风
    --S1029战役篇09 渭水之战-裸衣战马超
    --S1036战役篇10 合肥之战-威震逍遥津

    ["sfofl_w_pochengguanyu"] = "破城关羽[战役]",
    ["&sfofl_w_pochengguanyu"] = "破城关羽",
    ["#sfofl_w_pochengguanyu"] = "水淹七军",
    ["information:sfofl_w_pochengguanyu"] = "--S1035战役篇11 襄樊之战-水淹七军",
    --武圣
    --义绝
    ["@sfofl_pocheng"] = "破城:你弃置两张牌",
    ["@sfofl_pocheng_target"] = "破城: %src 令你弃置一张装备牌或受到1点伤害",
    ["sfofl_pocheng"] = "破城",
    [":sfofl_pocheng"] = "摸牌阶段，若你当前的体力值不大于3，你可以多摸一张牌，然后弃置两张牌，令一名其他角色选择一项：1.弃置一张装备牌，你回复1点体力；2.受到1点伤害，你弃置其一张手牌。",

    ["sfofl_w_jushoucaoren"] = "据守曹仁[战役]",
    ["&sfofl_w_jushoucaoren"] = "据守曹仁",
    ["#sfofl_w_jushoucaoren"] = "力守樊城",
    ["information:sfofl_w_jushoucaoren"] = "--S1035战役篇11 襄樊之战-水淹七军",
    ["@sfofl_shoufan"] = "守樊:你从中弃一张牌",
    ["sfofl_shoufan_equip"] = "守樊:使用装备",
    ["sfofl_shoufan"] = "守樊",
    [":sfofl_shoufan"] = "回合结束时，你可以摸3张牌，并从中弃一张牌，若你弃置的是装备牌，你可以改为使用之。",
    ["@sfofl_dunji"] = "盾击:你可视为使用一张杀",
    ["sfofl_dunji"] = "盾击",
    [":sfofl_dunji"] = "每回合限一次，当你于回合内使用装备牌结算结束后，你可视为使用一张杀。",
    ["sfofl_gucheng"] = "固城",
    [":sfofl_gucheng"] = "锁定技，你的手牌上限始终为4；若你的装备区里没有防具牌，你视为装备着仁王盾。",

    --S1035战役篇11 襄樊之战-水淹七军
    --S1020战役篇12 定军山之战-黄忠斩夏侯
    --S1024战役篇13 夷陵之战-火烧联营

    ["sfofl_w_shenmenghuo_7"] = "神孟获[战役]",
    ["&sfofl_w_shenmenghuo_7"] = "神孟获",
    ["#sfofl_w_shenmenghuo_7"] = "南蛮王",
    ["information:sfofl_w_shenmenghuo_7"] = "--S1025战役篇14 南中平之战-七擒孟获",
    ["sfofl_w_shenmenghuo_6"] = "神孟获[战役]",
    ["&sfofl_w_shenmenghuo_6"] = "神孟获",
    ["#sfofl_w_shenmenghuo_6"] = "南蛮王",
    ["information:sfofl_w_shenmenghuo_6"] = "--S1025战役篇14 南中平之战-七擒孟获",
    ["sfofl_w_shenmenghuo_5"] = "神孟获[战役]",
    ["&sfofl_w_shenmenghuo_5"] = "神孟获",
    ["#sfofl_w_shenmenghuo_5"] = "南蛮王",
    ["information:sfofl_w_shenmenghuo_5"] = "--S1025战役篇14 南中平之战-七擒孟获",
    ["sfofl_w_shenmenghuo_4"] = "神孟获[战役]",
    ["&sfofl_w_shenmenghuo_4"] = "神孟获",
    ["#sfofl_w_shenmenghuo_4"] = "南蛮王",
    ["information:sfofl_w_shenmenghuo_4"] = "--S1025战役篇14 南中平之战-七擒孟获",
    ["sfofl_w_shenmenghuo_3"] = "神孟获[战役]",
    ["&sfofl_w_shenmenghuo_3"] = "神孟获",
    ["#sfofl_w_shenmenghuo_3"] = "南蛮王",
    ["information:sfofl_w_shenmenghuo_3"] = "--S1025战役篇14 南中平之战-七擒孟获",
    ["sfofl_w_shenmenghuo_2"] = "神孟获[战役]",
    ["&sfofl_w_shenmenghuo_2"] = "神孟获",
    ["#sfofl_w_shenmenghuo_2"] = "南蛮王",
    ["information:sfofl_w_shenmenghuo_2"] = "--S1025战役篇14 南中平之战-七擒孟获",
    ["sfofl_w_shenmenghuo_1"] = "神孟获[战役]",
    ["&sfofl_w_shenmenghuo_1"] = "神孟获",
    ["#sfofl_w_shenmenghuo_1"] = "南蛮王",
    ["information:sfofl_w_shenmenghuo_1"] = "--S1025战役篇14 南中平之战-七擒孟获",

    --祸首
    --再起
    ["sfofl_fuzhan"] = "复战",
    [":sfofl_fuzhan"] = "锁定技，<font color=\"green\"><b>每局游戏限两次，</b></font>当你进入濒死状态时，将你武将牌随机替换成一个未出埸的孟获并将手牌补至4张，弃置判定区内的牌，立刻进入你的回合。",

    ["sfofl_jiedao"] = "截刀",
    [":sfofl_jiedao"] = "继承技，当你每回合第一次造成伤害时，你可令此伤害+1，然后若受到此伤害的角色没有死亡，你弃置一张牌。",

    ["sfofl_qukui-invoke"] = "你可以发动“渠魁”<br/> <b>操作提示</b>: 选择一名角色→点击确定<br/>",
    ["sfofl_qukui"] = "渠魁",
    [":sfofl_qukui"] = "继承技，准备阶段，你可以失去1点体力弃置一名角色区域里的至多2张牌。",

    ["sfofl_liefu"] = "烈斧",
    [":sfofl_liefu"] = "继承技，当你使用杀指定目标后，你可以与其拼点，若你赢，你获得其一张牌。",

    ["sfofl_bingman"] = "并蛮",
    [":sfofl_bingman"] = "继承技，出牌阶段限一次，你可以观看牌堆项三张牌，然后展示其中任意数量红色牌并获得之，其余以任意顺序置于牌堆顶。",

    ["sfofl_nanbing"] = "南兵",
    [":sfofl_nanbing"] = "继承技，出牌阶段，你可以将所有手牌当做南蛮入侵使用。",

    ["sfofl_sunshou"] = "损寿",
    [":sfofl_sunshou"] = "继承技，你不会成为黑色牌的目标，你的黑色牌目标数+1。",

    ["sfofl_zaizheng"] = "再整",
    [":sfofl_zaizheng"] = "继承技，出牌阶段限一次，你可以摸三张牌然后弃置埸上一张牌，若如此做，你本回合的手牌上限等于你此阶段造成的伤害值。",


    --S1025战役篇14 南中平之战-七擒孟获
    --S1030战役篇15 五丈原之战-六出祁山

    ["sfofl_w_jinsimayi"] = "晋司马懿[战役]",
    ["&sfofl_w_jinsimayi"] = "晋司马懿",
    ["#sfofl_w_jinsimayi"] = "三狼吞魏",
    ["information:sfofl_w_jinsimayi"] = "--S1034战役篇16 天下一统-三国归晋",
    --忍戒
    --拜印

    ["sfofl_w_jinsimazhao"] = "司马昭[战役]",
    ["&sfofl_w_jinsimazhao"] = "司马昭",
    ["#sfofl_w_jinsimazhao"] = "四海威伏",
    ["information:sfofl_w_jinsimazhao"] = "--S1034战役篇16 天下一统-三国归晋",
    ["sfofl_shidi-invoke"] = "你可以发动“弑敌”<br/> <b>操作提示</b>: 选择一名角色→点击确定<br/>",
    ["sfofl_shidi"] = "弑敌",
    [":sfofl_shidi"] = "回合开始阶段，你可以指定一名角色观看你的手牌并弃置其中一张，你对其造成1点伤害。",
    ["@sfofl_zhaoxin_target"] = "昭心:你选择交给 %src 一张手牌或受到1点伤害",
    ["sfofl_zhaoxin"] = "昭心",
    [":sfofl_zhaoxin"] = "限定技，出牌阶段，你可以展出你所有的手牌，所有其他角色选择交给你一张手牌或受到1点伤害。",

    --S1034战役篇16 天下一统-三国归晋


    ["sfofl_nw_shenzhangliang"] = "神张梁[战役]",
    ["&sfofl_nw_shenzhangliang"] = "神张梁",
    ["#sfofl_nw_shenzhangliang"] = "人公将军",
    ["information:sfofl_nw_shenzhangliang"] = "E0026《群雄逐鹿》",
    ["@sfofl_n_rengong"] = "人公:你可以将一张牌置于你的武将牌上",
    ["sfofl_n_rengong"] = "人公",
    [":sfofl_n_rengong"] = "<font color=\"green\"><b>每名角色的结束阶段限一次，</b></font>你可以将一张牌置于你的武将牌上然后摸两张牌。",
    --鬼继
    --血逆

    ["sfofl_nw_shenzhangbao"] = "神张宝[战役]",
    ["&sfofl_nw_shenzhangbao"] = "神张宝",
    ["#sfofl_nw_shenzhangbao"] = "地公将军",
    ["information:sfofl_nw_shenzhangbao"] = "E0026《群雄逐鹿》",
    --地公
    ["sfofl_n_chedian"] = "掣电",
    [":sfofl_n_chedian"] = "其他角色的结束阶段，你可以对其造成一点雷电伤害。",

    ["sfofl_nw_shenzhangjiao"] = "神张角[战役]",
    ["&sfofl_nw_shenzhangjiao"] = "神张角",
    ["#sfofl_nw_shenzhangjiao"] = "天公将军",
    ["information:sfofl_nw_shenzhangjiao"] = "E0026《群雄逐鹿》",
    ["sfofl_n_tiangong"] = "天公",
    [":sfofl_n_tiangong"] = "准备阶段你摸两张牌，你可以将武将牌上的牌如手牌般使用或打出。",
    --雷击
    ["sfofl_n_leiming"] = "雷鸣",
    [":sfofl_n_leiming"] = "你可以将【杀】当做雷【杀】使用。每当有角色受到1点雷电伤害时，你可以摸一张牌。",
    ["@sfofl_n_guishen-card"] = "请发动“%dest”来修改 %src 的“%arg”判定",
    ["sfofl_n_guishen"] = "鬼神",
    [":sfofl_n_guishen"] = "当一名角色的判定牌生效前，你可以打出一张牌替换之。",
    --挑衅

    ["sfofl_nw_shenyuanshao"] = "袁绍[战役]",
    ["&sfofl_nw_shenyuanshao"] = "袁绍",
    ["#sfofl_nw_shenyuanshao"] = "乱箭肃敌",
    ["information:sfofl_nw_shenyuanshao"] = "E0026《群雄逐鹿》",
    --步战
    ["sfofl_n_luanjian"] = "乱箭",
    [":sfofl_n_luanjian"] = "摸牌阶段，你可以额外摸两张牌，然后弃置X张牌（X为你装备区牌的数量）。<font color=\"green\"><b>出牌阶段，</b></font>你可以将两张手牌当【万箭齐发】使用（不能使用本回合发动此技能时已用过的花色）。",

    ["sfofl_nw_wenchou"] = "文丑[战役]",
    ["&sfofl_nw_wenchou"] = "文丑",
    ["#sfofl_nw_wenchou"] = "夔威天下",
    ["information:sfofl_nw_wenchou"] = "E0026《群雄逐鹿》",
    ["sfofl_n_xuezhan"] = "血战",
    [":sfofl_n_xuezhan"] = "摸牌阶段，你可以额外摸两张牌，然后弃置X张牌（X为你装备区牌的数量）。<font color=\"green\"><b>出牌阶段，</b></font>你可以将装备牌当【决斗】使用。",
    --弩箭
    ["sfofl_n_jadeseal"] = "玉玺",
    [":sfofl_n_jadeseal"] = "装备牌/宝物<br/><b>宝物技能</b>：锁定技，摸牌阶段摸牌时，你额外摸一张牌；出牌阶段开始时，你观看一名其他角色的所有手牌。\
    锁定技，当你死亡时，杀死你的角色获得你装备区的玉壐。",

    ["sfofl_nw_jiaxu"] = "贾诩[战役]",
    ["&sfofl_nw_jiaxu"] = "贾诩",
    ["#sfofl_nw_jiaxu"] = "世之观者",
    ["information:sfofl_nw_jiaxu"] = "E0026《群雄逐鹿》",
    ["sfofl_n_bishi"] = "避世",
    [":sfofl_n_bishi"] = "当你成为其他角色使用的【杀】的目标后，你可以令其摸一张牌令此【杀】无效。",
    ["sfofl_n_jianbing"] = "谏兵",
    [":sfofl_n_jianbing"] = "当一名其他角色受到【杀】的伤害时，你可以获得其一张牌，如果该牌是红桃，其回复1点体力。",
    --帷幕

    ["sfofl_nw_fanchou"] = "樊稠[战役]",
    ["&sfofl_nw_fanchou"] = "樊稠",
    ["#sfofl_nw_fanchou"] = "庸生变难",
    ["information:sfofl_nw_fanchou"] = "E0026《群雄逐鹿》",
    ["sfofl_n_yangwu"] = "扬武",
    [":sfofl_n_yangwu"] = "出牌阶段限一次，你可以选择一名手牌比你多的角色，观看其所有手牌并获得其一张牌。",

    ["sfofl_nw_wangyun"] = "王允[战役]",
    ["&sfofl_nw_wangyun"] = "王允",
    ["#sfofl_nw_wangyun"] = "计随鞘出",
    ["information:sfofl_nw_wangyun"] = "E0026《群雄逐鹿》",
    ["sfofl_n_lianji-invoke"] = "你可以发动“连计”，令一名角色摸一张牌<br/> <b>操作提示</b>: 选择一名角色→点击确定<br/>",
    ["sfofl_n_lianji_phase-invoke"] = "你可以发动“连计”，令一名角色于此阶段结束后代替你执行你此回合所有剩余的阶段<br/> <b>操作提示</b>: 选择一名角色→点击确定<br/>",
    ["sfofl_n_lianjiphase"] = "连计",
    ["sfofl_n_lianji"] = "连计",
    [":sfofl_n_lianji"] = "出牌阶段结束时，若你此阶段内使用过牌的类别数：达到1，你可以令一名角色摸一张牌；达到2，你可以回复1点体力；达到3，你可以令一名角色于此阶段结束后代替你执行你此回合所有剩余的阶段。",
    ["sfofl_n_moucheng"] = "谋逞",
    [":sfofl_n_moucheng"] = "出牌阶段限一次，你可以将一张黑色牌当【借刀杀人】使用。",


    --E0026《群雄逐鹿》
    
    ["sfofl_nw_dianwei"] = "典韦[战役]",
    ["&sfofl_nw_dianwei"] = "典韦",
    ["#sfofl_nw_dianwei"] = "古之恶来",
    ["information:sfofl_nw_dianwei"] = "E0035《问鼎中原》",
    ["sfofl_n_poshi"] = "迫视",
    [":sfofl_n_poshi"] = "锁定技，你计算与装备区里牌数大于你的角色互相距离为1，且不能响应对方使用的牌。",
    ["sfofl_n_duanji"] = "断戟",
    [":sfofl_n_duanji"] = "锁定技，你不能使用武器牌；出牌阶段限一次，你可以将一张装备牌当决斗使用。",
    --死战
    --护主

    ["sfofl_nw_shencaocao"] = "曹操[战役]",
    ["&sfofl_nw_shencaocao"] = "曹操",
    ["#sfofl_nw_shencaocao"] = "平定宛城",
    ["information:sfofl_nw_shencaocao"] = "E0035《问鼎中原》",
    --奸雄
    --飞影
    ["@sfofl_n_hujia"] = "护驾:你可以打出一张 %src",
    ["sfofl_n_hujia"] = "护驾",
    [":sfofl_n_hujia"] = "主公技，当你需要使用或打出一张殺或【闪】时，你可以令其他魏势力角色打出一张相应的牌，视为你使用或打出之。",

    ["sfofl_nw_shenlvbu"] = "神吕布[战役]",
    ["&sfofl_nw_shenlvbu"] = "神吕布",
    ["#sfofl_nw_shenlvbu"] = "战神之殇",
    ["information:sfofl_nw_shenlvbu"] = "E0035《问鼎中原》",
    --马术
    --无双
    ["sfofl_n_shenji"] = "神戟",
    [":sfofl_n_shenji"] = "你使用的杀可以多指定一名角色为目标。",
    ["sfofl_n_shenwei"] = "神威",
    [":sfofl_n_shenwei"] = "锁定技，你摸牌阶段改为摸X张牌（X为你的体力值）。",
    --修罗

    ["sfofl_nw_chunyuqiong"] = "淳于琼[战役]",
    ["&sfofl_nw_chunyuqiong"] = "淳于琼",
    ["#sfofl_nw_chunyuqiong"] = "昔袍今臣",
    ["information:sfofl_nw_chunyuqiong"] = "E0035《问鼎中原》",
    --乌巢
    ["sfofl_n_cangchu"] = "仓储",
    [":sfofl_n_cangchu"] = "锁定技，你受到的火焰伤害+1；出牌阶段开始时，你视为使用一张【酒】。",
    ["@sfofl_n_liangying"] = "粮营：将一张牌置于你的武将牌上",
    ["sfofl_n_liangying"] = "粮营",
    [":sfofl_n_liangying"] = "结束阶段，你可以摸三张牌，然后将一张牌置于你的武将牌上，成为“粮”。",

    ["sfofl_nw_zhanghe"] = "张郃[战役]",
    ["&sfofl_nw_zhanghe"] = "张郃",
    ["#sfofl_nw_zhanghe"] = "名门的梁柱",
    ["information:sfofl_nw_zhanghe"] = "E0035《问鼎中原》",
    --乌巢
    ["@sfofl_n_yuanlue"] = "远略：将两张牌置于你的武将牌上",
    ["sfofl_n_yuanlue"] = "远略",
    [":sfofl_n_yuanlue"] = "出牌阶段限一次，你可以失去1点体力并摸三张牌，然后将两张牌置于你的武将牌上，称为“粮”，若你装备区里的牌数为全场最多，你可以回复1点体力。",
    ["sfofl_n_xiying-invoke"] = "你可以发动“袭营”<br/> <b>操作提示</b>: 选择一名角色→点击确定<br/>",
    ["sfofl_n_xiying"] = "袭营",
    [":sfofl_n_xiying"] = "一名角色的结束阶段，你可以弃置一名角色区域里的一张牌。",

    ["sfofl_nw_yuanshao"] = "袁绍[战役]",
    ["&sfofl_nw_yuanshao"] = "袁绍",
    ["#sfofl_nw_yuanshao"] = "高贵的名门",
    ["information:sfofl_nw_yuanshao"] = "E0035《问鼎中原》",
    --乌巢
    ["sfofl_n_wuduan"] = "无断",
    [":sfofl_n_wuduan"] = "准备阶段，你可以进行判定，若结果为：红色，你本回合获得“急攻”；黑色，你本回合获得“渐营”。",
    ["sfofl_n_juezhanAttach"] = "决战",
    [":sfofl_n_juezhanAttach"] = "你可以将两张“粮”当任意一张基本牌或普通锦囊牌使用（每种牌名每回合限一次）。",
    ["sfofl_n_juezhan"] = "决战",
    -- [":sfofl_n_juezhan"] = "锁定技，你可以将武将牌上的“粮”当手牌使用、打出或弃置；你可以将两张“粮”当任意一张基本牌或普通锦囊牌使用（每种牌名每回合限一次）。",
    [":sfofl_n_juezhan"] = "锁定技，你可以将武将牌上的“粮”当手牌使用、打出；你可以将两张“粮”当任意一张基本牌或普通锦囊牌使用（<font color=\"green\"><b>每种牌名每回合限一次</b></font>）。",

    ["sfofl_nw_shenzhouyu"] = "神周瑜[战役]",
    ["&sfofl_nw_shenzhouyu"] = "神周瑜",
    ["#sfofl_nw_shenzhouyu"] = "红莲业火",
    ["information:sfofl_nw_shenzhouyu"] = "E0035《问鼎中原》",
    ["sfofl_n_huoshen"] = "火神",
    [":sfofl_n_huoshen"] = "锁定技，你不会受到火焰伤害。回合结束时，若你本回合造成过火焰伤害，你回复1点体力。",
    ["sfofl_n_zonghuo"] = "纵火",
    [":sfofl_n_zonghuo"] = "你可以将红色牌当【火攻】使用，你使用【火攻】结算完成后，若此牌未造成伤害，你可以弃置其一张牌。",
    ["sfofl_n_fenyin"] = "焚音",
    [":sfofl_n_fenyin"] = "出牌阶段限一次，你可以弃置所有手牌，然后对所有其他角色造成1点火焰伤害。",

    ["sfofl_nw_shenzhugeliang"] = "神诸葛亮[战役]",
    ["&sfofl_nw_shenzhugeliang"] = "神诸葛亮",
    ["#sfofl_nw_shenzhugeliang"] = "灭世鸹风",
    ["information:sfofl_nw_shenzhugeliang"] = "E0035《问鼎中原》",
    ["sfofl_n_fengshen"] = "风神",
    [":sfofl_n_fengshen"] = "锁定技，你不会受到【杀】和【决斗】的伤害。",
    ["sfofl_n_jifeng"] = "祭风",
    [":sfofl_n_jifeng"] = "当一名角色造成火焰伤害时，你可以令其摸一张牌。",
    ["sfofl_n_zhisuan"] = "智算",
    [":sfofl_n_zhisuan"] = "<font color=\"green\"><b>每回合限四次，</b></font>你使用一张黑色牌结算完成后，你可以摸一张牌。",

    ["sfofl_nw_guojia"] = "郭嘉[战役]",
    ["&sfofl_nw_guojia"] = "郭嘉",
    ["#sfofl_nw_guojia"] = "奉孝再生",--??
    ["information:sfofl_nw_guojia"] = "E0035《问鼎中原》",
    --天妒
    --遗计
    ["sfofl_n_tongchou"] = "统筹",
    [":sfofl_n_tongchou"] = "出牌阶段限一次，你可以进行一次判定，若为红色：你回复1点体力；若为黑色：你本回合使用【杀】没有次数限制。然后你可以变更一次副将。",

    --E0035《问鼎中原》

    ["sfofl_nw_shenmachao"] = "神马超[战役]",
    ["&sfofl_nw_shenmachao"] = "神马超",
    ["#sfofl_nw_shenmachao"] = "西凉雄狮",
    ["information:sfofl_nw_shenmachao"] = "E0037《三分天下》",
    ["sfofl_n_weishui_rule"] = "渭水之战",
    [":sfofl_n_weishui_rule"] = "每当你对其他角色造成1点伤害时，你获得一张武将牌作为1点士气。\
        你可以在对应时机使用你的士气武将牌上一个技能，每张武将牌限使用一次。\
        【桃】或【桃园结义】可以当【杀】或【闪】使用或打出。\
        没有手牌上限",

    ["weishuiGenerals"] = "士气",
    ["sfofl_n_weishui_rule0"] = "渭水之战：你可以发动“%src”",
	["~sfofl_n_weishui_rule"] = "若无法发动，可以退至空闲点重新点击",
	["$weishuiremoveOne"] = "%from 选择移去武将牌 %arg",
	["sfofl_n_weishui_ruleRemove"] = "移去武将牌",

    ["sfofl_n_shiqi"] = "士气",
    [":sfofl_n_shiqi"] = "锁定技，当你使用士气上的蜀势力武将技能结算完成后，你摸两张牌。",
    ["sfofl_n_chongsha"] = "冲杀",
    [":sfofl_n_chongsha"] = "当你使用【杀】指定目标时，你可以获得其一张牌，若其使用【闪】抵消此【杀】，其可以弃置你一张牌。",

    ["sfofl_nw_shenxuchu"] = "神许褚[战役]",
    ["&sfofl_nw_shenxuchu"] = "神许褚",
    ["#sfofl_nw_shenxuchu"] = "血战渭水",
    ["information:sfofl_nw_shenxuchu"] = "E0037《三分天下》",
    ["sfofl_n_2_shiqi"] = "士气",
    [":sfofl_n_2_shiqi"] = "锁定技，当你使用士气上的魏势力武将技能结算完成后，你摸两张牌。",
    ["sfofl_n_luozhan"] = "裸战",
    [":sfofl_n_luozhan"] = "出牌阶段限一次，你可以弃置一张装备牌，令一名其他家角色选择一项：1. 弃置一张装备牌；2. 你对其造成1点伤害。",

    ["sfofl_nw_shenzhangliao"] = "神张辽[战役]",
    ["&sfofl_nw_shenzhangliao"] = "神张辽",
    ["#sfofl_nw_shenzhangliao"] = "威震逍遥津",
    ["information:sfofl_nw_shenzhangliao"] = "E0037《三分天下》",
    ["sfofl_n_tuxi-invoke"] = "你可以发动“突袭”<br/> <b>操作提示</b>: 选择一名角色→点击确定<br/>",
    ["sfofl_n_tuxi"] = "突袭",
    [":sfofl_n_tuxi"] = "回合开始时，你可以观看一名其他角色的手牌并弃置其中一张。",
    ["sfofl_n_weizhen"] = "威震",
    [":sfofl_n_weizhen"] = "锁定技，手牌数大于你的角色对你造成的伤害至多为1。",
    ["sfofl_n_zhiti"] = "止啼",
    [":sfofl_n_zhiti"] = "回合结束时，若你的手牌数小于2，你可以观看牌堆顶四张牌，获得其中花色相同的任意张牌。",

    ["sfofl_nw_shenguanyu"] = "神关羽[战役]",
    ["&sfofl_nw_shenguanyu"] = "神关羽",
    ["#sfofl_nw_shenguanyu"] = "军神对决",
    ["information:sfofl_nw_shenguanyu"] = "E0037《三分天下》",
    --武圣
    ["sfofl_n_huwei-invoke"] = "你可以发动“虎威”<br/> <b>操作提示</b>: 选择一名角色→点击确定<br/>",
    ["sfofl_n_huwei"] = "虎威",
    [":sfofl_n_huwei"] = "锁定技，回合开始时，你展示牌堆顶一张牌，若此牌为红色，你获得此牌且本回合使用【杀】的次数+1；若此牌为黑色，你将此牌置于武将牌子上，称为“骤”，若你有三张花色相同的“骤”，你移去所有“骤”令一名其他角色弃置装备区里的所有牌，其减少2点体力上限。",

    ["sfofl_nw_shenyujin"] = "神于禁[战役]",
    ["&sfofl_nw_shenyujin"] = "神于禁",
    ["#sfofl_nw_shenyujin"] = "讨暴坚垒",
    ["information:sfofl_nw_shenyujin"] = "E0037《三分天下》",
    ["@sfofl_n_baijiang"] = "败降：你交给 %src 一张牌",
    ["sfofl_n_baijiang"] = "败降",
    [":sfofl_n_baijiang"] = "其他角色于其出牌阶段内使用牌指定你为目标后，你可以摸一张牌并交给其一张牌，其本回合手牌上限-1，若如此做，本回合弃牌阶段结束时，若其此阶段弃置过至少两张手牌，其失去1点体力。",
    ["@sfofl_n_zhuying"] = "筑营：你可以弃置两张牌令此伤害-1",
    ["sfofl_n_zhuying"] = "筑营",
    [":sfofl_n_zhuying"] = "当你受到伤害时，你可以弃置两张牌令此伤害-1；若你以此法弃置的牌类别相同，你摸一张牌。",

    ["sfofl_nw_shenfazheng"] = "神法正[战役]",
    ["&sfofl_nw_shenfazheng"] = "神法正",
    ["#sfofl_nw_shenfazheng"] = "恩怨如火",
    ["information:sfofl_nw_shenfazheng"] = "E0037《三分天下》",
    ["sfofl_n_youzhan"] = "诱战",
    [":sfofl_n_youzhan"] = "你距离1以内的角色成为【杀】的目标后，你可以弃置此【杀】的使用者一张牌。",
    --眩惑
    --恩怨

    ["sfofl_nw_shenzhanghe"] = "神张郃[战役]",
    ["&sfofl_nw_shenzhanghe"] = "神张郃",
    ["#sfofl_nw_shenzhanghe"] = "陷敌摧坚",
    ["information:sfofl_nw_shenzhanghe"] = "E0037《三分天下》",
    ["@sfofl_n_shiji"] = "识计：你可以将一张【闪】交给一名其他角色",
    ["sfofl_n_shiji"] = "识计",
    [":sfofl_n_shiji"] = "回合结束时，你可以将一张【闪】交给一名其他角色，然后你摸两张牌。",
    --巧变
    
    --E0037《三分天下》

    ["sfofl_nw_shenmenghuo"] = "神孟获[战役]",
    ["&sfofl_nw_shenmenghuo"] = "神孟获",
    ["#sfofl_nw_shenmenghuo"] = "南蛮王",
    ["information:sfofl_nw_shenmenghuo"] = "E0041《分久必合》",
    --祸首
    --再起
    ["sfofl_n_menghuo_rule"] = "特殊规则",
    [":sfofl_n_menghuo_rule"] = "第一阶段神孟获体力上限为2，副将为忙牙长，神孟获阵亡后进入第二阶段；\
    第二阶段神孟获体力上限翻倍并将体力回复至体力上限，将副将替换为朵思大王，将手牌摸至四张并立即进入神孟获的回合，神孟获阵亡后进入第三阶段；\
    第三阶段神孟获体力上限翻倍并将体力回复至体力上限，将副将替换为兀突骨，将手牌摸至四张并立即进入神孟获的回合。",

    ["sfofl_nw_wenyang"] = "文鸯[战役]",
    ["&sfofl_nw_wenyang"] = "文鸯",
    ["#sfofl_nw_wenyang"] = "独骑破军",
    ["information:sfofl_nw_wenyang"] = "E0041《分久必合》",

    ["sfofl_n_zhuifeng"] = "椎锋",
    [":sfofl_n_zhuifeng"] = "魏势力技，你可以失去1点体力，视为使用一张【杀】或【决斗】。",
    ["sfofl_n_chongjian"] = "冲坚",
    [":sfofl_n_chongjian"] = "吴势力技，你可以将一张装备牌当做【酒】或【杀】使用。",
        
    --E0026《群雄逐鹿》E0035《问鼎中原》E0037《三分天下》E0041《分久必合》
    --https://tieba.baidu.com/p/6946117255
    --https://tieba.baidu.com/p/9336440479

}
local exclusive_cards = sgs.Sanguosha:getPackage("exclusive_cards")
sfofl_guanyu = sgs.General(extension_s, "sfofl_guanyu", "shu", 4, true)

sfofl_guanyu:addSkill("wusheng")

--[[
	技能名：忠魂
	相关武将：关羽[官盗]
	技能描述：每当你使用或打出一张红色牌时，你可以亮出牌堆顶的一张牌，若此牌为红色，你获得之。
	引用：sfofl_zhonghun
]] --

sfofl_zhonghun = sgs.CreateTriggerSkill {
    name = "sfofl_zhonghun",
    events = { sgs.CardUsed, sgs.CardResponded },
    frequency = sgs.Skill_Frequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()

        local card = nil
        if event == sgs.CardUsed then
            card = data:toCardUse().card
        else
            card = data:toCardResponse().m_card
        end
        if (not card) or (card:isKindOf("SkillCard")) then return false end
        if not card:isRed() then return false end
        if room:askForSkillInvoke(player, self:objectName()) then
            local id = room:drawCard()
            local move = sgs.CardsMoveStruct()
            move.card_ids:append(id)
            move.reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_TURNOVER, player:objectName(), self:objectName(),
                "")
            move.to_place = sgs.Player_PlaceTable
            room:moveCardsAtomic(move, true)
            room:getThread():delay(800)
            id = sgs.Sanguosha:getCard(id)
            local dummy = dummyCard()
            if id:isRed() then
                room:obtainCard(player, id)
            else
                dummy:addSubcard(id)
            end
            if dummy:subcardsLength() < 1 then return end
            local move = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_NATURAL_ENTER, player:objectName(),
                self:objectName(),
                nil)
            room:throwCard(dummy, move, nil)
        end
    end,
}

sfofl_guanyu:addSkill(sfofl_zhonghun)


sfofl_guanyu:addSkill("nuzhan")


sfofl_longyufei = sgs.General(extension_s, "sfofl_longyufei", "shu", 3, false)


--[[
	技能名：龙裔
	相关武将：龙羽飞[官盗]
	技能描述：你可以将所有手牌当任意一张基本牌使用或打出。若其中有锦囊牌，你摸一张牌；若其中有装备牌，此牌不可被响应。
	引用：sfofl_longyi
]] --

sfofl_longyiCard = sgs.CreateSkillCard {
    name = "sfofl_longyi",
    will_throw = false,
    filter = function(self, targets, to_select, player)
        local plist = sgs.PlayerList()
        for i = 1, #targets do plist:append(targets[i]) end
        local rangefix = 0
        if not self:getSubcards():isEmpty() and sgs.Self:getWeapon() and sgs.Self:getWeapon():getId() == self:getSubcards():first() then
            local card = sgs.Self:getWeapon():getRealCard():toWeapon()
            rangefix = rangefix + card:getRange() - sgs.Self:getAttackRange(false)
        end
        if not self:getSubcards():isEmpty() and sgs.Self:getOffensiveHorse() and sgs.Self:getOffensiveHorse():getId() == self:getSubcards():first() then
            rangefix = rangefix + 1
        end
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
            local card, user_str = nil, self:getUserString()
            if user_str ~= "" then
                local us = user_str:split("+")
                card = sgs.Sanguosha:cloneCard(us[1])
            end
            return card and card:targetFilter(plist, to_select, sgs.Self) and
                not sgs.Self:isProhibited(to_select, card, plist)
                and (card:isKindOf("Slash") and
                    (sgs.Self:canSlash(to_select, true, rangefix)))
        elseif sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE then
            return false
        end
        local card = sgs.Self:getTag("sfofl_longyi"):toCard()
        return card and card:targetFilter(plist, to_select, sgs.Self) and
            not sgs.Self:isProhibited(to_select, card, plist)
            and (card:isKindOf("Slash") and sgs.Self:canSlash(to_select, true, rangefix))
    end,
    feasible = function(self, targets)
        local plist = sgs.PlayerList()
        for i = 1, #targets do plist:append(targets[i]) end
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
            local card, user_str = nil, self:getUserString()
            if user_str ~= "" then
                local us = user_str:split("+")
                card = sgs.Sanguosha:cloneCard(us[1])
            end
            return card and card:targetsFeasible(plist, sgs.Self)
        elseif sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE then
            return true
        end
        local card = sgs.Self:getTag("sfofl_longyi"):toCard()
        return card and card:targetsFeasible(plist, sgs.Self)
    end,
    on_validate = function(self, use)
        local yuji = use.from
        local to_guhuo = self:getUserString()
        --local use_card = dummyCard(to_guhuo)
        if to_guhuo == "slash" then
            to_guhuo = table.concat(sgs.Sanguosha:getSlashNames(), "+")
        end
        local user_str = yuji:getRoom():askForChoice(yuji, "sfofl_longyi_slash", to_guhuo)
        local use_card = sgs.Sanguosha:cloneCard(user_str)
        use_card:setSkillName("sfofl_longyi")
        use_card:addSubcard(self)
        return use_card
    end,
    on_validate_in_response = function(self, yuji)
        local to_guhuo = self:getUserString()
        if to_guhuo == "slash" then
            to_guhuo = table.concat(sgs.Sanguosha:getSlashNames(), "+")
        end
        local user_str = yuji:getRoom():askForChoice(yuji, "sfofl_longyi_slash", to_guhuo)
        local use_card = sgs.Sanguosha:cloneCard(user_str)
        use_card:setSkillName("sfofl_longyi")
        use_card:addSubcard(self)
        return use_card
    end
}
sfofl_longyiVS = sgs.CreateViewAsSkill {
    name = "sfofl_longyi",
    n = 0,
    view_as = function(self, cards)
        local c = sfofl_longyiCard:clone()
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE
            or sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
            local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
            c:setUserString(pattern)
            c:addSubcards(sgs.Self:getHandcards())
            return c
        else
            local card = sgs.Self:getTag("sfofl_longyi"):toCard()
            c:setUserString(card:objectName())
            c:addSubcards(sgs.Self:getHandcards())
            return c
        end
    end,
    enabled_at_response = function(self, player, pattern)
        local skill_invoke = pattern
        if pattern == "peach+analeptic" and player:getMark("Global_PreventPeach") > 0
        then
            pattern = "analeptic"
        end
        pattern = dummyCard(pattern:split("+")[1])
        if pattern and not player:isKongcheng()
        then
            return pattern:isKindOf("BasicCard") or
                ((string.find(skill_invoke, "slash")) and
                    (sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE
                        or sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE))
        end
    end,
    enabled_at_play = function(self, player)
        if not player:isKongcheng() then
            return (player:isWounded() or sgs.Slash_IsAvailable(player) or sgs.Analeptic_IsAvailable(player))
        end
    end,
}

sfofl_longyi = sgs.CreateTriggerSkill {
    name = "sfofl_longyi",
    events = { sgs.CardUsed, sgs.CardResponded },
    view_as_skill = sfofl_longyiVS,
    on_trigger = function(self, event, player, data, room)
        local card
        if event == sgs.CardUsed then
            local use = data:toCardUse()
            card = use.card
        elseif event == sgs.CardResponded then
            card = data:toCardResponse().m_card
        end
        if not card or card:isKindOf("SkillCard") or card:getSkillName() ~= "sfofl_longyi" then return false end
        local to_draw = false
        local to_no_respond = false
        for c, id in sgs.list(card:getSubcards()) do
            c = sgs.Sanguosha:getCard(id)
            if c:isKindOf("TrickCard") then
                to_draw = true
            elseif c:isKindOf("EquipCard") then
                to_no_respond = true
            end
            if to_draw and to_no_respond then
                break
            end
        end
        if to_no_respond and event == sgs.CardUsed then
            local log = sgs.LogMessage()
            log.type = "$longyi_norespond"
            log.from = player
            log.arg = card:objectName()
            room:sendLog(log)
            local use = data:toCardUse()
            local no_respond_list = use.no_respond_list
            table.insert(no_respond_list, "_ALL_TARGETS")
            use.no_respond_list = no_respond_list
            data:setValue(use)
        end
        if to_draw then
            player:drawCards(1, self:objectName())
        end
        return false
    end
}
sfofl_longyufei:addSkill(sfofl_longyi)
sfofl_longyi:setGuhuoDialog("l")

--[[
	技能名：阵绝
	相关武将：龙羽飞[官盗]
	技能描述：当前回合角色的结束阶段，若你没有手牌，你可以令其选择一项：1.弃置一张牌；2.你摸一张牌。
	引用：sfofl_zhenjue
]] --
sfofl_zhenjue = sgs.CreateTriggerSkill {
    name = "sfofl_zhenjue",
    frequency = sgs.Skill_Frequent,
    events = { sgs.EventPhaseStart },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if player:getPhase() ~= sgs.Player_Finish then return false end
        for _, p in sgs.list(room:findPlayersBySkillName(self:objectName())) do
            if p:isKongcheng() and room:askForSkillInvoke(p, self:objectName()) then
                if not room:askForDiscard(player, self:objectName(), 1, 1, true, true, "@sfofl_zhenjue:" .. p:objectName()) then
                    p:drawCards(1, self:objectName())
                end
            end
            if not player:isAlive() then break end
        end
    end,
    can_trigger = function(self, target)
        return (target ~= nil)
    end,
}

sfofl_longyufei:addSkill(sfofl_zhenjue)

sfofl_zhouyu = sgs.General(extension_s, "sfofl_zhouyu", "wu", 3, true)

sfofl_zhouyu:addSkill("nosyingzi")

--[[
	技能名：识音
	相关武将：周瑜[官盗]
	技能描述：当你于回合内获得手牌时，你可以展示这些牌，然后根据花色数令你本回合下一张牌获得对应效果：不少于1，不能被响应；不少于2，造成的伤害+ 1；不少于3，使用时摸一张牌。
	引用：sfofl_shiyin
]] --
sfofl_shiyin = sgs.CreateTriggerSkill {
    name = "sfofl_shiyin",
    frequency = sgs.Skill_Frequent,
    events = { sgs.CardsMoveOneTime, sgs.CardFinished, sgs.TargetSpecified, sgs.DamageCaused, sgs.CardUsed, sgs.PreCardUsed },
    on_trigger = function(self, event, player, data, room)
        if event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            if not room:getTag("FirstRound"):toBool() and player:getPhase() ~= sgs.Player_NotActive and move.to and move.to:objectName() == player:objectName() then
                local ids = sgs.IntList()
                for _, id in sgs.qlist(move.card_ids) do
                    if room:getCardOwner(id) == player and room:getCardPlace(id) == sgs.Player_PlaceHand then
                        ids:append(id)
                    end
                end
                if ids:isEmpty() then return false end
                if room:askForSkillInvoke(player, self:objectName(), data) then
                    room:showCard(player, ids)
                    local show_suit = {}
                    for _, id in sgs.qlist(ids) do
                        local c = sgs.Sanguosha:getCard(id)
                        if c and not table.contains(show_suit, c:getSuitString()) then
                            table.insert(show_suit, c:getSuitString())
                        end
                    end
                    if not player:hasFlag(self:objectName()) then
                        if #show_suit >= 1 then
                            room:setPlayerFlag(player, "sfofl_shiyin_noresponse")
                            if #show_suit >= 2 then
                                room:setPlayerFlag(player, "sfofl_shiyin_damage")
                                if #show_suit >= 3 then
                                    room:setPlayerFlag(player, "sfofl_shiyin_draw")
                                end
                            end
                        end
                    else
                        player:setTag("shiyin", sgs.QVariant(#show_suit))
                    end
                end
            end
        elseif event == sgs.CardFinished then
            local use = data:toCardUse()
            if use.card:isKindOf("SkillCard") then return false end
            if use.card:hasFlag(self:objectName()) then
                room:setPlayerFlag(player, "-" .. self:objectName())
                room:setPlayerFlag(player, "-sfofl_shiyin_noresponse")
                room:setPlayerFlag(player, "-sfofl_shiyin_damage")
                room:setPlayerFlag(player, "-sfofl_shiyin_draw")
                local x = player:getTag("shiyin"):toInt()
                if x >= 1 then
                    room:setPlayerFlag(player, "sfofl_shiyin_noresponse")
                    if x >= 2 then
                        room:setPlayerFlag(player, "sfofl_shiyin_damage")
                        if x >= 3 then
                            room:setPlayerFlag(player, "sfofl_shiyin_draw")
                        end
                    end
                end
                player:setTag("shiyin", sgs.QVariant(0))
            end
        elseif event == sgs.TargetSpecified then
            local use = data:toCardUse()
            if player:hasFlag("sfofl_shiyin_noresponse") then
                local log = sgs.LogMessage()
                log.type = "$NoRespond_All"
                log.from = use.from
                log.arg = self:objectName()
                log.card_str = use.card:toString()
                room:sendLog(log)
                local use = data:toCardUse()
                local no_respond_list = use.no_respond_list
                table.insert(no_respond_list, "_ALL_TARGETS")
                use.no_respond_list = no_respond_list
                data:setValue(use)
            end
        elseif event == sgs.DamageCaused then
            local damage = data:toDamage()
            if damage.card and player:hasFlag("sfofl_shiyin_damage") then
                damage.damage = damage.damage + 1
                data:setValue(damage)
                local log = sgs.LogMessage()
                log.type = "#skill_add_damage"
                log.from = damage.from
                log.to:append(damage.to)
                log.arg  = self:objectName()
                log.arg2 = damage.damage
                room:sendLog(log)
            end
        elseif event == sgs.CardUsed then
            local use = data:toCardUse()
            if use.card:isKindOf("SkillCard") then return false end
            if player:hasFlag("sfofl_shiyin_draw") then
                player:drawCards(1, self:objectName())
            end
        elseif event == sgs.PreCardUsed then
            local use = data:toCardUse()
            if use.card:isKindOf("SkillCard") then return false end
            if player:hasFlag("sfofl_shiyin_noresponse") or player:hasFlag("sfofl_shiyin_damage") or player:hasFlag("sfofl_shiyin_draw") then
                room:setCardFlag(use.card, self:objectName())
                room:setPlayerFlag(player, self:objectName())
            end
        end
        return false
    end
}

sfofl_zhouyu:addSkill(sfofl_shiyin)

sfofl_caozhi = sgs.General(extension_s, "sfofl_caozhi", "wei", 3, true)
--[[
	技能名：流觞
	相关武将：曹植[官盗]
	技能描述：锁定技，摸牌阶段，你摸X+1张牌，然后在每名其他角色武将牌上放置一张手牌。其他角色的准备阶段，其选择一项：获得其武将牌上的流觞牌且本回合不能对你造成伤害；或弃置此牌（X为埸上存活角色数且至少为3）。
	引用：sfofl_liushang
]] --
sfofl_liushang = sgs.CreateTriggerSkill {
    name = "sfofl_liushang",
    frequency = sgs.Skill_Compulsory,
    events = { sgs.DrawNCards, sgs.AfterDrawNCards, sgs.EventPhaseStart, sgs.DamageCaused },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if player:hasSkill(self:objectName()) and (event == sgs.DrawNCards or event == sgs.AfterDrawNCards) then
            local draw = data:toDraw()
            if draw.reason ~= "draw_phase" then return false end
            if event == sgs.DrawNCards then
                local x = math.max(3, room:getAlivePlayers():length())
                draw.num = x + 1
                room:sendCompulsoryTriggerLog(player, "sfofl_liushang", true)
                data:setValue(draw)
            else
                for _, p in sgs.qlist(room:getOtherPlayers(player)) do
                    local card = nil
                    if player:getHandcardNum() > 1 then
                        local dest = sgs.QVariant()
                        dest:setValue(p)
                        card = room:askForCard(player, ".|.|.|hand!", "@sfofl_liushang:" .. p:objectName(), dest, sgs.Card_MethodNone)
                        if not card then
                            card = player:getHandcards():at(math.random(0, player:getHandcardNum() - 1))
                        end
                    elseif not player:isKongcheng() then
                        card = player:getHandcards():first()
                    else
                        break
                    end
                    local splayers = sgs.SPlayerList()
                    splayers:append(p)
                    splayers:append(player)
                    p:addToPile("sfofl_liushang", card:getEffectiveId(), false, splayers)
                    room:showCard(p, card:getEffectiveId())
                end
            end
        elseif event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Start and not player:getPile("sfofl_liushang"):isEmpty() then
            local dummy = sgs.Sanguosha:cloneCard("slash")
            dummy:addSubcards(player:getPile("sfofl_liushang"))
            dummy:deleteLater()
            if room:askForSkillInvoke(player, self:objectName(), data) then
				room:obtainCard(player, dummy)
                room:addPlayerMark(player, self:objectName().."-Clear")
                room:addPlayerMark(player, "&"..self:objectName().."-Clear")
            else
                local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_REMOVE_FROM_PILE, nil, "sfofl_liushang", nil)
                room:throwCard(dummy, reason, nil)
            end
        elseif event == sgs.DamageCaused and player:getMark(self:objectName().."-Clear") > 0 then
            local damage = data:toDamage()
            if damage.to and damage.to:hasSkill(self:objectName()) then
                damage.damage = 0
                damage.prevented = true
                data:setValue(damage)
                return true
            end
        end
    end,
    can_trigger = function(self, target)
        return (target ~= nil)
    end,
}
sfofl_caozhi:addSkill(sfofl_liushang)

--[[
	技能名：七步
	相关武将：曹植[官盗]
	技能描述：限定技，当你进入濒死状态时，你翻开牌堆顶的七张牌，每有一张红桃牌，你回复1点体力，然后获得其中的梅花牌。
	引用：sfofl_qibu
]] --
sfofl_qibu = sgs.CreateTriggerSkill{
    name = "sfofl_qibu",
    events = {sgs.EnterDying},
    frequency = sgs.Skill_Limited,
    limit_mark = "@sfofl_qibu",
    priority = -1,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if room:askForSkillInvoke(player, self:objectName(), data) then
            room:removePlayerMark(player, "@sfofl_qibu", 1)
            local ids = room:getNCards(7, false)
            local move = sgs.CardsMoveStruct()
            move.card_ids = ids
            move.to = player
            move.to_place = sgs.Player_PlaceTable
            move.reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_TURNOVER, player:objectName(), self:objectName(), nil)
            room:moveCardsAtomic(move, true)
            local card_to_throw = {}
            local card_to_gotback = {}
            local n = 0
            for i=0, 6, 1 do
                local id = ids:at(i)
                local card = sgs.Sanguosha:getCard(id)
                local suit = card:getSuit()
                if suit ~= sgs.Card_Club then
                    table.insert(card_to_throw, id)
                    if suit == sgs.Card_Heart then
                        n = n + 1
                    end
                else
                    table.insert(card_to_gotback, id)
                end
            end
            if #card_to_throw > 0 then
                local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                dummy:deleteLater()
                for _, id in ipairs(card_to_throw) do
                    dummy:addSubcard(id)
                end
                local recover = sgs.RecoverStruct()
                recover.card = nil
                recover.who = player
                recover.recover = n
                room:recover(player, recover)
                local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_NATURAL_ENTER, player:objectName(), self:objectName(), nil)
                room:throwCard(dummy, reason, nil)
            end
            if #card_to_gotback > 0 then
                local dummy2 = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                dummy2:deleteLater()
                for _, id in ipairs(card_to_gotback) do
                    dummy2:addSubcard(id)
                end
                room:obtainCard(player, dummy2)
            end
        end
    end,
    can_trigger = function(self, target)
        return target and target:hasSkill(self:objectName()) and target:getMark("@sfofl_qibu") > 0
    end,
}

sfofl_caozhi:addSkill(sfofl_qibu)

sfofl_guojia = sgs.General(extension_s, "sfofl_guojia", "wei", 3, true)
sfofl_guojia:addSkill("tiandu")
--[[
	技能名：奇佐
	相关武将：郭嘉[官盗]
	技能描述：当你攻击范围内的角色受到或造成伤害时，你可以弃置一张牌并判定，若结果与此牌颜色相同，你可以令此伤害+1或-1。
	引用：sfofl_qizuo
]] --

sfofl_qizuo = sgs.CreateTriggerSkill {
    name = "sfofl_qizuo",
    frequency = sgs.Skill_NotFrequent,
    events = { sgs.DamageCaused, sgs.DamageInflicted },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local damage = data:toDamage()
        local target
        if event == sgs.DamageInflicted then
            target = damage.to
        elseif event == sgs.DamageCaused and damage.from then
            target = damage.from
        end
        if target then
            for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                if p:inMyAttackRange(target) then
                    if p:canDiscard(p, "he") then
                        room:setTag("sfofl_qizuo", data)
                        room:setPlayerFlag(target, "sfofl_qizuo_target")
                        local card = room:askForDiscard(p, self:objectName(), 1, 1, true, false,
                        string.format("@sfofl_qizuo:%s", target:objectName()))
                        room:removeTag("sfofl_qizuo")
                        room:setPlayerFlag(target, "-sfofl_qizuo_target")
                        if card then
                            local judge = sgs.JudgeStruct()
                            judge.pattern = ".|"..card:getColorString()
                            judge.reason = self:objectName()
                            judge.who = p
                            judge.time_consuming = true
                            room:judge(judge)
                            if judge:isGood() then
                                local choice = room:askForChoice(p, self:objectName(), "add+minus", data)
                                if choice == "add" then
                                    local log= sgs.LogMessage()
                                    log.type = "#skill_add_damage_byother1"
                                    log.from = p
                                    log.arg = self:objectName()
                                    room:sendLog(log)
                                    damage.damage = damage.damage + 1
                                    local log= sgs.LogMessage()
                                    log.type = "#skill_add_damage_byother2"
                                    log.from = damage.from
                                    log.to:append(damage.to)
                                    log.arg  = damage.damage
                                    room:sendLog(log)

                                else
                                    damage.damage = damage.damage - 1
                                end
                                data:setValue(damage)
                            end
                        end
                    end
                end
            end
            if damage.damage <= 0 then
                damage.prevented = true
                data:setValue(damage)
                return true
            end
        end
        
    end,
    can_trigger = function(self, target)
        return (target ~= nil)
    end,
}
sfofl_guojia:addSkill(sfofl_qizuo)

sfofl_2_guojia = sgs.General(extension_s, "sfofl_2_guojia", "wei", 3, true)
--[[
	技能名：全谋
	相关武将：郭嘉[官盗]
	技能描述：当一名其他角色使用的锦囊牌结算后，若你为此牌指定的目标之一，你可以弃置一张与此牌颜色相同的手牌，然后获得之。
	引用：sfofl_quanmou
]] --

sfofl_quanmou = sgs.CreateTriggerSkill {
    name = "sfofl_quanmou",
    events = { sgs.CardFinished },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local use = data:toCardUse()
        if use.card:isNDTrick() and use.card:getColorString() ~= "no_color" then
            for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                if use.to:contains(p) and p:objectName() ~= use.from:objectName() then
                    if room:askForCard(p, ".|"..use.card:getColorString().."|.|hand", "@sfofl_quanmou", data, sgs.Card_MethodDiscard,
                    p, false, self:objectName()) then
                        room:obtainCard(p, use.card, false)
                        break
                    end
                end
            end
        end
    end,
    can_trigger = function(self, target)
		return target
	end
}

sfofl_2_guojia:addSkill("nosyiji")
sfofl_2_guojia:addSkill(sfofl_quanmou)


sfofl_zhaoyun = sgs.General(extension_s, "sfofl_zhaoyun", "shu", 4, true)
--[[
	技能名：七进
	相关武将：赵云[官盗]
	技能描述：摸牌阶段，你可以改为亮出牌堆顶的七张牌，然后获得其中一种颜色的所有牌。
	引用：sfofl_qijin
]] --
local function getCardList(intlist)
    local ids = sgs.CardList()
    for _, id in sgs.qlist(intlist) do
        ids:append(sgs.Sanguosha:getCard(id))
    end
    return ids
end
sfofl_qijin = sgs.CreateTriggerSkill{
    name = "sfofl_qijin",
    events = {sgs.EventPhaseStart},
    on_trigger = function(self, event, player, data)
        if player:getPhase() ~= sgs.Player_Draw then
            return false
        end
        local room = player:getRoom()
        if not player:askForSkillInvoke(self:objectName()) then
            return false
        end
        local card_ids = room:getNCards(7)
        room:fillAG(card_ids)
        local to_get = sgs.IntList()
        local to_throw = sgs.IntList()
        local card_id = room:askForAG(player, card_ids, false, "sfofl_qijin")
        card_ids:removeOne(card_id)
        to_get:append(card_id)
        local card = sgs.Sanguosha:getCard(card_id)
        for _,id in sgs.qlist(card_ids) do
            local c = sgs.Sanguosha:getCard(id)
            if c:sameColorWith(card) then
                to_get:append(id)
            else
                to_throw:append(id)
            end
        end
        local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
        if not to_get:isEmpty() then
            dummy:addSubcards(getCardList(to_get))
            player:obtainCard(dummy)
        end
        dummy:clearSubcards()
        if not to_throw:isEmpty() then
            dummy:addSubcards(getCardList(to_throw))
            local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_NATURAL_ENTER, player:objectName(), self:objectName(),"")
            room:throwCard(dummy, reason, nil)
        end
        dummy:deleteLater()
        room:clearAG()
        return true
    end
}
sfofl_zhaoyun:addSkill(sfofl_qijin)

--[[
	技能名：七出
	相关武将：赵云[官盗]
	技能描述：每名其他角色的回合限一次，当你需要使用或打出一张基本牌时，你可以观看牌堆顶的两张牌，然后可以使用或打出其中一张相应的基本牌。
	引用：sfofl_qichu
]] --
function view(room, player, ids, enabled, disabled)
    local result = -1;
    room:notifySkillInvoked(player, "sfofl_qichu")
    local log = sgs.LogMessage()
    log.type = "$ViewDrawPile"
    log.from = player
    log.card_str = table.concat(sgs.QList2Table(ids), "+")
    room:sendLog(log, player)

        
    if enabled:isEmpty() then
        
    else
        room:fillAG(ids, player, disabled)
        local id = room:askForAG(player, enabled, true, "sfofl_qichu");
        if id ~= -1 then
            ids:removeOne(id)
            result = id
        end
        room:clearAG(player)
    end
    room:returnToTopDrawPile(ids)--用这个函数将牌放回牌堆顶
    if result == -1 then
        room:setPlayerFlag(player, "Global_sfofl_qichuFailed")
    else
        room:addPlayerMark(player, "&sfofl_qichu-Clear")
    end
    return result
end
sfofl_qichuVS = sgs.CreateZeroCardViewAsSkill{
    name = "sfofl_qichu",
    enabled_at_play = function()
        return false
    end ,
    enabled_at_response = function(self, player, pattern)
        if player:getPhase() ~= sgs.Player_NotActive or player:hasFlag("Global_sfofl_qichuFailed") then return end
        if player:getMark("&sfofl_qichu-Clear") > 0 then return end
        if pattern == "slash" then
            return (sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE) or  (sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE)
        elseif pattern == "peach" then
            return not player:hasFlag("Global_PreventPeach")
        elseif string.find(pattern, "analeptic") then
            return true
        end
        return false
    end,
    view_as = function(self)
        local acard = sfofl_qichuCard:clone()
        local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
        if pattern == "peach+analeptic" and sgs.Self:hasFlag("Global_PreventPeach") then
            pattern = "analeptic"
        end
        acard:setUserString(pattern)
        return acard
    end
}
sfofl_qichu = sgs.CreateTriggerSkill{
    name = "sfofl_qichu",
    view_as_skill = sfofl_qichuVS,
    events = {sgs.CardAsked},
    on_trigger = function(self,event,player,data)
        if player:getPhase() ~= sgs.Player_NotActive then return end
        if player:getMark("&sfofl_qichu-Clear") > 0 then return end
        local room = player:getRoom()
        local pattern = data:toStringList()[1]
        if pattern == "slash" or pattern == "jink"
            and room:askForSkillInvoke(player, self:objectName(), data) then
            local ids = room:getNCards(2, false)
            local enabled, disabled = sgs.IntList(), sgs.IntList()
            for _,id in sgs.qlist(ids) do
                if string.find(sgs.Sanguosha:getCard(id):objectName(), pattern) then
                    enabled:append(id)
                else
                    disabled:append(id)
                end
            end
            local id = view(room, player, ids, enabled, disabled)
            if id ~= -1 then
                local card = sgs.Sanguosha:getCard(id)
                room:provide(card)
                return true
            end
        end
    end,
}
sfofl_qichuCard = sgs.CreateSkillCard{
    name = "sfofl_qichuCard",
    will_throw = false ,
    filter = function(self, targets, to_select)
        local name = ""
        local card
        local plist = sgs.PlayerList()
        for i = 1, #targets do plist:append(targets[i]) end
        local aocaistring = self:getUserString()
        if aocaistring ~= "" then
            local uses = aocaistring:split("+")
            name = uses[1]
            card = sgs.Sanguosha:cloneCard(name)
        end
        return card and card:targetFilter(plist, to_select, sgs.Self) and not sgs.Self:isProhibited(to_select, card, plist)
    end ,
    feasible = function(self, targets)
        local name = ""
        local card
        local plist = sgs.PlayerList()
        for i = 1, #targets do plist:append(targets[i]) end
        local aocaistring = self:getUserString()
        if aocaistring ~= "" then
            local uses = aocaistring:split("+")
            name = uses[1]
            card = sgs.Sanguosha:cloneCard(name)
        end
        return card and card:targetsFeasible(plist, sgs.Self)
    end,
    on_validate_in_response = function(self, user)
        local room = user:getRoom()
        local ids = room:getNCards(2, false)
        local aocaistring = self:getUserString()
        local names = aocaistring:split("+")
        if table.contains(names, "slash") then
            table.insert(names,"fire_slash")
            table.insert(names,"thunder_slash")
        end
        local enabled, disabled = sgs.IntList(), sgs.IntList()
        for _,id in sgs.qlist(ids) do
            if table.contains(names, sgs.Sanguosha:getCard(id):objectName()) then
                enabled:append(id)
            else
                disabled:append(id)
            end
        end
        local id = view(room, user, ids, enabled, disabled)
        return sgs.Sanguosha:getCard(id)
    end,
    on_validate = function(self, cardUse)
        cardUse.m_isOwnerUse = false
        local user = cardUse.from
        local room = user:getRoom()
        local ids = room:getNCards(2, false)
        local aocaistring = self:getUserString()
        local names = aocaistring:split("+")
        if table.contains(names, "slash") then
            table.insert(names, "fire_slash")
            table.insert(names, "thunder_slash")
        end
        local enabled, disabled = sgs.IntList(), sgs.IntList()
        for _,id in sgs.qlist(ids) do
            if table.contains(names, sgs.Sanguosha:getCard(id):objectName()) then
                enabled:append(id)
            else
                disabled:append(id)
            end
        end
        local id = view(room, user, ids, enabled, disabled)
        return sgs.Sanguosha:getCard(id)
    end
}
sfofl_zhaoyun:addSkill(sfofl_qichu)

--[[
	技能名：龙心
	相关武将：赵云[官盗]
	技能描述：判定阶段开始时，你可以弃置一张装备牌，然后弃置你的判定区里的一张牌。
	引用：sfofl_longxin
]] --

sfofl_longxinCard = sgs.CreateSkillCard{
    name = "sfofl_longxinCard",
    target_fixed = true,
    mute = true,
    on_use = function(self, room, source, targets)
    end
}

sfofl_longxinVS = sgs.CreateViewAsSkill{
    name = "sfofl_longxin",
    n = 2,
    response_pattern = "@@sfofl_longxin",
    expand_pile = "#sfofl_longxin",
    view_filter = function(self, selected, to_select)
        if #selected > 0 then
			if sgs.Self:getPile("#sfofl_longxin"):contains(selected[1]:getId()) then
				return to_select:isKindOf("EquipCard")
			else
				return sgs.Self:getPile("#sfofl_longxin"):contains(to_select)
			end
		else
			return to_select:isKindOf("EquipCard") or sgs.Self:getPile("#sfofl_longxin"):contains(to_select:getEffectiveId())
		end
    end,
    view_as = function(self, cards)
        if #cards == 0 then return nil end
        if #cards == 2 then
            local dis_card = sfofl_longxinCard:clone()
            for _,card in pairs(cards) do
                dis_card:addSubcard(card)
            end
            dis_card:setSkillName("sfofl_longxin")
            return dis_card
        end
    end,
    enabled_at_play = function(self, player)
        return false
    end,
}

sfofl_longxin = sgs.CreateTriggerSkill{
    name = "sfofl_longxin",
    events = {sgs.EventPhaseStart},
    view_as_skill = sfofl_longxinVS,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if (event == sgs.EventPhaseStart) then
            if player:getPhase() == sgs.Player_Judge then
                if player:canDiscard(player, "he") and player:getJudgingArea():length() > 0 then
                    local ids = player:getJudgingAreaID()
                    room:notifyMoveToPile(player, ids, self:objectName(), sgs.Player_PlaceDelayedTrick, true)
                    local card = room:askForUseCard(player, "@@sfofl_longxin", "sfofl_longxin-ask")
                    room:notifyMoveToPile(player, ids, self:objectName(), sgs.Player_PlaceDelayedTrick, false)
                    if not card then return end
                    local dummy = dummyCard()
                    for _,id in sgs.list(card:getSubcards())do
                        if player:getCards("he"):contains(id) then
                           dummy:addSubcard(id)
                        else
                            card:addSubcard(id)
                        end
                    end
                    local log = sgs.LogMessage()
                    log.type = "$DiscardCardWithSkill"
                    log.from = player
                    log.arg = self:objectName()
                    log.card_str = table.concat(sgs.QList2Table(dummy:getSubcards()), "+")
                    room:sendLog(log)
                    room:notifySkillInvoked(player, self:objectName())
                    local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_THROW, player:objectName(), "", self:objectName(), "")
                    room:moveCardTo(dummy, player, nil, sgs.Player_DiscardPile, reason, true)
                    if player:isAlive() and room:getCardPlace(card:getEffectiveId()) == sgs.Player_PlaceDelayedTrick then
                        room:throwCard(card, nil, player)
                    end
                end
            end
        end
        return false
    end
}
sfofl_zhaoyun:addSkill(sfofl_longxin)

sfofl_lubu = sgs.General(extension_s, "sfofl_lubu", "qun", 4, true)
--[[
	技能名：射戟
	相关武将：吕布[官盗]
	技能描述：出牌阶段限一次，你可以将所有手牌当一张无距离限制的【杀】使用，此【杀】对目标角色造成伤害后，若其装备区里有武器牌或坐骑牌，你获得之。
	引用：sfofl_sheji
]] --
sfofl_shejiVS = sgs.CreateViewAsSkill {
    name = "sfofl_sheji",
    n = 0,
    view_as = function(self, cards)
        local card = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, 0)
        card:addSubcards(sgs.Self:getHandcards())
        card:setSkillName(self:objectName())
        return card
    end,
    enabled_at_play = function(self, player)
        return player:getMark("sfofl_sheji-PlayClear") == 0
    end,
}
sfofl_sheji = sgs.CreateTriggerSkill {
    name = "sfofl_sheji",
    frequency = sgs.Skill_NotFrequent,
    events = { sgs.PreCardUsed, sgs.Damage },
    view_as_skill = sfofl_shejiVS,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.PreCardUsed then
            if player:getPhase() == sgs.Player_Play then
                local use = data:toCardUse()
                if use.card and use.card:isKindOf("Slash") then
                    if use.card:getSkillName() == self:objectName() then
                    room:addPlayerMark(player, "sfofl_sheji-PlayClear")
                    end
                end
            end
        elseif event == sgs.Damage then
            local damage = data:toDamage()
            if damage.chain or damage.transfer then return false end
            if damage.card and damage.card:isKindOf("Slash") and table.contains(damage.card:getSkillNames(), "sfofl_sheji") then
                if damage.to:getWeapon() or damage.to:getOffensiveHorse() or damage.to:getDefensiveHorse() then
                    if room:askForSkillInvoke(player, self:objectName(), data) then
                        if damage.to:getWeapon() then
                            room:obtainCard(player, damage.to:getWeapon())
                        end
                        if damage.to:getOffensiveHorse() then
                            room:obtainCard(player, damage.to:getOffensiveHorse())
                        end
                        if damage.to:getDefensiveHorse() then
                            room:obtainCard(player, damage.to:getDefensiveHorse())
                        end
                    end
                end
            end
        end
    end,
}
sfofl_sheji_Target = sgs.CreateTargetModSkill {
    name = "#sfofl_sheji_Target",
    distance_limit_func = function(self, player, card)
        if table.contains(card:getSkillNames(), "sfofl_sheji") then
            return 1000
        else
            return 0
        end
    end,
}

sfofl_lubu:addSkill("wushuang")
sfofl_lubu:addSkill(sfofl_sheji)
sfofl_lubu:addSkill(sfofl_sheji_Target)
extension_s:insertRelatedSkills("sfofl_sheji", "#sfofl_sheji_Target")

sfofl_dongzhuo = sgs.General(extension_s, "sfofl_dongzhuo", "qun", 4, true)
--[[
	技能名：横征
	相关武将：董卓[官盗]
	技能描述：回合开始时，若你没有手牌或体力值为1，你可以获得每名角色区域里的一张牌。
	引用：sfofl_hengzheng
]] --
sfofl_hengzheng = sgs.CreateTriggerSkill{
    name = "sfofl_hengzheng" ,
    frequency = sgs.Skill_Frequent,
    events = { sgs.EventPhaseStart },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if player:getPhase() ~= sgs.Player_Start then return false end
        if player:getHp() == 1 or player:isKongcheng() then
            if player:askForSkillInvoke(self:objectName(), data) then
                local players = room:getOtherPlayers(player)
                for _, p in sgs.qlist(players) do
                    if p:isAlive() and (not p:isAllNude()) then
                        local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_EXTRACTION, player:objectName())
                        local card_id = room:askForCardChosen(player, p, "hej", self:objectName())
                        room:obtainCard(player, sgs.Sanguosha:getCard(card_id), reason, room:getCardPlace(card_id) ~= sgs.Player_PlaceHand)
                    end
                end            
            end
        end
    end
}
sfofl_dongzhuo:addSkill(sfofl_hengzheng)

sfofl_jiaxu = sgs.General(extension_s, "sfofl_jiaxu", "qun", 3, true)
--[[
	技能名：遗策
	相关武将：贾诩[官盗]
	技能描述：锁定技，当你使用/打出/弃置的牌进入弃牌堆后，你将这些牌以任意顺序置于你的武将牌上，称为“策”。若这些“策”中有点数相同的牌，则你获得这两张牌中的所有牌，将这两张牌置于牌堆两端。若场上没有处于濒死状态的角色，则你对一名角色造成1点伤害。
	引用：sfofl_yice
]] --

sfofl_yice = sgs.CreateTriggerSkill {
	name = "sfofl_yice",
	frequency = sgs.Skill_Frequent,
	events = { sgs.CardsMoveOneTime },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            local source = move.from
            if source and source:objectName() == player:objectName() then
                    if move.to_place == sgs.Player_DiscardPile then
                        local reason = move.reason.m_reason
                        if (bit32.band(reason, sgs.CardMoveReason_S_MASK_BASIC_REASON) == sgs.CardMoveReason_S_REASON_DISCARD and (move.from_places:contains(sgs.Player_PlaceHand) or move.from_places:contains(sgs.Player_PlaceEquip) )) or bit32.band(reason, sgs.CardMoveReason_S_MASK_BASIC_REASON) == sgs.CardMoveReason_S_REASON_USE or bit32.band(reason, sgs.CardMoveReason_S_MASK_BASIC_REASON) == sgs.CardMoveReason_S_REASON_RESPONSE then
                            if room:askForSkillInvoke(player, self:objectName(), data) then
                                local poi = move.card_ids
                                while not poi:isEmpty() do
                                    room:clearAG()
                                    room:fillAG(poi)
                                    local id = room:askForAG(player, poi, false, "sfofl_yice")
                                    if id ~= -1 then
                                        poi:removeOne(id)
                                        local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                                        dummy:deleteLater()
                                        local to_obtain = false
                                        for _, c in sgs.qlist(player:getPile("sfofl_yice")) do
                                            if to_obtain then
                                                dummy:addSubcard(c)
                                            end
                                            if sgs.Sanguosha:getCard(c):getNumber() ==sgs.Sanguosha:getCard(id):getNumber() then
                                                to_obtain = true
                                            end
                                        end
                                        if dummy:subcardsLength() > 0 then
                                            room:obtainCard(player, dummy)
                                        end
                                        if not to_obtain then
                                            player:addToPile("sfofl_yice", id)
                                        else
                                            room:clearAG()
                                            local cardids = sgs.IntList()
                                            cardids:append(id)
                                            for _, c in sgs.qlist(player:getPile("sfofl_yice")) do
                                                if sgs.Sanguosha:getCard(c):getNumber() ==sgs.Sanguosha:getCard(id):getNumber() then
                                                    local ids = sgs.IntList()
                                                    ids:append(c)
                                                    local move = sgs.CardsMoveStruct()
                                                    move.card_ids = ids
                                                    move.to = player
                                                    move.to_place = sgs.Player_PlaceTable
                                                    move.reason =  sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_REMOVE_FROM_PILE, "", nil, self:objectName(), "")
                                                    room:moveCardsAtomic(move, true)
                                                    cardids:append(c)
                                                end
                                            end
                                            local choicelist = {"sfofl_yice_up", "sfofl_yice_down"}
                                            room:fillAG(cardids)
                                            local new_card = room:askForAG(player, cardids, false, "sfofl_yice_guanxing")
                                            if new_card ~= -1 then
                                                cardids:removeOne(new_card)
                                                local choice = room:askForChoice(player, self:objectName(), table.concat(choicelist, "+"))
                                                if choice == "sfofl_yice_up" then
                                                    local top = sgs.IntList()
                                                    top:append(new_card)
                                                    local log = sgs.LogMessage()
                                                    log.type = "$PutCard"
                                                    log.from = player
                                                    log.card_str = table.concat(sgs.QList2Table(top), "+")
                                                    room:sendLog(log)
                                                    room:returnToTopDrawPile(top)
                                                    local down = sgs.IntList()
                                                    down:append(cardids:first())
                                                    room:returnToEndDrawPile(down)
                                                    local log = sgs.LogMessage()
                                                    log.type = "$PutCardEnd2"
                                                    log.from = player
                                                    log.card_str = table.concat(sgs.QList2Table(down), "+")
                                                    room:sendLog(log)
                                                else
                                                    local down = sgs.IntList()
                                                    down:append(new_card)
                                                    room:returnToEndDrawPile(down)
                                                    local log = sgs.LogMessage()
                                                    log.type = "$PutCardEnd2"
                                                    log.from = player
                                                    log.card_str = table.concat(sgs.QList2Table(down), "+")
                                                    room:sendLog(log)
                                                    local top = sgs.IntList()
                                                    top:append(cardids:first())
                                                    room:returnToTopDrawPile(top)
                                                    local log = sgs.LogMessage()
                                                    log.type = "$PutCard"
                                                    log.from = player
                                                    log.card_str = table.concat(sgs.QList2Table(top), "+")
                                                    room:sendLog(log)
                                                end
                                            end
                                            room:clearAG()
                                            if not room:getCurrentDyingPlayer() then
                                                local dest = room:askForPlayerChosen(player, room:getAlivePlayers(), "sfofl_yice_damage")
                                                local damage = sgs.DamageStruct()
                                                damage.from = player
                                                damage.to = dest
                                                room:damage(damage)
                                            end
                                        end
                                    end
                                    room:clearAG()
                                end
                            end
                        end
                    end
            end
        end
    end,
}

sfofl_jiaxu:addSkill(sfofl_yice)
sfofl_jiaxu:addSkill("luanwu")

sfofl_jin_simayi = sgs.General(extension_s, "sfofl_jin_simayi", "jin", 3, true)
--[[
	技能名：权弈
	相关武将：司马懿[官盗]
	技能描述：出牌阶段限一次，你可以与一名角色拼点（你可以用牌堆顶的牌拼点），根据对方拼点牌的花色，赢的角色依次执行以下效果：红桃，其获得没赢的角色区域里的一张牌；方块，其对没赢的角色造成1点伤害；黑桃，其失去1点体力；梅花，其弃置两张牌。
	引用：sfofl_quanyi
]] --
sfofl_quanyiCard = sgs.CreateSkillCard {
    name = "sfofl_quanyi",
    target_fixed = false,
    will_throw = false,
    filter = function(self, targets, to_select, player)
        return #targets == 0 and to_select:objectName() ~= player:objectName() and player:canPindian(to_select)
    end,
    on_use = function(self, room, source, targets)
        local target = targets[1]
        local pindian = source:PinDian(target, self:objectName())
        if pindian.from_number == pindian.to_number then return end
        local winner = source
        local loser = target
        if not pindian.success then
            winner = target
            loser = source
        end
        local cards = sgs.CardList()
        cards:append(pindian.from_card)
        cards:append(pindian.to_card)
        for _, card in sgs.qlist(cards) do
            if card:getSuit() == sgs.Card_Heart and winner and winner:isAlive() and loser and loser:isAlive() and not loser:isAllNude() then
                local cardn = room:askForCardChosen(winner, loser, "hej", self:objectName())
                room:obtainCard(winner, cardn, false)
            end
            if card:getSuit() == sgs.Card_Diamond and winner and winner:isAlive() and loser and loser:isAlive() then
                local damage = sgs.DamageStruct()
                damage.from = winner
                damage.to = loser
                damage.damage = 1
                room:damage(damage)
            end
            if card:getSuit() == sgs.Card_Spade and winner and winner:isAlive() then
                room:loseHp(winner, 1, true, source, self:objectName())
            end
            if card:getSuit() == sgs.Card_Club and winner and winner:isAlive() and winner:canDiscard(winner, "he") then
                room:askForDiscard(winner, self:objectName(), 2, 2, false, true)
            end
        end
    end,
}
sfofl_quanyiVS = sgs.CreateZeroCardViewAsSkill{
    name = "sfofl_quanyi",
    view_as = function()
        return sfofl_quanyiCard:clone()
    end,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_quanyi")
	end
}
sfofl_quanyi = sgs.CreateTriggerSkill{
	name = "sfofl_quanyi",
	events = {sgs.AskforPindianCard},
    view_as_skill = sfofl_quanyiVS,
	on_trigger = function(self, event, player, data, room)
		if event == sgs.AskforPindianCard then
            local pindian = data:toPindian()
            if pindian.reason == "sfofl_quanyi" then
                for _, p in sgs.qlist(room:findPlayersBySkillName("sfofl_quanyi")) do
                    if pindian.from:objectName() == p:objectName() then
                        if room:askForSkillInvoke(player, self:objectName(), data) then
                            pindian.from_card = sgs.Sanguosha:getCard(room:drawCard())
                            data:setValue(pindian)
                        end
                    end
                    if pindian.to:objectName() == p:objectName() then
                        if room:askForSkillInvoke(p, self:objectName(), data) then
                            pindian.to_card = sgs.Sanguosha:getCard(room:drawCard())
                            data:setValue(pindian)
                        end
                    end
                end
			end	
		end
	end,
	can_trigger = function(self, target)
		return target and target:isAlive()
	end
}

sfofl_jin_simayi:addSkill("jinyingshi")
sfofl_jin_simayi:addSkill(sfofl_quanyi)
--[[
	技能名：玉玺
	技能描述：锁定技，当你受到伤害后，你可以声明一种花色，然后命令伤害来源显示所有手牌并弃置其中与该花色相同的所有牌。
	引用：sfofl_jadeseal
]] --
sfofl_jadesealTr = sgs.CreateTriggerSkill {
	name = "sfofl_jadeseal",
	frequency = sgs.Skill_Compulsory,
	events = { sgs.Damaged },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()
		local source = damage.from
		if source then
            room:broadcastSkillInvoke(self:objectName())
            room:addPlayerMark(source, self:objectName())
            local suit = room:askForSuit(player, self:objectName())
            room:setPlayerMark(source, self:objectName(), 0)
            local msg = sgs.LogMessage()
            msg.type = "#ChooseSuit"
            msg.from = player
            if suit == sgs.Card_Club then
                msg.arg = "club"
            elseif suit == sgs.Card_Spade then
                msg.arg = "spade"
            elseif suit == sgs.Card_Diamond then
                msg.arg = "diamond"
            elseif suit == sgs.Card_Heart then
                msg.arg = "heart"
            end
            room:sendLog(msg)
            room:getThread():delay()
            if not source:isKongcheng() then
                room:showAllCards(source)
            end
            local hand = source:getHandcards()
            local guess = sgs.CardList()
            for _, card in sgs.qlist(hand) do
                if card:getSuit() == suit then
                    guess:append(card)
                end
            end
            if not guess:isEmpty() then
                local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                dummy:deleteLater()
                for _, card in sgs.qlist(guess) do
                    if not source:isJilei(card) then
                        dummy:addSubcard(card)
                    end
                end
                room:throwCard(dummy, source)
            end
		end
	end,
    can_trigger = function(self,target)
		return target and target:hasTreasure("sfofl_jadeseal")
	end,
}
sfofl_jadeseal = sgs.CreateTreasure{
	name = "sfofl_jadeseal",
	class_name = "Jadeseal",
	equip_skill = sfofl_jadesealTr,
    suit = sgs.Card_Heart,
    number = 6,
	on_install = function(self,player)
		local room = player:getRoom()
		room:attachSkillToPlayer(player,"sfofl_jadeseal")
	end,
	on_uninstall = function(self,player)
		player:getRoom():detachSkillFromPlayer(player,"sfofl_jadeseal",true,true)
	end,
}

sfofl_jadeseal:setParent(extension_card)


sfofl_2_jiaxu = sgs.General(extension_s, "sfofl_2_jiaxu", "qun", 3, true)

--[[
	技能名：驱魄
	相关武将：贾诩[官盗]
	技能描述：一名角色的回合开始时，你可以将一张牌交给另一名其他角色，若此牌为：黑色，当前回合角色使用【杀】指定该角色以外的目标时，当前回合角色失去1点体力；红色，该角色本回合第一次受到伤害时，其失去1点体力。
	引用：sfofl_qupo
]] --
sfofl_qupoCard = sgs.CreateSkillCard {
    name = "sfofl_qupo",
    target_fixed = false,
    will_throw = false,
    filter = function(self, targets, to_select)
		if (#targets ~= 0) then return false end
		return (to_select:objectName() ~= sgs.Self:objectName()) and not to_select:hasFlag("sfofl_qupo")
	end,
	on_use = function(self, room, player, targets)
		local target = targets[1]
        local current = room:getCurrent()
		current:obtainCard(self)
        room:addPlayerMark(current, "&sfofl_qupo-Clear")
        room:addPlayerMark(target, "&sfofl_qupo+to+#"..player:objectName().."-Clear")
        if sgs.Sanguosha:getCard(self:getSubcards():first()):isRed() then
            room:addPlayerMark(player, "sfofl_qupoBlack-Clear")
        else
            room:addPlayerMark(player, "sfofl_qupoRed-Clear")
        end
	end
}
sfofl_qupoVS = sgs.CreateViewAsSkill {
    name = "sfofl_qupo",
    n = 1,
    view_filter = function(self, selected, to_select)
        return true
    end,
    view_as = function(self, cards)
        if #cards == 1 then
            local card = sfofl_qupoCard:clone()
            card:addSubcard(cards[1])
            return card
        end
    end,
    enabled_at_play = function(self, player)
        return false
    end,
    enabled_at_response = function(self, player, pattern)
        return pattern == "@@sfofl_qupo"
    end
}
sfofl_qupo = sgs.CreateTriggerSkill {
    name = "sfofl_qupo",
    view_as_skill = sfofl_qupoVS,
    events = { sgs.EventPhaseStart, sgs.TargetConfirming, sgs.DamageInflicted },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.EventPhaseStart then
            if player and player:getPhase() == sgs.Player_Start then
                for _, p in sgs.qlist(room:findPlayersBySkillName("sfofl_qupo")) do
                    if not p:isKongcheng() and p:objectName() ~= player:objectName() then
                        room:setPlayerFlag(player, "sfofl_qupo")
                        room:askForUseCard(p, "@@sfofl_qupo", "@sfofl_qupo")
                        room:setPlayerFlag(player, "-sfofl_qupo")
                    end
                end
            end
        elseif event == sgs.TargetConfirming then
            local use = data:toCardUse()
            if use.from and use.from:getMark("&sfofl_qupo-Clear") > 0 and use.card and use.card:isKindOf("Slash") and room:getCurrent() and room:getCurrent():isAlive() then
                for _, p in sgs.qlist(room:getAlivePlayers()) do
                    for _, q in sgs.qlist(room:findPlayersBySkillName("sfofl_qupo")) do
                        if p:getMark("&sfofl_qupo+to+#"..q:objectName().."-Clear") > 0 and q:getMark("sfofl_qupoRed-Clear") == 1 then
                            if not use.to:contains(p) then
                                room:sendCompulsoryTriggerLog(q, self:objectName(), true)
                                room:loseHp(room:getCurrent(), 1, true, q, self:objectName())
                            end
                        end
                    end
                end
            end
        elseif event == sgs.DamageInflicted then
            local damage = data:toDamage()
            if damage.to and damage.to:getMark("sfofl_qupo-Clear") == 0 then
                room:addPlayerMark(damage.to, "sfofl_qupo-Clear")
                for _, p in sgs.qlist(room:findPlayersBySkillName("sfofl_qupo")) do
                    if damage.to:getMark("&sfofl_qupo+to+#"..p:objectName().."-Clear") > 0 and p:getMark("sfofl_qupoBlack-Clear") == 1  then
                        for _, q in sgs.qlist(room:getAlivePlayers()) do
                            if q:getMark("&sfofl_qupo-Clear") > 0  then
                                room:sendCompulsoryTriggerLog(p, self:objectName(), true)
                                room:loseHp(q, 1, true, p, self:objectName())
                            end
                        end
                    end
                end
            end
        end
        
    end,
    can_trigger = function(self, target)
        return target and target:isAlive()
    end
}


--[[
	技能名：保全
	相关武将：贾诩[官盗]
	技能描述：当你受到伤害时，你可以弃置一张锦囊牌并防止此伤害。
	引用：sfofl_baoquan
]] --
sfofl_baoquan = sgs.CreateTriggerSkill {
	name = "sfofl_baoquan",
	events = { sgs.DamageInflicted },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()
		if not player:isKongcheng() then
            local card = room:askForCard(damage.to, "TrickCard", "@sfofl_baoquan", data, sgs.Card_MethodDiscard)
            if card then
                room:sendCompulsoryTriggerLog(player, self:objectName(),true)
                damage.damage = 0
                damage.prevented = true
                data:setValue(damage)
                return true
            end
		end
		return false
	end
}
sfofl_2_jiaxu:addSkill("wansha")
sfofl_2_jiaxu:addSkill(sfofl_qupo)
sfofl_2_jiaxu:addSkill(sfofl_baoquan)

--[[
	技能名：拂尘
	技能描述：出牌阶段限一次，你可以将一张手牌放置在拂尘上。当牌数为2或以上时，你可以将拂尘上的牌使用或打出：若牌数为2，该牌视为【闪】；若牌数为3，该牌视为【无懈可击】；若牌数为4或以上，该牌视为【闪】或【无懈可击】。
	引用：sfofl_horsetailwhisk
]] --

sfofl_horsetailwhiskCard = sgs.CreateSkillCard {
	name = "sfofl_horsetailwhisk",
	will_throw = false,
	target_fixed = true,
	handling_method = sgs.Card_MethodNone,
	on_use = function(self, room, source, targets)
		source:addToPile("sfofl_horsetailwhisk", self)
	end
}

sfofl_horsetailwhiskVS = sgs.CreateOneCardViewAsSkill{
    name = "sfofl_horsetailwhisk",
    expand_pile = "sfofl_horsetailwhisk",
    view_filter = function(self, card)
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
            return not card:isEquipped() and not sgs.Self:getPile("sfofl_horsetailwhisk"):contains(card:getEffectiveId())
        end
        return sgs.Sanguosha:matchExpPattern(".|.|.|sfofl_horsetailwhisk", sgs.Self, card)
    end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_horsetailwhisk")
    end,
    enabled_at_response = function(self, player, pattern)
        return (((pattern == "jink" and (player:getPile("sfofl_horsetailwhisk"):length() ~= 3)) or (pattern == "nullification" and player:getPile("sfofl_horsetailwhisk"):length() >= 3)) and (player:hasArmorEffect("sfofl_horsetailwhisk")) and #(player:getTag("Qinggang"):toStringList()) == 0) and player:getPile("sfofl_horsetailwhisk"):length() >= 2
    end,
    view_as = function(self, card)
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
            local acard = sfofl_horsetailwhiskCard:clone()
            acard:addSubcard(card)
            return acard
		else
            local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
            if pattern == "jink" then
                local jink = sgs.Sanguosha:cloneCard("jink", sgs.Card_NoSuit, 0)
                jink:setSkillName("sfofl_horsetailwhisk")
                jink:addSubcard(card)
                return jink
            else
                local ncard = sgs.Sanguosha:cloneCard("nullification", card:getSuit(), card:getNumber())
                ncard:addSubcard(card)
                ncard:setSkillName("sfofl_horsetailwhisk")
                return ncard
            end
        end
    end
}
sfofl_horsetailwhisk = sgs.CreateArmor{
    name = "sfofl_horsetailwhisk",
    class_name = "Horsetailwhisk",
    suit = sgs.Card_Spade,
    number = 13,
    equip_skill = sfofl_horsetailwhiskVS,
    on_install = function(self, player)
        local room = player:getRoom()
        local viewAsSkill = sgs.Sanguosha:getViewAsSkill("sfofl_horsetailwhisk")
        if (viewAsSkill) then
            room:attachSkillToPlayer(player, self:objectName())
        end
    end,
    on_uninstall = function(self, player)
        local room = player:getRoom()
        -- for _,card_id in sgs.qlist(player:getPile("sfofl_horsetailwhisk")) do
        --     room:throwCard(card_id,player)
        -- end
        if (player:isAlive() and player:hasArmorEffect(self:objectName()) and not string.find(player:getFlags(), "_InTempMoving")) then
            player:clearOnePrivatePile("sfofl_horsetailwhisk")
        end
        local viewAsSkill = sgs.Sanguosha:getViewAsSkill("sfofl_horsetailwhisk")
        if (viewAsSkill) then
            room:detachSkillFromPlayer(player, self:objectName(), true)
        end			
    end
}
sfofl_horsetailwhisk:setParent(extension_card)

--[[
	技能名：便衣
	技能描述：锁定技，你每回合内第一次成为【杀】的目标时，此牌对你无效。
	引用：sfofl_plainclothes
]] --
sfofl_plainclothes_skill = sgs.CreateTriggerSkill{
    name = "sfofl_plainclothes",
    frequency = sgs.Skill_Compulsory,
    events = { sgs.TargetConfirming },
    can_trigger = function(self,target)
		return target and target:hasArmorEffect("sfofl_plainclothes")
	end,
    on_trigger = function(self, event, player, data)
        local use = data:toCardUse()
        local room = player:getRoom()
        if use.card and use.card:isKindOf("Slash") and use.to:contains(player)  then
           if player:getMark("sfofl_plainclothes-Clear") == 0 then
                local list = use.nullified_list
                table.insert(list,player:objectName())
                use.nullified_list = list
                data:setValue(use)
                room:sendCompulsoryTriggerLog(player, self:objectName(), true)
                room:addPlayerMark(player, "sfofl_plainclothes-Clear")
           end
        end
        return false
    end
}
sfofl_plainclothes = sgs.CreateArmor{
    name = "sfofl_plainclothes",
    class_name = "Plainclothes",
    suit = sgs.Card_Spade,
    number = 13,
    equip_skill = sfofl_plainclothes_skill,
    on_install = function(self, player)
        local room = player:getRoom()
        local viewAsSkill = sgs.Sanguosha:getViewAsSkill("sfofl_plainclothes")
        if (viewAsSkill) then
            room:attachSkillToPlayer(player, self:objectName())
        end
    end,
    on_uninstall = function(self, player)
        local room = player:getRoom()
        room:setPlayerMark(player, "sfofl_plainclothes-Clear", 0)
        local viewAsSkill = sgs.Sanguosha:getViewAsSkill("sfofl_plainclothes")
        if (viewAsSkill) then
            room:detachSkillFromPlayer(player, self:objectName(), true)
        end			
    end
}
sfofl_plainclothes:setParent(extension_card)

--[[
	技能名：丞相之令
	技能描述：你获得观星，若你已拥有观星，则将其描述中的X改为5。
	引用：sfofl_token
]] --
sfofl_token = sgs.CreateTreasure{
    name = "sfofl_token",
    class_name = "Token",
    suit = sgs.Card_Heart,
    number = 1,
    on_install = function(self,player)
        local room = player:getRoom()
        if player:hasSkill("guanxing") then
            room:attachSkillToPlayer(player,"super_guanxing")
            room:handleAcquireDetachSkills(player,"-guanxing")
        else
            room:attachSkillToPlayer(player,"guanxing")
        end
    end,
    on_uninstall = function(self,player)
        if player:hasSkill("guanxing") then
            player:getRoom():detachSkillFromPlayer(player,"guanxing",true,true)
        else
            player:getRoom():detachSkillFromPlayer(player,"super_guanxing",true,true)
            player:getRoom():handleAcquireDetachSkills(player,"guanxing")
        end
    end,
}

sfofl_token:setParent(extension_card)

--[[
	技能名：七星灯
	技能描述：每回合每种牌名限一次，你可以将所有手牌或七星灯当一张基本牌或【无懈可击】使用或打出。
	引用：sfofl_qixinglight
]] --
sfofl_qixinglight_select = sgs.CreateSkillCard {
    name = "sfofl_qixinglight_select",
    will_throw = false,
    target_fixed = true,
    handling_method = sgs.Card_MethodNone,
    on_use = function(self, room, source, targets)
        local choices = {}
        for _, name in ipairs(patterns()) do
            local poi = sgs.Sanguosha:cloneCard(name, sgs.Card_NoSuit, -1)
            poi:setSkillName("sfofl_qixinglight")
            if  poi:isAvailable(source) and poi:isKindOf("BasicCard") and source:getMark("sfofl_qixinglight"..poi:objectName().."-Clear") == 0 and not table.contains(sgs.Sanguosha:getBanPackages(), poi:getPackage()) then
                table.insert(choices, name)
            end
        end

        if next(choices) ~= nil then
            table.insert(choices, "cancel")
            local pattern = room:askForChoice(source, "sfofl_qixinglight", table.concat(choices, "+"))
            if pattern and pattern ~= "cancel" then
                local poi = sgs.Sanguosha:cloneCard(pattern, sgs.Card_NoSuit, -1)
                poi:deleteLater()
                if poi:targetFixed() then
                    poi:setSkillName("sfofl_qixinglight")
                    poi:addSubcards(self:getSubcards())
                    local nonetarget = sgs.SPlayerList()
                    room:useCard(sgs.CardUseStruct(poi, source, nonetarget), true)
                else
                    local cdata = sgs.QVariant()
                    cdata:setValue(poi)
                    room:setPlayerProperty(source,"sfofl_qixinglight",sgs.QVariant(tostring(poi:objectName())))
                    room:askForUseCard(source, "@@sfofl_qixinglight", "@sfofl_qixinglight:" .. pattern) --%src
                    room:setPlayerProperty(source,"sfofl_qixinglight",sgs.QVariant())
                end
            end
        end
    end
}
sfofl_qixinglightCard = sgs.CreateSkillCard {
    name = "sfofl_qixinglight",
    will_throw = false,
    filter = function(self, targets, to_select, player)
        local plist = sgs.PlayerList()
        for i = 1, #targets do plist:append(targets[i]) end
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
            local card, user_str = nil, self:getUserString()
            if user_str ~= "" then
                local us = user_str:split("+")
                card = sgs.Sanguosha:cloneCard(us[1])
            end
            return card and card:targetFilter(plist, to_select, sgs.Self) and
                not sgs.Self:isProhibited(to_select, card, plist)
        elseif sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE then
            return false
        end
        local card = sgs.Sanguosha:cloneCard(sgs.Self:property("sfofl_qixinglight"):toString(), sgs.Card_SuitToBeDecided, -1)
        return card and card:targetFilter(plist, to_select, sgs.Self) and
            not sgs.Self:isProhibited(to_select, card, plist)
    end,
    feasible = function(self, targets)
        local plist = sgs.PlayerList()
        for i = 1, #targets do plist:append(targets[i]) end
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
            local card, user_str = nil, self:getUserString()
            if user_str ~= "" then
                local us = user_str:split("+")
                card = sgs.Sanguosha:cloneCard(us[1])
            end
            return card and card:targetsFeasible(plist, sgs.Self)
        elseif sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE then
            return true
        end
        local card = sgs.Sanguosha:cloneCard(sgs.Self:property("sfofl_qixinglight"):toString(), sgs.Card_SuitToBeDecided, -1)
        return card and card:targetsFeasible(plist, sgs.Self)
    end,
    on_validate = function(self, use)
        local yuji = use.from
        local to_guhuo = self:getUserString()
        if to_guhuo == "slash" then
            to_guhuo = table.concat(sgs.Sanguosha:getSlashNames(), "+")
        end
        local user_str = yuji:getRoom():askForChoice(yuji, "sfofl_qixinglight_slash", to_guhuo)
        local use_card = sgs.Sanguosha:cloneCard(user_str)
        use_card:setSkillName("sfofl_qixinglight")
        use_card:addSubcard(self)
        return use_card
    end,
    on_validate_in_response = function(self, yuji)
        local to_guhuo = self:getUserString()
        if to_guhuo == "slash" then
            to_guhuo = table.concat(sgs.Sanguosha:getSlashNames(), "+")
        end
        local user_str = yuji:getRoom():askForChoice(yuji, "sfofl_qixinglight_slash", to_guhuo)
        local use_card = sgs.Sanguosha:cloneCard(user_str)
        use_card:setSkillName("sfofl_qixinglight")
        use_card:addSubcard(self)
        return use_card
    end
}
sfofl_qixinglightVS = sgs.CreateViewAsSkill {
    name = "sfofl_qixinglight",
    n = 999,
    view_filter = function(self, selected, to_select)
        return not to_select:isEquipped()
    end,
    view_as = function(self, cards)
        if #cards == sgs.Self:getHandcards():length() or #cards == 0 then
            local c = sfofl_qixinglightCard:clone()
            if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE
                or sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
                local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
			    if pattern and pattern == "@@sfofl_qixinglight" then
                    local card = sgs.Sanguosha:cloneCard(sgs.Self:property("sfofl_qixinglight"):toString(), sgs.Card_SuitToBeDecided, -1)
                    c:setUserString(card:objectName())
                    if #cards > 0 then
                        for _, ic in sgs.list(cards) do
                            c:addSubcard(ic)
                        end
                    else
                        if sgs.Self:getTreasure() == nil then
                            return nil
                        else
                            c:addSubcard(sgs.Self:getTreasure():getRealCard())
                        end
                    end
                else
                    c:setUserString(pattern)
                    if #cards > 0 then
                        for _, ic in sgs.list(cards) do
                            c:addSubcard(ic)
                        end
                    else
                        if sgs.Self:getTreasure() == nil then
                            return nil
                        else
                            c:addSubcard(sgs.Self:getTreasure():getRealCard())
                        end
                    end
                end
                return c
            end
            if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
                local c = sfofl_qixinglight_select:clone()
                if #cards > 0 then
                    for _, ic in sgs.list(cards) do
                        c:addSubcard(ic)
                    end
                else
                    if sgs.Self:getTreasure() == nil then
                        return nil
                    else
                        c:addSubcard(sgs.Self:getTreasure():getRealCard())
                    end
                end
                return c
            end
        end
    end,
    enabled_at_response = function(self, player, pattern)
        local skill_invoke = pattern
        if  (string.find(skill_invoke, "@@sfofl_qixinglight")) then
            return true
        end
        if pattern == "peach+analeptic" and player:getMark("Global_PreventPeach") > 0
        then
            pattern = "analeptic"
        end
        pattern = dummyCard(pattern:split("+")[1])
        if pattern and player:getMark("sfofl_qixinglight"..pattern:objectName().."-Clear") < 1 and player:getCardCount(true) > 0
        then
            return pattern:isKindOf("BasicCard") or pattern:isKindOf("Nullification") or
                ((string.find(skill_invoke, "slash")) and
                    (sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE
                        or sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE))
        end
        return false
    end,
    enabled_at_play = function(self, player)
        for _, pn in sgs.list(patterns())do
            
            local dc = sgs.Sanguosha:cloneCard(pn)
            if dc then
                if player:getMark("sfofl_qixinglight"..dc:objectName().."-Clear")>0 then continue end
                dc:setSkillName("sfofl_qixinglight")
                dc:deleteLater()
                if (dc:isKindOf("BasicCard") or dc:isKindOf("Nullification"))
                and dc:isAvailable(player)
                then return true end
            end
        end
    end,
}

sfofl_qixinglight_skill = sgs.CreateTriggerSkill {
    name = "sfofl_qixinglight",
    events = { sgs.CardUsed, sgs.CardResponded },
    view_as_skill = sfofl_qixinglightVS,
    on_trigger = function(self, event, player, data, room)
        local card
        if event == sgs.CardUsed then
            local use = data:toCardUse()
            card = use.card
        elseif event == sgs.CardResponded then
            card = data:toCardResponse().m_card
        end
        if card:isKindOf("SkillCard") or card:getSkillName() ~= "sfofl_qixinglight" then return false end
        room:setPlayerMark(player, "sfofl_qixinglight"..card:objectName().."-Clear", 1)
        -- room:setPlayerMark(player, "sfofl_qixinglight_guhuo_remove_"..card:objectName().."-Clear", 1)
        return false
    end,
    can_trigger = function(self,target)
		return target and target:hasTreasure("sfofl_qixinglight")
	end,
}
-- sfofl_qixinglightVS:setGuhuoDialog("l")
sfofl_qixinglight = sgs.CreateTreasure{
	name = "sfofl_qixinglight",
	class_name = "Qixinglight",
	equip_skill = sfofl_qixinglight_skill,
    suit = sgs.Card_Spade,
    number = 13,
	on_install = function(self,player)
		local room = player:getRoom()
		room:attachSkillToPlayer(player,"sfofl_qixinglight")
	end,
	on_uninstall = function(self,player)
		player:getRoom():detachSkillFromPlayer(player,"sfofl_qixinglight",true,true)
	end,
}
sfofl_qixinglight:setParent(extension_card)


--[[
	技能名：虎豹兵符
	技能描述：你可以将一张其他装备牌当杀使用或打出，若此牌为：武器，此杀不可被响应；坐骑，此杀不计次数；防具，你摸一张牌。
	引用：sfofl_tigertally
]] --
sfofl_tigertallyVS = sgs.CreateViewAsSkill {
    name = "sfofl_tigertally",
    n = 1,
    view_filter = function(self, selected, to_select)
        if not to_select:isEquipped() then return false end
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
            local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
            slash:addSubcard(to_select:getEffectiveId())
            slash:deleteLater()
            return slash:isAvailable(sgs.Self)
        end
        return true
    end,
    view_as = function(self, cards)
        if #cards == 1 then
            local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
            slash:addSubcard(cards[1]:getId())
            slash:setSkillName(self:objectName())
            return slash
        end
	end,
    enabled_at_play = function(self, player)
		return sgs.Slash_IsAvailable(player)
	end, 
	enabled_at_response = function(self, player, pattern)
		return pattern == "slash"
	end
}

sfofl_tigertally_skill = sgs.CreateTriggerSkill {
    name = "sfofl_tigertally",
    events = { sgs.CardUsed, sgs.CardResponded, sgs.TargetSpecified },
    view_as_skill = sfofl_tigertallyVS,
    on_trigger = function(self, event, player, data, room)
        if event == sgs.CardUsed or event == sgs.CardResponded then
            local card
            if event == sgs.CardUsed then
                local use = data:toCardUse()
                card = use.card
            elseif event == sgs.CardResponded then
                card = data:toCardResponse().m_card
            end
            if card:getSkillName() ~= "sfofl_tigertally" then return false end
            if sgs.Sanguosha:getCard(card:getSubcards():first()):isKindOf("Armor") then
                player:drawCards(1, self:objectName())
            end
        elseif event == sgs.TargetSpecified then
            local use = data:toCardUse()
            if not use.card:isKindOf("Slash") or use.card:getSkillName() ~= "sfofl_tigertally" then return false end
            if sgs.Sanguosha:getCard(use.card:getSubcards():first()):isKindOf("DefensiveHorse") or sgs.Sanguosha:getCard(use.card:getSubcards():first()):isKindOf("OffensiveHorse") then
                room:addPlayerHistory(player, "slash", -1)
            elseif sgs.Sanguosha:getCard(use.card:getSubcards():first()):isKindOf("Weapon") then
                local jink_table = sgs.QList2Table(player:getTag("Jink_" .. use.card:toString()):toIntList())
                local index = 1
                for _, p in sgs.qlist(use.to) do
                    local log = sgs.LogMessage()
                    log.type = "#skill_cant_jink"
                    log.from = player
                    log.to:append(p)
                    log.arg = self:objectName()
                    room:sendLog(log)
                    jink_table[index] = 0
                    index = index + 1
                end
                local jink_data = sgs.QVariant()
                jink_data:setValue(Table2IntList(jink_table))
                player:setTag("Jink_" .. use.card:toString(), jink_data)
            end
        end
        return false
    end,
    can_trigger = function(self,target)
        return target and target:hasTreasure("sfofl_tigertally")
    end,
}

sfofl_tigertally = sgs.CreateTreasure{
    name = "sfofl_tigertally",
    class_name = "Tigertally",
    equip_skill = sfofl_tigertally_skill,
    suit = sgs.Card_Spade,
    number = 5,
    on_install = function(self,player)
        local room = player:getRoom()
        room:attachSkillToPlayer(player,"sfofl_tigertally")
    end,
    on_uninstall = function(self,player)
        player:getRoom():detachSkillFromPlayer(player,"sfofl_tigertally",true,true)
    end,
}
sfofl_tigertally:setParent(extension_card)




sfofl_2_zhouyu = sgs.General(extension_s, "sfofl_2_zhouyu", "wu", 3, true)
--[[
	技能名：识音
	相关武将：周瑜[官盗]
	技能描述：游戏开始时，你可以将一张手牌正面向上置于武将牌上，称为“杂音”标记，与其花色相同的牌称为“杂音”牌；出牌阶段开始时，你可以用一张手牌替换“杂音”标记。
	引用：sfofl_2_shiyin
]] --
sfofl_2_shiyin = sgs.CreateTriggerSkill{
    name = "sfofl_2_shiyin",
    events = {sgs.AfterDrawNCards, sgs.EventPhaseStart},
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.AfterDrawNCards then
            local draw = data:toDraw()
			if draw.reason ~= "InitialHandCards" then return false end
            local card = room:askForExchange(player, self:objectName(), 1, 1, false, "QuanjiPush", true)
            if card then
                local card_id = card:getSubcards():first()
                player:addToPile("sfofl_noise", card_id)
            end
        elseif event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Play then
            if not player:getPile("sfofl_noise"):isEmpty() then
                local card = room:askForExchange(player, self:objectName(), 1, 1, false, "QuanjiPush", true)
                if card then
                    local dummy = sgs.Sanguosha:cloneCard("slash")
					dummy:deleteLater()
					local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_EXCHANGE_FROM_PILE, player:objectName(),"sfofl_2_shiyin", "");
					for _, id in sgs.qlist(player:getPile("sfofl_noise")) do
						dummy:addSubcard(id)
					end
                    room:obtainCard(player, dummy, reason, false)
                    local card_id = card:getSubcards():first()
                    player:addToPile("sfofl_noise", card_id)
                end
                
            end
        end
        return false
    end
}


--[[
	技能名：曲误
	相关武将：周瑜[官盗]
	技能描述：锁定技，你不能使用或打出“杂音”牌且“杂音”牌对你无效。
	引用：sfofl_quwu
]] --

sfofl_quwu_limit = sgs.CreateCardLimitSkill{
    name = "#sfofl_quwu_limit",
    limit_list = function(self,player)
        return "use,response"
    end,
    limit_pattern = function(self,player)
        if player:hasSkill("sfofl_2_shiyin") and player:hasSkill("sfofl_quwu") then
            local ss = {}
            for _, id in sgs.qlist(player:getPile("sfofl_noise")) do
                local card = sgs.Sanguosha:getCard(id)
                if not table.contains(ss, card:getSuitString()) then
                    table.insert(ss, card:getSuitString())
                end
            end
            if table.concat(ss, ",")~="" then return ".|"..table.concat(ss, "+") end
        end
        return ""
    end
}
sfofl_quwu = sgs.CreateTriggerSkill {
	name = "sfofl_quwu",
	frequency = sgs.Skill_Compulsory,
	events = { sgs.CardEffected },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local effect = data:toCardEffect()
        if player:getPile("sfofl_noise"):isEmpty() then return end
        if effect.card:isKindOf("SkillCard") then return end
        for _, id in sgs.qlist(player:getPile("sfofl_noise")) do
            local card = sgs.Sanguosha:getCard(id)
            if effect.card:getSuit() == card:getSuit() then
                local msg = sgs.LogMessage()
                msg.type = "#SkillNullify"
                msg.from = player
                msg.arg = self:objectName()
                msg.arg2 = effect.card:objectName()
                room:sendLog(msg)
                return true
            end
        end
	end
}


--[[
	技能名：聊奏
	相关武将：周瑜[官盗]
	技能描述：出牌阶段，你可以展示所有手牌，若其中没有杂音牌，你摸一张牌。
	引用：sfofl_liaozou
]] --
sfofl_liaozouCard = sgs.CreateSkillCard{
    name = "sfofl_liaozou",
    target_fixed = true,
    on_use = function(self, room, source, targets)
        room:showAllCards(source)
        source:drawCards(1, self:objectName())
    end
}
sfofl_liaozou = sgs.CreateZeroCardViewAsSkill{
    name = "sfofl_liaozou",
    view_as = function(self, cards)
        local skillcard = sfofl_liaozouCard:clone()
        skillcard:setSkillName(self:objectName())
        return skillcard
    end,
    enabled_at_play = function(self, player)
        if player:getPile("sfofl_noise"):isEmpty() then return false end
        for _, id in sgs.qlist(player:getPile("sfofl_noise")) do
            local c = sgs.Sanguosha:getCard(id)
            for _, card in sgs.qlist(player:getHandcards()) do
                if card:getSuit() == c:getSuit() then
                    return false
                end
            end
        end
        return true
    end
}

sfofl_2_zhouyu:addSkill(sfofl_2_shiyin)
sfofl_2_zhouyu:addSkill(sfofl_quwu)
sfofl_2_zhouyu:addSkill(sfofl_quwu_limit)
extension_s:insertRelatedSkills("sfofl_quwu", "#sfofl_quwu_limit")
sfofl_2_zhouyu:addSkill(sfofl_liaozou)

sfofl_zhugeliang = sgs.General(extension_s, "sfofl_zhugeliang", "shu", 3, true)
--[[
	技能名：祈星
	相关武将：诸葛亮[官盗]
	技能描述：出牌阶段开始时，你可以将你的手牌摸至七张，若如此做，回合结束时，你弃置所有手牌，且本回合你连续使用两张类别相同的牌时，你失去1点体力。
	引用：sfofl_qixing
]] --

sfofl_qixing = sgs.CreateTriggerSkill {
    name = "sfofl_qixing",
    frequency = sgs.Skill_NotFrequent,
    events = { sgs.EventPhaseStart },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if player:getPhase() == sgs.Player_Play and player:getHandcardNum() < 7 and room:askForSkillInvoke(player, self:objectName()) then
            player:drawCards(7-player:getHandcardNum(), self:objectName())
            room:addPlayerMark(player, "&"..self:objectName() .. "-Clear")
            room:addPlayerMark(player, self:objectName())
        end
    end
}
sfofl_qixing_buff = sgs.CreateTriggerSkill {
    name = "#sfofl_qixing_buff",
    frequency = sgs.Skill_Compulsory,
    events = { sgs.EventPhaseChanging, sgs.CardUsed },
    can_trigger = function(self, target)
        return target and target:getMark("sfofl_qixing") > 0
    end,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.EventPhaseChanging then
            local change = data:toPhaseChange()
			if change.to==sgs.Player_NotActive then
                room:setPlayerMark(player, "sfofl_qixing", 0)
                player:throwAllHandCards()
            end
        elseif event == sgs.CardUsed then
            local use = data:toCardUse()
            if use.card and use.card:isKindOf("SkillCard") then return end
            for _, mark in sgs.list(player:getMarkNames()) do
                if string.find(mark, "sfofl_qixingCard"..use.card:getTypeId()) and player:getMark(mark) > 0 then
                    room:sendCompulsoryTriggerLog(player, "sfofl_qixing", true)
                    room:loseHp(player, 1, true, player, "sfofl_qixing")
                end
            end
            for _, mark in sgs.list(player:getMarkNames()) do
                if string.find(mark, "sfofl_qixingCard") and player:getMark(mark) > 0 then
                    room:setPlayerMark(player, mark, 0)
                end
            end
            room:setPlayerMark(player, "sfofl_qixingCard"..use.card:getTypeId(), 1)
        end
    end
}


sfofl_zhugeliang:addSkill("kongcheng")
sfofl_zhugeliang:addSkill(sfofl_qixing)
sfofl_zhugeliang:addSkill(sfofl_qixing_buff)
extension_s:insertRelatedSkills("sfofl_qixing", "#sfofl_qixing_buff")
--[[
	技能名：七弦琴
	技能描述：你每有一张手牌，你的攻击范围+1；你攻击范围外的角色对你造成伤害后，你可以弃置该角色一张牌。
	引用：sfofl_lyre
]] --
sfofl_lyre_skill = sgs.CreateTriggerSkill{
    name = "sfofl_lyre", --一般的话，技能的objectName()和武器的objectName(）用一样的名字
    frequency = sgs.Skill_Compulsory,
    events = { sgs.Damaged, sgs.CardsMoveOneTime },
    can_trigger = function(self, target)
        return target and target:hasWeapon(self:objectName())
    end,
    on_trigger = function(self, event, player, data)
        local damage = data:toDamage()
        local room = player:getRoom()
        if event == sgs.Damaged then
            if damage.from and damage.from:objectName() ~= player:objectName() and not player:inMyAttackRange(damage.from) then
                if player:canDiscard(damage.from, "he") and room:askForSkillInvoke(player, self:objectName(), data)  then
                    local id = room:askForCardChosen(player, damage.from, "he", self:objectName())
                    room:throwCard(id, damage.from, player)
                end
            end
        elseif event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            local room = player:getRoom()
            if move.to and move.to:objectName() == player:objectName() then
                room:notifyWeaponRange("sfofl_lyre", player:getHandcardNum())
            else
                if move.from and move.from:objectName() == player:objectName() and move.from_places:contains(sgs.Player_PlaceHand) then
                    room:notifyWeaponRange("sfofl_lyre", player:getHandcardNum())
                end
            end
            
        end
        return false
    end
}
sfofl_lyre = sgs.CreateWeapon{
    name = "sfofl_lyre",
    class_name = "Lyre",
    suit = sgs.Card_Spade,
    number = 7,
    range = 0,
    equip_skill = sfofl_lyre_skill,
    on_install = function(self, player)
        local room = player:getRoom()
        local skill = sgs.Sanguosha:getSkill(self:objectName())
        if skill then
            if skill:inherits("ViewAsSkill") then
                room:attachSkillToPlayer(player, self:objectName())
            elseif skill:inherits("TriggerSkill") then
                local tirggerskill = sgs.Sanguosha:getTriggerSkill(self:objectName())
                room:getThread():addTriggerSkill(tirggerskill)
            end
        end
        end,
    on_uninstall = function(self, player) --卸下时移除技能
        local room = player:getRoom()
        local skill = sgs.Sanguosha:getSkill(self:objectName())
        if skill and skill:inherits("ViewAsSkill") then
            room:detachSkillFromPlayer(player, self:objectName(), true)
        end
    end,
}
    
sfofl_lyre:setParent(extension_card)


sfofl_2_guanyu = sgs.General(extension_s, "sfofl_2_guanyu", "shu+wei", 4, true)
--[[
	技能名：怒嗔
	相关武将：关羽[官盗]
	技能描述：魏势力技，出牌阶段限一次，你可以展示一名其他角色的一张手牌，然后选择一项：1.弃置一张花色相同的牌并对其造成1点伤害；2.获得此牌。
	引用：sfofl_nuchen
]] --
sfofl_nuchenCard = sgs.CreateSkillCard{
    name = "sfofl_nuchen" ,
    filter = function(self, targets, to_select)
        return (#targets == 0) and (to_select:objectName() ~= sgs.Self:objectName()) and not to_select:isKongcheng()
    end,
    on_effect = function(self, effect)
        local room = effect.to:getRoom()
        local card_id = room:askForCardChosen(effect.from, effect.to, "h", "sfofl_nuchen")
        room:showCard(effect.to, card_id)
        local prompt = string.format("@sfofl_nuchen:%s", effect.to:getGeneralName())
        local dest = sgs.QVariant()
        dest:setValue(effect.to)
        local card = room:askForCard(effect.from, ".|"..sgs.Sanguosha:getCard(card_id):getSuitString().."|.|hand|.", prompt, dest, sgs.Card_MethodDiscard)
        if card then
            room:damage(sgs.DamageStruct(self:objectName(), effect.from, effect.to, 1))
        else
            room:obtainCard(effect.from, card_id, true)
        end	
    end
}
sfofl_nuchen = sgs.CreateViewAsSkill{
    name = "sfofl_nuchen" ,
    n = 0,
    view_as = function(self, cards)
        if #cards ~= 0 then return nil end
        local card = sfofl_nuchenCard:clone()
        return card
    end ,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_nuchen") and player:getKingdom() == "wei"
    end
}


--[[
	技能名：义绝
	相关武将：关羽[官盗]
	技能描述：蜀势力技，出牌阶段限一次，你可以与一名角色拼点，若你赢，本回合其不能使用或打出手牌，没赢，你可以令其回复1点体力。
	引用：sfofl_yijue
]] --
sfofl_yijueCard = sgs.CreateSkillCard{
    name = "sfofl_yijue" ,
    filter = function(self, targets, to_select)
        return (#targets == 0) and (to_select:objectName() ~= sgs.Self:objectName()) and sgs.Self:canPindian(to_select)
    end,
    on_effect = function(self, effect)
        local room = effect.to:getRoom()
        local success = effect.from:pindian(effect.to, "sfofl_yijue", nil)
		if success then
			room:addPlayerMark(effect.to, "&sfofl_yijue+to+#"..effect.from:objectName().."-Clear")
            room:setPlayerCardLimitation(effect.to, "use,response", ".|.|.|hand", true);
		else
			if (effect.to:isAlive() and effect.to:isWounded() and effect.from:askForSkillInvoke("tenyearyijue", string.format("recover:%s", effect.to:objectName()))) then
                room:recover(effect.to, sgs.RecoverStruct("tenyearyijue", effect.from));
            end
		end
    end
}
sfofl_yijue = sgs.CreateViewAsSkill{
    name = "sfofl_yijue" ,
    n = 0,
    view_as = function(self, cards)
        if #cards ~= 0 then return nil end
        local card = sfofl_yijueCard:clone()
        return card
    end ,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_yijue") and player:getKingdom() == "shu"
    end
}

sfofl_2_guanyu:addSkill("tenyearwusheng")
sfofl_2_guanyu:addSkill(sfofl_nuchen)
sfofl_2_guanyu:addSkill(sfofl_yijue)

sfofl_2_zhaoyun = sgs.General(extension_s, "sfofl_2_zhaoyun", "shu", 4, true)
--[[
	技能名：回枪
	相关武将：赵云[官盗]
	技能描述：当你使用的【杀】被目标角色使用的【闪】抵消后，你可以对其使用一张【杀】。
	引用：sfofl_huiqiang
]] --
sfofl_huiqiang = sgs.CreateTriggerSkill{
    name = "sfofl_huiqiang", 
    events = {sgs.CardOffset}, 
    frequency = sgs.Skill_NotFrequent, 
    on_trigger = function(self, TriggerEvent, player, data)
        local room = player:getRoom()
        local effect = data:toCardEffect()
        if not effect.card:isKindOf("Slash") then return false end
        if effect.from:canSlash(effect.to, nil, false) then
            room:askForUseSlashTo(effect.from, effect.to, "sfofl_huiqiang-slash:"..effect.to:objectName(), false, true)
        end
        return false
    end,
}

--[[
	技能名：魂突
	相关武将：赵云[官盗]
	技能描述：出牌阶段限一次，当你使用的【杀】对目标角色造成伤害后，你可以对其使用一张【杀】。
	引用：sfofl_huntu
]] --
sfofl_huntu = sgs.CreateTriggerSkill{
    name = "sfofl_huntu", 
    events = {sgs.Damage, sgs.CardFinished}, 
    frequency = sgs.Skill_NotFrequent, 
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.Damage then
            local damage = data:toDamage()
            if player:getPhase() ~= sgs.Player_Play or player:getMark("sfofl_huntu-PlayClear") > 0 then return end
            if damage.card and damage.card:isKindOf("Slash") and not damage.chain and not damage.transfer then
                room:setCardFlag(damage.card, "sfofl_huntu")
                room:setPlayerFlag(damage.to, "sfofl_huntu")
            end
        elseif event == sgs.CardFinished then
            local use = data:toCardUse()
            if use.card:isKindOf("Slash") and use.card:hasFlag("sfofl_huntu") then
                local targets = sgs.SPlayerList()
                for _,to in sgs.list(use.to)do
                    if to:hasFlag("sfofl_huntu") then
                        room:setPlayerFlag(to, "-sfofl_huntu")
                        targets:append(to)
                    end
                end
                if targets:isEmpty() then return end
                room:setPlayerMark(player, "sfofl_huntu-PlayClear", 1)
                if room:askForUseSlashTo(player, targets, "sfofl_huntu-slash", false, false) then
                    room:addPlayerMark(player, "sfofl_huntu-PlayClear")
                end
            end
        end
        return false
    end,
}

sfofl_2_zhaoyun:addSkill("longdan")
sfofl_2_zhaoyun:addSkill(sfofl_huiqiang)
sfofl_2_zhaoyun:addSkill(sfofl_huntu)

sfofl_2_zhugeliang = sgs.General(extension_s, "sfofl_2_zhugeliang", "shu", 3, true)
--[[
	技能名：智激
	相关武将：诸葛亮[官盗]
	技能描述：出牌阶段限一次，你可以弃置两张手牌并选择两名不同势力的角色，视为两名角色对对方使用一张【杀】。
	引用：sfofl_zhiji
]] --
sfofl_zhijiCard = sgs.CreateSkillCard{
    name = "sfofl_zhiji",
    target_fixed = false,
    filter = function(self, targets, to_select)
		if #targets == 1 then
			return to_select:getKingdom() ~= #targets[1]:getKingdom()
		end
		return #targets < 2
	end,
    on_use = function(self, room, source, targets)
        local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
        slash:setSkillName(self:objectName())
        slash:deleteLater()
        local use = sgs.CardUseStruct()
        use.card = slash
        use.from = targets[1]
        use.to:append(targets[2])
        room:useCard(use)
        if targets[2]:isAlive() then
            local use = sgs.CardUseStruct()
            use.card = slash
            use.from = targets[2]
            use.to:append(targets[1])
            room:useCard(use)
        end
    end
}
sfofl_zhiji = sgs.CreateViewAsSkill{
    name = "sfofl_zhiji",
    n = 2,
    view_filter = function(self, selected, to_select)
        return not to_select:isEquipped()
    end,
    view_as = function(self, cards)
        if #cards == 2 then
            local card = sfofl_zhijiCard:clone()
            card:addSubcard(cards[1])
            card:addSubcard(cards[2])
            return card
        end
    end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_zhiji")
    end
}


--[[
	技能名：借风
	相关武将：诸葛亮[官盗]
	技能描述：你可以弃置两张手牌，然后亮出牌堆顶的5张牌，若其中有两张红色牌，则视为你使用一张万箭齐发。
	引用：sfofl_jiefeng
]] --
sfofl_jiefengCard = sgs.CreateSkillCard{
    name = "sfofl_jiefeng",
    target_fixed = true,
    on_use = function(self, room, source, targets)
        local ids = room:getNCards(5, false)
        local move = sgs.CardsMoveStruct()
        move.card_ids = ids
        move.to = source
        move.to_place = sgs.Player_PlaceTable
        move.reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_TURNOVER, source:objectName(), self:objectName(), nil)
        room:moveCardsAtomic(move, true)
        local card_to_throw = {}
        local y = 0
        for i=0, 4, 1 do
            local id = ids:at(i)
            local card = sgs.Sanguosha:getCard(id)
            if card:isRed() then
                y = y + 1
            end
            table.insert(card_to_throw, id)
        end
        if #card_to_throw > 0 then
            local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
            dummy:deleteLater()
            for _, id in ipairs(card_to_throw) do
                dummy:addSubcard(id)
            end
            local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_NATURAL_ENTER, source:objectName(), self:objectName(), nil)
            room:throwCard(dummy, reason, nil)
        end
        if y >= 2 then
            local use = sgs.CardUseStruct()
            local archery_attack = sgs.Sanguosha:cloneCard("archery_attack", sgs.Card_SuitToBeDecided, -1)
            archery_attack:setSkillName(self:objectName())
            archery_attack:deleteLater()
            use.card = archery_attack
            use.from = source
            room:useCard(use)
        end
    end
}
sfofl_jiefeng = sgs.CreateViewAsSkill{
    name = "sfofl_jiefeng",
    n = 2,
	view_filter = function(self, selected, to_select)
		return not to_select:isEquipped()
	end,
	view_as = function(self, cards)
		if #cards == 2 then
			local card = sfofl_jiefengCard:clone()
			card:addSubcard(cards[1])
			card:addSubcard(cards[2])
			return card
		end
	end,
    enabled_at_play = function(self, player)
        return true
    end
}


sfofl_2_zhugeliang:addSkill(sfofl_zhiji)
sfofl_2_zhugeliang:addSkill(sfofl_jiefeng)
sfofl_2_zhugeliang:addSkill("kongcheng")

sfofl_2_simayi = sgs.General(extension_s, "sfofl_2_simayi", "wei", 3, true)
--[[
	技能名：冢虎
	相关武将：司马懿[官盗]
	技能描述：你的回合外有角色死亡时，你可以立即终止当前角色回合，并且游戏轮次跳至你的回合。
	引用：sfofl_zhonghu
    做不出來
]] --

sfofl_zhonghu = sgs.CreateTriggerSkill{
    name = "sfofl_zhonghu", 
    events = {sgs.Death}, 
    frequency = sgs.Skill_NotFrequent,
    priority = -99,
    on_trigger = function(self, event, player, data, room)
        if player:isAlive() and player:getPhase() == sgs.Player_NotActive and room:askForSkillInvoke(player, self:objectName(), data) then
            data:toDeath().who:bury()
            local current = room:getCurrent()
            if current and current:isAlive() and (room:getTag("Global_ExtraTurn".. current:objectName()):toBool()) then
                room:throwEvent(sgs.TurnBroken)
            end
            local current = room:getCurrent()
            if current and current:isAlive() then
                current:changePhase(current:getPhase(), sgs.Player_NotActive)
            end
            local target = player:getNextAlive(room:alivePlayerCount() - 1)
            if target then
                room:setCurrent(target)
            end
            room:throwEvent(sgs.TurnBroken)
        end
        return false
    end,
}
sfofl_2_simayi:addSkill("fankui")
sfofl_2_simayi:addSkill("guicai")
sfofl_2_simayi:addSkill(sfofl_zhonghu)

sfofl_machao = sgs.General(extension_s, "sfofl_machao", "shu", 4, true)
--[[
	技能名：威侯
	相关武将：马超[官盗]
	技能描述：当你进行判定时，你可以展示牌堆顶的两张牌，弃置其中一张并选择另一张作为你本次的判定牌。
	引用：sfofl_weihou
]] --
sfofl_weihou=sgs.CreateTriggerSkill{ 
    name="sfofl_weihou",
    frequency=sgs.Skill_Frequent,
    events=sgs.StartJudge,
    on_trigger=function(self,event,player,data)
        local room=player:getRoom()
        if not room:askForSkillInvoke(player,self:objectName()) then return end
        room:broadcastSkillInvoke(self:objectName())
        local ids = room:getNCards(2, false)
		local move = sgs.CardsMoveStruct()
		move.card_ids = ids
		move.to = player
		move.to_place = sgs.Player_PlaceTable
		move.reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_TURNOVER, player:objectName(), self:objectName(), "")
		room:moveCardsAtomic(move, true)
		
        room:fillAG(ids, player)
        room:setTag("sfofl_weihou", data)
		local choice_id = room:askForAG(player, ids, false, self:objectName())
        room:removeTag("sfofl_weihou")
		if choice_id ~= -1 then
            local card = sgs.Sanguosha:getCard(choice_id)
            local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_NATURAL_ENTER, player:objectName(), self:objectName(), "")
            room:throwCard(card, reason, nil)
            ids:removeOne(choice_id)
        end
        room:clearAG()
        local judge = data:toJudge()
        judge.card = sgs.Sanguosha:getCard(ids:first())
        judge:updateResult()
        data:setValue(judge)
        room:setTag("SkipGameRule", sgs.QVariant(tonumber(event)))
    end,
}

sfofl_machao:addSkill("mashu")
sfofl_machao:addSkill("nostieji")
sfofl_machao:addSkill(sfofl_weihou)

sfofl_caopi = sgs.General(extension_s, "sfofl_caopi$", "wei", 3, true)
--[[
	技能名：僭位
	相关武将：曹丕[官盗]
	技能描述：限定技，回合开始时，你可以失去1点体力，然后与一名其他角色交换区域内所有牌。
	引用：sfofl_jianwei
]] --

sfofl_jianwei = sgs.CreateTriggerSkill{
    name = "sfofl_jianwei",
    frequency = sgs.Skill_Limited,
    events = { sgs.EventPhaseStart },
    limit_mark = "@sfofl_jianwei",
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if player:getMark("@sfofl_jianwei") > 0 and player:getPhase() == sgs.Player_Start then
            local target = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName(),
						"sfofl_jianwei-invoke", true, true)
            if not target then return false end
            player:loseMark("@sfofl_jianwei")
            room:loseHp(player, 1, true, player, self:objectName())
            if not player:isAlive() then return false end
            room:swapCards(player, target, "hej", self:objectName())
        end
        return false
    end
}


sfofl_caopi:addSkill(sfofl_jianwei)
sfofl_caopi:addSkill("fangzhu")
sfofl_caopi:addSkill("songwei")

sfofl_3_simayi = sgs.General(extension_s, "sfofl_3_simayi", "wei", 3, true)
--[[
	技能名：虎啸
	相关武将：司马懿[官盗]
	技能描述：回合开始时，你可以进行一次判定，若为基本牌或非延时锦囊牌，本回合内你可以将相同点数或花色的手牌当此判定牌使用。
	引用：sfofl_huxiao
]] --

sfofl_huxiaoVS=sgs.CreateViewAsSkill{
    name="sfofl_huxiao",
    n=1,
    response_or_use = true,
    view_filter=function(self,selected,to_select)
        if sgs.Self:getMark("sfofl_huxiaoskill-Clear") > 0 then 
            local card_id=sgs.Self:getMark("sfofl_huxiaoskill-Clear")
            local card=sgs.Sanguosha:getCard(card_id)
            card:setSkillName("sfofl_huxiao")
            return not to_select:isEquipped() and ((sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY and card:isAvailable(sgs.Self)) or sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE or sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE) and (to_select:getSuit() == card:getSuit() or to_select:getNumber() == card:getNumber())
        end
        return false
    end,
    view_as=function(self,cards)
    if #cards==0 then return nil end
    if sgs.Self:getMark("sfofl_huxiaoskill-Clear") <= 0 then return nil end
        local card_id=sgs.Self:getMark("sfofl_huxiaoskill-Clear")
        local card=sgs.Sanguosha:getCard(card_id)
        local acard=cards[1]
        local new_card=sgs.Sanguosha:cloneCard(card:objectName(),acard:getSuit(),acard:getNumber())
        new_card:addSubcard(cards[1])
        new_card:setSkillName(self:objectName())
        return new_card
    end,
    enabled_at_play=function(self, player)
        if player:getMark("sfofl_huxiaoskill-Clear") > 0 then 
            local card=sgs.Sanguosha:getCard(player:getMark("sfofl_huxiaoskill-Clear"))
            card:setSkillName("sfofl_huxiao")
            return card:isAvailable(player)
        end
        return false
    end,
    enabled_at_response = function(self, player, pattern)
        if sgs.Sanguosha:getCurrentCardUseReason() ~= sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then return false end
        if player:getMark("sfofl_huxiaoskill-Clear") > 0 then 
            local card=sgs.Sanguosha:getCard(player:getMark("sfofl_huxiaoskill-Clear"))
            card:setSkillName("sfofl_huxiao")
            for _,pt in sgs.list(pattern:split("+"))do
                local dc = dummyCard(pt)
                if dc and card:sameNameWith(dc, false) then return true end
            end
        end
        return false
    end
}
sfofl_huxiao = sgs.CreateTriggerSkill{
    name = "sfofl_huxiao",
    events = {sgs.EventPhaseStart},
    view_as_skill = sfofl_huxiaoVS,
    on_trigger = function(self,event,player,data)
    local room = player:getRoom()
    if (player:getPhase() ~= sgs.Player_Start) then return false end
        local judge = sgs.JudgeStruct()
		judge.who = player
		judge.pattern = "EquipCard"
        judge.good = false
		judge.reason = self:objectName()
		room:judge(judge)
		if judge:isGood() then
            local card = judge.card
            if card:isNDTrick() or card:isKindOf("BasicCard")then
                local card_id=card:getEffectiveId()
                room:setPlayerMark(player,"sfofl_huxiaoskill-Clear",card_id)
                room:setPlayerMark(player, "&sfofl_huxiao+" .. card:objectName().. "+[+".. card:getSuitString().."_char" .."+" .. card:getNumberString() .. "+]-Clear", 1)
            end
        end
    end
}
sfofl_3_simayi:addSkill("guicai")
sfofl_3_simayi:addSkill(sfofl_huxiao)

sfofl_3_zhugeliang = sgs.General(extension_s, "sfofl_3_zhugeliang", "shu", 3, true)
--[[
	技能名：龙吟
	相关武将：诸葛亮[官盗]
	技能描述：你可以将任意点数和为13的牌当做任意基本牌或非延时锦囊牌使用或打出，每回合限一次。
	引用：sfofl_longyin
]] --
sfofl_longyinCard = sgs.CreateSkillCard {
    name = "sfofl_longyin",
    will_throw = false,
    handling_method = sgs.Card_MethodNone,
    filter = function(self, targets, to_select, player)
        local players = sgs.PlayerList()
        for i = 1, #targets do
            players:append(targets[i])
        end
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
            local card = nil
            if self:getUserString() and self:getUserString() ~= "" then
                card = sgs.Sanguosha:cloneCard(self:getUserString():split("+")[1])
                card:deleteLater()
                return card and card:targetFilter(players, to_select, sgs.Self) and
                    not sgs.Self:isProhibited(to_select, card, players)
            end
        elseif sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE then
            return false
        end
        local _card = player:getTag("sfofl_longyin"):toCard()
        if _card == nil then
            return false
        end
        local card = sgs.Sanguosha:cloneCard(_card)
        card:setCanRecast(false)
        card:deleteLater()
        return card and card:targetFilter(players, to_select, sgs.Self) and
            not sgs.Self:isProhibited(to_select, card, players)
    end,
    feasible = function(self, targets)
        local players = sgs.PlayerList()
        for i = 1, #targets do
            players:append(targets[i])
        end
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
            local card = nil
            if self:getUserString() and self:getUserString() ~= "" then
                card = sgs.Sanguosha:cloneCard(self:getUserString():split("+")[1])
                return card and card:targetsFeasible(players, sgs.Self)
            end
        elseif sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE then
            return true
        end
        local _card = sgs.Self:getTag("sfofl_longyin"):toCard()
        if _card == nil then
            return false
        end
        local card = sgs.Sanguosha:cloneCard(_card)
        card:setCanRecast(false)
        card:deleteLater()
        return card and card:targetsFeasible(players, sgs.Self)
    end,
    on_validate = function(self, card_use)
        local yuji = card_use.from
        local room = yuji:getRoom()
        local to_guhuo = self:getUserString()
        if to_guhuo == "slash" and sgs.Sanguosha:getCurrentCardUseReason() ==
            sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
            local guhuo_list = {}
            table.insert(guhuo_list, "slash")
            local sts = sgs.GetConfig("BanPackages", "")
            if not string.find(sts, "maneuvering") then
                table.insert(guhuo_list, "normal_slash")
                table.insert(guhuo_list, "thunder_slash")
                table.insert(guhuo_list, "fire_slash")
            end
            to_guhuo = room:askForChoice(yuji, "guhuo_slash", table.concat(guhuo_list, "+"))
        end
        local used_cards = sgs.IntList()
        local moves = sgs.CardsMoveList()
        for _, card_id in sgs.qlist(self:getSubcards()) do
            used_cards:append(card_id)
        end
        -- room:setTag("GuhuoType", self:getUserString())
        local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_USE, yuji:objectName(), "", "sfofl_longyin")
        local move = sgs.CardsMoveStruct(used_cards, yuji, nil, sgs.Player_PlaceUnknown, sgs.Player_PlaceTable, reason)
        moves:append(move)
        room:moveCardsAtomic(moves, true)
        local card = sgs.Sanguosha:getCard(self:getSubcards():first())
        local user_str = ""
        if to_guhuo == "slash" then
            if card:isKindOf("Slash") then
                user_str = card:objectName()
            else
                user_str = "slash"
            end
        elseif to_guhuo == "normal_slash" then
            user_str = "slash"
        else
            user_str = to_guhuo
        end
        local use_card = sgs.Sanguosha:cloneCard(user_str, card:getSuit(), card:getNumber())
        use_card:setSkillName("sfofl_longyin")
        use_card:addSubcards(self:getSubcards())
        use_card:deleteLater()
        local tos = card_use.to
        for _, to in sgs.qlist(tos) do
            local skill = room:isProhibited(yuji, to, use_card)
            if skill then
                card_use.to:removeOne(to)
            end
        end
        room:addPlayerMark(yuji, "sfofl_longyin-Clear")
        return use_card
    end,
    on_validate_in_response = function(self, yuji)
        local room = yuji:getRoom()
        local to_guhuo = ""
        if self:getUserString() == "peach+analeptic" then
            local guhuo_list = {}
            table.insert(guhuo_list, "peach")
            local sts = sgs.GetConfig("BanPackages", "")
            if not string.find(sts, "maneuvering") then
                table.insert(guhuo_list, "analeptic")
            end
            to_guhuo = room:askForChoice(yuji, "guhuo_saveself", table.concat(guhuo_list, "+"))
        elseif self:getUserString() == "slash" then
            local guhuo_list = {}
            table.insert(guhuo_list, "slash")
            local sts = sgs.GetConfig("BanPackages", "")
            if not string.find(sts, "maneuvering") then
                table.insert(guhuo_list, "normal_slash")
                table.insert(guhuo_list, "thunder_slash")
                table.insert(guhuo_list, "fire_slash")
            end
            to_guhuo = room:askForChoice(yuji, "guhuo_slash", table.concat(guhuo_list, "+"))
        else
            to_guhuo = self:getUserString()
        end
        if to_guhuo == "" then
            return nil
        end
        local used_cards = sgs.IntList()
        local moves = sgs.CardsMoveList()
        for _, card_id in sgs.qlist(self:getSubcards()) do
            used_cards:append(card_id)
        end
        -- room:setTag("GuhuoType", self:getUserString())
        local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_USE, yuji:objectName(), "", "sfofl_longyin")
        local move = sgs.CardsMoveStruct(used_cards, yuji, nil, sgs.Player_PlaceUnknown, sgs.Player_PlaceTable, reason)
        moves:append(move)
        room:moveCardsAtomic(moves, true)
        local card = sgs.Sanguosha:getCard(self:getSubcards():first())
        local user_str = ""
        if to_guhuo == "slash" then
            if card:isKindOf("Slash") then
                user_str = card:objectName()
            else
                user_str = "slash"
            end
        elseif to_guhuo == "normal_slash" then
            user_str = "slash"
        else
            user_str = to_guhuo
        end
        local use_card = sgs.Sanguosha:cloneCard(user_str, card:getSuit(), card:getNumber())
        use_card:setSkillName("sfofl_longyin")
        use_card:addSubcards(self:getSubcards())
        use_card:deleteLater()
        room:addPlayerMark(yuji, "sfofl_longyin-Clear")
        return use_card
    end
}
sfofl_longyin = sgs.CreateViewAsSkill {
    name = "sfofl_longyin",
    response_or_use = true,
    n = 999,
	view_filter = function(self, selected, to_select)
		if #selected > 0 then
            local x = 0
			for _,card in ipairs(selected) do
               x = card:getNumber()
            end
            return to_select:getNumber() + x <= 13
		end
		return true
	end,
	view_as = function(self, cards)
		if #cards > 0 then
            local x = 0
            for _, c in ipairs(cards) do
				x = x + c:getNumber()
			end
            if x ~= 13 then return nil end
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE or
            sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
            local card = sfofl_longyinCard:clone()
            card:setUserString(sgs.Sanguosha:getCurrentCardUsePattern())
            for _, c in ipairs(cards) do
                card:addSubcard(c)
            end
            return card
        end
        local c = sgs.Self:getTag("sfofl_longyin"):toCard()
        if c then
            local card = sfofl_longyinCard:clone()
            card:setUserString(c:objectName())
            for _, c in ipairs(cards) do
                card:addSubcard(c)
            end
            return card
        else
            return nil
        end
    end
    end,
    enabled_at_nullification = function(self, player)
        local current = player:getRoom():getCurrent()
        if not current or current:isDead() or current:getPhase() == sgs.Player_NotActive then
            return false
        end
        return player:getMark("sfofl_longyin-Clear") == 0
    end,
    enabled_at_response = function(self, player, pattern)
        if player:getMark("sfofl_longyin-Clear") > 0 then return false end
        local current = false
        local players = player:getAliveSiblings()
        players:append(player)
        for _, p in sgs.qlist(players) do
            if p:getPhase() ~= sgs.Player_NotActive then
                current = true
                break
            end
        end
        if not current then
            return false
        end
        if string.sub(pattern, 1, 1) == "." or string.sub(pattern, 1, 1) == "@" then
            return false
        end
        if pattern == "peach" and player:getMark("Global_PreventPeach") > 0 then
            return false
        end
        return true
    end,
    enabled_at_play = function(self, player)
        return player:getMark("sfofl_longyin-Clear") == 0
    end,
}
sfofl_longyin_use = sgs.CreateTriggerSkill{
    name = "#sfofl_longyin_use",
    events = {sgs.CardUsed, sgs.CardResponded},
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local card
        if event == sgs.CardUsed then
            card = data:toCardUse().card
        else
            card = data:toCardResponse().m_card
        end
        if card and table.contains(card:getSkillNames(), "sfofl_longyin") then
            room:addPlayerMark(player, "sfofl_longyin-Clear")
        end
    end
}
sfofl_longyin:setGuhuoDialog("lr")



sfofl_3_zhugeliang:addSkill("super_guanxing")
sfofl_3_zhugeliang:addSkill(sfofl_longyin)
sfofl_3_zhugeliang:addSkill(sfofl_longyin_use)
extension_s:insertRelatedSkills("sfofl_longyin", "#sfofl_longyin_use")

sfofl_2_lvbu = sgs.General(extension_s, "sfofl_2_lvbu", "qun", 5)
--[[
	技能名：无双
	相关武将：吕布[官盗]
	技能描述：锁定技，当你使用【杀】指定目标后，其使用【闪】抵消此【杀】的方式改为需连续使用两张【闪】；当你使用【决斗】指定目标后，或当你成为【决斗】的目标后，你令其打出【杀】响应此【决斗】的方式改为需连续打出两张【杀】。<br>" ..
  "二级：增加效果：当其他角色弃置的【决斗】进入弃牌堆后，你获得之。<br>" ..
  "三级：增加效果：你使用【杀】伤害基数值+1，目标角色每使用一张【闪】进行响应，此【杀】对其造成的伤害-1。
	引用：sfofl_wushuang
]] --

sfofl_wushuang = sgs.CreateTriggerSkill {
	name = "sfofl_wushuang",
	events = { sgs.TargetSpecified, sgs.CardEffected, sgs.CardResponded, sgs.ConfirmDamage, sgs.CardUsed, sgs.CardsMoveOneTime },
	frequency = sgs.Skill_Compulsory,
	can_trigger = function(self, target)
		return target and target:isAlive()
	end,
	on_trigger = function(self, event, player, data, room)
        if event == sgs.TargetSpecified then
            local use = data:toCardUse()
            if use.card:isKindOf("Duel") then
                local wushuang = {}
                if player:hasSkill(self:objectName()) then
                    for _, p in sgs.qlist(use.to) do
                        table.insert(wushuang, p:objectName())
                    end
                end
                for _, p in sgs.qlist(use.to) do
                    if p:hasSkill(self:objectName()) then
                        table.insert(wushuang, player:objectName())
                    end
                end
                room:setTag("sfofl_wushuang_"..use.card:toString(), sgs.QVariant(table.concat(wushuang, "+")))
            elseif use.card:isKindOf("Slash") and player:hasSkill(self:objectName()) then
                local jink_table = sgs.QList2Table(player:getTag("Jink_" .. use.card:toString()):toIntList())
                local index = 1
                for _, p in sgs.qlist(use.to) do
                    jink_table[index] = jink_table[index] + 1
                    index = index + 1
                end
                local jink_data = sgs.QVariant()
                jink_data:setValue(Table2IntList(jink_table))
                player:setTag("Jink_" .. use.card:toString(), jink_data)
            end
        elseif event == sgs.CardEffected then
            local effect = data:toCardEffect()
            if effect.card:isKindOf("Duel") then
                local wushuang = room:getTag("sfofl_wushuang_" .. effect.card:toString()):toString()
                if wushuang and wushuang ~= "" then
                    if string.find(wushuang, effect.to:objectName()) or string.find(wushuang, effect.from:objectName()) then
                        room:setTag("sfofl_wushuangData", data)
                    end
                end
            end
        elseif event == sgs.CardResponded then
            local resp = data:toCardResponse()
            if resp.m_toCard and resp.m_toCard:isKindOf("Duel") and not player:hasFlag("sfofl_wushuangSlash") then
                local wushuang = room:getTag("sfofl_wushuang_" .. resp.m_toCard:toString()):toString()
                if wushuang and wushuang ~= "" then
                    if string.find(wushuang, player:objectName()) then
                        room:setPlayerFlag(player,"sfofl_wushuangSlash")
                        if not room:askForCard(player, "slash", "duel-slash:"..resp.m_who:objectName(), room:getTag("sfofl_wushuangData"), sgs.Card_MethodResponse, resp.m_who, false, "",false,resp.m_toCard) then
                            resp.nullified = true
                            data:setValue(resp)
                        end
                        room:setPlayerFlag(player,"-sfofl_wushuangSlash")
                    end
                end
            end
        elseif event == sgs.CardUsed then
            local use = data:toCardUse()
            if use.card:isKindOf("Jink") and use.whocard then
                room:setCardFlag(use.whocard, "sfofl_wushuang"..player:objectName())
            end
        elseif event == sgs.ConfirmDamage then
            local damage = data:toDamage()
            if damage.card and damage.card:isKindOf("Slash") and player:hasSkill(self:objectName()) and player:getMark("sfofl_xiuluo") > 1 and not damage.card:hasFlag("sfofl_wushuang"..damage.to:objectName()) then
                damage.damage = damage.damage + 1
                local log = sgs.LogMessage()
                log.type = "#skill_add_damage"
                log.from = damage.from
                log.to:append(damage.to)
                log.arg  = self:objectName()
                log.arg2 = damage.damage
                room:sendLog(log)
            end
        elseif event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            if move.from and (move.from:objectName() ~= player:objectName() and player:getMark("sfofl_xiuluo") > 0 and player:hasSkill(self:objectName())) and (move.to_place == sgs.Player_DiscardPile) and (move.from_places:contains(sgs.Player_PlaceHand)) and bit32.band(move.reason.m_reason,sgs.CardMoveReason_S_MASK_BASIC_REASON)==sgs.CardMoveReason_S_REASON_DISCARD then
                local dc = dummyCard()
                for _, id in sgs.qlist(move.card_ids) do
                    if sgs.Sanguosha:getCard(id):isKindOf("Duel") and room:getCardPlace(id) == sgs.Player_DiscardPile then
                        dc:addSubcard(id)
                    end
                end
                if dc:subcardsLength() > 0 then
                    room:obtainCard(player, dc, false)
                end
            end
        end
    end,
}
    
--[[
	技能名：修罗
	相关武将：吕布[官盗]
	技能描述：当你杀死一名角色后，你可以减1点体力上限，修改〖无双〗。
	引用：sfofl_xiuluo
]] --

sfofl_xiuluo = sgs.CreateTriggerSkill {
	name = "sfofl_xiuluo",
	events = { sgs.BuryVictim },
	frequency = sgs.Skill_Frequent,
	priority = -2,
	can_trigger = function(target)
		return target
	end,
	on_trigger = function(self, event, player, data)
		local death = data:toDeath()
		local room = player:getRoom()
		if death.damage and death.damage.from and death.damage.from:hasSkill(self:objectName()) and death.damage.from:getMark("sfofl_xiuluo") < 2 then
			if death.damage.from:askForSkillInvoke(self:objectName(), data) then
                room:broadcastSkillInvoke(self:objectName())
                room:loseMaxHp(death.damage.from)
                room:addPlayerMark(death.damage.from, "sfofl_xiuluo")
                room:changeTranslation(death.damage.from, "sfofl_wushuang", death.damage.from:getMark("sfofl_xiuluo"))
            end
		end
		return false
	end,
}

sfofl_2_lvbu:addSkill(sfofl_wushuang)
sfofl_2_lvbu:addSkill(sfofl_xiuluo)

sfofl_zhugedan = sgs.General(extension_s, "sfofl_zhugedan", "wei", 4)

--[[
	技能名：举义
	相关武将：诸葛诞[官盗]
	技能描述：觉醒技，准备阶段，若你已受伤且体力上限大于存活角色数，你摸等同于你体力上限数量的牌，然后获得“崩坏”。
	引用：sfofl_juyi
]] --
sfofl_juyi = sgs.CreateTriggerSkill{
	name = "sfofl_juyi",
	frequency = sgs.Skill_Wake,
	events = {sgs.EventPhaseStart},
	waked_skills = "benghuai",
	can_trigger = function(self,target)
	   	return target and target:getPhase()==sgs.Player_Start
	   	and target:getMark(self:objectName())<1 and target:hasSkill(self)
	end,
	on_trigger = function(self,event,player,data,room)
	  	if (player:getMaxHp() > player:aliveCount()) then
			local log = sgs.LogMessage()
			log.type = "#JuyiWake"
			log.from = player
			log.arg = player:getMaxHp()
			log.arg2 = player:aliveCount()
			log.arg3 = self:objectName();
			room:sendLog(log)
		elseif (not player:canWake(self:objectName())) then
			return false
        end
		player:peiyin(self:objectName());
		room:notifySkillInvoked(player, self:objectName());
		room:doSuperLightbox(player, "oljuyi")

		room:setPlayerMark(player, "sfofl_juyi", 1)
		if (room:changeMaxHpForAwakenSkill(player, 0, self:objectName())) then
			room:drawCards(player, player:getMaxHp(), self:objectName());
			room:handleAcquireDetachSkills(player, "benghuai");
        end
		return false;
	end
}

sfofl_zhugedan:addSkill("gongao")
sfofl_zhugedan:addSkill("weizhong")
sfofl_zhugedan:addSkill(sfofl_juyi)

sfofl_zhenji = sgs.General(extension_s, "sfofl_zhenji", "wei", 3, false)

--[[
	技能名：洛神
	相关武将：甄姬[官盗]
	技能描述：准备阶段，你可以判定，并获得生效后的判定牌，然后若你本次以此法获得的牌颜色均相同，你可以重复此流程。
	引用：sfofl_luoshen
]] --
sfofl_luoshen = sgs.CreateTriggerSkill{
	name = "sfofl_luoshen",
	frequency = sgs.Skill_Frequent,
	events = {sgs.EventPhaseStart, sgs.FinishJudge},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.EventPhaseStart then
			if player:getPhase() == sgs.Player_Start then
                local colour = ".|."
				while player:askForSkillInvoke(self:objectName()) do
					local judge = sgs.JudgeStruct()
					judge.pattern = colour
					judge.good = true
					judge.reason = self:objectName()
					judge.who = player
					judge.time_consuming = true
					room:judge(judge)
					if judge:isBad() then
						break
                    else
                        colour = ".|"..judge.card:getColorString()
					end
				end
			end
		elseif event == sgs.FinishJudge then
			local judge = data:toJudge()
			if judge.reason == self:objectName() then
				local card = judge.card
				if judge:isGood() then
					player:obtainCard(card)
					return true
				end
			end
		end
		return false
	end
}

sfofl_zhenji:addSkill("qingguo")
sfofl_zhenji:addSkill(sfofl_luoshen)

sfofl_sp_jiaxu = sgs.General(extension_s, "sfofl_sp_jiaxu", "wei", 3)

--[[
	技能名：间书
	相关武将：贾诩[官盗]
	技能描述：出牌阶段限一次，你可以将一张手牌交给一名其他角色，然后选择另一名其他角色，令这两名角色拼点：没赢的角色失去1点体力。
	引用：sfofl_2_jianshu
]] --
sfofl_2_jianshuCard = sgs.CreateSkillCard{
    name = "sfofl_2_jianshu",
    will_throw = false,
    on_effect = function(self,effect)
        local from,to = effect.from,effect.to
        local room = from:getRoom()
        room:giveCard(from,to,self,"sfofl_2_jianshu")
        
        if from:isDead() then return end
        local targets = room:getOtherPlayers(from)
        if targets:contains(to) then
            targets:removeOne(to)
        end
        if targets:isEmpty() then return end
        
        local other = room:askForPlayerChosen(from,targets,self:objectName(),"@sfofl_2_jianshu-pindian:"..to:objectName())
        room:doAnimate(1,to:objectName(),other:objectName())
        if not to:canPindian(other,false) then return end
        
        local n = to:pindianInt(other,self:objectName())
        if n < -1 then return end
        
        local losers,winner = sgs.SPlayerList(),nil
        if n == -1 then
            winner = other
            losers:append(to)
        elseif n == 1 then
            winner = to
            losers:append(other)
        elseif n == 0 then
            losers:append(to)
            losers:append(other)
        end

        room:sortByActionOrder(losers)
        for _,p in sgs.qlist(losers)do
            room:loseHp(sgs.HpLostStruct(p,1,"sfofl_2_jianshu",from))
        end
    end
}

sfofl_2_jianshu = sgs.CreateOneCardViewAsSkill{
    name = "sfofl_2_jianshu",
    filter_pattern = ".|.|.|hand",
    view_as = function(self,card)
        local c = sfofl_2_jianshuCard:clone()
        c:addSubcard(card)
        return c
    end,
    enabled_at_play = function(self,player)
        return not player:hasUsed("#sfofl_2_jianshu")
    end
}
sfofl_sp_jiaxu:addSkill("zhenlve")
sfofl_sp_jiaxu:addSkill(sfofl_2_jianshu)
sfofl_sp_jiaxu:addSkill("yongdi")

sfofl_shenjiangwei = sgs.General(extension_s, "sfofl_shenjiangwei", "god", 4)
--[[
	技能名：九伐
	相关武将：神姜维[官盗]
	技能描述：当你使用或打出的牌结算完成后，若你的武将牌上没有与之牌名相同的牌，你可以将这些牌置于你的武将牌上。此时若你以此法置于武将牌上的牌中包括至少九种牌名，你移去这些牌，然后展示牌堆顶的九张牌，获得其中点数重复的牌各一张。
	引用：sfofl_jiufa
]] --
sfofl_jiufa = sgs.CreateTriggerSkill{
    name = "sfofl_jiufa",
	frequency = sgs.Skill_NotFrequent,
	events = {sgs.CardFinished, sgs.CardResponded},
	on_trigger = function(self, event, player, data)
	    local room = player:getRoom()
		local card = nil
		if event == sgs.CardFinished then
			card = data:toCardUse().card
        elseif event == sgs.CardResponded then
			local response = data:toCardResponse()
			card = response.m_card
		end
		if card and not card:isKindOf("SkillCard") and not (card:isVirtualCard() and card:subcardsLength() == 0) then
            for _, id in sgs.qlist(player:getPile(self:objectName())) do
                local c = sgs.Sanguosha:getCard(id)
                if c:objectName() == card:objectName() then
                    return
                end
            end
            if room:askForSkillInvoke(player, self:objectName(), ToData(card)) then
                room:broadcastSkillInvoke(self:objectName())
                player:addToPile(self:objectName(), card)
            end
			if player:getPile(self:objectName()):length() < 9 then return false end
            room:sendCompulsoryTriggerLog(player, self:objectName())
            room:broadcastSkillInvoke(self:objectName())
            local dummy = sgs.Sanguosha:cloneCard("slash")
            dummy:addSubcards(player:getPile(self:objectName()))
            dummy:deleteLater()
            local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_REMOVE_FROM_PILE, "", self:objectName(), "")
            room:throwCard(dummy, reason, nil)
            
            local card_ids = room:showDrawPile(player, 9, self:objectName())
            local numbers = {}
            local duplicatenumbers = {}
            for _, id in sgs.qlist(card_ids) do
                local c = sgs.Sanguosha:getCard(id)
                if not table.contains(numbers, c:getNumberString()) then
                    table.insert(numbers, c:getNumberString())
                else
                    if not table.contains(duplicatenumbers, c:getNumberString()) then
                        table.insert(duplicatenumbers, c:getNumberString())
                    end
                end
            end
            if #duplicatenumbers > 0 then
                local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                dummy:deleteLater()
                for _, num in ipairs(duplicatenumbers) do
                    local to_get = sgs.IntList()
                    local card_ids_discard = sgs.IntList()
                    for _, id in sgs.qlist(card_ids) do
                        local c = sgs.Sanguosha:getCard(id)
                        if c:getNumberString() == num then
                            to_get:append(id)
                        else
                            card_ids_discard:append(id)
                        end
                    end
                    if to_get:length() > 0 then
                        room:fillAG(card_ids, player, card_ids_discard)
                        local card_id = room:askForAG(player, to_get, false, self:objectName(), "@sfofl_jiufa:"..num)
                        dummy:addSubcard(card_id)
                        room:clearAG()
                    end
                    
                end
                player:obtainCard(dummy)
            end
		end
	end,
}

sfofl_jiufa_pingxiang = sgs.CreateTriggerSkill{
	name = "#sfofl_jiufa_pingxiang",
	events = {sgs.MarkChanged, sgs.EventLoseSkill},
	on_trigger = function(self,event,player,data)
	    local room = player:getRoom()
		if event == sgs.MarkChanged then
			local mark = data:toMark()
			if mark.name == "&pingxiangmax" then
			    if player:getMark(mark.name) > 0 then
				    room:detachSkillFromPlayer(player,"sfofl_jiufa")
				end
			end
		end
        if event == sgs.EventLoseSkill and data:toString() == "sfofl_jiufa" then
            player:clearOnePrivatePile("sfofl_jiufa")
        end
	end,
}

sfofl_shenjiangwei:addSkill("tianren")
sfofl_shenjiangwei:addSkill(sfofl_jiufa)
sfofl_shenjiangwei:addSkill(sfofl_jiufa_pingxiang)
sfofl_shenjiangwei:addSkill("pingxiang")
extension_s:insertRelatedSkills("sfofl_jiufa", "#sfofl_jiufa_pingxiang")




--解禁包：线下神马超（Ny神的单品）
undershoulistart = sgs.CreateTriggerSkill{
    name = "undershoulistart",
	global = true,
    events = {sgs.GameStart},
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local nextp = player:getNextAlive()
        local cards = sgs.IntList()
		for _,id in sgs.qlist(sgs.Sanguosha:getRandomCards(true)) do
			if sgs.Sanguosha:getEngineCard(id):objectName() == "_horsede" or sgs.Sanguosha:getEngineCard(id):objectName() == "_horseof" then
				cards:append(id)
			end
		end
        room:sendCompulsoryTriggerLog(player, "undershouli")
        room:broadcastSkillInvoke("undershouli")
        while(true) do
            if not room:askForUseCard(nextp, "Horse", "@undershouli") then
                for _,id in sgs.qlist(cards) do
                    if nextp:canUse(sgs.Sanguosha:getEngineCard(id), nextp, true) then
                        cards:removeOne(id)
                        local use = sgs.CardUseStruct(sgs.Sanguosha:getEngineCard(id), nextp, nextp)
                        room:useCard(use)
                        break
                    end
                end
            end
            room:setPlayerMark(nextp, "shouliget", 1)
            nextp = nextp:getNextAlive()
            if nextp:getMark("shouliget") > 0 then break end
        end

    end,
    can_trigger = function(self, target)
        return target and target:hasSkill("undershouli")
    end,
}
undershouli = sgs.CreateViewAsSkill
{
    name = "undershouli",
    n = 1,
    expand_pile = "/Horse/undershouli",
    view_filter = function(self, selected, to_select)
        if sgs.Self:getHandcards():contains(to_select) then return false end
        if #selected >= 1 then return false end
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
            if (not to_select:isKindOf("OffensiveHorse")) then return false end
            local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
            slash:setSkillName("undershouli")
            slash:addSubcard(to_select)
            slash:deleteLater()
            return not sgs.Self:isLocked(slash)
        else
            local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
            if pattern == "slash" then
                if (not to_select:isKindOf("OffensiveHorse")) then return false end
                local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
                slash:setSkillName("undershouli")
                slash:addSubcard(to_select)
                slash:deleteLater()
                return not sgs.Self:isCardLimited(slash, sgs.Card_MethodResponse)
            elseif pattern == "jink" then
                if (not to_select:isKindOf("DefensiveHorse")) then return false end
                local method = nil
                if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
                    method = sgs.Card_MethodUse
                elseif sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE then
                    method = sgs.Card_MethodResponse
                end
                local jink = sgs.Sanguosha:cloneCard("jink", sgs.Card_SuitToBeDecided, -1)
                jink:setSkillName("undershouli")
                jink:addSubcard(to_select)
                jink:deleteLater()
                return not sgs.Self:isCardLimited(jink, method)
            end
        end
    end,
    view_as = function(self,cards)
        if #cards == 0 then return nil end
        local card = undershouliCard:clone()
        for _,c in ipairs(cards) do
            card:addSubcard(c)
        end
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
            card:setUserString("slash")
            return card
        end
        local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
        card:setUserString(pattern)
        return card
    end,
    enabled_at_play = function(self, player)
        local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
        slash:setSkillName("undershouli")
        slash:deleteLater()
        return slash:isAvailable(player)
    end,
    enabled_at_response = function(self, player, pattern)
        return pattern == "slash" or pattern == "jink"
    end,
}
undershouliCard = sgs.CreateSkillCard
{
    name = "undershouli",
    filter = function(self, targets, to_select, player)
        local qtargets = sgs.PlayerList()
        for _,p in ipairs(targets) do
            qtargets:append(p)
        end
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
            local card, user_string = nil, self:getUserString()
            if user_string ~= "" then
                card = sgs.Sanguosha:cloneCard(user_string:split("+")[1])
                card:setSkillName("undershouli")
            end
            return card and card:targetFilter(qtargets, to_select, player) and not player:isProhibited(to_select, card, qtargets)
        end
    
        local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
        slash:setSkillName("undershouli")
        
        for _,id in sgs.qlist(self:getSubcards()) do
            slash:addSubcard(sgs.Sanguosha:getCard(id))
        end

        slash:deleteLater()
        return slash and slash:targetFilter(qtargets, to_select, player) and not player:isProhibited(to_select, slash, qtargets)
    end,
    feasible = function(self, targets, player)
        --[[local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
        slash:setSkillName("undershouli")
        for _,id in sgs.qlist(self:getSubcards()) do
            slash:addSubcard(sgs.Sanguosha:getCard(id))
        end
        slash:deleteLater()]]--

        local user_string = self:getUserString()
        local use_card = sgs.Sanguosha:cloneCard(user_string, sgs.Card_SuitToBeDecided, -1)
        use_card:setSkillName("undershouli")
        for _,id in sgs.qlist(self:getSubcards()) do
            use_card:addSubcard(sgs.Sanguosha:getCard(id))
        end

        local qtargets = sgs.PlayerList()
        for _,p in ipairs(targets) do
            qtargets:append(p)
        end
        return use_card and use_card:targetsFeasible(qtargets, player)
    end,
    on_validate = function(self, cardUse)
        local source = cardUse.from
        local room = source:getRoom()
        
        local owner = nil
        for _,id in sgs.qlist(self:getSubcards()) do
            owner = room:getCardOwner(id)
        end
        room:setPlayerMark(owner, "&undershouli-Clear", 1)
        room:setPlayerMark(source, "&undershouli-Clear", 1)
        if owner:objectName() ~= source:objectName() then
            room:addPlayerMark(owner, "@skill_invalidity")
        end

        local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
        slash:setSkillName("undershouli")
        for _,id in sgs.qlist(self:getSubcards()) do
            slash:addSubcard(sgs.Sanguosha:getCard(id))
        end
        room:setCardFlag(slash, "RemoveFromHistory")
        return slash
    end,
    on_validate_in_response = function(self, source)
        local room = source:getRoom()

        local owner = nil
        for _,id in sgs.qlist(self:getSubcards()) do
            owner = room:getCardOwner(id)
        end
        room:setPlayerMark(owner, "&undershouli-Clear", 1)
        room:setPlayerMark(source, "&undershouli-Clear", 1)
        if owner:objectName() ~= source:objectName() then
            room:addPlayerMark(owner, "@skill_invalidity")
        end

        local user_string = sgs.Sanguosha:getCurrentCardUsePattern()
        local use_card = sgs.Sanguosha:cloneCard(user_string, sgs.Card_SuitToBeDecided, -1)
        use_card:setSkillName("undershouli")
        for _,id in sgs.qlist(self:getSubcards()) do
            use_card:addSubcard(sgs.Sanguosha:getCard(id))
        end
        return use_card
    end,
}
undershoulibuff = sgs.CreateTriggerSkill{
    name = "undershoulibuff",
	global = true,
    events = {sgs.DamageInflicted},
    frequency = sgs.Skill_NotFrequent,
    priority = 4,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local da = data:toDamage()

        local log = sgs.LogMessage()
        log.type = "$undershoulida"
        log.arg = player:getGeneralName()
        log.arg2 = "undershouli"
        log.arg3 = da.damage
        log.arg4 = da.damage + 1
        room:sendLog(log)
        da.damage = da.damage + 1
        da.nature = sgs.DamageStruct_Thunder
        data:setValue(da)
    end,
    can_trigger = function(self, target)
        return target and target:getMark("&undershouli-Clear") > 0
    end,
}
undershouliClear = sgs.CreateTriggerSkill{
    name = "undershouliClear",
	global = true,
    events = {sgs.EventPhaseChanging},
    frequency = sgs.Skill_NotFrequent,
    priority = 10,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local change = data:toPhaseChange()
        if change.to ~= sgs.Player_NotActive then return false end
        for _,p in sgs.qlist(room:getAlivePlayers()) do
            if p:getMark("&undershouli-Clear") > 0 then
                room:removePlayerMark(p, "@skill_invalidity")
                room:setPlayerMark(p, "&undershouli-Clear", 0)
            end
        end
    end,
    can_trigger = function(self, target)
        return target 
    end,
}
underhengwu = sgs.CreateTriggerSkill{
    name = "underhengwu",
    events = {sgs.CardUsed,sgs.CardResponded},
    frequency = sgs.Skill_NotFrequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local card = nil
        if event == sgs.CardUsed then
            card = data:toCardUse().card
        elseif event == sgs.CardResponded then
            card = data:toCardResponse().m_card
        end
        local suit = card:getSuitString()
        if card:isKindOf("SkillCard") then return false end
        local n = 0
        for _,p in sgs.qlist(room:getAlivePlayers()) do
            if p:getEquips():length() > 0 then
                for _,cc in sgs.qlist(p:getEquips()) do
                    if cc:getSuitString() == suit then
                        n = n + 1
                    end
                end
            end
        end
        if n == 0 then return false end
        if not room:askForSkillInvoke(player, self:objectName(), data) then return false end
        room:broadcastSkillInvoke(self:objectName())
        local prompt = string.format("@underhengwu:%s::%s:",suit,n)
        local pattern = ".|"..suit.."|.|."

        player:setTag("underhengwu", sgs.QVariant(suit))--ai

        local dis = room:askForDiscard(player, self:objectName(), 999, 0, true, true, prompt, pattern)
        if dis then
            player:drawCards(n+dis:subcardsLength())
        else
            player:drawCards(n)
        end
    end,
    can_trigger = function(self, target)
        return target and target:hasSkill(self:objectName())
    end,
}
if not sgs.Sanguosha:getSkill("undershouli") then skills:append(undershouli) end
if not sgs.Sanguosha:getSkill("undershoulistart") then skills:append(undershoulistart) end
if not sgs.Sanguosha:getSkill("undershoulibuff") then skills:append(undershoulibuff) end
if not sgs.Sanguosha:getSkill("undershouliClear") then skills:append(undershouliClear) end
if not sgs.Sanguosha:getSkill("underhengwu") then skills:append(underhengwu) end

--“狩骊”指示物：
for i = 1, 4, 1 do
    local horsede = sgs.Sanguosha:cloneCard("DefensiveHorse", i-1, i)
    horsede:setObjectName("_horsede")
    horsede:setParent(extension_card)
    local horseof = sgs.Sanguosha:cloneCard("OffensiveHorse", i-1, i)
    horseof:setObjectName("_horseof")
    horseof:setParent(extension_card)
end

sfofl_2_shenmachao = sgs.General(extension_s, "sfofl_2_shenmachao", "god", 4, true, true)
sfofl_2_shenmachao:addSkill("undershouli")
sfofl_2_shenmachao:addSkill("underhengwu")









sfofl_zhonghui = sgs.General(extension_e, "sfofl_zhonghui$", "wei", 4, true)
--[[
	技能名：谋川
	相关武将：钟会[官盗]
	技能描述：每轮开始时，你可以摸两张牌并交给一名其他角色一张牌，然后你与其依次展示一张手牌，若颜色：相同，你本轮获得技能“道合”；不同，你本轮获得技能“志异”。
	引用：sfofl_mouchuan
]] --
sfofl_mouchuan = sgs.CreateTriggerSkill{
    name = "sfofl_mouchuan",
    events = {sgs.RoundStart, sgs.RoundEnd},
    on_trigger = function(self, event, player, data, room)
        if event == sgs.RoundStart then
            if room:askForSkillInvoke(player, self:objectName()) then
                player:drawCards(2)
                if player:isKongcheng() then return false end
                local target = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName())
                local give = room:askForExchange(player, self:objectName(), 1, 1, false, "@sfofl_mouchuan:" .. target:objectName(), false)
                local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_GIVE, target:objectName(), player:objectName(), self:objectName(), nil)
                reason.m_playerId = player:objectName()
                room:moveCardTo(give, player, target, sgs.Player_PlaceHand, reason)
                if player:isKongcheng() or target:isKongcheng() then return false end
                local card = room:askForCardShow(player, target, self:objectName())
                local acard = room:askForCardShow(target, player, self:objectName())
                room:showCard(player, card:getEffectiveId())
                room:showCard(target, acard:getEffectiveId())
                if card:sameColorWith(acard) then
                    room:addPlayerMark(player, "sfofl_daohe_lun")
                    room:handleAcquireDetachSkills(player, "sfofl_daohe")
                else
                    room:addPlayerMark(player, "sfofl_zhiyiz_lun")
                    room:handleAcquireDetachSkills(player, "sfofl_zhiyiz")
                end
            end
        elseif event == sgs.RoundEnd then
            if player:getMark("sfofl_daohe_lun") > 0 then
                room:handleAcquireDetachSkills(player, "-sfofl_daohe")
            end
            if player:getMark("sfofl_zhiyiz_lun") > 0 then
                room:handleAcquireDetachSkills(player, "-sfofl_zhiyiz")
            end
        end
    end,
}

--[[
	技能名：自重
	相关武将：钟会[官盗]
	技能描述：锁定技，当你使用或打出一张你本轮未使用过的非装备牌时，你摸X-2张牌；你的手牌上限+X。（X为你的技能数）
	引用：sfofl_zizhong
    貌似原意是不算主公技的
]] --
sfofl_zizhong = sgs.CreateTriggerSkill{
    name = "sfofl_zizhong",
    events = {sgs.CardUsed, sgs.CardResponded},
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local card
        if event == sgs.CardUsed then
            card = data:toCardUse().card
        else
            card = data:toCardResponse().m_card
        end
        if card:isKindOf("SkillCard") or card:isKindOf("EquipCard") then return false end
        if player:getMark("sfofl_zizhong:"..card:objectName().."_lun") > 0 then return false end
        if card:getHandlingMethod() == sgs.Card_MethodUse then
            room:addPlayerMark(player, "sfofl_zizhong:"..card:objectName().."_lun")
        end
        local x = 0
        for _,skill in sgs.qlist(player:getVisibleSkillList()) do
			if skill:isAttachedLordSkill() then continue end
            if (skill:isLordSkill() and not player:hasLordSkill(skill)) then continue end
			x = x + 1
		end
        player:drawCards(x-2)
    end
}
sfofl_zizhong_cardmax = sgs.CreateMaxCardsSkill {
	name = "#sfofl_zizhong_cardmax",
	extra_func = function(self, target)
		if target:hasSkill("sfofl_zizhong") then
            local x = 0
            for _,skill in sgs.qlist(target:getVisibleSkillList()) do
                if skill:isAttachedLordSkill() then continue end
                if (skill:isLordSkill() and not target:hasLordSkill(skill)) then continue end
                x = x + 1
            end
			local y = math.max(0, x-2)
			return y
		end
        return 0
	end
}
--[[
	技能名：极尊
	相关武将：钟会[官盗]
	技能描述：觉醒技，当你脱离濒死状态时，你获得技能〖清算〗；若你已拥有〖清算〗，则改为回复体力至体力上限。
	引用：sfofl_jizun
]] --
sfofl_jizun = sgs.CreateTriggerSkill{
    name = "sfofl_jizun",
    frequency = sgs.Skill_Wake,
    events = {sgs.QuitDying},
    waked_skills = "sfofl_qingsuan",
    on_trigger = function(self, event, player, data, room)
        if player:getMark(self:objectName()) == 0 then
            room:sendCompulsoryTriggerLog(player, self:objectName(), true, true)
            room:addPlayerMark(player, self:objectName())
            if player:hasLordSkill("sfofl_qingsuan") then
                local recover = sgs.RecoverStruct()
                recover.recover = player:getMaxHp() - player:getHp()
                recover.who = player
                room:recover(player, recover)
            else
                room:handleAcquireDetachSkills(player, "-sfofl_qingsuan", false, true, false)
                room:handleAcquireDetachSkills(player, "sfofl_qingsuan", false, true, false)
            end
        end
        
        return false
    end
}

--[[
	技能名：清算
	相关武将：钟会[官盗]
	技能描述：主公技，锁定技，你对与你势力不同且本局游戏对你造成过伤害的角色使用牌无距离和次数限制。
	引用：sfofl_qingsuan
]] --
sfofl_qingsuan_damage = sgs.CreateTriggerSkill{
    name = "#sfofl_qingsuan_damage",
    frequency = sgs.Skill_NotFrequent,
    events = {sgs.Damaged},
    on_trigger = function(self, event, player, data, room)
        local damage = data:toDamage()
        if damage.from and damage.from:isAlive() and damage.from:objectName() ~= player:objectName() then
            room:addPlayerMark(damage.from, "sfofl_qingsuan"..player:objectName())
            room:setPlayerMark(damage.from, "&sfofl_qingsuan+to+#"..player:objectName(), 1)
        end
    end
}
sfofl_qingsuan = sgs.CreateTargetModSkill {
	name = "sfofl_qingsuan$",
    residue_func = function(self, from, card, to)
        if from:hasLordSkill(self:objectName()) and to and from:getKingdom() ~= to:getKingdom() and to:getMark("sfofl_qingsuan"..from:objectName()) > 0 then
			return 999
		else
			return 0
		end
    end,
    distance_limit_func = function(self, from, card, to)
        if from:hasLordSkill(self:objectName()) and to and from:getKingdom() ~= to:getKingdom() and to:getMark("sfofl_qingsuan"..from:objectName()) > 0 then
			return 999
		else
			return 0
		end
    end,
}

--[[
	技能名：道合
	相关武将：钟会[官盗]
	技能描述：出牌阶段限一次，你可以令一名其他角色交给你至少一张手牌，然后其回复1点体力。
	引用：sfofl_daohe
]] --
sfofl_daoheCard = sgs.CreateSkillCard{
    name = "sfofl_daohe",
    will_throw = false,
    handling_method = sgs.Card_MethodNone,
    filter = function(self, targets, to_select)
        return #targets == 0 and not to_select:isKongcheng() and to_select:objectName() ~= sgs.Self:objectName()
    end,
    on_effect = function(self, effect)
        local source = effect.from
        local target = effect.to
        local room = source:getRoom()
        local give = room:askForExchange(target, self:objectName(), target:getHandcardNum(), 1, false, "@sfofl_daohe:" .. source:objectName(), false)
        local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_GIVE, target:objectName(), source:objectName(), self:objectName(), nil)
        reason.m_playerId = source:objectName()
        room:moveCardTo(give, target, source, sgs.Player_PlaceHand, reason)
        local recover = sgs.RecoverStruct()
        recover.who = source
        room:recover(target, recover, true)
    end
}
sfofl_daohe = sgs.CreateZeroCardViewAsSkill{
    name = "sfofl_daohe",
    view_as = function(self)
        local py = sfofl_daoheCard:clone()
        return py
    end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_daohe")
    end
}
--[[
	技能名：志异
	相关武将：钟会[官盗]
	技能描述：出牌阶段限一次，你可以令一名角色摸一张牌，然后你对其造成1点伤害。
	引用：sfofl_zhiyiz
]] --
sfofl_zhiyizCard = sgs.CreateSkillCard{
    name = "sfofl_zhiyiz",
    will_throw = false,
    handling_method = sgs.Card_MethodNone,
    filter = function(self, targets, to_select)
        return #targets == 0
    end,
    on_effect = function(self, effect)
        local source = effect.from
        local target = effect.to
        local room = source:getRoom()
        room:drawCards(target, 1, self:objectName())
        room:damage(sgs.DamageStruct(self:objectName(), source, target))
    end
}
sfofl_zhiyiz = sgs.CreateZeroCardViewAsSkill{
    name = "sfofl_zhiyiz",
    view_as = function(self)
        local py = sfofl_zhiyizCard:clone()
        return py
    end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_zhiyiz")
    end
}
sfofl_zhonghui:addSkill(sfofl_mouchuan)
sfofl_zhonghui:addSkill(sfofl_zizhong)
sfofl_zhonghui:addSkill(sfofl_zizhong_cardmax)
sfofl_zhonghui:addSkill(sfofl_jizun)
sfofl_zhonghui:addSkill(sfofl_qingsuan_damage)
sfofl_zhonghui:addSkill(sfofl_qingsuan)
extension_e:insertRelatedSkills("sfofl_qingsuan", "#sfofl_qingsuan_damage")
extension_e:insertRelatedSkills("sfofl_zizhong", "#sfofl_zizhong_cardmax")
if not sgs.Sanguosha:getSkill("sfofl_daohe") then skills:append(sfofl_daohe) end
if not sgs.Sanguosha:getSkill("sfofl_zhiyiz") then skills:append(sfofl_zhiyiz) end
sfofl_zhonghui:addRelateSkill("sfofl_daohe")
sfofl_zhonghui:addRelateSkill("sfofl_zhiyiz")


sfofl_young_blade_skill = sgs.CreateTriggerSkill{
    name = "sfofl_young_blade", --一般的话，技能的objectName()和武器的objectName(）用一样的名字
    frequency = sgs.Skill_Compulsory,
    events = { sgs.CardOffset },
    can_trigger = function(self, target)
        return target and target:hasWeapon(self:objectName())
    end,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local effect = data:toCardEffect()
        if effect.card and effect.card:isKindOf("Slash") then
            room:addSlashCishu(player, 1, true)
        end
        return false
    end
}
sfofl_young_blade = sgs.CreateWeapon{
    name = "sfofl_young_blade",
    class_name = "Blade",
    suit = sgs.Card_Spade,
    number = 5,
    range = 3,
    equip_skill = sfofl_young_blade_skill,
    on_install = function(self, player)
        local room = player:getRoom()
        local skill = sgs.Sanguosha:getSkill(self:objectName())
        if skill then
            if skill:inherits("ViewAsSkill") then
                room:attachSkillToPlayer(player, self:objectName())
            elseif skill:inherits("TriggerSkill") then
                local tirggerskill = sgs.Sanguosha:getTriggerSkill(self:objectName())
                room:getThread():addTriggerSkill(tirggerskill)
            end
        end
        end,
    on_uninstall = function(self, player) --卸下时移除技能
        local room = player:getRoom()
        local skill = sgs.Sanguosha:getSkill(self:objectName())
        if skill and skill:inherits("ViewAsSkill") then
            room:detachSkillFromPlayer(player, self:objectName(), true)
        end
    end,
}
sfofl_young_halberd_skill = sgs.CreateTargetModSkill {
	name = "sfofl_young_halberd",
	pattern = "Slash",
	extra_target_func = function(self,from,card)
		if from:hasWeapon(self:objectName()) then return 1 end
		return 0
	end,
}

sfofl_young_halberd = sgs.CreateWeapon{
    name = "sfofl_young_halberd",
    class_name = "Halberd",
    suit = sgs.Card_Diamond,
    number = 10,
    range = 4,
    equip_skill = sfofl_young_halberd_skill,
    on_install = function(self, player)
        local room = player:getRoom()
        local skill = sgs.Sanguosha:getSkill(self:objectName())
        if skill then
            if skill:inherits("ViewAsSkill") then
                room:attachSkillToPlayer(player, self:objectName())
            elseif skill:inherits("TriggerSkill") then
                local tirggerskill = sgs.Sanguosha:getTriggerSkill(self:objectName())
                room:getThread():addTriggerSkill(tirggerskill)
            end
        end
        end,
    on_uninstall = function(self, player) --卸下时移除技能
        local room = player:getRoom()
        local skill = sgs.Sanguosha:getSkill(self:objectName())
        if skill and skill:inherits("ViewAsSkill") then
            room:detachSkillFromPlayer(player, self:objectName(), true)
        end
    end,
}
sfofl_young_eight_diagram_skill = sgs.CreateTriggerSkill{
	name = "sfofl_young_eight_diagram",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.TargetConfirming, sgs.CardAsked},
	can_trigger = function(self,target)
		return target and target:hasArmorEffect(self:objectName())
	end,
	on_trigger = function(self,event,player,data,room)
    	if (event == sgs.TargetConfirming) then
			local use = data:toCardUse()
			if use.card and (use.card:isKindOf("Slash") or use.card:isKindOf("ArcheryAttack")) and use.to:contains(player) then
				if room:askForSkillInvoke(player, self:objectName(), data) then
                    local ids = sgs.IntList()
                    local id = room:getNCards(1):first()
                    -- ids:append(id)
                    -- local move = sgs.CardsMoveStruct()
                    -- move.card_ids = ids
                    -- move.to_place = sgs.Player_DiscardPile
                    -- move.reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_THROW, player:objectName(), self:objectName(),
                    --     nil)
                    -- room:moveCardsAtomic(move, true)
                    local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_THROW, player:objectName(), self:objectName(), nil)
					room:throwCard(sgs.Sanguosha:getCard(id), reason, player, nil)
                    if sgs.Sanguosha:getCard(id):isRed() then
                        room:setCardFlag(use.card, "sfofl_young_eight_diagram"..player:objectName())
                    end
                end
            end
        elseif event == sgs.CardAsked then
            local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
            if pattern == "jink" then
                local string = data:toStringList()[4]
                if not string then return end
                local tag = room:getTag("UseHistory"..string)
                if not tag then return end
                local use = tag:toCardUse()
                if not use then return end
                local usecard = use.card
                if not usecard or not usecard:hasFlag("sfofl_young_eight_diagram"..player:objectName()) then return end
                local jinkcard = sgs.Sanguosha:cloneCard("jink", sgs.Card_NoSuit, 0)
                jinkcard:setSkillName("sfofl_young_eight_diagram")
                room:provide(jinkcard)
                return true
            end
        end
	end
}

sfofl_young_eight_diagram = sgs.CreateArmor{
    name = "sfofl_young_eight_diagram",
    class_name = "EightDiagram",
    suit = sgs.Card_Spade,
    number = 2,
    equip_skill = sfofl_young_eight_diagram_skill,
    on_install = function(self,player)
        local room = player:getRoom()
        local skill = sgs.Sanguosha:getSkill(self:objectName())
        if skill then
            if skill:inherits("ViewAsSkill") then
                room:attachSkillToPlayer(player, self:objectName())
            elseif skill:inherits("TriggerSkill") then
                local tirggerskill = sgs.Sanguosha:getTriggerSkill(self:objectName())
                room:getThread():addTriggerSkill(tirggerskill)
            end
        end
    end,
    on_uninstall = function(self,player)
        local room = player:getRoom()
        room:detachSkillFromPlayer(player,self:objectName(),true,true)
        return false
    end,
}



local c = sgs.Sanguosha:cloneCard("slash",2,4)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("slash",2,7)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("slash",2,10)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("slash",3,6)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("slash",3,7)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("slash",1,5)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("slash",1,6)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("slash",1,8)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("slash",1,9)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("slash",1,10)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("slash",0,8)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("slash",0,9)
c:setParent(extension_youngcard)

local c = sgs.Sanguosha:cloneCard("jink",2,2)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("jink",3,2)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("jink",3,4)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("jink",2,8)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("jink",3,8)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("jink",3,9)
c:setParent(extension_youngcard)

local c = sgs.Sanguosha:cloneCard("peach",3,3)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("peach",3,5)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("peach",3,6)
c:setParent(extension_youngcard)

local c = sgs.Sanguosha:cloneCard("duel",0,1)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("duel",3,1)
c:setParent(extension_youngcard)

local c = sgs.Sanguosha:cloneCard("snatch",0,4)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("snatch",3,3)
c:setParent(extension_youngcard)

local c = sgs.Sanguosha:cloneCard("dismantlement",0,3)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("dismantlement",1,3)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("dismantlement",1,4)
c:setParent(extension_youngcard)

local c = sgs.Sanguosha:cloneCard("savage_assault",0,7)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("savage_assault",1,7)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("archery_attack",2,1)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("ex_nihilo",2,9)
c:setParent(extension_youngcard)

local c = sgs.Sanguosha:cloneCard("qinggang_sword",0,6)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("crossbow",1,1)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("axe",3,5)
c:setParent(extension_youngcard)
local c = sgs.Sanguosha:cloneCard("spear",0,10)
c:setParent(extension_youngcard)
sfofl_young_blade:setParent(extension_youngcard)
sfofl_young_halberd:setParent(extension_youngcard)
sfofl_young_eight_diagram:setParent(extension_youngcard)
sfofl_young_eight_diagram:clone(1,2):setParent(extension_youngcard)

sfofl_young_xiahoudun = sgs.General(extension_young, "sfofl_young_xiahoudun", "wei", 4, true)

--[[
	技能名：刚烈
	相关武将：夏侯惇[青春]
	技能描述：其他角色对你造成伤害后，你可以令其弃置一张手牌。
	引用：sfofl_young_ganglie
]] --
sfofl_young_ganglie = sgs.CreateTriggerSkill{
    name = "sfofl_young_ganglie",
    events = {sgs.Damaged},
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.Damaged and player:isAlive() and player:hasSkill(self:objectName()) then
            local damage = data:toDamage()
            local from = damage.from
            if (not from) or from:isDead() then return end
            if room:askForSkillInvoke(player, self:objectName(), data) then
                room:askForDiscard(from, self:objectName(), 1, 1, false)
            end
        end
        return false
    end
}
sfofl_young_xiahoudun:addSkill(sfofl_young_ganglie)


sfofl_young_sunquan = sgs.General(extension_young, "sfofl_young_sunquan", "wu", 4, true)
--[[
	技能名：制衡
	相关武将：孙权[青春]
	技能描述：出牌阶段限一次，你可以弃置一张手牌，再摸一张牌。
	引用：sfofl_young_zhiheng
]] --
sfofl_young_zhihengCard = sgs.CreateSkillCard {
    name = "sfofl_young_zhiheng",
    target_fixed = true,
    will_throw = true,
    on_use = function(self, room, source, targets)
        local count = self:subcardsLength()
        room:drawCards(source, count, "sfofl_young_zhiheng")
    end
}
sfofl_young_zhiheng = sgs.CreateViewAsSkill {
    name = "sfofl_young_zhiheng",
    n = 1,
    view_filter = function(self, selected, to_select)
        return not to_select:isEquipped()
    end,
    view_as = function(self, cards)
        if #cards > 0 then
            local zhiheng_card = sfofl_young_zhihengCard:clone()
            for _, card in pairs(cards) do
                zhiheng_card:addSubcard(card)
            end
            zhiheng_card:setSkillName(self:objectName())
            return zhiheng_card
        end
    end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_young_zhiheng")
    end
}
sfofl_young_sunquan:addSkill(sfofl_young_zhiheng)

sfofl_young_lvbu = sgs.General(extension_young, "sfofl_young_lvbu", "qun", 4, true)
--[[
	技能名：无双
	相关武将：吕布[青春]
	技能描述：你使用的【杀】需要两张【闪】才能抵消（单出一张无效）。
	引用：sfofl_young_wushuang
]] --
sfofl_young_wushuang = sgs.CreateTriggerSkill {
    name = "sfofl_young_wushuang",
    frequency = sgs.Skill_Compulsory,
    events = { sgs.TargetSpecified },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
      
      if event == sgs.TargetSpecified then
            local use = data:toCardUse()
            if (player:objectName() ~= use.from:objectName()) or (not use.card:isKindOf("Slash")) then return false end
            local jink_table = sgs.QList2Table(player:getTag("Jink_" .. use.card:toString()):toIntList())
            local index = 1
            for _, p in sgs.qlist(use.to) do
                jink_table[index] = jink_table[index] + 1
                index = index + 1
            end
            local jink_data = sgs.QVariant()
            jink_data:setValue(Table2IntList(jink_table))
            player:setTag("Jink_" .. use.card:toString(), jink_data)
            return false
        end
    end
}
sfofl_young_lvbu:addSkill(sfofl_young_wushuang)


sfofl_4_zhugeliang = sgs.General(extension_s, "sfofl_4_zhugeliang", "shu", 4, true)
--[[
	技能名：问天
	相关武将：诸葛亮[官盗]
	技能描述：锁定技，摸牌阶段开始时，你改为亮出牌堆顶的四张牌，然后获得其中一种花色的所有牌。剩余牌以任意顺序放回牌堆顶或牌堆底。根据你获得的花色，直到你的下回合开始，你拥有以下效果。\
        黑桃，雪：你视为装备【诸葛连弩】；\
        红桃，晴：你回复1点体力，摸一张牌；\
        梅花，雾：你视为装备【八卦阵】；\
        方块，风：你每造成1点伤害，你可以摸一张牌。
	引用：sfofl_wentian
]] --

sfofl_wentian = sgs.CreateTriggerSkill{
    name = "sfofl_wentian",
    frequency = sgs.Skill_Compulsory,
    events = {sgs.EventPhaseStart},
    on_trigger = function(self, event, player, data)
        if player:getPhase() ~= sgs.Player_Draw then
            return false
        end
        local room = player:getRoom()
        local x = 4 + player:getMark("sfofl_wentian")
        local card_ids = room:getNCards(x)
        room:fillAG(card_ids)
        local to_get = sgs.IntList()
        local to_throw = sgs.IntList()
        local card_id = room:askForAG(player, card_ids, false, "sfofl_qijin")
        card_ids:removeOne(card_id)
        to_get:append(card_id)
        local card = sgs.Sanguosha:getCard(card_id)
        for _,id in sgs.qlist(card_ids) do
            local c = sgs.Sanguosha:getCard(id)
            if c:getSuit() == card:getSuit() then
                to_get:append(id)
            else
                to_throw:append(id)
            end
        end
        local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
        if not to_get:isEmpty() then
            dummy:addSubcards(getCardList(to_get))
            player:obtainCard(dummy)
        end
        dummy:clearSubcards()
        if not to_throw:isEmpty() then
            dummy:addSubcards(getCardList(to_throw))
            -- local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_NATURAL_ENTER, player:objectName(), self:objectName(),"")
            -- room:throwCard(dummy, reason, nil)
            room:askForGuanxing(player, to_throw)
        end
        dummy:deleteLater()
        room:clearAG()
        room:addPlayerMark(player, "sfofl_wentian_"..card:getSuitString())
        room:addPlayerMark(player, "&sfofl_wentian_"..card:getSuitString())
        if card:getSuit() == sgs.Card_Spade then
        elseif card:getSuit() == sgs.Card_Heart then
            local recover = sgs.RecoverStruct()
            recover.who = player
            room:recover(player, recover, true)
            player:drawCards(1, self:objectName())
        elseif card:getSuit() == sgs.Card_Diamond then
        elseif card:getSuit() == sgs.Card_Club then
        end
        return true
    end
}
sfofl_wentian_Clear = sgs.CreateTriggerSkill{
    name = "#sfofl_wentian_Clear",
    frequency = sgs.Skill_Compulsory,
    events = {sgs.EventPhaseStart},
    on_trigger = function(self, event, player, data, room)
        if player:getPhase() ~= sgs.Player_Start then
            return false
        end
        for _, mark in sgs.list(player:getMarkNames()) do
            if string.find(mark, "sfofl_wentian_") and player:getMark(mark) > 0 then
                room:setPlayerMark(player, mark, 0)
            end
        end
    end
}
sfofl_wentian_spade = sgs.CreateViewAsEquipSkill {
	name = "#sfofl_wentian_spade",
	view_as_equip = function(self, player)
		if player:getMark("sfofl_wentian_spade") > 0 then
			return "crossbow"
		end
	end
}
sfofl_wentian_club = sgs.CreateViewAsEquipSkill {
	name = "#sfofl_wentian_club",
	view_as_equip = function(self, player)
		if player:getMark("sfofl_wentian_club") > 0 then
			return "eight_diagram"
		end
	end
}
sfofl_wentian_diamond = sgs.CreateTriggerSkill{
    name = "#sfofl_wentian_diamond",
    frequency = sgs.Skill_Frequent,
    events = {sgs.Damage},
    on_trigger = function(self, event, player, data, room)
        local damage = data:toDamage()
        if room:askForSkillInvoke(player, "sfofl_wentian", data) then
            room:sendCompulsoryTriggerLog(player, "sfofl_wentian", true)
            player:drawCards(damage.damage, "sfofl_wentian")
        end
    end,
    can_trigger = function(self, target)
        return target and target:getMark("sfofl_wentian_diamond") > 0
    end,
}

--[[
	技能名：克复
	相关武将：诸葛亮[官盗]
	技能描述：你每对其他角色造成4点伤害，问天的牌数+1。
	引用：sfofl_kefu
]] --
sfofl_kefu = sgs.CreateTriggerSkill{
    name = "sfofl_kefu",
    frequency = sgs.Skill_NotFrequent,
    events = {sgs.Damage},
    on_trigger = function(self, event, player, data, room)
        local damage = data:toDamage()
        if damage.from:objectName() ~= damage.to:objectName() then
            room:addPlayerMark(player, "sfofl_kefu_damage", damage.damage)
            if player:getMark("sfofl_kefu_damage") >= 4 then
                room:addPlayerMark(player, "sfofl_wentian")
                room:addPlayerMark(player, "&sfofl_kefu")
                room:removePlayerMark(player, "sfofl_kefu_damage", 4)
                player:setSkillDescriptionSwap("sfofl_wentian","%arg1", 4+player:getMark("sfofl_wentian"))
                room:changeTranslation(player, "sfofl_wentian",1)
            end
        end
    end
}

sfofl_4_zhugeliang:addSkill(sfofl_wentian)
sfofl_4_zhugeliang:addSkill(sfofl_wentian_Clear)
sfofl_4_zhugeliang:addSkill(sfofl_wentian_spade)
sfofl_4_zhugeliang:addSkill(sfofl_wentian_club)
sfofl_4_zhugeliang:addSkill(sfofl_wentian_diamond)
extension_s:insertRelatedSkills("sfofl_wentian", "#sfofl_wentian_Clear")
extension_s:insertRelatedSkills("sfofl_wentian", "#sfofl_wentian_spade")
extension_s:insertRelatedSkills("sfofl_wentian", "#sfofl_wentian_club")
extension_s:insertRelatedSkills("sfofl_wentian", "#sfofl_wentian_diamond")
sfofl_4_zhugeliang:addSkill(sfofl_kefu)

sfofl_3_guanyu = sgs.General(extension_s, "sfofl_3_guanyu", "shu", 4, true)
--[[
	技能名：拖刀
	相关武将：关羽[官盗]
	技能描述：锁定技，你使用黑色【杀】时，你摸一张牌；红色【杀】时，此【杀】伤害+1。
	引用：sfofl_tuodao
]] --

sfofl_tuodao = sgs.CreateTriggerSkill{
    name = "sfofl_tuodao",
    frequency = sgs.Skill_Compulsory,
    events = {sgs.ConfirmDamage, sgs.CardUsed},
    on_trigger = function(self, event, player, data)
        if event == sgs.ConfirmDamage then
            local damage = data:toDamage()
            local card = damage.card
            if card then
                if card:isKindOf("Slash") and card:isRed() then
                    local hurt = damage.damage
                    damage.damage = hurt + 1
                    local log = sgs.LogMessage()
                    log.type = "#skill_add_damage"
                    log.from = damage.from
                    log.to:append(damage.to)
                    log.arg  = self:objectName()
                    log.arg2 = damage.damage
                    player:getRoom():sendLog(log)
                    data:setValue(damage)
                end
            end
        elseif event == sgs.CardUsed then
            local use = data:toCardUse()
            if use.card:isKindOf("Slash") and use.card:isBlack() then
                player:drawCards(1, "sfofl_tuodao")
            end
        end
        return false
    end
}
sfofl_3_guanyu:addSkill("wusheng")
sfofl_3_guanyu:addSkill(sfofl_tuodao)

sfofl_caocao = sgs.General(extension_s, "sfofl_caocao", "wei", 4, true)
--[[
	技能名：雄才
	相关武将：曹操[官盗]
	技能描述：你造成1点伤害后，你可以摸一张牌。
	引用：sfofl_xiongcai
]] --
sfofl_xiongcai = sgs.CreateTriggerSkill{
    name = "sfofl_xiongcai",
    frequency = sgs.Skill_Frequent,
    events = {sgs.Damage},
    on_trigger = function(self, event, player, data, room)
        local damage = data:toDamage()
        if room:askForSkillInvoke(player, self:objectName(), data) then
            player:drawCards(damage.damage, self:objectName())
        end
    end
}

sfofl_caocao:addSkill("jianxiong")
sfofl_caocao:addSkill("feiying")
sfofl_caocao:addSkill(sfofl_xiongcai)


sfofl_3_zhaoyun = sgs.General(extension_s, "sfofl_3_zhaoyun", "shu", 4, true)
--[[
	技能名：七进
	相关武将：赵云[官盗]
	技能描述：觉醒技，结束阶段，若你本回合造成了2点或更多伤害，你减1点体力上限，获得“冲阵”。
	引用：sfofl_2_qijin
]] --
sfofl_2_qijin = sgs.CreatePhaseChangeSkill{
    name = "sfofl_2_qijin",
    frequency = sgs.Skill_Wake,
    waked_skills = "chongzhen",
    on_phasechange = function(self, player)
        local room = player:getRoom()
        room:setPlayerMark(player, self:objectName(), 1)
        if room:changeMaxHpForAwakenSkill(player, -1, self:objectName()) then
            room:handleAcquireDetachSkills(player, "chongzhen")
        end
        return false
    end ,
    can_trigger = function(self, target)
        return target and target:isAlive() and target:hasSkill(self:objectName()) and target:getPhase() == sgs.Player_Finish 
        and target:getMark(self:objectName()) == 0 and (target:getMark("damage_point_turn-Clear") >= 2 or target:canWake(self:objectName()))
    end
}
--[[
	技能名：七出
	相关武将：赵云[官盗]
	技能描述：觉醒技，当你的体力值第一次为2点及以下时，你获得义从并抽两张牌。
	引用：sfofl_2_qichu
]] --
sfofl_2_qichu = sgs.CreateTriggerSkill{
    events = {sgs.HpChanged},
    name = "sfofl_2_qichu",
    frequency = sgs.Skill_Wake,
    waked_skills = "yicong",
    on_trigger = function(self, event, player, data, room)
        local room = player:getRoom()
        if player:getHp() <= 2  then
            room:setPlayerMark(player, self:objectName(), 1)
            if room:changeMaxHpForAwakenSkill(player, 0, self:objectName()) then
                room:handleAcquireDetachSkills(player, "yicong")
                player:drawCards(2, self:objectName())
            end
        end
        return false
    end ,
    can_trigger = function(self, target)
        return target and target:isAlive() and target:hasSkill(self:objectName()) 
        and target:getMark(self:objectName()) == 0
    end
}
sfofl_3_zhaoyun:addSkill("longdan")
sfofl_3_zhaoyun:addSkill(sfofl_2_qijin)
sfofl_3_zhaoyun:addSkill(sfofl_2_qichu)

sfofl_sunce = sgs.General(extension_s, "sfofl_sunce", "wu", 4, true)
--[[
	技能名：霸业
	相关武将：孙策[官盗]
	技能描述：你可以将两张手牌当红色杀使用或打出。
	引用：sfofl_baye
]] --
sfofl_baye = sgs.CreateViewAsSkill{
    name = "sfofl_baye" ,
    n = 2,
    view_filter = function(self, selected, to_select)
        return (#selected < 2) and (not to_select:isEquipped())
    end ,
    view_as = function(self, cards)
        if #cards ~= 2 then return nil end
        local slash = sgs.Sanguosha:cloneCard("Slash", sgs.Card_NoSuitRed, 0)
        slash:setSkillName(self:objectName())
        slash:addSubcard(cards[1])
        slash:addSubcard(cards[2])
        return slash
    end ,
    enabled_at_play = function(self, player)
        return (player:getHandcardNum() >= 2) and sgs.Slash_IsAvailable(player)
    end ,
    enabled_at_response = function(self, player, pattern)
        return (player:getHandcardNum() >= 2) and (pattern == "slash")
    end
}
sfofl_sunce:addSkill("jiang")
sfofl_sunce:addSkill(sfofl_baye)
sfofl_sunce:addSkill("hunzi")

sfofl_boss_guanyu = sgs.General(extension_s, "sfofl_boss_guanyu", "shu", 8, true, hide_boss)
--[[
	技能名：形态转换
	相关武将：关羽[官盗]
	技能描述：当你的“武魂”牌只有一种颜色时，你进入历战状态。
	引用：sfofl_boss_change_guanyu
]] --
sfofl_boss_change_guanyu = sgs.CreateTriggerSkill{
    name = "sfofl_boss_change_guanyu",
    frequency = sgs.Skill_Compulsory,
    events = {sgs.CardsMoveOneTime},
    on_trigger = function(self,event,player,data)
        local room = player:getRoom()
       if event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            if move.to_place == sgs.Player_PlaceSpecial and move.to_pile_name == "sfofl_boss_wuhun"
            and move.to:objectName() == player:objectName()
            then
                local colors = {}
                if not player:getPile("sfofl_boss_wuhun"):isEmpty() then
                    for _,c in sgs.qlist(player:getPile("sfofl_boss_wuhun")) do
                        if not table.contains(colors, sgs.Sanguosha:getCard(c):getColorString()) then
                            table.insert(colors, sgs.Sanguosha:getCard(c):getColorString())
                        end
                        if #colors > 1 then
                            break
                        end
                    end
                    if #colors ~= 1 then
                        room:handleAcquireDetachSkills(player,"sfofl_boss_wuhun|sfofl_boss_wenjiu|sfofl_boss_wusheng")
                        room:handleAcquireDetachSkills(player,"-sfofl_boss_zhongyi|-sfofl_boss_ruiyi|-sfofl_boss_xiaoyong")
                    elseif #colors == 1 then
                        room:handleAcquireDetachSkills(player,"-sfofl_boss_wuhun|-sfofl_boss_wenjiu|-sfofl_boss_wusheng")
                        room:handleAcquireDetachSkills(player,"sfofl_boss_zhongyi|sfofl_boss_ruiyi|sfofl_boss_xiaoyong")
                    end
                end
            elseif move.from_places:contains(sgs.Player_PlaceSpecial)
            and table.contains(move.from_pile_names,"sfofl_boss_wuhun")
            and move.from:objectName() == player:objectName()
            then
                local colors = {}
                if not player:getPile("sfofl_boss_wuhun"):isEmpty() then
                    for _,c in sgs.qlist(player:getPile("sfofl_boss_wuhun")) do
                        if not table.contains(colors, sgs.Sanguosha:getCard(c):getColorString()) then
                            table.insert(colors, sgs.Sanguosha:getCard(c):getColorString())
                        end
                        if #colors > 1 then
                            break
                        end
                    end
                    if #colors == 1 then
                        room:handleAcquireDetachSkills(player,"-sfofl_boss_wuhun|-sfofl_boss_wenjiu|-sfofl_boss_wusheng")
                        room:handleAcquireDetachSkills(player,"sfofl_boss_zhongyi|sfofl_boss_ruiyi|sfofl_boss_xiaoyong")
                    elseif #colors ~= 1 then
                        room:handleAcquireDetachSkills(player,"sfofl_boss_wuhun|sfofl_boss_wenjiu|sfofl_boss_wusheng")
                        room:handleAcquireDetachSkills(player,"-sfofl_boss_zhongyi|-sfofl_boss_ruiyi|-sfofl_boss_xiaoyong")
                    end
                    
                end
            end
        end
        return false
    end
}


--[[
	技能名：武魂
	相关武将：关羽[官盗]
	技能描述：游戏开始时，你将牌堆顶九张牌放在你的武将牌上，称为“武魂”牌。
	引用：sfofl_boss_wuhun
]] --

sfofl_boss_wuhun = sgs.CreateTriggerSkill {
    name = "sfofl_boss_wuhun",
    events = { sgs.GameStart },
    frequency = sgs.Skill_NotFrequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local players = sgs.SPlayerList()
        players:append(player)
        player:addToPile("sfofl_boss_wuhun", room:getNCards(9), false, players)
    end
}

--[[
	技能名：温酒
	相关武将：关羽[官盗]
	技能描述：摸牌阶段，你可以放弃摸牌，然后将三张“武魂”牌加入手牌，并将牌堆顶三张牌置入“武魂”牌。
	引用：sfofl_boss_wenjiu
]] --
sfofl_boss_wenjiuCard = sgs.CreateSkillCard{
    name = "sfofl_boss_wenjiu",
    will_throw = false,
    handling_method = sgs.Card_MethodNone,
    target_fixed = true,
    on_use = function(self, room, source, targets)
        local subCards = self:getSubcards()
        local to_handcard_x = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
        for _,id in sgs.qlist(subCards) do
            to_handcard_x:addSubcard(id)
        end
        local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_EXTRACTION, source:objectName())
        room:obtainCard(source, to_handcard_x, reason, false)
    end,
}
sfofl_boss_wenjiuVS = sgs.CreateViewAsSkill{
    name = "sfofl_boss_wenjiu", 
    n = 998,
    response_pattern = "@@sfofl_boss_wenjiu",
    expand_pile = "sfofl_boss_wuhun",
    view_filter = function(self, selected, to_select)
        if #selected < 3 then
            local pat = ".|.|.|sfofl_boss_wuhun"
            return sgs.Sanguosha:matchExpPattern(pat, sgs.Self, to_select)
        end
        return false
    end,
    view_as = function(self, cards)
        if #cards == 3 then
            local c = sfofl_boss_wenjiuCard:clone()
            for _,card in ipairs(cards) do
                c:addSubcard(card)
            end
            return c
        end
        return nil
    end,
    enabled_at_play = function(self, player)
        return false
    end,
}
sfofl_boss_wenjiu = sgs.CreateTriggerSkill{
    name = "sfofl_boss_wenjiu",
    view_as_skill = sfofl_boss_wenjiuVS,
    events = {sgs.EventPhaseStart},
    on_trigger = function(self, event, player, data, room)
        if event == sgs.EventPhaseStart then
            if player:getPhase() == sgs.Player_Draw then
                if player:getPile("sfofl_boss_wuhun"):length() >= 3 then
                    if player:getRoom():askForUseCard(player, "@@sfofl_boss_wenjiu", "@sfofl_boss_wenjiu", -1, sgs.Card_MethodNone) then
                        local players = sgs.SPlayerList()
                        players:append(player)
                        player:addToPile("sfofl_boss_wuhun", room:getNCards(3), false, players)
                        return true
                    end
                end
            end
        end
    end
}

--[[
	技能名：武圣
	相关武将：关羽[官盗]
	技能描述：你的“武魂”牌中黑色牌最多时，你可以将一张黑色牌当【过河拆桥】使用；红色牌最多时，你可以将一张红色牌当【杀】使用或打出。
	引用：sfofl_boss_wusheng
]] --
sfofl_boss_wusheng = sgs.CreateOneCardViewAsSkill{
    name = "sfofl_boss_wusheng",
    response_or_use = true,
    view_filter = function(self, card)
        local red = 0
        local black = 0
        for _,id in sgs.qlist(sgs.Self:getPile("sfofl_boss_wuhun")) do
            local c = sgs.Sanguosha:getCard(id)
            if c:isBlack() then
                black = black + 1
            else
                red = red + 1
            end
        end
        if black > red then
            if not card:isBlack() then return false end
            if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
                local dismantlement = dummyCard("dismantlement")
                dismantlement:addSubcard(card:getEffectiveId())
                dismantlement:deleteLater()
                return dismantlement:isAvailable(sgs.Self)
            end
        elseif red > black then
            if not card:isRed() then return false end
            local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
            slash:addSubcard(card:getEffectiveId())
            slash:deleteLater()
            return slash:isAvailable(sgs.Self)
        end
        return true
    end,
    view_as = function(self, card)
        if card:isRed() then
            local slash = sgs.Sanguosha:cloneCard("slash", card:getSuit(), card:getNumber())
            slash:addSubcard(card:getId())
            slash:setSkillName(self:objectName())
            return slash
        elseif card:isBlack() then
            local acard = sgs.Sanguosha:cloneCard("dismantlement", card:getSuit(), card:getNumber())
            acard:addSubcard(card:getId())
            acard:setSkillName(self:objectName())
            return acard
        end
    end,
    enabled_at_play = function(self, player)
        if player:getPile("sfofl_boss_wuhun"):isEmpty() then return false end
        local red = 0
        local black = 0
        for _,id in sgs.qlist(player:getPile("sfofl_boss_wuhun")) do
            local c = sgs.Sanguosha:getCard(id)
            if c:isBlack() then
                black = black + 1
            else
                red = red + 1
            end
        end
        if red > black then
            return sgs.Slash_IsAvailable(player)
        elseif black > red then
            return dummyCard("dismantlement"):isAvailable(player)
        end
    end, 
    enabled_at_response = function(self, player, pattern)
        if player:getPile("sfofl_boss_wuhun"):isEmpty() then return false end
        local red = 0
        local black = 0
        for _,id in sgs.qlist(player:getPile("sfofl_boss_wuhun")) do
            local c = sgs.Sanguosha:getCard(id)
            if c:isBlack() then
                black = black + 1
            else
                red = red + 1
            end
        end
        if red > black then
            return pattern == "slash"
        end
    end
}

--[[
	技能名：忠义
	相关武将：关羽[官盗]
	技能描述：摸牌阶段，你额外摸两张牌，若你的“武魂”牌为同一花色，则改为摸五张牌。
	引用：sfofl_boss_zhongyi
]] --
sfofl_boss_zhongyi = sgs.CreateTriggerSkill {
    name = "sfofl_boss_zhongyi",
    frequency = sgs.Skill_Frequent,
    events = { sgs.DrawNCards },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local draw = data:toDraw()
        if draw.reason ~= "draw_phase" then return false end
        room:sendCompulsoryTriggerLog(player, self:objectName(), true)
        local x = 2
        local suit = {}
        if not player:getPile("sfofl_boss_wuhun"):isEmpty() then
            for _,c in sgs.qlist(player:getPile("sfofl_boss_wuhun")) do
                if not table.contains(suit, sgs.Sanguosha:getCard(c):getSuitString()) then
                    table.insert(suit, sgs.Sanguosha:getCard(c):getSuitString())
                end
                if #suit > 1 then
                    break
                end
            end
            if #suit == 1 then
                x = 5
            end
        end
        draw.num = draw.num + x
        data:setValue(draw)
    end
}

--[[
	技能名：锐意
	相关武将：关羽[官盗]
	技能描述：出牌阶段限一次，你可以选择一项：①用任意张“武魂”牌替换等量相同颜色的手牌；②弃置任意张与“武魂”牌颜色不同的手牌然后摸等量的牌。
	引用：sfofl_boss_ruiyi
]] --
sfofl_boss_ruiyiCard = sgs.CreateSkillCard{
    name = "sfofl_boss_ruiyi",
    target_fixed = true,
    mute = true,
    will_throw = false,
    on_use = function(self, room, source, targets)
        if source:isAlive() then
            if source:getPile("sfofl_boss_wuhun"):contains(self:getSubcards():first()) then
                source:obtainCard(self)
                local exchange_card = room:askForExchange(source, "sfofl_boss_ruiyi", self:subcardsLength(), self:subcardsLength())
                local players = sgs.SPlayerList()
                players:append(source)
                source:addToPile("sfofl_boss_wuhun", exchange_card:getSubcards(), false, players)
            else
                room:throwCard(self, source)
                if source:isAlive() then
                    room:drawCards(source, self:subcardsLength(), "sfofl_boss_ruiyi")
                end
            end
        end
    end
}
sfofl_boss_ruiyi = sgs.CreateViewAsSkill{
    name = "sfofl_boss_ruiyi",
    n = 999,
    expand_pile = "sfofl_boss_wuhun",
	view_filter = function(self, selected, to_select)
		if #selected > 0 then
			if sgs.Self:getPile("sfofl_boss_wuhun"):contains(selected[1]:getId()) then
				return sgs.Self:getPile("sfofl_boss_wuhun"):contains(to_select:getId()) and #selected < sgs.Self:getHandcardNum()
			else
                for _, c in sgs.list(selected) do
                    if c:sameColorWith(to_select) then
                        return sgs.Self:getHandcards():contains(to_select) 
                    end
                end
			end
		else
            for _,id in sgs.qlist(sgs.Self:getPile("sfofl_boss_wuhun")) do
                if sgs.Self:getHandcards():contains(to_select) and to_select:sameColorWith(sgs.Sanguosha:getCard(id)) then
                    return false
                end
            end
			return sgs.Self:getPile("sfofl_boss_wuhun"):contains(to_select:getId()) or sgs.Self:getHandcards():contains(to_select)
		end
	end,
    view_as = function(self, cards)
        if #cards == 0 then return nil end
        local zhiheng_card = sfofl_boss_ruiyiCard:clone()
        for _,card in pairs(cards) do
            zhiheng_card:addSubcard(card)
        end
        zhiheng_card:setSkillName(self:objectName())
        return zhiheng_card
    end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_boss_ruiyi")
    end,
}

--[[
	技能名：骁勇
	相关武将：关羽[官盗]
	技能描述：若你使用的【杀】与你“武魂”牌颜色相同，则无次数限制；若你的“武魂”牌为同一花色，则你使用与你“武魂”牌花色相同的【杀】造成伤害时摸一张牌。
	引用：sfofl_boss_xiaoyong
]] --
sfofl_boss_xiaoyong_targetmod = sgs.CreateTargetModSkill {
    name = "#sfofl_boss_xiaoyong_targetmod",
    pattern = "Slash",
    residue_func = function(self, player, card)
        if not player:getPile("sfofl_boss_wuhun"):isEmpty() and player:hasSkill("sfofl_boss_xiaoyong") then
            for _,id in sgs.qlist(player:getPile("sfofl_boss_wuhun")) do
                if card:sameColorWith(sgs.Sanguosha:getCard(id)) then
                    return 999
                end
            end
        end
        return 0
    end,
}
sfofl_boss_xiaoyong = sgs.CreateTriggerSkill {
	name = "sfofl_boss_xiaoyong",
	frequency = sgs.Skill_NotFrequent,
	events = { sgs.PreCardUsed, sgs.DamageCaused },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.PreCardUsed then
			local use = data:toCardUse()
			if use.card and use.card:isKindOf("Slash") then
				if not player:getPile("sfofl_boss_wuhun"):isEmpty() then
                    for _,id in sgs.qlist(player:getPile("sfofl_boss_wuhun")) do
                        if use.card:sameColorWith(id) then
                            if (use.m_addHistory) then
                                room:addPlayerHistory(player, use.card:getClassName(), -1)
                                room:sendCompulsoryTriggerLog(player, self:objectName(), true)
                                use.m_addHistory = false
                                data:setValue(use)
                                break
                            end
                        end
                    end
                end
			end
        elseif event == sgs.DamageCaused then
            local damage = data:toDamage()
            if damage.card and damage.card:isKindOf("Slash") then
                local suit = {}
                if not player:getPile("sfofl_boss_wuhun"):isEmpty() then
                    for _,c in sgs.qlist(player:getPile("sfofl_boss_wuhun")) do
                        if damage.card:getSuitString() ~= sgs.Sanguosha:getCard(c):getSuitString() then return false end
                        if not table.contains(suit, sgs.Sanguosha:getCard(c):getSuitString()) then
                            table.insert(suit, sgs.Sanguosha:getCard(c):getSuitString())
                        end
                        if #suit > 1 then
                            break
                        end
                    end
                    if #suit == 1 then
                        player:drawCards(1, self:objectName())
                    end
                end
            end
		end
	end,
}

sfofl_boss_guanyu:addSkill(sfofl_boss_change_guanyu)
sfofl_boss_guanyu:addSkill(sfofl_boss_wuhun)
sfofl_boss_guanyu:addSkill(sfofl_boss_wenjiu)
sfofl_boss_guanyu:addSkill(sfofl_boss_wusheng)
if not sgs.Sanguosha:getSkill("sfofl_boss_zhongyi") then skills:append(sfofl_boss_zhongyi) end
if not sgs.Sanguosha:getSkill("sfofl_boss_ruiyi") then skills:append(sfofl_boss_ruiyi) end
if not sgs.Sanguosha:getSkill("sfofl_boss_xiaoyong") then skills:append(sfofl_boss_xiaoyong) end
if not sgs.Sanguosha:getSkill("#sfofl_boss_xiaoyong_targetmod") then skills:append(sfofl_boss_xiaoyong_targetmod) end
extension_s:insertRelatedSkills("sfofl_boss_xiaoyong", "#sfofl_boss_xiaoyong_targetmod")
sfofl_boss_guanyu:addRelateSkill("sfofl_boss_zhongyi")
sfofl_boss_guanyu:addRelateSkill("sfofl_boss_ruiyi")
sfofl_boss_guanyu:addRelateSkill("sfofl_boss_xiaoyong")


sfofl_boss_lvbu = sgs.General(extension_s, "sfofl_boss_lvbu", "qun", 9, true, hide_boss)

--[[
	技能名：形态转换
	相关武将：吕布[官盗]
	技能描述：当你的“战意”牌数量大于等于3时，你进入历战状态。
	引用：sfofl_boss_change_lvbu
]] --
sfofl_boss_change_lvbu = sgs.CreateTriggerSkill{
    name = "sfofl_boss_change_lvbu",
    frequency = sgs.Skill_Compulsory,
    events = {sgs.CardsMoveOneTime},
    on_trigger = function(self,event,player,data)
        local room = player:getRoom()
        if event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            if move.to_place == sgs.Player_PlaceSpecial and move.to_pile_name == "sfofl_boss_zhanyi"
            and move.to:objectName() == player:objectName()
            then
                if not player:getPile("sfofl_boss_zhanyi"):isEmpty() then
                    if player:getPile("sfofl_boss_zhanyi"):length() >= 3 then
                        room:handleAcquireDetachSkills(player,"sfofl_boss_hanzhan_2|sfofl_boss_wushuang|sfofl_boss_xiuluo")
                        room:handleAcquireDetachSkills(player,"-sfofl_boss_hanzhan|-sfofl_boss_feijun|-wushuang")
                    else
                        room:handleAcquireDetachSkills(player,"-sfofl_boss_hanzhan_2|-sfofl_boss_wushuang|-sfofl_boss_xiuluo")
                        room:handleAcquireDetachSkills(player,"sfofl_boss_hanzhan|sfofl_boss_feijun|wushuang")
                    end
                end
            elseif move.from_places:contains(sgs.Player_PlaceSpecial)
            and table.contains(move.from_pile_names,"sfofl_boss_zhanyi")
            and move.from:objectName() == player:objectName()
            then
                if not player:getPile("sfofl_boss_zhanyi"):isEmpty() then
                    if player:getPile("sfofl_boss_zhanyi"):length() >= 3 then
                        room:handleAcquireDetachSkills(player,"sfofl_boss_hanzhan_2|sfofl_boss_wushuang|sfofl_boss_xiuluo")
                        room:handleAcquireDetachSkills(player,"-sfofl_boss_hanzhan|-sfofl_boss_feijun|-wushuang")
                    else
                        room:handleAcquireDetachSkills(player,"-sfofl_boss_hanzhan_2|-sfofl_boss_wushuang|-sfofl_boss_xiuluo")
                        room:handleAcquireDetachSkills(player,"sfofl_boss_hanzhan|sfofl_boss_feijun|wushuang")
                    end
                end
            end
        end
        return false
    end
}

--[[
	技能名：酣战
	相关武将：吕布[官盗]
	技能描述：你每造成1点伤害，你可以将牌堆顶的一张牌置于你的武将牌上，称为“战意”牌。
	引用：sfofl_boss_hanzhan
]] --
sfofl_boss_hanzhan = sgs.CreateTriggerSkill {
    name = "sfofl_boss_hanzhan",
    frequency = sgs.Skill_Frequent,
    events = { sgs.Damage },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local damage = data:toDamage()
        if room:askForSkillInvoke(player, self:objectName(), data) then
            local x = damage.damage
            for i = 0, x - 1, 1 do
                local card_id = room:drawCard()
                player:addToPile("sfofl_boss_zhanyi", card_id)
            end
        end
    end
}

--[[
	技能名：飞军
	相关武将：吕布[官盗]
	技能描述：出牌阶段，每种花色限一次，当你使用或打出一张牌时，若此牌花色与你装备区中的牌花色相同，则你摸一张牌。
	引用：sfofl_boss_feijun
]] --
sfofl_boss_feijun = sgs.CreateTriggerSkill{
    name = "sfofl_boss_feijun",
    events = {sgs.CardResponded, sgs.CardUsed},
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local card
        if event == sgs.CardResponded then
            card = data:toCardResponse().m_card
        elseif event == sgs.CardUsed then
            card = data:toCardUse().card
        end
        if card and not card:isKindOf("SkillCard") and player:getPhase() == sgs.Player_Play then

            local record = player:property("sfofl_boss_feijunRecords"):toString()
            local suit = card:getSuitString()
            local records
            if (record) then
                records = record:split(",")
            end
            if records and (table.contains(records, suit) ) then

            else
                for _, equip in sgs.qlist(player:getEquips()) do
                    if equip:getSuit() == card:getSuit() then
                        table.insert(records, suit)
                        room:sendCompulsoryTriggerLog(player, self:objectName())
                        room:broadcastSkillInvoke(self:objectName())
                        player:drawCards(1, self:objectName())
                        break
                    end      
                end
            end
            if #records == 0 then return false end
            room:setPlayerProperty(player, "sfofl_boss_feijunRecords", sgs.QVariant(table.concat(records, ",")));
            for _, mark in sgs.list(player:getMarkNames()) do
                if (string.startsWith(mark, "&sfofl_boss_feijun+#record") and player:getMark(mark) > 0) then
                    room:setPlayerMark(player, mark, 0)
                end
            end
            local mark = "&sfofl_boss_feijun+#record"
            for _, suit in ipairs(records) do
                mark = mark .. "+" .. suit .. "_char"
            end
            mark = mark .. "-PlayClear"
            room:setPlayerMark(player, mark, 1)
            
        end
    end
}
sfofl_boss_feijunClear = sgs.CreateTriggerSkill {
    name = "#sfofl_boss_feijunClear",
    events = { sgs.EventLoseSkill, sgs.EventPhaseChanging },
    on_trigger = function(self, event, player, data, room)
        if event == sgs.EventLoseSkill then
            if data:toString() == "sfofl_boss_feijun" then
                local records = {}
                room:setPlayerProperty(player, "sfofl_boss_feijunRecords", sgs.QVariant(table.concat(records, ",")));
            end
        elseif event == sgs.EventPhaseChanging then
            local change = data:toPhaseChange()
            if change.from == sgs.Player_Play then
                for _, p in sgs.qlist(room:getAlivePlayers()) do
                    local records = {}
                    room:setPlayerProperty(p, "sfofl_boss_feijunRecords", sgs.QVariant(table.concat(records, ",")))
                end
            end
        end
        return false
    end,
    can_trigger = function(self, target)
        return target
    end
}

--[[
	技能名：无双
	相关武将：吕布[官盗]
	技能描述：锁定技，你使用的【杀】伤害+1，被指定的角色每使用一张【闪】可抵消1点伤害；你的【决斗】不可被响应。
	引用：sfofl_boss_wushuang
]] --
sfofl_boss_wushuang = sgs.CreateTriggerSkill{
    name = "sfofl_boss_wushuang" ,
    frequency = sgs.Skill_Compulsory ,
    events = {sgs.TargetSpecified, sgs.CardUsed, sgs.DamageCaused } ,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.TargetSpecified then
            local use = data:toCardUse()
            if use.card:isKindOf("Slash") and player and player:isAlive() and player:hasSkill(self:objectName()) then
                room:sendCompulsoryTriggerLog(player, self:objectName())
                local jink_list = sgs.QList2Table(player:getTag("Jink_" .. use.card:toString()):toIntList())
                for i = 0, use.to:length() - 1, 1 do
                    if jink_list[i + 1] == 1 then
                        jink_list[i + 1] = 2
                    end
                end
                local jink_data = sgs.QVariant()
                jink_data:setValue(Table2IntList(jink_list))
                player:setTag("Jink_" .. use.card:toString(), jink_data)
            end
        elseif event == sgs.CardUsed then
            local use = data:toCardUse()
            if use.card:isKindOf("Duel") then				
                local no_respond_list = use.no_respond_list
                for _, p in sgs.qlist(use.to) do
                    table.insert(no_respond_list, p:objectName())
                end
                use.no_respond_list = no_respond_list
                data:setValue(use)
            
            end
        elseif event == sgs.DamageCaused then
            local damage = data:toDamage()
            if damage.from and damage.from:hasSkill(self:objectName()) and damage.card and damage.card:isKindOf("Slash") then
                damage.damage = damage.damage + 1
                local log = sgs.LogMessage()
                log.type = "#skill_add_damage"
                log.from = damage.from
                log.to:append(damage.to)
                log.arg  = self:objectName()
                log.arg2 = damage.damage
                room:sendLog(log)
                local effect = sgs.CardEffectStruct()
                effect.card = damage.card
                effect.from = damage.from
                effect.to = damage.to
                local _data = sgs.QVariant()
                _data:setValue(effect)
                damage.from:setTag("sfofl_boss_wushuang", _data)
                while (damage.damage > 0) do
                    if not room:askForCard(damage.to, "jink", "sfofl_boss_wushuang-jink:"..damage.from:objectName(), sgs.QVariant(), sgs.Card_MethodUse, damage.from, false, "sfofl_boss_wushuang", false, damage.card) then
                        break
                    else
                        damage.damage = damage.damage - 1
                    end
                end
                damage.from:removeTag("sfofl_boss_wushuang")
                data:setValue(damage)
            end
        end
        return false
    end ,
}

--[[
	技能名：酣战
	相关武将：吕布[官盗]
	技能描述：当你使用或打出与“战意”牌花色相同的牌时，摸一张牌。
	引用：sfofl_boss_hanzhan_2
]] --
sfofl_boss_hanzhan_2 = sgs.CreateTriggerSkill{
    name = "sfofl_boss_hanzhan_2",
    events = {sgs.CardResponded, sgs.CardUsed},
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local card
        if event == sgs.CardResponded then
            card = data:toCardResponse().m_card
        elseif event == sgs.CardUsed then
            card = data:toCardUse().card
        end
        if card and not card:isKindOf("SkillCard") then
            if not player:getPile("sfofl_boss_zhanyi"):isEmpty() then
                for _,id in sgs.qlist(player:getPile("sfofl_boss_zhanyi")) do
                    if card:getSuit() == sgs.Sanguosha:getCard(id):getSuit() then
                        room:sendCompulsoryTriggerLog(player, self:objectName(),true)
                        player:drawCards(1, self:objectName())
                        break
                    end
                end
            end
        end
    end
}

--[[
	技能名：修罗
	相关武将：吕布[官盗]
	技能描述：出牌阶段限一次，你可以弃置一张“战意”牌并选择一项：①摸四张牌，并将两张手牌作为“战意”牌放在你的武将牌上然后结束出牌阶段；②弃置一名角色所有装备牌；③弃置一名角色一半的手牌（向下取整）。
	引用：sfofl_boss_xiuluo
]] --
sfofl_boss_xiuluoCard = sgs.CreateSkillCard{
    name = "sfofl_boss_xiuluo",
    target_fixed = true,
    mute = true,
    will_throw = false,
    on_use = function(self, room, source, targets)
        local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_REMOVE_FROM_PILE, "", self:objectName(), "")
		room:throwCard(self, reason, nil)
        local choicelist = {}
		table.insert(choicelist, "sfofl_boss_xiuluo_Draw")
        local targets_2 = sgs.SPlayerList()
        for _,p in sgs.qlist(room:getAlivePlayers()) do
            if source:canDiscard(p, "e") and not p:getEquips():isEmpty() then
                targets_2:append(p)
            end
        end
        if not targets_2:isEmpty() then
            table.insert(choicelist, "sfofl_boss_xiuluo_Discard_equip")
        end
        local targets_3 = sgs.SPlayerList()
        for _,p in sgs.qlist(room:getAlivePlayers()) do
            if source:canDiscard(p, "h") and not p:isKongcheng() then
                targets_3:append(p)
            end
        end
        if not targets_3:isEmpty() then
            table.insert(choicelist, "sfofl_boss_xiuluo_Discard_handcard")
        end
        
		local choice = room:askForChoice(source, self:objectName(),  table.concat(choicelist, "+"))
		if choice == "sfofl_boss_xiuluo_Draw" then
            source:drawCards(4, self:objectName())
            if not source:isKongcheng() then
                local exchange_card = room:askForExchange(source, "sfofl_boss_xiuluo", math.min(2, source:getHandcardNum()), math.min(2, source:getHandcardNum()))
                source:addToPile("sfofl_boss_zhanyi", exchange_card:getSubcards())
            end
            source:endPlayPhase()
        elseif choice == "sfofl_boss_xiuluo_Discard_equip" then
            local target = room:askForPlayerChosen(source, targets_2, self:objectName())
            if target then
                target:throwAllEquips()
            end
        elseif choice == "sfofl_boss_xiuluo_Discard_handcard" then
            room:setPlayerFlag(source, "sfofl_boss_xiuluo_Discard_handcard")
            local target = room:askForPlayerChosen(source, targets_3, self:objectName())
            room:setPlayerFlag(source, "-sfofl_boss_xiuluo_Discard_handcard")
            local discards = sgs.IntList()

            local max = math.floor(target:getCards("h"):length()/2)

            for i = 1, max do--进行多次执行
                local id = room:askForCardChosen(source, target, "h", "sfofl_boss_xiuluo",
                    false,--选择卡牌时手牌不可见
                    sgs.Card_MethodDiscard,--设置为弃置类型
                    discards,--将子卡表设置为不可选卡牌id表（保证每张卡只能被选择一次）
                    false)--只有执行过一次选择才可取消
                if id < 0 then break end--如果卡牌id无效就结束多次执行
                discards:append(id)--将选择的id添加到虚拟卡的子卡表
            end

            room:throwCard(discards, "sfofl_boss_xiuluo", target, source)
        end
    end
}
sfofl_boss_xiuluo = sgs.CreateOneCardViewAsSkill {
    name = "sfofl_boss_xiuluo",
    expand_pile = "sfofl_boss_zhanyi",
    filter_pattern = ".|.|.|sfofl_boss_zhanyi",
    view_as = function(self, card)
		local zhiheng_card = sfofl_boss_xiuluoCard:clone()
		zhiheng_card:addSubcard(card)
		return zhiheng_card
	end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_boss_xiuluo")
    end,
}


sfofl_boss_lvbu:addSkill(sfofl_boss_change_lvbu)
sfofl_boss_lvbu:addSkill("wushuang")
sfofl_boss_lvbu:addSkill(sfofl_boss_hanzhan)
sfofl_boss_lvbu:addSkill(sfofl_boss_feijun)
sfofl_boss_lvbu:addSkill(sfofl_boss_feijunClear)
extension_s:insertRelatedSkills("sfofl_boss_feijun", "#sfofl_boss_feijunClear")
if not sgs.Sanguosha:getSkill("sfofl_boss_wushuang") then skills:append(sfofl_boss_wushuang) end
if not sgs.Sanguosha:getSkill("sfofl_boss_hanzhan_2") then skills:append(sfofl_boss_hanzhan_2) end
if not sgs.Sanguosha:getSkill("sfofl_boss_xiuluo") then skills:append(sfofl_boss_xiuluo) end
sfofl_boss_lvbu:addRelateSkill("sfofl_boss_wushuang")
sfofl_boss_lvbu:addRelateSkill("sfofl_boss_hanzhan_2")
sfofl_boss_lvbu:addRelateSkill("sfofl_boss_xiuluo")

sfofl_boss_zhangfei = sgs.General(extension_s, "sfofl_boss_zhangfei", "shu", 8, true, hide_boss)

--[[
	技能名：形态转换
	相关武将：张飞[官盗]
	技能描述：当你的“杀意”牌达到五张或体力值小于等于4时，进入历战形态。
	引用：sfofl_boss_change_zhangfei
]] --
sfofl_boss_change_zhangfei = sgs.CreateTriggerSkill{
    name = "sfofl_boss_change_zhangfei",
    frequency = sgs.Skill_Compulsory,
    events = {sgs.CardsMoveOneTime, sgs.HpChanged, sgs.MaxHpChanged},
    on_trigger = function(self,event,player,data)
        local room = player:getRoom()
        local can_invoke = false
        if event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            if move.to_place == sgs.Player_PlaceSpecial and move.to_pile_name == "sfofl_boss_shayi"
            and move.to:objectName() == player:objectName()
            then
                can_invoke = true
            elseif move.from_places:contains(sgs.Player_PlaceSpecial)
            and table.contains(move.from_pile_names,"sfofl_boss_shayi")
            and move.from:objectName() == player:objectName()
            then
                can_invoke = true
            end
        else
            can_invoke = true
        end
        if can_invoke then
            if player:getPile("sfofl_boss_shayi"):length() >= 5 or player:getHp() <= 4 then
                room:handleAcquireDetachSkills(player,"sfofl_boss_beizhan|sfofl_boss_shajue|sfofl_boss_numu")
                room:handleAcquireDetachSkills(player,"-sfofl_boss_shayi|-paoxiao|-tenyeartishen")
            else
                room:handleAcquireDetachSkills(player,"-sfofl_boss_beizhan|-sfofl_boss_shajue|-sfofl_boss_numu")
                room:handleAcquireDetachSkills(player,"sfofl_boss_shayi|paoxiao|tenyeartishen")
            end
        
        end
        return false
    end
}
    
--[[
	技能名：杀意
	相关武将：张飞[官盗]
	技能描述：你的回合内，你的【杀】进入弃牌堆时，你可以将其放在你的武将牌上，称为“杀意”牌。
	引用：sfofl_boss_shayi
]] --
sfofl_boss_shayi = sgs.CreateTriggerSkill{
    name = "sfofl_boss_shayi",
    events = {sgs.BeforeCardsMove},
    on_trigger = function(self,event,player,data,room)
        if (event == sgs.BeforeCardsMove) then
            local move = data:toMoveOneTime()
            if player:getPhase() == sgs.Player_NotActive then return end
            local basic = bit32.band(move.reason.m_reason, sgs.CardMoveReason_S_MASK_BASIC_REASON)
            if move.from_places:contains(sgs.Player_PlaceTable) and move.to_place == sgs.Player_DiscardPile and
                ((basic == sgs.CardMoveReason_S_REASON_USE) or (basic == sgs.CardMoveReason_S_REASON_RESPONSE)) then
                local card = move.reason.m_extraData:toCard()
		        if not card then return false end
                if card:isKindOf("Slash") then
                    local from = room:findPlayerByObjectName(move.reason.m_playerId)
                    if from:objectName() == player:objectName() then
                        room:sendCompulsoryTriggerLog(player,self:objectName())
                        local ids = sgs.IntList()
                        ids:append(card:getEffectiveId())
                        move:removeCardIds(ids)
                        data:setValue(move)
                        player:addToPile("sfofl_boss_shayi", card:getEffectiveId())
                    end
                end
            end	
            if (move.from == nil) or (move.from:objectName() ~= player:objectName()) then return false end
            if ((move.from_places:contains(sgs.Player_PlaceHand) or  move.from_places:contains(sgs.Player_PlaceEquip)) and move.to_place == sgs.Player_DiscardPile) then
                for i,id in sgs.list(move.card_ids)do
                    if sgs.Sanguosha:getCard(id):isKindOf("Slash") then
                        room:sendCompulsoryTriggerLog(player,self:objectName())
                        local ids = sgs.IntList()
                        ids:append(id)
                        move:removeCardIds(ids)
                        data:setValue(move)
                        player:addToPile("sfofl_boss_shayi", id)
                    end
                end
            end
        end
    end
}
--[[
	技能名：备战
	相关武将：张飞[官盗]
	技能描述：摸牌阶段，你每有一张红色“杀意”牌，额外摸一张牌。
	引用：sfofl_boss_beizhan
]] --
sfofl_boss_beizhan = sgs.CreateTriggerSkill {
    name = "sfofl_boss_beizhan",
    frequency = sgs.Skill_Frequent,
    events = { sgs.DrawNCards },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local draw = data:toDraw()
        if draw.reason ~= "draw_phase" then return false end
        room:sendCompulsoryTriggerLog(player, self:objectName(), true)
        local x = 0
        if not player:getPile("sfofl_boss_shayi"):isEmpty() then
            for _,c in sgs.qlist(player:getPile("sfofl_boss_shayi")) do
                if sgs.Sanguosha:getCard(c):isRed() then
                    x = x + 1
                end
            end
        end
        draw.num = draw.num + x
        data:setValue(draw)
    end
}
    

--[[
	技能名：杀绝
	相关武将：张飞[官盗]
	技能描述：出牌阶开始时，你可以将弃置任意张“杀意”牌，根据你弃置的数量，你于本回合获得以下效果：一张，摸两张牌；两张，获得咆哮；三张，获得一名其他角色手牌区与装备区各一张牌。
	引用：sfofl_boss_shajue
]] --
sfofl_boss_shajueCard = sgs.CreateSkillCard {
    name = "sfofl_boss_shajue",
    target_fixed = true,
    will_throw = false,
    on_use = function(self, room, source, targets)
        local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_REMOVE_FROM_PILE, "", self:objectName(), "")
		room:throwCard(self, reason, nil)
        source:drawCards(2)
        if self:subcardsLength() >= 2 then
            room:acquireOneTurnSkills(source,"sfofl_boss_shajue","tenyearpaoxiao")
        end
        if self:subcardsLength() >= 3 then
            local target = room:askForPlayerChosen(source, room:getOtherPlayers(source), self:objectName(),
            "sfofl_boss_shajue-invoke", true, true)
            if not target then return false end
            if not target:isKongcheng() then
                local card_id = room:askForCardChosen(source, target, "h", self:objectName())
                room:obtainCard(source, card_id)
            end
            if target:getEquips():length() > 0 then
                local card_id = room:askForCardChosen(source, target, "e", self:objectName())
                room:obtainCard(source, card_id)
            end
        end
    end
}
sfofl_boss_shajueVS = sgs.CreateViewAsSkill {
    name = "sfofl_boss_shajue",
    n = 999,
    expand_pile = "sfofl_boss_shayi",
    view_filter = function(self, selected, to_select)
        return sgs.Self:getPile("sfofl_boss_shayi"):contains(to_select:getId())
    end,
    view_as = function(self, cards)
        if #cards > 0 then
            local sfofl_boss_shajue = sfofl_boss_shajueCard:clone()
            for i = 1, #cards, 1 do
                sfofl_boss_shajue:addSubcard(cards[i]:getId())
            end
            return sfofl_boss_shajue
        end
    end,
    enabled_at_play = function(self, player)
        return false
    end,
    enabled_at_response = function(self, player, pattern)
        return pattern == "@@sfofl_boss_shajue"
    end

}
sfofl_boss_shajue = sgs.CreateTriggerSkill {
    name = "sfofl_boss_shajue",
    view_as_skill = sfofl_boss_shajueVS,
    --frequency = sgs.Skill_Frequent,
    events = { sgs.EventPhaseStart },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.EventPhaseStart then
            if player:getPhase() == sgs.Player_Play and player:hasSkill(self:objectName()) and player:getPile("sfofl_boss_shayi"):length() > 0 then
                if room:askForUseCard(player, "@@sfofl_boss_shajue", "@sfofl_boss_shajue") then
                    room:broadcastSkillInvoke(self:objectName())
                end
                
            end
        end
    end,
}
--[[
	技能名：怒目
	相关武将：张飞[官盗]
	技能描述：以你为目标的【杀】未对你造成伤害时，你可以摸一张牌，然后将一张手牌当做“杀意”牌放在你武将牌上。
	引用：sfofl_boss_numu
]] --
sfofl_boss_numu = sgs.CreateTriggerSkill{
    name = "sfofl_boss_numu",
    events = {sgs.TargetConfirming,sgs.CardFinished},
--	frequency = sgs.Skill_Compulsory,
    can_trigger = function(self, target)
		return target and target:isAlive()
	end,
    on_trigger = function(self,event,player,data)
        local room = player:getRoom()
        if event==sgs.TargetConfirming then
            local use = data:toCardUse()
            if (use.card:isKindOf("Slash")) and use.to:contains(player) and player:hasSkill(self:objectName()) then
                player:addMark("sfofl_boss_numu"..use.card:toString())
            end
        elseif event==sgs.CardFinished then
            local use = data:toCardUse()
            if not (use.card:isKindOf("Slash")) then return false end
            for _,owner in sgs.list(room:findPlayersBySkillName(self:objectName()))do
                if owner:getMark("sfofl_boss_numu"..use.card:toString())>0 then
                    owner:removeMark("sfofl_boss_numu"..use.card:toString())
                    if use.card:hasFlag("DamageDone_"..owner:objectName()) then continue end
                    if room:askForSkillInvoke(player, self:objectName(), data) then
                        owner:drawCards(1, self:objectName())
                        local exchange_card = room:askForExchange(owner, "sfofl_boss_numu", 1, 1)
                        owner:addToPile("sfofl_boss_shayi", exchange_card:getSubcards())
                    end
                end
            end
        end
    end,
}
   
sfofl_boss_zhangfei:addSkill(sfofl_boss_change_zhangfei)
sfofl_boss_zhangfei:addSkill("paoxiao")
sfofl_boss_zhangfei:addSkill("tenyeartishen")
sfofl_boss_zhangfei:addSkill(sfofl_boss_shayi)
if not sgs.Sanguosha:getSkill("sfofl_boss_beizhan") then skills:append(sfofl_boss_beizhan) end
if not sgs.Sanguosha:getSkill("sfofl_boss_shajue") then skills:append(sfofl_boss_shajue) end
if not sgs.Sanguosha:getSkill("sfofl_boss_numu") then skills:append(sfofl_boss_numu) end
sfofl_boss_zhangfei:addRelateSkill("sfofl_boss_beizhan")
sfofl_boss_zhangfei:addRelateSkill("sfofl_boss_shajue")
sfofl_boss_zhangfei:addRelateSkill("sfofl_boss_numu")

sfofl_zhouji = sgs.General(extension_e, "sfofl_zhouji", "wu", 3, false)

--[[
	技能名：炎谋
	相关武将：周姬[官盗]
	技能描述：当其他角色的【火攻】、火【杀】因弃置或判定而置入弃牌堆后，你可以获得之；当你获得牌后，你可以使用其中一张【火攻】或火【杀】。
	引用：sfofl_yanmouz
]] --
sfofl_yanmouz = sgs.CreateTriggerSkill {
    name = "sfofl_yanmouz",
    frequency = sgs.Skill_Frequent,
    events = { sgs.BeforeCardsMove, sgs.CardsMoveOneTime },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local move = data:toMoveOneTime()
        if event == sgs.BeforeCardsMove then
            if (move.from == nil) or (move.from:objectName() == player:objectName()) then return false end
            if (move.to_place == sgs.Player_DiscardPile)
                and ((bit32.band(move.reason.m_reason, sgs.CardMoveReason_S_MASK_BASIC_REASON) == sgs.CardMoveReason_S_REASON_DISCARD)
                    or (move.reason.m_reason == sgs.CardMoveReason_S_REASON_JUDGEDONE)) then
                local card_ids = sgs.IntList()
                local i = 0
                for _, card_id in sgs.qlist(move.card_ids) do
                    if (sgs.Sanguosha:getCard(card_id):isKindOf("FireSlash") or sgs.Sanguosha:getCard(card_id):isKindOf("FireAttack"))
                        and (((move.reason.m_reason == sgs.CardMoveReason_S_REASON_JUDGEDONE)
                                and (move.from_places:at(i) == sgs.Player_PlaceJudge)
                                and (move.to_place == sgs.Player_DiscardPile))
                            or ((move.reason.m_reason ~= sgs.CardMoveReason_S_REASON_JUDGEDONE)
                                and (room:getCardOwner(card_id):objectName() == move.from:objectName())
                                and ((move.from_places:at(i) == sgs.Player_PlaceHand) or (move.from_places:at(i) == sgs.Player_PlaceEquip)))) then
                        card_ids:append(card_id)
                    end
                    i = i + 1
                end
                if card_ids:isEmpty() then
                    return false
                elseif player:askForSkillInvoke(self:objectName(), data) then
                    if not card_ids:length() == 1 then
                        while not card_ids:isEmpty() do
                            room:fillAG(card_ids, player)
                            local id = room:askForAG(player, card_ids, true, self:objectName())
                            if id == -1 then
                                room:clearAG(player)
                                break
                            end
                            card_ids:removeOne(id)
                            room:clearAG(player)
                        end
                    end
                    local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                    if not card_ids:isEmpty() then
                        move:removeCardIds(card_ids)
                        data:setValue(move)
                        for _, id in sgs.qlist(card_ids) do
                            if move.card_ids:contains(id) then
                                -- move.from_places:removeAt(listIndexOf(move.card_ids, id))
                                -- move.card_ids:removeOne(id)
                                -- data:setValue(move)
                            end
                            dummy:addSubcard(id)
                            --room:moveCardTo(sgs.Sanguosha:getCard(id), player, sgs.Player_PlaceHand, move.reason, true)
                            if not player:isAlive() then break end
                        end
                    end
                    room:obtainCard(player, dummy)
                    dummy:deleteLater()
                end
            end
        elseif event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            if move.to and (move.to:objectName() == player:objectName())
                and player:hasSkill(self:objectName()) and not player:hasFlag("sfofl_yanmouz_using") --預防一下插結
                and (move.to_place == sgs.Player_PlaceHand) then
                local card_ids = {}
                for _,id in sgs.qlist(move.card_ids) do
                    if sgs.Sanguosha:getCard(id):isKindOf("FireSlash") or sgs.Sanguosha:getCard(id):isKindOf("FireAttack") then
                       table.insert(card_ids,id)
                    end
                end
                if #card_ids > 0 then
                    room:setPlayerFlag(player, "sfofl_yanmouz_using")
                    if room:askForUseCard(player, table.concat(card_ids, ","), "@sfofl_yanmouz") then
                    end
                    room:setPlayerFlag(player, "-sfofl_yanmouz_using")
                end
            end
        end
        return false
    end
}

--[[
	技能名：绽焰
	相关武将：周姬[官盗]
	技能描述：出牌阶段限一次，你可以令你攻击范围内的所有角色依次选择一项：1.你对其造成1点火焰伤害；2.将手牌或弃牌堆中的一张【火攻】或火【杀】置于牌堆顶。选择完成后，你摸X张牌（X为被选择次数较少的项被选择的次数）。
	引用：sfofl_zhanyan
]] --
sfofl_zhanyanCard = sgs.CreateSkillCard{
    name = "sfofl_zhanyan",
    target_fixed = true,
    on_use = function(self, room, source, targets)
        local targets = sgs.SPlayerList()
        for _,p in sgs.qlist(room:getAlivePlayers()) do
            if source:inMyAttackRange(p) then
                targets:append(p)
            end
        end
        if not targets:isEmpty() then
            room:sortByActionOrder(targets)
            local x, y = 0, 0
            local dest = sgs.QVariant()
            dest:setValue(source)
            for _,p in sgs.qlist(targets) do
                local card = room:askForCard(p, "FireSlash,FireAttack", "@sfofl_zhanyan:"..source:objectName(), dest, sgs.Card_MethodNone)
                if not card then
                    local ids = sgs.IntList()
                    for _,id in sgs.qlist(room:getDiscardPile()) do
                        local dcard = sgs.Sanguosha:getCard(id)
                        if dcard:isKindOf("FireSlash") or dcard:isKindOf("FireAttack") then
                            ids:append(dcard:getEffectiveId())
                        end
                    end
                    if not ids:isEmpty() then
                        room:setTag("sfofl_zhanyan", dest)
                        room:fillAG(ids, p)
						local cid = room:askForAG(p, ids, false, self:objectName())
						room:clearAG(p)
                        room:removeTag("sfofl_zhanyan")
						if cid ~= -1 then
                            card = sgs.Sanguosha:getCard(cid)
                        end
                    end
                end
                if not card then
                    x = x + 1
                    local damage = sgs.DamageStruct()
                    damage.from = source
                    damage.to = p
                    damage.damage = 1
                    damage.nature = sgs.DamageStruct_Fire
                    room:damage(damage)
                else
                    y = y + 1
                    local ids = sgs.IntList()
                    ids:append(card:getEffectiveId())
                    local move = sgs.CardsMoveStruct()
					move.card_ids = ids
					move.to_place = sgs.Player_DrawPile
					local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_PUT, p:objectName(), "sfofl_zhanyan", "");
					move.reason = reason	
					room:setPlayerFlag(p, "Global_GongxinOperator")
					room:moveCardsAtomic(move,false)
					room:setPlayerFlag(p, "-Global_GongxinOperator")
                    local log = sgs.LogMessage()
                    log.type = "$PutCard2"
                    log.from = p
                    log.card_str = table.concat(sgs.QList2Table(card:getSubcards()), "+")
                    room:sendLog(log)
                    room:returnToTopDrawPile(ids)
                end
            end
            source:drawCards(math.min(x,y))
        end
    end
}
sfofl_zhanyan = sgs.CreateViewAsSkill{
    name = "sfofl_zhanyan",
    n = 0,
    view_as = function(self, cards)
        local card = sfofl_zhanyanCard:clone()
        return card
    end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_zhanyan")
    end
}
    
--[[
	技能名：驭火
	相关武将：周姬[官盗]
	技能描述：锁定技，防止你受到的火焰伤害；你手牌中的【火攻】和火【杀】不计入手牌上限。
	引用：sfofl_yuhuo
]] --
sfofl_yuhuo = sgs.CreateTriggerSkill {
    name = "sfofl_yuhuo",
    frequency = sgs.Skill_Compulsory,
    events = { sgs.DamageInflicted },
    on_trigger = function(self, event, player, data)
        local damage = data:toDamage()
        local room = player:getRoom()
        if event == sgs.DamageInflicted then
            if damage.nature == sgs.DamageStruct_Fire then
                if player:hasSkill(self:objectName()) then
                    damage.prevented = true
                    data:setValue(damage)
                    local log = sgs.LogMessage()
                    log.type  = "#SkillNullifyDamage"
                    log.from  = player
                    log.arg   = self:objectName()
                    log.arg2  = damage.damage
                    room:sendLog(log)
                    return true
                end
            end
        elseif (event == sgs.CardsMoveOneTime) then
            local move = data:toMoveOneTime()
            if move.to and (move.to:objectName() == player:objectName())
                and player:hasSkill(self:objectName())
                and (move.to_place == sgs.Player_PlaceHand) then
                for _,id in sgs.qlist(move.card_ids) do
                    if sgs.Sanguosha:getCard(id):isKindOf("FireSlash") or sgs.Sanguosha:getCard(id):isKindOf("FireAttack") then
                        room:ignoreCards(player, sgs.Sanguosha:getCard(id))
                    end
                end
            end
        end
    end
}
sfofl_zhouji:addSkill(sfofl_yanmouz)
sfofl_zhouji:addSkill(sfofl_zhanyan)
sfofl_zhouji:addSkill(sfofl_yuhuo)

sfofl_ehuan = sgs.General(extension_e, "sfofl_ehuan", "qun+shu", 5)

--[[
	技能名：敌万
	相关武将：鄂焕[官盗]
	技能描述：每回合限一次，当你使用【杀】指定目标后，你可以摸X张牌（X为此牌的目标数）。
	引用：sfofl_diwan
]] --
sfofl_diwan = sgs.CreateTriggerSkill{
    name = "sfofl_diwan",
    events = {sgs.TargetSpecified},
    on_trigger = function(self,event,player,data)
        local room = player:getRoom()
        local use = data:toCardUse()
        if not use.card:isKindOf("Slash") then return false end
        if player:getMark("sfofl_diwan-Clear") > 0 then return false end
        if room:askForSkillInvoke(player,self:objectName(),data) then
            room:addPlayerMark(player, "sfofl_diwan-Clear")
            player:drawCards(use.to:length() , self:objectName())
        end
        return false
    end
}
--[[
	技能名：随乱
	相关武将：鄂焕[官盗]
	技能描述：群势力技，你使用【杀】可以多指定至多两个目标，若如此做，此【杀】结算后，所有目标角色依次可以对你使用一张【杀】，当你以此法受到伤害后，你变更势力至蜀。
	引用：sfofl_suiluan
]] --
sfofl_suiluan = sgs.CreateTriggerSkill{
    name = "sfofl_suiluan",
    events = {sgs.TargetSpecifying,sgs.CardFinished, sgs.Damaged},
    frequency = sgs.Skill_NotFrequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.TargetSpecifying then
            local use = data:toCardUse()
            if use.card:isKindOf("Slash") and player:getKingdom() == "qun" then
                local targets = sgs.SPlayerList()
                for _, target in sgs.qlist(room:getOtherPlayers(player)) do
                    if player:canSlash(target, use.card, true) and not use.to:contains(target) then
                        targets:append(target)
                    end
                end
                if not targets:isEmpty() then
                    room:setTag("sfofl_suiluan", data)
                    local others = room:askForPlayersChosen(player, targets, self:objectName(), 0, 2, "@sfofl_suiluan:"..use.card:objectName(), true, true)
                    room:removeTag("sfofl_suiluan")
                    if not others then return false end
                    for _, p in sgs.qlist(others) do
                        use.to:append(p)
                    end
                    room:sortByActionOrder(use.to)
                    data:setValue(use)
                    room:setCardFlag(use.card, "sfofl_suiluan")
                end
            end
        elseif event == sgs.CardFinished then
            local use = data:toCardUse()
            if use.card:isKindOf("Slash") and use.card:hasFlag("sfofl_suiluan") and player:isAlive() then
                for _, p in sgs.qlist(use.to) do
                    room:askForUseSlashTo(p, use.from, "@sfofl_suiluan_target:"..use.from:objectName(), false, false, false, nil, nil, "sfofl_suiluan_target")
                    if not player:isAlive() then
                        break
                    end
                end
            end
        elseif event == sgs.Damaged then
            local damage = data:toDamage()
            if damage.card and damage.card:isKindOf("Slash") and damage.card:hasFlag("sfofl_suiluan_target") then
                room:setPlayerProperty(player, "kingdom", sgs.QVariant("shu"))
            end
        end
    end,
}
--[[
	技能名：从汉
	相关武将：鄂焕[官盗]
	技能描述：蜀势力技，当一号位造成伤害后，你可以对受到此伤害的角色使用一张【杀】。
	引用：sfofl_conghan
]] --
sfofl_conghan = sgs.CreateTriggerSkill{
    name = "sfofl_conghan",
    frequency = sgs.Skill_NotFrequent,
    events = {sgs.Damaged},
    can_trigger = function(self, target)
        return target
    end,
    on_trigger = function(self, event, player, data, room)
        local damage = data:toDamage()
        if damage.from and damage.from:isAlive() and damage.from:getSeat() == 1 then
            if damage.to and damage.to:isAlive() then
                for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if p:getKingdom() == "shu" then
                        room:askForUseSlashTo(p, damage.to, "@sfofl_conghan:"..damage.to:objectName())
                    end
                end
            end
        end
    end
}
sfofl_ehuan:addSkill(sfofl_diwan)
sfofl_ehuan:addSkill(sfofl_suiluan)
sfofl_ehuan:addSkill(sfofl_conghan)

sfofl_sunlang = sgs.General(extension_s, "sfofl_sunlang", "shu", 4)

--[[
	技能名：奔矢
	相关武将：李傕[官盗]
	技能描述：锁定技，若你的装备区没有武器牌，你的攻击范围+1；你使用【杀】时，你攻击范围内所有角色均成为目标。
	引用：sfofl_benshi
]] --
sfofl_benshi_buff = sgs.CreateAttackRangeSkill{
	name = "#sfofl_benshi_buff",
	extra_func = function(self, player, include_weapon)
		if player:hasSkill("sfofl_benshi") and player:getWeapon() == nil  then
			return 1
		end
	end,
}
sfofl_benshi = sgs.CreateTriggerSkill{
    name = "sfofl_benshi",
    frequency = sgs.Skill_Compulsory,
    events = {sgs.CardUsed},
    on_trigger = function(self, event, player, data, room)
        local use = data:toCardUse()
        if not use.card:isKindOf("Slash") then return false end
        local log = sgs.LogMessage()
        log.type  = "#BenshiExtra"
        log.from  = player
        log.arg   = self:objectName()
        for _, p in sgs.qlist(room:getAllPlayers()) do
           if use.to:contains(p) or not player:inMyAttackRange(p) or not player:canSlash(p, use.card) then
                continue
           end
           room:doAnimate(1, player:objectName(), p:objectName())
           log.to:append(p)
        end
        if log.to:isEmpty() then return false end
        room:sendLog(log)
        player:peiyin(self)
        room:notifySkillInvoked(player, self:objectName())
        for _, p in sgs.qlist(log.to) do
            use.to:append(p)
        end
        room:sortByActionOrder(use.to)
        data:setValue(use)
        return false
    end
}

sfofl_sunlang:addSkill("tingxian")
sfofl_sunlang:addSkill(sfofl_benshi)
sfofl_sunlang:addSkill(sfofl_benshi_buff)
extension_s:insertRelatedSkills("sfofl_benshi", "#sfofl_benshi_buff")


sfofl_guannin = sgs.General(extension_s, "sfofl_guannin", "shu", 3)

--[[
	技能名：龙诵
	相关武将：关宁[官盗]
	技能描述：出牌阶段开始时，你可以交给或获得一名其他角色一张红色牌，然后你本阶段视为拥有该角色的“出牌阶段”的技能直到你发动之。
	引用：sfofl_longsong
]] --
sfofl_longsongVS = sgs.CreateViewAsSkill{
    name = "sfofl_longsong",
    response_pattern = "@@sfofl_longsong",
    n = 1,
    view_filter = function(self, selected, to_select)
        return to_select:isRed() and #selected < 1
    end,
    view_as = function(self, cards)
        local card = sfofl_longsongCard:clone()
        if #cards == 1 then
            card:addSubcard(cards[1])
        end
        return card
    end,
    enabled_at_play = function(self, player)
        return false
    end
}

sfofl_longsongCard = sgs.CreateSkillCard{
    name = "sfofl_longsong",
    will_throw = false,
    filter = function(self, targets, to_select,player)
        if self:subcardsLength() == 0 then
            local red = sgs.IntList()
            for _,c in sgs.list(to_select:getEquips())do
                if c:isRed() then
                    red:append(c:getEffectiveId())
                end
            end
            for _,c in sgs.list(to_select:getHandcards())do
                if c:isRed() then
                    red:append(c:getEffectiveId())
                end
            end
                
            return #targets < 1 and to_select:objectName() ~= player:objectName() and red:length() > 0
        end
        return #targets < 1 and to_select:objectName() ~= player:objectName()
    end,
    on_effect = function(self, effect)
        local room = effect.from:getRoom()
        if self:subcardsLength() > 0 then
            effect.to:obtainCard(self, true)
        else
            local disable = sgs.IntList()
			for _, card in sgs.qlist(effect.to:getHandcards()) do
				if card:isBlack() then
					disable:append(card:getEffectiveId())
				end
			end
            local id = room:askForCardChosen(effect.from, effect.to, "he", self:objectName(), true, sgs.Card_MethodNone, disable)
            room:obtainCard(effect.from, sgs.Sanguosha:getCard(id), true)
        end
        local skills = effect.to:getVisibleSkillList()
        local skillnames = {}
        for _,s in sgs.qlist(skills) do
            local skillname = s:objectName()
            if (not s:isAttachedLordSkill()) and (not effect.from:hasSkill(skillname)) then
                local translation = sgs.Sanguosha:translate(":"..skillname)
                if string.find(translation,"出牌阶段") then
                    table.insert(skillnames,skillname)
                    room:acquireSkill(effect.from, skillname)
                end
            end
        end
        if #skillnames > 0 then
            effect.from:setTag("sfofl_longsong_skills", sgs.QVariant(table.concat(skillnames,"+")))
        end
    end
}

sfofl_longsong = sgs.CreateTriggerSkill{
    name = "sfofl_longsong",
    events = {sgs.EventPhaseStart,sgs.EventPhaseEnd,sgs.InvokeSkill, sgs.CardFinished,sgs.CardUsed,sgs.CardResponded},
    frequency = sgs.Skill_NotFrequent,
    view_as_skill = sfofl_longsongVS,
    priority = 1,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.EventPhaseStart then
            if player:getPhase() ~= sgs.Player_Play then return false end
            room:askForUseCard(player, "@@sfofl_longsong", "@sfofl_longsong")
        end
        if event == sgs.InvokeSkill then
            if player:getPhase() ~= sgs.Player_Play then return false end
            local skillname = data:toString()
            local skills = player:getTag("sfofl_longsong_skills"):toString():split("+")
            if (not skills) or (#skills <= 0) then return false end
            for _,skill in ipairs(skills) do
                if string.find(skillname, skill) and player:hasSkill(skill) then
                    local log = sgs.LogMessage()
                    log.type = "#InvokeSkill"
                    log.from = player
                    log.arg = skillname
                    room:sendLog(log)

                    room:sendCompulsoryTriggerLog(player, self:objectName(), true, true)
                    room:detachSkillFromPlayer(player, skill)
                    table.removeOne(skills, skill)
                    break
                end
            end
            if #skills <= 0 then player:removeTag("sfofl_longsong_skills")
            else player:setTag("sfofl_longsong_skills", sgs.QVariant(table.concat(skills,"+"))) end
        end
        if event == sgs.CardFinished then
            local use = data:toCardUse()
            if player:getPhase() ~= sgs.Player_Play then return false end
            if use.card:isKindOf("SkillCard") then
                local skills = player:getTag("sfofl_longsong_skills"):toString():split("+")
                if (not skills) or (#skills <= 0) then return false end
                for _,skill in ipairs(skills) do
                    if (table.contains(use.card:getSkillNames(), skill)  or string.find(use.card:objectName(), skill)) and player:hasSkill(skill) then
                        local log = sgs.LogMessage()
                        log.type = "#InvokeSkill"
                        log.from = player
                        log.arg = skill
                        room:sendLog(log)

                        room:sendCompulsoryTriggerLog(player, self:objectName(), true, true)
                        room:detachSkillFromPlayer(player, skill)
                        table.removeOne(skills, skill)
                        break
                    end
                end
                if #skills <= 0 then player:removeTag("sfofl_longsong_skills")
                else player:setTag("sfofl_longsong_skills", sgs.QVariant(table.concat(skills,"+"))) end
            end
        end
        if event == sgs.EventPhaseEnd then
            if player:getPhase() ~= sgs.Player_Play then return false end
            local skills = player:getTag("sfofl_longsong_skills"):toString():split("+")
            if (not skills) or (#skills <= 0) then return false end
            local send = true
            for _,skill in ipairs(skills) do
                if player:hasSkill(skill) then
                    if send then
                        room:sendCompulsoryTriggerLog(player, self:objectName(), true, true)
                        send = false
                    end
                    room:detachSkillFromPlayer(player, skill)
                end
            end
            player:removeTag("sfofl_longsong_skills")
        end
        if event == sgs.CardUsed or event == sgs.CardResponded then
            if player:getPhase() ~= sgs.Player_Play then return false end
            local card 
            if event == sgs.CardUsed then
                card = data:toCardUse().card
            else
                card = data:toCardResponse().m_card
            end
            if (not card)  then return false end
            local skillname = card:getSkillName()
            local skills = player:getTag("sfofl_longsong_skills"):toString():split("+")
            if (not skills) or (#skills <= 0) then return false end
            for _,skill in ipairs(skills) do
                if string.find(skillname, skill) and player:hasSkill(skill) then
                    room:sendCompulsoryTriggerLog(player, self:objectName(), true, true)
                    room:detachSkillFromPlayer(player, skill)
                    table.removeOne(skills, skill)
                    break
                end
            end
            if #skills <= 0 then player:removeTag("sfofl_longsong_skills")
            else player:setTag("sfofl_longsong_skills", sgs.QVariant(table.concat(skills,"+"))) end
        end
    end,
    can_trigger = function(self, target)
        return target and target:hasSkill(self:objectName())
    end,
}

sfofl_guannin:addSkill("ny_tenth_xiuwen")
sfofl_guannin:addSkill(sfofl_longsong)


sfofl_liuli = sgs.General(extension_s, "sfofl_liuli", "shu", 3)

--[[
	技能名：抚黎
	相关武将：刘理[官盗]
	技能描述：出牌阶段限一次，你可以展示所有手牌，选择其中有的一种类别全部弃置，然后摸X张牌（X为所有弃置的牌的牌名称字数之合，且不能超过全场手牌数最多角色的手牌数），若你因此弃置了伤害牌，则你可以令一名角色攻击范围减至0直到你的下个回合开始。
	引用：sfofl_fuli
]] --

sfofl_fuli = sgs.CreateZeroCardViewAsSkill
{
    name = "sfofl_fuli",
    view_as = function(self)
        return sfofl_fuliCard:clone()
    end,
    enabled_at_play = function(self, player)
        return (not player:isKongcheng()) and (not player:hasUsed("#sfofl_fuli"))
    end,
}

local function chsize(tmp)
	if not tmp then
		return 0
    elseif tmp > 240 then
        return 4
    elseif tmp > 225 then
        return 3
    elseif tmp > 192 then
        return 2
    else
        return 1
    end
end

local function utf8len(str)
	local length = 0
	local currentIndex = 1
	while currentIndex <= #str do
		local tmp = string.byte(str, currentIndex)
		currentIndex  = currentIndex + chsize(tmp)
		length = length + 1
	end
	return length
end

sfofl_fuliCard = sgs.CreateSkillCard{
    name = "sfofl_fuli",
    target_fixed = true,
    on_use = function(self, room, player, targets)
        local room = player:getRoom()
        local types = {}
        local all = {"BasicCard", "TrickCard", "EquipCard"}
        local show = sgs.IntList()
        for _,card in sgs.qlist(player:getHandcards()) do
            show:append(card:getEffectiveId())
            for _,cardType in ipairs(all) do
                if card:isKindOf(cardType) and (not table.contains(types, cardType)) then
                    table.insert(types, cardType)
                    break
                end
            end
        end
        room:showCard(player, show)

        local choice = room:askForChoice(player, self:objectName(), table.concat(types, "+"))
        local discard = sgs.IntList()
        local draw = 0
        local reduce = false
        for _,card in sgs.qlist(player:getHandcards()) do
            if card:isKindOf(choice) then
                discard:append(card:getEffectiveId())
                local name = sgs.Sanguosha:translate(card:objectName())
                local n = utf8len(name)
                if card:isKindOf("Slash") then n = 1 end
                draw = draw + n
                if card:isDamageCard() then reduce = true end
            end
        end

        local log = sgs.LogMessage()
        log.type = "$DiscardCard"
        log.from = player
        log.card_str = table.concat(sgs.QList2Table(discard), "+")
        room:sendLog(log)
        local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_DISCARD, player:objectName(), self:objectName(), "")
        local move = sgs.CardsMoveStruct(discard, nil, sgs.Player_DiscardPile, reason)
        room:moveCardsAtomic(move, true)

        if player:isDead() then return false end

        local max = 0
        for _,p in sgs.qlist(room:getAlivePlayers()) do
            if p:getHandcardNum() > max then max = p:getHandcardNum() end
        end
        draw = math.min(draw, max)
        player:drawCards(draw, self:objectName())
        if reduce and player:isAlive() then
            local target = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName(), "sfofl_fuli-invoke", true, true)
            if target then
                room:addPlayerMark(target, "&sfofl_fuli", 1)
                room:addPlayerMark(target, "sfofl_fuli_"..player:objectName(), 1)
            end
        end
    end
}

sfofl_fuli_range = sgs.CreateAttackRangeSkill{
    name = "#sfofl_fuli_range",
    fixed_func = function(self, player, include_weapon)
        if player:getMark("&sfofl_fuli") > 0 then
            return 0
        end
        return -1
    end,
}

sfofl_fuli_clear = sgs.CreateTriggerSkill{
    name = "#sfofl_fuli_clear",
    events = {sgs.EventPhaseChanging},
    frequency = sgs.Skill_NotFrequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local change = data:toPhaseChange()
        if change.from == sgs.Player_NotActive then
            for _,p in sgs.qlist(room:getAlivePlayers()) do
                if p:getMark("sfofl_fuli_"..player:objectName()) > 0 then
                    local n = p:getMark("sfofl_fuli_"..player:objectName())
                    room:removePlayerMark(p, "&sfofl_fuli", n)
                    room:setPlayerMark(p, "sfofl_fuli_"..player:objectName(), 0)
                end
            end
        end
    end,
    can_trigger = function(self, target)
        return target and target:isAlive()
    end,
}

--[[
	技能名：德化
	相关武将：刘理[官盗]
	技能描述：锁定技，每轮开始时，你选择一种你可以使用的伤害牌的牌名，视为使用此牌，然后你不能再使用手牌中与之牌名相同的牌（你的手牌上限+X，X为因此不能使用的牌名数），然后若所有伤害牌的牌名均被选择过，你失去此技能，然后本局游戏你的伤害牌不计手牌上限。
	引用：sfofl_dehua
]] --

sfofl_dehuaVS = sgs.CreateZeroCardViewAsSkill
{
    name = "sfofl_dehua",
    response_pattern = "@@sfofl_dehua",
    frequency = sgs.Skill_Compulsory,
    view_as = function(self)
        return sfofl_dehuaCard:clone()
    end,
    enabled_at_play = function(self, player)
        return false
    end
}

sfofl_dehuaCard = sgs.CreateSkillCard
{
    name = "sfofl_dehua",
    handling_method = sgs.Card_MethodUse,
    mute = true,
    filter = function(self, targets, to_select, player) 
		local pattern = player:property("sfofl_dehua_card"):toString()
		local card = sgs.Sanguosha:cloneCard(pattern, sgs.Card_SuitToBeDecided, -1)
		card:setSkillName("sfofl_dehua")
		if card:targetFixed() then
			return false
		end
		local qtargets = sgs.PlayerList()
		for _, p in ipairs(targets) do
			qtargets:append(p)
		end
		return card:targetFilter(qtargets, to_select, player)
	end,
    target_fixed = function(self)		
		local pattern = sgs.Self:property("sfofl_dehua_card"):toString()
		local card = sgs.Sanguosha:cloneCard(pattern, sgs.Card_SuitToBeDecided, -1)
        card:setSkillName("sfofl_dehua")
		return card:targetFixed()
	end,
	feasible = function(self, targets,player)	
		local pattern = player:property("sfofl_dehua_card"):toString()
		local card = sgs.Sanguosha:cloneCard(pattern, sgs.Card_SuitToBeDecided, -1)
		card:setSkillName("sfofl_dehua")
		local qtargets = sgs.PlayerList()
		for _, p in ipairs(targets) do
			qtargets:append(p)
		end
		return card:targetsFeasible(qtargets, player)
	end,
    on_validate = function(self, card_use)
		local player = card_use.from
		local room = player:getRoom()
		local pattern = player:property("sfofl_dehua_card"):toString()
		local card = sgs.Sanguosha:cloneCard(pattern, sgs.Card_SuitToBeDecided, -1)
        card:setSkillName("_sfofl_dehua")

		return card	
	end
}

sfofl_dehua = sgs.CreateTriggerSkill{
    name = "sfofl_dehua",
    events = {sgs.RoundStart},
    frequency = sgs.Skill_Compulsory,
    view_as_skill = sfofl_dehuaVS,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.RoundStart then
            local finds = {"slash"}
            local able = {}
            local unable = player:getTag("sfofl_dehua_used"):toString():split("+")
            if (not unable) or (#unable <= 0) then unable = {} end
            if (#unable > 0) and (table.contains(unable, "slash")) then
            else table.insert(able, "slash") end
            local slashs = {}
            for _,id in sgs.qlist(sgs.Sanguosha:getRandomCards()) do
                local card = sgs.Sanguosha:getCard(id)
                local name = card:objectName()
                if card:isKindOf("Slash") then
                    if (not table.contains(slashs, card:objectName())) then
                        table.insert(slashs, card:objectName())
                    end
                else
                    if (card:isKindOf("BasicCard") or card:isNDTrick())
                    and card:isDamageCard() then
                        if (not table.contains(finds, card:objectName())) then
                            table.insert(finds, card:objectName())
                            if (not table.contains(unable, card:objectName())) then
                                table.insert(able, card:objectName())
                            end
                        end
                    end
                end
            end

            room:sendCompulsoryTriggerLog(player, self:objectName(), true, true)
            local choice = room:askForChoice(player, self:objectName(), table.concat(able, "+"), sgs.QVariant(), table.concat(unable, "+"))
            table.insert(unable, choice)
            if choice == "slash" then 
                choice = room:askForChoice(player, "sfofl_dehua_slash", table.concat(slashs, "+"))
            end
            room:setPlayerProperty(player, "sfofl_dehua_card", sgs.QVariant(choice))
            room:askForUseCard(player, "@@sfofl_dehua", "@sfofl_dehua:"..choice)

            if player:isAlive() then
                local temp = sgs.Sanguosha:cloneCard(choice, sgs.Card_SuitToBeDecided, -1)
                temp:deleteLater()
                local classname = temp:getClassName()
                if temp:isKindOf("Slash") then classname = "Slash" end
                room:setPlayerCardLimitation(player, "use", classname.."|.|.|hand", false)
                room:addPlayerMark(player, "&sfofl_dehua", 1)

                player:setTag("sfofl_dehua_used", sgs.QVariant(table.concat(unable, "+")))

                if #able == 1 then
                    room:detachSkillFromPlayer(player, self:objectName())
                end
            end
        end
    end,
    can_trigger = function(self, target)
        return target and target:hasSkill(self:objectName()) and target:isAlive()
    end,
}

sfofl_dehua_lose = sgs.CreateTriggerSkill{
    name = "#sfofl_dehua_lose",
    events = {sgs.EventLoseSkill},
    frequency = sgs.Skill_NotFrequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.EventLoseSkill then
            if data:toString() == "sfofl_dehua" then
                local unable = player:getTag("sfofl_dehua_used"):toString():split("+")
                if (not unable) or (#unable <= 0) then unable = {} end
                player:removeTag("sfofl_dehua_used")
                room:setPlayerMark(player, "&sfofl_dehua", 0)
                room:setPlayerMark(player, "&sfofl_dehua_lose", 1)

                for _,pattern in ipairs(unable) do
                    if pattern == "slash" then
                        room:removePlayerCardLimitation(player, "use", "Slash|.|.|hand")
                    else
                        local temp = sgs.Sanguosha:cloneCard(pattern, sgs.Card_SuitToBeDecided, -1)
                        temp:deleteLater()
                        local classname = temp:getClassName()
                        room:removePlayerCardLimitation(player, "use", classname.."|.|.|hand")
                    end
                end
            end
        end
    end,
    can_trigger = function(self, target)
        return target and target:isAlive() 
    end,
}

sfofl_dehua_max = sgs.CreateMaxCardsSkill{
    name = "#sfofl_dehua_max",
    extra_func = function(self, target)
        return target:getMark("&sfofl_dehua")
    end,
}

sfofl_dehua_buff = sgs.CreateTriggerSkill{
    name = "#sfofl_dehua_buff",
    events = {sgs.EventPhaseProceeding},
    frequency = sgs.Skill_Compulsory,
    global = true,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.EventPhaseProceeding then
            if player:getPhase() ~= sgs.Player_Discard then return false end
            local damagecard = sgs.IntList()
            for _,card in sgs.qlist(player:getHandcards()) do
                if card:isDamageCard() then
                    damagecard:append(card:getEffectiveId())
                end
            end
            if damagecard:isEmpty() then return false end
            room:ignoreCards(player, damagecard);
		    return false;
        end
    end,
    can_trigger = function(self, target)
        return target and target:isAlive() and target:getMark("&sfofl_dehua_lose") > 0
    end,
}

sfofl_liuli:addSkill(sfofl_fuli)
sfofl_liuli:addSkill(sfofl_fuli_range)
sfofl_liuli:addSkill(sfofl_fuli_clear)
extension_s:insertRelatedSkills("sfofl_fuli","#sfofl_fuli_range")
extension_s:insertRelatedSkills("sfofl_fuli","#sfofl_fuli_clear")
sfofl_liuli:addSkill(sfofl_dehua)
sfofl_liuli:addSkill(sfofl_dehua_lose)
sfofl_liuli:addSkill(sfofl_dehua_max)
sfofl_liuli:addSkill(sfofl_dehua_buff)
extension_s:insertRelatedSkills("sfofl_dehua","#sfofl_dehua_lose")
extension_s:insertRelatedSkills("sfofl_dehua","#sfofl_dehua_max")
extension_s:insertRelatedSkills("sfofl_dehua","#sfofl_dehua_buff")

sfofl_lijue = sgs.General(extension_e, "sfofl_lijue", "qun", 6, true, false, false, 4)

--[[
	技能名：狼袭
	相关武将：李傕[官盗]
	技能描述：准备阶段，你可以选择一名体力值小于你的角色，你对其造成X点伤害（X为你与其体力值之差，至多为2。）
	引用：sfofl_langxi
]] --
sfofl_langxi = sgs.CreatePhaseChangeSkill{
    name = "sfofl_langxi",
    on_phasechange = function(self, player)
        local room = player:getRoom()
        if player:getPhase() == sgs.Player_Start then
            local players = sgs.SPlayerList()
            for _, p in sgs.qlist(room:getAlivePlayers()) do
                if p:getHp() <= player:getHp() and p:objectName() ~= player:objectName() then
                    players:append(p)
                end
            end
            if not players:isEmpty() then
                local target = room:askForPlayerChosen(player, players, self:objectName(), "@langxi-invoke", true, true)
                if target then
                    room:broadcastSkillInvoke(self:objectName())
                    local damage_num = math.min(2, player:getHp()-target:getHp())
                    if damage_num > 0 then
                        room:damage(sgs.DamageStruct(self:objectName(), player, target, damage_num))
                    end
                end
            end
        end
    end
}
sfofl_lijue:addSkill(sfofl_langxi)
sfofl_lijue:addSkill("yisuan")

sfofl_2_caocao = sgs.General(extension_e, "sfofl_2_caocao", "qun", 4)

--[[
	技能名：献刀
	相关武将：曹操[官盗]
	技能描述：每回合限一次，你赠予其他角色牌后，你可以令其本回合不能使用此花色的牌，然后若此牌为：锦囊牌，你摸两张牌；装备牌，你获得其另一张牌；武器牌，你对其造成1点伤害。
	引用：sfofl_xiandao
]] --

sfofl_xiandao = sgs.CreateTriggerSkill{
    name = "sfofl_xiandao",
    events = {sgs.CardsMoveOneTime},
    frequency = sgs.Skill_NotFrequent,
    on_trigger = function(self,event,player,data,room)
        if event==sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            if move.from and player:objectName()==move.from:objectName() and player:getMark("sfofl_xiandao-Clear") == 0 and move.to and move.to:isAlive() then
                local ids = {}
                for _,id in sgs.list(move.card_ids)do
                    if move.to:getTag("PresentCard"):toString()==tostring(id)
                    then table.insert(ids,id) end
                end
                if #ids>0 then
                    local c = sgs.Sanguosha:getCard(ids[1])
                    if room:askForSkillInvoke(player,self:objectName(),data) then
                        local target = room:findPlayerByObjectName(move.to:objectName())
                        room:addPlayerMark(player, "sfofl_xiandao-Clear")
                        room:addPlayerMark(target, "&sfofl_xiandao+to+:+".. c:getSuitString().."_char" .."+#".. player:objectName().."-Clear")
                        room:setPlayerCardLimitation(target,"use",".|"..c:getSuitString(),true)

                        if c:isKindOf("TrickCard") then
                            player:drawCards(2)
                        elseif c:isKindOf("EquipCard") then
                            local remove = sgs.IntList()
                            remove:append(ids[1])
                            local card_id = room:askForCardChosen(player, target, "he", self:objectName(), false, sgs.Card_MethodNone,remove)
                            room:obtainCard(player, card_id)
                            if c:isKindOf("Weapon") then
                                local damage = sgs.DamageStruct()
                                damage.from = player
                                damage.to = target
                                room:damage(damage)
                            end
                        end
                    end
                end
            end
        end
        return false
    end
}

--[[
	技能名：散财
	相关武将：曹操[官盗]
	技能描述：出牌阶段限一次，你可以展示所有手牌，若均为同一类别，你可以将其中一张牌赠予其他角色。
	引用：sfofl_sancai
]] --
sfofl_sancaiCard = sgs.CreateSkillCard{
    name = "sfofl_sancai",
    target_fixed = true,
    on_use = function(self, room, source, targets)
        room:showAllCards(source)
        local hand = source:getHandcards()
        local can_invoke = true
        for _, card in sgs.qlist(hand) do
            for _, card2 in sgs.qlist(hand) do
                if card ~= card2 and card:getTypeId() ~= card2:getTypeId() then
                    can_invoke = false
                    break
                end
            end
        end
        if can_invoke then
            room:askForUseCard(source, "@@sfofl_sancai", "@sfofl_sancai")
        end
    end
}
sfofl_sancai = sgs.CreateViewAsSkill{
    name = "sfofl_sancai",
    n = 1,
    view_filter = function(self, selected, to_select)
		return not to_select:isEquipped() 
	end,
	view_as = function(self, cards)
        if sgs.Sanguosha:getCurrentCardUsePattern() == "@@sfofl_sancai" then
            if #cards == 1 then
                local c = yj_zhengyuCard:clone()
                c:addSubcard(cards[1])
                return c
            end
        else
            local skillcard = sfofl_sancaiCard:clone()
            skillcard:setSkillName(self:objectName())
            return skillcard
        end
    end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_sancai")
    end,
    enabled_at_response = function(self, player, pattern)
		return pattern == "@@sfofl_sancai"
	end,
}
--[[
	技能名：义兵
	相关武将：曹操[官盗]
	技能描述：当你于摸牌阶段外获得牌后，你可以将这些牌当无距离次数限制的【杀】使用，此【杀】结算结束前，你不能发动〖义兵〗。
	引用：sfofl_yibing
]] --
sfofl_yibing = sgs.CreateTriggerSkill{
    name = "sfofl_yibing",
    events = {sgs.CardsMoveOneTime},
    on_trigger = function(self, event, player, data)
        local move = data:toMoveOneTime()
        local room = player:getRoom()
        if not room:getTag("FirstRound"):toBool() and player:getPhase() ~= sgs.Player_Draw and move.to and move.to:objectName() == player:objectName() and not player:hasFlag("sfofl_yibing") then
            local ids = sgs.IntList()
            for _,id in sgs.qlist(move.card_ids) do
                if room:getCardOwner(id) == player and room:getCardPlace(id) == sgs.Player_PlaceHand then
                    ids:append(id)
                end
            end
            if ids:isEmpty() then return false end
            local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
            slash:setSkillName(self:objectName())
            slash:deleteLater()
            slash:addSubcards(ids)
            local targets = sgs.SPlayerList()
            for _,p in sgs.qlist(room:getOtherPlayers(player)) do
                if (player:canSlash(p, false)) then
                    targets:append(p)
                end
            end
            if not targets:isEmpty() then
                room:setTag("sfofl_yibing", data)
                local target = room:askForPlayerChosen(player, targets, self:objectName(), "sfofl_yibing-invoke", true, true)
                room:removeTag("sfofl_yibing")
                if target then
                    room:setPlayerFlag(player, "sfofl_yibing")
                    local use = sgs.CardUseStruct()
                    use.from = player
                    use.card = slash
                    use.to:append(target)
                    room:useCard(use, false)
                    room:setPlayerFlag(player, "-sfofl_yibing")
                end
            end
        end
        return false
    end
}
sfofl_2_caocao:addSkill(sfofl_xiandao)
sfofl_2_caocao:addSkill(sfofl_sancai)
sfofl_2_caocao:addSkill(sfofl_yibing)

sfofl_jiling = sgs.General(extension_e, "sfofl_jiling", "qun", 4)

--[[
	技能名：双刃
	相关武将：纪灵[官盗]
	技能描述：出牌阶段，你可以与一名角色拼点。若你赢，你可以依次视为使用X张【杀】；若你没赢，本回合你的【杀】视为K点的【闪】（X为你本回合拼点赢的次数）。
	引用：sfofl_shuangren
]] --
sfofl_shuangrenCard = sgs.CreateSkillCard{
	name = "sfofl_shuangren",
	target_fixed = false,
	will_throw = false,
	handling_method = sgs.Card_MethodPindian,
	filter = function(self, targets, to_select, player)
		if #targets == 0 then
			if player:canPindian(to_select) then
				return to_select:objectName() ~= player:objectName()
			end
		end
		return false
	end,
	on_effect = function(self, effect)
		local room = effect.from:getRoom()
		local success = effect.from:pindian(effect.to, "sfofl_shuangren")
		if success then
            for i = 1, effect.from:getMark("sfofl_shuangren-Clear"), 1 do
                local targets = sgs.SPlayerList()
                local others = room:getOtherPlayers(effect.from)
                for _,target in sgs.qlist(others) do
                    if effect.from:canSlash(target, nil, false) then
                        targets:append(target)
                    end
                end
                if not targets:isEmpty() then
                    local target = room:askForPlayerChosen(effect.from, targets, self:objectName(), "sfofl_shuangren-slash:"..i..":"..effect.from:getMark("sfofl_shuangren-Clear"))
                    local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                    slash:setSkillName("sfofl_shuangren")
                    slash:deleteLater()
                    local card_use = sgs.CardUseStruct()
                    card_use.card = slash
                    card_use.from = effect.from
                    card_use.to:append(target)
                    room:useCard(card_use, false)
                end
            end
		else
			room:acquireSkill(effect.from, "#sfofl_shuangrenFilter", false)
		    room:filterCards(effect.from, effect.from:getCards("he"), false)
		end
	end
}
sfofl_shuangrenVS = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_shuangren",
	view_as = function(self) 
		return sfofl_shuangrenCard:clone()
	end, 
    enabled_at_play = function(self, player)
        return not player:isKongcheng() and player:canPindian()
    end
}
sfofl_shuangren = sgs.CreateTriggerSkill{
	name = "sfofl_shuangren",
	frequency = sgs.Skill_NotFrequent,
	events = {sgs.Pindian},
	view_as_skill = sfofl_shuangrenVS,
	on_trigger = function(self, event, player, data, room)
        local pindian = data:toPindian()
        local winner
        local loser
        if pindian.from:hasSkill(self:objectName()) and pindian.success then
            winner = pindian.from
            loser = pindian.to
        elseif pindian.to:hasSkill(self:objectName()) and not pindian.success then
            winner = pindian.to
            loser = pindian.from
        end
        if winner then
            room:addPlayerMark(winner, "sfofl_shuangren-Clear")
            room:addPlayerMark(winner, "&sfofl_shuangren-Clear")
        end
        return false
	end
}

sfofl_shuangrenFilter = sgs.CreateFilterSkill {
	name = "#sfofl_shuangrenFilter",
	view_filter = function(self, to_select)
		return to_select:isKindOf("Slash")
	end,
	view_as = function(self, card)
        local jink = sgs.Sanguosha:cloneCard("Jink", card:getSuit(), 13)
		jink:setSkillName(self:objectName())
		local wrap = sgs.Sanguosha:getWrappedCard(card:getId())
		wrap:takeOver(jink)
		return wrap
	end,
}
if not sgs.Sanguosha:getSkill("#sfofl_shuangrenFilter") then skills:append(sfofl_shuangrenFilter) end
sfofl_jiling:addSkill(sfofl_shuangren)


sfofl_yuanshao = sgs.General(extension_s, "sfofl_yuanshao$", "qun", 4)

--[[
	技能名：肃敌
	相关武将：袁绍[官盗]
	技能描述：锁定技，攻击范围内包含你的角色响应你使用的牌后，你摸一张牌。
	引用：sfofl_sudi
]] --
sfofl_sudi = sgs.CreateTriggerSkill{
    name = "sfofl_sudi",
    frequency = sgs.Skill_Compulsory,
    events = {sgs.CardUsed, sgs.CardResponded},
    on_trigger = function(self, event, player, data, room)
        local card
        local target
        if event == sgs.CardUsed then
            local use = data:toCardUse()
            if not data:toCardUse().whocard then
                return false
            end
            card = use.card
            target = use.who
            
        else
            local res = data:toCardResponse()
            if not res.m_toCard then
                return false
            end
            target = res.m_who
            card = data:toCardResponse().m_card
            
        end
        if card and not card:isKindOf("SkillCard") and target and target:isAlive() then
            if target:hasSkill(self:objectName()) and player:inMyAttackRange(target) then
                room:sendCompulsoryTriggerLog(target, self:objectName())
                target:drawCards(1, self:objectName())
            end
        end
    end,
    can_trigger = function(self, target)
		return target
	end,
}

--[[
	技能名：齐射
	相关武将：袁绍[官盗]
	技能描述：游戏开始时，你从游戏外获得一张【万箭齐发】；结束阶段，你可以从弃牌堆获得一张【万箭齐发】。
	引用：sfofl_qishe
]] --
local card = sgs.Sanguosha:cloneCard("archery_attack", sgs.Card_Heart, 1)
card:setObjectName("_archery_attack")
card:setParent(exclusive_cards)
sfofl_qishe = sgs.CreateTriggerSkill{
    name = "sfofl_qishe",
	frequency = sgs.Skill_Frequent,
	events = {sgs.GameStart, sgs.EventPhaseStart},
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
		if event == sgs.GameStart then
			for _,id in sgs.qlist(sgs.Sanguosha:getRandomCards(true))do
                local nmrq = sgs.Sanguosha:getEngineCard(id)
                if nmrq:objectName()~="_archery_attack"
                or room:getCardOwner(id) then continue end
                room:broadcastSkillInvoke(self:objectName(),1)
                room:obtainCard(player,nmrq)
                break
            end
		elseif event == sgs.EventPhaseStart then
			if player:getPhase()==sgs.Player_Finish and room:askForSkillInvoke(player, self:objectName()) then
                for _, id in sgs.qlist(room:getDiscardPile()) do
                    if sgs.Sanguosha:getCard(id):isKindOf("ArcheryAttack") then
                        player:obtainCard(sgs.Sanguosha:getCard(id))
                        break
                    end
                end
			end
		end
	end,
}

--[[
	技能名：临阵
	相关武将：袁绍[官盗]
	技能描述：主公技，锁定技，你视为在其他群势力角色的攻击范围内。
	引用：sfofl_linzhen
]] --

sfofl_linzhen = sgs.CreateTriggerSkill {
    name = "sfofl_linzhen$",
    frequency = sgs.Skill_Compulsory,
    events = { sgs.GameStart, sgs.EventAcquireSkill, sgs.EventLoseSkill },
    on_trigger = function(self, event, player, data, room)
        if event == sgs.EventAcquireSkill and data:toString() == self:objectName() or event == sgs.GameStart then
            local kingdoms = player:property("inMyAttackRangeKingdoms"):toString()
            local _kingdoms
                _kingdoms = kingdoms:split("+")
                if table.contains(_kingdoms, "qun") then
                    return 
                end
                table.insert(_kingdoms, "qun")
                room:setPlayerProperty(player, "inMyAttackRangeKingdoms", sgs.QVariant(table.concat(_kingdoms, "+")))
        elseif event == sgs.EventLoseSkill and data:toString() == self:objectName() then
            local kingdoms = player:property("inMyAttackRangeKingdoms"):toString()
            local _kingdoms
                _kingdoms = kingdoms:split("+")
                if table.contains(_kingdoms, "qun") then
                    table.remove(_kingdoms, "qun")
                    room:setPlayerProperty(player, "inMyAttackRangeKingdoms", sgs.QVariant(table.concat(_kingdoms, "+")))
                end
        end
    end
}

sfofl_yuanshao:addSkill(sfofl_sudi)
sfofl_yuanshao:addSkill(sfofl_qishe)
sfofl_yuanshao:addSkill(sfofl_linzhen)

sfofl_wenchou = sgs.General(extension_s, "sfofl_wenchou", "qun", 4)

--[[
	技能名：血战
	相关武将：文丑[官盗]
	技能描述：锁定技，你的锦囊牌均视为【决斗】；你使用【决斗】不能被【无懈可击】响应。
	引用：sfofl_xuezhan
]] --

sfofl_xuezhan = sgs.CreateFilterSkill{
    name = "sfofl_xuezhan", 
    view_filter = function(self,to_select)
        local room = sgs.Sanguosha:currentRoom()
        local place = room:getCardPlace(to_select:getEffectiveId())
        return (to_select:isKindOf("TrickCard")) and (place == sgs.Player_PlaceHand)
    end,
    view_as = function(self, originalCard)
        local duel = sgs.Sanguosha:cloneCard("duel", originalCard:getSuit(), originalCard:getNumber())
        duel:setSkillName(self:objectName())
        local card = sgs.Sanguosha:getWrappedCard(originalCard:getId())
        card:takeOver(duel)
        return card
    end
}
sfofl_xuezhan_buff = sgs.CreateTriggerSkill{
    name = "#sfofl_xuezhan_buff",
    events = {sgs.CardUsed},
    frequency = sgs.Skill_NotFrequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.CardUsed then
            local use = data:toCardUse()
            if use.card and table.contains(use.card:getSkillNames(), "sfofl_xuezhan") then
                room:sendCompulsoryTriggerLog(player, "sfofl_xuezhan")
                local no_offset_list = use.no_offset_list
                table.insert(no_offset_list, "_ALL_TARGETS")
                use.no_offset_list = no_offset_list
                data:setValue(use)
            end
        end
    end,
    can_trigger = function(self, target)
        return target ~= nil
    end,
}
--[[
	技能名：历阵
	相关武将：文丑[官盗]
	技能描述：你可以将装备区内的牌当【杀】使用或打出。
	引用：sfofl_lizhen
]] --
sfofl_lizhen = sgs.CreateOneCardViewAsSkill{
    name = "sfofl_lizhen",
    response_or_use = true,
    view_filter = function(self, card)
        if not card:isKindOf("EquipCard") then return false end
        if not card:isEquipped() then return false end
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
            local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
            slash:addSubcard(card:getEffectiveId())
            slash:deleteLater()
            return slash:isAvailable(sgs.Self)
        end
        return true
    end,
    view_as = function(self, card)
        local slash = sgs.Sanguosha:cloneCard("slash", card:getSuit(), card:getNumber())
        slash:addSubcard(card:getId())
        slash:setSkillName(self:objectName())
        return slash
    end,
    enabled_at_play = function(self, player)
        return sgs.Slash_IsAvailable(player)
    end, 
    enabled_at_response = function(self, player, pattern)
        return pattern == "slash"
    end
}
sfofl_wenchou:addSkill(sfofl_xuezhan)
sfofl_wenchou:addSkill(sfofl_xuezhan_buff)
extension_s:insertRelatedSkills("sfofl_xuezhan", "#sfofl_xuezhan_buff")
sfofl_wenchou:addSkill(sfofl_lizhen)

sfofl_gongsunzan = sgs.General(extension_s, "sfofl_gongsunzan$", "qun", 4)

--[[
	技能名：骑阵
	相关武将：公孙瓒[官盗]
	技能描述：当你使用【杀】结算后，若此【杀】造成伤害，你摸造成伤害值的牌；若未造成伤害，你弃置每名目标角色装备区的一张牌。
	引用：sfofl_qizhen
]] --
sfofl_qizhen = sgs.CreateTriggerSkill{
    name = "sfofl_qizhen",
    events = {sgs.CardFinished, sgs.Damage},
    frequency = sgs.Skill_NotFrequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.CardFinished then   
            local use = data:toCardUse()
            if use.card:isKindOf("Slash") and room:askForSkillInvoke(player, self:objectName(), data) then
                local x = player:getMark("sfofl_qizhen-Clear")
                room:setPlayerMark(player, "sfofl_qizhen-Clear", 0)
                if use.card:hasFlag("DamageDone") then
                    player:drawCards(x, "sfofl_qizhen")
                    room:setPlayerMark(player, "sfofl_qizhen-Clear", 0)
                else
                    for _, p in sgs.qlist(use.to) do
                        if player:canDiscard(p, "e") then
                            local id = room:askForCardChosen(player, p, "e", "sfofl_qizhen")
				            room:throwCard(id, p, player)
                        end
                    end
                end
            end
        elseif event == sgs.Damage then
            local damage = data:toDamage()
            if damage.card and damage.card:isKindOf("Slash") then
                room:addPlayerMark(player, "sfofl_qizhen-Clear")
            end
        end
    end,
}

--[[
	技能名：募军
	相关武将：公孙瓒[官盗]
	技能描述：主公技，限定技，出牌阶段，你可以令一名群势力角色获得〖义从〗。
	引用：sfofl_mujun
]] --
sfofl_mujunCard = sgs.CreateSkillCard {
    name = "sfofl_mujun",
    target_fixed = false,
    will_throw = false,
    filter = function(self, targets, to_select)
        return (#targets == 0) and (to_select:objectName() ~= sgs.Self:objectName()) and to_select:getKingdom() == "qun"
    end,
    on_use = function(self, room, player, targets)
        room:removePlayerMark(player, "@sfofl_mujun")
        room:handleAcquireDetachSkills(targets[1], "yicong")
    end
}

sfofl_mujunVS = sgs.CreateZeroCardViewAsSkill {
    name = "sfofl_mujun$",
    limit_mark = "@sfofl_mujun",
    enabled_at_play = function(self, player)
        return (player:getMark("@sfofl_mujun") > 0)
    end,
    view_as = function()
        return sfofl_mujunCard:clone()
    end
}
sfofl_mujun = sgs.CreateTriggerSkill{
	name = "sfofl_mujun$",
	events = {},
	frequency = sgs.Skill_Limited,
	limit_mark = "@sfofl_mujun",
	view_as_skill = sfofl_mujunVS,
	on_trigger = function(self, event, player, data)
	end
}



sfofl_gongsunzan:addSkill(sfofl_qizhen)
sfofl_gongsunzan:addSkill("yicong")
sfofl_gongsunzan:addSkill(sfofl_mujun)

sfofl_whitehorse_change = sgs.CreateTriggerSkill{
	name = "#sfofl_whitehorse_change",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.CardsMoveOneTime, sgs.BeforeCardsMove},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
        if (event == sgs.BeforeCardsMove) then
			local move = data:toMoveOneTime()
			if move.from_places:contains(sgs.Player_PlaceEquip) and move.reason.m_skillName~="BreakCard"
			and move.from:objectName()==player:objectName() then
				for i,id in sgs.list(move.card_ids)do
					if move.from_places:at(i)==sgs.Player_PlaceEquip
					and sgs.Sanguosha:getCard(id):isKindOf("WhiteHorse") then
						local ids = sgs.IntList()
						ids:append(id)
						move:removeCardIds(ids)
						data:setValue(move)
						room:breakCard(id,player)
                    end
                end
            end
	    elseif event == sgs.CardsMoveOneTime then
			local move = data:toMoveOneTime()
			if move.to and move.to:objectName() == player:objectName() then
			    if move.to_place == sgs.Player_PlaceEquip then
				    if move.to:objectName() == player:objectName() and player:hasSkill(self:objectName()) then
                        for _, id in sgs.qlist(move.card_ids) do
                            local card = sgs.Sanguosha:getEngineCard(id)
                            if card:isKindOf("EquipCard") and not card:isKindOf("WhiteHorse") then
                                local cards = sgs.IntList()
                                for _,id in sgs.qlist(sgs.Sanguosha:getRandomCards(true)) do
                                    if sgs.Sanguosha:getEngineCard(id):isKindOf("WhiteHorse") and sgs.Sanguosha:getEngineCard(id):getRealCard():toEquipCard():location() == card:getRealCard():toEquipCard():location() then
                                        cards:append(id)
                                    end
                                end
                                if not cards:isEmpty() then
                                    for _, id in sgs.qlist(cards) do
                                        room:useCard(sgs.CardUseStruct(sgs.Sanguosha:getEngineCard(id), player, player), false)
                                        break
                                    end
                                end
                            end
                        end
					end
				end
			end
		end
	end,
	can_trigger = function(self, player)
		return player
	end,
}

sfofl_gongsunzan:addSkill(sfofl_whitehorse_change)

--[[
	技能名：白马骁骑
	相关武将：公孙瓒[官盗]
	技能描述：当你装备区内牌数不小于1时，你攻击范围+X；不小于2时，你的出杀次数+X；不小于3时，你与其他角色计算距离+X；不小于4时，你摸牌数+X（X为你当前装备区的牌数）。 (可疊加?)
	引用：_sfofl_whitehorse_weapon
    sfofl_whitehorse_targetmod
    sfofl_whitehorse_range
    sfofl_whitehorse_distance
    sfofl_whitehorse_weaponTr
]] --
function getWhiteHorse(player)
    local x = 0
    -- for _, e in sgs.qlist(player:getEquips()) do
    --     if e:isKindOf("WhiteHorse")
    --     then x = x + 1 end
    -- end --貌似用不到viewasequip
    if player:hasWeapon("_sfofl_whitehorse_weapon") then
        x = x + 1
    end
    if player:hasArmorEffect("_sfofl_whitehorse_armor") then
        x = x + 1
    end
    if player:hasDefensiveHorse("_sfofl_whitehorse_offensivehorse") then
        x = x + 1
    end
    if player:hasOffensiveHorse("_sfofl_whitehorse_defensivehorse") then
        x = x + 1
    end
    return x
end
sfofl_whitehorse_targetmod = sgs.CreateTargetModSkill {
	name = "#sfofl_whitehorse_targetmod",
	pattern = "Slash",
	residue_func = function(self, player, card)
        local x = player:getEquips():length()
		if player:hasSkill("#_sfofl_whitehorse") and  x >= 2 and getWhiteHorse(player) > 0 then return x * getWhiteHorse(player) end
		return 0
	end,
}
sfofl_whitehorse_range = sgs.CreateAttackRangeSkill {
	name = "#sfofl_whitehorse_range",
	extra_func = function(self, player)
        local x = player:getEquips():length()
		if player:hasSkill("#_sfofl_whitehorse") and x >= 1 and getWhiteHorse(player) > 0 then return x * getWhiteHorse(player) end
	end,
}
sfofl_whitehorse_distance = sgs.CreateDistanceSkill {
	name = "#sfofl_whitehorse_distance",
	correct_func = function(self, from, to)
        local x = from:getEquips():length()
		if from:hasSkill("#_sfofl_whitehorse") and x>=3 and getWhiteHorse(from) > 0 then return x * getWhiteHorse(from) end
        return 0
	end
}
if not sgs.Sanguosha:getSkill("#sfofl_whitehorse_targetmod") then skills:append(sfofl_whitehorse_targetmod) end
if not sgs.Sanguosha:getSkill("#sfofl_whitehorse_range") then skills:append(sfofl_whitehorse_range) end
if not sgs.Sanguosha:getSkill("#sfofl_whitehorse_distance") then skills:append(sfofl_whitehorse_distance) end
sfofl_whitehorseTr = sgs.CreateTriggerSkill{
	name = "#_sfofl_whitehorse",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.DrawNCards},
	can_trigger = function(self,target)
		return target and getWhiteHorse(target) > 0
	end,
	on_trigger = function(self,event,player,data,room)
   		local draw = data:toDraw()
        if draw.reason ~= "draw_phase" then return false end
        local x = player:getEquips():length()
        if x >= 4 then
            draw.num = draw.num + 4 * getWhiteHorse(player)
            data:setValue(draw)
        end
		return false
	end
}
sfofl_whitehorse_weapon = sgs.CreateWeapon{
	name = "_sfofl_whitehorse_weapon",
	class_name = "WhiteHorse",
	range = 1,
	equip_skill = sfofl_whitehorseTr,
	on_install = function(self,player)
		local room = player:getRoom()
		room:acquireSkill(player,sfofl_whitehorseTr,true,true,false)
		return false
	end,
	on_uninstall = function(self,player)
		local room = player:getRoom()
        if getWhiteHorse(player) < 1 then
		    room:detachSkillFromPlayer(player,"#_sfofl_whitehorse",true,true)
        end
		return false
	end,
}
sfofl_whitehorse_weapon:clone(sgs.Card_Spade,13):setParent(extension_card)

sfofl_whitehorse_armor = sgs.CreateArmor{
	name = "_sfofl_whitehorse_armor",
	class_name = "WhiteHorse",
	on_install = function(self, player)
		local room = player:getRoom()
		room:acquireSkill(player,sfofl_whitehorseTr,true,true,false)
	end,
	on_uninstall = function(self, player)
		local room = player:getRoom()
		if getWhiteHorse(player) < 1 then
		    room:detachSkillFromPlayer(player,"#_sfofl_whitehorse",true,true)
        end
	end,
}
sfofl_whitehorse_armor:clone(sgs.Card_Club,13):setParent(extension_card)

sfofl_whitehorse_offensivehorse = sgs.CreateOffensiveHorse{
	name = "_sfofl_whitehorse_offensivehorse",
	class_name = "WhiteHorse",
	on_install = function(self,player)
		local room = player:getRoom()
		room:acquireSkill(player,sfofl_whitehorseTr,true,true,false)
	end,
	on_uninstall = function(self,player)
		local room = player:getRoom()
		if getWhiteHorse(player) < 1 then
		    room:detachSkillFromPlayer(player,"#_sfofl_whitehorse",true,true)
        end
	end
}
sfofl_whitehorse_offensivehorse:clone(sgs.Card_Diamond,13):setParent(extension_card)

sfofl_whitehorse_defensivehorse = sgs.CreateDefensiveHorse{
	name = "_sfofl_whitehorse_defensivehorse",
	class_name = "WhiteHorse",
	on_install = function(c,player)
		local room = player:getRoom()
		room:acquireSkill(player,sfofl_whitehorseTr,true,true,false)
	end,
	on_uninstall = function(c,player)
		local room = player:getRoom()
		if getWhiteHorse(player) < 1 then
		    room:detachSkillFromPlayer(player,"#_sfofl_whitehorse",true,true)
        end
	end
}
sfofl_whitehorse_defensivehorse:clone(sgs.Card_Heart,13):setParent(extension_card)



sfofl_4_zhaoyun = sgs.General(extension_s, "sfofl_4_zhaoyun", "qun", 3)

sfofl_4_zhaoyun:addSkill("longdan")
sfofl_4_zhaoyun:addSkill("chongzhen")
sfofl_4_zhaoyun:addSkill("yicong")

sfofl_gongsunyuan = sgs.General(extension_s, "sfofl_gongsunyuan$", "qun", 4)

--[[
	技能名：旋势
	相关武将：公孙渊[官盗]
	技能描述：出牌阶段限两次，若你的手牌中黑色牌和红色牌数量相同，你可以展示手牌，然后获得一名其他角色的一张牌。
	引用：sfofl_xuanshi
]] --
sfofl_xuanshiCard = sgs.CreateSkillCard{
	name = "sfofl_xuanshi",
	target_fixed = false,
	will_throw = false,
	filter = function(self, targets, to_select)
		if #targets == 0 then
			if not to_select:isNude() then
				return to_select:objectName() ~= sgs.Self:objectName()
			end
		end
		return false
	end,
	on_effect = function(self, effect)
		local room = effect.from:getRoom()
		room:showAllCards(effect.from)
        local card = room:askForCardChosen(effect.from, effect.to, "he", self:objectName())
        room:obtainCard(effect.from, card, false)
	end
}
sfofl_xuanshi = sgs.CreateViewAsSkill{
	name = "sfofl_xuanshi" ,
	n = 0 ,
	view_filter = function(self, selected, to_select)
		return false
	end ,
	view_as = function(self, cards)
		if #cards == 0 then
            local rende_card = sfofl_xuanshiCard:clone()
            return rende_card
        end
	end ,
	enabled_at_play = function(self, player)
        if not player:isKongcheng() and player:usedTimes("#sfofl_xuanshi") < 2 then
            local red = 0
            local black = 0
		    for _,card in sgs.qlist(player:getHandcards()) do
                if card:isRed() then red = red + 1 end
                if card:isBlack() then black = black + 1 end
            end
            if black == red then
                return true
            end
        end
        return false
	end
}

--[[
	技能名：凶业
	相关武将：公孙渊[官盗]
	技能描述：主公技，出牌阶段限一次，你可以交给任意名其他群势力角色各一张手牌，然后对这些角色各造成1点伤害。
	引用：sfofl_xiongye
]] --
sfofl_xiongyeCard = sgs.CreateSkillCard{
	name = "sfofl_xiongye",
	target_fixed = false,
	will_throw = false,
	filter = function(self, targets, to_select, player)
		return #targets < player:getHandcardNum() and to_select:objectName() ~= player:objectName() and to_select:getKingdom() == "qun"
	end,
    feasible = function(self, targets, player)
        return #targets <= player:getHandcardNum() and #targets > 0
    end,
    on_use = function(self, room, source, targets)
        local destlist = {}
		for i,to in ipairs(targets)do
			room:cardEffect(self, source, to)
            table.insert(destlist, to)
            if source:isKongcheng() then break end
		end
        for i,to in ipairs(destlist)do
            room:damage(sgs.DamageStruct("sfofl_xiongye", source, to, 1, sgs.DamageStruct_Normal))
        end
	end ,
	on_effect = function(self, effect)
		local room = effect.from:getRoom()
		if not effect.from:isKongcheng() then
            local card_ex = room:askForCard(effect.from, ".|.|.|hand!", "@sfofl_xiongye:"..effect.to:objectName(), ToData(effect.to), sgs.Card_MethodNone)
            room:obtainCard(effect.to, card_ex, false)
        end
	end
}

sfofl_xiongye = sgs.CreateViewAsSkill{
	name = "sfofl_xiongye$" ,
	n = 0 ,
	view_filter = function(self, selected, to_select)
		return false
	end ,
	view_as = function(self, cards)
		if #cards == 0 then
            local rende_card = sfofl_xiongyeCard:clone()
            return rende_card
        end
	end ,
	enabled_at_play = function(self, player)
       return not player:isKongcheng() and not player:hasUsed("#sfofl_xiongye")
	end
}

sfofl_gongsunyuan:addSkill(sfofl_xuanshi)
sfofl_gongsunyuan:addSkill(sfofl_xiongye)

sfofl_caorui = sgs.General(extension_s, "sfofl_caorui$", "wei", 3)

--[[
	技能名：明鉴
	相关武将：曹叡[官盗]
	技能描述：其他角色出牌阶段开始时，你可以展示手牌并将其中一种花色的所有牌交给该角色，然后其本回合使用的下一张牌额外结算一次。
	引用：sfofl_mingjian
]] --

sfofl_mingjian = sgs.CreateTriggerSkill {
    name = "sfofl_mingjian",
    events = { sgs.EventPhaseStart, sgs.CardFinished, sgs.CardUsed },
    frequency = sgs.Skill_NotFrequent,
    on_trigger = function(self, event, player, data, room)
        local room = player:getRoom()
        if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Play then
            for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                if p and p:objectName() ~= player:objectName() and not p:isKongcheng() and
                    room:askForSkillInvoke(p, self:objectName(), ToData(player)) then
                    local suits = {}
                    local cards = p:getHandcards()
                    for _, card in sgs.qlist(cards) do
                        if not table.contains(suits, card:getSuitString()) then
                            table.insert(suits, card:getSuitString())
                        end
                    end
                    if #suits > 0 then
                        local suit = room:askForChoice(p, self:objectName(), table.concat(suits, "+"), ToData(player))
                        local log= sgs.LogMessage()
                        log.type = "#ChooseSuit"
                        log.from = p
                        log.arg = suit
                        room:sendLog(log)
                        local dummy = dummyCard()
                        for _, card in sgs.qlist(cards) do
                            if card:getSuitString() == suit then
                                dummy:addSubcard(card)
                            end
                        end
                        room:obtainCard(player, dummy)
                        room:addPlayerMark(player, "&sfofl_mingjian+to+#"..p:objectName().."-Clear")
                    end
                end
            end
        elseif event == sgs.CardFinished then
            --处理额外结算
            local use = data:toCardUse()
            if (not use.card:hasFlag("sfofl_mingjian")) then return false end
            room:setCardFlag(use.card, "-sfofl_mingjian")
            if use.from:objectName() == player:objectName() then
                local targets = sgs.SPlayerList()
                for _,to in sgs.qlist(use.to) do
                    if to:isAlive() then
                        targets:append(to)
                    end
                end
                if (not targets:isEmpty()) then
                    local use_again = sgs.CardUseStruct(use.card,player,targets)
				    room:setTag("UseHistory"..use.card:toString(),ToData(use_again))
				    use.card:use(room,player,targets)
                end
            end
        elseif event == sgs.CardUsed then
            local use = data:toCardUse()
            if use.card:isKindOf("SkillCard") then return false end
            for _,p in ipairs(player:getMarkNames()) do
                if (string.find(p,"&sfofl_mingjian")) and (player:getMark(p) > 0) then
                    room:setPlayerMark(player, p, 0)
                    room:setCardFlag(use.card, "sfofl_mingjian")
                end
            end
        end
    end,
    can_trigger = function(self, target)
        return target and target:isAlive()
    end
}





--[[
	技能名：恢拓
	相关武将：曹叡[官盗]
	技能描述：当你受到1点伤害后，你可以令一名角色进行一次判定，若结果为红色，该角色回复1点体力；若结果为黑色，该角色摸一张牌。
	引用：sfofl_huituo
]] --
sfofl_huituo = sgs.CreateTriggerSkill{
	name = "sfofl_huituo",
	frequency = sgs.Skill_Frequent,
	events = {sgs.Damaged},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()
		local from = damage.from
		local x = damage.damage
		for i = 1, x, 1 do
            local target = room:askForPlayerChosen(player, room:getAlivePlayers(), self:objectName(),
                "sfofl_huituo-invoke", true, true)
            if target then
                local judge = sgs.JudgeStruct()
                judge.pattern = "."
                judge.reason = self:objectName()
                judge.who = player
                room:judge(judge)
                if judge.card:isRed() then
                    room:recover(target, sgs.RecoverStruct(self:objectName(), player, 1))
                elseif judge.card:isBlack() then
                    room:drawCards(target, 1, self:objectName())
                end
            else
                break
            end
        end
	end
}

sfofl_caorui:addSkill(sfofl_mingjian)
sfofl_caorui:addSkill(sfofl_huituo)
sfofl_caorui:addSkill("xingshuai")

sfofl_simayi = sgs.General(extension_s, "sfofl_simayi", "wei", 3)

--[[
	技能名：佯固
	相关武将：司马懿[官盗]
	技能描述：转换技，阳：当你受到伤害后，你可以回复1点体力；阴：你可以将一张手牌当【声东击西】使用。
	引用：sfofl_yanggu
]] --

sfofl_yangguVS = sgs.CreateViewAsSkill{
	name = "sfofl_yanggu" ,
	n = 1 ,
	view_filter = function(self, selected, to_select)
		return not to_select:isEquipped()
	end ,
	view_as = function(self, cards)
		if #cards == 1 then
            local zd_shengdongjixi = sgs.Sanguosha:cloneCard("zd_shengdongjixi", sgs.Card_NoSuit,0)
			zd_shengdongjixi:setSkillName(self:objectName())
            zd_shengdongjixi:addSubcard(cards[1])
			return zd_shengdongjixi
        end
	end ,
	enabled_at_play = function(self, player)
       return player:getChangeSkillState(self:objectName()) == 2
	end
}
 
sfofl_yanggu = sgs.CreateTriggerSkill{
	name = "sfofl_yanggu",
	view_as_skill = sfofl_yangguVS,
	events = {sgs.Damaged, sgs.CardUsed},
    change_skill = true,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
        if event == sgs.Damaged then
            local damage = data:toDamage()
            if player:getChangeSkillState(self:objectName()) <= 1 then
                if room:askForSkillInvoke(player, self:objectName()) then
                    room:setChangeSkillState(player, self:objectName(), 2)
                    room:recover(player, sgs.RecoverStruct(self:objectName(), player, 1))
                end
            end 
        elseif event == sgs.CardUsed then
            local use = data:toCardUse()
            if use.card and table.contains(use.card:getSkillNames(), "sfofl_yanggu") then
                if player:getChangeSkillState(self:objectName()) == 2 then
                    room:setChangeSkillState(player, self:objectName(), 1)
                end
            end
        end
	end
}



--[[
	技能名：罪缚
	相关武将：司马懿[官盗]
	技能描述：每回合限一次，当一名角色于其摸牌阶段外获得牌后，若没有角色处于濒死状态，你可以对其造成1点伤害。
	引用：sfofl_zuifu
]] --

sfofl_zuifu = sgs.CreateTriggerSkill{
	name = "sfofl_zuifu",
	events = {sgs.CardsMoveOneTime},
	on_trigger = function(self, event, player, data)
		local move = data:toMoveOneTime()
		local room = player:getRoom()
		if not room:getTag("FirstRound"):toBool() and player:getPhase() ~= sgs.Player_Draw and move.to and move.to:objectName() == player:objectName() then
			local ids = sgs.IntList()
			for _,id in sgs.qlist(move.card_ids) do
				if room:getCardOwner(id) == player and room:getCardPlace(id) == sgs.Player_PlaceHand then
					ids:append(id)
				end
			end
			if ids:isEmpty() then return false end
			for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                if room:getCurrentDyingPlayer() then return false end
                if p:getMark("sfofl_zuifu-Clear") == 0 and room:askForSkillInvoke(p, self:objectName(), ToData(player)) then
                    room:addPlayerMark(p, "sfofl_zuifu-Clear")
                    room:addPlayerMark(p, "&sfofl_zuifu-Clear")
                    local damage = sgs.DamageStruct()
                    damage.from = p
                    damage.to = player
                    room:damage(damage)
                end
            end
		end
		return false
	end,
    can_trigger = function(self, target)
        return target and target:isAlive()
    end
}
sfofl_simayi:addSkill(sfofl_yanggu)
sfofl_simayi:addSkill(sfofl_zuifu)

sfofl_jieqiao = sgs.General(extension_s, "sfofl_jieqiao", "qun", 1, true, true, false, 1, 3)
sfofl_jieqiao:setGender(sgs.General_Sexless)
--[[
	技能名：界桥
	相关武将：界桥
	技能描述：锁定技，该地形阵亡时，友方角色弃置所有牌。其他角色的结束阶段，其可以弃置所有手牌，令你获得1点护甲。
	引用：sfofl_jieqiao_skill
]] --
sfofl_castle = sgs.CreateTriggerSkill {
	name = "#sfofl_castle",
	events = { sgs.EventPhaseStart, sgs.GameStart, sgs.BeforeCardsMove },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
        if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_RoundStart then
            player:skip(sgs.Player_Start)
            player:skip(sgs.Player_Judge)
            player:skip(sgs.Player_Draw)
            player:skip(sgs.Player_Play)
            player:skip(sgs.Player_Discard)
            player:skip(sgs.Player_Finish)
        elseif event == sgs.GameStart then
            player:throwEquipArea()
            player:throwJudgeArea()
        elseif event == sgs.BeforeCardsMove then
            local move = data:toMoveOneTime()
            if (move.to_place == sgs.Player_PlaceHand) and move.to and move.to:objectName() == player:objectName() then
                move:removeCardIds(move.card_ids)
				data:setValue(move)
                local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                dummy:addSubcards(move.card_ids)
                dummy:deleteLater()
                local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_NATURAL_ENTER, player:objectName())
                room:moveCardTo(dummy, nil, sgs.Player_DiscardPile, reason, false)
            end
		end
	end,
}

sfofl_jieqiao_skill = sgs.CreateTriggerSkill {
    name = "sfofl_jieqiao_skill",
    events = { sgs.EventPhaseStart, sgs.Death},
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data, room)
        local room = player:getRoom()
        if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish and not player:isKongcheng() then
            for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                if p and p:objectName() ~= player:objectName() and room:askForSkillInvoke(player, self:objectName(), ToData(player)) then
                    player:throwAllHandCards()
                    p:gainHujia(1)
                end
            end
        elseif event == sgs.Death then
            local death = data:toDeath()
            if death.who:objectName() ~= player:objectName() then return false end
            if player:hasSkill(self:objectName()) then
                for _, p in sgs.qlist(room:getAlivePlayers()) do
                    if player:isYourFriend(p) then
                        p:throwAllHandCardsAndEquips()
                    end
                end
            end
        end
    end,
    can_trigger = function(self, target)
        return target
    end
}
sfofl_jieqiao:addSkill(sfofl_castle)
sfofl_jieqiao:addSkill(sfofl_jieqiao_skill)

--[[
	技能名：先锋
	相关武将：麴义方
	技能描述：每有一个先锋标记，麴义方攻击范围和手牌上限+1。当麴义方需要使用或打出基本时，其可以弃置一个标记并视为使用或打出该牌。
	引用：sfofl_jieqiao_quyi
]] --
sfofl_jieqiao_quyiCard = sgs.CreateSkillCard{
    name = "sfofl_jieqiao_quyi",
    will_throw = false,
    filter = function(self, targets, to_select)
        local pattern = self:getUserString()
		if pattern == "normal_slash" then pattern = "slash" end

		local card = sgs.Sanguosha:cloneCard(pattern, sgs.Card_SuitToBeDecided, -1)
		card:setSkillName("sfofl_jieqiao_quyi")
        card:deleteLater()

		if card and card:targetFixed() then
			return false
		end
		local qtargets = sgs.PlayerList()
		for _, p in ipairs(targets) do
			qtargets:append(p)
		end
		return card and card:targetFilter(qtargets, to_select, sgs.Self) and not sgs.Self:isProhibited(to_select, card, qtargets)
	end,
	feasible = function(self, targets)
		local pattern = self:getUserString()
		if pattern=="normal_slash" then pattern = "slash" end

		local card = sgs.Sanguosha:cloneCard(pattern, sgs.Card_SuitToBeDecided, -1)
		card:setSkillName("sfofl_jieqiao_quyi")
        card:deleteLater()

		local qtargets = sgs.PlayerList()
		for _, p in ipairs(targets) do
			qtargets:append(p)
		end
		if card and card:canRecast() and #targets == 0 then
			return false
		end
		return card and card:targetsFeasible(qtargets, sgs.Self) --and card:isAvailable(sgs.Self)
	end,
	on_validate = function(self, card_use)
		local player = card_use.from
        local room = player:getRoom()

        local pattern = self:getUserString()
		if pattern=="normal_slash" then pattern = "slash" end
        room:removePlayerMark(player, "&sfofl_jieqiao_quyi", 1)

		local card = sgs.Sanguosha:cloneCard(pattern, sgs.Card_SuitToBeDecided, -1)
		card:setSkillName("sfofl_jieqiao_quyi")
		return card
	end,
    on_validate_in_response = function(self, player)
        local room = player:getRoom()

        local pattern = self:getUserString()
		if pattern=="normal_slash" then pattern = "slash" end
        room:removePlayerMark(player, "&sfofl_jieqiao_quyi", 1)

		local card = sgs.Sanguosha:cloneCard(pattern, sgs.Card_SuitToBeDecided, -1)
		card:setSkillName("sfofl_jieqiao_quyi")
		return card
    end
}
sfofl_jieqiao_quyi = sgs.CreateZeroCardViewAsSkill{
    name = "sfofl_jieqiao_quyi&",
    view_as = function(self)
        local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
        if sgs.Sanguosha:getCurrentCardUseReason()==sgs.CardUseStruct_CARD_USE_REASON_PLAY then
			local card = sgs.Self:getTag("sfofl_jieqiao_quyi"):toCard()
			pattern = card:objectName()
		end
        local card = sfofl_jieqiao_quyiCard:clone()
        local names = pattern:split("+")
        if #names ~= 1 then pattern = names[1] end
        if pattern == "Slash" then pattern = "slash" end
        if pattern == "Jink" then pattern = "jink" end
        card:setUserString(pattern)
        return card
    end,
    enabled_at_play = function(self, player)
        if player:getMark("&sfofl_jieqiao_quyi") == 0 then return false end
        if not player:hasSkill("sfofl_jieqiao_quyi") then return false end
        return true
    end,
    enabled_at_response = function(self,player,pattern)
        if player:getMark("&sfofl_jieqiao_quyi") == 0 then return false end
        if not player:hasSkill("sfofl_jieqiao_quyi") then return false end
        --if sgs.Sanguosha:getCurrentCardUseReason()~=sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then return false end
        local basics = {"slash", "jink", "peach", "analeptic", "Jink", "Slash"}
        for _,basic in ipairs(basics) do
            if string.find(pattern, basic) then
                return true
            end
        end
        return false
    end
}
sfofl_jieqiao_quyi:setGuhuoDialog("l")

sfofl_jieqiao_quyi_buff = sgs.CreateTriggerSkill{
    name = "#sfofl_jieqiao_quyi_buff",
    events = {sgs.GameStart},
    frequency = sgs.Skill_NotFrequent,
    on_trigger = function(self, event, player, data, room)
         for _, p in sgs.qlist(room:getAlivePlayers()) do
            if player:isYourFriend(p) then
                room:addPlayerMark(p, "&sfofl_jieqiao_quyi", 2)
            end
        end
        room:doLightbox("sfofl_jieqiao_quyi_start$", 4444)
    end
}
sfofl_jieqiao_quyi_range = sgs.CreateAttackRangeSkill {
	name = "#sfofl_jieqiao_quyi_range",
	extra_func = function(self, player)
        local x = player:getMark("&sfofl_jieqiao_quyi")
		if player:hasSkill("sfofl_jieqiao_quyi") then return x end
        return 0
	end,
}
sfofl_jieqiao_quyi_cardmax = sgs.CreateMaxCardsSkill {
	name = "#sfofl_jieqiao_quyi_cardmax",
	extra_func = function(self, target)
		if target:hasSkill("sfofl_jieqiao_quyi") then
            local x = target:getMark("&sfofl_jieqiao_quyi")
			return x
		end
        return 0
	end
}
if not sgs.Sanguosha:getSkill("sfofl_jieqiao_quyi") then skills:append(sfofl_jieqiao_quyi) end
if not sgs.Sanguosha:getSkill("sfofl_jieqiao_quyi_buff") then skills:append(sfofl_jieqiao_quyi_buff) end
if not sgs.Sanguosha:getSkill("sfofl_jieqiao_quyi_range") then skills:append(sfofl_jieqiao_quyi_range) end
if not sgs.Sanguosha:getSkill("sfofl_jieqiao_quyi_cardmax") then skills:append(sfofl_jieqiao_quyi_cardmax) end

--搞不明白
--[[
sfofl_jieqiao_quyiScenario = sgs.CreateScenario{--创建剧情模式
	name = "sfofl_jieqiao_quyiScenario",--剧情名称
	expose = true,--身份是否可见
	roles = {--身份数（-1代表不指定武将，默认为素将，可以将-1改为特定武将名，例如樊城之战["lord"] = "guanyu"）
		["rebel1"] = "quyi",
		["rebel2"] = -1,
		["loyalist1"] = "ov_yangang",
		["loyalist2"] = -1,
		["lord"] = "sfofl_gongsunzan",
		["loyalist3"] = "keol_zhangyan",
		["loyalist4"] = "sfofl_jieqiao",
	},
    on_assign = function(self,generals,roles)
        local generals2 = generals
		local roles2 = roles
		table.insert(roles,"rebel")
		table.insert(roles,"rebel")
		table.insert(roles,"loyalist")
		table.insert(roles,"loyalist")
        table.insert(roles,"lord")
		table.insert(roles,"loyalist")
		table.insert(roles,"loyalist")
        table.insert(generals2,"quyi")
        table.insert(generals2,"sujiang")
        table.insert(generals2,"ov_yangang")
        table.insert(generals2,"sujiang")
        table.insert(generals2,"sfofl_gongsunzan")
        table.insert(generals2,"keol_zhangyan")
        table.insert(generals2,"sfofl_jieqiao")
        roles = roles2
        generals = generals2
    end
}
sfofl_jieqiao_quyiScenarioRule = sgs.CreateScenarioRule{--创建剧情规则（就是创建一个特殊的全局触发技，但这个全局触发技只有进入剧情才启用）
	events = {sgs.GameReady,sgs.GameOver},--触发时机
	global = true,--默认全局触发
	scenario = sfofl_jieqiao_quyiScenario,--设定触发技的剧情模式
	on_trigger = function(self,event,player,data,room)--触发函数
	if event==sgs.GameReady then
			if room:getTag("god_exam"):toBool() or player then return end
			local lord = room:getLord()
			if not lord then return end
			room:setTag("god_exam",ToData(true))
			local ops = room:getOtherPlayers(lord)
			
			local lgs = {"ge_qinglong","ge_zhuque","ge_baihu","ge_xuanwu"}
			local lgn = math.random(1,#lgs)
			local lg = lgs[lgn]
			local heros = {}
			if god_examWinner==1 then
				god_examRandom = lgn
			else
				local boss = god_examBoss[god_examWinner][god_examRandom]
				for i,b in sgs.list(boss)do
					if i<2 then
						ig = b
					else
						for _,p in sgs.list(ops)do
							if p:getRole()=="loyalist" then
								heros[p:objectName()] = b
								ops:removeOne(p)
								break
							end
						end
					end
				end
			end
			room:changeHero(lord,lg,true,false,false,false)
			local rgs = {}
			local total = sgs.GetConfig("MaxChoice",5)
			local lords = sgs.Sanguosha:getRandomGenerals(total*ops:length())
           	for _,p in sgs.list(ops)do
				rgs = {}
				for i=1,total do
					table.insert(rgs,lords[#lords])
					table.remove(lords,#lords)
				end
				heros[p:objectName()] = room:askForGeneral(p,table.concat(rgs,"+"))
			end
           	for _,p in sgs.list(ops)do
				room:changeHero(p,heros[p:objectName()],true,false,false,false)
			end
		elseif event==sgs.GameOver
		and room:getTag("god_exam"):toBool() then
			local winner = data:toString():split("+")
			local owner = room:getOwner()
			if table.contains(winner,owner:objectName())
			or table.contains(winner,owner:getRole()) then
				god_examWinner = god_examWinner+1
			end
		end
		return false
	end,
}
sfofl_jieqiao_quyiScenario:setRule(sfofl_jieqiao_quyiScenarioRule)--将触发技设置给剧情
sgs.Sanguosha:addScenario(sfofl_jieqiao_quyiScenario)
]]


sfofl_pangtong = sgs.General(extension_s, "sfofl_pangtong", "wei", 3)

--[[
	技能名：连环
	相关武将：庞统[官盗]
	技能描述：出牌阶段限一次，你可以失去1点体力并视为使用一张【铁索连环】。
	引用：sfofl_lianhuan
]] --
sfofl_lianhuanCard = sgs.CreateSkillCard{
	name = "sfofl_lianhuan",
	will_throw = false,
	filter = function(self,targets,to_select,player)
		local plist = sgs.PlayerList()
		for i = 1,#targets do plist:append(targets[i]) end
		local dc = dummyCard("iron_chain","sfofl_lianhuan")
		return dc:targetFilter(plist,to_select,player)
	end,
	on_use = function(self, room, source, targets)
        room:loseHp(source,1,true,source,self:objectName())
        local dc = dummyCard("iron_chain","sfofl_lianhuan")
        local targets_list = sgs.SPlayerList()
        for _,target in ipairs(targets) do
            targets_list:append(target)
        end
        room:useCard(sgs.CardUseStruct(dc,source,targets_list))
    end
}
sfofl_lianhuan = sgs.CreateViewAsSkill {
    name = "sfofl_lianhuan",
    n = 0,
    view_as = function(self, cards)
        if #cards == 0 then
            return sfofl_lianhuanCard:clone()
        end
    end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_lianhuan")
    end,
}

--[[
	技能名：索舟
	相关武将：庞统[官盗]
	技能描述：每回合限一次，当你成为的目标或使用牌时，你可以令所有横置的角色摸一张牌。
	引用：sfofl_suozhou
]] --

sfofl_suozhou = sgs.CreateTriggerSkill{
	name = "sfofl_suozhou",
	events = {sgs.TargetConfirmed, sgs.TargetSpecified},
	frequency = sgs.Skill_NotFrequent, 
	on_trigger = function(self, event, player, data)
		local use = data:toCardUse()
		local room = player:getRoom()
		if (event == sgs.TargetSpecified) or (event == sgs.TargetConfirmed and use.to:contains(player)) then
			if not use.card:isKindOf("SkillCard")
			and (player:getMark("sfofl_suozhou-Clear") == 0) then
                local targets = sgs.SPlayerList()
                for _, p in sgs.list(room:getAllPlayers()) do
                    if p:isChained() then
                        targets:append(p)
                    end
                end
				if targets:length() > 0 and player:askForSkillInvoke(self:objectName(), data) then
					room:broadcastSkillInvoke(self:objectName())
                    room:drawCards(targets, 1, self:objectName())
					room:setPlayerMark(player,"sfofl_suozhou-Clear",1)
					
				end
			end
		end
	end
}

--[[
	技能名：浴火
	相关武将：庞统[官盗]
	技能描述：锁定技，横置的其他角色受到的属性伤害+1，非属性伤害-1。
	引用：sfofl_yihuo
]] --
sfofl_yihuo = sgs.CreateTriggerSkill{
    name = "sfofl_yihuo",
    events = {sgs.DamageInflicted},
	frequency = sgs.Skill_Compulsory,
    on_trigger = function(self,event,player,data,room)
		if event == sgs.DamageInflicted then
			local damage = data:toDamage()
			if damage.nature == sgs.DamageStruct_Normal then
				for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if player:objectName() ~= p:objectName() then
                        room:sendCompulsoryTriggerLog(p,self)
                        player:damageRevises(data,-1)
                    end
                end
            else
                for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if player:objectName() ~= p:objectName() then
                        room:sendCompulsoryTriggerLog(p,self)
                        player:damageRevises(data,1)
                    end
                end
			end
	    end
    end,
    can_trigger = function(self, target)
		return target and target:isAlive() and target:isChained()
	end
}



sfofl_pangtong:addSkill(sfofl_lianhuan)
sfofl_pangtong:addSkill(sfofl_suozhou)
sfofl_pangtong:addSkill(sfofl_yihuo)

sfofl_3_caocao = sgs.General(extension_s, "sfofl_3_caocao", "wei", 4)

--[[
	技能名：砺军
	相关武将：曹操[官盗]
	技能描述：当魏势力角色受到伤害后，你可以令其摸一张牌。
	引用：sfofl_lijun
]] --
sfofl_lijun = sgs.CreateTriggerSkill{
	name = "sfofl_lijun",
	events = {sgs.Damaged},
    can_trigger = function(self,target)
		return target and target:getKingdom() == "wei"
	end,
	on_trigger = function(self,event,player,data,room)
        for _,p in sgs.list(room:findPlayersBySkillName(self:objectName()))do
            if room:askForSkillInvoke(p, self:objectName(), data) then
                data:toDamage().to:drawCards(1, self:objectName())
            end
        end
    end

}

--[[
	技能名：统北
	相关武将：曹操[官盗]
	技能描述：你对非魏势力角色造成伤害时，你可以令其选择一项：1.此伤害+1；2.交给你一张你声明的类别的牌。
	引用：sfofl_tongbei
]] --
sfofl_tongbei = sgs.CreateTriggerSkill{
	name = "sfofl_tongbei",
	events = {sgs.DamageCaused},
	on_trigger = function(self,event,player,data,room)
        local damage = data:toDamage()
        if damage.to:getKingdom() ~= "wei" and room:askForSkillInvoke(player, self:objectName(), data) then
            local state = room:askForChoice(player, self:objectName(), "basic+trick+equip", data)
            local card = room:askForCard(damage.to, state, "@sfofl_tongbei:"..player:objectName()..":"..state, data, sgs.Card_MethodNone)
            if card then
                room:obtainCard(player, card, true)
            else
                damage.damage = damage.damage + 1
                local log = sgs.LogMessage()
                log.type = "#skill_add_damage"
                log.from = damage.from
                log.to:append(damage.to)
                log.arg  = self:objectName()
                log.arg2 = damage.damage
                room:sendLog(log)
                data:setValue(damage)
            end
        end
    return false
    end
}


sfofl_3_caocao:addSkill(sfofl_lijun)
sfofl_3_caocao:addSkill(sfofl_tongbei)

sfofl_caoren = sgs.General(extension_s, "sfofl_caoren", "wei", 4)

--[[
	技能名：备戎
	相关武将：曹仁[官盗]
	技能描述：出牌阶段限一次，你可以重铸至少一张手牌，若你以此法重铸的牌的花色数不小于你的体力值，你横置。
	引用：sfofl_beirong
]] --
sfofl_beirongCard = sgs.CreateSkillCard{
	name = "sfofl_beirong",
    target_fixed = true,
    will_throw = false,
	on_use = function(self, room, source, targets)
        local suits = {}
		for _,id in sgs.qlist(self:getSubcards()) do
		    local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_RECAST, source:objectName())
            reason.m_skillName = self:objectName()
            room:moveCardTo(sgs.Sanguosha:getCard(id), source, nil, sgs.Player_DiscardPile, reason)
            source:broadcastSkillInvoke("@recast")
            local log = sgs.LogMessage()
            log.type = "#UseCard_Recast"
            log.from = source
            log.card_str = sgs.Sanguosha:getCard(id):toString()
            room:sendLog(log)
            source:drawCards(1, "recast")
            if not table.contains(suits, sgs.Sanguosha:getCard(id):getSuit()) then
                table.insert(suits, sgs.Sanguosha:getCard(id):getSuit())
            end
        end
		if #suits >= source:getHp() then
            room:setPlayerChained(source,true)
        end
	end
}
sfofl_beirong = sgs.CreateViewAsSkill{
	name = "sfofl_beirong",
    n = 999,
    view_filter = function(self, selected, to_select)
		return not to_select:isEquipped()
	end,
	view_as = function(self, cards)
		if #cards == 0 then return nil end
		local card = sfofl_beirongCard:clone()
		for _, c in ipairs(cards) do
			card:addSubcard(c)
		end
		return card
	end,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_beirong") 
	end, 
}

--[[
	技能名：御军
	相关武将：曹仁[官盗]
	技能描述：一名横置角色受到属性伤害时，你可以翻面并失去1点体力，然后摸三张牌，若如此做，防止此伤害。
	引用：sfofl_yujun
]] --
sfofl_yujun = sgs.CreateTriggerSkill{
	name = "sfofl_yujun",
	events = {sgs.DamageInflicted},
    can_trigger = function(self,target)
		return target and target:isChained()
	end,
	on_trigger = function(self,event,player,data,room)
        local damage = data:toDamage()
        if damage.nature ~= sgs.DamageStruct_Normal then
            for _,p in sgs.list(room:findPlayersBySkillName(self:objectName()))do
                if room:askForSkillInvoke(p, self:objectName(), data) then
                    p:turnOver()
                    room:loseHp(p, 1, true, p, self:objectName())
                    p:drawCards(3, self:objectName())
                    return player:damageRevises(data,-damage.damage)
                end
            end
        end
    end

}



sfofl_caoren:addSkill(sfofl_beirong)
sfofl_caoren:addSkill(sfofl_yujun)



sfofl_5_zhugeliang = sgs.General(extension_s, "sfofl_5_zhugeliang", "shu", 4, true ,false, false, 3)

--[[
	技能名：七辩
	相关武将：诸葛亮[官盗]
	技能描述：每轮开始时，你将牌堆顶的七张牌置于武将牌上，称为“才”，每轮结束时，你弃置所有的“才”。
	引用：sfofl_qibian
]] --

sfofl_qibian = sgs.CreateTriggerSkill{
	name = "sfofl_qibian",
	events = {sgs.RoundStart, sgs.RoundEnd, sgs.EventAcquireSkill, sgs.EventLoseSkill},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.RoundStart then
            local players = sgs.SPlayerList()
            players:append(player)
            if player:hasSkill("sfofl_cailue") then
                player:addToPile("&sfofl_qibian_talent", room:getNCards(7), false, players)
            else
                player:addToPile("sfofl_qibian_talent", room:getNCards(7), false, players)
            end
        elseif event == sgs.RoundEnd then
            player:clearOnePrivatePile("&sfofl_qibian_talent")
            player:clearOnePrivatePile("sfofl_qibian_talent")
        elseif event == sgs.EventAcquireSkill and data:toString() == "sfofl_cailue" then
            if player:getPile("sfofl_qibian_talent"):length() > 0 then
                local obtain = sgs.Sanguosha:cloneCard("jink", sgs.Card_SuitToBeDecided, -1)
                obtain:addSubcards(player:getPile("sfofl_qibian_talent"))
                room:moveCardTo(obtain,nil,sgs.Player_PlaceTable, false)
                local players = sgs.SPlayerList()
                players:append(player)
                player:addToPile("&sfofl_qibian_talent", obtain, false, players)
            end
        elseif event == sgs.EventLoseSkill and data:toString() == "sfofl_cailue" then
            if player:getPile("&sfofl_qibian_talent"):length() > 0 then
                local obtain = sgs.Sanguosha:cloneCard("jink", sgs.Card_SuitToBeDecided, -1)
                obtain:addSubcards(player:getPile("&sfofl_qibian_talent"))
                room:moveCardTo(obtain,nil,sgs.Player_PlaceTable, false)
                local players = sgs.SPlayerList()
                players:append(player)
                player:addToPile("sfofl_qibian_talent", obtain, false, players)
            end
		end
	end
}

--[[
	技能名：才略
	相关武将：诸葛亮[官盗]
	技能描述：你可以使用或打出“才”，然后成为“才”的目标的角色可以弃置你一张牌。
	引用：sfofl_cailue
]] --
sfofl_cailue = sgs.CreateTriggerSkill{
	name = "sfofl_cailue",
	events = {sgs.TargetSpecified, sgs.CardsMoveOneTime},
	frequency = sgs.Skill_Frequent,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
        if event == sgs.TargetSpecified then
            local use = data:toCardUse()
            if use.card and use.card:hasFlag(self:objectName()) then
                room:sendCompulsoryTriggerLog(use.from, self:objectName(), true)
                for _,p in sgs.qlist(use.to) do 
                    if p:canDiscard(use.from, "he") and room:askForSkillInvoke(p, self:objectName(), ToData(player)) then
                        local id = room:askForCardChosen(p,player,"he",self:objectName(),false,sgs.Card_MethodDiscard)
                        room:throwCard(id,player,p)
                    end
                end
            end
        elseif event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            if move.to_place == sgs.Player_PlaceTable and bit32.band(move.reason.m_reason,sgs.CardMoveReason_S_MASK_BASIC_REASON)==sgs.CardMoveReason_S_REASON_USE and table.contains(move.from_pile_names,"&sfofl_qibian_talent") then
                local use = move.reason.m_useStruct
                if use.to and use.to:length() > 0 then
                    room:setCardFlag(use.card, self:objectName())
                end
            end
        end
        return false
	end,
}


sfofl_5_zhugeliang:addSkill(sfofl_qibian)
sfofl_5_zhugeliang:addSkill(sfofl_cailue)

sfofl_3_zhouyu = sgs.General(extension_s, "sfofl_3_zhouyu", "wu", 3)

--[[
	技能名：飒爽
	相关武将：周瑜[官盗]
	技能描述：结束阶段，你可以获得弃牌堆中本回合进入的每种颜色的牌各一张。
	引用：sfofl_sashuang
]] --
sfofl_sashuang = sgs.CreateTriggerSkill{
	name = "sfofl_sashuang",
	frequency = sgs.Skill_NotFrequent,
	events = {sgs.EventPhaseStart,sgs.EventPhaseChanging},
	on_trigger = function(self, event, player, data, room)	
		if event == sgs.EventPhaseChanging then
			local change = data:toPhaseChange()
			if change.to == sgs.Player_NotActive then
				room:removeTag("sfofl_sashuangCard")
			end
		else
			local phase = player:getPhase()
			if phase == sgs.Player_Finish then
								
				local DiscardPile = room:getDiscardPile()
				local tag = room:getTag("sfofl_sashuangCard"):toString():split("+")
				room:removeTag("sfofl_sashuangCard")
				if #tag == 0 then return false end
				local toGainList = sgs.IntList()				
				for _,is in ipairs(tag) do
					if is~="" and DiscardPile:contains(tonumber(is)) then
						toGainList:append(tonumber(is))
					end
				end			
				if toGainList:isEmpty() then return false end
                if room:askForSkillInvoke(player,"sfofl_sashuang",data) then
                    local ids = sgs.IntList()
                    for _,id in sgs.list(toGainList)do
                        ids:append(id)
                    end
                    room:fillAG(toGainList)
                    local dummy = dummyCard()
                    while ids:length()>0 do
                        local id = room:askForAG(player,ids,false,"sfofl_sashuang")
                        dummy:addSubcard(id)
                        room:takeAG(player,id,false)
                        for _,to_id in sgs.list(toGainList)do
                            if sgs.Sanguosha:getCard(to_id):getColor()==sgs.Sanguosha:getCard(id):getColor()
                            and ids:contains(to_id) then
                                if to_id~=id then
                                    room:takeAG(nil,to_id,false)
                                end
                                ids:removeOne(to_id)
                            end
                        end
                    end
                    room:clearAG()
                    player:obtainCard(dummy)
                end
            end
		end
		return false
	end,
}

sfofl_sashuang_record = sgs.CreateTriggerSkill{
	name = "#sfofl_sashuang_record",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.CardsMoveOneTime,},
	on_trigger = function(self, event, player, data, room)
		
		local current = room:getCurrent()
		if not current or current:isDead() or current:getPhase() == sgs.Player_NotActive or not current:hasSkill("sfofl_sashuang") then return false end		
		local move = data:toMoveOneTime()			
		if (move.to_place == sgs.Player_DiscardPile) 
			and ((bit32.band(move.reason.m_reason, sgs.CardMoveReason_S_MASK_BASIC_REASON) == 
				sgs.CardMoveReason_S_REASON_DISCARD) 
			or (move.reason.m_reason == sgs.CardMoveReason_S_REASON_JUDGEDONE)) then
			local oldtag = room:getTag("sfofl_sashuangCard"):toString():split("+")
			local totag = {}
			for _,is in ipairs(oldtag) do
				table.insert(totag,tonumber(is))
			end					
			for _, card_id in sgs.qlist(move.card_ids) do
				table.insert(totag,card_id)
			end	
			room:setTag("sfofl_sashuangCard",sgs.QVariant(table.concat(totag,"+")))
		end		
	end
}
--[[
	技能名：火策
	相关武将：周瑜[官盗]
	技能描述：出牌阶段限一次，你可以与一名其他角色同时弃置一张手牌，若这些牌颜色相同，你对一名角色造成1点火焰伤害。
	引用：sfofl_huoce
]] --
sfofl_huoceCard = sgs.CreateSkillCard{
	name = "sfofl_huoce",
	target_fixed = false,
	will_throw = false,
	filter = function(self, targets, to_select, player)
		return #targets == 0 and to_select:canDiscard(to_select, "h")
	end,
	on_use = function(self, room, player, targets)
		local target = targets[1]
        local card = room:askForCard(player, ".|.|.|hand!", "@sfofl_huoce", ToData(target), sgs.Card_MethodNone, player, false, self:objectName())
        local card2 = room:askForCard(target, ".|.|.|hand!", "@sfofl_huoce", ToData(player), sgs.Card_MethodNone, player, false, self:objectName())
        if card and card2 then
            room:throwCard(card, player)
            room:throwCard(card2, target)
            if card:getColorString() == card2:getColorString() then
                local target2 = room:askForPlayerChosen(player, room:getAlivePlayers(), self:objectName(), "sfofl_huoce-invoke")
                if not target2 then return false end
                room:damage(sgs.DamageStruct("sfofl_huoce", player, target2, 1, sgs.DamageStruct_Fire))
            end
        end
	end
}

sfofl_huoce = sgs.CreateViewAsSkill{
	name = "sfofl_huoce",
	n = 0,
	view_as = function(self, cards)
		return sfofl_huoceCard:clone()
	end,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_huoce") and player:canDiscard(player, "h")
	end, 
}


sfofl_3_zhouyu:addSkill(sfofl_sashuang)
sfofl_3_zhouyu:addSkill(sfofl_sashuang_record)
extension_s:insertRelatedSkills("sfofl_sashuang", "#sfofl_sashuang_record")
sfofl_3_zhouyu:addSkill(sfofl_huoce)

sfofl_zhangzhao = sgs.General(extension_s, "sfofl_zhangzhao", "wu", 3)

--[[
	技能名：驳言
	相关武将：张昭[官盗]
	技能描述：出牌阶段限两次，你可以与一名其他角色拼点，没赢的角色本回合不能使用手牌，然后摸两张牌。
	引用：sfofl_boyan
]] --
sfofl_boyanCard = sgs.CreateSkillCard{
	name = "sfofl_boyan",
	target_fixed = false,
	will_throw = false,
	filter = function(self, targets, to_select, player)
		return #targets == 0 and player:canPindian(to_select, true)
	end,
	on_use = function(self, room, player, targets)
		local target = targets[1]
        room:addPlayerMark(target, "sfofl_boyan-PlayClear")
        local n = player:pindianInt(target,"sfofl_boyan")
        local loser
        if n>0 then 
            loser = target 
        elseif n<0 then 
            loser = player
        else
            room:setPlayerCardLimitation(player,"use",".|.|.|hand", true)
            player:drawCards(2, "sfofl_boyan")
            room:addPlayerMark(player, "&sfofl_boyan+to+#"..player:objectName().."-Clear")
            room:setPlayerCardLimitation(target,"use",".|.|.|hand", true)
            target:drawCards(2, "sfofl_boyan")
            room:addPlayerMark(target, "&sfofl_boyan+to+#"..player:objectName().."-Clear")
        end
        if loser then
            room:setPlayerCardLimitation(loser,"use",".|.|.|hand", true)
            loser:drawCards(2, "sfofl_boyan")
            room:addPlayerMark(loser, "&sfofl_boyan+to+#"..player:objectName().."-Clear")
        end
	end
}

sfofl_boyan = sgs.CreateViewAsSkill{
	name = "sfofl_boyan",
	n = 0,
	view_as = function(self, cards)
		return sfofl_boyanCard:clone()
	end,
	enabled_at_play = function(self, player)
		return player:usedTimes("#sfofl_boyan") < 2
	end, 
}

--[[
	技能名：慕势
	相关武将：张昭[官盗]
	技能描述：结束阶段，若所有其他角色手牌数均大于等于其体力值，你可以选择一项：1.获得每名其他角色的各一张牌；2.令所有其他角色将其手牌数调整至其体力值张。
	引用：sfofl_mushi
]] --
sfofl_mushi = sgs.CreateTriggerSkill{
	name = "sfofl_mushi",  
	events = {sgs.EventPhaseStart}, 
	on_trigger = function(self, event, player, data, room)
		if (event == sgs.EventPhaseStart) and player:getPhase() == sgs.Player_Finish then
            local can_invoke = true
            for _,p in sgs.qlist(room:getAllPlayers()) do
                if p:getHandcardNum() < p:getHp() then can_invoke = false break end
            end
            if can_invoke then
                local choice = room:askForChoice(player, self:objectName(), "obtain+discard+cancel")
                if choice == "obtain" then
                    for _,p in sgs.qlist(room:getAllPlayers()) do
                        if not p:isNude() then
                            local card_id = room:askForCardChosen(player, p, "he", self:objectName())
                            room:obtainCard(player, card_id)
                        end
                    end
                elseif choice == "discard" then
                    for _,p in sgs.qlist(room:getAllPlayers()) do
                        if p:getHandcardNum() > p:getHp() then
                            room:askForDiscard(p, self:objectName(), p:getHandcardNum() - p:getHp(), p:getHandcardNum() - p:getHp(), false, false)
                        end
                    end
                end
            end
        end
		return false
	end,
}


sfofl_zhangzhao:addSkill(sfofl_boyan)
sfofl_zhangzhao:addSkill(sfofl_mushi)

sfofl_lusu = sgs.General(extension_s, "sfofl_lusu", "wu", 3)


--[[
	技能名：缔盟
	相关武将：鲁肃[官盗]
	技能描述：当有角色拼点时，你可以交换双方的拼点牌。
	引用：sfofl_dimeng
]] --
sfofl_dimeng = sgs.CreateTriggerSkill{
	name = "sfofl_dimeng",
	events = {sgs.PindianVerifying},
    can_trigger = function(self,target)
		return target and target:isAlive()
		and target:getRoom():findPlayerBySkillName("sfofl_dimeng")
	end,
	on_trigger = function(self,event,player,data,room)
		if event==sgs.PindianVerifying then
			local pindian = data:toPindian()
			for _,owner in sgs.list(room:findPlayersBySkillName("sfofl_dimeng"))do
				if room:askForSkillInvoke(owner, self:objectName(), data) then
                    local temp = pindian.from_card
                    pindian.from_card = pindian.to_card
                    pindian.to_card = temp
                    pindian.from_number = pindian.from_card:getNumber()
                    pindian.to_number = pindian.to_card:getNumber()
                    room:sendCompulsoryTriggerLog(owner, self:objectName())
                    data:setValue(pindian)
                end
			end
		end
		return false
	end
}

--[[
	技能名：周济
	相关武将：鲁肃[官盗]
	技能描述：出牌阶段限x次，你可以与一名其他角色拼点，若其赢，其摸两张牌（x为你的体力值）
	引用：sfofl_2_zhouji
]] --
sfofl_2_zhoujiCard = sgs.CreateSkillCard{
	name = "sfofl_2_zhouji",
	target_fixed = false,
	will_throw = false,
	filter = function(self, targets, to_select, player)
		return #targets == 0 and player:canPindian(to_select, true)
	end,
	on_use = function(self, room, player, targets)
		local target = targets[1]
        local n = player:pindianInt(target,"sfofl_2_zhouji")
        local winner
        if n<0 then 
            winner = target
        end
        if winner then
			winner:drawCards(2, "sfofl_2_zhouji")
		end
	end
}

sfofl_2_zhouji = sgs.CreateViewAsSkill{
	name = "sfofl_2_zhouji",
	n = 0,
	view_as = function(self, cards)
		return sfofl_2_zhoujiCard:clone()
	end,
	enabled_at_play = function(self, player)
		return player:usedTimes("#sfofl_2_zhouji") < player:getHp()
	end, 
}
sfofl_lusu:addSkill(sfofl_dimeng)
sfofl_lusu:addSkill(sfofl_2_zhouji)


sfofl_huanggai = sgs.General(extension_s, "sfofl_huanggai", "wu", 5, true, false, false, 4)



--[[
	技能名：烈舟
	相关武将：黄盖[官盗]
	技能描述：锁定技，你造成的伤害视为火焰伤害；你对一名角色造成伤害后，若其受到伤害前武将牌横置，你摸x张牌（x为你造成的伤害值）。
	引用：sfofl_liezhou
]] --

sfofl_liezhou = sgs.CreateTriggerSkill {
	name = "sfofl_liezhou",
	frequency = sgs.Skill_Compulsory,
	events = { sgs.Predamage, sgs.Damage },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()
		if event == sgs.Predamage then
            room:sendCompulsoryTriggerLog(player, self:objectName())
			damage.nature = sgs.DamageStruct_Fire
            data:setValue(damage)
            if damage.to:isChained() then
                room:setPlayerMark(player, "sfofl_liezhou"..damage.to:objectName().."-Clear", 1)
            end
        elseif event == sgs.Damage then
            if player:getMark("sfofl_liezhou"..damage.to:objectName().."-Clear") > 0 then
                room:setPlayerMark(player, "sfofl_liezhou"..damage.to:objectName().."-Clear", 0)
                room:sendCompulsoryTriggerLog(player, self:objectName())
                player:drawCards(damage.damage, self:objectName())
            end
		end
		return false
	end
}

--[[
	技能名：诈降
	相关武将：黄盖[官盗]
	技能描述：出牌阶段限一次，你可以失去1点体力上限，令你本回合使用的牌不能被响应。
	引用：sfofl_zhaxiong
]] --
sfofl_zhaxiongCard = sgs.CreateSkillCard{
	name = "sfofl_zhaxiong",
    target_fixed = true,
	on_use = function(self, room, source, targets)
        room:loseMaxHp(source)
		room:addPlayerMark(source, "sfofl_zhaxiong-Clear")
		room:addPlayerMark(source, "&sfofl_zhaxiong-Clear")
	end
}
sfofl_zhaxiongVS = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_zhaxiong",
	view_as = function(self) 
		return sfofl_zhaxiongCard:clone()
	end, 
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_zhaxiong")
    end
}
sfofl_zhaxiong = sgs.CreateTriggerSkill{
	name = "sfofl_zhaxiong",
	view_as_skill = sfofl_zhaxiongVS,
	events = {sgs.CardUsed},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.CardUsed then
			local use = data:toCardUse()
			if use.card and not use.card:isKindOf("SkillCard") and player:getMark("sfofl_zhaxiong-Clear") > 0 then
                room:sendCompulsoryTriggerLog(player, self:objectName())
                local no_respond_list = use.no_respond_list
                table.insert(no_respond_list, "_ALL_TARGETS")
                use.no_respond_list = no_respond_list
                data:setValue(use)
			end
		
		end
		return false
	end	
}


sfofl_huanggai:addSkill(sfofl_liezhou)
sfofl_huanggai:addSkill(sfofl_zhaxiong)


--[[
	技能名：艦船
	技能描述：宝物锁定技，若你处于连环状态，你的攻击距离和手牌上限+2。
	引用：sfofl_jianchuan
]] --
sfofl_jianchuan_maxcard = sgs.CreateMaxCardsSkill{
    name = "#sfofl_jianchuan_maxcard",
    extra_func = function(self, player)
        if player:hasTreasure("sfofl_jianchuan") and player:isChained() then return 2 end
    end
}
sfofl_jianchuan_range = sgs.CreateAttackRangeSkill {
	name = "#sfofl_jianchuan_range",
	extra_func = function(self, player)
       if player:hasTreasure("sfofl_jianchuan") and player:isChained() then return 2 end
	end,
}

if not sgs.Sanguosha:getSkill("#sfofl_jianchuan_maxcard") then skills:append(sfofl_jianchuan_maxcard) end
if not sgs.Sanguosha:getSkill("#sfofl_jianchuan_range") then skills:append(sfofl_jianchuan_range) end

sfofl_jianchuan = sgs.CreateTreasure{
    name = "sfofl_jianchuan",
    class_name = "Jianchuan",
    suit = sgs.Card_Spade,
    number = 1,
    on_install = function(self,player)
       
    end,
    on_uninstall = function(self,player)
        
    end,
}

sfofl_jianchuan:clone(0,1):setParent(extension_card)
sfofl_jianchuan:clone(1,1):setParent(extension_card)
sfofl_jianchuan:clone(2,1):setParent(extension_card)
sfofl_jianchuan:clone(3,1):setParent(extension_card)
--[[
	技能名：楼船
	技能描述：宝物当你对一名角色使用牌时，你可以令其进入连环状态。
	引用：sfofl_louchuan
]] --

sfofl_louchuan_skill = sgs.CreateTriggerSkill {
	name = "sfofl_louchuan",
	frequency = sgs.Skill_NotFrequent,
	events = { sgs.TargetSpecified },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.TargetSpecified then
			local use = data:toCardUse()
			if not use.card:isKindOf("SkillCard") then
				for _, p in sgs.qlist(use.to) do
					if not p:isChained() then
						if player:askForSkillInvoke(self:objectName(), ToData(p)) then
                            room:setPlayerChained(p)
                        end
					end
				end
				
			end
		end
	end,
    can_trigger = function(self,target)
        return target and target:hasTreasure("sfofl_louchuan")
    end,
}

sfofl_louchuan = sgs.CreateTreasure{
    name = "sfofl_louchuan",
    class_name = "Louchuan",
    equip_skill = sfofl_louchuan_skill,
    suit = sgs.Card_Spade,
    number = 5,
    on_install = function(self,player)
        local room = player:getRoom()
        room:attachSkillToPlayer(player,"sfofl_louchuan")
    end,
    on_uninstall = function(self,player)
        player:getRoom():detachSkillFromPlayer(player,"sfofl_louchuan",true,true)
    end,
}
sfofl_louchuan:clone(0,13):setParent(extension_card)
sfofl_louchuan:clone(1,13):setParent(extension_card)
sfofl_louchuan:clone(2,13):setParent(extension_card)
sfofl_louchuan:clone(3,13):setParent(extension_card)

--[[
	技能名：一鼓作气
	技能描述：锦囊牌出牌阶段，对你使用，你本回合使用牌无距离和次数限制。
	引用：sfofl_yiguzuoqi
]] --
sfofl_yiguzuoqi = sgs.CreateTrickCard{
	name = "sfofl_yiguzuoqi",
	class_name = "Yiguzuoqi",
	subclass = sgs.LuaTrickCard_TypeSingleTargetTrick,
	target_fixed = true,
	can_recast = false,
	is_cancelable = true,
    available = function(self,player)
		return self:cardIsAvailable(player)
		and not player:isProhibited(player,self)
	end,
	about_to_use = function(self,room,use)
        local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
    	if use.to:isEmpty() then use.to:append(use.from) end
	    self:cardOnUse(room,use)
	end,
	on_effect = function(self,effect)
		local to,source,room = effect.to,effect.from,effect.to:getRoom()
		room:addPlayerMark(to, "&sfofl_yiguzuoqi-Clear")
	end
}
sfofl_yiguzuoqi_buff = sgs.CreateTargetModSkill{
	name = "#sfofl_yiguzuoqi_buff",
	pattern = ".",
	distance_limit_func = function(self, from, card)
		if from:getMark("&sfofl_yiguzuoqi-Clear") > 0 then
			return 1000
		else
			return 0
		end
	end,
    residue_func = function(self, player, card)
        if player:getMark("&sfofl_yiguzuoqi-Clear") > 0 then
			return 1000
		else
			return 0
		end
	end,
}
if not sgs.Sanguosha:getSkill("#sfofl_yiguzuoqi_buff") then skills:append(sfofl_yiguzuoqi_buff) end
sfofl_yiguzuoqi:clone(0,1):setParent(extension_card)
sfofl_yiguzuoqi:clone(1,12):setParent(extension_card)
sfofl_yiguzuoqi:clone(2,2):setParent(extension_card)
sfofl_yiguzuoqi:clone(3,13):setParent(extension_card)

--[[
	技能名：舌战
	技能描述：出牌阶段限一次，你可以和一名角色拼点，没赢的角色失去1点体力。
	引用：sfofl_barbs
]] --
sfofl_barbsCard = sgs.CreateSkillCard{
	name = "sfofl_barbs",
	target_fixed = false,
	will_throw = false,
	filter = function(self, targets, to_select, player)
		return #targets == 0 and player:canPindian(to_select, true)
	end,
	on_use = function(self, room, player, targets)
		local target = targets[1]
        local n = player:pindianInt(target,"sfofl_boyan")
        local loser
        if n>0 then 
            loser = target 
        elseif n<0 then 
            loser = player
        else
            room:loseHp(player, 1, true, player, self:objectName())
            room:loseHp(target, 1, true, target, self:objectName())
        end
        if loser then
            room:loseHp(loser, 1, true, loser, self:objectName())
        end
	end
}

sfofl_barbs = sgs.CreateViewAsSkill{
	name = "sfofl_barbs",
	n = 0,
	view_as = function(self, cards)
		return sfofl_barbsCard:clone()
	end,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_barbs")
	end, 
}
if not sgs.Sanguosha:getSkill("sfofl_barbs") then skills:append(sfofl_barbs) end

sfofl_caosong = sgs.General(extension_s, "sfofl_caosong", "wei", 4, true)
--[[
	技能名：礼赂
	相关武将：曹嵩[官盗]
	技能描述：摸牌阶段，你可以放弃摸牌，改为弃置任意张牌并将手牌摸至体力上限（最多摸至5张），然后将至少一张手牌交给一名其他角色；若你交出的牌数大于上次以此法交出的牌数，你增加1点体力上限并回复1点体力。
	引用：sfofl_lilu
]] --
sfofl_liluCard = sgs.CreateSkillCard
{
	name = "sfofl_lilu",
	target_fixed = false,	
	will_throw = false,		
	filter = function(self, targets, to_select, player)
	    return #targets == 0 and to_select:objectName()~= sgs.Self:objectName()
	end,
	on_use = function(self, room, source, targets)
		local x=source:getMark("&sfofl_lilu")
		room:setPlayerMark(source, "&sfofl_lilu", self:subcardsLength())
		local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_GIVE, source:objectName(),"sfofl_lilu","")
		room:moveCardTo(self, targets[1], sgs.Player_PlaceHand, reason)
		if (self:subcardsLength() > x) then
			room:gainMaxHp(source)
			local re = sgs.RecoverStruct()
			re.who = source
			room:recover(source, re, true)
		end
    end,
}
sfofl_liluVS = sgs.CreateViewAsSkill
{
	name = "sfofl_lilu",
	n = 999,
	view_filter = function(self, selected, to_select)                    
		return not to_select:isEquipped()
	end,
	view_as = function(self, cards)        
		if #cards == 0 then return end
		local acard = sfofl_liluCard:clone()
		for i = 1, #cards, 1 do   
			acard:addSubcard(cards[i])                
		end
		acard:setSkillName(self:objectName())
		return acard        
	end,
	enabled_at_play=function()
	    return false 
    end,
	enabled_at_response=function(self,player,pattern) 
	    return pattern == "@@sfofl_lilu"
    end
}
sfofl_lilu = sgs.CreateTriggerSkill
{
	name = "sfofl_lilu",
	view_as_skill = sfofl_liluVS,
    events = {sgs.EventPhaseProceeding},
	on_trigger=function(self,event,player,data)
        local room = player:getRoom()
        if player:getPhase() == sgs.Player_Draw then
            if player:askForSkillInvoke("sfofl_lilu",data) then
                room:askForDiscard(player, self:objectName(), 0, player:getCards("he"):length(), true, true)
                local x = math.min(5, player:getMaxHp())
                player:drawCards(x - player:getHandcardNum())
                room:askForUseCard(player,"@@sfofl_lilu!","@sfofl_lilu")
                return true 
            end
        end
    end
}

    
--[[
	技能名：翊正
	相关武将：曹嵩[官盗]
	技能描述：回合结束时，你可以选择一名其他角色。直到你的下回合开始，当该角色造成伤害或回复体力时，你减1点体力上限，然后此伤害或回复值+1。
	引用：sfofl_yizhengc
]] --

sfofl_yizhengc = sgs.CreateTriggerSkill{
	name = "sfofl_yizhengc",
	frequency = sgs.Skill_Frequent,
	events = {sgs.DamageCaused, sgs.EventPhaseChanging, sgs.EventPhaseStart,sgs.PreHpRecover},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.DamageCaused then
            local can_invoke = false
            for _,m in ipairs(player:getMarkNames()) do
                if (string.find(m,"&sfofl_yizhengc")) and (player:getMark(m) > 0) then
                    can_invoke = true
                    break
                end
            end
            if not can_invoke then return false end
			local cansongs = room:findPlayersBySkillName(self:objectName())
			for _,cansong in sgs.qlist(cansongs) do
				if player:getMark("sfofl_yizhengc"..cansong:objectName()) > 0 then
					local damage = data:toDamage()
					room:loseMaxHp(cansong)
					damage.damage = damage.damage + 1
					data:setValue(damage)
					room:broadcastSkillInvoke(self:objectName())
					local log= sgs.LogMessage()
                    log.type = "#skill_add_damage_byother1"
                    log.from = cansong
                    log.arg = "sfofl_yizhengc"
                    room:sendLog(log)
                    local log= sgs.LogMessage()
                    log.type = "#skill_add_damage_byother2"
                    log.from = damage.from
                    log.to:append(damage.to)
                    log.arg  = damage.damage
                    room:sendLog(log)
				end
			end
		elseif event == sgs.EventPhaseStart and player:hasSkill(self:objectName()) then
			if player:getPhase() == sgs.Player_RoundStart then
				for _,p in sgs.qlist(room:getOtherPlayers(player)) do
					if p:getMark("sfofl_yizhengc"..player:objectName()) > 0 then
						room:setPlayerMark(p, "sfofl_yizhengc"..player:objectName(), 0)
						room:setPlayerMark(p, "&sfofl_yizhengc+to+#"..player:objectName(), 0)
					end
				end
            end
        elseif event == sgs.EventPhaseChanging then
            local change = data:toPhaseChange()
            if change.to == sgs.Player_NotActive  and player:hasSkill(self:objectName()) then
                local target = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName(), "sfofl_yizhengc-invoke", true, true)
                if not target then return false end
                room:setPlayerMark(target, "sfofl_yizhengc"..player:objectName(), 1)
                room:setPlayerMark(target, "&sfofl_yizhengc+to+#"..player:objectName(), 1)
                room:broadcastSkillInvoke(self:objectName())
            end
		elseif event == sgs.PreHpRecover then
            local can_invoke = false
            for _,m in ipairs(player:getMarkNames()) do
                if (string.find(m,"&sfofl_yizhengc")) and (player:getMark(m) > 0) then
                    can_invoke = true
                    break
                end
            end
            if not can_invoke then return false end
			local cansongs = room:findPlayersBySkillName(self:objectName())
			for _,cansong in sgs.qlist(cansongs) do
				if player:getMark("sfofl_yizhengc"..cansong:objectName()) > 0 then
					room:broadcastSkillInvoke(self:objectName())
					local recover = data:toRecover()
					recover.recover = recover.recover + 1
					data:setValue(recover)
					room:loseMaxHp(cansong)
					local log= sgs.LogMessage()
                    log.type = "#skill_add_damage_byother1"
                    log.from = cansong
                    log.arg = "sfofl_yizhengc"
                    room:sendLog(log)
				end
			end
		end
	end,
    can_trigger = function(self, player)
        return player and player:isAlive()
    end,
}

sfofl_caosong:addSkill(sfofl_lilu)
sfofl_caosong:addSkill(sfofl_yizhengc)


sfofl_chengyu = sgs.General(extension_s, "sfofl_chengyu", "wei", 3, true)

--[[
	技能名：燎伏
	相关武将：程昱[官盗]
	技能描述：出牌阶段限一次，你可以扣置一张未以此法扣置过的类别的【杀】，其他角色于你的回合外使用【杀】时，你可以移去一张相同的【杀】，对其造成1点此【杀】属性的伤害。
	引用：sfofl_liaofu
]] --

sfofl_liaofuCard = sgs.CreateSkillCard{
    name = "sfofl_liaofu",
    will_throw = false,
    target_fixed = true,
    on_use = function(self, room, source, targets)
        local players = sgs.SPlayerList()
        players:append(source)
        source:addToPile("sfofl_liaofu", self, false, players)
        room:addPlayerMark(source, "sfofl_liaofu"..sgs.Sanguosha:getCard(self:getSubcards():first()):objectName())
    end
}

sfofl_liaofuVS = sgs.CreateOneCardViewAsSkill{
    name = "sfofl_liaofu",
    view_filter = function(self, card)
        return card:isKindOf("Slash") and sgs.Self:getMark("sfofl_liaofu"..card:objectName()) == 0
    end,
    view_as = function(self, card)
        local zhiheng_card = sfofl_liaofuCard:clone()
		zhiheng_card:addSubcard(card)
		return zhiheng_card
    end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_liaofu")
    end,
}

sfofl_liaofu = sgs.CreateTriggerSkill{
    name = "sfofl_liaofu",
    view_as_skill = sfofl_liaofuVS,
    events = {sgs.CardUsed},
    on_trigger = function(self,event,player,data, room)
        local use = data:toCardUse()
        if use.card and use.card:isKindOf("Slash") then
            for _,p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                if p:getPhase() == sgs.Player_NotActive and p:objectName() ~= use.from:objectName() then
                    if p:getPile("sfofl_liaofu"):isEmpty() then continue end
                    local card_ids = sgs.IntList()
                    for _,id in sgs.qlist(p:getPile("sfofl_liaofu")) do
                        local card = sgs.Sanguosha:getCard(id)
                        if card:isKindOf("Slash") and card:objectName() == use.card:objectName() then
                            card_ids:append(id)
                        end
                    end
                    if not card_ids:isEmpty() and p:askForSkillInvoke(self:objectName(), data) then
                        room:sendCompulsoryTriggerLog(p, self:objectName())
                        room:fillAG(card_ids, p)
                        local id = room:askForAG(p, card_ids, false, self:objectName())
                        room:clearAG(p)
                        local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_REMOVE_FROM_PILE, "","sfofl_liaofu", "")
                        local card = sgs.Sanguosha:getCard(id)
                        room:throwCard(card, reason, nil)
                        local damage = sgs.DamageStruct()
                        damage.from = p
                        damage.to = use.from
                        damage.damage = 1
                        damage.nature = getCardDamageNature(p, use.from, card)
                        room:damage(damage)
                    end
                end
            end
        end
    end,
    can_trigger = function(self,target)
        return target and target:isAlive()
    end
}

--[[
	技能名：烬守
	相关武将：程昱[官盗]
	技能描述：结束阶段，若你本回合体力值未变化过，你可以弃置所有手牌并失去1点体力，若如此做，直到你下回合开始，其他角色使用的仅指定你为目标的伤害牌无效。
	引用：sfofl_jinshou
]] --

sfofl_jinshou = sgs.CreateTriggerSkill{
    name = "sfofl_jinshou",
    frequency = sgs.Skill_Frequent,
    events = {sgs.EventPhaseEnd, sgs.HpChanged, sgs.TargetConfirmed},
    on_trigger = function(self,event,player,data, room)
        if event == sgs.EventPhaseEnd then
            if player:getPhase() == sgs.Player_Finish then
                if player:getMark("sfofl_jinshou-Clear") == 0 then
                    if player:askForSkillInvoke(self:objectName(), data) then
                        room:throwAllHandCards(player)
                        room:loseHp(player, 1, true, player, self:objectName())
                        room:addPlayerMark(player, "&sfofl_jinshou-SelfstartClear")
                    end
                end
            end
        elseif event == sgs.HpChanged and player:getPhase() ~= sgs.Player_NotActive then
            room:setPlayerMark(player, "sfofl_jinshou-Clear", 1)
        elseif event == sgs.TargetConfirmed then
            local use = data:toCardUse()
            if use.card and not use.card:isKindOf("SkillCard") and use.card:isDamageCard() and use.to:length() == 1 and use.to:contains(player) and use.from:objectName() ~= player:objectName() then
                if player:getMark("&sfofl_jinshou-SelfstartClear") > 0 then
                    local list = use.nullified_list
                    table.insert(list, "_ALL_TARGETS")
                    use.nullified_list = list
                    data:setValue(use)
                end
            end
        end
        return false
    end,
}


sfofl_chengyu:addSkill(sfofl_liaofu)
sfofl_chengyu:addSkill(sfofl_jinshou)



sfofl_5_caocao = sgs.General(extension_s, "sfofl_5_caocao", "wei", 4, true)

--[[
	技能名：旌聚
	相关武将：曹操[官盗]
	技能描述：锁定技，你的摸牌阶段摸牌数、攻击范围、出牌阶段使用【杀】次数为X（X为场上魏势力角色数，至多为5）。
	引用：sfofl_jingju
]] --

sfofl_jingju = sgs.CreateTriggerSkill{
    name = "sfofl_jingju",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.DrawNCards},
	on_trigger = function(self,event,player,data, room)
        local draw = data:toDraw()
        if draw.reason ~= "draw_phase" then return false end
        room:sendCompulsoryTriggerLog(player, self:objectName())
        local x = 0
        for _,p in sgs.qlist(room:getAllPlayers()) do
            if p:isAlive() and p:getKingdom() == "wei" then
                x = x + 1
            end
        end
        if x > 5 then x = 5 end
        draw.num = x
    end
}
sfofl_jingju_range = sgs.CreateAttackRangeSkill {
	name = "#sfofl_jingju_range",
	fixed_func = function(self, player, include_weapon)
        if player:hasSkill("sfofl_jingju") then
            local x = 0
            for _,p in sgs.qlist(player:getAliveSiblings()) do
                if p:getKingdom() == "wei" then
                    x = x + 1
                end
            end
            if x > 5 then x = 5 end
            return x
        end
        return -1
    end,
}
sfofl_jingju_buff = sgs.CreateTargetModSkill{
	name = "#sfofl_jingju_buff",
	pattern = "Slash",
    residue_func = function(self, player, card)
        if player:hasSkill("sfofl_jingju") then
            local x = 0
            for _,p in sgs.qlist(player:getAliveSiblings()) do
                if p:getKingdom() == "wei" then
                    x = x + 1
                end
            end
            if x > 5 then x = 5 end
            return x
        else
            return 0
        end
	end,
}


--[[
	技能名：泗恸
	相关武将：曹操[官盗]
	技能描述：每回合限一次，当一名角色使用的指定另一名魏势力角色为唯一目标的伤害牌结算结束后，你可以视为对其使用一张【杀】。
	引用：sfofl_sitong
]] --
sfofl_sitong = sgs.CreateTriggerSkill{
    name = "sfofl_sitong",
	frequency = sgs.Skill_Frequent,
	events = {sgs.CardFinished},
	on_trigger = function(self,event,player,data, room)
        if event == sgs.CardFinished then   
            local use = data:toCardUse()
            if use.card and not use.card:isKindOf("SkillCard") and use.to:length() == 1 and use.card:isDamageCard() and use.to:first():getKingdom() == "wei" then
                local to = use.to:first()
                for _,owner in sgs.list(room:findPlayersBySkillName("sfofl_sitong"))do
                    if to:objectName() ~= owner:objectName() and owner:getMark("sfofl_sitong-Clear") == 0 and room:askForSkillInvoke(owner, self:objectName(), data) then
                        room:addPlayerMark(owner, "sfofl_sitong-Clear")
                        local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                        slash:setSkillName(self:objectName())
                        slash:deleteLater()
                        local use = sgs.CardUseStruct()
                        use.from = owner
                        use.to:append(player)
                        use.card = slash
                        room:useCard(use, false)
                    end
                end
            end
        end
        return false
    end,
    can_trigger = function(self,target)
        return target
    end
}


sfofl_5_caocao:addSkill(sfofl_jingju)
sfofl_5_caocao:addSkill(sfofl_jingju_range)
extension_s:insertRelatedSkills("sfofl_jingju", "#sfofl_jingju_range")
sfofl_5_caocao:addSkill(sfofl_jingju_buff)
extension_s:insertRelatedSkills("sfofl_jingju", "#sfofl_jingju_buff")
sfofl_5_caocao:addSkill(sfofl_sitong)

sfofl_xunyu = sgs.General(extension_s, "sfofl_xunyu", "wei", 3, true)


--[[
	技能名：谏旌
	相关武将：荀彧[官盗]
	技能描述：出牌阶段限一次，你可以与一名角色拼点，赢的角色对其攻击范围内一名角色造成1点伤害。
	引用：sfofl_jianjing
]] --
sfofl_jianjingCard = sgs.CreateSkillCard{
    name = "sfofl_jianjing",
    target_fixed = false,
    will_throw = false,
    filter = function(self, targets, to_select, player)
        return (#targets == 0) and player:canPindian(to_select, true)
    end,
    on_use = function(self, room, source, targets)
        local tiger = targets[1]
        local n = source:pindianInt(tiger, self:objectName(), nil)
        if n < -1 then return end
        
        local winner = nil
        if n == -1 then
            winner = tiger
        elseif n == 1 then
            winner = source
        end
        if winner then
            local players = room:getOtherPlayers(tiger)
            local wolves = sgs.SPlayerList()
            for _,player in sgs.qlist(players) do
                if winner:inMyAttackRange(player) then
                    wolves:append(player)
                end
            end
            if wolves:isEmpty() then
                return
            end
            local wolf = room:askForPlayerChosen(winner, wolves, self:objectName(), "@quhu-damage:" .. tiger:objectName())
            room:damage(sgs.DamageStruct(self:objectName(), tiger, wolf))
        end
    end
}
sfofl_jianjing = sgs.CreateZeroCardViewAsSkill{
    name = "sfofl_jianjing",
    view_as = function(self, cards) 
        return sfofl_jianjingCard:clone()
    end, 
    enabled_at_play = function(self, player)
        return (not player:hasUsed("#sfofl_jianjing")) and not player:isKongcheng()
    end, 
}

--[[
	技能名：砥守
	相关武将：荀彧[官盗]
	技能描述：当你受到伤害时，若伤害来源的手牌数和体力值不相等，其选择一项：1.弃置所有手牌；2.失去1点体力，重复此流程直到手牌数和体力值相等或进入濒死状态。
	引用：sfofl_dishou
]] --
sfofl_dishou_Clear = sgs.CreateTriggerSkill{
    name = "#sfofl_dishou_Clear",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.EnterDying},
    on_trigger = function(self,event,player,data, room)
        local dying = data:toDying()
        if dying.hplost and dying.hplost.reason == "sfofl_dishou" then
            room:addPlayerMark(dying.who, "sfofl_dishou-Clear")
        end
    end,
    can_trigger = function(self,target)
        return target
    end
}


sfofl_dishou = sgs.CreateTriggerSkill{
    name = "sfofl_dishou",
	frequency = sgs.Skill_Frequent,
	events = {sgs.DamageInflicted},
	on_trigger = function(self,event,player,data, room)
        local damage = data:toDamage()
        if not damage.from then return false end
        if damage.from:isAlive() and damage.from:getHandcardNum() ~= damage.from:getHp() then
            while damage.from:isAlive() and not damage.from:isKongcheng() and damage.from:getHandcardNum() ~= damage.from:getHp() do
                local choicelist = {"losehp"}
                if not damage.from:isKongcheng() then
                    table.insert(choicelist, "discard")
                end
                local choice = room:askForChoice(damage.from, self:objectName(), table.concat(choicelist, "+"))
                if choice == "discard" then
                    room:throwAllHandCards(damage.from, self:objectName())
                else
                    room:loseHp(damage.from, 1, true, player, self:objectName())
                end
                if damage.from:getMark("sfofl_dishou-Clear") > 0 then
                    room:setPlayerMark(damage.from, "sfofl_dishou-Clear", 0)
                    break
                end
            end
        end
    end
}

sfofl_xunyu:addSkill(sfofl_jianjing)
sfofl_xunyu:addSkill(sfofl_dishou_Clear)
sfofl_xunyu:addSkill(sfofl_dishou)
extension_s:insertRelatedSkills("sfofl_dishou", "#sfofl_dishou_Clear")

sfofl_chengong = sgs.General(extension_s, "sfofl_chengong", "qun", 3, true)


--[[
	技能名：矫诤
	相关武将：陈宫[官盗]
	技能描述：每回合限一次，当你摸牌时，你可以改为令一名角色视为使用一张无距离限制的【杀】。
	引用：sfofl_jiaozheng
]] --



sfofl_jiaozheng = sgs.CreateTriggerSkill{
    name = "sfofl_jiaozheng",
	frequency = sgs.Skill_Frequent,
	events = {sgs.DrawNCards},
	on_trigger = function(self,event,player,data, room)
        if player:getMark("sfofl_jiaozheng-Clear") > 0 then return false end
        local to = room:askForPlayerChosen(player, room:getAlivePlayers(), self:objectName(), "sfofl_jiaozheng-invoke", true, true)
        if not to then return false end
        room:setPlayerFlag(to, "slashNoDistanceLimit")
        local slash = dummyCard()
        slash:setSkillName(self:objectName())
        local extra_targets = room:getCardTargets(to, slash)
        if extra_targets:isEmpty() then return false end
        room:setTag("sfofl_jiaozheng", data)
        local others = room:askForPlayersChosen(to, extra_targets, self:objectName(), 0, 1+sgs.Sanguosha:correctCardTarget(sgs.TargetModSkill_ExtraTarget,to,slash), "@sfofl_jiaozheng", true, true)
        room:removeTag("sfofl_jiaozheng")
        if others and others:length() > 0 then
            local use = sgs.CardUseStruct()
            use.from = to
            use.card = slash
            use.to = others
            room:useCard(use, false)
        end
        room:setPlayerFlag(to, "-slashNoDistanceLimit")
        local draw = data:toDraw()
        draw.num = 0
        data:setValue(draw)
    end
}
sfofl_chengong:addSkill("mingce")
sfofl_chengong:addSkill(sfofl_jiaozheng)

sfofl_zhangkai = sgs.General(extension_s, "sfofl_zhangkai", "qun", 4, true)


--[[
	技能名：黥金
	相关武将：张闿[官盗]
	技能描述：一名角色摸牌阶段结束时，若其此阶段摸牌数大于两张，你可以视为对其使用一张【杀】，若此【杀】未造成伤害，你失去1点体力。
	引用：sfofl_qingjin
]] --



sfofl_qingjin_record = sgs.CreateTriggerSkill{
    name = "#sfofl_qingjin_record",
	frequency = sgs.Skill_Frequent,
	events = {sgs.CardsMoveOneTime},
	on_trigger = function(self,event,player,data, room)
        if event == sgs.CardsMoveOneTime  then
            local move = data:toMoveOneTime()
            if move.to and (bit32.band(move.reason.m_reason, sgs.CardMoveReason_S_MASK_BASIC_REASON) == 
                    sgs.CardMoveReason_S_REASON_DRAW) then
                local to = room:findPlayerByObjectName(move.to:objectName())
                if to and to:getPhase() == sgs.Player_Draw then
                    room:addPlayerMark(to, "sfofl_qingjin-"..to:getPhase().."Clear" , move.card_ids:length())
                end
            end
        end
        return false
    end,
}
sfofl_qingjin = sgs.CreateTriggerSkill{
    name = "sfofl_qingjin",
	frequency = sgs.Skill_Frequent,
	events = {sgs.EventPhaseEnd, sgs.CardFinished},
	on_trigger = function(self,event,player,data, room)
        if event == sgs.EventPhaseEnd then
            if player:getPhase() == sgs.Player_Draw and player:getMark( "sfofl_qingjin-"..player:getPhase().."Clear" ) > 2 then
                for _,p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if room:askForSkillInvoke(p, self:objectName(), ToData(player)) then
                        local slash = dummyCard()
                        slash:setSkillName(self:objectName())
                        local use = sgs.CardUseStruct()
                        use.card = slash
                        use.from = p
                        use.to:append(player)
                        room:useCard(use)
                        if not player:isAlive() then break end
                    end
                end
            end
        elseif event == sgs.CardFinished then   
            local use = data:toCardUse()
            if use.card:isKindOf("Slash") and table.contains(use.card:getSkillNames(), "sfofl_qingjin") and not use.card:hasFlag("DamageDone") and player:objectName() == use.from:objectName() then
                room:loseHp(player, 1, true, player, self:objectName())
            end
        end
        return false
    end,
    can_trigger = function(self,target)
        return target
    end
}

sfofl_zhangkai:addSkill(sfofl_qingjin_record)
sfofl_zhangkai:addSkill(sfofl_qingjin)
extension_s:insertRelatedSkills("sfofl_qingjin", "#sfofl_qingjin_record")

sfofl_3_lvbu = sgs.General(extension_s, "sfofl_3_lvbu", "qun", 5, true)
--[[
	技能名：虓袭
	相关武将：吕布[官盗]
	技能描述：游戏开始时，你获得7个标记。摸牌阶段，你改为摸标记数的牌，然后移去一个标记。
	引用：sfofl_xiaoxi
]] --
sfofl_xiaoxi = sgs.CreateTriggerSkill{
    name = "sfofl_xiaoxi",
	frequency = sgs.Skill_Frequent,
	events = {sgs.GameStart, sgs.DrawNCards},
	on_trigger = function(self,event,player,data, room)
        if event == sgs.GameStart then
            room:setPlayerMark(player, "&sfofl_xiaoxi", 7)
        elseif event == sgs.DrawNCards then
            local draw = data:toDraw()
            if draw.reason ~= "draw_phase" then return false end
            local mark = player:getMark("&sfofl_xiaoxi")
            if mark > 0 then
                room:sendCompulsoryTriggerLog(player, self:objectName())
                draw.num = mark
                data:setValue(draw)
                room:setPlayerMark(player, "&sfofl_xiaoxi", mark -1)
            end
        end
        return false
    end
}



--[[
	技能名：焚骑
	相关武将：吕布[官盗]
	技能描述：出牌阶段限一次，你可以移去一个标记，获得一张【一鼓作气】。
	引用：sfofl_fenqi
]] --

sfofl_fenqiCard = sgs.CreateSkillCard{
	name = "sfofl_fenqi",
    target_fixed = true,
	on_use = function(self, room, source, targets)
		room:removePlayerMark(source, "&sfofl_xiaoxi", 1)
        for _,id in sgs.qlist(sgs.Sanguosha:getRandomCards(true))do
            local nmrq = sgs.Sanguosha:getEngineCard(id)
            if room:getCardOwner(id) then continue end
            if not nmrq:isKindOf("Yiguzuoqi") then continue end
            room:obtainCard(player,nmrq)
            break
        end
        
	end
}
sfofl_fenqi = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_fenqi",
	view_as = function(self) 
		return sfofl_fenqiCard:clone()
	end, 
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_fenqi") and player:getMark("&sfofl_xiaoxi") > 0
    end
}

sfofl_3_lvbu:addSkill(sfofl_xiaoxi)
sfofl_3_lvbu:addSkill(sfofl_fenqi)

sfofl_zhangmiao = sgs.General(extension_s, "sfofl_zhangmiao", "qun", 4, true)

--[[
	技能名：谋逆
	相关武将：张邈[官盗]
	技能描述：回合开始时，你可以令一名其他角色展示所有手牌，对其依次使用其中所有的【杀】直到该角色进入濒死状态。若以此法使用的【杀】均未造成伤害，你结束此回合。
	引用：sfofl_mouni
]] --
sfofl_mouni = sgs.CreateTriggerSkill{
    name = "sfofl_mouni",
	frequency = sgs.Skill_Frequent,
	events = {sgs.EventPhaseStart, sgs.EnterDying, sgs.CardFinished},
	on_trigger = function(self,event,player,data, room)
        if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_RoundStart and player:hasSkill(self:objectName()) then
            local target = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName(), "sfofl_mouni-invoke")
            if not target then return false end
            room:showAllCards(target)
            local cards = sgs.IntList()
            for _,id in sgs.qlist(target:getHandcards()) do
                if id:isKindOf("Slash") then
                    cards:append(id:getId())
                end
            end
            for _,card_id in sgs.qlist(cards) do
                local slash = sgs.Sanguosha:getCard(card_id)
                slash:setSkillName(self:objectName())
                local use = sgs.CardUseStruct()
                use.card = slash
                use.from = player
                use.to:append(target)
                room:useCard(use)
                if not target:isAlive() then break end
                if player:getMark("sfofl_mouni_dying-Clear") > 0 then
                    break
                end
            end
            if player:getMark("sfofl_mouni_damage-Clear") == 0 then
                room:sendCompulsoryTriggerLog(player, self:objectName())
                room:throwEvent(sgs.TurnBroken)
            end
        elseif event == sgs.EnterDying then
            local dying = data:toDying()
            if dying.damage and dying.damage.card and dying.damage.card:getSkillName() == self:objectName() then
                room:addPlayerMark(dying.damage.from, "sfofl_mouni_dying-Clear")
            end
        elseif event == sgs.CardFinished then
            local use = data:toCardUse()
            if use.card and use.card:getSkillName() == self:objectName() and player:objectName() == use.from:objectName() then
                if use.card:hasFlag("DamageDone") then
                    room:setPlayerMark(player, "sfofl_mouni_damage-Clear", 1)
                end
            end
        end
    end,
    can_trigger = function(self,target)
        return target
    end
}

--[[
	技能名：纵反
	相关武将：张邈[官盗]
	技能描述：觉醒技，回合结束时，若你本回合发动“谋逆”且有角色进入濒死状态，你交给一名其他角色任意张牌，加X点体力上限并回复X点体力（X为你交给该角色的牌数且最多为5），失去“谋逆”，获得“战孤”。
	引用：sfofl_zongfan
]] --

sfofl_zongfan = sgs.CreateTriggerSkill{
    name = "sfofl_zongfan",
	frequency = sgs.Skill_Wake,
	events = {sgs.EventPhaseChanging},
    waked_skills = "sfofl_zhangu",
	on_trigger = function(self,event,player,data, room)
        if event == sgs.EventPhaseChanging and data:toPhaseChange().from == sgs.Player_Finish then
            room:sendCompulsoryTriggerLog(player, self:objectName())
            local target = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName(), "sfofl_zongfan-invoke")
            local cards = room:askForExchange(player, self:objectName(), 0, 5, true, "@sfofl_zongfan:"..target:objectName(), false)
            local x = cards:length()
            if x > 0 then
                room:obtainCard(target, cards, false)
                room:changePlayerMaxHp(player, x, self:objectName())
                room:recover(player, sgs.RecoverStruct(self:objectName(), player, x))
            end
            room:detachSkillFromPlayer(player, "sfofl_mouni")
            room:acquireSkill(player, "sfofl_zhangu")
            room:setPlayerMark(player, "sfofl_zongfan", 1)
        end
    end,
    can_trigger = function(self,target)
        if target and target:isAlive() then
            if target:getMark("sfofl_zongfan") == 0 then
                return target:getMark("sfofl_mouni_dying-Clear") > 0 or target:canWake(self:objectName())
            end
        end
        return false
    end
}

--[[
	技能名：战孤
	相关武将：张邈[官盗]
	技能描述：锁定技，回合开始时，若你体力上限大于1且没有手牌或装备区没有牌，你减1点体力上限，然后摸两张牌。
	引用：sfofl_zhangu
]] --

sfofl_zhangu = sgs.CreateTriggerSkill{
    name = "sfofl_zhangu",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.EventPhaseStart},
	on_trigger = function(self,event,player,data, room)
        if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_RoundStart then
            if (player:getMaxHp() > 1 and player:isKongcheng()) or player:getEquips():isEmpty() then
                room:sendCompulsoryTriggerLog(player, self:objectName())
                room:loseMaxHp(player)
                player:drawCards(2, self:objectName())
            end
        end
    end
}


sfofl_zhangmiao:addSkill(sfofl_mouni)
sfofl_zhangmiao:addSkill(sfofl_zongfan)
if not sgs.Sanguosha:getSkill("sfofl_zhangu") then skills:append(sfofl_zhangu) end






--[[
	技能名：荆襄盛世
	技能描述：锦囊\你指定X名其他角色为目标，并亮出牌堆顶存活人数张牌，这些角色依次获得其中一张（X为全场势力数）。
	引用：sfofl_jingxiang_goldenage
]] --
sfofl_jingxiang_goldenage = sgs.CreateTrickCard{
	name = "_sfofl_jingxiang_goldenage",
	class_name = "JingxiangGoldenage",
    subtype = "sfofl_shenliubiao_card",
	subclass = sgs.LuaTrickCard_LuaTrickCard_TypeNormal,
	target_fixed = false,
	can_recast = false,
	is_cancelable = true,
    available = function(self,player)
    	local tos = player:getAliveSiblings()
		tos:append(player)
		for _,to in sgs.list(tos)do
			if CanToCard(self,player,to) then
				return self:cardIsAvailable(player)
			end
		end
    end,
    filter = function(self,targets,to_select,source)
	    return #targets<sgs.Sanguosha:correctCardTarget(sgs.TargetModSkill_ExtraTarget,source,self)+getKingdoms(source)
		and not source:isProhibited(to_select,self) and source:objectName() ~= to_select:objectName()
	end,
    feasible = function(self,targets,from)
		return #targets==getKingdoms(from)
	end,
	about_to_use = function(self,room,use)
	    self:cardOnUse(room,use)
	end,
    on_use = function(self, room, source, targets)
        local x = room:getAlivePlayers():length()
        if x <= 0 then return end
        local card_ids = room:getNCards(x)
        room:fillAG(card_ids)
        local _data = sgs.QVariant()
        _data:setValue(card_ids)
        room:setTag("JingxiangGoldenage", _data)
		for _, t in ipairs(targets) do
			room:cardEffect(self, source, t)
		end
        room:clearAG()
        local ag_list = room:getTag("JingxiangGoldenage"):toIntList()
        if (ag_list:isEmpty()) then return end
        local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
        dummy:addSubcards(ag_list)
        dummy:deleteLater()
        room:obtainCard(source,dummy)
        -- local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_NATURAL_ENTER, "", "_sfofl_jingxiang_goldenage", "")
        -- room:throwCard(dummy, reason, nil)
        room:removeTag("JingxiangGoldenage")
	end,
    on_effect = function(self,effect)
		local to,from,room = effect.to,effect.from,effect.to:getRoom()
        local card_ids = room:getTag("JingxiangGoldenage"):toIntList()
        if card_ids:isEmpty() then return end
        local card_id = room:askForAG(to, card_ids, false, "_sfofl_jingxiang_goldenage")
        room:takeAG(to, card_id)
        card_ids:removeOne(card_id)
        local _data = sgs.QVariant()
        _data:setValue(card_ids)
        room:setTag("JingxiangGoldenage", _data)
    end
}
sfofl_jingxiang_goldenage:clone(2,5):setParent(extension_card)
sfofl_jingxiang_goldenage:clone(2,5):setParent(extension_card)
sfofl_shenliubiao = sgs.General(extension_e, "sfofl_shenliubiao", "god", 2)
--[[
	技能名：雄据
	相关武将：神刘表[官盗]
	技能描述：锁定技，游戏开始时，你从游戏外获得两张【荆襄盛世】，你的起始手牌+X，手牌上限+X，体力值和体力上限+X（X为场上势力数）。
	引用：sfofl_xiongju
]] --
sfofl_xiongju = sgs.CreateTriggerSkill{
    name = "sfofl_xiongju",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.GameStart, sgs.DrawNCards},
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
		if event == sgs.GameStart then
            local x = 0
			for _,id in sgs.qlist(sgs.Sanguosha:getRandomCards(true))do
                local nmrq = sgs.Sanguosha:getEngineCard(id)
                if nmrq:objectName()~="_sfofl_jingxiang_goldenage"
                or room:getCardOwner(id) then continue end
                room:obtainCard(player,nmrq)
                x = x + 1
                if x >= 2 then 
                    break
                end
            end
            room:setPlayerProperty(player,"maxhp",ToData(player:getMaxHp()+getKingdoms(player)))
            room:setPlayerProperty(player,"hp",ToData(player:getHp()+getKingdoms(player)))
		elseif event == sgs.DrawNCards then
			local draw = data:toDraw()
			if draw.reason ~= "InitialHandCards" then return false end
            draw.num = draw.num + getKingdoms(player)
            data:setValue(draw)
		end
	end,
}
sfofl_xiongju_cardmax = sgs.CreateMaxCardsSkill {
	name = "#sfofl_xiongju_cardmax",
	extra_func = function(self, target)
		if target:hasSkill("sfofl_xiongju") then
			return getKingdoms(target)
		end
        return 0
	end
}

--[[
	技能名：富荆
	相关武将：神刘表[官盗]
	技能描述：锁定技，你跳过摸牌阶段，并改为使用一张【荆襄盛世】。依此法获得牌的其他角色本轮首次对你使用牌时需弃置一张牌。
	引用：sfofl_fujing
]] --
sfofl_fujing = sgs.CreateTriggerSkill{
    name = "sfofl_fujing",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.EventPhaseChanging},
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
		if event == sgs.EventPhaseChanging then
            local change = data:toPhaseChange()
            if change.to == sgs.Player_Draw and not player:isSkipped(sgs.Player_Draw) then
                room:sendCompulsoryTriggerLog(player, self:objectName(), true)
                player:skip(sgs.Player_Draw)
                local card = sgs.Sanguosha:cloneCard("_sfofl_jingxiang_goldenage", sgs.Card_NoSuit, 0)
                card:setSkillName("sfofl_fujing")
                card:deleteLater()
                local extra_targets = room:getCardTargets(player, card)
                local others = room:askForPlayersChosen(player, extra_targets, self:objectName(), getKingdoms(player), getKingdoms(player), "@sfofl_fujing:"..card:objectName(), true, true)
			    if others and others:length() > 0 then
                    local use = sgs.CardUseStruct()
                    use.from = player
                    use.card = card
                    use.to = others
                    room:useCard(use, false)
                end
            end
		end
	end,
}
sfofl_fujing_buff = sgs.CreateTriggerSkill{
	name = "#sfofl_fujing_buff",
	frequency = sgs.Skill_Frequent,
	events = {sgs.CardsMoveOneTime, sgs.CardUsed, sgs.CardFinished},
	on_trigger = function(self, event, player, data, room)
        if event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            local card_ids = room:getTag("JingxiangGoldenage"):toIntList()
            if card_ids:isEmpty() then return end
            for _,p in sgs.qlist(room:findPlayersBySkillName("sfofl_fujing")) do
                if p:hasFlag("sfofl_fujing") and player:objectName() ~= p:objectName() then
                    if (move.to and (move.to:objectName() == player:objectName() and move.to_place == sgs.Player_PlaceHand)) then
                        for _,id in sgs.qlist(move.card_ids) do						
                            if not card_ids:contains(id) then card_ids:removeOne(id) end
                        end
                        if not card_ids:isEmpty() then
                            room:setPlayerMark(player, "&sfofl_fujing+to+#"..p:objectName().."_lun", 1)
                            break
                        end
                    end
                end
			end
        elseif event == sgs.CardUsed then
            local use = data:toCardUse()
            if use.card and not use.card:isKindOf("SkillCard") then
                if use.from and use.from:objectName() == player:objectName() then
                    for _,p in sgs.qlist(use.to) do
                        if player:getMark("&sfofl_fujing+to+#"..p:objectName().."_lun") > 0 then
                            room:setPlayerMark(player, "&sfofl_fujing+to+#"..p:objectName().."_lun", 0)
                            if player:canDiscard(player, "he") then
                                room:askForDiscard(player, "sfofl_fujing", 1,1,false, true)
                            end
                        end
                    end
                end
            end
            if use.card and use.from and use.card:isKindOf("JingxiangGoldenage") and player:objectName() == use.from:objectName() and player:hasSkill("sfofl_fujing")  then
                room:setPlayerFlag(player, "sfofl_fujing")
            end
        elseif event == sgs.CardFinished then
            local use = data:toCardUse()
            if use.card and use.from and use.card:isKindOf("JingxiangGoldenage") and player:objectName() == use.from:objectName() and player:hasSkill("sfofl_fujing")  then
                room:setPlayerFlag(player, "-sfofl_fujing")
            end
		end
	end,
	can_trigger = function(self, target)
		return target
	end
}

--[[
	技能名：雍容
	相关武将：神刘表[官盗]
	技能描述：每回合限一次，你造成/受到伤害时，若受伤角色/伤害来源的手牌小于你，你可以交给其一张牌令此伤害+1/-1。
	引用：sfofl_yongrong
]] --

sfofl_yongrong = sgs.CreateTriggerSkill{
    name = "sfofl_yongrong",
	frequency = sgs.Skill_Frequent,
	events = {sgs.DamageCaused, sgs.DamageInflicted},
	on_trigger = function(self, event, player, data)
	    local room = player:getRoom()
        if player:getMark(self:objectName().."-Clear") > 0 then return end
		local target
        local damage = data:toDamage()
        if event == sgs.DamageCaused then
            if damage.to and damage.to:isAlive() then
                target = damage.to
            end
        end
        if event == sgs.DamageInflicted then
            if damage.from and damage.from:isAlive() then
                target = damage.from
            end
        end
        if target and target:getHandcardNum() < player:getHandcardNum() then
            local prompt
            if event == sgs.DamageCaused then
                prompt = string.format("@sfofl_yongrong_increase:%s", target:objectName())
            else
                prompt = string.format("@sfofl_yongrong_decrease:%s", target:objectName())
            end
            local card = room:askForCard(player, ".", prompt, data, sgs.Card_MethodNone, target, false)
            if card then
                room:addPlayerMark(player, self:objectName().."-Clear")
                room:addPlayerMark(player, "&"..self:objectName().."-Clear")
                local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_EXTRACTION, player:objectName())
                room:obtainCard(target, card, reason, false)
                if event == sgs.DamageCaused then
                    player:damageRevises(data,1)
                else
                    player:damageRevises(data,-1)
                end
            end
        end
	end,
}




sfofl_shenliubiao:addSkill(sfofl_xiongju)
sfofl_shenliubiao:addSkill(sfofl_xiongju_cardmax)
extension_e:insertRelatedSkills("sfofl_xiongju", "#sfofl_xiongju_cardmax")
sfofl_shenliubiao:addSkill(sfofl_fujing)
sfofl_shenliubiao:addSkill(sfofl_fujing_buff)
extension_e:insertRelatedSkills("sfofl_fujing", "#sfofl_fujing_buff")
sfofl_shenliubiao:addSkill(sfofl_yongrong)


sfofl_shencaoren = sgs.General(extension_e, "sfofl_shencaoren", "god", 4)
--[[
	技能名：据守
	相关武将：神曹仁[官盗]
	技能描述：结束阶段，你可以翻面并摸Ｘ张牌（X 为场上存活人数）。然后你可以令全场翻面并各摸三张牌，若如此做你弃置场上所有装备，失去“据守”并获得“突围”。
	引用：sfofl_jushou
]] --
sfofl_jushou = sgs.CreateTriggerSkill {
	name = "sfofl_jushou",
	frequency = sgs.Skill_NotFrequent,
	events = { sgs.EventPhaseStart },
    waked_skills = "sfofl_tuwei",
	on_trigger = function(self, event, player, data)
		local phase = player:getPhase()
		if phase == sgs.Player_Finish then
			local room = player:getRoom()
			if room:askForSkillInvoke(player, self:objectName(), data) then
				room:broadcastSkillInvoke(self:objectName())
                player:turnOver()
				room:drawCards(player, room:getAlivePlayers():length(), self:objectName())
                if room:askForSkillInvoke(player, self:objectName().."TurnOver", data) then
                    local players = room:getAllPlayers()
                    for _, p in sgs.qlist(players) do
                        p:turnOver()
                        room:drawCards(p, 3, self:objectName())
                    end
                    for _, p in sgs.qlist(players) do
                        if player:canDiscard(p, "e") then
                            local discards = sgs.IntList()
                            for i = 1, p:getEquips():length() do--进行多次执行
                                local id = room:askForCardChosen(player, p, "e", self:objectName(),
                                    false,--选择卡牌时手牌不可见
                                    sgs.Card_MethodDiscard,--设置为弃置类型
                                    discards,--将子卡表设置为不可选卡牌id表（保证每张卡只能被选择一次）
                                    false)--只有执行过一次选择才可取消
                                if id < 0 then break end--如果卡牌id无效就结束多次执行
                                discards:append(id)--将选择的id添加到虚拟卡的子卡表
                            end
                            room:throwCard(discards, "sfofl_jushou", p, player)
                        end
                    end
                    room:handleAcquireDetachSkills(player, "-sfofl_jushou")
                    room:handleAcquireDetachSkills(player, "sfofl_tuwei")
                end
			end
		end
	end
}


--[[
	技能名：突围
	相关武将：神曹仁[官盗]
	技能描述：本局游戏每名角色限一次，出牌阶段你可以将弃牌堆的一张装备牌置入一名角色对应的装备区内，然后若其不为你，则你可以令其摸一张牌或对其造成１点伤害。
	引用：sfofl_tuwei
]] --
sfofl_tuweiCard = sgs.CreateSkillCard{
	name = "sfofl_tuwei" ,
	filter = function(self, targets, to_select, player)
		return (#targets == 0) and (to_select:getMark("&sfofl_tuwei+to+#"..player:objectName()) == 0) 
	end ,
	on_effect = function(self, effect)
		local ids = sgs.IntList()
		local room = effect.from:getRoom()
        for _, id in sgs.qlist(room:getDiscardPile()) do
            if sgs.Sanguosha:getCard(id):isKindOf("EquipCard") then
                ids:append(id)
            end
        end
        if ids:isEmpty() then return end
        room:fillAG(ids)
        if not ids:isEmpty() then
            local card_id = room:askForAG(effect.from, ids, false, self:objectName())
            if InstallEquip(card_id,effect.to,self) then 
            else
            local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_NATURAL_ENTER,effect.to:objectName(),self:objectName(),nil)
            room:throwCard(card_id,reason,nil)
            end
            room:addPlayerMark(effect.to, "&sfofl_tuwei+to+#"..effect.from:objectName())
            if effect.to:objectName() ~= effect.from:objectName() then
                local choice = room:askForChoice(effect.from, self:objectName(), "draw+damage+cancel", ToData(effect.to))
                if choice == "draw" then 
                    effect.to:drawCards(1, self:objectName())
                elseif choice == "damage" then 
                    local damage = sgs.DamageStruct()
                    damage.from = effect.from
                    damage.to = effect.to
                    damage.damage = 1
                    room:damage(damage)
                end 
            end
        end
        room:clearAG()
	end
}
sfofl_tuwei = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_tuwei",
	view_as = function()
		return sfofl_tuweiCard:clone()
	end ,
	enabled_at_play = function(self, player)
		if (player:getMark("&sfofl_tuwei+to+#"..player:objectName()) == 0) then return true end
		for _, sib in sgs.qlist(player:getSiblings()) do
			if (sib:getMark("&sfofl_tuwei+to+#"..player:objectName()) == 0) then return true end
		end
		return false
	end 
}

sfofl_shencaoren:addSkill(sfofl_jushou)
if not sgs.Sanguosha:getSkill("sfofl_tuwei") then skills:append(sfofl_tuwei) end

sfofl_4_zhouyu = sgs.General(extension_e, "sfofl_4_zhouyu", "wu", 3)
--[[
	技能名：雄姿
	相关武将：周瑜[官盗]
	技能描述：锁定技，摸牌阶段你额外摸 X 张牌，你的手牌上限 + X （X 为你当前的体力值）。
	引用：sfofl_xiongzi
]] --


sfofl_xiongzi = sgs.CreateTriggerSkill {
    name = "sfofl_xiongzi",
    frequency = sgs.Skill_Compulsory,
    events = { sgs.DrawNCards },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local draw = data:toDraw()
        if draw.reason ~= "draw_phase" then return false end
        room:sendCompulsoryTriggerLog(player, self:objectName(), true)
        draw.num = draw.num + player:getHp()
        data:setValue(draw)
    end
}
sfofl_xiongzi_cardmax = sgs.CreateMaxCardsSkill {
	name = "#sfofl_xiongzi_cardmax",
	extra_func = function(self, target)
		if target:hasSkill("sfofl_xiongzi") then
			return target:getHp()
		end
        return 0
	end
}



--[[
	技能名：绽焱
	相关武将：周瑜[官盗]
	技能描述：出牌阶段限一次，你可以令一名其他角色猜测你的红色手牌数量，然后你展示你的手牌并将所有红色手牌交给其，然后你对其造成猜测数与你红色手牌之差的火焰伤害，且至多为３。
	引用：sfofl_2_zhanyan
]] --
sfofl_2_zhanyanCard = sgs.CreateSkillCard{
	name = "sfofl_2_zhanyan" ,
	filter = function(self, targets, to_select, player)
		return (#targets == 0)
	end ,
	on_effect = function(self, effect)
		local room = effect.from:getRoom()
        local x = 0
        local guess = {}
        for i = 0, effect.from:getHandcardNum(), 1 do
            table.insert(guess, i)
        end
        local num = tonumber(room:askForChoice(effect.to, "sfofl_2_zhanyan", table.concat(guess, "+"), ToData(effect.from)))
        room:showAllCards(effect.from, nil)
		local dummy_card = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
		for _, p in sgs.qlist(effect.from:getHandcards()) do
			if p:isRed() then
				dummy_card:addSubcard(p)
			end
		end
		room:obtainCard(effect.to, dummy_card)
		dummy_card:deleteLater()
		x = math.min(math.abs(dummy_card:subcardsLength() - num), 3)
        if x > 0 then
            local damage = sgs.DamageStruct()
            damage.from = effect.from
            damage.to = effect.to
            damage.nature = sgs.DamageStruct_Fire
            damage.damage = x
            room:damage(damage)
        end
	end
}
sfofl_2_zhanyan = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_2_zhanyan",
	view_as = function()
		return sfofl_2_zhanyanCard:clone()
	end ,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_2_zhanyan") and not player:isKongcheng()
	end 
}



sfofl_4_zhouyu:addSkill(sfofl_xiongzi)
sfofl_4_zhouyu:addSkill(sfofl_xiongzi_cardmax)
extension_e:insertRelatedSkills("sfofl_xiongzi", "#sfofl_xiongzi_cardmax")
sfofl_4_zhouyu:addSkill(sfofl_2_zhanyan)


sfofl_4_guanyu = sgs.General(extension_e, "sfofl_4_guanyu", "shu", 4)

--[[
	技能名：武圣
	相关武将：关羽[官盗]
	技能描述：你可以将一张红色牌当【杀】/【酒】使用或打出；你使用方片【杀】无距离限制。
	引用：sfofl_wusheng
]] --
sfofl_wusheng_buff = sgs.CreateTargetModSkill{
    name = "#sfofl_wusheng_buff",
    pattern = "Slash",
    distance_limit_func = function(self, from, card, to)
        if from:hasSkill("sfofl_wusheng") and card and card:getSuit() == sgs.Card_Diamond then return 1000 end
        return 0
    end,
}

sfofl_wushengCard = sgs.CreateSkillCard{
	name = "sfofl_wusheng",
	will_throw = false,
	mute = true,
	filter = function(self,targets,to_select,user)
		local plist = sgs.PlayerList()
		for i = 1,#targets do plist:append(targets[i]) end
		if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
			local card,user_str = nil,self:getUserString()
			if user_str ~= "" then
				local us = user_str:split("+")
				card = sgs.Sanguosha:cloneCard(us[1])
			end
			return card and card:targetFilter(plist,to_select,user)
		elseif sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE then
			return false
		end
		local card = user:getTag("sfofl_wusheng"):toCard()
		return card and card:targetFilter(plist,to_select,user)
	end,
	feasible = function(self,targets,user)
		local plist = sgs.PlayerList()
		for i = 1,#targets do plist:append(targets[i]) end
		if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
			local card,user_str = nil,self:getUserString()
			if user_str ~= "" then
				local us = user_str:split("+")
				card = sgs.Sanguosha:cloneCard(us[1])
			end
			return card and card:targetsFeasible(plist,user)
		elseif sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE then
			return true
		end
		local card = user:getTag("sfofl_wusheng"):toCard()
		return card and card:targetsFeasible(plist,user)
	end,
	on_validate = function(self,card_use)
		local player = card_use.from
		local room,to_sfofl_wusheng = player:getRoom(),self:getUserString()
		local card = nil
		local user_str
		if to_sfofl_wusheng == "slash" then
			if card and card:objectName() == "slash" then
				user_str = card:objectName()
			else
				user_str = "slash"
			end
		else
			user_str = to_sfofl_wusheng
		end
		local use_card = sgs.Sanguosha:cloneCard(user_str)
		use_card:setSkillName("sfofl_wusheng")
		use_card:addSubcards(self:getSubcards())
		use_card:deleteLater()
		return use_card
	end,
	on_validate_in_response = function(self,user)
		local room,user_str = user:getRoom(),self:getUserString()
		local to_sfofl_wusheng
		if user_str == "peach+analeptic" then
			to_sfofl_wusheng = "analeptic"
		else
			to_sfofl_wusheng = user_str
		end
		local card = nil
		local user_str
		if to_sfofl_wusheng == "slash" then
			if card and card:objectName() == "slash" then
				user_str = card:objectName()
			else
				user_str = "slash"
			end
		else
			user_str = to_sfofl_wusheng
		end
		local use_card = sgs.Sanguosha:cloneCard(user_str)
		use_card:addSubcards(self:getSubcards())
		use_card:setSkillName("sfofl_wusheng")
		use_card:deleteLater()
		return use_card
	end,
}
sfofl_wushengVS = sgs.CreateViewAsSkill{
	name = "sfofl_wusheng",
	n = 1,
	response_or_use = true,
	view_filter = function(self,selected,to_select)
		if not to_select:isRed() then return false  end
		return #selected<1
	end,
	view_as = function(self,cards)
		if #cards ~= 1 then return nil end
		--local sc = sfofl_wushengCard:clone()
		--sc:setSkillName(self:objectName())
		if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE
		or sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
			local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
			local sc = sgs.Sanguosha:cloneCard(pattern:split("+")[1])
			sc:setSkillName(self:objectName())
			for _,card in ipairs(cards)do
				sc:addSubcard(card)
			end
			return sc
		end
		local c = sgs.Self:getTag("sfofl_wusheng"):toCard()
		if c then
			local sc = sgs.Sanguosha:cloneCard(c:objectName())
			sc:setSkillName(self:objectName())
			for _,card in ipairs(cards)do
				sc:addSubcard(card)
			end
			return sc
		end
	end,
	enabled_at_play = function(self,player)
		for _,patt in ipairs(patterns())do
			local dc = dummyCard(patt)
			if dc and (dc:isKindOf("Slash") or dc:isKindOf("Analeptic")) then
				dc:setSkillName(self:objectName())
				if dc:isAvailable(player)
				then return true end
			end
		end
	end,
	enabled_at_response = function(self,player,pattern)
		for _,pt in sgs.list(pattern:split("+"))do
			local dc = dummyCard(pt)
			if dc and (dc:isKindOf("Slash") or dc:isKindOf("Analeptic")) then
				return true
			end
		end
	end,
}
sfofl_wusheng = sgs.CreateTriggerSkill{
	name = "sfofl_wusheng",
	view_as_skill = sfofl_wushengVS,
	events = {sgs.GameStart},
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
        for _,patt in ipairs(patterns())do
			local dc = dummyCard(patt)
			if dc and dc:isKindOf("BasicCard") then
                if (dc:isKindOf("Slash") or dc:isKindOf("Analeptic")) then
                else
                    room:addPlayerMark(player,"sfofl_wusheng_guhuo_remove_"..dc:objectName())
                end
            end
        end
	end,
}
sfofl_wusheng:setGuhuoDialog("l")

sfofl_4_guanyu:addSkill(sfofl_wusheng_buff)
sfofl_4_guanyu:addSkill(sfofl_wusheng)
extension_e:insertRelatedSkills("sfofl_wusheng", "#sfofl_wusheng_buff")
sfofl_4_guanyu:addSkill("kechengguanjue")
sfofl_4_guanyu:addSkill("nuzhan")

sfofl_fuyun = sgs.General(extension_e, "sfofl_fuyun", "qun", 4)
--[[
	技能名：随去
	相关武将：浮云[官盗]
	技能描述：锁定技，每名角色的弃牌阶段，你弃置所有手牌，若你因此弃置至少一张牌，你选择一项：1.加1点体力上限；2.回复1点体力。
	引用：sfofl_suiqu
]] --
sfofl_suiqu = sgs.CreateTriggerSkill{
	name = "sfofl_suiqu",
	events = {sgs.EventPhaseProceeding},
	on_trigger = function(self,event,player,data,room)
        if event==sgs.EventPhaseProceeding then
			if player:getPhase()==sgs.Player_Discard then
                for _,p in sgs.list(room:findPlayersBySkillName(self:objectName()))do
                    if p:canDiscard(p, "h") then
                        p:throwAllHandCards()
                        local choicelist = "maxhp"
                        if p:isWounded() then
                            choicelist = string.format("%s+%s", choicelist, "hp")
                        end
                        local choice = room:askForChoice(p, self:objectName(), choicelist)
                        if choice == "hp" then
                            local recover = sgs.RecoverStruct()
                            recover.who = p
                            room:recover(p, recover)
                        else
                            room:setPlayerProperty(p, "maxhp", sgs.QVariant(p:getMaxHp() + 1))
                        end
                    end
                end
			end
		end
		return false
	end,
	can_trigger = function(self, target)
		return target
	end
}



--[[
	技能名：余热
	相关武将：浮云[官盗]
	技能描述：限定技，当你弃置牌后，你可以将此次弃置的牌交给任意名其他角色。
	引用：sfofl_yure
]] --

sfofl_yure = sgs.CreateTriggerSkill{
	name = "sfofl_yure",
    frequency = sgs.Skill_Limited,
	limit_mark = "@sfofl_yure",
	events = {sgs.CardsMoveOneTime},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
        if player:getMark("@sfofl_yure") == 0 then return false end
	    if event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            if move.from and move.from:objectName() == player:objectName() then
                local card_ids = sgs.IntList()
                for _,card_id in sgs.qlist(move.card_ids) do
                    local flag = bit32.band(move.reason.m_reason, sgs.CardMoveReason_S_MASK_BASIC_REASON)
                    if flag == sgs.CardMoveReason_S_REASON_DISCARD and room:getCardPlace(card_id) == sgs.Player_DiscardPile then
                        card_ids:append(card_id)
                    end
                end
                if not card_ids:isEmpty() then
                    if room:askForSkillInvoke(player, self:objectName(), data) then
                        room:doSuperLightbox(player,self:objectName())
                        room:removePlayerMark(player, "@sfofl_yure")
                        player:assignmentCards(card_ids,self:objectName(),room:getOtherPlayers(player),-1,card_ids:length(),true)
                    end
                end
            end
        end
	end,
}


sfofl_fuyun:addSkill(sfofl_suiqu)
sfofl_fuyun:addSkill(sfofl_yure)

sfofl_taosheng = sgs.General(extension_e, "sfofl_taosheng", "qun", 5)
--[[
	技能名：载内
	相关武将：陶升[官盗]
	技能描述：限定技，出牌阶段，你可以选择一名其他角色，令你与其的距离视为1，直到你进入濒死状态。
	引用：sfofl_zainei
]] --

sfofl_zaineiCard = sgs.CreateSkillCard {
	name = "sfofl_zainei",
	target_fixed = false,
	will_throw = false,

	filter = function(self, targets, to_select, player)
		return #targets == 0
	end,

	on_effect = function(self, effect)
		local room = effect.from:getRoom()
        room:doSuperLightbox(effect.from,self:objectName())
        room:removePlayerMark(effect.from, "@sfofl_zainei")
		room:setFixedDistance(effect.from, effect.to, 1)
        room:addPlayerMark(effect.to, "&sfofl_zainei+to+#"..effect.from:objectName())
        room:addPlayerMark(effect.to, "sfofl_zainei+to+#"..effect.from:objectName())
		return false
	end,
}

sfofl_zaineiVS = sgs.CreateViewAsSkill {
	name = "sfofl_zainei",
	n = 0,
	view_as = function(self,cards)
		if #cards == 0 then 
            return sfofl_zaineiCard:clone()
        end
	end,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_zainei") and player:getMark("@sfofl_zainei") > 0
	end,
}
sfofl_zainei = sgs.CreateTriggerSkill{
    name = "sfofl_zainei",
    events = { sgs.EnterDying },
    frequency = sgs.Skill_Limited,
    view_as_skill = sfofl_zaineiVS,
    limit_mark = "@sfofl_zainei",
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local dying = data:toDying()
        local target = room:getCurrentDyingPlayer()
        if target and player and player:hasSkill(self:objectName()) and target:objectName() == player:objectName() then
            for _, p in sgs.qlist(room:getOtherPlayers(player)) do
                if p:getMark("sfofl_zainei+to+#"..player:objectName()) > 0 then
                    room:removeFixedDistance(player, p, 1)
                    room:setPlayerMark(p, "&sfofl_zainei+to+#"..player:objectName(), 0)
                    room:setPlayerMark(p, "sfofl_zainei+to+#"..player:objectName(), 0)
                end
            end
        end
        return false
    end
}

--[[
	技能名：捍卫
	相关武将：陶升[官盗]
	技能描述：出牌阶段限一次，你可以展示并交给一名与你距离为1的其他角色任意张非伤害牌并摸等量张牌，然后其可以使用你交给其的任意张牌。"
	引用：sfofl_hanwei
]] --
sfofl_hanweiCard = sgs.CreateSkillCard {
	name = "sfofl_hanwei",
	target_fixed = false,
	will_throw = false,

	filter = function(self, targets, to_select, player)
		return #targets == 0 and player:distanceTo(to_select) <= 1
	end,

	on_effect = function(self, effect)
		local room = effect.from:getRoom()
		room:giveCard(effect.from, effect.to, self, self:objectName(), true)
		effect.from:drawCards(self:subcardsLength())
        local pattern = {}
        for _, id in sgs.qlist(self:getSubcards()) do
            local card = sgs.Sanguosha:getCard(id)
            for _, p in sgs.qlist(room:getOtherPlayers(effect.to)) do
                if not sgs.Sanguosha:isProhibited(effect.to, p, card) and card:isAvailable(effect.to) then
                    table.insert(pattern, card:getEffectiveId())
                    break
                end
            end
        end
        if #pattern > 0 then
            while true do
                local card = room:askForUseCard(effect.to, table.concat(pattern, ","), "@sfofl_hanwei", -1) 
                if card then
                    table.removeOne(pattern, card:getEffectiveId())
                else
                    break
                end
            end
        end
        
		return false
	end,
}

sfofl_hanwei = sgs.CreateViewAsSkill {
	name = "sfofl_hanwei",
	n = 999,
	view_filter = function(self,selected,to_select)
		if to_select:isDamageCard() then return false  end
		return true
	end,
	view_as = function(self,cards)
		if #cards == 0 then return nil end
        local dis_card = sfofl_hanweiCard:clone()
        for _,card in pairs(cards) do
            dis_card:addSubcard(card)
        end
        dis_card:setSkillName("sfofl_longxin")
        return dis_card
	end,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_hanwei")
	end,
}
sfofl_taosheng:addSkill(sfofl_zainei)
sfofl_taosheng:addSkill(sfofl_hanwei)

sfofl_gaosheng = sgs.General(extension_e, "sfofl_gaosheng", "qun", 5)
--[[
	技能名：凶势
	相关武将：高升[官盗]
	技能描述：每名角色的出牌阶段限一次，其可以将一张手牌置于你的武将牌上。
	引用：sfofl_xiongshi
]] --
sfofl_xiongshiCard = sgs.CreateSkillCard {
	name = "sfofl_xiongshi",
	target_fixed = false,
	will_throw = false,
	filter = function(self, targets, to_select)
		if #targets == 0 then
			if to_select:hasSkill("sfofl_xiongshi") then
				return not to_select:hasFlag("sfofl_xiongshiInvoked")
			end
		end
		return false
	end,
	on_use = function(self, room, source, targets)
		local zhangjiao = targets[1]
		if zhangjiao:hasSkill("sfofl_xiongshi") then
			room:setPlayerFlag(zhangjiao, "sfofl_xiongshiInvoked")
			room:broadcastSkillInvoke("sfofl_xiongshi")
			zhangjiao:addToPile("sfofl_xiongshi", self)
			local zhangjiaos = sgs.SPlayerList()
			local players = room:getOtherPlayers(source)
			for _, p in sgs.qlist(players) do
				if p:hasSkill("sfofl_xiongshi") then
					if not p:hasFlag("sfofl_xiongshiInvoked") then
						zhangjiaos:append(p)
					end
				end
			end
			if zhangjiaos:length() == 0 then
				room:setPlayerFlag(source, "Forbidsfofl_xiongshi")
			end
		end
	end
}
sfofl_xiongshiAttach = sgs.CreateViewAsSkill {
	name = "sfofl_xiongshiAttach&",
	n = 1,
	view_filter = function(self, selected, to_select)
		return not to_select:isEquipped()
	end,
	view_as = function(self, cards)
		if #cards == 1 then
			local card = sfofl_xiongshiCard:clone()
			card:addSubcard(cards[1])
			return card
		end
	end,
	enabled_at_play = function(self, player)
		return not player:hasFlag("Forbidsfofl_xiongshi")
	end
}
sfofl_xiongshi = sgs.CreateTriggerSkill {
	name = "sfofl_xiongshi",
	frequency = sgs.Skill_NotFrequent,
	events = { sgs.GameStart, sgs.EventAcquireSkill,sgs.EventPhaseChanging },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.GameStart or event == sgs.EventAcquireSkill and data:toString() == "sfofl_xiongshi") and player:hasSkill(self:objectName()) then
			for _, p in sgs.qlist(room:getAllPlayers()) do
				if not p:hasSkill("sfofl_xiongshiAttach") then
					room:attachSkillToPlayer(p, "sfofl_xiongshiAttach")
				end
			end
		elseif event == sgs.EventPhaseChanging then
			local phase_change = data:toPhaseChange()
			if phase_change.from == sgs.Player_Play then
				if player:hasFlag("Forbidsfofl_xiongshi") then
					room:setPlayerFlag(player, "-Forbidsfofl_xiongshi")
				end
				for _, p in sgs.qlist(room:getAllPlayers()) do
					if p:hasFlag("sfofl_xiongshiInvoked") then
						room:setPlayerFlag(p, "-sfofl_xiongshiInvoked")
					end
				end
			end
		end
		return false
	end,
	can_trigger = function(self, target)
		return target
	end
}


--[[
	技能名：地锋
	相关武将：高升[官盗]
	技能描述：锁定技，当一名角色将牌置于武将牌上后，你与其各摸一张牌。当你造成或受到伤害时，伤害来源可以移去你武将牌上的一张牌，令此伤害+1。
	引用：sfofl_defeng
]] --

sfofl_defeng = sgs.CreateTriggerSkill{
	name = "sfofl_defeng",
    frequency = sgs.Skill_Compulsory, 
	events = {sgs.CardsMoveOneTime, sgs.DamageCaused, sgs.DamageInflicted},
	on_trigger = function(self, event, player, data, room)
        if event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            local players = sgs.SPlayerList()
            --if move.from and move.to_place and move.to_place == sgs.Player_PlaceSpecial then
            if move.to_place and move.to_place == sgs.Player_PlaceSpecial and move.from then
                if string.startsWith(move.to_pile_name, "#") then return false end
                local from = room:findPlayerByObjectName(move.from:objectName())
                if from and from:isAlive() then
                    for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                        from:drawCards(1, self:objectName())
                        p:drawCards(1, self:objectName())     
                    end
                end
            end
        else
            local damage = data:toDamage()
            local target = damage.from
            local ids = sgs.IntList()
            for _,key in sgs.list(player:getPileNames())do
                for _,id in sgs.list(player:getPile(key))do
                    ids:append(id)
                end
            end
            if not target or not target:isAlive() then return false end
            if ids:isEmpty() then return false end
            room:setTag("sfofl_defeng", data)
            room:fillAG(ids,target)
			local id = room:askForAG(target,ids,true,self:objectName(), "@sfofl_defeng:"..player:objectName())
			room:clearAG(target)
            if id == -1 then return false end
            local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_REMOVE_FROM_PILE, "","sfofl_defeng", "")
            local card = sgs.Sanguosha:getCard(id)
            room:throwCard(card, reason, nil)
            player:damageRevises(data,1)
            room:removeTag("sfofl_defeng")
        end
		return false
	end
}

sfofl_gaosheng:addSkill(sfofl_xiongshi)
if not sgs.Sanguosha:getSkill("sfofl_xiongshiAttach") then skills:append(sfofl_xiongshiAttach) end
sfofl_gaosheng:addSkill(sfofl_defeng)


sfofl_bairao = sgs.General(extension_e, "sfofl_bairao", "qun", 5)
--[[
	技能名：祸引
	相关武将：白绕[官盗]
	技能描述：锁定技，若你在一名角色的攻击范围内，且其也在你的攻击范围内，你对其使用【杀】无次数限制；当你对这些角色造成伤害后，你摸一张牌，然后其选择是否使用这些牌。
	引用：sfofl_huoyin
]] --
sfofl_huoyin_buff = sgs.CreateTargetModSkill {
    name = "#sfofl_huoyin_buff",
    pattern = "Slash",
    residue_func = function(self, from, card, to)
        if from and to and from:inMyAttackRange(to) and to:inMyAttackRange(from) and from:hasSkill("sfofl_huoyin") then
			return 999
		else
			return 0
		end
    end,
}
sfofl_huoyin = sgs.CreateTriggerSkill {
	name = "sfofl_huoyin",
	frequency = sgs.Skill_Compulsory,
	events = { sgs.Damage },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()
        if damage.from and damage.from:inMyAttackRange(damage.to) and damage.to:inMyAttackRange(damage.from) and player:objectName() == damage.from:objectName() then
            room:sendCompulsoryTriggerLog(player, self:objectName())
            local card = sgs.Sanguosha:getCard(room:drawCard())
            local cardid = card:getEffectiveId()
            player:obtainCard(card)
            room:showCard(player, cardid)
            local card_ids = sgs.IntList()
            card_ids:append(cardid)
            room:notifyMoveToPile(damage.to, card_ids, self:objectName(), sgs.Player_PlaceHand, true)
            local card = room:askForUseCard(damage.to, cardid, "@sfofl_huoyin:"..card:getFullName(true), -1) 
            room:notifyMoveToPile(damage.to, card_ids, self:objectName(), sgs.Player_PlaceHand, false)
            
        end
            
	end,
}
sfofl_bairao:addSkill(sfofl_huoyin)
sfofl_bairao:addSkill(sfofl_huoyin_buff)
extension_e:insertRelatedSkills("sfofl_huoyin", "#sfofl_huoyin_buff")


sfofl_yanzheng = sgs.General(extension_e, "sfofl_yanzheng", "qun", 4)
--[[
	技能名：地逝
	相关武将：严政[官盗]
	技能描述：限定技，出牌阶段开始时，若你已受伤，你可以将所有手牌当一张无视距离且伤害为X的【杀】使用（X为你的手牌数）。
	引用：sfofl_deshi
]] --

sfofl_deshiCard = sgs.CreateSkillCard {
	name = "sfofl_deshi",
	target_fixed = false,
    will_throw = false,
	filter = function(self, targets, to_select)
		local targets_list = sgs.PlayerList()
		for _, target in ipairs(targets) do
			targets_list:append(target)
		end
		local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
		slash:setSkillName("sfofl_deshi")
		slash:deleteLater()
        slash:addSubcards(self:getSubcards())
		return slash:targetFilter(targets_list, to_select, sgs.Self)
	end ,
	on_use = function(self, room, source, targets)
		local targets_list = sgs.SPlayerList()
		for _, target in ipairs(targets) do
			if source:canSlash(target, nil, false) then
				targets_list:append(target)
			end
		end
		if targets_list:length() > 0 then
            room:doSuperLightbox(source,self:getSkillName())
			local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
			slash:deleteLater()
			slash:setSkillName("sfofl_deshi")
            slash:addSubcards(self:getSubcards())
			room:useCard(sgs.CardUseStruct(slash, source, targets_list))
		end
	end
}
sfofl_deshiVS = sgs.CreateViewAsSkill {
	name = "sfofl_deshi",
	n = 0,
	view_filter = function(self, selected, to_select)
		return false
	end,
	view_as = function(self, cards)
		if #cards == 0 then
			local card = sfofl_deshiCard:clone()
			card:addSubcards(sgs.Self:getHandcards())
			return card
		end
	end,
	enabled_at_play = function(self, player)
		return false
	end,
	enabled_at_response = function(self, player, pattern)
		return pattern == "@@sfofl_deshi"
	end,
}
sfofl_deshi = sgs.CreateTriggerSkill{
	name = "sfofl_deshi",
	frequency = sgs.Skill_Limited,
	events = {sgs.EventPhaseStart, sgs.DamageCaused},
    view_as_skill = sfofl_deshiVS,
    limit_mark = "@sfofl_deshi",
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
        if event == sgs.EventPhaseStart then
            if player:getPhase()  == sgs.Player_Play and player:getMark("@sfofl_deshi") > 0 and player:isWounded() then
                if room:askForUseCard(player, "@@sfofl_deshi", "@sfofl_deshi:"..player:getHandcardNum(), 1) then
                    room:removePlayerMark(player, "@sfofl_deshi")
                end
            end
        else
            local damage = data:toDamage()
            if damage.card and table.contains(damage.card:getSkillNames(), "sfofl_deshi") then
                room:sendCompulsoryTriggerLog(player, self:objectName())
                damage.damage = damage.card:subcardsLength()
                data:setValue(damage)
            end
        end
		return false
	end,
}
sfofl_deshi_buff = sgs.CreateTargetModSkill{
	name = "#sfofl_deshi_buff" ,
	pattern = "Slash" ,
	distance_limit_func = function(self, player, card)
		if player:hasSkill("sfofl_deshi") and (table.contains(card:getSkillNames(), "sfofl_deshi")) then
			return 1000
		else
			return 0
		end
	end
}



--[[
	技能名：献降
	相关武将：严政[官盗]
	技能描述：锁定技，当你杀死一名角色时，你令另一名其他角色获得死亡角色区域内的所有牌。
	引用：sfofl_xianjiang
]] --
sfofl_xianjiang=sgs.CreateTriggerSkill{
	name="sfofl_xianjiang",
	events=sgs.Death,
	frequency = sgs.Skill_Compulsory,
	on_trigger=function(self,event,player,data)	
	local room=player:getRoom()
	local death = data:toDeath()
	local damage=death.damage
	if(damage and damage.from and damage.from:objectName() == player:objectName()) then 
		if not death.who:isAllNude() then
            local targets = room:getAlivePlayers()
            targets:removeOne(player)
            local target = room:askForPlayerChosen(player, targets, self:objectName())
			local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
			local cards = death.who:getCards("hej")
			for _,card in sgs.qlist(cards) do
				dummy:addSubcard(card)
			end
			if cards:length() > 0 then
				local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_RECYCLE, player:objectName())
				room:obtainCard(target, dummy, reason, false)
			end
			dummy:deleteLater()
        end
	end
    return false
end,
}
sfofl_yanzheng:addSkill(sfofl_deshi)
sfofl_yanzheng:addSkill(sfofl_deshi_buff)
extension_e:insertRelatedSkills("sfofl_deshi", "#sfofl_deshi_buff")
sfofl_yanzheng:addSkill(sfofl_xianjiang)


sfofl_bosi = sgs.General(extension_e, "sfofl_bosi", "qun", 6, true, false, false, 4)
--[[
	技能名：为乱
	相关武将：卜巳[官盗]
	技能描述：锁定技，准备阶段/摸牌阶段/出牌阶段开始时，你判定，若结果为黑桃，你的攻击范围/摸牌阶段摸牌数/使用【杀】的上限+1。
	引用：sfofl_weiluan
]] --
sfofl_weiluan = sgs.CreateTriggerSkill {
	name = "sfofl_weiluan",
	frequency = sgs.Skill_Compulsory,
	events = { sgs.EventPhaseStart, sgs.DrawNCards },
	on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.EventPhaseStart then
            local judge = sgs.JudgeStruct()
            judge.pattern = ".|spade"
            judge.good = true
            judge.reason = self:objectName()
            judge.who = player
            if player:getPhase() == sgs.Player_Start then
                room:judge(judge)
                if judge:isGood() then
                    room:addPlayerMark(player, "sfofl_weiluan-Clear")
                end
            elseif player:getPhase() == sgs.Player_Draw then
                room:judge(judge)
                if judge:isGood() then
                    room:addPlayerMark(player, "sfofl_weiluan_draw-Clear")
                end
            elseif player:getPhase() == sgs.Player_Play then
                room:judge(judge)
                if judge:isGood() then
                    room:addSlashCishu(player, 1, true)
                end
            end
        else
            local draw = data:toDraw()
            if draw.reason ~= "draw_phase" then return false end
            if player:getMark("sfofl_weiluan_draw-Clear") > 0 then
                draw.num = draw.num + 1
                data:setValue(draw)
            end
        end
	end
}
sfofl_weiluan_buff  = sgs.CreateAttackRangeSkill {
	name = "#sfofl_weiluan_buff",
	extra_func = function(self, player)
		if player:hasSkill("sfofl_weiluan") and player:getMark("sfofl_weiluan-Clear") ~= 0 then return 1 end
	end,
}



--[[
	技能名：天判
	相关武将：卜巳[官盗]
	技能描述：锁定技，当你的判定牌生效时，若为：黑桃，你获得之，然后回复1点体力或加1点体力上限；非黑桃，你失去1点体力或减1点体力上限。
	引用：sfofl_tianpan
]] --
sfofl_tianpan = sgs.CreateTriggerSkill{
	name = "sfofl_tianpan",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.FinishJudge},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local judge = data:toJudge()
		local card = judge.card
		if card:getSuit() == sgs.Card_Spade  then
			player:obtainCard(card)
            local choicelist = "gainmaxhp"
            if player:isWounded() then
                choicelist = string.format("%s+%s", choicelist, "gainhp")
            end
            local choice = room:askForChoice(player, self:objectName(), choicelist, data)
            if choice == "gainhp" then
                local recover = sgs.RecoverStruct()
                recover.who = player
                room:recover(player, recover)
            else
                room:setPlayerProperty(player, "maxhp", sgs.QVariant(player:getMaxHp() + 1))
            end
        else
            local result = room:askForChoice(player, self:objectName(), "hp+maxhp", data)
            if result == "hp" then
                room:loseHp(player, 1, true, player, self:objectName())
            else
                room:loseMaxHp(player)
            end
		end
	end
}

--[[
	技能名：改命
	相关武将：卜巳[官盗]
	技能描述：每名角色的回合限一次，当你的判定牌生效前，若结果不为黑桃，你可以亮出牌堆顶一张牌代替之。
	引用：sfofl_gaiming
]] --
sfofl_gaiming = sgs.CreateTriggerSkill{
	name = "sfofl_gaiming" ,
	events = {sgs.AskForRetrial} ,
	on_trigger = function(self, event, player, data)
		local judge = data:toJudge()
		if judge.who:objectName() ~= player:objectName() then return false end
		if judge.card:getSuit() == sgs.Card_Spade then return false end
		if player:getMark("sfofl_gaiming-Clear") == 0 and player:askForSkillInvoke(self:objectName(), data) then
			local room = player:getRoom()
            room:addPlayerMark(player, "sfofl_gaiming-Clear")
			local card_id = room:drawCard()
			room:getThread():delay()
			local card = sgs.Sanguosha:getCard(card_id)
			room:retrial(card, player, judge, self:objectName())
		end
		return false
	end
}


sfofl_bosi:addSkill(sfofl_weiluan)
sfofl_bosi:addSkill(sfofl_weiluan_buff)
extension_e:insertRelatedSkills("sfofl_weiluan", "#sfofl_weiluan_buff")
sfofl_bosi:addSkill(sfofl_tianpan)
sfofl_bosi:addSkill(sfofl_gaiming)


sfofl_suigu = sgs.General(extension_e, "sfofl_suigu", "qun", 5)
--[[
	技能名：屯犬
	相关武将：眭固[官盗]
	技能描述：锁定技，准备阶段，你令你本回合的摸牌阶段摸牌数、手牌上限、本回合首次造成的伤害+1，直到你发动“迁军”。
	引用：sfofl_tunquan
]] --

sfofl_tunquan = sgs.CreateTriggerSkill {
	name = "sfofl_tunquan",
	frequency = sgs.Skill_Compulsory,
	events = { sgs.EventPhaseStart, sgs.DrawNCards, sgs.DamageCaused },
	on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.EventPhaseStart then
            if player:getPhase() == sgs.Player_Start and player:getMark("sfofl_qianjun") == 0 then
                room:sendCompulsoryTriggerLog(player, self:objectName())
                room:addPlayerMark(player, "sfofl_tunquan-Clear")
                room:addPlayerMark(player, "&sfofl_tunquan-Clear")
                room:addMaxCards(player, 1, true)
            end
        elseif event == sgs.DrawNCards then
            local draw = data:toDraw()
            if draw.reason ~= "draw_phase" then return false end
            if player:getMark("sfofl_tunquan-Clear") > 0 then
                draw.num = draw.num + 1
                data:setValue(draw)
            end
        elseif event == sgs.DamageCaused then
            local damage = data:toDamage()
            if player:getMark("sfofl_tunquan-Clear") > 0 and player:getMark("sfofl_tunquan_damage-Clear") == 0 then
                room:addPlayerMark(player, "sfofl_tunquan_damage-Clear")
                damage.damage = damage.damage + 1
                local log = sgs.LogMessage()
                log.type = "#skill_add_damage"
                log.from = damage.from
                log.to:append(damage.to)
                log.arg  = self:objectName()
                log.arg2 = damage.damage
                room:sendLog(log)
                data:setValue(damage)
            end
        end
	end
}



--[[
	技能名：迁军
	相关武将：眭固[官盗]
	技能描述：限定技，出牌阶段，你可以将装备区内所有牌交给一名其他角色，并与其交换座次，然后你回复1点体力并获得“乱击”。
	引用：sfofl_qianjun
]] --

sfofl_qianjunCard = sgs.CreateSkillCard {
	name = "sfofl_qianjun",
	target_fixed = false,
    will_throw = false,
	filter = function(self, targets, to_select)
		if #targets == 0 then
			return to_select:objectName() ~= sgs.Self:objectName()
		end
        return false
	end ,
	on_use = function(self, room, source, targets)
        room:removePlayerMark(source, "@sfofl_qianjun")
        room:doSuperLightbox(source,self:getSkillName())
        room:addPlayerMark(source, "sfofl_qianjun")
        local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
		dummy:deleteLater()
		local equips = source:getEquips()
        for _, equip in sgs.qlist(equips) do
            dummy:addSubcard(equip)
        end
        room:giveCard(source, targets[1], dummy, self:objectName())
        room:swapSeat(source, targets[1])
        local recover = sgs.RecoverStruct()
        recover.who = source
        recover.recover = 1
        room:recover(source, recover, true)
        room:handleAcquireDetachSkills(source, "luanji")
	end
}
sfofl_qianjunVS = sgs.CreateViewAsSkill {
	name = "sfofl_qianjun",
	n = 0,
	view_filter = function(self, selected, to_select)
		return false
	end,
	view_as = function(self, cards)
		if #cards == 0 then
			return sfofl_qianjunCard:clone()
		end
	end,
	enabled_at_play = function(self, player)
		return player:getMark("@sfofl_qianjun") > 0 and player:getEquips():length() > 0
	end,
}

sfofl_qianjun = sgs.CreateTriggerSkill{
	name = "sfofl_qianjun",
	frequency = sgs.Skill_Limited,
	events = {},
    view_as_skill = sfofl_qianjunVS,
    waked_skills = "luanji",
    limit_mark = "@sfofl_qianjun",
	on_trigger = function(self, event, player, data)
    end
}

sfofl_suigu:addSkill(sfofl_tunquan)
sfofl_suigu:addSkill(sfofl_qianjun)



sfofl_heman = sgs.General(extension_e, "sfofl_heman", "qun", 6,true,false, false, 5)
--[[
	技能名：决巅
	相关武将：何曼[官盗]
	技能描述：锁定技，当你每回合首次使用目标唯一的牌造成伤害后，你选择一项并视为对受伤角色使用一张【决斗】：1.失去1点体力；2.减1点体力上限；3.背水：此【决斗】造成的伤害+1。
	引用：sfofl_juedian
]] --

sfofl_juedian_buff = sgs.CreateTriggerSkill{
    name = "#sfofl_juedian_buff", 
    events = {sgs.DamageCaused}, 
    frequency = sgs.Skill_Compulsory, 
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.DamageCaused then
            local damage = data:toDamage()
            if damage.card and damage.card:hasFlag("sfofl_juedian") and player:objectName() == damage.from:objectName() then
                damage.damage = damage.damage + 1
                local log = sgs.LogMessage()
                log.type = "#skill_add_damage"
                log.from = damage.from
                log.to:append(damage.to)
                log.arg  = "sfofl_juedian"
                log.arg2 = damage.damage
                room:sendLog(log)
                data:setValue(damage)
            end
        end
        return false
    end,
	can_trigger = function(self, target)
		return target
	end
}
sfofl_juedian = sgs.CreateTriggerSkill{
    name = "sfofl_juedian", 
    events = {sgs.Damage}, 
    frequency = sgs.Skill_Compulsory, 
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.Damage then
            local damage = data:toDamage()
            if player:getMark("sfofl_juedian-Clear") > 0 then return end
            if damage.card and not damage.card:isKindOf("SkillCard") and damage.to and damage.to:isAlive() then
                local use = room:getTag("UseHistory"..damage.card:toString()):toCardUse()
                if use and use.card and use.to:length() == 1 then
                    local result = room:askForChoice(player, self:objectName(), "hp+maxhp+beishui", data)
                    if result == "hp" or result == "beishui" then
                        room:loseHp(player, 1, true, player, self:objectName())
                    end
                    if result == "maxhp" or result == "beishui" then
                        room:loseMaxHp(player)
                    end
                    
                    room:addPlayerMark(player, "sfofl_juedian-Clear")
                    local duel = sgs.Sanguosha:cloneCard("duel", sgs.Card_NoSuit, 0)
                    duel:deleteLater()
                    duel:setSkillName("sfofl_juedian")
                    if result == "beishui" then
                        room:setCardFlag(duel, "sfofl_juedian")
                    end
                    local use = sgs.CardUseStruct()
                    use.from = player
                    use.card = duel
                    use.to:append(damage.to)
                    room:useCard(use, false)
                end
            end
        end
        return false
    end,
}

--[[
	技能名：逆天
	相关武将：何曼[官盗]
	技能描述：限定技，出牌阶段，你可以令你本回合使用牌不能被抵消。若如此做，结束阶段，若你本回合未杀死角色，你死亡。
	引用：sfofl_nitian
]] --

sfofl_nitianCard = sgs.CreateSkillCard{
	name = "sfofl_nitian",
    target_fixed = true,
	on_use = function(self, room, source, targets)
        room:removePlayerMark(source, "@sfofl_nitian")
        room:doSuperLightbox(source,self:getSkillName())
		room:addPlayerMark(source, "sfofl_nitian-Clear")
		room:addPlayerMark(source, "&sfofl_nitian-Clear")
	end
}
sfofl_nitianVS = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_nitian",
	view_as = function(self) 
		return sfofl_nitianCard:clone()
	end, 
	enabled_at_play = function(self, player)
		return player:getMark("@sfofl_nitian") > 0
    end
}
sfofl_nitian = sgs.CreateTriggerSkill{
	name = "sfofl_nitian",
    limit_mark = "@sfofl_nitian",
    frequency = sgs.Skill_Limited,
	view_as_skill = sfofl_nitianVS,
	events = {sgs.CardUsed, sgs.Death, sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.CardUsed then
			local use = data:toCardUse()
			if use.card and not use.card:isKindOf("SkillCard") and player:getMark("sfofl_nitian-Clear") > 0 then
                room:sendCompulsoryTriggerLog(player, self:objectName())
                local no_respond_list = use.no_respond_list
                table.insert(no_respond_list, "_ALL_TARGETS")
                use.no_respond_list = no_respond_list
                data:setValue(use)
			end
		elseif event == sgs.Death then
            if player:getMark("sfofl_nitian-Clear") > 0 then
                local death = data:toDeath()
                local damage=death.damage
                local from=damage.from
                if(damage and damage.from and damage.from:objectName() == player:objectName()) then
                    room:addPlayerMark(player, "sfofl_nitiankill-Clear")
                end
            end
            
		elseif event == sgs.EventPhaseStart then
            if player:getMark("sfofl_nitian-Clear") > 0 and player:getPhase() == sgs.Player_Finish then
                if player:getMark("sfofl_nitiankill-Clear") == 0 then
                    room:killPlayer(player)
                end
            end
		end
		return false
	end	
}
sfofl_heman:addSkill(sfofl_juedian)
sfofl_heman:addSkill(sfofl_juedian_buff)
extension_e:insertRelatedSkills("sfofl_juedian", "#sfofl_juedian_buff")
sfofl_heman:addSkill(sfofl_nitian)


sfofl_yudu = sgs.General(extension_e, "sfofl_yudu", "qun", 4)
--[[
	技能名：打富
	相关武将：于毒[官盗]
	技能描述：当你使用伤害牌指定目标后，你可以令目标角色摸一张牌，然后其不可相应此牌。
	引用：sfofl_dafu
]] --

sfofl_dafu = sgs.CreateTriggerSkill{
	name = "sfofl_dafu",
	events = {sgs.TargetSpecified},
	frequency = sgs.Skill_NotFrequent, 
	on_trigger = function(self, event, player, data)
		local use = data:toCardUse()
		local room = player:getRoom()
		if (event == sgs.TargetSpecified) then
			if not use.card:isKindOf("SkillCard") and use.card:isDamageCard() then
                for _, p in sgs.qlist(use.to) do
                    if player:askForSkillInvoke(self:objectName(), ToData(p)) then
                        p:drawCards(1, self:objectName())
                        local no_respond_list = use.no_respond_list
                        table.insert(no_respond_list, p:objectName())
                        use.no_respond_list = no_respond_list
                        data:setValue(use)
                    end
                end
			end
		end
	end
}

--[[
	技能名：济贫
	相关武将：于毒[官盗]
	技能描述：当你对手牌数大于你的角色造成伤害后，你可以获得其一张手牌，然后你可以将之交给一名其他角色。
	引用：sfofl_jipin
]] --
sfofl_jipin = sgs.CreateTriggerSkill{
    name = "sfofl_jipin", 
    events = {sgs.Damage}, 
    frequency = sgs.Skill_NotFrequent, 
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.Damage then
            local damage = data:toDamage()
            if damage.to and damage.to:isAlive() and damage.to:getHandcardNum() > player:getHandcardNum() and not damage.to:isKongcheng() then
                if room:askForSkillInvoke(player, self:objectName(), data) then
                    if not damage.to:isKongcheng() then
                        local card_id = room:askForCardChosen(player, damage.to, "h", self:objectName())
                        room:obtainCard(player, card_id)
                        room:setPlayerMark(player, "sfofl_jipin", card_id)
                        local target = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName(),
						"sfofl_jipin-invoke", true, true)
                        room:setPlayerMark(player, "sfofl_jipin", 0)
                        if not target then return false end
                        room:giveCard(player, target, sgs.Sanguosha:getCard(card_id), self:objectName(), false)
                    end
                end
            end
        end
        return false
    end,
}

sfofl_yudu:addSkill(sfofl_dafu)
sfofl_yudu:addSkill(sfofl_jipin)



sfofl_tangzhou = sgs.General(extension_e, "sfofl_tangzhou", "qun", 4)
--[[
	技能名：举寇
	相关武将：唐周[官盗]
	技能描述：出牌阶段限一次，你可以选择一项：1.令一名其他角色摸一张牌，然后其本回合不能使用【杀】；2.令一名其他角色获得武将牌上的所有牌，然后其本回合不能使用手牌。
	引用：sfofl_jukou
]] --

sfofl_jukouCard = sgs.CreateSkillCard {
	name = "sfofl_jukou",
	target_fixed = false,
    will_throw = false,
	filter = function(self, targets, to_select)
		if #targets == 0 then
			return to_select:objectName() ~= sgs.Self:objectName()
		end
        return false
	end ,
	on_use = function(self, room, source, targets)
        local target = targets[1]
        local choicelist = "draw="..target:objectName()
        local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
        dummy:deleteLater()
        for _,key in sgs.list(target:getPileNames())do
            for _,id in sgs.list(target:getPile(key))do
                dummy:addSubcard(id)
            end
        end
        if dummy:subcardsLength() > 0 then
            choicelist = string.format("%s+%s", choicelist, "obtain="..target:objectName())
        end
        local choice =room:askForChoice(source, "sfofl_jukou",choicelist,ToData(target))
        room:addPlayerMark(target, "&sfofl_jukou+to+#"..source:objectName().."-Clear")
        if string.startsWith(choice,"draw") then
            target:drawCards(1, self:objectName())
            room:setPlayerCardLimitation(target, "use", "Slash", true);
        else
            room:obtainCard(target, dummy)
            room:setPlayerCardLimitation(target, "use", ".|.|.|hand", true);
        end
	end
}
sfofl_jukou = sgs.CreateViewAsSkill {
	name = "sfofl_jukou",
	n = 0,
	view_filter = function(self, selected, to_select)
		return false
	end,
	view_as = function(self, cards)
		if #cards == 0 then
			return sfofl_jukouCard:clone()
		end
	end,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_jukou")
	end,
}


--[[
	技能名：述叛
	相关武将：唐周[官盗]
	技能描述：限定技，出牌阶段，你可以依次选择两名其他角色，然后你展示前者的手牌，并与后者各摸三张牌。若如此做，前者对后者依次使用手牌中的所有伤害牌，且本回合这两名角色互相使用牌无次数限制。
	引用：sfofl_shupan
]] --
sfofl_shupanCard = sgs.CreateSkillCard {
	name = "sfofl_shupan",
	target_fixed = false,
	will_throw = true,
	filter = function(self, targets, to_select, player)
		return to_select:objectName() ~= sgs.Self:objectName() and #targets <= 2
	end,
	feasible = function(self, targets, player)
		return #targets == 2
	end,
	on_use = function(self, room, source, targets)
        room:removePlayerMark(source, "@sfofl_shupan")
        room:doSuperLightbox(source,self:getSkillName())
		local from = targets[1]
		local to = targets[2]
        room:showAllCards(from)
        source:drawCards(3, self:objectName())
        to:drawCards(3, self:objectName())
        for _, c in sgs.qlist(from:getHandcards()) do
            if not c:isAvailable(from) then continue end
            if c:isDamageCard() and not from:isProhibited(to, c)  then
                local use = sgs.CardUseStruct()
                use.card = c
                use.from = from
                use.to:append(to)
                room:useCard(use, false)
            end
        end
	end,
}
sfofl_shupanVS = sgs.CreateViewAsSkill {
	name = "sfofl_shupan",
	n = 0,
	view_filter = function(self, selected, to_select)
		return true
	end,
	view_as = function(self, cards)
		return sfofl_shupanCard:clone()
	end,
	enabled_at_play = function(self, player)
		return player:getMark("@sfofl_shupan") > 0
	end,
}
sfofl_shupan = sgs.CreateTriggerSkill{
	name = "sfofl_shupan",
	frequency = sgs.Skill_Limited,
	events = {},
    view_as_skill = sfofl_shupanVS,
    limit_mark = "@sfofl_shupan",
	on_trigger = function(self, event, player, data)
    end
}
sfofl_tangzhou:addSkill(sfofl_jukou)
sfofl_tangzhou:addSkill(sfofl_shupan)


sfofl_bocai = sgs.General(extension_e, "sfofl_bocai", "qun", 5)
--[[
	技能名：困军
	相关武将：波才[官盗]
	技能描述：锁定技，你的初始手牌数+4；手牌数小于你的角色不能响应你使用的牌；你不能响应手牌数大于你的角色使用的牌。
	引用：sfofl_kunjun
]] --
sfofl_kunjun = sgs.CreateTriggerSkill {
    name = "sfofl_kunjun",
    frequency = sgs.Skill_Compulsory,
    events = { sgs.DrawNCards, sgs.CardUsed },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.DrawNCards then
            local draw = data:toDraw()
            if draw.reason ~= "InitialHandCards" then return false end
            if player:hasSkill(self:objectName()) then
                room:sendCompulsoryTriggerLog(player, self:objectName(), true)
                draw.num = draw.num + 4
                data:setValue(draw)
            end
        elseif event == sgs.CardUsed then
            local use = data:toCardUse()
			if use.card and not use.card:isKindOf("SkillCard") then
                for _, p in sgs.qlist(use.to) do
                    if p:getHandcardNum() < player:getHandcardNum() and (player:hasSkill(self:objectName()) or (p:hasSkill(self:objectName()))) then
                        if player:hasSkill(self:objectName()) then
                            room:sendCompulsoryTriggerLog(player, self:objectName())
                        else
                            room:sendCompulsoryTriggerLog(p, self:objectName())
                        end
                        local no_respond_list = use.no_respond_list
                        table.insert(no_respond_list, p:objectName())
                        use.no_respond_list = no_respond_list
                        data:setValue(use)
                    end
                end
                
			end
        end
    end,
    can_trigger = function(self, target)
		return target
	end
}


--[[
	技能名：营战
	相关武将：波才[官盗]
	技能描述：锁定技，你造成和受到的属性伤害+1。
	引用：sfofl_yingzhan
]] --
sfofl_yingzhan = sgs.CreateTriggerSkill{
	name = "sfofl_yingzhan",
	frequency = sgs.Skill_Frequent,
	events = {sgs.DamageCaused, sgs.DamageInflicted},
	on_trigger = function(self, event, player, data)
		local damage = data:toDamage()
		if damage.nature ~= sgs.DamageStruct_Normal then
            damage.damage = damage.damage + 1
            local log = sgs.LogMessage()
            log.type = "#skill_add_damage"
            log.from = damage.from
            log.to:append(damage.to)
            log.arg  = self:objectName()
            log.arg2 = damage.damage
            player:getRoom():sendLog(log)
            data:setValue(damage)
		end
		return false
	end,
}

--[[
	技能名：摧击
	相关武将：波才[官盗]
	技能描述：其他角色的出牌阶段开始时，若你的手牌数大于其，你可以将至少一张手牌当一张雷【杀】对其使用，若造成伤害，你摸等量的牌。
	引用：sfofl_cuiji
]] --
sfofl_cuijiVS = sgs.CreateViewAsSkill {
	name = "sfofl_cuiji",
    n = 999,
	view_filter = function(self, selected, to_select)
       	return not to_select:isEquipped()
	end,
	view_as = function(self,cards)
        if #cards > 0 then
            local ThunderSlash = sgs.Sanguosha:cloneCard("thunder_slash", sgs.Card_SuitToBeDecided, -1)
            for _,card in pairs(cards) do
                ThunderSlash:addSubcard(card)
            end
            ThunderSlash:setSkillName(self:objectName())
            return ThunderSlash
        end
	end,
	enabled_at_play = function(self, player)
		return false
	end,
	enabled_at_response = function(self, player, pattern)
		return (pattern == "@@sfofl_cuiji") 
	end
}
sfofl_cuiji = sgs.CreateTriggerSkill{
	name = "sfofl_cuiji",
	view_as_skill = sfofl_cuijiVS,
	events = {sgs.EventPhaseStart, sgs.CardFinished},
	on_trigger = function(self, event, player, data, room)
        if event == sgs.EventPhaseStart then
            if player:getPhase() == sgs.Player_Play then
                for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if p:getHandcardNum() > player:getHandcardNum() then
                        room:askForUseCard(p, "@@sfofl_cuiji", "@sfofl_cuiji:"..player:objectName(), -1, sgs.Card_MethodUse)
                    end
                end
            end
        elseif event == sgs.CardFinished then
            local use = data:toCardUse()
            if use.card and table.contains(use.card:getSkillNames(), "sfofl_cuiji")  then
                if use.card:hasFlag("DamageDone") and player:hasSkill(self:objectName()) then
                    player:drawCards(use.card:subcardsLength(), self:objectName())
                end
            end
        end
		return false
	end,
    can_trigger = function(self, target)
		return target
	end
}
sfofl_cuiji_prohibit = sgs.CreateProhibitSkill {
	name = "#sfofl_cuiji_prohibit",
	is_prohibited = function(self, from, to, card)
		if card:isKindOf("Slash") and table.contains(card:getSkillNames(), "sfofl_cuiji") then
			if not to:hasFlag("CurrentPlayer") then
				return true
			end
		end
		return false
	end
}

sfofl_bocai:addSkill(sfofl_kunjun)
sfofl_bocai:addSkill(sfofl_yingzhan)
sfofl_bocai:addSkill(sfofl_cuiji)
sfofl_bocai:addSkill(sfofl_cuiji_prohibit)
extension_e:insertRelatedSkills("sfofl_cuiji", "#sfofl_cuiji_prohibit")

sfofl_dengmao = sgs.General(extension_e, "sfofl_dengmao", "qun", 5)
--[[
	技能名：咆袭
	相关武将：邓茂[官盗]
	技能描述：锁定技，每名角色的回合限一次，当你连续成为牌指定的目标后，你本回合下次受到的伤害+1；当你连续使用牌指定目标后，你本回合造成的伤害+1。
	引用：sfofl_paoxi
]] --

sfofl_paoxi = sgs.CreateTriggerSkill{
	name = "sfofl_paoxi",
	events = {sgs.TargetSpecified},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.TargetSpecified then
			local use = data:toCardUse()
			local invoke = false
			if not use.card:isKindOf("SkillCard") then
                for _, p in sgs.qlist(use.to) do
                    if p:getMark(self:objectName()..player:objectName().."-Clear") > 0 then
                        invoke = true
                        if p:hasSkill(self:objectName()) and p:getMark(self:objectName().."+1_num+Used-Clear") == 0  then
                            room:addPlayerMark(p, "&"..self:objectName().."+1_num-Clear")
                            room:addPlayerMark(p, self:objectName().."+1_num-Clear")
                            room:addPlayerMark(p, self:objectName().."+1_num+Used-Clear")
                        end
                    end
                end
                if player:hasSkill(self:objectName()) and invoke and player:getMark(self:objectName().."+2_num+Used-Clear") == 0 then
                    room:addPlayerMark(player, "&"..self:objectName().."+2_num-Clear")
                    room:addPlayerMark(player, self:objectName().."+2_num-Clear")
                    room:addPlayerMark(player, self:objectName().."+2_num+Used-Clear")
                end
                if not invoke then
                    for _, p in sgs.qlist(room:getAlivePlayers()) do
                        if p:getMark(self:objectName()..player:objectName().."-Clear") > 0 and not use.to:contains(p) then
                            room:setPlayerMark(p, self:objectName()..player:objectName().."-Clear", 0)
                        end
                    end
                end
                for _, p in sgs.qlist(use.to) do
                    if use.to:contains(p) then
                        room:addPlayerMark(p, self:objectName()..player:objectName().."-Clear")
                    end
                end
            end
		end
		return false
	end,
	can_trigger = function(self, target)
		return target
	end
}
sfofl_paoxi_buff = sgs.CreateTriggerSkill{
	name = "#sfofl_paoxi_buff",
	events = {sgs.DamageCaused, sgs.DamageInflicted},
	frequency = sgs.Skill_Compulsory, 
	on_trigger = function(self, event, player, data, room)
        local invoke = false
        local damage = data:toDamage()
        if event == sgs.DamageCaused then
            if player:getMark("sfofl_paoxi+2_num-Clear") > 0 then
                invoke = true
                room:setPlayerMark(player, "sfofl_paoxi+2_num-Clear", 0)
                room:setPlayerMark(player, "&sfofl_paoxi+2_num-Clear", 0)
            end
        elseif event == sgs.DamageInflicted then
            if player:getMark("sfofl_paoxi+1_num-Clear") > 0 then
                invoke = true
                room:setPlayerMark(player, "sfofl_paoxi+1_num-Clear", 0)
                room:setPlayerMark(player, "&sfofl_paoxi+1_num-Clear", 0)
            end
        end
        if invoke then
            damage.damage = damage.damage + 1
            local log = sgs.LogMessage()
            log.type = "#skill_add_damage"
            log.from = damage.from
            log.to:append(damage.to)
            log.arg  = "sfofl_paoxi"
            log.arg2 = damage.damage
            player:getRoom():sendLog(log)
            data:setValue(damage)
        end
	end
}


--[[
	技能名：后应
	相关武将：邓茂[官盗]
	技能描述：出牌阶段，你可以弃置两张黑色牌并视为使用一张无次数限制的【杀】，若造成伤害，你摸一张牌。
	引用：sfofl_houying
]] --
sfofl_houyingCard = sgs.CreateSkillCard{
	name = "sfofl_houying",
	target_fixed = false,
	will_throw = true,
	filter = function(self, targets, to_select) --必须
	local card = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
	card:deleteLater()
	card:setSkillName(self:objectName())
	local qtargets = sgs.PlayerList()
			for _, p in ipairs(targets) do
				qtargets:append(p)
			end
		if to_select:objectName() ~= sgs.Self:objectName() and sgs.Self:canSlash(to_select, card,false) then
			return card:targetFilter(qtargets, to_select, sgs.Self) and not sgs.Self:isProhibited(to_select, card, qtargets)
		end
	end,
	on_use = function(self, room, source, targets) 
		if #targets > 0 then
			local card = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
			card:setSkillName(self:objectName())
			card:deleteLater()
			local use = sgs.CardUseStruct()
			use.from = source
			for _,target in ipairs(targets) do
				use.to:append(target)
			end
			use.card = card
			room:useCard(use, false)
		end
	end,
}
sfofl_houyingVS = sgs.CreateViewAsSkill{
	name = "sfofl_houying",
	n = 2,
	view_filter = function(self, selected, to_select)
		return to_select:isBlack()
	end, 
	view_as = function(self, cards)
	if #cards == 2 then 
		local card = sfofl_houyingCard:clone()
		card:addSubcard(cards[1])
		card:addSubcard(cards[2])
		card:setSkillName(self:objectName())
		return card
		end
	end,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_houying")
	end,
}
sfofl_houying = sgs.CreateTriggerSkill{
    name = "sfofl_houying",
    events = {sgs.CardFinished},
    view_as_skill = sfofl_houyingVS,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.CardFinished then   
            local use = data:toCardUse()
            if use.card:isKindOf("Slash") and table.contains(use.card:getSkillNames(), "sfofl_houying") and use.card:hasFlag("DamageDone") then
                player:drawCards(1, self:objectName())
            end
        end
    end
}


sfofl_dengmao:addSkill(sfofl_paoxi)
sfofl_dengmao:addSkill(sfofl_paoxi_buff)
extension_e:insertRelatedSkills("sfofl_paoxi", "#sfofl_paoxi_buff")
sfofl_dengmao:addSkill(sfofl_houying)

sfofl_chengyuanzhi = sgs.General(extension_e, "sfofl_chengyuanzhi", "qun", 5)
--[[
	技能名：武嚣
	相关武将：程远志[官盗]
	技能描述：锁定技，每名角色的回合内首次有红色牌进入弃牌堆后，你本回合下次造成和受到的伤害+1。
	引用：sfofl_wuxiao
]] --


sfofl_wuxiao = sgs.CreateTriggerSkill{
	name = "sfofl_wuxiao",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.CardsMoveOneTime,},
	on_trigger = function(self, event, player, data, room)
		local current = room:getCurrent()
		if not current or current:isDead() or current:getPhase() == sgs.Player_NotActive then return false end		
		local move = data:toMoveOneTime()			
		if (move.to_place == sgs.Player_DiscardPile) then
			for _, card_id in sgs.qlist(move.card_ids) do
				local card = sgs.Sanguosha:getCard(card_id)
                if card:isRed() then
                    for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                        if p:getMark("sfofl_wuxiaoUsed-Clear") == 0 then
                            room:setPlayerMark(p, "sfofl_wuxiao+1_num-Clear", 1)
                            room:setPlayerMark(p, "sfofl_wuxiao+2_num-Clear", 1)
                            room:setPlayerMark(p, "sfofl_wuxiaoUsed-Clear", 1)
                            room:setPlayerMark(p, "&sfofl_wuxiao+1_num-Clear", 1)
                            room:setPlayerMark(p, "&sfofl_wuxiao+2_num-Clear", 1)
                        end
                    end
                end
			end	
			
		end		
	end,
	can_trigger = function(self, target)
		return target
	end
}
sfofl_wuxiao_buff = sgs.CreateTriggerSkill{
	name = "#sfofl_wuxiao_buff",
	events = {sgs.DamageCaused, sgs.DamageInflicted},
	frequency = sgs.Skill_Compulsory, 
	on_trigger = function(self, event, player, data,room)
        local invoke = false
        local damage = data:toDamage()
        if event == sgs.DamageCaused then
            if player:getMark("sfofl_wuxiao+2_num-Clear") > 0 then
                invoke = true
                room:setPlayerMark(player, "sfofl_wuxiao+2_num-Clear", 0)
                room:setPlayerMark(player, "&sfofl_wuxiao+2_num-Clear", 0)
            end
        elseif event == sgs.DamageInflicted then
            if player:getMark("sfofl_wuxiao+1_num-Clear") > 0 then
                invoke = true
                room:setPlayerMark(player, "sfofl_wuxiao+1_num-Clear", 0)
                room:setPlayerMark(player, "&sfofl_wuxiao+1_num-Clear", 0)
            end
        end
        if invoke then
            local damage = data:toDamage()
            damage.damage = damage.damage + 1
            local log = sgs.LogMessage()
            log.type = "#skill_add_damage"
            log.from = damage.from
            log.to:append(damage.to)
            log.arg  = "sfofl_wuxiao"
            log.arg2 = damage.damage
            room:sendLog(log)
            data:setValue(damage)
        end
	end
}

--[[
	技能名：前呼
	相关武将：程远志[官盗]
	技能描述：出牌阶段，你可以弃置两张红色牌并视为使用一张【决斗】，若你造成伤害，你摸一张牌。
	引用：sfofl_qianhu
]] --

sfofl_qianhuCard = sgs.CreateSkillCard{
	name = "sfofl_qianhu",
	target_fixed = false,
	will_throw = true,
	filter = function(self, targets, to_select) --必须
	local card = sgs.Sanguosha:cloneCard("duel", sgs.Card_SuitToBeDecided, -1)
	card:deleteLater()
	card:setSkillName(self:objectName())
	local qtargets = sgs.PlayerList()
			for _, p in ipairs(targets) do
				qtargets:append(p)
			end
		if to_select:objectName() ~= sgs.Self:objectName() then
			return card:targetFilter(qtargets, to_select, sgs.Self) and not sgs.Self:isProhibited(to_select, card, qtargets)
		end
	end,
	on_use = function(self, room, source, targets) 
		if #targets > 0 then
			local card = sgs.Sanguosha:cloneCard("duel", sgs.Card_NoSuit, 0)
			card:setSkillName(self:objectName())
			card:deleteLater()
			local use = sgs.CardUseStruct()
			use.from = source
			for _,target in ipairs(targets) do
				use.to:append(target)
			end
			use.card = card
			room:useCard(use, false)
            if use.card:hasFlag("DamageDone") then
                source:drawCards(1, self:objectName())
            end
		end
	end,
}
sfofl_qianhuVS = sgs.CreateViewAsSkill{
	name = "sfofl_qianhu",
	n = 2,
	view_filter = function(self, selected, to_select)
		return to_select:isRed()
	end, 
	view_as = function(self, cards)
	if #cards == 2 then 
		local card = sfofl_qianhuCard:clone()
		card:addSubcard(cards[1])
		card:addSubcard(cards[2])
		card:setSkillName(self:objectName())
		return card
		end
	end,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_qianhu")
	end,
}
sfofl_qianhu = sgs.CreateTriggerSkill{
    name = "sfofl_qianhu",
    events = {sgs.CardFinished},
    view_as_skill = sfofl_qianhuVS,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.CardFinished then   
            local use = data:toCardUse()
            if use.card:isKindOf("Slash") and table.contains(use.card:getSkillNames(), "sfofl_qianhu") and use.card:hasFlag("DamageDone") then
                player:drawCards(1, self:objectName())
            end
        end
    end
}



sfofl_chengyuanzhi:addSkill(sfofl_wuxiao)
sfofl_chengyuanzhi:addSkill(sfofl_wuxiao_buff)
extension_e:insertRelatedSkills("sfofl_wuxiao", "#sfofl_wuxiao_buff")
sfofl_chengyuanzhi:addSkill(sfofl_qianhu)


sfofl_shenzhangjiao = sgs.General(extension_e, "sfofl_shenzhangjiao", "god", 4)
sfofl_shenzhangbao = sgs.General(extension_e, "sfofl_shenzhangbao", "god", 4, true, true)
sfofl_shenzhangliang = sgs.General(extension_e, "sfofl_shenzhangliang", "god", 4, true, true)
--[[
	技能名：瞑道
	相关武将：神张角[官盗]
	技能描述：游戏开始时，你可以将一张【众】置入你的装备区，【众】离开你的装备区时销毁。
	引用：sfofl_mingdao
    不會改眾的花色 理論上應該是能裝到任意裝備位 但實際是每個裝備牌都寫了 想不出更好的做法
    targetmod cardmax 不成功
]] --
sfofl_mingdao_change = sgs.CreateTriggerSkill{
	name = "#sfofl_mingdao_change",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.BeforeCardsMove},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
        if (event == sgs.BeforeCardsMove) then
			local move = data:toMoveOneTime()
			if move.from_places:contains(sgs.Player_PlaceEquip) and move.reason.m_skillName~="BreakCard"
			and move.from:objectName()==player:objectName() then
                local card_ids = move.card_ids
				for i,id in sgs.list(card_ids)do
					if move.from_places:at(i)==sgs.Player_PlaceEquip
					and sgs.Sanguosha:getCard(id):isKindOf("sfofl_YellowTurbanRebels") then
						local ids = sgs.IntList()
						ids:append(id)
						move:removeCardIds(ids)
						data:setValue(move)
						room:breakCard(id,player)
                        local disable = {"weapon", "armor", "offensivehorse", "defensivehorse"}
                        local string = disable[sgs.Sanguosha:getCard(id):getRealCard():toEquipCard():location()+1]
                        local x = player:getTag("sfofl_YellowTurbanRebels_"..string):toInt()
                        player:setTag("sfofl_YellowTurbanRebels"..x, sgs.QVariant(false))
                        player:setTag("sfofl_YellowTurbanRebels_"..string, sgs.QVariant(0))
                        room:detachSkillFromPlayer(player,"_sfofl_YellowTurbanRebels"..x,true,true)
                        room:setPlayerProperty(player, "sfofl_YellowTurbanRebels"..x, sgs.QVariant(false))
                    end
                end
			end
		end
	end,
	can_trigger = function(self, player)
		return player
	end,
}
sfofl_mingdao = sgs.CreateTriggerSkill{
	name = "sfofl_mingdao",
	frequency = sgs.Skill_NotFrequent,
	events = {sgs.GameStart},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
        if event == sgs.GameStart then
            local cards = sgs.IntList()
            for _,id in sgs.qlist(sgs.Sanguosha:getRandomCards(true)) do
                if sgs.Sanguosha:getEngineCard(id):isKindOf("sfofl_YellowTurbanRebels") and room:getCardPlace(id) == sgs.Player_PlaceTable  then
                    cards:append(id)
                end
            end
            if not cards:isEmpty() and room:askForSkillInvoke(player, self:objectName()) then
                for _, id in sgs.qlist(cards) do
                    room:useCard(sgs.CardUseStruct(sgs.Sanguosha:getEngineCard(id), player, player), false)
                    break
                end
            end
		end
	end,
}
sfofl_YellowTurbanRebels_weapon = sgs.CreateWeapon{
	name = "_sfofl_YellowTurbanRebels_weapon",
	class_name = "sfofl_YellowTurbanRebels",
	range = 1,
    number = 1,
    suit = 0,
	on_install = function(self,player)
		local room = player:getRoom()
		local YellowTurbanRebels = {0, 1, 2, 3}
        local choicelist = {}
        for _, skill in pairs(YellowTurbanRebels) do
            if not player:getTag("sfofl_YellowTurbanRebels"..skill):toBool() then
                table.insert(choicelist, skill)
            end
        end
        local choice = room:askForChoice(player, "sfofl_YellowTurbanRebels",table.concat(choicelist,"+"))
        player:setTag("sfofl_YellowTurbanRebels"..choice, sgs.QVariant(true))
        player:setTag("sfofl_YellowTurbanRebels_weapon", sgs.QVariant(choice))
        -- room:attachSkillToPlayer(player,"_sfofl_YellowTurbanRebels"..choice)
        room:acquireSkill(player,"_sfofl_YellowTurbanRebels"..choice, true, true, false)
        room:changeTranslation(player, "_sfofl_YellowTurbanRebels"..choice, sgs.Sanguosha:translate(":_sfofl_YellowTurbanRebels_weapon") .. sgs.Sanguosha:translate("sfofl_YellowTurbanRebels:"..choice))
        room:setPlayerProperty(player, "sfofl_YellowTurbanRebels"..choice, sgs.QVariant(true))
		return false
	end,
	on_uninstall = function(self,player)
	end,
}
sfofl_YellowTurbanRebels_armor = sgs.CreateArmor{
	name = "_sfofl_YellowTurbanRebels_armor",
	class_name = "sfofl_YellowTurbanRebels",
    number = 1,
    suit = 1,
	on_install = function(self,player)
		local room = player:getRoom()
		local YellowTurbanRebels = {0, 1, 2, 3}
        local choicelist = {}
        for _, skill in pairs(YellowTurbanRebels) do
            if not player:getTag("sfofl_YellowTurbanRebels"..skill):toBool() then
                table.insert(choicelist, skill)
            end
        end
        local choice = room:askForChoice(player, "sfofl_YellowTurbanRebels",table.concat(choicelist,"+"))
        player:setTag("sfofl_YellowTurbanRebels"..choice, sgs.QVariant(true))
        player:setTag("sfofl_YellowTurbanRebels_armor", sgs.QVariant(choice))
        -- room:attachSkillToPlayer(player,"_sfofl_YellowTurbanRebels"..choice)
        room:acquireSkill(player,"_sfofl_YellowTurbanRebels"..choice, true, true, false)
        room:changeTranslation(player, "_sfofl_YellowTurbanRebels"..choice, sgs.Sanguosha:translate(":_sfofl_YellowTurbanRebels_armor") .. sgs.Sanguosha:translate("sfofl_YellowTurbanRebels:"..choice))
        room:setPlayerProperty(player, "sfofl_YellowTurbanRebels"..choice, sgs.QVariant(true))
		return false
	end,
	on_uninstall = function(self,player)
	end,
}

sfofl_YellowTurbanRebels_offensivehorse = sgs.CreateOffensiveHorse{
	name = "_sfofl_YellowTurbanRebels_offensivehorse",
	class_name = "sfofl_YellowTurbanRebels",
    number = 1,
    suit = 2,
	on_install = function(self,player)
		local room = player:getRoom()
		local YellowTurbanRebels = {0, 1, 2, 3}
        local choicelist = {}
        for _, skill in pairs(YellowTurbanRebels) do
            if not player:getTag("sfofl_YellowTurbanRebels"..skill):toBool() then
                table.insert(choicelist, skill)
            end
        end
        local choice = room:askForChoice(player, "sfofl_YellowTurbanRebels",table.concat(choicelist,"+"))
        player:setTag("sfofl_YellowTurbanRebels"..choice, sgs.QVariant(true))
        player:setTag("sfofl_YellowTurbanRebels_offensivehorse", sgs.QVariant(choice))
        -- room:attachSkillToPlayer(player,"_sfofl_YellowTurbanRebels"..choice)
        room:acquireSkill(player,"_sfofl_YellowTurbanRebels"..choice, true, true, false)
        room:changeTranslation(player, "_sfofl_YellowTurbanRebels"..choice, sgs.Sanguosha:translate(":_sfofl_YellowTurbanRebels_offensivehorse") .. sgs.Sanguosha:translate("sfofl_YellowTurbanRebels:"..choice))
        room:setPlayerProperty(player, "sfofl_YellowTurbanRebels"..choice, sgs.QVariant(true))
		return false
	end,
	on_uninstall = function(self,player)
	end,
}
sfofl_YellowTurbanRebels_defensivehorse = sgs.CreateDefensiveHorse{
	name = "_sfofl_YellowTurbanRebels_defensivehorse",
	class_name = "sfofl_YellowTurbanRebels",
    number = 1,
    suit = 3,
	on_install = function(self,player)
		local room = player:getRoom()
		local YellowTurbanRebels = {0, 1, 2, 3}
        local choicelist = {}
        for _, skill in pairs(YellowTurbanRebels) do
            if not player:getTag("sfofl_YellowTurbanRebels"..skill):toBool() then
                table.insert(choicelist, skill)
            end
        end
        local choice = room:askForChoice(player, "sfofl_YellowTurbanRebels",table.concat(choicelist,"+"))
        player:setTag("sfofl_YellowTurbanRebels"..choice, sgs.QVariant(true))
        player:setTag("sfofl_YellowTurbanRebels_defensivehorse", sgs.QVariant(choice))
        -- room:attachSkillToPlayer(player,"_sfofl_YellowTurbanRebels"..choice)
        room:acquireSkill(player,"_sfofl_YellowTurbanRebels"..choice, true, true, false)
        room:changeTranslation(player, "_sfofl_YellowTurbanRebels"..choice, sgs.Sanguosha:translate(":_sfofl_YellowTurbanRebels_defensivehorse") .. sgs.Sanguosha:translate("sfofl_YellowTurbanRebels:"..choice))
        room:setPlayerProperty(player, "sfofl_YellowTurbanRebels"..choice, sgs.QVariant(true))
		return false
	end,
	on_uninstall = function(self,player)
	end,
}




--[[
	技能名：众
	相关武将：神张角[官盗]
	技能描述：锁定技，你造成/受到的雷电伤害+1/-1。
	引用：sfofl_YellowTurbanRebels1
]] --

sfofl_YellowTurbanRebels0 = sgs.CreateTriggerSkill{
	name = "_sfofl_YellowTurbanRebels0&",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.DamageCaused, sgs.DamageInflicted},
	can_trigger = function(self,target)
		return target and target:getTag("sfofl_YellowTurbanRebels0"):toBool()
	end,
	on_trigger = function(self,event,player,data,room)
   		local damage = data:toDamage()
        if damage.nature == sgs.DamageStruct_Thunder then
            room:sendCompulsoryTriggerLog(player, "_sfofl_YellowTurbanRebels0")
            if event == sgs.DamageCaused then
                player:damageRevises(data,1)
            else
                player:damageRevises(data,-1)
            end
        end
		return false
	end
}

--[[
	技能名：众
	相关武将：神张角[官盗]
	技能描述：锁定技，出牌阶段使用杀的次数+1，你使用杀无距离限制。
	引用：sfofl_YellowTurbanRebels2
]] --
sfofl_YellowTurbanRebels2 = sgs.CreateTargetModSkill{
	name = "_sfofl_YellowTurbanRebels2&",
	frequency = sgs.Skill_Compulsory,
    pattern = "Slash",
	residue_func = function(self, from, card)
        if from and from:property("sfofl_YellowTurbanRebels2"):toBool() then
            return 1
        end
        return 0
	end,
    distance_limit_func = function(self, from, card, to)
        if from and from:property("sfofl_YellowTurbanRebels2"):toBool() then
            return 999
        end
        return 0
    end
}


--[[
	技能名：众
	相关武将：神张角[官盗]
	技能描述：锁定技，当你受到伤害后，你摸两张牌。
	引用：sfofl_YellowTurbanRebels3
]] --


sfofl_YellowTurbanRebels3 = sgs.CreateTriggerSkill{
	name = "_sfofl_YellowTurbanRebels3&",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.Damaged},
	can_trigger = function(self,target)
		return target and target:getTag("sfofl_YellowTurbanRebels3"):toBool()
	end,
	on_trigger = function(self,event,player,data,room)
        room:sendCompulsoryTriggerLog(player, "_sfofl_YellowTurbanRebels3")
   		player:drawCards(2, self:objectName())
		return false
	end
}


--[[
	技能名：众
	相关武将：神张角[官盗]
	技能描述：锁定技，摸牌阶段多摸一张牌，手牌上限+1。
	引用：sfofl_YellowTurbanRebels4
]] --
sfofl_YellowTurbanRebels1 = sgs.CreateTriggerSkill{
	name = "_sfofl_YellowTurbanRebels1&",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.DrawNCards},
	can_trigger = function(self,target)
		return target and target:getTag("sfofl_YellowTurbanRebels1"):toBool()
	end,
	on_trigger = function(self,event,player,data,room)
   		local draw = data:toDraw()
        if draw.reason ~= "draw_phase" then return false end
        room:sendCompulsoryTriggerLog(player, "_sfofl_YellowTurbanRebels1")
        draw.num = draw.num + 1
        data:setValue(draw)
		return false
	end
}
sfofl_YellowTurbanRebels1_cardmax = sgs.CreateMaxCardsSkill {
	name = "#sfofl_YellowTurbanRebels1_cardmax",
	extra_func = function(self, target, player)
		if target:property("sfofl_YellowTurbanRebels1"):toBool() then
			return 1
		end
        return 0
	end
}
--[[
	技能名：众附
	相关武将：神张角[官盗]
	技能描述：每轮开始时，你可以声明一种花色，然后令手牌最少的角色依次选择一项：1.将一张牌置于牌堆顶；2.从牌堆底摸一张牌。本轮当以此法失去牌的角色造成伤害后，你可以发动一次〖瞑道〗。
	引用：sfofl_zhongfu
]] --
sfofl_zhongfu = sgs.CreateTriggerSkill{
	name = "sfofl_zhongfu",
	frequency = sgs.Skill_NotFrequent,
	events = {sgs.RoundStart},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
        if room:askForSkillInvoke(player,self:objectName()) then
            local min = 999
            for _, p in sgs.qlist(room:getAllPlayers()) do
                if p:getHandcardNum() < min then
                    min = p:getHandcardNum()
                end
            end
            local suit = room:askForSuit(player,self:objectName())
            if suit then
                local suit_str = sgs.Card_Suit2String(suit)
                local log = sgs.LogMessage()
                log.type = "#ChooseSuit"
                log.from = player
                log.arg = suit_str
                room:sendLog(log)
                room:addPlayerMark(player, "&sfofl_zhongfu+:+"..suit_str.."_char_lun")
                for _, p in sgs.qlist(room:getAllPlayers()) do
                    if p:getHandcardNum() == min then
                        local card = room:askForCard(p, ".", "@sfofl_zhongfu:"..player:objectName(), ToData(player), sgs.Card_MethodNone)
                        if card then
                            room:moveCardTo(card, p, nil,sgs.Player_DrawPile,sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_PUT, p:objectName(), "sfofl_zhongfu", ""))
                            room:addPlayerMark(p, "&sfofl_zhongfu+to+#"..player:objectName().."_lun")
                        else
                            p:drawCards(1, self:objectName(), false)
                        end
                    end
                end
                local data = sgs.QVariant("sfofl_dangjing:"..suit_str)
		        room:getThread():trigger(sgs.EventForDiy,room,player,data)
            end
        end
	end,
}
sfofl_zhongfu_buff = sgs.CreateTriggerSkill{
    name = "#sfofl_zhongfu_buff",
    events = {sgs.Damage},
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        for _, p in sgs.qlist(room:findPlayersBySkillName("sfofl_zhongfu")) do
            if player:getMark("&sfofl_zhongfu+to+#"..p:objectName().."_lun") > 0 and room:askForSkillInvoke(p, "sfofl_zhongfu", sgs.QVariant("sfofl_mingdao")) then
                local mingdao = sgs.Sanguosha:getTriggerSkill("sfofl_mingdao")
                mingdao:trigger(sgs.GameStart, room, p, data)
            end
        end
        
    end,
    can_trigger = function(self, target)
        return target
    end,
}

--[[
	技能名：荡京
	相关武将：神张角[官盗]
	技能描述：当你发动〖众附〗后，若你装备区内的牌为全场最多，你可以令一名角色进行一次判定，若为你〖众附〗声明的花色，你对其造成1点雷电伤害且可以重复此流程。
	引用：sfofl_dangjing
]] --
sfofl_dangjing = sgs.CreateTriggerSkill{
	name = "sfofl_dangjing",
	frequency = sgs.Skill_Frequent,
	events = {sgs.EventForDiy},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.EventForDiy) then
			local ys = data:toString()
			if ys:startsWith("sfofl_dangjing:") then
				local sts = ys:split(":")
				local suit = sts[2]
                local max = 0
                for _, p in sgs.qlist(room:getAllPlayers()) do
                    if p:getEquips():length() > max then
                        max = p:getEquips():length()
                    end
                end
                if player:getEquips():length() >= max then
                    local target = room:askForPlayerChosen(player, room:getAlivePlayers(), self:objectName(), "sfofl_dangjing-invoke", true, true)
                    if not target then return false end
                    while player:askForSkillInvoke(self:objectName()) do
                        local judge = sgs.JudgeStruct()
                        judge.pattern = ".|"..suit
                        judge.good = true
                        judge.reason = self:objectName()
                        judge.who = player
                        judge.time_consuming = true
                        room:judge(judge)
                        if judge:isBad() then
                            break
                        else
                            local damage = sgs.DamageStruct()
                            damage.card = nil
                            damage.from = player
                            damage.to = target
                            damage.nature = sgs.DamageStruct_Thunder
                            room:damage(damage)
                        end
                    end
                end
			end
		end
	end,
}

--[[
	技能名：三首
	相关武将：神张角[官盗]
	技能描述：锁定技，你的准备阶段和结束阶段改为出牌阶段，并在此阶段将武将牌改为张宝或张梁。此阶段结束后把武将牌替换回张角。
	引用：sfofl_sanshou
]] --


sfofl_sanshou = sgs.CreateTriggerSkill{
	name = "sfofl_sanshou",  
	frequency = sgs.Skill_Compulsory, 
	events = {sgs.EventPhaseChanging},  
	on_trigger = function(self, event, player, data) 
    	if event == sgs.EventPhaseChanging then
	    	local change = data:toPhaseChange()
		    local nextphase = change.to
            local room = player:getRoom()
            if nextphase == sgs.Player_Start or nextphase == sgs.Player_Finish then
			    if not player:isSkipped(nextphase) then
				    local sanshou = {"sfofl_shenzhangbao", "sfofl_shenzhangliang"}
                    local choicelist = {}
                    for _, gn in pairs(sanshou) do
                        if player:getMark(gn.."-Clear") == 0 then
                            table.insert(choicelist, gn)
                        end
                    end
                    if #choicelist > 0 then
                        local gn 
                        if player:getState() == "online" then
                            gn = room:askForGeneral(player,table.concat(choicelist, "+"))
                        else
                            gn = choicelist[math.random(1,#choicelist)]
                        end
                        room:addPlayerMark(player, gn.."-Clear")
                        if player:getGeneral2Name()=="sfofl_shenzhangjiao" then
                            room:changeHero(player,gn,false,false, true)
                        elseif player:getGeneralName()=="sfofl_shenzhangjiao" then
                            room:changeHero(player,gn,false,false)
                        end
                    end
                    
				    change.to = sgs.Player_Play
				    data:setValue(change)
			    end
            else
                if player:getGeneralName()=="sfofl_shenzhangbao" or player:getGeneralName()=="sfofl_shenzhangliang" then
                    room:changeHero(player,"sfofl_shenzhangjiao",false,false)
                end
                if player:getGeneral2Name()=="sfofl_shenzhangbao" or player:getGeneral2Name()=="sfofl_shenzhangliang" then
                    room:changeHero(player,"sfofl_shenzhangjiao",false,false, true)
                end
		    end
		end
	end
}

--[[
	技能名：咒怨
	相关武将：神张宝[官盗]
	技能描述：出牌阶段限一次，你可以选择一名其他角色，其将所有黑色/红色手牌扣置于其武将牌上，你将所有红色/黑色手牌置于武将牌上，这些牌称为“咒兵”。出牌阶段结束时，你与其收回“咒兵”。"
	引用：sfofl_zhouyuan
]] --
sfofl_zhouyuanCard = sgs.CreateSkillCard {
	name = "sfofl_zhouyuan",
	target_fixed = false,
    will_throw = false,
	filter = function(self, targets, to_select)
		if #targets == 0 then
			return to_select:objectName() ~= sgs.Self:objectName() and not to_select:isKongcheng()
		end
        return false
	end ,
	on_use = function(self, room, source, targets)
        local target = targets[1]
        local hand = target:getHandcards()
        local card_ids = sgs.IntList()
        for _,card in sgs.qlist(hand) do
            if sgs.Sanguosha:getCard(self:getSubcards():first()):getColor() ~= card:getColor() then
                card_ids:append(card:getEffectiveId())
            end
        end
        if not card_ids:isEmpty() then
            local splayers = sgs.SPlayerList()
            splayers:append(target)
            splayers:append(source)
            target:addToPile("sfofl_zhoubing", card_ids, false, splayers)
        end
        local splayers = sgs.SPlayerList()
        splayers:append(source)
        source:addToPile("sfofl_zhoubing", self, false, splayers)
	end
}
sfofl_zhouyuan = sgs.CreateViewAsSkill {
	name = "sfofl_zhouyuan",
	n = 999,
	view_filter = function(self, selected, to_select)
		if #selected == 0 then
			return not to_select:isEquipped()
		elseif #selected > 0 then
			local card = selected[1]
			if card:getColor() == to_select:getColor() then
				return not to_select:isEquipped()
			end
		end
	end,
	view_as = function(self, cards)
		if #cards > 0 then
            local hand = sgs.Self:getHandcards()
            local x = 0
            for _,card in sgs.qlist(hand) do
                if cards[1]:getColor() == card:getColor() then
                    x = x + 1
                end
            end
            if #cards == x then
                local vs_card = sfofl_zhouyuanCard:clone()
                for _,card in pairs(cards) do
                    vs_card:addSubcard(card)
                end
                vs_card:setSkillName(self:objectName())
                return vs_card
            end
		end
	end,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_zhouyuan") and not player:isKongcheng()
	end,
}
sfofl_zhouyuan_return = sgs.CreateTriggerSkill{
    name = "#sfofl_zhouyuan_return",
    events = {sgs.EventPhaseEnd},
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        for _, p in sgs.qlist(room:getAllPlayers()) do
            if not p:getPile("sfofl_zhoubing"):isEmpty() then
                local obtain = sgs.Sanguosha:cloneCard("jink", sgs.Card_SuitToBeDecided, -1)
                obtain:addSubcards(p:getPile("sfofl_zhoubing"))
                room:obtainCard(p, obtain, false)
                obtain:deleteLater()
            end
        end
    end,
    can_trigger = function(self, target)
        return target and target:getPhase() == sgs.Player_Play
    end,
}


--[[
	技能名：诏兵
	相关武将：神张宝[官盗]
	技能描述：出牌阶段，你可以将“咒兵”如手牌般使用或打出。
	引用：sfofl_zhaobing
]] --

sfofl_zhaobing = sgs.CreateViewAsSkill {
	name = "sfofl_zhaobing",
	n = 1,
    expand_pile = "%sfofl_zhoubing,sfofl_zhoubing",
	view_filter = function(self, selected, to_select)
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE
        or sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
            local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
            if pattern == "peach+analeptic" and sgs.Self:hasFlag("Global_PreventPeach") then
                pattern = "analeptic"
            end
            local can = false
            for _,p in sgs.list(pattern:split("+"))do
                local dc = dummyCard(p)
                if dc then
                    can = to_select:sameNameWith(dc, false)
                    if can then
                        break
                    end
                end
            end
            if can then
                for _,p in sgs.qlist(sgs.Self:getAliveSiblings(true)) do 
                    if p:getPile("sfofl_zhoubing"):length() > 0 then 
                        return p:getPile("sfofl_zhoubing"):contains(to_select:getId())
                    end
                end
            end
            return false
        end
        return sgs.Self:getPile("sfofl_zhoubing"):contains(to_select:getId()) and to_select:isAvailable(sgs.Self)
	end,
	view_as = function(self, cards)
        if #cards == 1 then
            return cards[1]
        end
	end,
	enabled_at_play = function(self, player)
        for _,p in sgs.qlist(player:getAliveSiblings()) do
            if not p:getPile("sfofl_zhoubing"):isEmpty() then
                return true
            end
        end
		return not player:getPile("sfofl_zhoubing"):isEmpty()
	end,
    enabled_at_response = function(self,player,pattern)
		for _,p in sgs.list(pattern:split("+"))do
			local dc = dummyCard(p)
			if dc then
                for _,p in sgs.qlist(player:getAliveSiblings(true)) do
                    for _,id in sgs.list(p:getPile("sfofl_zhoubing"))do
                        local card = sgs.Sanguosha:getCard(id)
                        if card:sameNameWith(dc, false) then
                            dc:setSkillName("sfofl_zhoubing")
                            if not player:isLocked(dc)
                            then return true end
                        end
                    end
                end
			end
		end
		return false
	end,
}
--[[
	技能名：集军
	相关武将：神张梁[官盗]
	技能描述：当你使用牌指定你为目标后，你可以进行判定，然后选择一项：1.获得此牌；2.将判定牌置于武将牌上，称为“方”。
	引用：sfofl_jijun
]] --
sfofl_jijun = sgs.CreateTriggerSkill{
    name = "sfofl_jijun",
    events = {sgs.TargetConfirmed},
    frequency = sgs.Skill_NotFrequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local use = data:toCardUse()
        if use.card:isKindOf("SkillCard") then return false end
        if use.from:objectName() ~= player:objectName() then return false end
        if not use.to:contains(player) then return false end
        room:sendCompulsoryTriggerLog(player, self:objectName())
        if room:askForSkillInvoke(player, self:objectName()) then
            local judge = sgs.JudgeStruct()
            judge.pattern = "."
            judge.good = true
            judge.who = player
            judge.reason = self:objectName()
            room:judge(judge)
            if room:askForSkillInvoke(player, self:objectName(), sgs.QVariant("obtain")) then
                player:addToPile("sfofl_fang", judge.card, true)
            else
                room:obtainCard(player, judge.card)
            end
        end
    end,
}

--[[
	技能名：方统
	相关武将：神张梁[官盗]
	技能描述：出牌阶段结束时，若有“方”，你可以重铸一张手牌，若你重铸的牌与你的任意“方”点数之和为36，你可以将对应的“方”置入弃牌堆，然后对一名其他角色造成3点雷电伤害。
	引用：sfofl_fangtong
]] --
sfofl_fangtongCard = sgs.CreateSkillCard{
	name = "sfofl_fangtong",
    will_throw = false,
	filter = function(self, targets, to_select)
        if (#targets >= 1) or (to_select:objectName() == sgs.Self:objectName()) then return false end
		return true
	end,
	on_effect = function(self, effect)
		local room = effect.from:getRoom()
        local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_REMOVE_FROM_PILE, "", "sfofl_fangtong", "");
		room:throwCard(self, reason, nil);
        room:broadcastSkillInvoke("fangtong")
		local da = sgs.DamageStruct("sfofl_fangtong", effect.from, effect.to, 3, sgs.DamageStruct_Thunder)
        room:damage(da)
	end
}
sfofl_fangtongVS = sgs.CreateViewAsSkill{
    name = "sfofl_fangtong",
    expand_pile = "sfofl_fang",
    n = 99,
    response_pattern = "@@sfofl_fangtong",
    view_filter = function(self, selected, to_select)
        local n = 36
        for _,p in ipairs(selected) do
            n = n - p:getNumber()
        end
        n = n - tonumber(sgs.Self:property("sfofl_fangtong"):toString())
        return (sgs.Self:getPile("sfofl_fang"):contains(to_select:getId())) and (to_select:getNumber() <= n)
	end,
    view_as = function(self, cards)
        if #cards == 0 then return nil end
        local n = sgs.Self:property("sfofl_fangtong"):toInt() or 0
        for _,p in ipairs(cards) do
            n = n + p:getNumber()
        end
        if n ~= 36 then return nil end
		local c = sfofl_fangtongCard:clone()
		for _, card in pairs(cards) do
			c:addSubcard(card)
		end
        c:setSkillName(self:objectName())
		return c
	end,
	enabled_at_play = function(self, player)
		return false
	end,
}

sfofl_fangtong = sgs.CreateTriggerSkill{
    name = "sfofl_fangtong",
    events = {sgs.EventPhaseEnd},
    frequency = sgs.Skill_NotFrequent,
    view_as_skill = sfofl_fangtongVS,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if player:getPile("sfofl_fang"):length() == 0 then return false end
        local card = room:askForCard(player , ".|.|.|hand", "@sfofl_fangtong-invoke", sgs.QVariant(), sgs.Card_MethodNone)
        if card then 
            local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_RECAST, player:objectName())
            reason.m_skillName = self:objectName()
            room:moveCardTo(card, player, nil, sgs.Player_DiscardPile, reason);
            player:broadcastSkillInvoke("@recast")
            local log = sgs.LogMessage()
            log.type = "#UseCard_Recast"
            log.from = player
            log.card_str = card:getNumberString()
            room:sendLog(log)
            player:drawCards(1, "recast")
            room:setPlayerProperty(player, "sfofl_fangtong", sgs.QVariant(card:getNumber()))
            room:askForUseCard(player, "@@sfofl_fangtong", string.format("@sfofl_fangtong:%s", card:getNumber()),-1)
            room:setPlayerProperty(player, "sfofl_fangtong", sgs.QVariant())
        end
    end,
    can_trigger = function(self, target)
        return target and target:hasSkill(self:objectName()) and target:getPhase() == sgs.Player_Play
    end,
}

if not sgs.Sanguosha:getSkill("_sfofl_YellowTurbanRebels0") then skills:append(sfofl_YellowTurbanRebels0) end
if not sgs.Sanguosha:getSkill("_sfofl_YellowTurbanRebels1") then skills:append(sfofl_YellowTurbanRebels1) end
if not sgs.Sanguosha:getSkill("#sfofl_YellowTurbanRebels1_cardmax") then skills:append(sfofl_YellowTurbanRebels1_cardmax) end
if not sgs.Sanguosha:getSkill("_sfofl_YellowTurbanRebels2") then skills:append(sfofl_YellowTurbanRebels2) end
if not sgs.Sanguosha:getSkill("_sfofl_YellowTurbanRebels3") then skills:append(sfofl_YellowTurbanRebels3) end

sfofl_YellowTurbanRebels_weapon:setParent(extension_card)
sfofl_YellowTurbanRebels_armor:setParent(extension_card)
sfofl_YellowTurbanRebels_offensivehorse:setParent(extension_card)
sfofl_YellowTurbanRebels_defensivehorse:setParent(extension_card)
sfofl_shenzhangjiao:addSkill(sfofl_mingdao)
sfofl_shenzhangjiao:addSkill(sfofl_mingdao_change)
extension_e:insertRelatedSkills("sfofl_mingdao", "#sfofl_mingdao_change")
sfofl_shenzhangjiao:addSkill(sfofl_zhongfu)
sfofl_shenzhangjiao:addSkill(sfofl_zhongfu_buff)
extension_e:insertRelatedSkills("sfofl_zhongfu", "#sfofl_zhongfu_buff")
sfofl_shenzhangjiao:addSkill(sfofl_dangjing)
sfofl_shenzhangjiao:addSkill(sfofl_sanshou)
sfofl_shenzhangbao:addSkill(sfofl_zhouyuan_return)
sfofl_shenzhangbao:addSkill(sfofl_zhouyuan)
sfofl_shenzhangbao:addSkill(sfofl_zhaobing)
sfofl_shenzhangbao:addSkill("sfofl_sanshou")
extension_e:insertRelatedSkills("sfofl_zhouyuan", "#sfofl_zhouyuan_return")
sfofl_shenzhangliang:addSkill(sfofl_jijun)
sfofl_shenzhangliang:addSkill(sfofl_fangtong)
sfofl_shenzhangliang:addSkill("sfofl_sanshou")



sfofl_shenhuangfusong = sgs.General(extension_e, "sfofl_shenhuangfusong", "god", 4)
--[[
	技能名：势策
	相关武将：神皇甫嵩[官盗]
	技能描述：转换技，①当你受到属性伤害时，若你的技能数不大于伤害来源，你可以防止此伤害并视为使用一张【火攻】；②当你不因此技能使用牌指定唯一目标后，你可以令其弃置装备区任意张牌，然后此牌额外结算X次（X为其装备区的牌数）。
	引用：sfofl_shice
]] --

sfofl_shice = sgs.CreateTriggerSkill{
    name = "sfofl_shice",
    events = {sgs.TargetConfirmed, sgs.DamageInflicted, sgs.CardFinished},
    frequency = sgs.Skill_NotFrequent,
    change_skill = true,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.DamageInflicted then
            local damage = data:toDamage()
            if player:getChangeSkillState(self:objectName()) <= 1 and damage.nature ~= sgs.DamageStruct_Normal and damage.from and damage.from:isAlive() then
                local skill_listuse = {}
                local skill_listplayer = {}
                for _,skill in sgs.qlist(damage.from:getVisibleSkillList()) do
                    if (not table.contains(skill_listuse,skill:objectName())) and not skill:isAttachedLordSkill() then
                        table.insert(skill_listuse,skill:objectName())
                    end
                end
                for _,skill in sgs.qlist(player:getVisibleSkillList()) do
                    if (not table.contains(skill_listplayer,skill:objectName())) and not skill:isAttachedLordSkill() then
                        table.insert(skill_listplayer,skill:objectName())
                    end
                end
                if (#skill_listplayer <= #skill_listuse ) then
                    local fratk = sgs.Sanguosha:cloneCard("FireAttack", sgs.Card_NoSuit, 0)
		            fratk:setSkillName(self:objectName())
                    fratk:deleteLater()
                    local extra_targets = room:getCardTargets(player, fratk)
                    if extra_targets:isEmpty() then return false end
                    room:setTag("sfofl_shice", data)
                    local others = room:askForPlayersChosen(player, extra_targets, self:objectName(), 0, 1+sgs.Sanguosha:correctCardTarget(sgs.TargetModSkill_ExtraTarget,player,fratk), "@sfofl_shice", true, true)
                    room:removeTag("sfofl_shice")
                    if others and others:length() > 0 then
                        room:setChangeSkillState(player, self:objectName(), 2)
                        local use = sgs.CardUseStruct()
                        use.from = player
                        use.card = fratk
                        use.to = others
                        room:useCard(use, false)
                        damage.prevented = true
                        data:setValue(damage)
                        return true
                    end
                end
            end
        elseif event == sgs.TargetConfirmed then
            local use = data:toCardUse()
            if use.card:isKindOf("SkillCard") then return false end
            if table.contains(use.card:getSkillNames(), "sfofl_shice") then return false end
            if use.to:length() ~= 1 then return false end
            if use.to:first():getEquips():length() == 0 then return false end
            if player:getChangeSkillState(self:objectName()) <= 1 then return false end
            local target = use.to:first()
            if target:canDiscard(target, "e") and room:askForSkillInvoke(player, self:objectName(), data) then
               room:setChangeSkillState(player, self:objectName(), 1)
               local max = target:getEquips():length()
               local discards = sgs.IntList()
               for i = 1, max do--进行多次执行
                    local id = room:askForCardChosen(target, target, "e", self:objectName(),
                        false,--选择卡牌时手牌不可见
                        sgs.Card_MethodDiscard,--设置为弃置类型
                        discards,--将子卡表设置为不可选卡牌id表（保证每张卡只能被选择一次）
                        true)--只有执行过一次选择才可取消
                    if id < 0 then break end--如果卡牌id无效就结束多次执行
                    discards:append(id)--将选择的id添加到虚拟卡的子卡表
                end
                room:throwCard(discards, "sfofl_shice", target, target)
                if target:getEquips():length() > 0 then
                    use.card:setTag("sfofl_shice",sgs.QVariant(target:getEquips():length()))
                end
            end
        elseif event == sgs.CardFinished then
			local use = data:toCardUse()
			if use.card:getTag("sfofl_shice") then
				local n = use.card:getTag("sfofl_shice"):toInt()
				if n > 0 then
					for i = 1,n do
						if player:isDead() then break end
						local use2 = sgs.CardUseStruct(use.card,player,use.to)
						room:setTag("UseHistory"..use.card:toString(),ToData(use2))
						use.card:use(room,player,use.to)
					end
				end
			end
        end
    end,
}


--[[
	技能名：破怠
	相关武将：神皇甫嵩[官盗]
	技能描述：每轮各限一次，一名角色的回合开始或结束时，你可以选择一顶：1.令其描述中含有基本牌名或数字的一个技能失效；2.令其摸三张牌，然后对其造成1点火焰伤害。
	引用：sfofl_podai
]] --


function PodaiNames(player)
    local basic = {}
    for id=0,sgs.Sanguosha:getCardCount()-1 do
		local c = sgs.Sanguosha:getEngineCard(id)
		if c:getTypeId()>2 or table.contains(basic,c:objectName()) then continue end
		if c:isKindOf("BasicCard") then table.insert(basic,c:objectName()) end
	end
    local skillnames = {}
    for _,s in sgs.list(player:getVisibleSkillList())do
        if player:getMark("sfofl_podai"..s:objectName()) > 0 then continue end
        if s:isAttachedLordSkill() then continue end
        local description = s:getDescription()
        local chineseNumbers = {"一", "二", "兩", "三", "四", "五", "六", "七", "八", "九", "十"}
        local englishNumbers = {"1", "2", "3", "4", "5", "6", "7", "8", "9", "0"}
        local numberFound = false
        for i, chineseNumber in ipairs(chineseNumbers) do
            if string.find(description, chineseNumber) then
                numberFound = true
                break
            end
        end

        if not numberFound then
            for i, englishNumber in ipairs(englishNumbers) do
                if string.find(description, englishNumber) then
                    numberFound = true
                    break
                end
            end
        end
        if numberFound then
            table.insert(skillnames, s:objectName())
            continue
        end

        for _,c in sgs.list(basic)do
            if string.find(description,"【"..sgs.Sanguosha:translate(c).."】") then
                table.insert(skillnames,s:objectName())
                break
            end
        end
    end
	
	
	return skillnames
end

sfofl_podai = sgs.CreateTriggerSkill{
	name = "sfofl_podai",
	events = {sgs.EventPhaseStart, sgs.EventPhaseChanging},
	on_trigger = function(self,event,player,data,room)
		if (event==sgs.EventPhaseStart and player:getPhase() == sgs.Player_Start) or (event==sgs.EventPhaseChanging and data:toPhaseChange().to==sgs.Player_NotActive) then
            for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                local choicelist = {}
                if p:getMark("sfofl_podai_skill_lun") == 0 then
                    if #PodaiNames(player) > 0 then
                        table.insert(choicelist, "skill="..player:objectName())
                    end
                end
                if p:getMark("sfofl_podai_damage_lun") == 0 then
                    table.insert(choicelist, "damage="..player:objectName())
                end
                if #choicelist > 0 then
                    table.insert(choicelist, "cancel")
                    local choice = room:askForChoice(p, self:objectName(), table.concat(choicelist, "+"), ToData(player))
                    if string.startsWith(choice,"skill") then
                        room:addPlayerMark(p, "sfofl_podai_skill_lun")
                        room:addPlayerMark(p, "&sfofl_podai+1_num_lun")
                        
                        local skilllist = PodaiNames(player)
                        local choice = room:askForChoice(p, self:objectName().."skill", table.concat(skilllist, "+"), ToData(player))
                        room:addPlayerMark(player, "&sfofl_podai+to+:+".. choice .."+#"..p:objectName())
                        room:addPlayerMark(player, "sfofl_podai"..choice)
                    end
                    if string.startsWith(choice,"damage") then
                        room:addPlayerMark(p, "sfofl_podai_damage_lun")
                        room:addPlayerMark(p, "&sfofl_podai+2_num_lun")
                        player:drawCards(3, self:objectName())
                        room:damage(sgs.DamageStruct(self:objectName(), p, player, 1, sgs.DamageStruct_Fire))
                    end
                end
            end
		end
	end,
    can_trigger = function(self,target)
		return target
	end,
}
sfofl_podaiInvalidity = sgs.CreateInvaliditySkill{
	name = "#sfofl_podaiInvalidity",
	skill_valid = function(self, player, skill)
		if player:getMark("sfofl_podai"..skill:objectName()) >= 1 then
			return false
		else
			return true
		end
	end
}


sfofl_shenhuangfusong:addSkill(sfofl_shice)
sfofl_shenhuangfusong:addSkill(sfofl_podai)
sfofl_shenhuangfusong:addSkill(sfofl_podaiInvalidity)
extension_e:insertRelatedSkills("sfofl_podai", "#sfofl_podaiInvalidity")

sfofl_shenluzhi = sgs.General(extension_e, "sfofl_shenluzhi", "god", 4)
--[[
	技能名：桢干
	相关武将：神卢植[官盗]
	技能描述：每个回合结束时，若本回合有角色交给过其他角色手牌，或计算距离与回合开始时不同，你可以令其中至多两名角色依次可以视为使用一张基本牌。
	引用：sfofl_zhengan
]] --

sfofl_zhengan_basicCard = sgs.CreateSkillCard{
	name = "sfofl_zhengan_basicCard",
	target_fixed = true,
	about_to_use = function(self,room,use)
		local p_choices = {}
		for _,dc in sgs.list(PatternsCard("BasicCard",true))do
			dc:setSkillName("sfofl_zhengan_basic")
			if dc:isAvailable(use.from)	then table.insert(p_choices,dc:objectName()) end
		end
		if #p_choices<1 then return end
		table.insert(p_choices,"cancel")
		p_choices = room:askForChoice(use.from,"sfofl_zhengan_basic",table.concat(p_choices,"+"))
		if p_choices=="cancel" then return end
		for i=0,sgs.Sanguosha:getCardCount()-1 do
			local c = sgs.Sanguosha:getEngineCard(i)
			if c:objectName()==p_choices then
				room:setPlayerMark(use.from,"sfofl_zhengan_basic_id",i)
				room:askForUseCard(use.from,"@@sfofl_zhengan_basic","@sfofl_zhengan_basic:"..p_choices,-1,sgs.Card_MethodPlay)
				break
			end
		end
        room:setPlayerMark(use.from,"sfofl_zhengan_basic_id",0)
	end
}
sfofl_zhengan_basic = sgs.CreateViewAsSkill{
	name = "sfofl_zhengan_basic&",
	view_as = function(self,cards)
		local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
		if pattern=="@@sfofl_zhengan_basic" then
			pattern = sgs.Self:getMark("sfofl_zhengan_basic_id")
			pattern = sgs.Sanguosha:getEngineCard(pattern)
			pattern = sgs.Sanguosha:cloneCard(pattern:objectName())
			pattern:setSkillName("sfofl_zhengan_basic")
			return pattern
		elseif pattern =="@@sfofl_zhengan" then
			return sfofl_zhengan_basicCard:clone()
		end
		return false
	end,
	enabled_at_response = function(self,player,pattern)
	   	return pattern=="@@sfofl_zhengan" or pattern == "@@sfofl_zhengan_basic"
	end,
	enabled_at_play = function(self,player)
		return false
	end,
}
sfofl_zhengan_buff = sgs.CreateTriggerSkill{
    name = "#sfofl_zhengan_buff",
	events = {sgs.GameStart,sgs.EventAcquireSkill},
	on_trigger = function(self, event, player, data)
	    local room = player:getRoom()
		--游戏开始时或获得技能时，每个人发一个技能
		for _, p in sgs.qlist(room:getAllPlayers()) do
			if not p:hasSkill("sfofl_zhengan_basic",true) then
				room:attachSkillToPlayer(p,"sfofl_zhengan_basic")
			end
		end
	end,
}
sfofl_zhengan = sgs.CreateTriggerSkill{
	name = "sfofl_zhengan",
	events = {sgs.EventPhaseChanging},
    priority = 1,
	on_trigger = function(self,event,player,data,room)
		if event==sgs.EventPhaseChanging and data:toPhaseChange().to==sgs.Player_NotActive then
            room:setPlayerMark(player, "sfofl_zhengan", 0)
            for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                local splayers = sgs.SPlayerList()
                for _, q in sgs.qlist(room:getAlivePlayers()) do
                    if q:getMark("sfofl_zhengan_target-Clear") > 0 then
                        splayers:append(q)
                    end
                end
                if not splayers:isEmpty() then
                    local targets = room:askForPlayersChosen(p,splayers,self:objectName(),0,2,"@sfofl_zhengan", true, true)
                    if targets and targets:length() > 0 then
                        for _,to in sgs.qlist(targets) do
                            room:askForUseCard(to, "@@sfofl_zhengan", "@sfofl_zhenganUse")
                        end
                    end
                end
            end
		end
	end,
    can_trigger = function(self,target)
		return target and target:getMark("sfofl_zhengan") > 0
	end,
}

sfofl_zhengan_record = sgs.CreateTriggerSkill{
	name = "#sfofl_zhengan_record",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.CardsMoveOneTime,sgs.EventPhaseStart, sgs.EventPhaseChanging},
	on_trigger = function(self, event, player, data, room)
		local current = room:getCurrent()
		if not current or current:isDead() then return false end
        if event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()			
            if (move.to_place == sgs.Player_PlaceHand) and move.from and move.to and move.from:objectName() ~= move.to:objectName()
                and (bit32.band(move.reason.m_reason, sgs.CardMoveReason_S_MASK_BASIC_REASON) == 
                    sgs.CardMoveReason_S_REASON_GIVE) then
                room:setPlayerMark(current, "sfofl_zhengan", 1)
                room:addPlayerMark(move.from, "sfofl_zhengan_target-Clear", 1)
            end	
        elseif event == sgs.EventPhaseStart then
            if player:getPhase() == sgs.Player_Start then
                for _, p in sgs.qlist(room:getAlivePlayers()) do
                    for _, q in sgs.qlist(room:getOtherPlayers(p)) do
                        room:setPlayerMark(p, "sfofl_zhengan_record"..q:objectName().."-Clear", p:distanceTo(q))
                    end
                end
            end
        elseif event == sgs.EventPhaseChanging and data:toPhaseChange().to==sgs.Player_NotActive then
            for _, p in sgs.qlist(room:getAlivePlayers()) do
                for _, q in sgs.qlist(room:getOtherPlayers(p)) do
                    if p:getMark("sfofl_zhengan_record"..q:objectName().."-Clear") ~= p:distanceTo(q) then
                        room:setPlayerMark(current, "sfofl_zhengan", 1)
                        room:addPlayerMark(p, "sfofl_zhengan_target-Clear", 1)
                    end
                end
            end
        end
	end
    ,
    can_trigger = function(self,target)
		return target
	end,
}


--[[
	技能名：围铸
	相关武将：神卢植[官盗]
	技能描述：出牌阶段限一次，你可以重铸任意张手牌，获得弃牌堆中等量张装备牌，然后你交给等量名其他角色各一张牌，以此法获得牌的角色本轮计算与除其以外的角色距离-1。
	引用：sfofl_weizhu
]] --
sfofl_weizhu_distance = sgs.CreateDistanceSkill {
	name = "#sfofl_weizhu_distance",
	correct_func = function(self, from, to)
        return from:getMark("sfofl_weizhu_lun")
	end
}
sfofl_weizhuCard = sgs.CreateSkillCard{
	name = "sfofl_weizhu",
	target_fixed = true,
	will_throw = false,
	on_use = function(self, room, source, targets)
        for _,id in sgs.qlist(self:getSubcards()) do
		    local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_RECAST, source:objectName())
            reason.m_skillName = self:objectName()
            room:moveCardTo(sgs.Sanguosha:getCard(id), source, nil, sgs.Player_DiscardPile, reason)
            source:broadcastSkillInvoke("@recast")
            local log = sgs.LogMessage()
            log.type = "#UseCard_Recast"
            log.from = source
            log.card_str = sgs.Sanguosha:getCard(id):toString()
            room:sendLog(log)
            source:drawCards(1, "recast")
        end
        local x = self:subcardsLength()
        local ids = room:getDiscardPile()
		ids = RandomList(ids)
		local dc = dummyCard()
		for _,id in sgs.qlist(ids)do
			if sgs.Sanguosha:getCard(id):isKindOf("EquipCard") then
				dc:addSubcard(id)
				if dc:subcardsLength()>=x then break end
			end
		end
		source:obtainCard(dc,true)
        local others = room:askForPlayersChosen(source, room:getOtherPlayers(source), self:objectName(), math.min(room:getOtherPlayers(source):length(), x), math.min(room:getOtherPlayers(source):length(), x), "@sfofl_weizhu", true, true)
        if others and others:length() > 0 then
            for _,p in sgs.qlist(others) do
                if not source:isKongcheng() then
                    room:setPlayerFlag(p, "sfofl_weizhu")
                    local card = sgs.Sanguosha:getCard(room:askForExchange(source, "sfofl_weizhu", 1,1, false, "@sfofl_weizhu_to:"..p:objectName(), false, ".|.|.|.|."):getSubcards():first())
                    room:setPlayerFlag(p, "-sfofl_weizhu")
					room:giveCard(source,p,card,"sfofl_weizhu",false)
                    room:addPlayerMark(p, "sfofl_weizhu_lun")
                    room:addPlayerMark(p, "&sfofl_weizhu+to+#"..source:objectName().."_lun")
                end
            end
        end
	end,
}
sfofl_weizhu = sgs.CreateViewAsSkill {
    name = "sfofl_weizhu",
    n = 999,
    view_filter = function(self, selected, to_select)
		return not to_select:isEquipped()
	end,
    view_as = function(self, cards)
        if #cards > 0 then
            local card = sfofl_weizhuCard:clone()
            for _, c in ipairs(cards) do
                card:addSubcard(c)
            end
            return card
        end
    end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_weizhu")
    end,
}

--[[
	技能名：责权
	相关武将：神卢植[官盗]
	技能描述：你可以将一张装备牌当未以此法使用过的锦囊牌对体力不小于你的其他角色使用。
	引用：sfofl_zequan
]] --

sfofl_zequanCard = sgs.CreateSkillCard{
	name = "sfofl_zequan",
	will_throw = false,
	handling_method = sgs.Card_MethodNone,
	filter = function(self, targets, to_select, player)
		local card = sgs.Sanguosha:cloneCard(self:getUserString(), sgs.Card_SuitToBeDecided, -1)
        card:addSubcards(self:getSubcards())
		card:setSkillName("sfofl_zequan")

		if card and card:targetFixed() then
			return false
		end
		local qtargets = sgs.PlayerList()
		for _, p in ipairs(targets) do
			qtargets:append(p)
		end
        card:deleteLater()
		return card:targetFilter(qtargets, to_select, player) and to_select:getHp() >= player:getHp()
	end,
	feasible = function(self, targets, player)
		local card = sgs.Sanguosha:cloneCard(self:getUserString(), sgs.Card_SuitToBeDecided, -1)
        card:addSubcards(self:getSubcards())
		card:setSkillName("sfofl_zequan")

		local qtargets = sgs.PlayerList()
		for _, p in ipairs(targets) do
			qtargets:append(p)
		end
		if card:canRecast() and #targets == 0 then
			return false
		end
        card:deleteLater()
		return card:targetsFeasible(qtargets, player)
	end,
	on_validate = function(self, card_use)
		local player = card_use.from
        local room = player:getRoom()
        room:addPlayerMark(player, "sfofl_zequan_guhuo_remove_"..self:getUserString())
		local card = sgs.Sanguosha:cloneCard(self:getUserString(), sgs.Card_SuitToBeDecided, -1)
        card:addSubcards(self:getSubcards())
		card:setSkillName("sfofl_zequan")
        card:deleteLater()
		return card
	end,
}
sfofl_zequan = sgs.CreateViewAsSkill{
    name = "sfofl_zequan",
    n = 1,
    view_filter = function(self, selected, to_select)
        return #selected < 1 and to_select:isKindOf("EquipCard")
    end,
    view_as = function(self, cards)
        if #cards > 0 then
            local cc = sfofl_zequanCard:clone()
            if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY  then
                local c = sgs.Self:getTag("sfofl_zequan"):toCard()
                if c==nil then return end
                if c then
                    cc:addSubcard(cards[1])
                    cc:setUserString(c:objectName())
                    return cc
                end
            else
                local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
                if pattern=="" then
                    local c = sgs.Self:getTag("sfofl_zequan"):toCard()
                    if c==nil then return end
                    if c then
                        cc:addSubcard(cards[1])
                        cc:setUserString(c:objectName())
                        return cc
                    end
                end
                cc:setUserString(pattern)
                return cc
            end
        end
    end,
    enabled_at_play = function(self, player)
        for _,p in sgs.list(patterns())do
			local dc = dummyCard(p)
			if dc and dc:isKindOf("TrickCard")
			and player:getMark("sfofl_zequan_guhuo_remove_"..p)<1 then
				dc:setSkillName("sfofl_zequan")
				if dc:isAvailable(player)
				then return true end
			end
		end
		return false
    end,
    enabled_at_response = function(self,player,pattern)
		if sgs.Sanguosha:getCurrentCardUseReason()~=sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE	then return false end
		local can = false
		for _,p in sgs.list(pattern:split("+"))do
			local dc = dummyCard(p)
			if dc and dc:isKindOf("TrickCard") and not dc:targetFixed()
			and player:getMark("sfofl_zequan_guhuo_remove_"..p)<1 then
				dc:setSkillName("sfofl_zequan")
				if not player:isLocked(dc)
				then return true end
			end
		end
		return false
	end,
}
sfofl_zequan:setGuhuoDialog("r")



sfofl_shenluzhi:addSkill(sfofl_zhengan)
sfofl_shenluzhi:addSkill(sfofl_zhengan_record)
sfofl_shenluzhi:addSkill(sfofl_zhengan_buff)
extension_e:insertRelatedSkills("sfofl_zhengan", "#sfofl_zhengan_record")
extension_e:insertRelatedSkills("sfofl_zhengan", "#sfofl_zhengan_buff")
if not sgs.Sanguosha:getSkill("sfofl_zhengan_basic&") then skills:append(sfofl_zhengan_basic) end
sfofl_shenluzhi:addSkill(sfofl_weizhu_distance)
sfofl_shenluzhi:addSkill(sfofl_weizhu)
extension_e:insertRelatedSkills("sfofl_weizhu", "#sfofl_weizhu_distance")
sfofl_shenluzhi:addSkill(sfofl_zequan)

sfofl_shenzhujun = sgs.General(extension_e, "sfofl_shenzhujun", "god", 4)
--[[
	技能名：撤击
	相关武将：神朱儁[官盗]
	技能描述：出牌阶段限一次，你可以重铸任意张牌，然后令一名其他角色重铸等量张手牌，若其重铸的牌包含：【杀】，你对其造成1点火焰伤害；【闪】，其对你指定的角色视为使用一张【杀】；【桃】，你与其各摸两张牌。
	引用：sfofl_cheji
]] --
sfofl_chejiCard = sgs.CreateSkillCard{
	name = "sfofl_cheji",
	target_fixed = false,
	will_throw = false,
    filter = function(self, targets, to_select)
		if (#targets ~= 0) then return false end
		return (to_select:objectName() ~= sgs.Self:objectName()) and not to_select:isKongcheng()
	end,
	on_use = function(self, room, source, targets)
		for _,id in sgs.qlist(self:getSubcards()) do
		    local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_RECAST, source:objectName())
            reason.m_skillName = self:objectName()
            room:moveCardTo(sgs.Sanguosha:getCard(id), source, nil, sgs.Player_DiscardPile, reason)
            source:broadcastSkillInvoke("@recast")
            local log = sgs.LogMessage()
            log.type = "#UseCard_Recast"
            log.from = source
            log.card_str = sgs.Sanguosha:getCard(id):toString()
            room:sendLog(log)
            source:drawCards(1, "recast")
        end
        local target = targets[1]
        local x = math.min(self:subcardsLength(), target:getHandcardNum())
        local remove = sgs.IntList()
        local to_obtain = dummyCard()
        for i = 1, x do--进行多次执行
            local id = room:askForCardChosen(target, target, "h", self:objectName(),
                true,
                sgs.Card_MethodRecast,
                remove,--将子卡表设置为不可选卡牌id表（保证每张卡只能被选择一次）
                false)
            remove:append(id)--将选择的id添加到虚拟卡的子卡表
            to_obtain:addSubcard(sgs.Sanguosha:getCard(id))
        end
        for _,id in sgs.qlist(to_obtain:getSubcards()) do
		    local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_RECAST, target:objectName())
            reason.m_skillName = self:objectName()
            room:moveCardTo(sgs.Sanguosha:getCard(id), target, nil, sgs.Player_DiscardPile, reason)
            target:broadcastSkillInvoke("@recast")
            local log = sgs.LogMessage()
            log.type = "#UseCard_Recast"
            log.from = target
            log.card_str = sgs.Sanguosha:getCard(id):toString()
            room:sendLog(log)
            target:drawCards(1, "recast")
        end
        local slash, jink, peach = false, false, false
        for _,id in sgs.qlist(remove)do
            local card = sgs.Sanguosha:getCard(id)
            if card:isKindOf("Slash") then
                slash = true
            end
            if card:isKindOf("Jink") then
                jink = true
            end
            if card:isKindOf("Peach") then
                peach = true
            end
        end
        if slash then
            room:damage(sgs.DamageStruct(self:objectName(), source, target, 1, sgs.DamageStruct_Fire))
        end
        if jink then
            local dc = dummyCard()
            dc:setSkillName("_"..self:objectName())
            local extra_targets = room:getCardTargets(target, dc)
            if not extra_targets:isEmpty() then 
                room:setPlayerFlag(target, "sfofl_cheji_target")
                local to = room:askForPlayerChosen(source, extra_targets, "sfofl_cheji", "@sfofl_cheji:"..target:objectName(), true)
                room:setPlayerFlag(target, "-sfofl_cheji_target")
                if target then
                    room:useCard(sgs.CardUseStruct(dc,target,to))
                end
            end
        end
        if peach then
            source:drawCards(2, self:objectName())
            target:drawCards(2, self:objectName())
        end
	end,
}
sfofl_cheji = sgs.CreateViewAsSkill {
    name = "sfofl_cheji",
    n = 999,
    view_filter = function(self, selected, to_select)
		return true
	end,
    view_as = function(self, cards)
        if #cards > 0 then
            local card = sfofl_chejiCard:clone()
            for _, c in ipairs(cards) do
                card:addSubcard(c)
            end
            return card
        end
    end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_cheji")
    end,
}


--[[
	技能名：急摧
	相关武将：神朱儁[官盗]
	技能描述：锁定技，你的回合内，当一名角色使用属性【杀】指定目标后，目标角色需将其X张牌置于武将牌上直到回合结束，此【杀】伤害+1（X为本回合进入过弃牌堆的牌数）。
	引用：sfofl_jicui
]] --
sfofl_jicui = sgs.CreateTriggerSkill{
	name = "sfofl_jicui",
	events = {sgs.TargetConfirmed},
    frequency = sgs.Skill_Compulsory,
	on_trigger = function(self,event,player,data,room)
		if event==sgs.TargetConfirmed then
			local use = data:toCardUse()
			if use.card:isKindOf("NatureSlash") and player:getPhase() ~= sgs.Player_NotActive then
                local x = player:getMark("sfofl_jicui-Clear")
                if x > 0 then
                    for _, p in sgs.qlist(use.to) do
                        if not p:isNude() then
                            local max = math.min(x, p:getCardCount())
                            for i = 1, max do--进行多次执行
                                local remove = sgs.IntList()
                                local id = room:askForCardChosen(p, p, "he", self:objectName(),
                                    true,--选择卡牌时手牌不可见
                                    sgs.Card_MethodNone,--设置为弃置类型
                                    remove,--将子卡表设置为不可选卡牌id表（保证每张卡只能被选择一次）
                                    false)
                                remove:append(id)--将选择的id添加到虚拟卡的子卡表
                                local views = sgs.SPlayerList()
                                views:append(p)
                                p:addToPile("sfofl_jicui", remove, false, views)
                            end
                        end
                    end
                    room:setCardFlag(use.card, self:objectName())
                end
			end
		end
		return false
	end
}
sfofl_jicui_buff = sgs.CreateTriggerSkill{
    name = "#sfofl_jicui_buff",
    events = {sgs.DamageCaused},
    priority = 1,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.DamageCaused then
            local damage = data:toDamage()
            if damage.to:isDead() then return false end
            if damage.card and damage.card:hasFlag("sfofl_jicui") then
                local damage = data:toDamage()
                damage.damage = damage.damage + 1
                local log = sgs.LogMessage()
                log.type = "#skill_add_damage"
                log.from = damage.from
                log.to:append(damage.to)
                log.arg  = "sfofl_jicui"
                log.arg2 = damage.damage
                player:getRoom():sendLog(log)
                data:setValue(damage)
            end
        end
    end,
    can_trigger = function(self, target)
        return target
    end,
}

sfofl_jicui_record = sgs.CreateTriggerSkill{
	name = "#sfofl_jicui_record",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.CardsMoveOneTime,},
	on_trigger = function(self, event, player, data, room)
		local current = room:getCurrent()
		if not current or current:isDead() or current:getPhase() == sgs.Player_NotActive or not current:hasSkill("sfofl_jicui") then return false end		
		local move = data:toMoveOneTime()			
		if (move.to_place == sgs.Player_DiscardPile) then
			room:addPlayerMark(current, "sfofl_jicui-Clear", move.card_ids:length())
		end		
	end
}

sfofl_jicui_return = sgs.CreateTriggerSkill{
    name = "#sfofl_jicui_return",
    events = {sgs.EventPhaseStart},
    frequency = sgs.Skill_NotFrequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if player:getPhase() ~= sgs.Player_NotActive then return false end
        for _,target in sgs.qlist(room:getAlivePlayers()) do
            if target:isAlive() and target:getPile("sfofl_jicui") and target:getPile("sfofl_jicui"):length() > 0 then
                --[[local reason2 = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_GOTCARD, target:objectName(), "sfofl_jicui", "")
                local move2 = sgs.CardsMoveStruct(target:getPile("sfofl_jicui"), target, sgs.Player_PlaceHand, reason2)
                room:moveCardsAtomic(move2, true)]]--
                local obtain = sgs.Sanguosha:cloneCard("jink", sgs.Card_SuitToBeDecided, -1)
                obtain:addSubcards(target:getPile("sfofl_jicui"))
                room:obtainCard(target, obtain, false)
                obtain:deleteLater()
            end
        end
    end,
    can_trigger = function(self, target)
        return target ~= nil
    end,
}

--[[
	技能名：溃降
	相关武将：神朱儁[官盗]
	技能描述：每名角色限一次，其他角色脱离濒死状态时，你可以对其造成1点伤害，若因此杀死该角色，你摸三张牌。
	引用：sfofl_kuixiang
]] --
sfofl_kuixiang = sgs.CreateTriggerSkill{
    name = "sfofl_kuixiang",
    events = {sgs.QuitDying, sgs.Death},
    frequency = sgs.Skill_NotFrequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.QuitDying then
            if not player:isAlive() then return false end
            local targets = room:findPlayersBySkillName(self:objectName())
            for _,p in sgs.qlist(targets) do
                if p:getMark("sfofl_kuixiang"..player:objectName()) == 0 and p:objectName() ~= player:objectName() then
                    room:setPlayerFlag(player, "sfofl_kuixiangtarget")
                    local prompt = string.format("dying:%s", player:getGeneralName())
                    if room:askForSkillInvoke(p, self:objectName(), sgs.QVariant(prompt)) then
                        room:addPlayerMark(p, "sfofl_kuixiang"..player:objectName())
                        room:addPlayerMark(player, "&sfofl_kuixiang+to+#"..p:objectName())
                        room:damage(sgs.DamageStruct("sfofl_kuixiang", p, player, 1, sgs.DamageStruct_Normal))
                    end
                    room:setPlayerFlag(player, "-sfofl_kuixiangtarget")
                end
                if not player:isAlive() then return false end
            end
        elseif player:hasSkill(self:objectName()) then
            local death = data:toDeath()
            if death.damage and death.damage.reason == "sfofl_kuixiang" and death.damage.from and death.damage.from and death.damage.from:objectName() == player:objectName() then
                player:drawCards(3, self:objectName())
            end
        end
    end,
    can_trigger = function(self, target)
        return target 
    end,
}


sfofl_shenzhujun:addSkill(sfofl_cheji)
sfofl_shenzhujun:addSkill(sfofl_jicui)
sfofl_shenzhujun:addSkill(sfofl_jicui_buff)
sfofl_shenzhujun:addSkill(sfofl_jicui_record)
sfofl_shenzhujun:addSkill(sfofl_jicui_return)
extension_e:insertRelatedSkills("sfofl_jicui", "#sfofl_jicui_buff")
extension_e:insertRelatedSkills("sfofl_jicui", "#sfofl_jicui_record")
extension_e:insertRelatedSkills("sfofl_jicui", "#sfofl_jicui_return")
sfofl_shenzhujun:addSkill(sfofl_kuixiang)


sfofl_2_lijue = sgs.General(extension_e, "sfofl_2_lijue", "qun", 6)
--[[
	技能名：摧袭
	相关武将：李傕[官盗]
	技能描述：出牌阶段限两次，你可以弃置任意张手牌，选择两名体力值小于你的角色，你与这些角色依次亮出牌堆顶的一张牌，点数不为最大的角色受到2点伤害。你可以令你的点数+X（X为你弃置的手牌数）。
	引用：sfofl_cuixi
]] --

sfofl_cuixiCard = sgs.CreateSkillCard{
	name = "sfofl_cuixi",
	target_fixed = false,
	will_throw = true,
	filter = function(self, targets, to_select, player)
		return #targets < 2 and to_select:getHp() < player:getHp()
	end,
    feasible = function(self, targets, player)
		return #targets == 2
	end,
	on_use = function(self, room, player, targets)
        -- Helper function to draw, move, and throw a card for a player
        local function draw_and_throw(p)
            local ids = room:getNCards(1, false)
            local move = sgs.CardsMoveStruct()
            move.card_ids = ids
            move.to = nil
            move.to_place = sgs.Player_PlaceTable
            move.reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_TURNOVER, p:objectName(), self:objectName(), nil)
            room:moveCardsAtomic(move, true)
            local card = sgs.Sanguosha:getCard(ids:first())
            room:throwCard(card, nil)
            return card:getNumber()
        end

        local numbers = {}
        -- First, for the player
        numbers[1] = draw_and_throw(player)
        if self:subcardsLength() > 0 and player:askForSkillInvoke(self:objectName()) then
            numbers[1] = numbers[1] + self:subcardsLength()
        end
        -- Then, for each target
        for i, p in ipairs(targets) do
            numbers[i + 1] = draw_and_throw(p)
        end

        -- Find the max number
        local max = math.max(table.unpack(numbers))

        -- Deal damage if a player's number is less than max
        local all_players = {player, table.unpack(targets)}
        for i, num in ipairs(numbers) do
            if num < max then
                local damage = sgs.DamageStruct(self:objectName(), nil, all_players[i], 2)
                room:damage(damage)
            end
        end
    end
}

sfofl_cuixi = sgs.CreateViewAsSkill{
	name = "sfofl_cuixi",
	n = 99,
    view_filter = function(self, selected, to_select)
		return not to_select:isEquipped()
	end,
	view_as = function(self, cards)
		if #cards > 0 then
            local card = sfofl_cuixiCard:clone()
            for _, c in ipairs(cards) do
                card:addSubcard(c)
            end
            return card
        end
	end,
	enabled_at_play = function(self, player)
		return player:usedTimes("#sfofl_cuixi") < 2
	end, 
}

--[[
	技能名：聚军
	相关武将：李傕[官盗]
	技能描述：限定技，出牌阶段，你可以将手牌和体力补至体力上限，若如此做，你不能回复体力直到你杀死一名角色。
	引用：sfofl_jujun
]] --
sfofl_jujunCard = sgs.CreateSkillCard{
	name = "sfofl_jujun",
	target_fixed = true,
	will_throw = true,
	on_use = function(self, room, player, targets)
        room:doSuperLightbox(player,self:objectName())
        room:removePlayerMark(player, "@sfofl_jujun")
        player:drawCards(player:getMaxHp()-player:getHandcardNum(), self:objectName())
        local recover = sgs.RecoverStruct()
        recover.who = player
        recover.recover = player:getLostHp()
        room:recover(player, recover, true)
        room:setPlayerMark(player, "&sfofl_jujun+no_recover", 1)
    end
}

sfofl_jujunVS = sgs.CreateViewAsSkill{
	name = "sfofl_jujun",
	n = 0,
	view_as = function(self, cards)
        return sfofl_jujunCard:clone()
	end,
	enabled_at_play = function(self, player)
		return player:getMark("@sfofl_jujun") > 0 and (player:getHandcardNum() < player:getMaxHp() or player:isWounded())
	end, 
}   

sfofl_jujun = sgs.CreateTriggerSkill{
	name = "sfofl_jujun",
    frequency = sgs.Skill_Limited,
    limit_mark = "@sfofl_jujun",
	view_as_skill = sfofl_jujunVS,
	events = {sgs.Death,sgs.PreHpRecover},
	can_trigger = function(self,target)
		return target and target:isAlive()
	end,
	on_trigger = function(self,event,player,data,room)
		if event == sgs.Death then
            local death = data:toDeath()
            if not death.damage or not death.damage.from or death.damage.from ~= player then return end 
			if player:getMark("&sfofl_jujun+no_recover")>0 then
                room:setPlayerMark(player, "&sfofl_jujun+no_recover", 0)
            end
		elseif event == sgs.PreHpRecover then
			return player:getMark("&sfofl_jujun+no_recover")>0
		end
	end,
}

sfofl_2_lijue:addSkill(sfofl_cuixi)
sfofl_2_lijue:addSkill(sfofl_jujun)

sfofl_guosi = sgs.General(extension_e, "sfofl_guosi", "qun", 4)
--[[
	技能名：伺袭
	相关武将：郭汜[官盗]
	技能描述：出牌阶段限两次，你可以与一名角色拼点：若你赢，你可以视为使用一张刺【杀】；若你没赢，其计算与你的距离+1直到你下回合开始。当一次拼点结算后，你可以获得所有拼点牌。
	引用：sfofl_sixi
]] --
sfofl_sixiCard = sgs.CreateSkillCard{
	name = "sfofl_sixi",
	target_fixed = false,
	filter = function(self, targets, to_select, player)
		return #targets < 1 and player:canPindian(to_select)
	end,
	on_effect = function(self, effect)
        local room = effect.from:getRoom()
        local success = effect.from:pindian(effect.to, "sfofl_sixi", nil)
		if success then
            room:askForUseCard(effect.from, "@@sfofl_sixi", "@sfofl_sixi", -1, sgs.Card_MethodUse)
		else
			room:addPlayerMark(effect.to, "&sfofl_sixi+to+#"..effect.from:objectName())
		end
    end
}

sfofl_sixiVS = sgs.CreateViewAsSkill{
	name = "sfofl_sixi",
	n = 0,
	view_as = function(self, cards)
        if sgs.Sanguosha:getCurrentCardUsePattern() == "@@sfofl_sixi" then
            local sc = sgs.Sanguosha:cloneCard("yj_stabs_slash")
		    sc:setSkillName("sfofl_sixi")
            return sc
        end
        return sfofl_sixiCard:clone()
	end,
	enabled_at_play = function(self, player)
		return player:usedTimes("#sfofl_sixi") < 2
	end,
    enabled_at_response = function(self, player, pattern)
		return string.startsWith(pattern, "@@sfofl_sixi")
	end
}
sfofl_sixi = sgs.CreateTriggerSkill{
	name = "sfofl_sixi",
	events = {sgs.Pindian, sgs.EventPhaseStart},
	view_as_skill = sfofl_sixiVS,
	on_trigger = function(self, event, player, data, room)
        if event == sgs.Pindian then
            local pindian = data:toPindian()
            for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                local to_obatin = dummyCard()
                if room:getCardPlace(pindian.from_card:getEffectiveId()) == sgs.Player_PlaceTable then
                    to_obatin:addSubcard(pindian.from_card)
                end
                if room:getCardPlace(pindian.to_card:getEffectiveId()) == sgs.Player_PlaceTable then
                    to_obatin:addSubcard(pindian.to_card)
                end
                if to_obatin:subcardsLength() > 0 and room:askForSkillInvoke(p, self:objectName(), data) then
                    room:obtainCard(p, to_obatin)
                    break
                end
            end
        else
            if player:getPhase() == sgs.Player_Start and player:hasSkill(self:objectName()) then
                for _, p in sgs.qlist(room:getOtherPlayers(player)) do
                    if p:getMark("&sfofl_sixi+to+#"..player:objectName()) > 0 then
                        room:setPlayerMark(p, "&sfofl_sixi+to+#"..player:objectName(), 0)
                    end
                end
            end
        end
        return false
	end,
    can_trigger = function(self, target)
        return target and target:isAlive()
    end,
}
sfofl_sixi_distance = sgs.CreateDistanceSkill {
	name = "#sfofl_sixi_distance",
	correct_func = function(self, from, to)
        if from:getMark("&sfofl_sixi+to+#"..to:objectName()) > 0 then return from:getMark("&sfofl_sixi+to+#"..to:objectName()) end
        return 0
	end
}


--[[
	技能名：掠盗
	相关武将：郭汜[官盗]
	技能描述：当你使用【杀】对一名角色造成伤害时，你可以获得其一张牌并令其减1点体力上限，其获得“避凶”。
	引用：sfofl_lvedao
]] --
sfofl_lvedao = sgs.CreateTriggerSkill {
	name = "sfofl_lvedao",
	frequency = sgs.Skill_NotFrequent,
	events = { sgs.DamageCaused },
    waked_skills = "sfofl_bixiong",
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()
        if damage.card and damage.card:isKindOf("Slash") then
            if not damage.to:isNude() and room:askForSkillInvoke(player, self:objectName(), data) then
                local id = room:askForCardChosen(player, damage.to, "he", self:objectName())
                local card = sgs.Sanguosha:getCard(id)
                room:obtainCard(player, card, false)
                if not damage.to:hasSkill("sfofl_bixiong") then
                    room:addPlayerMark(damage.to, "&sfofl_lvedao")
                    room:loseMaxHp(damage.to, 1, self:objectName())
                    room:acquireSkill(damage.to, "sfofl_bixiong", true, true, true)
                end
            end
        end
		return false
	end,
}


--[[
	技能名：避凶
	相关武将：郭汜[官盗]
	技能描述：限定技，出牌阶段，你可以弃置两张手牌，加1点体力上限。
	引用：sfofl_bixiong
]] --
sfofl_bixiongCard = sgs.CreateSkillCard{
	name = "sfofl_bixiong",
	target_fixed = true,
	will_throw = true,
	on_use = function(self, room, player, targets)
        room:gainMaxHp(player, 1, self:objectName())
        room:handleAcquireDetachSkills(player, "-sfofl_bixiong", true)
        room:setPlayerMark(player, "&sfofl_lvedao", 0)
    end
}

sfofl_bixiong = sgs.CreateViewAsSkill{
	name = "sfofl_bixiong&",
	n = 2,
	view_filter = function(self, selected, to_select)
		return not to_select:isEquipped()
	end, 
	view_as = function(self, cards)
	if #cards == 2 then 
		local card = sfofl_bixiongCard:clone()
		card:addSubcard(cards[1])
		card:addSubcard(cards[2])
		card:setSkillName(self:objectName())
		return card
		end
	end,
	enabled_at_play = function(self, player)
		return true
	end, 
}

sfofl_guosi:addSkill(sfofl_sixi)
sfofl_guosi:addSkill(sfofl_sixi_distance)
extension_e:insertRelatedSkills("sfofl_sixi", "#sfofl_sixi_distance")
sfofl_guosi:addSkill(sfofl_lvedao)
if not sgs.Sanguosha:getSkill("sfofl_bixiong&") then skills:append(sfofl_bixiong) end


sfofl_fanchou = sgs.General(extension_e, "sfofl_fanchou", "qun", 4)
--[[
	技能名：兴威
	相关武将：樊稠[官盗]
	技能描述：当你获得红色牌后，你可以展示之并摸一张牌；准备阶段或当你受到伤害后，你可以获得弃牌堆中的一张红色牌。
	引用：sfofl_xingwei
]] --

sfofl_xingwei = sgs.CreateTriggerSkill{
    name = "sfofl_xingwei",
    events = {sgs.CardsMoveOneTime, sgs.EventPhaseStart, sgs.Damaged},
    on_trigger = function(self, event, player, data, room)
        if event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            if not room:getTag("FirstRound"):toBool() and player:getPhase() ~= sgs.Player_Draw and move.to and move.to:objectName() == player:objectName() then
                local ids = sgs.IntList()
                for _,id in sgs.qlist(move.card_ids) do
                    if room:getCardOwner(id) == player and room:getCardPlace(id) == sgs.Player_PlaceHand and sgs.Sanguosha:getCard(id):isRed() then
                        ids:append(id)
                    end
                end
                if ids:isEmpty() then return false end
                if room:askForSkillInvoke(player, self:objectName()) then
                    room:showCard(player, ids)
                    player:drawCards(1, self:objectName())
                end
            end
        elseif ((event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Start) or (event == sgs.Damaged)) then
            if room:askForSkillInvoke(player, self:objectName()) then
                local ids = sgs.IntList()
                for _, id in sgs.qlist(room:getDiscardPile()) do
                    if sgs.Sanguosha:getCard(id):isRed() then
                        ids:append(id)
                    end
                end
                if not ids:isEmpty() then
                    room:fillAG(ids,player)
                    local id = room:askForAG(player, ids, true, self:objectName())
                    room:clearAG(player)
                    if id ~= -1 then
                        room:obtainCard(player, id, false)
                    end
                end
            end
        end
        return false
    end
}


--[[
	技能名：浅目
	相关武将：樊稠[官盗]
	技能描述：每回合各限一次，你可以展示并将一张<font color='red'>♦</font>牌当基本牌、<font color='red'>♥</font>牌当锦囊牌使用或打出。
	引用：sfofl_qianmu
]] --
sfofl_qianmuCard = sgs.CreateSkillCard{
    name = "sfofl_qianmu",
    will_throw = false,
    filter = function(self, targets, to_select, from)
        local pattern = self:getUserString()
		local dc = dummyCard(pattern:split("+")[1])
		if dc:targetFixed() then return false end
		dc:setSkillName("sfofl_qianmu")
		local plist = sgs.PlayerList()
		for i = 1, #targets do plist:append(targets[i]) end
		return dc:targetFilter(plist,to_select,from)
	end,
    feasible = function(self,targets,from)
		local pattern = self:getUserString()
		local dc = dummyCard(pattern:split("+")[1])
        dc:setSkillName("sfofl_qianmu")
        if card and card:canRecast() and #targets == 0 then
			return false
		end
		local plist = sgs.PlayerList()
		for i = 1, #targets do plist:append(targets[i]) end
		return dc:targetFixed() or dc:targetsFeasible(plist, from)
	end,
	on_validate = function(self, card_use)
		local player = card_use.from
        local room = player:getRoom()

        local pattern = self:getUserString()
        local use_card = sgs.Sanguosha:getCard(self:getSubcards():first())
        local card = sgs.Sanguosha:cloneCard(pattern, use_card:getSuit(), use_card:getNumber())
		card:setSkillName(self:objectName())
        card:addSubcards(self:getSubcards())
        for _,p in sgs.list(patterns())do
			local dc = dummyCard(p)
			if dc and player:getMark("sfofl_qianmu_guhuo_remove_"..p.."-Clear")<1 then
                if ((card:isKindOf("BasicCard") and dc:isKindOf("BasicCard")) or (card:isKindOf("TrickCard") and dc:isKindOf("TrickCard"))) then
                    room:addPlayerMark(player, "sfofl_qianmu_guhuo_remove_"..p.."-Clear")
                end
			end
		end

        if card:isKindOf("BasicCard") then
            room:setPlayerMark(player, "sfofl_qianmu_basic-Clear", 1)
        elseif card:isKindOf("TrickCard") then
            room:setPlayerMark(player, "sfofl_qianmu_trick-Clear", 1)
        end
        room:showCard(player, self:getSubcards())
        for _, mark in sgs.list(player:getMarkNames()) do
            if (string.startsWith(mark, "&sfofl_qianmu+") and player:getMark(mark) > 0) then
                room:setPlayerMark(player, mark, 0)
            end
        end
        local mark = "&sfofl_qianmu+:"
        if player:getMark("sfofl_qianmu_basic-Clear") > 0 then
            mark = mark .. "+basic"
        end
        if player:getMark("sfofl_qianmu_trick-Clear") > 0 then
            mark = mark .. "+trick"
        end
        mark = mark .. "-Clear"
        room:setPlayerMark(player, mark, 1)
		return card
	end,
    on_validate_in_response = function(self, player)
        local room = player:getRoom()

        local pattern = self:getUserString()
		if pattern == "normal_slash" then pattern = "slash" end
        if pattern == "Slash" then
            local all = {"slash","fire_slash","thunder_slash"} 
            local items = {}
            for _,item in ipairs(all) do
                local mark = string.format("sfofl_qianmu_guhuo_remove_%s-Clear", item)
                if player:getMark(mark) == 0 then
                    table.insert(items, item)
                end
            end
            pattern = room:askForChoice(player, "sfofl_qianmu_Slash", table.concat(items, "+"))
        end
        if pattern == "Jink" then pattern = "jink" end
        if pattern == "peach+analeptic" then 
            local all = {"peach","analeptic"} 
            local items = {}
            for _,item in ipairs(all) do
                local mark = string.format("sfofl_qianmu_guhuo_remove_%s-Clear", item)
                if player:getMark(mark) == 0 then
                    table.insert(items, item)
                end
            end
            pattern = room:askForChoice(player, "sfofl_qianmu_saveself", table.concat(items, "+"))
        end

        local use_card = sgs.Sanguosha:getCard(self:getSubcards():first())
		local card = sgs.Sanguosha:cloneCard(pattern, use_card:getSuit(), use_card:getNumber())
		card:setSkillName(self:objectName())
        card:addSubcards(self:getSubcards())

        for _,p in sgs.list(patterns())do
			local dc = dummyCard(p)
			if dc and player:getMark("sfofl_qianmu_guhuo_remove_"..p.."-Clear")<1 then
                if ((card:isKindOf("BasicCard") and dc:isKindOf("BasicCard")) or (card:isKindOf("TrickCard") and dc:isKindOf("TrickCard"))) then
                    room:addPlayerMark(player, "sfofl_qianmu_guhuo_remove_"..p.."-Clear")
                end
			end
		end

        if card:isKindOf("BasicCard") then
            room:setPlayerMark(player, "sfofl_qianmu_basic-Clear", 1)
        elseif card:isKindOf("TrickCard") then
            room:setPlayerMark(player, "sfofl_qianmu_trick-Clear", 1)
        end
        room:showCard(player, self:getSubcards())
         for _, mark in sgs.list(player:getMarkNames()) do
            if (string.startsWith(mark, "&sfofl_qianmu+") and player:getMark(mark) > 0) then
                room:setPlayerMark(player, mark, 0)
            end
        end
        local mark = "&sfofl_qianmu+:"
        if player:getMark("sfofl_qianmu_basic-Clear") > 0 then
            mark = mark .. "+basic"
        end
        if player:getMark("sfofl_qianmu_trick-Clear") > 0 then
            mark = mark .. "+trick"
        end
        mark = mark .. "-Clear"
        room:setPlayerMark(player, mark, 1)

        return card
    end
}

sfofl_qianmu = sgs.CreateOneCardViewAsSkill{
    name = "sfofl_qianmu",
    guhuo_type = "lr",
    response_or_use = true,
    view_filter = function(self, card)
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
            local c = sgs.Self:getTag("sfofl_qianmu"):toCard()
            if c and c:isKindOf("BasicCard") then
                return card:getSuit() == sgs.Card_Diamond
            end
            if c and c:isKindOf("TrickCard") then
                return card:getSuit() == sgs.Card_Heart
            end
        else
            local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
            for _,p in sgs.list(pattern:split("+"))do
                local dc = dummyCard(p)
                if dc and dc:isKindOf("BasicCard") then
                    return card:getSuit() == sgs.Card_Diamond
                end
                if dc and dc:isKindOf("TrickCard") then
                    return card:getSuit() == sgs.Card_Heart
                end
            end
        end
        return false
    end,
    view_as = function(self, card)
        local cc = sfofl_qianmuCard:clone()
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
            local c = sgs.Self:getTag("sfofl_qianmu"):toCard()
            cc:setUserString(c:objectName())
            cc:addSubcard(card:getEffectiveId())
            return cc
        else
            local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
            if pattern == "slash" then pattern = "Slash" end
            cc:setUserString(pattern)
            cc:addSubcard(card:getEffectiveId())
            return cc
        end
    end,
    enabled_at_play = function(self, player)
        local can = false
		for _,p in sgs.list(patterns())do
			local dc = dummyCard(p)
			if dc and player:getMark("sfofl_qianmu_guhuo_remove_"..p.."-Clear")<1 then
                if (dc:isKindOf("BasicCard") and player:getMark("sfofl_qianmu_basic-Clear") == 0) or 
                (dc:isKindOf("TrickCard") and player:getMark("sfofl_qianmu_trick-Clear") == 0) then
                    dc:setSkillName("sfofl_qianmu")
                    if not player:isLocked(dc)
                    then can = true break end
                end
			end
		end
		if can==false then return false end
        return true
    end,
    enabled_at_response = function(self, player, pattern)
        local can = false
		for _,p in sgs.list(pattern:split("+"))do
			local dc = dummyCard(p)
			if dc and player:getMark("sfofl_qianmu_guhuo_remove_"..p.."-Clear")<1 then
                if (dc:isKindOf("BasicCard") and player:getMark("sfofl_qianmu_basic-Clear") == 0) or 
                (dc:isKindOf("TrickCard") and player:getMark("sfofl_qianmu_trick-Clear") == 0) then
                    dc:setSkillName("sfofl_qianmu")
                    if not player:isLocked(dc)
                    then can = true break end
                end
			end
		end
		if can==false then return false end
        return true
    end
}

sfofl_fanchou:addSkill(sfofl_xingwei)
sfofl_fanchou:addSkill(sfofl_qianmu)

sfofl_zhangji = sgs.General(extension_e, "sfofl_zhangji", "qun", 4)
--[[
	技能名：肆掠
	相关武将：张济[官盗]
	技能描述：摸牌阶段开始时，你可以改为获得任意名角色合计至多两张牌，然后将等量的牌置于武将牌上，称为“掠”。
	引用：sfofl_silve
]] --

sfofl_silve = sgs.CreateTriggerSkill {
	name = "sfofl_silve",
	frequency = sgs.Skill_NotFrequent,
	events = { sgs.EventPhaseStart },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if player:getPhase() == sgs.Player_Draw then
            local splayers = sgs.SPlayerList()
            for _,p in sgs.list(room:getAlivePlayers())do
                if not p:isNude() then
                    splayers:append(p)
                end
            end
            if not splayers:isEmpty() then
                local targets = room:askForPlayersChosen(player,splayers,self:objectName(),0,2,"@sfofl_silve", true, true)
                if targets and targets:length() > 0 then
                    local x = 0
                    for _,to in sgs.qlist(targets) do
                        local card_id = room:askForCardChosen(player, to, "he", self:objectName())
                        room:obtainCard(player, card_id)
                        x = x + 1
                    end
                    if targets:length() == 1 then
                        local card_id = room:askForCardChosen(player, targets:first(), "he", self:objectName(), false, sgs.Card_MethodNone, sgs.IntList(), true)
                        if card_id ~= -1 then
                            room:obtainCard(player, card_id)
                            x = x + 1
                        end
                    end
                    local card = room:askForExchange(player, self:objectName(), x, x, true, "@sfofl_silve_put:"..x, false)
                    player:addToPile("sfofl_silve_lve", card:getSubcards(), true)
                    return true
                end
            end
        end
		return false
	end,
}

--[[
	技能名：随变
	相关武将：张济[官盗]
	技能描述：一名角色使用与“掠”花色相同的牌时，你可以选择一项：1.移去所有此花色的“掠”，对其造成1点伤害；2.与其各摸一张牌；3.失去1点体力令此牌无效，然后将此牌交给一名角色并摸一张牌。
	引用：sfofl_suibian
]] --

sfofl_suibian = sgs.CreateTriggerSkill{
	name = "sfofl_suibian",
    frequency = sgs.Skill_Compulsory,
	events = {sgs.CardUsed},
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
		if event ==sgs.CardUsed then 
			local use = data:toCardUse()
			if use.card and not use.card:isKindOf("SkillCard") and use.card:hasSuit() then
                for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    local dummy = dummyCard()
                    if not p:getPile("sfofl_silve_lve"):isEmpty() then
                        for _,id in sgs.qlist(p:getPile("sfofl_silve_lve")) do
                            if sgs.Sanguosha:getCard(id):getSuit() == use.card:getSuit() then
                                dummy:addSubcard(sgs.Sanguosha:getCard(id))
                            end
                        end
                    end
                    if dummy:subcardsLength() > 0 then
                        local choicelist = {}
                        table.insert(choicelist, "damage="..player:objectName())
                        table.insert(choicelist, "draw="..player:objectName())
                        table.insert(choicelist, "nullified="..use.card:objectName())
                        local choice = room:askForChoice(p, self:objectName(), table.concat(choicelist, "+"), data)
                        if string.startsWith(choice, "damage") then
                            local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_REMOVE_FROM_PILE, "", "sfofl_suibian", "");
						    room:throwCard(dummy, reason, nil)
                            room:damage(sgs.DamageStruct(self:objectName(), p, player))
                        end
                        if string.startsWith(choice, "draw") then
                            player:drawCards(1)
                            p:drawCards(1)
                        end
                        if string.startsWith(choice, "nullified") then
                            local list = use.nullified_list
                            table.insert(list, "_ALL_TARGETS")
                            use.nullified_list = list
                            data:setValue(use)
                            room:loseHp(p, 1, true, player, self:objectName())
                            if p:isAlive() then
                                local to_obtain = sgs.IntList()
			                    if room:getCardPlace(use.card:getEffectiveId()) == sgs.Player_PlaceTable then
                                    room:setPlayerMark(p, "sfofl_suibian",use.card:getEffectiveId())
                                    local target = room:askForPlayerChosen(p, room:getAlivePlayers(), self:objectName(), "@sfofl_suibian:"..use.card:objectName())
                                    room:giveCard(p, target, use.card, self:objectName(), true)
                                    p:drawCards(1)
                                    room:setPlayerMark(p, "sfofl_suibian",0)
                                end
                            end
                        end
                    end
                end
			end
		end
	end,
		can_trigger = function(self, target)
		return target
	end,
}

sfofl_zhangji:addSkill(sfofl_silve)
sfofl_zhangji:addSkill(sfofl_suibian)


sfofl_wangyun = sgs.General(extension_e, "sfofl_wangyun", "qun", 3)
--[[
	技能名：连计
	相关武将：王允[官盗]
	技能描述：出牌阶段限一次，你可以令一名其他角色摸一张牌，然后令其视为使用一张你选择的伤害牌。
	引用：sfofl_lianji
]] --

sfofl_lianjiDamage = sgs.CreateViewAsSkill{
	name = "sfofl_lianjiDamage&",
	view_as = function(self,cards)
		local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
		if pattern=="@@sfofl_lianji!" then
			pattern = sgs.Self:getMark("sfofl_lianji_id-PlayClear") - 1
			pattern = sgs.Sanguosha:getCard(pattern)
			pattern = sgs.Sanguosha:cloneCard(pattern:objectName())
			pattern:setSkillName("sfofl_lianji")
			return pattern
		end
		return false
	end,
	enabled_at_response = function(self,player,pattern)
	   	return pattern=="@@sfofl_lianji!"
	end,
	enabled_at_play = function(self,player)
		return false
	end,
}
sfofl_lianji_buff = sgs.CreateTriggerSkill{
    name = "#sfofl_lianji_buff",
	events = {sgs.GameStart,sgs.EventAcquireSkill},
	on_trigger = function(self, event, player, data)
	    local room = player:getRoom()
		--游戏开始时或获得技能时，每个人发一个技能
		for _, p in sgs.qlist(room:getAllPlayers()) do
			if not p:hasSkill("sfofl_lianjiDamage",true) then
				room:attachSkillToPlayer(p,"sfofl_lianjiDamage")
			end
		end
	end,
}
sfofl_lianjiCard = sgs.CreateSkillCard {
	name = "sfofl_lianji",
	target_fixed = false,
    will_throw = false,
	filter = function(self, targets, to_select)
		if #targets == 0 then
			return to_select:objectName() ~= sgs.Self:objectName()
		end
        return false
	end ,
	on_use = function(self, room, source, targets)
        local target = targets[1]
        target:drawCards(1, self:objectName())
        local bans = {}
        local cardNames = {}
        local ids = sgs.IntList()
        local bp = sgs.Sanguosha:getBanPackages()
		if bp~=bans then
			bans = bp
			cardNames = {}
			for id=0,sgs.Sanguosha:getCardCount()-1 do
				local c = sgs.Sanguosha:getEngineCard(id)
				if string.sub(c:objectName(),1,1)=="_" or table.contains(bp,c:getPackage())
				or table.contains(cardNames,c:objectName()) then continue end
                local cc = sgs.Sanguosha:cloneCard(c:objectName())
                cc:setSkillName("sfofl_lianji")
                cc:deleteLater()
				if c:isDamageCard() and cc:isAvailable(target) then table.insert(cardNames,c:objectName()) ids:append(id) end
			end
		end
        if(ids:length()>0) then
            room:fillAG(ids,source)
            local id = room:askForAG(source,ids,false,"sfofl_lianji","@sfofl_lianji-damagecard:"..target:getLogName())
            room:clearAG(source)
            if id < 0 then return false end
            room:setPlayerMark(target, "sfofl_lianji_id-PlayClear", id + 1);
            room:askForUseCard(target,"@@sfofl_lianji!","@sfofl_lianji:"..sgs.Sanguosha:getEngineCard(id):objectName())
        end
	end
}
sfofl_lianji = sgs.CreateViewAsSkill {
	name = "sfofl_lianji",
	n = 0,
	view_filter = function(self, selected, to_select)
		return false
	end,
	view_as = function(self, cards)
		if #cards == 0 then
			return sfofl_lianjiCard:clone()
		end
	end,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_lianji")
	end,
}



--[[
	技能名：谋逞
	相关武将：王允[官盗]
	技能描述：觉醒技，一名角色造成伤害后，若本局游戏“连计”造成过至少3点伤害，你增加1点体力上限并失去技能连计，然后回复1点体力并获得“矜功”。
	引用：sfofl_moucheng
]] --

sfofl_moucheng = sgs.CreateTriggerSkill{
	name = "sfofl_moucheng" ,
	frequency = sgs.Skill_Wake ,
	events = {sgs.Damage} ,
	waked_skills = "sfofl_jingongz",
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()
        if damage.card and table.contains(damage.card:getSkillNames(), "sfofl_lianji") then
            for _,owner in sgs.list(room:findPlayersBySkillName(self:objectName()))do
                if owner:getMark(self:objectName()) == 0 then
                    room:addPlayerMark(owner, "sfofl_lianji_damage")
                    if owner:getMark("sfofl_lianji_damage") >= 3 or owner:canWake(self:objectName()) then
                        room:addPlayerMark(owner, self:objectName())
                        if room:changeMaxHpForAwakenSkill(owner, 1, self:objectName()) then
                            room:handleAcquireDetachSkills(owner, "-sfofl_lianji")
                            local recover = sgs.RecoverStruct()
                            recover.who = owner
                            recover.recover = 1
                            room:recover(owner, recover)
                            room:handleAcquireDetachSkills(owner, "sfofl_jingongz")
                        end
                    end
                end
            end
        end
		return false
	end ,
	can_trigger = function(self, target)
		return target and target:isAlive()
	end
}



--[[
	技能名：矜功
	相关武将：王允[官盗]
	技能描述：出牌阶段限一次，你可以将一张杀或装备牌当锦囊牌使用，本回合结束时，若你本回合未造成过伤害，你失去1点体力。
	引用：sfofl_jingongz
]] --
sfofl_jingongzCard = sgs.CreateSkillCard{
    name = "sfofl_jingongz",
    will_throw = false,
    filter = function(self, targets, to_select, from)
        local pattern = self:getUserString()
		local dc = dummyCard(pattern:split("+")[1])
		if dc:targetFixed() then return false end
		dc:setSkillName("sfofl_jingongz")
		local plist = sgs.PlayerList()
		for i = 1, #targets do plist:append(targets[i]) end
		return dc:targetFilter(plist,to_select,from)
	end,
    feasible = function(self,targets,from)
		local pattern = self:getUserString()
		local dc = dummyCard(pattern:split("+")[1])
        dc:setSkillName("sfofl_jingongz")
        if card and card:canRecast() and #targets == 0 then
			return false
		end
		local plist = sgs.PlayerList()
		for i = 1, #targets do plist:append(targets[i]) end
		return dc:targetFixed() or dc:targetsFeasible(plist, from)
	end,
	on_validate = function(self, card_use)
		local player = card_use.from
        local room = player:getRoom()

        local pattern = self:getUserString()
        local card = sgs.Sanguosha:cloneCard(pattern, sgs.Card_SuitToBeDecided, -1)
		card:setSkillName(self:objectName())
        card:addSubcards(self:getSubcards())
        room:addPlayerMark(player, "&sfofl_jingongz-Clear")
        room:addPlayerMark(player, "sfofl_jingongz-Clear")
        room:addPlayerMark(player, "sfofl_jingongz-PlayClear")
		return card
	end,
}

sfofl_jingongzVS = sgs.CreateOneCardViewAsSkill{
    name = "sfofl_jingongz",
    view_filter = function(self, card)
        return card:isKindOf("Slash") or card:isKindOf("EquipCard")
    end,
    view_as = function(self, card)
        local cc = sfofl_jingongzCard:clone()
        local dc = sgs.Self:getTag("sfofl_jingongz"):toCard()
        cc:setUserString(dc:objectName())
        cc:addSubcard(card:getEffectiveId())
        return cc
    end,
    enabled_at_play = function(self, player)
        return player:getMark("sfofl_jingongz-PlayClear") == 0
    end,
}
sfofl_jingongz = sgs.CreateTriggerSkill{
	name = "sfofl_jingongz",
	view_as_skill = sfofl_jingongzVS,
    guhuo_type = "!r",
	events = {sgs.EventPhaseChanging, sgs.CardFinished},
	on_trigger = function(self, event, player, data, room)
        if event == sgs.CardFinished then
            local use = data:toCardUse()
            if use.card and not use.card:isKindOf("SkillCard")  then
                if use.card:hasFlag("DamageDone") and player:hasSkill(self:objectName()) then
                    room:setPlayerMark(player, "sfofl_jingongz-Clear", 0)
                end
            end
        elseif event==sgs.EventPhaseChanging and data:toPhaseChange().to==sgs.Player_NotActive then
            if player:getMark("sfofl_jingongz-Clear") > 0 and player:getPhase() == sgs.Player_Finish then
                room:loseHp(player, 1, true, player, self:objectName())
                room:sendCompulsoryTriggerLog(player, self:objectName())
            end
        end
		return false
	end,
}
if not sgs.Sanguosha:getSkill("sfofl_lianjiDamage&") then skills:append(sfofl_lianjiDamage) end
sfofl_wangyun:addSkill(sfofl_lianji_buff)
sfofl_wangyun:addSkill(sfofl_lianji)
sfofl_wangyun:addSkill(sfofl_moucheng)
if not sgs.Sanguosha:getSkill("sfofl_jingongz") then skills:append(sfofl_jingongz) end

sfofl_lvbu = sgs.General(extension_e, "sfofl_lvbu", "qun", 5)
--[[
	技能名：利驭
	相关武将：吕布[官盗]
	技能描述：出牌阶段限两次，你可以获得一名其他角色的一张牌，若如此做，本回合你使用【杀】或【决斗】造成的伤害+1，然后其视为对你使用一张【决斗】。
	引用：sfofl_liyu
]] --

sfofl_liyuCard = sgs.CreateSkillCard{
	name = "sfofl_liyu",
	target_fixed = false,
	filter = function(self, targets, to_select, player)
		return #targets < 1 and not to_select:isNude()
	end,
	on_effect = function(self, effect)
        local room = effect.from:getRoom()
        local card_id = room:askForCardChosen(effect.from, effect.to, "he", self:objectName())
        room:obtainCard(effect.from, card_id)
        room:addPlayerMark(effect.from, "&sfofl_liyu-Clear")
        room:addPlayerMark(effect.from, "sfofl_liyu-Clear")
        local card = sgs.Sanguosha:cloneCard("duel", sgs.Card_NoSuit, 0)
        card:setSkillName(self:objectName())
        card:deleteLater()
        local use = sgs.CardUseStruct()
        use.from = effect.to
        use.to:append(effect.from)
        use.card = card
        room:useCard(use, false)
    end
}

sfofl_liyu = sgs.CreateViewAsSkill{
	name = "sfofl_liyu",
	n = 0,
	view_as = function(self, cards)
        return sfofl_liyuCard:clone()
	end,
	enabled_at_play = function(self, player)
		return player:usedTimes("#sfofl_liyu") < 2
	end,
}
sfofl_liyu_buff = sgs.CreateTriggerSkill{
    name = "#sfofl_liyu_buff",
    events = {sgs.DamageCaused},
    priority = 1,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.DamageCaused then
            local damage = data:toDamage()
            if damage.card and (damage.card:isKindOf("Slash") or damage.card:isKindOf("Duel")) and player:getMark("sfofl_liyu-Clear") > 0 and damage.by_user then
                local damage = data:toDamage()
                damage.damage = damage.damage + player:getMark("sfofl_liyu-Clear")
                local log = sgs.LogMessage()
                log.type = "#skill_add_damage"
                log.from = damage.from
                log.to:append(damage.to)
                log.arg  = "sfofl_liyu"
                log.arg2 = damage.damage
                player:getRoom():sendLog(log)
                data:setValue(damage)
            end
        end
    end,
    can_trigger = function(self, target)
        return target
    end,
}



sfofl_lvbu:addSkill("wushuang")
sfofl_lvbu:addSkill(sfofl_liyu)
sfofl_lvbu:addSkill(sfofl_liyu_buff)
extension_e:insertRelatedSkills("sfofl_liyu", "#sfofl_liyu_buff")

-- sfofl_shencaocao = sgs.General(extension_e, "sfofl_shencaocao", "god", 4)
--[[
	技能名：诏昭
	相关武将：神曹操[官盗]
	技能描述：当你造成或受到1点伤害后，你可以摸一张牌，然后选择一项令伤害来源或受伤角色执行：1.从弃牌堆或场上获得一张装备牌并使用之，此牌置于一个额外装备栏；2.翻面并摸一张牌；3.减1点体力上限。
	引用：sfofl_zhaozhao
]] --






    
--[[
	技能名：桀骜
	相关武将：神曹操[官盗]
	技能描述：锁定技，当你翻面时，防止之，然后令所有其他角色依次失去1点体力。
	引用：sfofl_jieao
]] --
sfofl_jieao = sgs.CreateTriggerSkill{
    name = "sfofl_jieao",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.TurnOver},
	on_trigger = function(self,event,player,data,room)
		if event==sgs.TurnOver then
            room:sendCompulsoryTriggerLog(player, self:objectName())
            for _, p in sgs.qlist(room:getOtherPlayers(player)) do
                room:loseHp(p, 1, true, player, self:objectName())
            end
			return player:faceUp()
		end
	end,
}

sfofl_lijueguosi = sgs.General(extension_e, "sfofl_lijueguosi", "god", 5)
--[[
	技能名：威惧
	相关武将：神李傕郭汜[官盗]
	技能描述：锁定技，准备阶段，所有其他角色依次将任意张手牌置于其武将牌上直到回合结束，称为“惧”。若一名角色的“惧”数不大于其手牌数，你与其互相视为在对方的攻击范围内。
	引用：sfofl_weiju
]] --

sfofl_weiju = sgs.CreateTriggerSkill{
    name = "sfofl_weiju",
    events = {sgs.EventPhaseStart, sgs.CardsMoveOneTime},
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.EventPhaseStart then
            if player:getPhase() ~= sgs.Player_Start then return false end
            for _,p in sgs.qlist(room:getAllPlayers()) do
                if not p:isKongcheng() then
                    local card = room:askForExchange(p, self:objectName(), p:getHandcardNum(), 1, false, "@sfofl_weiju", false)
                    if card then
                        local card_ids = card:getSubcards()
                        -- local splayers = sgs.SPlayerList()
                        -- splayers:append(p)
                        -- p:addToPile("sfofl_weiju_ju", card_ids, false, splayers)
                        p:addToPile("sfofl_weiju_ju", card_ids)
                    end
                end
            end
        else
            local move = data:toMoveOneTime()
            local from
            local to
            if move.from then
                from = room:findPlayerByObjectName(move.from:objectName())
                if not from then return end
                if from:getPile("sfofl_weiju_ju"):length() <= from:getHandcardNum() then
                    for _,p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                        room:insertAttackRangePair(from, p)
                        room:insertAttackRangePair(p, from)
                    end
                else
                    for _,p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                        room:removeAttackRangePair(from, p)
                        room:removeAttackRangePair(p, from)
                    end
                end
            end
            if move.to then
                to = room:findPlayerByObjectName(move.to:objectName())
                if to:getPile("sfofl_weiju_ju"):length() <= to:getHandcardNum() then
                    for _,p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                        room:insertAttackRangePair(to, p)
                        room:insertAttackRangePair(p, to)
                    end
                else
                    for _,p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                        room:removeAttackRangePair(to, p)
                        room:removeAttackRangePair(p, to)
                    end
                end
            end
        end
    end,
}
sfofl_weiju_return = sgs.CreateTriggerSkill{
    name = "#sfofl_weiju_return",
    events = {sgs.EventPhaseStart},
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if player:getPhase() ~= sgs.Player_NotActive then return false end
        for _,target in sgs.qlist(room:getAlivePlayers()) do
            if target:isAlive() and target:getPile("sfofl_weiju_ju") and target:getPile("sfofl_weiju_ju"):length() > 0 then
                local obtain = sgs.Sanguosha:cloneCard("jink", sgs.Card_SuitToBeDecided, -1)
                obtain:addSubcards(target:getPile("sfofl_weiju_ju"))
                room:obtainCard(target, obtain, false)
                obtain:deleteLater()
            end
        end
    end,
    can_trigger = function(self, target)
        return target ~= nil
    end,
}


--[[
	技能名：肆凶
	相关武将：神李傕郭汜[官盗]
	技能描述：出牌阶段开始时，你可以展示所有手牌并弃置其中至少一种颜色的所有牌，若弃置：黑色，你获得等量张“惧”；红色，你对攻击范围内所有其他角色依次造成1点伤害。
	引用：sfofl_sixiong
]] --
sfofl_sixiongCard = sgs.CreateSkillCard{
	name = "sfofl_sixiong",
	target_fixed = true,
	will_throw = false,
	on_use = function(self, room, player, targets)
        room:obtainCard(player, self, false)
    end
}
sfofl_sixiongVS = sgs.CreateViewAsSkill{
    name = "sfofl_sixiong",
    n = 999,
    expand_pile = "%sfofl_weiju_ju,sfofl_weiju_ju",
	view_filter = function(self, selected, to_select)
        local can_use = sgs.IntList()
		for _,p in sgs.qlist(sgs.Self:getAliveSiblings(true)) do 
            for _,id in sgs.qlist(p:getPile("sfofl_weiju_ju")) do 
                can_use:append(id)
            end
		end
        return can_use:contains(to_select:getId())
	end,
    view_as = function(self, cards)
        if #cards ~= sgs.Self:getMark("sfofl_sixiong") then return nil end
        if #cards > 0 then
            local card = sfofl_sixiongCard:clone()
            for _, c in ipairs(cards) do
                card:addSubcard(c)
            end
            return card
        end
    end,
    enabled_at_play = function(self, player)
        return false
    end,
    enabled_at_response = function(self,player,pattern)
	   	return pattern=="@@sfofl_sixiong!"
	end,
}
sfofl_sixiong = sgs.CreateTriggerSkill{
    name = "sfofl_sixiong",
    events = {sgs.EventPhaseStart},
    view_as_skill = sfofl_sixiongVS,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.EventPhaseStart then
            if player:getPhase() ~= sgs.Player_Play then return false end
            if player:canDiscard(player, "h") and room:askForSkillInvoke(player, self:objectName()) then
                room:showAllCards(player)
                local colours = {}
                local red, black
                for _, card in sgs.qlist(player:getHandcards()) do
                    if not table.contains(colours, card:getColorString()) then
                        table.insert(colours, card:getColorString())
                    end
                end
                if #colours > 1 then
                    table.insert(colours, "all")
                end
                local choice = room:askForChoice(player, self:objectName(), table.concat(colours, "+"))
                if choice == "red" or choice == "all" then
                    local dummy = dummyCard()
                    for _, card in sgs.qlist(player:getHandcards()) do
                        if card:isRed() then
                            dummy:addSubcard(card)
                        end
                    end
                    room:throwCard(dummy, player)
                    for _,p in sgs.qlist(room:getOtherPlayers(player)) do
                        if player:inMyAttackRange(p) then
                            room:damage(sgs.DamageStruct(self:objectName(), player, p))
                        end
                    end
                end
                if choice == "black" or choice == "all" then
                    local dummy = dummyCard()
                    for _, card in sgs.qlist(player:getHandcards()) do
                        if card:isBlack() then
                            dummy:addSubcard(card)
                        end
                    end
                    room:throwCard(dummy, player)
                    local max = 0
                    for _,p in sgs.qlist(room:getAllPlayers()) do
                        if not p:getPile("sfofl_weiju_ju"):isEmpty() then
                            max = max + p:getPile("sfofl_weiju_ju"):length()
                        end
                    end
                    max = math.min(dummy:subcardsLength(), max)
                    room:setPlayerMark(player, "sfofl_sixiong", max)
                    room:askForUseCard(player, "@@sfofl_sixiong!", "@sfofl_sixiong:"..max)
                    room:setPlayerMark(player, "sfofl_sixiong", 0)
                end
            end
        end
    end,
}

sfofl_lijueguosi:addSkill(sfofl_weiju)
sfofl_lijueguosi:addSkill(sfofl_weiju_return)
extension_e:insertRelatedSkills("sfofl_weiju", "#sfofl_weiju_return")
sfofl_lijueguosi:addSkill(sfofl_sixiong)

sfofl_shenjiaxu = sgs.General(extension_e, "sfofl_shenjiaxu", "god", 3)
--[[
	技能名：丧乱
	相关武将：神贾诩[官盗]
	技能描述：当你使用伤害牌后，你可以令一名其他角色对你指定的另一名角色使用一张【杀】，否则其失去1点体力且你回复1点体力。
	引用：sfofl_sangluan
]] --
sfofl_sangluan = sgs.CreateTriggerSkill{
	name = "sfofl_sangluan",
	events = {sgs.CardFinished},
	on_trigger = function(self,event,player,data,room)
		if event == sgs.CardFinished then
			local use = data:toCardUse()
			if not use.card:isDamageCard() then return end
			local target = room:askForPlayerChosen(player, room:getOtherPlayers(player), "sfofl_sangluan", "sfofl_sangluan-invoke", true, true)
            if target then
                local target2 = room:askForPlayerChosen(player, room:getOtherPlayers(target), "sfofl_sangluan_slash", "sfofl_sangluan-slash:"..target:objectName(), false, true)
                if room:askForUseSlashTo(target, target2, "@sfofl_sangluan:"..player:objectName(), false, true) then
                else
                    room:loseHp(target,1,true,player,self:objectName())
                    room:recover(player,sgs.RecoverStruct(self:objectName(),player,1))
                end
            end
		end
	end
}

--[[
	技能名：尸暴
	相关武将：神贾诩[官盗]
	技能描述：出牌阶段，你可以令一名丧尸失去所有体力，然后你对其上家和下家各造成1点伤害。
	引用：sfofl_shibao
]] --

sfofl_shibaoCard = sgs.CreateSkillCard {
	name = "sfofl_shibao",
	target_fixed = false,
    will_throw = false,
	filter = function(self, targets, to_select)
		if #targets == 0 then
			return string.find(to_select:getGeneralName(), "zombie") or string.find(to_select:getGeneral2Name(), "zombie")
		end
        return false
	end ,
	on_use = function(self, room, source, targets)
        local target = targets[1]
        local targets = sgs.SPlayerList()
        for _,p in sgs.list(room:getAlivePlayers()) do
            if target:isAdjacentTo(p) then
                targets:append(p)
            end
        end
        room:loseHp(target,target:getHp(),true,source,self:objectName())
        for _,p in sgs.list(targets) do
            room:damage(sgs.DamageStruct(self:objectName(), source, p))
        end
	end
}
sfofl_shibao = sgs.CreateViewAsSkill {
	name = "sfofl_shibao",
	n = 0,
	view_filter = function(self, selected, to_select)
		return false
	end,
	view_as = function(self, cards)
		if #cards == 0 then
			return sfofl_shibaoCard:clone()
		end
	end,
	enabled_at_play = function(self, player)
		return true
	end,
}


--[[
	技能名：出策
	相关武将：神贾诩[官盗]
	技能描述：你可以将锦囊牌当任意基本牌或锦囊牌使用（无距离次数限制）。每回合限一次，当其他角色使用锦囊牌时，你可以摸三张牌令此牌无效，然后你可以视为使用之。
	引用：sfofl_chuce
]] --
sfofl_chuceCard = sgs.CreateSkillCard{
    name = "sfofl_chuce",
    will_throw = false ,
    handling_method = sgs.Card_MethodNone,
    filter = function(self, targets, to_select, from)
        local pattern = self:getUserString()
		local dc = dummyCard(pattern:split("+")[1])
		if dc:targetFixed() then return false end
		dc:setSkillName("sfofl_chuce")
        dc:addSubcards(self:getSubcards())
		local plist = sgs.PlayerList()
		for i = 1, #targets do plist:append(targets[i]) end
		return dc:targetFilter(plist,to_select,from)
	end,
    feasible = function(self,targets,from)
		local pattern = self:getUserString()
		local dc = dummyCard(pattern:split("+")[1])
        dc:setSkillName("sfofl_chuce")
        dc:addSubcards(self:getSubcards())
        if card and card:canRecast() and #targets == 0 then
			return false
		end
		local plist = sgs.PlayerList()
		for i = 1, #targets do plist:append(targets[i]) end
		return dc:targetFixed() or dc:targetsFeasible(plist, from)
	end,
    on_validate = function(self, card_use)
		local player = card_use.from
        local room = player:getRoom()
        local pattern = self:getUserString()
        local card = sgs.Sanguosha:cloneCard(pattern, sgs.Card_SuitToBeDecided, -1)
		card:setSkillName(self:objectName())
        room:setCardFlag(card, "RemoveFromHistory")
        card:addSubcards(self:getSubcards())
        return card
	end,
    on_validate_in_response = function(self, player)
        local room = player:getRoom()
        local pattern = self:getUserString()
		if pattern == "normal_slash" then pattern = "slash" end
        if pattern == "Slash" then
            local all = {"slash","fire_slash","thunder_slash"} 
            local items = {}
            for _,item in ipairs(all) do
                local mark = string.format("sfofl_chuce_guhuo_remove_%s-Clear", item)
                if player:getMark(mark) == 0 then
                    table.insert(items, item)
                end
            end
            pattern = room:askForChoice(player, "sfofl_chuce_Slash", table.concat(items, "+"))
        end
        if pattern == "Jink" then pattern = "jink" end
        if pattern == "peach+analeptic" then 
            local all = {"peach","analeptic"} 
            local items = {}
            for _,item in ipairs(all) do
                local mark = string.format("sfofl_chuce_guhuo_remove_%s-Clear", item)
                if player:getMark(mark) == 0 then
                    table.insert(items, item)
                end
            end
            pattern = room:askForChoice(player, "sfofl_chuce_saveself", table.concat(items, "+"))
        end

		local card = sgs.Sanguosha:cloneCard(pattern, sgs.Card_SuitToBeDecided, -1)
		card:setSkillName(self:objectName())
        room:setCardFlag(card, "RemoveFromHistory")
        card:addSubcards(self:getSubcards())
        return card
    end
}

sfofl_chuceVS = sgs.CreateViewAsSkill{
    name = "sfofl_chuce",
    n = 1,
    view_filter = function(self, selected, to_select)
        if sgs.Sanguosha:getCurrentCardUsePattern() == "@@sfofl_chuce" then return false end
		return to_select:isKindOf("TrickCard")
	end,
    enabled_at_play = function(self, player)
		for _,p in sgs.list(patterns())do
			local dc = dummyCard(p)
			if dc then
                dc:setSkillName("sfofl_chuce")
                if dc:isAvailable(player)
				then return true end
			end
		end
        return false
    end,
    enabled_at_response = function(self, player, pattern)
        if sgs.Sanguosha:getCurrentCardUsePattern() == "@@sfofl_chuce" then return true end
        if sgs.Sanguosha:getCurrentCardUseReason() ~= sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then return false end
        if pattern == "peach" then
            return not player:hasFlag("Global_PreventPeach")
        else
            return true
        end
    end,
    view_as = function(self, cards)
        local cc = sfofl_chuceCard:clone()
        if sgs.Sanguosha:getCurrentCardUsePattern() == "@@sfofl_chuce" then
            local id = sgs.Self:getMark("sfofl_chuce_id-PlayClear") - 1
            local card = sgs.Sanguosha:getCard(id)
            c = sgs.Sanguosha:cloneCard(card:objectName())
            c:setSkillName("sfofl_chuce")
            if #cards == 0 then
                return c
            end
        else
            if #cards > 0 then
                for _, c in ipairs(cards) do
                    cc:addSubcard(c)
                end
                if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
                    local card = sgs.Self:getTag("sfofl_chuce"):toCard()
                    cc:setUserString(card:objectName())
                    return cc
                end
                if sgs.Sanguosha:getCurrentCardUseReason() ~= sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then return nil end
                local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
                if pattern == "peach+analeptic" and sgs.Self:hasFlag("Global_PreventPeach") then
                    pattern = "analeptic"
                end
                cc:setUserString(pattern)
                return cc
            end
        end
        
    end,
}
sfofl_chuce = sgs.CreateTriggerSkill{
	name = "sfofl_chuce",
    view_as_skill = sfofl_chuceVS,
    guhuo_type = "lr",
	events = {sgs.CardUsed, sgs.CardFinished},
    on_trigger = function(self,event,player,data,room)
        local use = data:toCardUse()
        if use.card and use.card:isKindOf("TrickCard") then
            if event == sgs.CardUsed then
                for _,p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if p:getMark("sfofl_chuce-Clear") == 0 and room:askForSkillInvoke(p, self:objectName(), data) then
                        room:addPlayerMark(p, "sfofl_chuce-Clear")
                        room:addPlayerMark(p, "&sfofl_chuce-Clear")
                        p:drawCards(3, self:objectName())
                        room:setCardFlag(use.card, "sfofl_chuce")
                        room:setCardFlag(use.card, "sfofl_chuce"..p:objectName())
                        local nullified_list = use.nullified_list
                        table.insert(nullified_list, "_ALL_TARGETS")
                        use.nullified_list = nullified_list
                        data:setValue(use)
                        break
                    end
                end
            else
                if use.card and use.card:hasFlag("sfofl_chuce") and use.card:isNDTrick() and not use.whocard then
                    for _,p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                        if use.card:hasFlag("sfofl_chuce"..p:objectName()) then
                            room:setPlayerMark(p, "sfofl_chuce_id-PlayClear", use.card:getEffectiveId() + 1);
                            if use.card:targetFixed() then
                                local poi = sgs.Sanguosha:cloneCard(use.card:objectName(), sgs.Card_NoSuit, 0)
                                poi:deleteLater()
                                if poi:targetFixed() then
                                    poi:setSkillName("sfofl_chuce")
                                    if room:askForSkillInvoke(p, self:objectName().."use", data) then
                                        room:useCard(sgs.CardUseStruct(poi, p, sgs.SPlayerList()), false)
                                    end
                                end
                            else
                                room:askForUseCard(p, "@@sfofl_chuce", "@sfofl_chuce:"..use.card:objectName())
                            end
                            room:setPlayerMark(p, "sfofl_chuce_id-PlayClear", 0)
                        end
                    end
                end
            end
        end
    end,
    can_trigger = function(self,target)
		return target and target:isAlive()
	end,
}
sfofl_chuce_buff = sgs.CreateTargetModSkill {
    name = "#sfofl_chuce_buff",
    residue_func = function(self, from, card, to)
        if from and from:hasSkill("sfofl_chuce") and table.contains(card:getSkillNames(), "sfofl_chuce") then
			return 999
		else
			return 0
		end
    end,
    distance_limit_func = function(self, from, card, to)
        if from and from:hasSkill("sfofl_chuce") and table.contains(card:getSkillNames(), "sfofl_chuce") then
            return 999
        end
        return 0
    end
}

--[[
	技能名：籠墓
	相关武将：神贾诩[官盗]
	技能描述：锁定技，你的回合内其他角色不能回复体力。当你成为锦囊牌的目标时，取消之。当一名角色死亡后，若你对其发动过此武将牌上的技能且其不为丧尸，用丧尸代替该角色加入游戏。
	引用：sfofl_longmu
]] --

sfofl_longmu_record = sgs.CreateTriggerSkill{
	name = "#sfofl_longmu_record",
    frequency = sgs.Skill_Compulsory,
	events = {sgs.ChoiceMade, sgs.CardFinished},
	on_trigger = function(self,event,player,data,room)
		if event == sgs.ChoiceMade then
            local str = data:toString()
		    if str:startsWith("playerChosen:") then
                local strs = str:split(":")
                if player:hasSkill(strs[2],true) then
                    local targetlist = strs[3]:split("+")
                    for _,p in sgs.list(targetlist) do
                        local target = room:findPlayerByObjectName(p)
                        if target and target:getMark("sfofl_longmu"..player:objectName()) == 0 then
                            room:addPlayerMark(target, "sfofl_longmu"..player:objectName())
                            room:addPlayerMark(target, "&sfofl_longmu+to+#"..player:objectName())
                        end
                    end
                end
            end
		elseif event == sgs.CardFinished then
			local use = data:toCardUse()
            if use.card and use.card:isKindOf("SkillCard") and player:hasSkill(use.card:getSkillName()) then
                for _,p in sgs.qlist(use.to) do
                    if p:getMark("sfofl_longmu"..player:objectName()) == 0 then
                        room:addPlayerMark(p, "sfofl_longmu"..player:objectName())
                        room:addPlayerMark(p, "&sfofl_longmu+to+#"..player:objectName())
                    end
                end
            else
                for _,sk in sgs.list(use.card:getSkillNames()) do
                    if player:hasSkill(sk) then
                        for _,p in sgs.qlist(use.to) do
                            if p:getMark("sfofl_longmu"..player:objectName()) == 0 then
                                room:addPlayerMark(p, "sfofl_longmu"..player:objectName())
                                room:addPlayerMark(p, "&sfofl_longmu+to+#"..player:objectName())
                            end
                        end
                    end
                end
            end
		end
	end,
}
sfofl_longmu = sgs.CreateTriggerSkill{
	name = "sfofl_longmu",
    frequency = sgs.Skill_Compulsory,
	events = {sgs.BeforeGameOverJudge,sgs.PreHpRecover,sgs.TargetConfirming},
	can_trigger = function(self,target)
		return target
	end,
	on_trigger = function(self,event,player,data,room)
		if event == sgs.BeforeGameOverJudge then
            local death = data:toDeath()
            for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                if p:objectName() == death.who:objectName() then continue end
                if death.who:getMark("sfofl_longmu"..p:objectName()) > 0 and not death.who:isLord() then
                    if string.find(death.who:getGeneralName(), "zombie") or string.find(death.who:getGeneral2Name(), "zombie") then
                    else
                        -- room:revivePlayer(death.who, true, false)
                        death.who:setAlive(true)
                        room:broadcastProperty(death.who, "alive")
                        room:swapSeat(death.who, death.who)
                        room:setPlayerFlag(death.who, "-Global_Dying")
                        local currentdying = room:getTag("CurrentDying"):toStringList()
                        table.removeOne(currentdying,death.who:objectName())
                        room:setTag("CurrentDying", sgs.QVariant(table.concat(currentdying, "|")))
                        local skills={}
                        for _,skill in sgs.qlist(death.who:getVisibleSkillList())do
                            if not table.contains(skills,skill:objectName()) then
                                table.insert(skills,skill:objectName())
                            end
                        end
                        room:changeHero(death.who,"sfofl_zombie",true,true,false,true)
                        for _,skill in ipairs(skills) do
                            room:handleAcquireDetachSkills(death.who,skill, true, false, false)
                        end
                        if p:getRole() == "lord" then
                            room:setPlayerProperty(death.who, "role", sgs.QVariant("loyalist"))
                        else
                            room:setPlayerProperty(death.who, "role", sgs.QVariant(p:getRole()))
                        end
                        -- room:resetAI(death.who)
                        room:updateStateItem()
                        local right = true
                        for _, p in sgs.qlist(room:getAlivePlayers()) do
                            if p:getRole() == "rebel" or p:getRole() == "renegade" then
                                right = false
                            end
                        end
                        if right then
                            room:gameOver("lord+loyalist")
                        end
                        return true
                    end
                end
                if death.who:isLord() and p:getRole() == "renegade" then
                    local right = true
                    for _, q in sgs.qlist(room:getOtherPlayers(death.who)) do
                        if q:getRole() == "renegade" and (string.find(q:getGeneralName(), "zombie") or string.find(q:getGeneral2Name(), "zombie")) then
                        else
                            right = false
                        end
                    end
                    if right then
                        room:gameOver("renegade")
                    end
                end
            end
		elseif event == sgs.PreHpRecover then
			local current = room:getCurrent()
			return current and current:hasSkill(self:objectName()) and player:objectName() ~= current:objectName()
        elseif event == sgs.TargetConfirming then
            local use = data:toCardUse()
            if use.card and use.card:isKindOf("TrickCard") then
                if player and player:isAlive() and player:hasSkill(self:objectName()) and use.to:contains(player) then
                    use.to:removeOne(player)
                    room:sendCompulsoryTriggerLog(player,self)
                    data:setValue(use)
                end
            end
		end
	end,
}

--[[
	技能名：炼尸傀
	相关武将：神贾诩[官盗]
	技能描述：当一名非丧尸角色失去体力时，你可以令一名丧尸回复1点体力或获得1点护甲；当一名丧尸角色造成伤害时，你可以摸一张牌。
	引用：sfofl_lianshikui
]] --
sfofl_lianshikuiTr = sgs.CreateTriggerSkill {
	name = "_sfofl_lianshikui",
	frequency = sgs.Skill_Compulsory,
	events = { sgs.DamageCaused, sgs.HpLost },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
        if event == sgs.DamageCaused then
            local damage = data:toDamage()
            local source = damage.from
            if source then
               if string.find(source:getGeneralName(), "zombie") or string.find(source:getGeneral2Name(), "zombie") then
                    for _,p in sgs.list(room:getAlivePlayers())do
                        if p:hasTreasure("_sfofl_lianshikui") then
                            p:drawCards(1, "sfofl_lianshikui")
                        end
                    end
               end
            end
        elseif event == sgs.HpLost then
            local lose = data:toHpLost()
            if string.find(lose.to:getGeneralName(), "zombie") or string.find(lose.to:getGeneral2Name(), "zombie") then
            else
                local splayers = sgs.SPlayerList()
                for _,p in sgs.list(room:getAllPlayers())do
                    if (string.find(p:getGeneralName(), "zombie") or string.find(p:getGeneral2Name(), "zombie")) then
                        splayers:append(p)
                    end
                end
                if splayers:isEmpty() then return end
                for _,p in sgs.list(room:getAlivePlayers())do
                    if p:hasTreasure("_sfofl_lianshikui") then
                        local target = room:askForPlayerChosen(p, splayers, self:objectName(), "sfofl_lianshikui-invoke", true, true)
                        if target then
                            local choicelist = {"gainHujia"}
                            if target:isWounded() then
                                table.insert(choicelist, "hp")
                            end
                            local result = room:askForChoice(p, self:objectName(), table.concat(choicelist, "+"), ToData(target))
                            if result == "hp" then
                                room:recover(target,sgs.RecoverStruct(self:objectName(),p,1))
                            else
                                target:gainHujia(1)
                            end
                        end
                    end
                end
            end
        end
	end,
    can_trigger = function(self,target)
		return target
	end,
}
sfofl_lianshikui = sgs.CreateTreasure{
	name = "_sfofl_lianshikui",
	class_name = "LianShiKui",
	equip_skill = sfofl_lianshikuiTr,
    suit = sgs.Card_Spade,
    number = 1,
	on_install = function(self,player)
		local room = player:getRoom()
		room:attachSkillToPlayer(player,"sfofl_lianshikui")
	end,
	on_uninstall = function(self,player)
		player:getRoom():detachSkillFromPlayer(player,"sfofl_lianshikui",true,true)
	end,
}    

sfofl_lianshikui_change = sgs.CreateTriggerSkill{
	name = "#sfofl_lianshikui_change",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.GameStart, sgs.BeforeCardsMove},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
        if (event == sgs.BeforeCardsMove) then
			local move = data:toMoveOneTime()
			if move.from_places:contains(sgs.Player_PlaceEquip) and move.reason.m_skillName~="BreakCard"
			and move.from:objectName()==player:objectName() then
				for i,id in sgs.list(move.card_ids)do
					if move.from_places:at(i)==sgs.Player_PlaceEquip
					and sgs.Sanguosha:getCard(id):isKindOf("LianShiKui") then
						local ids = sgs.IntList()
						ids:append(id)
						move:removeCardIds(ids)
						data:setValue(move)
						room:breakCard(id,player)
                    end
                end
            end
	    elseif event == sgs.GameStart then
            if player:hasSkill(self:objectName()) then
                for _,id in sgs.qlist(sgs.Sanguosha:getRandomCards(true)) do
                    if sgs.Sanguosha:getEngineCard(id):isKindOf("LianShiKui")  then
                        room:useCard(sgs.CardUseStruct(sgs.Sanguosha:getEngineCard(id), player, player), false)
                    end
                end
            end          
		end
	end,
	can_trigger = function(self, player)
		return player
	end,
}

sfofl_shenjiaxu:addSkill(sfofl_sangluan)
sfofl_shenjiaxu:addSkill(sfofl_shibao)
sfofl_shenjiaxu:addSkill(sfofl_chuce)
sfofl_shenjiaxu:addSkill(sfofl_chuce_buff)
extension_e:insertRelatedSkills("sfofl_chuce", "#sfofl_chuce_buff")
sfofl_shenjiaxu:addSkill(sfofl_longmu_record)
sfofl_shenjiaxu:addSkill(sfofl_longmu)
extension_e:insertRelatedSkills("sfofl_longmu", "#sfofl_longmu_record")
sfofl_lianshikui:setParent(extension_card)
sfofl_shenjiaxu:addSkill(sfofl_lianshikui_change)

sfofl_zombie = sgs.General(extension_e, "sfofl_zombie", "qun", 4, true, true, false, 2)
--[[
	技能名：尸变
	相关武将：神贾诩[官盗]
	技能描述：锁定技，你保留所有技能，阵营和胜利条件变为和贾诩相同。
	引用：sfofl_shibian
]] --

sfofl_shibian = sgs.CreateTriggerSkill{
	name = "sfofl_shibian",
    frequency = sgs.Skill_Compulsory,
	events = {},
    on_trigger = function(self,event,player,data,room)
    end
}

--[[
	技能名：感染
	相关武将：神贾诩[官盗]
	技能描述：结束阶段，若你本回合杀死了一名角色且其不为丧尸，用丧尸代替该角色加入游戏，然后你回复所有体力并摸等量张牌。
	引用：sfofl_ganran
]] --

sfofl_ganran = sgs.CreateTriggerSkill{
	name = "sfofl_ganran",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.Death, sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data, room)
        if event == sgs.Death then
            local death = data:toDeath()
            local victim = death.who
            if victim:getSeat() ~= player:getSeat() then
                if death.damage and death.damage.from and death.damage.from:getSeat() == player:getSeat() then
                    room:addPlayerMark(player, "sfofl_ganran".. victim:objectName() .."-Clear")	
                    room:addPlayerMark(player, "sfofl_ganran-Clear")	
                end
            end
        elseif event == sgs.EventPhaseStart then
            if player:getMark("sfofl_ganran-Clear") > 0 and player:getPhase() == sgs.Player_Finish then
                local deathplayer = {}
                for _, p in sgs.qlist(room:getPlayers()) do
                    if p:isDead() and p:getMaxHp() > 0 and player:getMark("sfofl_ganran".. p:objectName() .."-Clear") > 0 then
                        if string.find(p:getGeneralName(), "zombie") or string.find(p:getGeneral2Name(), "zombie") then
                        else
                            table.insert(deathplayer, p:getGeneralName())
                        end
                    end
                end
			    if #deathplayer > 0 then
                    local ap = room:askForChoice(player, "sfofl_ganran", table.concat(deathplayer, "+"))
                    local target
                    for _, p in sgs.qlist(room:getPlayers()) do
                        if p:getGeneralName() == ap and p:isDead() then
                            target = p
                        end
                    end
                    room:revivePlayer(target, true)
                    local skills={}
                    for _,skill in sgs.qlist(target:getVisibleSkillList())do
                        if not table.contains(skills,skill:objectName()) then
                            table.insert(skills,skill:objectName())
                        end
                    end
                    room:changeHero(target,"sfofl_zombie",true,true,false,true)
                    for _,skill in ipairs(skills) do
                        room:handleAcquireDetachSkills(target,skill, true, false, false)
                    end
                    if player:getRole() == "lord" then
                        room:setPlayerProperty(target, "role", sgs.QVariant("loyalist"))
                    else
                        room:setPlayerProperty(target, "role", sgs.QVariant(player:getRole()))
                    end
                    room:resetAI(target)
                    room:updateStateItem()
                    local x = player:getLostHp()
                    if x > 0 then
                        room:recover(player, sgs.RecoverStruct(self:objectName(), player, x))
                        player:drawCards(x)
                    end
                end
            end
        end
	end
}

sfofl_zombie:addSkill(sfofl_shibian)
sfofl_zombie:addSkill(sfofl_ganran)

sfofl_shenwangyun = sgs.General(extension_e, "sfofl_shenwangyun", "god", 4)
--[[
	技能名：安朝
	相关武将：神王允[官盗]
	技能描述：每个回合结束时，本回合每有一名角色使用过虚拟牌或转化牌，你可以摸一张牌并令〖定西〗可发动次数+1。
	引用：sfofl_anchao
]] --

sfofl_anchao = sgs.CreateTriggerSkill{
    name = "sfofl_anchao",
    frequency = sgs.Skill_Frequent,
    events = {sgs.CardUsed, sgs.CardResponded, sgs.EventPhaseChanging},
    on_trigger = function(self, event, player, data, room)
        if event==sgs.EventPhaseChanging and data:toPhaseChange().to==sgs.Player_NotActive then
            for _, p in sgs.qlist(room:getAllPlayers()) do
                if p:getMark("sfofl_anchao") > 0 then
                    room:setPlayerMark(p, "sfofl_anchao", 0)
                    for _, wangyun in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                        if room:askForSkillInvoke(wangyun, self:objectName()) then
                            wangyun:drawCards(1, self:objectName())
                            if wangyun:hasSkill("sfofl_dingxi") then
                                room:addPlayerMark(wangyun, "&sfofl_dingxi_can")
                            end
                        end
                    end
                end
            end
        else
            local card
            local target
            if event == sgs.CardUsed then
                card = data:toCardUse().card
                target = data:toCardUse().from
            else
                if data:toCardResponse().m_isUse then
                    card = data:toCardResponse().m_card
                    target = data:toCardResponse().m_who
                end
            end
            if card and card:getTypeId()>0 and card:isVirtualCard() and target then
                room:addPlayerMark(target, "sfofl_anchao")
            end
        end
    end,
    can_trigger = function(self, target)
		return target
	end,
}

--[[
	技能名：御戎
	相关武将：神王允[官盗]
	技能描述：锁定技，当你每轮首次成为一种牌名的伤害牌的目标时，取消之。
	引用：sfofl_yurong
]] --

sfofl_yurong = sgs.CreateTriggerSkill{
	name = "sfofl_yurong",
    frequency = sgs.Skill_Compulsory,
	events = {sgs.TargetConfirming, sgs.RoundEnd},
	on_trigger = function(self,event,player,data,room)
		if event == sgs.TargetConfirming then
            local use = data:toCardUse()
            if use.card and use.card:isDamageCard() then
                if player:hasSkill(self:objectName()) and use.to:contains(player) then
                    if player:getMark("sfofl_yurong:".. use.card:objectName().."_lun") == 0 then
                        room:addPlayerMark(player, "sfofl_yurong:".. use.card:objectName().."_lun")
                        use.to:removeOne(player)
                        room:sendCompulsoryTriggerLog(player,self)
                        data:setValue(use)
                        local names = player:property("SkillDescriptionRecord_sfofl_yurong"):toString():split("+")
                        table.insert(names,use.card:objectName())
                        room:setPlayerProperty(player, "SkillDescriptionRecord_sfofl_yurong", sgs.QVariant(table.concat(names, "+")))
                        local result = ""
                        for i, v in ipairs(names) do
                            if i > 1 then
                                result = result .. "+|+"
                            end
                            result = result .. v
                        end
                        player:setSkillDescriptionSwap("sfofl_yurong", "%arg11", result)
                        room:changeTranslation(player, "sfofl_yurong", 2)
                    end
                end
            end
        elseif event == sgs.RoundEnd then
            local names = {}
            room:setPlayerProperty(player, "SkillDescriptionRecord_sfofl_yurong", sgs.QVariant(table.concat(names, "+")))
            player:setSkillDescriptionSwap("sfofl_yurong", "%arg11", table.concat(names, "+"))
            room:changeTranslation(player, "sfofl_yurong", 1)
		end
	end,
}

--[[
	技能名：定西
	相关武将：神王允[官盗]
	技能描述：每局游戏限四次，当你需使用非装备牌时，你可以展示牌堆顶的一张牌，若与你需使用的牌类别相同，视为你使用你需要的牌；否则你从牌堆底摸一张牌。每连续相同两次，你回复所有体力；每连续相同三次，你对所有其他角色各造成1点伤害。
	引用：sfofl_dingxi
]] --

sfofl_dingxiCard = sgs.CreateSkillCard{
    name = "sfofl_dingxi",
    will_throw = false ,
    handling_method = sgs.Card_MethodNone,
    filter = function(self, targets, to_select, from)
        local pattern = self:getUserString()
		local dc = dummyCard(pattern:split("+")[1])
		if dc:targetFixed() then return false end
		dc:setSkillName("sfofl_dingxi")
		local plist = sgs.PlayerList()
		for i = 1, #targets do plist:append(targets[i]) end
		return dc:targetFilter(plist,to_select,from)
	end,
    feasible = function(self,targets,from)
		local pattern = self:getUserString()
		local dc = dummyCard(pattern:split("+")[1])
        dc:setSkillName("sfofl_dingxi")
        if card and card:canRecast() and #targets == 0 then
			return false
		end
		local plist = sgs.PlayerList()
		for i = 1, #targets do plist:append(targets[i]) end
		return dc:targetFixed() or dc:targetsFeasible(plist, from)
	end,
    on_validate = function(self, card_use)
		local player = card_use.from
        local room = player:getRoom()
        room:removePlayerMark(player, "&sfofl_dingxi_can")
        local pattern = self:getUserString()
        local card = sgs.Sanguosha:cloneCard(pattern, sgs.Card_NoSuit, 0)
		card:setSkillName(self:objectName())
        local log = sgs.LogMessage()
        log.type = card_use.to:isEmpty() and "#sfofl_dingxiNoTarget" or "#sfofl_dingxi"
        log.from = player
        log.to = card_use.to
        log.arg = pattern
        log.arg2 = "sfofl_dingxi"
        room:sendLog(log)

        local ids = room:showDrawPile(player,1,self:objectName(),false)
        local dc = sgs.Sanguosha:getCard(ids:first())
        if card:getTypeId() == dc:getTypeId() then
            room:addPlayerMark(player, "&sfofl_dingxi_same")
            if player:getMark("&sfofl_dingxi_same") % 2 == 0 then
                room:recover(player, sgs.RecoverStruct(self:objectName(), player, player:getLostHp()))
            end
            if player:getMark("&sfofl_dingxi_same") % 3 == 0 then
                for _, p in sgs.qlist(room:getOtherPlayers(player)) do
                    room:damage(sgs.DamageStruct(self:objectName(), player, p))
                end
            end
            return card
        else
            room:setPlayerMark(player, "&sfofl_dingxi_same", 0)
            player:drawCards(1, self:objectName(), false)
            return nil
        end
	end,
    on_validate_in_response = function(self, player)
        local room = player:getRoom()
        room:removePlayerMark(player, "&sfofl_dingxi_can")
        local pattern = self:getUserString()
		if pattern == "normal_slash" then pattern = "slash" end
        if pattern == "Slash" then
            local all = {"slash","fire_slash","thunder_slash"} 
            local items = {}
            for _,item in ipairs(all) do
                local mark = string.format("sfofl_dingxi_guhuo_remove_%s-Clear", item)
                if player:getMark(mark) == 0 then
                    table.insert(items, item)
                end
            end
            pattern = room:askForChoice(player, "sfofl_dingxi_Slash", table.concat(items, "+"))
        end
        if pattern == "Jink" then pattern = "jink" end
        if pattern == "peach+analeptic" then 
            local all = {"peach","analeptic"} 
            local items = {}
            for _,item in ipairs(all) do
                local mark = string.format("sfofl_dingxi_guhuo_remove_%s-Clear", item)
                if player:getMark(mark) == 0 then
                    table.insert(items, item)
                end
            end
            pattern = room:askForChoice(player, "sfofl_dingxi_saveself", table.concat(items, "+"))
        end

		local card = sgs.Sanguosha:cloneCard(pattern, sgs.Card_NoSuit, 0)
		card:setSkillName(self:objectName())
        local log = sgs.LogMessage()
        log.type = "#sfofl_dingxiNoTarget"
        log.from = player;
        log.arg = pattern;
        log.arg2 = "sfofl_dingxi"
        room:sendLog(log)
        
        local ids = room:showDrawPile(player,1,self:objectName(),false)
        local dc = sgs.Sanguosha:getCard(ids:first())
        if card:getTypeId() == dc:getTypeId() then
            room:addPlayerMark(player, "&sfofl_dingxi_same")
            if player:getMark("&sfofl_dingxi_same") % 2 == 0 then
                room:recover(player, sgs.RecoverStruct(self:objectName(), player, player:getLostHp()))
            end
            if player:getMark("&sfofl_dingxi_same") % 3 == 0 then
                for _, p in sgs.qlist(room:getOtherPlayers(player)) do
                    room:damage(sgs.DamageStruct(self:objectName(), player, p))
                end
            end
            return card
        else
            room:setPlayerMark(player, "&sfofl_dingxi_same", 0)
            player:drawCards(1, self:objectName(), false)
            return nil
        end
    end
}

sfofl_dingxiVS = sgs.CreateViewAsSkill{
    name = "sfofl_dingxi",
    n = 0,
    enabled_at_play = function(self, player)
        if player:getMark("&sfofl_dingxi_can") == 0  then return false end
		for _,p in sgs.list(patterns())do
			local dc = dummyCard(p)
			if dc then
                dc:setSkillName("sfofl_dingxi")
                if dc:isAvailable(player)
				then return true end
			end
		end
        return false
    end,
    enabled_at_response = function(self, player, pattern)
        if player:getMark("&sfofl_dingxi_can") == 0  then return false end
        if sgs.Sanguosha:getCurrentCardUseReason() ~= sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then return false end
        if pattern == "peach" then
            return not player:hasFlag("Global_PreventPeach")
        else
            return true
        end
    end,
    view_as = function(self, cards)
        local cc = sfofl_dingxiCard:clone()
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
            local card = sgs.Self:getTag("sfofl_dingxi"):toCard()
            cc:setUserString(card:objectName())
            return cc
        end
        if sgs.Sanguosha:getCurrentCardUseReason() ~= sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then return nil end
        local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
        if pattern == "peach+analeptic" and sgs.Self:hasFlag("Global_PreventPeach") then
            pattern = "analeptic"
        end
        cc:setUserString(pattern)
        return cc
    end,
}
sfofl_dingxi = sgs.CreateTriggerSkill{
	name = "sfofl_dingxi",
    view_as_skill = sfofl_dingxiVS,
    guhuo_type = "lr",
	events = {sgs.GameStart},
    on_trigger = function(self,event,player,data,room)
        room:addPlayerMark(player, "&sfofl_dingxi_can", 4)
    end
}


sfofl_shenwangyun:addSkill(sfofl_anchao)
sfofl_shenwangyun:addSkill(sfofl_yurong)
sfofl_shenwangyun:addSkill(sfofl_dingxi)

sfofl_soldier = sgs.General(extension_e, "sfofl_soldier", "qun", 3)
--[[
	技能名：固守
	相关武将：士兵[官盗]
	技能描述：当你成为【杀】的目标时，你可以摸一张牌并展示，若为基本牌，则你视为使用一张【闪】。
	引用：sfofl_gushou
]] --
sfofl_gushou = sgs.CreateTriggerSkill{
	name = "sfofl_gushou",
	frequency = sgs.Skill_Frequent,
	events = {sgs.TargetConfirming, sgs.CardAsked},
	on_trigger = function(self,event,player,data,room)
    	if (event == sgs.TargetConfirming) then
			local use = data:toCardUse()
			if use.card and (use.card:isKindOf("Slash") or use.card:isKindOf("ArcheryAttack")) and use.to:contains(player) then
				if room:askForSkillInvoke(player, self:objectName(), data) then
                    local cards = room:getNCards(1)
                    local card = sgs.Sanguosha:getCard(cards:first())
                    player:obtainCard(card)
                    room:showCard(player, cards)
                    if sgs.Sanguosha:getCard(cards:first()):isKindOf("BasicCard") then
                        room:setCardFlag(use.card, "sfofl_gushou"..player:objectName())
                    end
                end
            end
        elseif event == sgs.CardAsked then
            local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
            if pattern == "jink" then
                local string = data:toStringList()[4]
                if not string then return end
                local tag = room:getTag("UseHistory"..string)
                if not tag then return end
                local use = tag:toCardUse()
                if not use then return end
                local usecard = use.card
                if not usecard or not usecard:hasFlag("sfofl_gushou"..player:objectName()) then return end
                room:setCardFlag(usecard, "-sfofl_gushou"..player:objectName())
                local jinkcard = sgs.Sanguosha:cloneCard("jink", sgs.Card_NoSuit, 0)
                jinkcard:setSkillName("sfofl_gushou")
                room:provide(jinkcard)
                return true
            end
        end
	end
}


--[[
	技能名：心溃
	相关武将：士兵[官盗]
	技能描述：锁定技，结束阶段，若敌军角色的数量不少于我方，则你失去1点体力。
	引用：sfofl_xinkui
]] --

sfofl_xinkui = sgs.CreateTriggerSkill{
	name = "sfofl_xinkui",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data, room)
        if event == sgs.EventPhaseStart then
            if player:getPhase() == sgs.Player_Finish then
                local x = 0
                for _, p in sgs.qlist(room:getAlivePlayers()) do
                    if player:isYourFriend(p) then
                        x = x + 1
                    else
                        x = x - 1
                    end
                end
                if x <= 0 then
                    room:sendCompulsoryTriggerLog(player, "sfofl_xinkui", true)
                    room:loseHp(player,1,true,player,self:objectName())
                end
            end
        end
	end
}

sfofl_soldier:addSkill(sfofl_gushou)
sfofl_soldier:addSkill(sfofl_xinkui)


sfofl_4_caocao = sgs.General(extension_e, "sfofl_4_caocao$", "wei", 4)
--[[
	技能名：定乱
	相关武将：曹操[官盗]
	技能描述：出牌阶段限一次，你可以失去1点体力，令一名其他角色选择一项：1.视为你对其使用一张【大军压境】；2.其武将牌上的技能失效直到其回合结束。
	引用：sfofl_dingluan
]] --

sfofl_dingluanCard = sgs.CreateSkillCard{
    name = "sfofl_dingluan",
    will_throw = false,
    on_effect = function(self,effect)
        local from,to = effect.from,effect.to
        local room = from:getRoom()
        room:loseHp(from,1,true,from,self:objectName())
        local choice = room:askForChoice(from, self:objectName(), "BearingDownBorder="..to:objectName().."+skill="..to:objectName(), ToData(to))
        if string.startsWith(choice, "BearingDownBorder") then
            local BearingDownBorder = sgs.Sanguosha:cloneCard("_sfofl_bearing_down_border", sgs.Card_NoSuit, 0)
            BearingDownBorder:setSkillName("sfofl_dingluan")
            BearingDownBorder:deleteLater()
            local card_use = sgs.CardUseStruct()
            card_use.card = BearingDownBorder
            card_use.from = from
            card_use.to:append(to)
            room:useCard(card_use, false)
        elseif string.startsWith(choice, "skill") then
            local skills = {}
            for _,sk in sgs.list(to:getSkillList())do
                if sk:isAttachedLordSkill() then continue end
                if to:getMark("Qingcheng"..sk:objectName()) == 0 then
                    room:addPlayerMark(to, "Qingcheng"..sk:objectName(), 1)
                    room:addPlayerMark(to, "sfofl_dingluan_"..sk:objectName(), 1)
                end
            end
            room:addPlayerMark(to, "&sfofl_dingluan+to+#"..from:objectName().."-SelfClear")
        end
    end
}

sfofl_dingluan = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_dingluan",
    waked_skills = "_sfofl_bearing_down_border",
	view_as = function(self) 
		return sfofl_dingluanCard:clone()
	end, 
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_dingluan")
    end
}

sfofl_dingluan_Clear = sgs.CreateTriggerSkill{
    name = "#sfofl_dingluan_Clear",
    events = {sgs.EventPhaseStart},
    frequency = sgs.Skill_NotFrequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if player:getPhase() ~= sgs.Player_NotActive then return false end
        for _,sk in sgs.list(player:getSkillList())do
            if sk:isAttachedLordSkill() then continue end
            if player:getMark("sfofl_dingluan_"..sk:objectName()) > 0 then
                room:removePlayerMark(player, "sfofl_dingluan_"..sk:objectName(), 1)
                room:removePlayerMark(player, "Qingcheng"..sk:objectName(), 1)
            end
        end
    end,
    can_trigger = function(self, target)
        return target ~= nil
    end,
}


--[[
	技能名：遣将
	相关武将：曹操[官盗]
	技能描述：主公技，当一名角色阵亡后，你可以令一名魏势力角色与其交换座次。
	引用：sfofl_qianjiang
]] --

sfofl_qianjiang = sgs.CreateTriggerSkill{
    name = "sfofl_qianjiang$",
	events = {sgs.Death},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.Death then
		    local death = data:toDeath()
		    if death.who:objectName() == player:objectName() then return false end
		    if not player:hasLordSkill(self:objectName()) then return false end
            local targets = room:getLieges("wei", player)
            if targets:contains(death.who) then
                targets:removeOne(death.who)
            end
            if not targets:isEmpty() then
                room:setTag("sfofl_qianjiang", data)
                local target = room:askForPlayerChosen(player,targets,"sfofl_qianjiang","sfofl_qianjiang-invoke",true, true)
                room:removeTag("sfofl_qianjiang")
                if target then
				    if target~=death.who then room:swapSeat(target,death.who) end
                end
            end
		end
	end,
}

--[[
	技能名：大军压境
	相关武将：曹操[官盗]
	技能描述：出牌阶段，对一名角色使用，其他所有角色依次选择是否将一张牌当一张无距离限制的【杀】对其使用。
	引用：sfofl_bearing_down_border
]] --
sfofl_bearing_down_border = sgs.CreateTrickCard{
	name = "_sfofl_bearing_down_border",
	class_name = "BearingDownBorder",
	subclass = sgs.LuaTrickCard_TypeSingleTargetTrick,
    target_fixed = false,
	can_recast = false,
	is_cancelable = true,
    available = function(self,player)
    	local tos = player:getAliveSiblings()
		tos:append(player)
		for _,to in sgs.list(tos)do
			if CanToCard(self,player,to) then
				return self:cardIsAvailable(player)
			end
		end
    end,
    filter = function(self,targets,to_select,source)
	    return #targets<sgs.Sanguosha:correctCardTarget(sgs.TargetModSkill_ExtraTarget,source,self)
		and not source:isProhibited(to_select,self) and source:objectName() ~= to_select:objectName()
	end,
	about_to_use = function(self,room,use)
	    self:cardOnUse(room,use)
	end,
	on_effect = function(self,effect)
		local to,source,room = effect.to,effect.from,effect.to:getRoom()
		for _, p in sgs.qlist(room:getOtherPlayers(to)) do
            if p:objectName() == source:objectName() then continue end
            local card = room:askForCard(p, ".", "@sfofl_bearing_down_border:"..to:objectName(), ToData(to), sgs.Card_MethodNone) 
            if card then
                local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                slash:setSkillName("BearingDownBorder")
                slash:addSubcard(card)
                slash:deleteLater()
                local card_use = sgs.CardUseStruct()
                card_use.card = slash
                card_use.from = p
                card_use.to:append(to)
                room:useCard(card_use, false)
            end
            if not to:isAlive() then
                break
            end
        end
	end
}


sfofl_4_caocao:addSkill(sfofl_dingluan)
sfofl_4_caocao:addSkill(sfofl_dingluan_Clear)
extension_e:insertRelatedSkills("sfofl_dingluan", "#sfofl_dingluan_Clear")
sfofl_4_caocao:addSkill(sfofl_qianjiang)
sfofl_bearing_down_border:setParent(extension_card)


sfofl_hansui = sgs.General(extension_e, "sfofl_hansui$", "qun", 5, true, false, false, 4)
--[[
	技能名：举兵
	相关武将：韩遂[官盗]
	技能描述：每回合限一次，当一名角色受到伤害后，若其在群势力角色的攻击范围内，你可以弃置这些角色各一张牌，视为你对受伤角色使用X张【杀】（X为你以此法弃置的牌数）。
	引用：sfofl_jubing
]] --
sfofl_jubing = sgs.CreateTriggerSkill {
	name = "sfofl_jubing",
	events = { sgs.Damaged },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.Damaged then
			local damage = data:toDamage()
			if damage.to:isDead() then
				return false
			end
			local from = damage.from
            for _, hansui in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                if hansui:getMark("sfofl_jubing-Clear") > 0 then continue end
                local targets = sgs.SPlayerList()
                for _, p in sgs.qlist(room:getAllPlayers()) do
                    if p:getKingdom() == "qun" and p:inMyAttackRange(damage.to) and hansui:canDiscard(p, "he") then
                        targets:append(p)
                    end
                end
                if targets:length() > 0 and room:askForSkillInvoke(hansui, self:objectName(), data) then
                    room:addPlayerMark(hansui, "sfofl_jubing-Clear")
                    room:addPlayerMark(hansui, "&sfofl_jubing-Clear")
                    local x = 0
                    for _, p in sgs.qlist(targets) do
                        local to_throw = room:askForCardChosen(hansui, p, "he", self:objectName(), false, sgs.Card_MethodDiscard)
                        local card = sgs.Sanguosha:getCard(to_throw)
                        room:throwCard(card, p, hansui)
                        x = x + 1
                    end
                    for i = 1 , x, 1 do
                        local card = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                        card:deleteLater()
                        card:setSkillName(self:objectName())
                        local use = sgs.CardUseStruct()
                        use.card = card
                        use.from = hansui
                        use.to:append(damage.to)
                        room:useCard(use)
                        if not damage.to:isAlive() then break end
                    end
                end
            end
		end
	end,
	can_trigger = function(self, target)
		return target ~= nil
	end
}

--[[
	技能名：雄踞
	相关武将：韩遂[官盗]
	技能描述：主公技，与你势力相同的角色视为拥有技能“马术”。
	引用：sfofl_2_xiongju
]] --
sfofl_2_xiongju_distance=sgs.CreateDistanceSkill{
	name="#sfofl_2_xiongju_distance",
	correct_func=function(self,from,to)
        for _, p in sgs.qlist(from:getAliveSiblings(true)) do
            if p:hasLordSkill("sfofl_2_xiongju") and p:getRole() == "Lord" then
                if from:getKingdom() == p:getKingdom() then
                    return -1
                end
            end
        end
        return 0
	end,
}
sfofl_2_xiongju_mashu=sgs.CreateDistanceSkill{
	name="sfofl_2_xiongju_mashu&",
	correct_func=function(self,from,to)
        return 0
	end,
}

sfofl_2_xiongju = sgs.CreateTriggerSkill{
    name = "sfofl_2_xiongju$",
	events = {sgs.GameStart,sgs.EventAcquireSkill, sgs.KingdomChanged},
    waked_skills = "sfofl_2_xiongju_mashu",
	on_trigger = function(self, event, player, data)
	    local room = player:getRoom()
        if player:hasLordSkill(self:objectName()) and (event == sgs.GameStart or (event == sgs.EventAcquireSkill and data:toString() == "sfofl_2_xiongju")) then
		--游戏开始时或获得技能时，每个人发一个技能
            for _, p in sgs.qlist(room:getLieges(player:getKingdom(), player)) do
                if not p:hasSkill("sfofl_2_xiongju_mashu") then
                    room:handleAcquireDetachSkills(p, "sfofl_2_xiongju_mashu")
                end
            end
        end
        if event == sgs.KingdomChanged then
            if player:hasLordSkill(self:objectName()) then
                for _, p in sgs.qlist(room:getAllPlayers()) do
                    room:handleAcquireDetachSkills(p, "-sfofl_2_xiongju_mashu")
                end
                for _, p in sgs.qlist(room:getLieges(player:getKingdom(), player)) do
                    if not p:hasSkill("sfofl_2_xiongju_mashu") then
                        room:handleAcquireDetachSkills(p, "sfofl_2_xiongju_mashu")
                    end
                end
            end
            
        end
	end,
    can_trigger = function(self,target)
		return target and target:isAlive()
	end,
}



sfofl_hansui:addSkill(sfofl_jubing)
sfofl_hansui:addSkill(sfofl_2_xiongju_distance)
sfofl_hansui:addSkill(sfofl_2_xiongju)
extension_e:insertRelatedSkills("sfofl_2_xiongju", "#sfofl_2_xiongju_distance")
if not sgs.Sanguosha:getSkill("sfofl_2_xiongju_mashu&") then skills:append(sfofl_2_xiongju_mashu) end

sfofl_xuhuang = sgs.General(extension_e, "sfofl_xuhuang", "wei", 4)
--[[
	技能名：驻营
	相关武将：徐晃[官盗]
	技能描述：每名角色的结束阶段，若你本回合未成为过其使用牌的目标，你获得一枚“驻”标记。
	引用：sfofl_zhuying
]] --
sfofl_zhuying = sgs.CreateTriggerSkill{
	name = "sfofl_zhuying",
	events = {sgs.CardUsed, sgs.EventPhaseStart},
	on_trigger = function(self,event,player,data,room)
		if event==sgs.CardUsed	then
			local use = data:toCardUse()
			if not use.card:isKindOf("SkillCard")	then
				for i,to in sgs.list(use.to)do
					room:addPlayerMark(to,"sfofl_zhuying-Clear")
				end
			end
        elseif event == sgs.EventPhaseStart then
            if player:getPhase() == sgs.Player_Finish then
                for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if p:getMark("sfofl_zhuying-Clear") == 0 then
                        room:addPlayerMark(p,"&sfofl_zhuying")
                    end
                end
            end
		end
		return false
	end,
    can_trigger = function(self,target)
		return target and target:isAlive()
	end,
}

--[[
	技能名：驰援
	相关武将：徐晃[官盗]
	技能描述：出牌阶段，你可以交给任意名角色各一枚“驻”标记。有“驻”标记的角色受到伤害时，你可以弃置一张牌，然后选择一项：1.防止此伤害，然后移除其一枚“驻”标记；2.对伤害来源造成1点伤害。
	引用：sfofl_chiyuan
]] --

sfofl_chiyuanCard = sgs.CreateSkillCard {
	name = "sfofl_chiyuan",
	target_fixed = false,
    will_throw = false,
	filter = function(self, targets, to_select)
		if #targets < sgs.Self:getMark("&sfofl_zhuying") then
			return to_select:getMark("&sfofl_zhuying+to+#"..sgs.Self:objectName()) == 0
		end
        return false
	end ,
    on_effect = function(self,effect)
        local from,to = effect.from,effect.to
        local room = from:getRoom()
        room:addPlayerMark(to, "&sfofl_zhuying+to+#"..from:objectName())
        room:removePlayerMark(from, "&sfofl_zhuying")
	end
}
sfofl_chiyuanVS = sgs.CreateViewAsSkill {
	name = "sfofl_chiyuan",
	n = 0,
	view_filter = function(self, selected, to_select)
		return false
	end,
	view_as = function(self, cards)
		if #cards == 0 then
			return sfofl_chiyuanCard:clone()
		end
	end,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_chiyuan")
	end,
}
sfofl_chiyuan = sgs.CreateTriggerSkill {
	name = "sfofl_chiyuan",
    view_as_skill = sfofl_chiyuanVS,
	events = { sgs.DamageInflicted },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
        local damage = data:toDamage()
        local function tryPreventOrRedirect(target, markname)
            room:setTag("sfofl_chiyuan", data)
            if target:canDiscard(target, "he") and room:askForDiscard(target, self:objectName(), 1, 1, true, true, "@sfofl_chiyuan:"..player:objectName()) then
                local choicelist = {"prevented"}
                if damage.from and damage.from:isAlive() then
                    table.insert(choicelist, "damage="..damage.from:objectName())
                end
                local choice = room:askForChoice(target, self:objectName(), table.concat(choicelist, "+"), data)
                room:sendCompulsoryTriggerLog(target, self:objectName(), true)
                if choice == "prevented" then
                    damage.damage = 0
                    damage.prevented = true
                    data:setValue(damage)
                    return true
                else
                    room:damage(sgs.DamageStruct(self:objectName(),  target, damage.from))
                end
            end
            return false
        end
        
       
        for _, m in sgs.list(player:getMarkNames()) do
            if m:startsWith("&sfofl_zhuying") and player:getMark(m) > 0 then
                if player:hasSkill(self:objectName()) and tryPreventOrRedirect(player, m) then
                    room:removePlayerMark(player, "&sfofl_zhuying")
                    room:removeTag("sfofl_chiyuan")
                    return true
                end
                for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if player:objectName() == p:objectName() then continue end
                    if string.find(m, p:objectName()) then
                        if tryPreventOrRedirect(p, m) then
                            room:setPlayerMark(player, "&sfofl_zhuying+to+#"..p:objectName(), 0)
                            room:removeTag("sfofl_chiyuan")
                            return true
                        end
                    end
                end
            end
        end
		return false
	end,
    can_trigger = function(self, target)
		return target
	end
}
sfofl_xuhuang:addSkill(sfofl_zhuying)
sfofl_xuhuang:addSkill(sfofl_chiyuan)

sfofl_yangqiu = sgs.General(extension_e, "sfofl_yangqiu", "qun", 5)
--[[
	技能名：齐锋
	相关武将：杨秋[官盗]
	技能描述：每个回合结束时，若你本回合失去过牌，你可以视为对其使用一张伤害基数值为X的【杀】（X为你本回合失去过的牌数）。
	引用：sfofl_qifeng
]] --

sfofl_qifengVS = sgs.CreateViewAsSkill {
	name = "sfofl_qifeng",
    n = 0,
	view_as = function(self,cards)
        local Slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
        Slash:setSkillName(self:objectName())
        return Slash
	end,
	enabled_at_play = function(self, player)
		return false
	end,
	enabled_at_response = function(self, player, pattern)
		return (pattern == "@@sfofl_qifeng") 
	end
}
sfofl_qifeng = sgs.CreateTriggerSkill{
	name = "sfofl_qifeng",
	view_as_skill = sfofl_qifengVS,
	events = {sgs.EventPhaseChanging, sgs.CardsMoveOneTime, sgs.ConfirmDamage},
	on_trigger = function(self, event, player, data, room)
        if event==sgs.EventPhaseChanging and data:toPhaseChange().to==sgs.Player_NotActive then
            for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                if player:objectName() ~= p:objectName() and  p:getMark("sfofl_qifeng-Clear") > 0 then
                    room:setPlayerFlag(p, "slashTargetFix")
					room:setPlayerFlag(p, "slashNoDistanceLimit")
					room:setPlayerFlag(p, "slashTargetFixToOne")
					room:setPlayerFlag(player, "SlashAssignee")
                    room:askForUseCard(p, "@@sfofl_qifeng", "@sfofl_qifeng:"..player:objectName()..":"..p:getMark("sfofl_qifeng-Clear"), -1, sgs.Card_MethodUse)
                    room:setPlayerFlag(p, "-slashTargetFix")
                    room:setPlayerFlag(p, "-slashNoDistanceLimit")
                    room:setPlayerFlag(p, "-slashTargetFixToOne")
                    room:setPlayerFlag(player, "-SlashAssignee")
                end
            end
        elseif event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
			if (move.from and (move.from:objectName() == player:objectName()) and (move.from_places:contains(sgs.Player_PlaceHand) or  move.from_places:contains(sgs.Player_PlaceEquip))) and not (move.to and (move.to:objectName() == player:objectName() and (move.to_place == sgs.Player_PlaceHand or move.to_place == sgs.Player_PlaceEquip))) then
                if player:hasSkill(self:objectName()) then
                    room:addPlayerMark(player, "sfofl_qifeng-Clear", move.card_ids:length())
                    room:addPlayerMark(player, "&sfofl_qifeng-Clear", move.card_ids:length())
                end
            end
        elseif event == sgs.ConfirmDamage then
		    local damage = data:toDamage()
            if damage.card and damage.from
			and damage.from:objectName()==player:objectName() and player:getMark("sfofl_qifeng-Clear") > 0 and table.contains(damage.card:getSkillNames(), "sfofl_qifeng")
			then
				local owner = room:findPlayerBySkillName(self:objectName())
				owner = owner or player
				Skill_msg(self,owner)
                local x = player:getMark("sfofl_qifeng-Clear")
				if x~=damage.damage
				then x = x-damage.damage
				else x = 0 end
    	        owner:damageRevises(data,x)
			end
        end
		return false
	end,
    can_trigger = function(self, target)
		return target
	end
}

sfofl_yangqiu:addSkill(sfofl_qifeng)



sfofl_chengyi = sgs.General(extension_e, "sfofl_chengyi", "qun", 4)
--[[
	技能名：独探
	相关武将：成宜[官盗]
	技能描述：出牌阶段限一次，你可以视为使用一张指定任意名角色为目标的【决斗】。
	引用：sfofl_dutan
]] --

sfofl_dutanCard = sgs.CreateSkillCard{
	name = "sfofl_dutan",
	target_fixed = false,
	will_throw = true,
	filter = function(self, targets, to_select) --必须
        local card = sgs.Sanguosha:cloneCard("duel", sgs.Card_SuitToBeDecided, -1)
        card:deleteLater()
        card:setSkillName(self:objectName())
        card:deleteLater()
	    local qtargets = sgs.PlayerList()
		if to_select:objectName() ~= sgs.Self:objectName() then
			return not sgs.Self:isProhibited(to_select, card, qtargets)
		end
	end,
	on_use = function(self, room, source, targets) 
		if #targets > 0 then
			local card = sgs.Sanguosha:cloneCard("duel", sgs.Card_NoSuit, 0)
			card:setSkillName(self:objectName())
			card:deleteLater()
			local use = sgs.CardUseStruct()
			use.from = source
			for _,target in ipairs(targets) do
				use.to:append(target)
			end
			use.card = card
			room:useCard(use, false)
		end
	end,
}
sfofl_dutan = sgs.CreateViewAsSkill{
	name = "sfofl_dutan",
	n = 0,
	view_as = function(self, cards)
	if #cards == 0 then 
		local card = sfofl_dutanCard:clone()
		card:setSkillName(self:objectName())
		return card
		end
	end,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_dutan")
	end,
}

sfofl_chengyi:addSkill(sfofl_dutan)

sfofl_houxuan = sgs.General(extension_e, "sfofl_houxuan", "qun", 4)
--[[
	技能名：众讨
	相关武将：侯选[官盗]
	技能描述：与你距离1以内的角色使用【杀】结算结束后，你可以将一张牌当【杀】对相同的目标角色使用。
	引用：sfofl_zhongtao
]] --
sfofl_zhongtaoVS = sgs.CreateOneCardViewAsSkill {
	name = "sfofl_zhongtao",
	filter_pattern = ".",
	response_pattern = "@@sfofl_zhongtao",
	view_as = function(self, card)
		local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
		slash:addSubcard(card)
		slash:setSkillName("sfofl_zhongtao")
		return slash
	end,
}
sfofl_zhongtao = sgs.CreateTriggerSkill {
    name = "sfofl_zhongtao",
    events = { sgs.CardFinished },
    view_as_skill = sfofl_zhongtaoVS,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local use = data:toCardUse()
        if use.card:isKindOf("Slash") then
            for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                if p:objectName() ~= use.from:objectName() and p:distanceTo(player) <= 1 then
                    room:setPlayerFlag(p, "slashTargetFix")
					room:setPlayerFlag(p, "slashNoDistanceLimit")
					room:setPlayerFlag(p, "slashDisableExtraTarget")
                    for _, target in sgs.qlist(use.to) do
					    room:setPlayerFlag(target, "SlashAssignee")
                    end
					local slash = room:askForUseCard(p, "@@sfofl_zhongtao", "@sfofl_zhongtao")
					if slash == nil then
						room:setPlayerFlag(p, "-slashDisableExtraTarget")
						room:setPlayerFlag(p, "-slashTargetFix")
						room:setPlayerFlag(p, "-slashNoDistanceLimit")
						for _, target in sgs.qlist(use.to) do
                            room:setPlayerFlag(target, "-SlashAssignee")
                        end
					end
                end
            end
        end
    end,
    can_trigger = function(self, target)
		return target
	end
}

sfofl_houxuan:addSkill(sfofl_zhongtao)

sfofl_zhanghe = sgs.General(extension_e, "sfofl_zhanghe", "wei", 4)
--[[
	技能名：巧变
	相关武将：张郃[官盗]
	技能描述：其他角色的准备阶段，你可以将一张牌扣置于你的武将牌上，称为“巧”。当其本回合使用牌后，你展示“巧”，若“巧”与此牌类别：相同，其获得“巧”，然后结束出牌阶段；不同，你摸一张牌。本回合结束阶段，你将“巧”收回手牌。
	引用：sfofl_qiaobian
]] --
sfofl_qiaobian = sgs.CreateTriggerSkill{
	name = "sfofl_qiaobian",
	events = {sgs.EventPhaseStart, sgs.CardFinished},
	on_trigger = function(self, event, player, data, room)
        if event == sgs.EventPhaseStart then
            if player:getPhase() == sgs.Player_Start then 
                for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if p:getSeat() ~= player:getSeat() and not p:isNude() then
                        local card = room:askForExchange(p, self:objectName(), 1, 1, true, "@sfofl_qiaobian", true)
                        if card then
                            local card_id = card:getSubcards():first()
                            local splayers = sgs.SPlayerList()
                            splayers:append(p)
                            p:addToPile("sfofl_qiaobian", card_id, false, splayers)
                        end
                    end
                end
            elseif player:getPhase() == sgs.Player_Finish then
                for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if p:getSeat() ~= player:getSeat() then
                        if not p:getPile("sfofl_qiaobian"):isEmpty() then
                            local obtain = sgs.Sanguosha:cloneCard("jink", sgs.Card_SuitToBeDecided, -1)
                            obtain:addSubcards(p:getPile("sfofl_qiaobian"))
                            room:obtainCard(p, obtain, false)
                            obtain:deleteLater()
                        end
                    end
                end
            end
        else
            local use = data:toCardUse()
            if use.card and not use.card:isKindOf("SkillCard") then
                for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if p:getSeat() ~= player:getSeat() then
                        if not p:getPile("sfofl_qiaobian"):isEmpty() then
                            room:showCard(p, p:getPile("sfofl_qiaobian"):first())
                            local card = sgs.Sanguosha:getCard(p:getPile("sfofl_qiaobian"):first())
                            if card:getType() == use.card:getType() then
                                local obtain = sgs.Sanguosha:cloneCard("jink", sgs.Card_SuitToBeDecided, -1)
                                obtain:addSubcards(player:getPile("sfofl_zhoubing"))
                                room:obtainCard(player, obtain, false)
                                obtain:deleteLater()
                                player:endPlayPhase(true)
                            else
                                p:drawCards(1, self:objectName())
                            end
                        end
                    end
                end
            end
        end
	end,
	can_trigger = function()
		return true
	end
}

sfofl_zhanghe:addSkill(sfofl_qiaobian)

sfofl_zhuling = sgs.General(extension_e, "sfofl_zhuling", "wei", 4)
--[[
	技能名：战意
	相关武将：朱灵[官盗]
	技能描述：出牌阶段限一次，你可以失去1点体力并弃置一张基本牌或普通锦囊牌，然后你本回合该类别的牌额外结算一次。
	引用：sfofl_zhanyi
]] --

sfofl_zhanyiCard = sgs.CreateSkillCard {
    name = "sfofl_zhanyi",
    target_fixed = true,
    will_throw = true,
    on_use = function(self, room, source, targets)
        room:loseHp(source,1,true,source,self:objectName())
        room:addPlayerMark(source, "&sfofl_zhanyi+"..sgs.Sanguosha:getCard(self:getSubcards():first()):getType().."-Clear")
        room:addPlayerMark(source, "sfofl_zhanyi+"..sgs.Sanguosha:getCard(self:getSubcards():first()):getType().."-Clear")
    end
}
sfofl_zhanyiVS = sgs.CreateViewAsSkill {
    name = "sfofl_zhanyi",
    n = 1,
    view_filter = function(self, selected, to_select)
        return to_select:isKindOf("BasicCard") or to_select:isKindOf("TrickCard")
    end,
    view_as = function(self, cards)
        if #cards > 0 then
            local card = sfofl_zhanyiCard:clone()
            for _, c in pairs(cards) do
                card:addSubcard(c)
            end
            card:setSkillName(self:objectName())
            return card
        end
    end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_zhanyi")
    end
}

sfofl_zhanyi = sgs.CreateTriggerSkill {
    name = "sfofl_zhanyi",
    events = { sgs.CardFinished, sgs.CardUsed },
    view_as_skill = sfofl_zhanyiVS,
    on_trigger = function(self, event, player, data, room)
        local room = player:getRoom()
        if event == sgs.CardFinished then
            --处理额外结算
            local use = data:toCardUse()
            if (not use.card:hasFlag("sfofl_zhanyi")) then return false end
            room:setCardFlag(use.card, "-sfofl_zhanyi")
            if use.from:objectName() == player:objectName() then
                local targets = sgs.SPlayerList()
                for _,to in sgs.qlist(use.to) do
                    if to:isAlive() then
                        targets:append(to)
                    end
                end
                if (not targets:isEmpty()) then
                    local use_again = sgs.CardUseStruct(use.card,player,targets)
				    room:setTag("UseHistory"..use.card:toString(),ToData(use_again))
				    use.card:use(room,player,targets)
                end
            end
        elseif event == sgs.CardUsed then
            local use = data:toCardUse()
            if use.card:isKindOf("SkillCard") then return false end
            for _,m in ipairs(player:getMarkNames()) do
                if (string.find(m,"sfofl_zhanyi") or string.find(m,"&sfofl_zhanyi")) and (player:getMark(m) > 0) and (string.find(m, use.card:getType())) then
                    room:setPlayerMark(player, m, 0)
                    room:setCardFlag(use.card, "sfofl_zhanyi")
                end
            end
        end
    end,
}

sfofl_zhuling:addSkill(sfofl_zhanyi)

sfofl_3_jiaxu = sgs.General(extension_e, "sfofl_3_jiaxu", "wei", 3)
--[[
	技能名：间书
	相关武将：贾诩[官盗]
	技能描述：出牌阶段限一次，你可以将一张牌交给一名其他角色，然后选择另一名其他角色，令这两名角色拼点：赢的角色弃置两张牌，没赢的角色失去1点体力。
	引用：sfofl_jianshu
]] --

sfofl_jianshuCard = sgs.CreateSkillCard{
    name = "sfofl_jianshu",
    will_throw = false,
    on_effect = function(self,effect)
        local from,to = effect.from,effect.to
        local room = from:getRoom()
        room:giveCard(from,to,self,"sfofl_jianshu")
        
        if from:isDead() then return end
        local targets = room:getOtherPlayers(from)
        if targets:contains(to) then
            targets:removeOne(to)
        end
        if targets:isEmpty() then return end
        
        local other = room:askForPlayerChosen(from,targets,self:objectName(),"@sfofl_jianshu-pindian:"..to:objectName())
        room:doAnimate(1,to:objectName(),other:objectName())
        if not to:canPindian(other,false) then return end
        
        local n = to:pindianInt(other,self:objectName())
        if n < -1 then return end
        
        local losers,winner = sgs.SPlayerList(),nil
        if n == -1 then
            winner = other
            losers:append(to)
        elseif n == 1 then
            winner = to
            losers:append(other)
        elseif n == 0 then
            losers:append(to)
            losers:append(other)
        end
        
        if winner then
            room:askForDiscard(winner, self:objectName(), 2, 2, false, true)
        end

        room:sortByActionOrder(losers)
        for _,p in sgs.qlist(losers)do
            room:loseHp(sgs.HpLostStruct(p,1,"sfofl_jianshu",from))
        end
    end
}

sfofl_jianshu = sgs.CreateOneCardViewAsSkill{
    name = "sfofl_jianshu",
    filter_pattern = ".|.|.|hand",
    view_as = function(self,card)
        local c = sfofl_jianshuCard:clone()
        c:addSubcard(card)
        return c
    end,
    enabled_at_play = function(self,player)
        return not player:hasUsed("#sfofl_jianshu")
    end
}

--[[
	技能名：缜略
	相关武将：贾诩[官盗]
	技能描述：当一名角色使用【无懈可击】时，你可以弃置一张牌，令此【无懈可击】无效并获得之
	引用：sfofl_zhenlue
]] --

sfofl_zhenlue = sgs.CreateTriggerSkill{
    name = "sfofl_zhenlue",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.CardUsed},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.CardUsed then
		    local use = data:toCardUse()
			if use.card:isKindOf("Nullification") then
                room:setTag("sfofl_zhenlue", data)
			    for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if p:canDiscard(p, "he") and room:askForDiscard(p, self:objectName(), 1, 1, true, true, "@sfofl_zhenlue:"..use.whocard:objectName()) then
				        room:notifySkillInvoked(p, self:objectName())
                        p:obtainCard(use.card)
                        local nullified_list = use.nullified_list
                        table.insert(nullified_list, "_ALL_TARGETS")
                        use.nullified_list = nullified_list
                        data:setValue(use)
                        break
                    end
                end
                room:removeTag("sfofl_zhenlue")
			end
		end
		return false
	end,
	can_trigger = function(self, target)
	    return target
	end
}

sfofl_3_jiaxu:addSkill(sfofl_jianshu)
sfofl_3_jiaxu:addSkill(sfofl_zhenlue)

sfofl_shenmachao = sgs.General(extension_e, "sfofl_shenmachao", "god", 5)
--[[
	技能名：御马
	相关武将：神马超[官盗]
	技能描述：每回合限一次，当一张坐骑牌进入弃牌堆后，你可以将之置入一名角色的装备区，然后获得其所有手牌。
	引用：sfofl_yuma
]] --

sfofl_yuma = sgs.CreateTriggerSkill{
    name = "sfofl_yuma",
    frequency = sgs.Skill_NotFrequent,
    events = { sgs.CardsMoveOneTime },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local move = data:toMoveOneTime()
        if (move.to_place ~= sgs.Player_DiscardPile) then return false end
        for _, id in sgs.qlist(move.card_ids) do
            local card = sgs.Sanguosha:getCard(id)
            if card:isKindOf("Horse") then
                for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if p:getMark(self:objectName().."-Clear") > 0 then continue end
                    if room:getCardPlace(id) == sgs.Player_DiscardPile then
                        local targets = sgs.SPlayerList()
                        local place = sgs.Player_PlaceEquip
                        local i = card:getRealCard():toEquipCard():location()
                        for _, p in sgs.qlist(room:getAlivePlayers()) do
                            if p:hasEquipArea(i) and not p:getEquip(i) then
                                targets:append(p)
                            end
                        end
                        if not targets:isEmpty() then
                            local ai_data = sgs.QVariant()
                            ai_data:setValue(id)
                            room:setTag("sfofl_yuma", ai_data)
                            local target = room:askForPlayerChosen(p, targets, self:objectName(), "sfofl_yuma-invoke", true, true)
                            room:removeTag("sfofl_yuma")
                            if target then
                                room:addPlayerMark(p, self:objectName().."-Clear")
                                room:addPlayerMark(p, "&"..self:objectName().."-Clear")
                                local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_PUT, p:objectName(),
                                    self:objectName(), "")
                                room:moveCardTo(card, target, place, reason)
                                if not target:isKongcheng() then
                                    local handcards = target:wholeHandCards()
                                    local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_EXTRACTION, player:objectName())
                                    room:obtainCard(p, handcards, reason, false)
                                end
                                break
                            end  
                        end
                    end
                end
            end
        end
        
        return false
    end
}

--[[
	技能名：枪术
	相关武将：神马超[官盗]
	技能描述：当你使用【杀】或【决斗】造成伤害时，你可以弃置X张牌，令此伤害+X（X为你的攻击范围-1）。
	引用：sfofl_qiangshu
]] --
sfofl_qiangshu = sgs.CreateTriggerSkill{
	name = "sfofl_qiangshu",
	events = {sgs.DamageCaused},
	on_trigger = function(self,event,player,data,room)
        local damage = data:toDamage()
        if damage.card and (damage.card:isKindOf("Slash") or damage.card:isKindOf("Duel")) then
            local x = player:getAttackRange() - 1
            if x>0 and player:canDiscard(player, "he") and player:getCardCount(true) >= x then
                room:setTag("sfofl_qiangshu", data)
                if room:askForDiscard(player, self:objectName(), x, x, true, true, "@sfofl_qiangshu:" .. x) then
                    damage.damage = damage.damage + x
                    local log = sgs.LogMessage()
                    log.type = "#skill_add_damage"
                    log.from = damage.from
                    log.to:append(damage.to)
                    log.arg  = self:objectName()
                    log.arg2 = damage.damage
                    room:sendLog(log)
                    data:setValue(damage)
                end
                room:removeTag("sfofl_qiangshu")
            end
        end
    return false
    end
}


sfofl_shenmachao:addSkill(sfofl_yuma)
sfofl_shenmachao:addSkill(sfofl_qiangshu)

sfofl_shenxuchu = sgs.General(extension_e, "sfofl_shenxuchu", "god", 5)
--[[
	技能名：膊战
	相关武将：神许褚[官盗]
	技能描述：其他角色的准备阶段，你可以废除一个装备栏，视为对其使用一张【决斗】。
	引用：sfofl_bozhan
]] --

sfofl_bozhan = sgs.CreateTriggerSkill{
	name = "sfofl_bozhan",
	events = {sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data, room)
		if player:getPhase() ~= sgs.Player_Start then return false end
		for _, s in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
			if s:getSeat() ~= player:getSeat() then
				if s:hasEquipArea() and room:askForSkillInvoke(s, self:objectName(), ToData(player)) then
                    ThrowEquipArea(self,s,false,false,0,4)
                    local duel = sgs.Sanguosha:cloneCard("duel", sgs.Card_NoSuit, 0)
                    duel:deleteLater()
                    duel:setSkillName("sfofl_bozhan")
                    local use = sgs.CardUseStruct()
                    use.from = s
                    use.card = duel
                    use.to:append(player)
                    room:useCard(use, false)
                end
			end
		end
	end,
	can_trigger = function()
		return true
	end
}

--[[
	技能名：羆威
	相关武将：神许褚[官盗]
	技能描述：锁定技，摸牌阶段，你多摸X张牌（X为你废除的装备栏数）。
	引用：sfofl_piwei
]] --
sfofl_piwei = sgs.CreateTriggerSkill {
    name = "sfofl_piwei",
    frequency = sgs.Skill_Compulsory,
    events = { sgs.DrawNCards },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local draw = data:toDraw()
        if draw.reason ~= "draw_phase" then return false end
        if event == sgs.DrawNCards then
            local x = 0
            for i = 1, 5 do
                if not player:hasEquipArea(i) then
                    x = x + 1
                end
            end
            draw.num = draw.num + x
            room:sendCompulsoryTriggerLog(player, "sfofl_piwei", true)
            data:setValue(draw)
        end
    end
}

sfofl_shenxuchu:addSkill(sfofl_bozhan)
sfofl_shenxuchu:addSkill(sfofl_piwei)


sfofl_xiaoji = sgs.General(extension_e, "sfofl_xiaoji", "qun", 4)
--[[
	技能名：铁蹄
	相关武将：骁骑[官盗]
	技能描述：锁定技，距离与你为1的角色不可响应你使用的杀。
	引用：sfofl_tieti
]] --

sfofl_tieti = sgs.CreateTriggerSkill {
    name = "sfofl_tieti",
    frequency = sgs.Skill_Compulsory,
    events = { sgs.TargetSpecified },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
      
      if event == sgs.TargetSpecified then
            local use = data:toCardUse()
            if (player:objectName() ~= use.from:objectName()) or (not use.card:isKindOf("Slash")) then return false end
            local jink_table = sgs.QList2Table(player:getTag("Jink_" .. use.card:toString()):toIntList())
            local index = 1
            for _, p in sgs.qlist(use.to) do
                if player:distanceTo(p) <= 1 then
                    local log = sgs.LogMessage()
                    log.type = "#skill_cant_jink"
                    log.from = player
                    log.to:append(p)
                    log.arg = self:objectName()
                    room:sendLog(log)
                    jink_table[index] = 0
                end
                index = index + 1
            end
            local jink_data = sgs.QVariant()
            jink_data:setValue(Table2IntList(jink_table))
            player:setTag("Jink_" .. use.card:toString(), jink_data)
            return false
        end
    end
}
sfofl_xiaoji:addSkill(sfofl_tieti)

sfofl_bubing = sgs.General(extension_e, "sfofl_bubing", "wei", 3, true, false, false, 3, 3)
--[[
	技能名：固卫
	相关武将：步兵[官盗]
	技能描述：距离与你为1的角色成为杀的目标时，你可以失去1点护甲，然后你代替成为此牌的目标。
	引用：sfofl_guwei
]] --
sfofl_guwei = sgs.CreateTriggerSkill{
    name = "sfofl_guwei",
	events = {sgs.TargetConfirming},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.TargetConfirming then
			local use = data:toCardUse()
			if use.from and use.card and use.card:isKindOf("Slash") then
				for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if p:distanceTo(player) <= 1 and p:getHujia() > 0 and p:objectName() ~= player:objectName() then
                        room:setPlayerFlag(player, "sfofl_guwei_target")
                        if room:askForSkillInvoke(p, self:objectName(), data) then
                            room:setPlayerFlag(p, "-sfofl_guwei_target")
                            p:loseHujia(1)
                            use.to:append(p)
                            use.to:removeOne(player)
                            room:sortByActionOrder(use.to)
                            data:setValue(use)
                            break
                        end
                        room:setPlayerFlag(player, "-sfofl_guwei_target")
                    end
				end
			end
		end
		return false
	end,
    can_trigger = function()
		return true
	end
}

sfofl_bubing:addSkill(sfofl_guwei)

sfofl_caesar = sgs.General(extension_e, "sfofl_caesar$", "west", 4)

--[[
	技能名：独裁
	相关武将：凯撒[欧陆]
	技能描述：持恒技，你的回合内使用牌无距离次数限制，其他角色不能使用牌且所有技能失效。
	引用：sfofl_ducai
]] --

sfofl_ducai = sgs.CreateTargetModSkill{
	name = "sfofl_ducai",
	distance_limit_func = function(self, from, card, to)
		if from and from:hasSkill("sfofl_ducai") and from:getPhase() ~= sgs.Player_NotActive then
			return 999
		else
			return 0
		end
	end,
    residue_func = function(self, from, card, to)
        if from and from:hasSkill("sfofl_ducai") and from:getPhase() ~= sgs.Player_NotActive then
			return 999
		else
			return 0
		end
    end,
}

sfofl_ducaiInvalidity = sgs.CreateInvaliditySkill{
	name = "#sfofl_ducaiInvalidity",
	skill_valid = function(self, player, skill)
        for _, p in sgs.qlist(player:getAliveSiblings()) do
			if p:hasSkill("sfofl_ducai") and p:hasFlag("CurrentPlayer") then
                return false
            end
		end
        return true
	end
}
sfofl_ducai_limit = sgs.CreateCardLimitSkill{
    name = "#sfofl_ducai_limit",
    limit_list = function(self, player)
        for _, p in sgs.qlist(player:getAliveSiblings()) do
			if p:hasSkill("sfofl_ducai") and p:hasFlag("CurrentPlayer") then
                return "use"
            end
        end
        return ""
    end,
    limit_pattern = function(self, player)
        for _, p in sgs.qlist(player:getAliveSiblings()) do
			if p:hasSkill("sfofl_ducai") and p:hasFlag("CurrentPlayer") then
                return ".|.|.|."
            end
        end
        return ""
    end,
}
sfofl_ducai:setProperty("IgnoreInvalidity",ToData(true))

--[[
	技能名：治统
	相关武将：凯撒[欧陆]
	技能描述：转换技，当你使用牌时，若目标为①自己，摸两张牌目回复1点体力；②其他角色，你获得其装备区所有牌并对其造成1点伤害。
	引用：sfofl_zhitong
]] --
sfofl_zhitong = sgs.CreateTriggerSkill{
    name = "sfofl_zhitong",
	frequency = sgs.Skill_Frequent,
    change_skill = true,
	events = {sgs.CardUsed},
	on_trigger = function(self, event, player, data)
	    local room = player:getRoom()
		if event == sgs.CardUsed then
			local use = data:toCardUse()
			if use.card and not use.card:isKindOf("SkillCard") and use.to:length() > 0 then
				if player:getChangeSkillState(self:objectName()) <= 1 then
                    if use.to:first():objectName() == player:objectName() then
                        room:recover(player, sgs.RecoverStruct(self:objectName(), player, 1))
                        player:drawCards(2, self:objectName())
                        room:setChangeSkillState(player, self:objectName(), 2)
                    end
                else
                    if not use.to:contains(player) then
                        for _, p in sgs.qlist(use.to) do
                            if p:getEquips():length() > 0 then
                                local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                                local cards = p:getCards("e")
                                for _,card in sgs.qlist(cards) do
                                    dummy:addSubcard(card)
                                end
                                if cards:length() > 0 then
                                    room:obtainCard(player, dummy, false)
                                end
                                dummy:deleteLater()
                            end
                            room:damage(sgs.DamageStruct(self:objectName(), player, p))
                        end
                        room:setChangeSkillState(player, self:objectName(), 1)
                    end
                end
			end
        end
    end
}

--[[
	技能名：集权
	相关武将：凯撒[欧陆]
	技能描述：主公技，锁定技，西势力角色的回合开始时，你回复1点并摸一张牌。
	引用：sfofl_jiquan
]] --
sfofl_jiquan = sgs.CreateTriggerSkill{
	name = "sfofl_jiquan$",
	frequency = sgs.Skill_Frequent,
	events = {sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Start then
            for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                if p:hasLordSkill(self:objectName()) then
                    room:recover(p, sgs.RecoverStruct(self:objectName(), p, 1))
                    p:drawCards(1, self:objectName())
                end
            end
        end
    end,
    can_trigger = function(self, target)
        return target and target:getKingdom() == "west"
    end,
}



sfofl_caesar:addSkill(sfofl_ducai)
sfofl_caesar:addSkill(sfofl_ducaiInvalidity)
sfofl_caesar:addSkill(sfofl_ducai_limit)
extension_e:insertRelatedSkills("sfofl_ducai", "#sfofl_ducaiInvalidity")
extension_e:insertRelatedSkills("sfofl_ducai", "#sfofl_ducai_limit")
sfofl_caesar:addSkill(sfofl_zhitong)
sfofl_caesar:addSkill(sfofl_jiquan)

sfofl_macrinus = sgs.General(extension_e, "sfofl_macrinus", "west", 4)
--[[
	技能名：登天
	相关武将：马克里努斯[欧陆]
	技能描述：锁定技，每轮开始时，你选择以下一个选项的数值+1：\
    1.摸牌阶段摸牌数；2.手牌上限；3。每回合首次造成的伤害数。
	引用：sfofl_dengtian
]] --

sfofl_dengtian_cardmax = sgs.CreateMaxCardsSkill {
	name = "#sfofl_dengtian_cardmax",
	extra_func = function(self, target)
		if target:hasSkill("sfofl_dengtian") and target:getMark("sfofl_dengtian_cardmax") > 0 then
			return target:getMark("sfofl_dengtian_cardmax")
		end
        return 0
	end
}
sfofl_dengtian = sgs.CreateTriggerSkill {
    name = "sfofl_dengtian",
    frequency = sgs.Skill_Frequent,
    events = { sgs.DrawNCards, sgs.RoundStart, sgs.DamageCaused },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.RoundStart then
            local choice = room:askForChoice(player, self:objectName(), "sfofl_dengtian_draw+sfofl_dengtian_cardmax+sfofl_dengtian_damage")
            room:addPlayerMark(player, choice)
            room:addPlayerMark(player, "&"..choice)
        elseif event == sgs.DrawNCards then
            local draw = data:toDraw()
            if draw.reason ~= "draw_phase" then return false end
            if player:getMark("sfofl_dengtian_draw") > 0 then
                draw.num = draw.num + player:getMark("sfofl_dengtian_draw")
                room:sendCompulsoryTriggerLog(player, "sfofl_dengtian", true)
                data:setValue(draw)
            end
        elseif event == sgs.DamageCaused then
            local damage = data:toDamage()
            if player:getMark("sfofl_dengtian-Clear") == 0 then
                room:addPlayerMark(player, "sfofl_dengtian-Clear")
                damage.damage = damage.damage + player:getMark("sfofl_dengtian_damage")
                local log = sgs.LogMessage()
                log.type = "#skill_add_damage"
                log.from = damage.from
                log.to:append(damage.to)
                log.arg  = self:objectName()
                log.arg2 = damage.damage
                room:sendLog(log)
                data:setValue(damage)
            end
        end
    end
}

--[[
	技能名：命数
	相关武将：马克里努斯[欧陆]
	技能描述：锁定技，当“登天”的某一选项【增加】的数值达到3或以上时，你失去X点体力（X为你的当前体力值）。
	引用：sfofl_mingshu
]] --
sfofl_mingshu = sgs.CreateTriggerSkill{
	name = "sfofl_mingshu",
	events = {sgs.MarkChanged},
	on_trigger = function(self,event,player,data)
	    local room = player:getRoom()
		if event == sgs.MarkChanged then
			local mark = data:toMark()
			if string.startsWith(mark.name, "sfofl_dengtian") and mark.gain > 0 then
			    if player:getMark(mark.name) >= 3 then
                    room:sendCompulsoryTriggerLog(player, self:objectName(), true)
				    room:loseHp(player,player:getHp(),true,player,self:objectName())
				end
			end
		end
    end
}
--[[
	技能名：角斗
	相关武将：马克里努斯[欧陆]
	技能描述：当其他角色对你使用【杀】后，若你未受到此【杀】造成的伤害，你可以视为对其使用一张无距离限制的【杀】。
	引用：sfofl_juedou
]] --

sfofl_juedou = sgs.CreateTriggerSkill {
    name = "sfofl_juedou",
    events = { sgs.CardFinished },
    on_trigger = function(self, event, player, data, room)
        local room = player:getRoom()
        if event == sgs.CardFinished then
            local use = data:toCardUse()
            if use.card and not use.card:isKindOf("SkillCard") and use.card:isKindOf("Slash") then
                for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if use.to:contains(p) and p:objectName() ~= use.from:objectName() and not use.card:hasFlag("DamageDone_"..p:objectName()) then
                        local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, -1)
                        slash:setSkillName("sfofl_juedou")
                        slash:deleteLater()
                        if p:canSlash(use.from, slash, true) and not p:isProhibited(use.from, slash) and room:askForSkillInvoke(p, self:objectName(), ToData(use.from)) then
                            room:useCard(sgs.CardUseStruct(slash, p, use.from))
                        end
                    end
                end
            end
        end
    end,
    can_trigger = function(self, target)
        return target
    end,
}


sfofl_macrinus:addSkill(sfofl_dengtian_cardmax)
sfofl_macrinus:addSkill(sfofl_dengtian)
extension_e:insertRelatedSkills("sfofl_dengtian", "#sfofl_dengtian_cardmax")
sfofl_macrinus:addSkill(sfofl_mingshu)
sfofl_macrinus:addSkill(sfofl_juedou)

sfofl_ardashirI = sgs.General(extension_e, "sfofl_ardashirI", "west", 4)
--[[
	技能名：万王
	相关武将：阿尔达希尔一世[欧陆]
	技能描述：每轮限一次，其他西势力的角色出牌阶段开始时，你可以代替其执行本阶段。
	引用：sfofl_wanwang
]] --

sfofl_wanwang = sgs.CreateTriggerSkill{
	name = "sfofl_wanwang",
	events = {sgs.EventPhaseStart},
	frequency = sgs.Skill_NotFrequent,
	on_trigger = function(self, event, player, data, room)
        if event == sgs.EventPhaseStart then
            if player:getPhase() == sgs.Player_Play then
                for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if p:getMark("sfofl_wanwang_lun") == 0 and p:objectName() ~= player:objectName() and room:askForSkillInvoke(p, self:objectName()) then
                        room:addPlayerMark(p, "sfofl_wanwang_lun")
                        PhaseExtra(p,sgs.Player_Play,true)
                        return true
                    end
                end
            end
        end
    end,
    can_trigger = function(self, target)
        return target and target:getKingdom() == "west"
    end,
}



--[[
	技能名：萨珊
	相关武将：阿尔达希尔一世[欧陆]
	技能描述：锁定技，游戏开始时，你将全场势力改为西。
	引用：sfofl_sashan
]] --
sfofl_sashan = sgs.CreateTriggerSkill{
	name = "sfofl_sashan",
	events = {sgs.GameStart},
	frequency = sgs.Skill_Compulsory,
	on_trigger = function(self, event, player, data, room)
		if event == sgs.GameStart then
            for _, p in sgs.qlist(room:getAlivePlayers()) do
                room:setPlayerProperty(p, "kingdom", sgs.QVariant("west"))
            end
        end
    end
}

--[[
	技能名：纳贡
	相关武将：阿尔达希尔一世[欧陆]
	技能描述：其他角色的准备阶段，其可以交给你一张牌，然后直到其下个回合开始时，其将势力更改为群。
	引用：sfofl_nagong
]] --
sfofl_nagong = sgs.CreateTriggerSkill{
	name = "sfofl_nagong",
	events = {sgs.EventPhaseStart, sgs.TurnStart},
	frequency = sgs.Skill_NotFrequent,
	on_trigger = function(self, event, player, data, room)
        if event == sgs.TurnStart then
            local kingdom = player:property("sfofl_nagong"):toString()
            if kingdom ~= "" then
                room:setPlayerProperty(player, "sfofl_nagong", sgs.QVariant(""))
                room:setPlayerProperty(player, "kingdom", sgs.QVariant(kingdom))
            end
        elseif event == sgs.EventPhaseStart then
            if player:getPhase() == sgs.Player_Start and not player:isKongcheng() then
                for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    local card = room:askForCard(player, ".", "@sfofl_nagong:"..p:objectName(), ToData(p), sgs.Card_MethodNone) 
                    if card then
                        room:obtainCard(p, card, false)
                        room:setPlayerProperty(player, "sfofl_nagong", sgs.QVariant(player:getKingdom()))
                        room:setPlayerProperty(player, "kingdom", sgs.QVariant("qun"))
                        break
                    end
                end
            end
        end
    end,
    can_trigger = function(self, target)
        return target
    end,
}


sfofl_ardashirI:addSkill(sfofl_wanwang)
sfofl_ardashirI:addSkill(sfofl_sashan)
sfofl_ardashirI:addSkill(sfofl_nagong)

sfofl_makang = sgs.General(extension_e, "sfofl_makang", "west", 4, true)
--[[
	技能名：西入
	相关武将：马抗[欧陆]
	技能描述：锁定技，摸牌阶段，你的摸牌数+X（X为场上坐骑牌的数量的一半向上取整）。
	引用：sfofl_xiru
]] --

sfofl_xiru = sgs.CreateTriggerSkill {
    name = "sfofl_xiru",
    frequency = sgs.Skill_Frequent,
    events = { sgs.DrawNCards },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local draw = data:toDraw()
        if draw.reason ~= "draw_phase" then return false end
        if event == sgs.DrawNCards then
            local x = 0
            for _, p in sgs.qlist(room:getAlivePlayers()) do
				if p:getDefensiveHorse() then
					x = x + 1
				end
				if p:getOffensiveHorse() then
					x = x + 1
				end
			end
            x = math.ceil(x/2)
            draw.num = draw.num + x
            room:sendCompulsoryTriggerLog(player, "sfofl_xiru", true)
            data:setValue(draw)
        end
    end
}


--[[
	技能名：纵马
	相关武将：马抗[欧陆]
	技能描述：出牌阶段开始时，你可以将一张牌当防御/进攻坐骑牌置入一名角色对应的装备区内，其受到/造成的伤害+1，当其受到/造成伤害时将此牌置入弃牌堆。
	引用：sfofl_zongma
]] --



sfofl_zongmaCard = sgs.CreateSkillCard{
	name = "sfofl_zongma",
	will_throw = false,
	filter = function(self,targets,to_select,source)
        return ((to_select:hasEquipArea(2) and to_select:getEquip(2)==nil ) or (to_select:hasEquipArea(3) and to_select:getEquip(3)==nil )) and #targets == 0
	end,
	on_use = function(self,room,source,targets)
        local choicelist = {}
        local to = targets[1]
        if to:hasEquipArea(3) and to:getEquip(3)==nil then
            table.insert(choicelist, "OffensiveHorse")
        end
        if to:hasEquipArea(2) and to:getEquip(2)==nil then
            table.insert(choicelist, "DefensiveHorse")
        end
        if #choicelist == 0 then return end
        local to = targets[1]
        to:addToPile("sfofl_zongma", self:getSubcards())
        local choice = room:askForChoice(source, self:objectName(), table.concat(choicelist, "+"))
        
        if choice == "OffensiveHorse" then
            local cards = sgs.IntList()
            for _,id in sgs.qlist(sgs.Sanguosha:getRandomCards(true)) do
                if sgs.Sanguosha:getEngineCard(id):objectName() == "_horseof" then
                    if to:isAlive() and to:hasEquipArea(3) then
                        local c = sgs.Sanguosha:getEngineCard(id)
                        room:moveCardTo(c,to,sgs.Player_PlaceEquip,sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_PUT, source:objectName(), "sfofl_zongma", ""))
                        to:setTag("sfofl_zongmaOf", ToData(id))
                        to:setTag("sfofl_zongmaOfCard", ToData(self:getSubcards():first()))
                        break
                    end
                end
            end
        else
            local cards = sgs.IntList()
            for _,id in sgs.qlist(sgs.Sanguosha:getRandomCards(true)) do
                if sgs.Sanguosha:getEngineCard(id):objectName() == "_horsede" then
                    if to:isAlive() and to:hasEquipArea(2) then
                        local c = sgs.Sanguosha:getEngineCard(id)
                        room:moveCardTo(c,to,sgs.Player_PlaceEquip,sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_PUT, source:objectName(), "sfofl_zongma", ""))
                        to:setTag("sfofl_zongmaDe", ToData(id))
                        to:setTag("sfofl_zongmaDeCard", ToData(self:getSubcards():first()))
                        break
                    end
                end
            end
        end
	end,
}

sfofl_zongmaVS = sgs.CreateViewAsSkill{
    name = "sfofl_zongma",
    n = 1,
    view_filter = function(self, selected, to_select)
        if #selected >= 1 then return false end
        local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
        if pattern == "@@sfofl_zongma" then
            return true
        end
    end,
    view_as = function(self,cards)
        if #cards == 0 then return nil end
        local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
        if pattern == "@@sfofl_zongma" then
            local card = sfofl_zongmaCard:clone()
            for _,c in ipairs(cards) do
                card:addSubcard(c)
            end
            return card
        end
    end,
    enabled_at_play = function(self, player)
       return false
    end,
    enabled_at_response = function(self, player, pattern)
        return pattern == "@@sfofl_zongma" 
    end,
}
sfofl_zongma = sgs.CreateTriggerSkill{
	name = "sfofl_zongma",
	events = {sgs.EventPhaseStart},
    view_as_skill = sfofl_zongmaVS,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
        if not player:isNude() and player:getPhase() == sgs.Player_Play then
		    room:askForUseCard(player,"@@sfofl_zongma","@sfofl_zongma")
        end
	end,
}

sfofl_zongma_change = sgs.CreateTriggerSkill{
	name = "#sfofl_zongma_change",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.BeforeCardsMove, sgs.CardsMoveOneTime},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
        if (event == sgs.BeforeCardsMove) then
			local move = data:toMoveOneTime()
			if move.from_places:contains(sgs.Player_PlaceEquip) and move.reason.m_skillName~="BreakCard"
			and move.from:objectName()==player:objectName() then
                if move.to_place ~= sgs.Player_PlaceEquip then
                    for i,id in sgs.list(move.card_ids)do
                        if move.from_places:at(i)==sgs.Player_PlaceEquip
                        and ((sgs.Sanguosha:getEngineCard(id):objectName() == "_horseof") or 
                        sgs.Sanguosha:getEngineCard(id):objectName() == "_horsede") then
                            if sgs.Sanguosha:getEngineCard(id):objectName() == "_horseof" and player:getTag("sfofl_zongmaOf") and player:getTag("sfofl_zongmaOf"):toInt() == id then
                                player:removeTag("sfofl_zongmaOf")
                                local to = (move.to and room:findPlayerByObjectName(move.to:objectName())) or nil
                                local c =  sgs.Sanguosha:getCard(player:getTag("sfofl_zongmaOfCard"):toInt())
                                room:moveCardTo(c,to,move.to_place, move.reason)
                                player:removeTag("sfofl_zongmaOfCard")
                            end
                            if sgs.Sanguosha:getEngineCard(id):objectName() == "_horsede" and player:getTag("sfofl_zongmaDe")
                            and player:getTag("sfofl_zongmaDe"):toInt() == id then
                                player:removeTag("sfofl_zongmaDe")
                                local to = (move.to and room:findPlayerByObjectName(move.to:objectName())) or nil
                                local c =  sgs.Sanguosha:getCard(player:getTag("sfofl_zongmaDeCard"):toInt())
                                room:moveCardTo(c,to,move.to_place, move.reason)
                                player:removeTag("sfofl_zongmaDeCard")
                            end
                            local ids = sgs.IntList()
                            ids:append(id)
                            move:removeCardIds(ids)
                            data:setValue(move)
                            room:breakCard(id,player)
                        end
                    end
                end
            end
        elseif event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
			if move.from_places:contains(sgs.Player_PlaceEquip) and move.to and move.to:objectName()==player:objectName() then
                if move.to_place == sgs.Player_PlaceEquip then
                    for i,id in sgs.list(move.card_ids)do
                        if move.from_places:at(i)==sgs.Player_PlaceEquip
                        and ((sgs.Sanguosha:getEngineCard(id):objectName() == "_horseof") or 
                        sgs.Sanguosha:getEngineCard(id):objectName() == "_horsede") then
                            if sgs.Sanguosha:getEngineCard(id):objectName() == "_horseof" then 
                                for _, p in sgs.qlist(room:getAlivePlayers()) do
                                    if p:getTag("sfofl_zongmaOf") and p:getTag("sfofl_zongmaOf"):toInt() == id then
                                        local original = p:getTag("sfofl_zongmaOfCard"):toInt()
                                        p:removeTag("sfofl_zongmaOf")
                                        p:removeTag("sfofl_zongmaOfCard")
                                        player:setTag("sfofl_zongmaOf", ToData(id))
                                        player:setTag("sfofl_zongmaOfCard", ToData(original))
                                        player:addToPile("sfofl_zongma", original)
                                    end
                                end
                            end
                            if sgs.Sanguosha:getEngineCard(id):objectName() == "_horsede" then 
                                for _, p in sgs.qlist(room:getAlivePlayers()) do
                                    if p:getTag("sfofl_zongmaDe") and p:getTag("sfofl_zongmaDe"):toInt() == id then
                                        local original = p:getTag("sfofl_zongmaDeCard"):toInt()
                                        p:removeTag("sfofl_zongmaDe")
                                        p:removeTag("sfofl_zongmaDeCard")
                                        player:setTag("sfofl_zongmaDe", ToData(id))
                                        player:setTag("sfofl_zongmaDeCard", ToData(original))
                                        player:addToPile("sfofl_zongma", original)
                                    end
                                end
                            end
                        end
                    end
                end
            end
		end
	end,
	can_trigger = function(self, player)
		return player
	end,
}
sfofl_zongma_buff = sgs.CreateTriggerSkill{
    name = "#sfofl_zongma_buff", 
    events = {sgs.DamageInflicted, sgs.DamageCaused}, 
    frequency = sgs.Skill_Compulsory, 
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local damage = data:toDamage()
        if event == sgs.DamageInflicted then
            if player:getTag("sfofl_zongmaDe") and player:objectName() == damage.to:objectName() and player:getDefensiveHorse() ~= nil and player:getDefensiveHorse():getId() == player:getTag("sfofl_zongmaDe"):toInt() then
                player:damageRevises(data,1)
                local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_PUT, nil, "sfofl_zongma", nil)
                room:throwCard(player:getDefensiveHorse(), reason, nil)
            end
        elseif event == sgs.DamageCaused then
            if player:getTag("sfofl_zongmaOf") and player:objectName() == damage.from:objectName() and player:getOffensiveHorse() ~= nil and player:getOffensiveHorse():getId() == player:getTag("sfofl_zongmaOf"):toInt() then
                player:damageRevises(data,1)
                local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_PUT, nil, "sfofl_zongma", nil)
                room:throwCard(player:getOffensiveHorse(), reason, nil)
            end
        end
        return false
    end,
	can_trigger = function(self, target)
		return target
	end
}



sfofl_makang:addSkill("mashu")
sfofl_makang:addSkill(sfofl_xiru)
sfofl_makang:addSkill(sfofl_zongma)
sfofl_makang:addSkill(sfofl_zongma_change)
sfofl_makang:addSkill(sfofl_zongma_buff)
extension_e:insertRelatedSkills("sfofl_zongma", "#sfofl_zongma_change")
extension_e:insertRelatedSkills("sfofl_zongma", "#sfofl_zongma_buff")

sfofl_romawarrior = sgs.General(extension_e, "sfofl_romawarrior", "west", 5)
--[[
	技能名：贲勇
	相关武将：罗马力士[欧陆]
	技能描述：锁定技，你使用的牌其他角色需使用点数大于你的牌才能响应。
	引用：sfofl_benyong
]] --

sfofl_benyong = sgs.CreateTriggerSkill {
    name = "sfofl_benyong",
    events = { sgs.CardOffset },
    can_trigger = function(self, target)
        return target
    end,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local effect = data:toCardEffect()
        if effect.offset_card and effect.from and effect.from:hasSkill(self:objectName()) and effect.offset_card:getNumber() <= effect.card:getNumber() then
            return true
        end
        return false
    end
}

--[[
	技能名：缴资
	相关武将：罗马力士[欧陆]
	技能描述：当你使用伤害牌结算结束后，你可以将此牌交给一名其他角色。
	引用：sfofl_jiaozi
]] --
sfofl_jiaozi = sgs.CreateTriggerSkill {
    name = "sfofl_jiaozi",
    events = { sgs.CardFinished },
    on_trigger = function(self, event, player, data, room)
        local room = player:getRoom()
        if event == sgs.CardFinished then
            local use = data:toCardUse()
            if use.card and not use.card:isKindOf("SkillCard") and use.card:isDamageCard() then
                local id = use.card:getEffectiveId()
                if room:CardInPlace(use.card, sgs.Player_DiscardPile) then
                    local ai_data = sgs.QVariant()
                    ai_data:setValue(id)
                    room:setTag("sfofl_jiaozi", ai_data)
                    local target = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName(), "sfofl_jiaozi-invoke", true, true)
                    room:removeTag("sfofl_jiaozi")
                    if target then
                        room:obtainCard(target, use.card, true)
                    end
                end
            end
        end
    end
}

sfofl_romawarrior:addSkill(sfofl_benyong)
sfofl_romawarrior:addSkill(sfofl_jiaozi)


sfofl_yujin = sgs.General(extension_e, "sfofl_yujin", "wei", 4)
--[[
	技能名：节钺
	相关武将：于禁[欧陆]
	技能描述：每轮各限一次，结束阶段，你可以令一名角色摸一张牌，若如此做，其选择一项：1.令你摸三张牌；2.失去1点体力，令你执行一个额外的回合。
	引用：sfofl_jieyue
]] --
sfofl_jieyue = sgs.CreateTriggerSkill{
	name = "sfofl_jieyue",
	events = {sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
        if player:getPhase() ~= sgs.Player_Finish then return false end
        local choicelist = { }
        if player:getMark("sfofl_jieyue_draw_lun") == 0 then
            table.insert(choicelist, "draw")
        end
        if player:getMark("sfofl_jieyue_turn_lun") == 0 then
            table.insert(choicelist, "turn")
        end
        if #choicelist > 0 then
            local target = room:askForPlayerChosen(player, room:getAlivePlayers(), self:objectName(), "sfofl_jieyue-invoke", true, true)
            if target then
                target:drawCards(1, self:objectName())
                local choice = room:askForChoice(target,self:objectName(),table.concat(choicelist, "+"), ToData(player))
                room:addPlayerMark(player, "sfofl_jieyue_"..choice.."_lun")
                if choice == "draw" then
                    player:drawCards(3, self:objectName())
                else
                    room:loseHp(target,1,true,player,self:objectName())
                    local playerdata = sgs.QVariant()
                    playerdata:setValue(player)
                    room:setTag("sfofl_jieyueTarget", playerdata)
                end
            end
        end
	end,
}
sfofl_jieyue_buff = sgs.CreateTriggerSkill{
	name = "#sfofl_jieyue_buff" ,
	events = {sgs.EventPhaseStart} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if room:getTag("sfofl_jieyueTarget") then
			local target = room:getTag("sfofl_jieyueTarget"):toPlayer()
			room:removeTag("sfofl_jieyueTarget")
			if target and target:isAlive() then
				target:gainAnExtraTurn()
			end
		end
		return false
	end ,
	can_trigger = function(self, target)
		return target and (target:getPhase() == sgs.Player_NotActive)
	end ,
	priority = 1
}

sfofl_yujin:addSkill(sfofl_jieyue)
sfofl_yujin:addSkill(sfofl_jieyue_buff)
extension_e:insertRelatedSkills("sfofl_jieyue", "#sfofl_jieyue_buff")

sfofl_zhangliao = sgs.General(extension_e, "sfofl_zhangliao", "wei", 4)
--[[
	技能名：突袭
	相关武将：张辽[欧陆]
	技能描述：当你造成伤害后，你可以摸一张牌，然后获得受伤角色和其​​上下家各一张牌。
	引用：sfofl_tuxi
]] --


sfofl_tuxi = sgs.CreateTriggerSkill{
	name = "sfofl_tuxi",
	events = {sgs.Damage},
    frequency = sgs.Skill_Frequent,
    on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()
        if room:askForSkillInvoke(player, self:objectName(), data) then
            player:drawCards(1, self:objectName())
            if not damage.to:isNude() then
                local id = room:askForCardChosen(player,damage.to,"he",self:objectName())
                room:obtainCard(player,id,false)
            end
            if damage.to:isAlive() then
                local targets = sgs.SPlayerList()
                for _,p in sgs.list(room:getAlivePlayers())do
                    if p:objectName() == player:objectName() then continue end
                    if damage.to:isAdjacentTo(p) then targets:append(p) end
                end
                if targets:isEmpty() then return false end
                room:sortByActionOrder(targets)
                for _,p in sgs.list(targets)do
                    if not p:isNude() then
                        local id = room:askForCardChosen(player,p,"he",self:objectName())
                        room:obtainCard(player,id,false)
                    end
                end
            end
        end
    end
}
sfofl_zhangliao:addSkill(sfofl_tuxi)




sfofl_yuejin = sgs.General(extension_e, "sfofl_yuejin", "wei", 4)
--[[
	技能名：骁果
	相关武将：乐进[欧陆]
	技能描述：出牌阶段，你可以弃置一张基本牌，对一名其他角色造成1点伤害，若有角色以此法进入濒死状态，此技能本回合失效。
	引用：sfofl_xiaoguo
]] --
sfofl_xiaoguoCard = sgs.CreateSkillCard {
	name = "sfofl_xiaoguo",
	target_fixed = false,
	will_throw = true,
	filter = function(self, targets, to_select, player)
		return #targets < 1 and to_select:objectName() ~= player:objectName()
	end,
	on_effect = function(self, effect)
		effect.from:getRoom():damage(sgs.DamageStruct("sfofl_xiaoguo", effect.from, effect.to, 1, sgs.DamageStruct_Normal))
	end
}
sfofl_xiaoguoVS = sgs.CreateOneCardViewAsSkill {
	name = "sfofl_xiaoguo",
	filter_pattern = "BasicCard",
	view_as = function(self, card)
		local acard = sfofl_xiaoguoCard:clone()
		acard:addSubcard(card)
		acard:setSkillName(self:objectName())
		return acard
	end,
	enabled_at_play = function(self, player)
		return player:canDiscard(player, "he") and player:getMark("sfofl_xiaoguo-Clear") == 0
	end,
}
sfofl_xiaoguo = sgs.CreateTriggerSkill {
	name = "sfofl_xiaoguo",
	events = { sgs.EnterDying },
	view_as_skill = sfofl_xiaoguoVS,
	can_trigger = function(self, player)
		return player
	end,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local dying = data:toDying()
		local damage = dying.damage
		if damage and damage.from and dying.who:objectName() == player:objectName() and damage:getReason() == "sfofl_xiaoguo" then
			room:addPlayerMark(damage.from, "sfofl_xiaoguo-Clear")
		end
	end
}
sfofl_yuejin:addSkill(sfofl_xiaoguo)



sfofl_hubaoduwei = sgs.General(extension_e, "sfofl_hubaoduwei", "wei", 4)
--[[
	技能名：待敌
	相关武将：虎豹都尉[欧陆]
	技能描述：每回合限一次，当你成为其他角色牌的目标时，你可以进行一次判定，若颜色和此牌相同，你可以令一名角色获得此判定牌。
	引用：sfofl_daidi
]] --

sfofl_daidi = sgs.CreateTriggerSkill{
	name = "sfofl_daidi",
	events = {sgs.TargetConfirming},
    frequency = sgs.Skill_Frequent,
    on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local use = data:toCardUse()
        if use.to:contains(player) and player:objectName() ~= use.from:objectName() and use.card and not use.card:isKindOf("SkillCard") and player:getMark("sfofl_daidi-Clear") == 0 then
            if room:askForSkillInvoke(player, self:objectName(), data) then
                room:addPlayerMark(player, "sfofl_daidi-Clear")
                local judge = sgs.JudgeStruct()
                judge.pattern = ".|"..use.card:getColorString()
                judge.good = true
                judge.reason = self:objectName()
                judge.who = player
                judge.throw_card = false
                room:judge(judge)
                if judge:isGood() then
                    room:setTag("sfofl_daidi", ToData(judge.card:getEffectiveId()))
                    local target = room:askForPlayerChosen(player, room:getAlivePlayers(), self:objectName(), "sfofl_daidi-invoke", true, true)
                    room:removeTag("sfofl_daidi")
                    if target then
                        local dc = dummyCard()
                        local id = judge.card:getEffectiveId()
                        if room:getCardPlace(id)==sgs.Player_PlaceJudge then
                            dc:addSubcard(id)
                        end
                        room:obtainCard(player,dc,false)
                    end
                end
            end
        end
    end
}




sfofl_hubaoduwei:addSkill("spzhenwei")
sfofl_hubaoduwei:addSkill(sfofl_daidi)


sfofl_shichen = sgs.General(extension_e, "sfofl_shichen", "wei", 3)
--[[
	技能名：帝诏
	相关武将：使臣[欧陆]
	技能描述：每轮各限一次，你可以视为使用一张：基本牌，然后令一名其他角色摸一张牌；锦囊牌，然后令一名角色回复1点体力。
	引用：sfofl_dizhao
]] --
sfofl_dizhaoCard = sgs.CreateSkillCard{
    name = "sfofl_dizhao",
    will_throw = false,
    filter = function(self, targets, to_select, from)
        local pattern = self:getUserString()
		local dc = dummyCard(pattern:split("+")[1])
		if dc:targetFixed() then return false end
		dc:setSkillName("sfofl_dizhao")
		local plist = sgs.PlayerList()
		for i = 1, #targets do plist:append(targets[i]) end
		return dc:targetFilter(plist,to_select,from)
	end,
    feasible = function(self,targets,from)
		local pattern = self:getUserString()
		local dc = dummyCard(pattern:split("+")[1])
        dc:setSkillName("sfofl_dizhao")
        if card and card:canRecast() and #targets == 0 then
			return false
		end
		local plist = sgs.PlayerList()
		for i = 1, #targets do plist:append(targets[i]) end
		return dc:targetFixed() or dc:targetsFeasible(plist, from)
	end,
	on_validate = function(self, card_use)
		local player = card_use.from
        local room = player:getRoom()

        local pattern = self:getUserString()
        local card = sgs.Sanguosha:cloneCard(pattern, sgs.Card_NoSuit, -1)
		card:setSkillName(self:objectName())
        for _,p in sgs.list(patterns())do
			local dc = dummyCard(p)
			if dc and player:getMark("sfofl_dizhao_guhuo_remove_"..p.."_lun")<1 then
                if ((card:isKindOf("BasicCard") and dc:isKindOf("BasicCard")) or (card:isKindOf("TrickCard") and dc:isKindOf("TrickCard"))) then
                    room:addPlayerMark(player, "sfofl_dizhao_guhuo_remove_"..p.."_lun")
                end
			end
		end

        if card:isKindOf("BasicCard") then
            room:setPlayerMark(player, "sfofl_dizhao_basic_lun", 1)
            local target = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName())
            if target then
                target:drawCards(1, self:objectName())
            end
        elseif card:isKindOf("TrickCard") then
            room:setPlayerMark(player, "sfofl_dizhao_trick_lun", 1)
            local target = room:askForPlayerChosen(player, room:getAlivePlayers(), self:objectName().."heal")
            if target then
                room:recover(target, sgs.RecoverStruct(self:objectName(), player, 1))
            end
        end
        for _, mark in sgs.list(player:getMarkNames()) do
            if (string.startsWith(mark, "&sfofl_dizhao+") and player:getMark(mark) > 0) then
                room:setPlayerMark(player, mark, 0)
            end
        end
        local mark = "&sfofl_dizhao+:"
        if player:getMark("sfofl_dizhao_basic_lun") > 0 then
            mark = mark .. "+basic"
        end
        if player:getMark("sfofl_dizhao_trick_lun") > 0 then
            mark = mark .. "+trick"
        end
        mark = mark .. "_lun"
        room:setPlayerMark(player, mark, 1)
		return card
	end,
    on_validate_in_response = function(self, player)
        local room = player:getRoom()

        local pattern = self:getUserString()
		if pattern == "normal_slash" then pattern = "slash" end
        if pattern == "Slash" then
            local all = {"slash","fire_slash","thunder_slash"} 
            local items = {}
            for _,item in ipairs(all) do
                local mark = string.format("sfofl_dizhao_guhuo_remove_%s_lun", item)
                if player:getMark(mark) == 0 then
                    table.insert(items, item)
                end
            end
            pattern = room:askForChoice(player, "sfofl_dizhao_Slash", table.concat(items, "+"))
        end
        if pattern == "Jink" then pattern = "jink" end
        if pattern == "peach+analeptic" then 
            local all = {"peach","analeptic"} 
            local items = {}
            for _,item in ipairs(all) do
                local mark = string.format("sfofl_dizhao_guhuo_remove_%s_lun", item)
                if player:getMark(mark) == 0 then
                    table.insert(items, item)
                end
            end
            pattern = room:askForChoice(player, "sfofl_dizhao_saveself", table.concat(items, "+"))
        end
		local card = sgs.Sanguosha:cloneCard(pattern, sgs.Card_NoSuit, -1)
		card:setSkillName(self:objectName())

        for _,p in sgs.list(patterns())do
			local dc = dummyCard(p)
			if dc and player:getMark("sfofl_dizhao_guhuo_remove_"..p.."_lun")<1 then
                if ((card:isKindOf("BasicCard") and dc:isKindOf("BasicCard")) or (card:isKindOf("TrickCard") and dc:isKindOf("TrickCard"))) then
                    room:addPlayerMark(player, "sfofl_dizhao_guhuo_remove_"..p.."_lun")
                end
			end
		end

        if card:isKindOf("BasicCard") then
            room:setPlayerMark(player, "sfofl_dizhao_basic_lun", 1)
            local target = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName())
            if target then
                target:drawCards(1, self:objectName())
            end
        elseif card:isKindOf("TrickCard") then
            room:setPlayerMark(player, "sfofl_dizhao_trick_lun", 1)
            local target = room:askForPlayerChosen(player, room:getAlivePlayers(), self:objectName().."heal")
            if target then
                room:recover(target, sgs.RecoverStruct(self:objectName(), player, 1))
            end
        end
         for _, mark in sgs.list(player:getMarkNames()) do
            if (string.startsWith(mark, "&sfofl_dizhao+") and player:getMark(mark) > 0) then
                room:setPlayerMark(player, mark, 0)
            end
        end
        local mark = "&sfofl_dizhao+:"
        if player:getMark("sfofl_dizhao_basic_lun") > 0 then
            mark = mark .. "+basic"
        end
        if player:getMark("sfofl_dizhao_trick_lun") > 0 then
            mark = mark .. "+trick"
        end
        mark = mark .. "_lun"
        room:setPlayerMark(player, mark, 1)

        return card
    end
}

sfofl_dizhao = sgs.CreateZeroCardViewAsSkill{
    name = "sfofl_dizhao",
    guhuo_type = "lr",
    view_as = function(self)
        local cc = sfofl_dizhaoCard:clone()
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
            local c = sgs.Self:getTag("sfofl_dizhao"):toCard()
            cc:setUserString(c:objectName())
            return cc
        else
            local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
            if pattern == "slash" then pattern = "Slash" end
            cc:setUserString(pattern)
            return cc
        end
    end,
    enabled_at_play = function(self, player)
        local can = false
		for _,p in sgs.list(patterns())do
			local dc = dummyCard(p)
			if dc and player:getMark("sfofl_dizhao_guhuo_remove_"..p.."_lun")<1 then
                if (dc:isKindOf("BasicCard") and player:getMark("sfofl_dizhao_basic_lun") == 0) or 
                (dc:isKindOf("TrickCard") and player:getMark("sfofl_dizhao_trick_lun") == 0) then
                    dc:setSkillName("sfofl_dizhao")
                    if not player:isLocked(dc)
                    then can = true break end
                end
			end
		end
		if can==false then return false end
        return true
    end,
    enabled_at_response = function(self, player, pattern)
        local can = false
		for _,p in sgs.list(pattern:split("+"))do
			local dc = dummyCard(p)
			if dc and player:getMark("sfofl_dizhao_guhuo_remove_"..p.."_lun")<1 then
                if (dc:isKindOf("BasicCard") and player:getMark("sfofl_dizhao_basic_lun") == 0) or 
                (dc:isKindOf("TrickCard") and player:getMark("sfofl_dizhao_trick_lun") == 0) then
                    dc:setSkillName("sfofl_dizhao")
                    if not player:isLocked(dc)
                    then can = true break end
                end
			end
		end
		if can==false then return false end
        return sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE
    end
}

sfofl_shichen:addSkill("chenjie")
sfofl_shichen:addSkill(sfofl_dizhao)

sfofl_cavalry = sgs.General(extension_e, "sfofl_cavalry", "qun", 4)
--[[
	技能名：疾袭
	相关武将：骑兵[欧陆]
	技能描述：当你使用【杀】时，若其装备区内的牌数不小于你，你可以选择一项：1.获得其一张牌；2.令此【杀】不可响应并摸一张牌。
	引用：sfofl_jixi
]] --
sfofl_jixi = sgs.CreateTriggerSkill{
    name = "sfofl_jixi",
    frequency = sgs.Skill_Frequent,
    events = {sgs.CardUsed},
    on_trigger = function(self, event, player, data, room)
        local use = data:toCardUse()
        if not use.card:isKindOf("Slash") then return false end
        for _, p in sgs.qlist(use.to) do
            if p:getEquips():length() >= player:getEquips():length() then
                local choicelist = {"draw"}
                if not p:isNude() then
                    table.insert(choicelist, "obtain")
                end
                table.insert(choicelist, "cancel")
                local choice = room:askForChoice(player,self:objectName(),table.concat(choicelist, "+"), ToData(p))
                if choice == "draw" then
                    player:drawCards(1, self:objectName())
                    local no_respond_list = use.no_respond_list
                    table.insert(no_respond_list, "_ALL_TARGETS")
                    use.no_respond_list = no_respond_list
                    data:setValue(use)
                elseif choice == "obtain" then
                    local id = room:askForCardChosen(player,p,"he",self:objectName())
                    room:obtainCard(player,id,false)
                end
            end
        end
    end
}

sfofl_cavalry:addSkill("mashu")
sfofl_cavalry:addSkill(sfofl_jixi)

--[[
	技能名：冲车
	技能描述：装备牌/宝物\
        宝物技能：出牌阶段限一次，当你装备区的牌数不小于2时，你可以弃置装备区内除此牌以外的所有牌，然后对一名角色造成1点伤害。
	引用：sfofl_batteringram
]] --
sfofl_batteringramCard = sgs.CreateSkillCard {
	name = "sfofl_batteringram",
	target_fixed = false,
	will_throw = true,
	filter = function(self, targets, to_select, player)
		return #targets < 1 and to_select:objectName() ~= player:objectName()
	end,
	on_effect = function(self, effect)
        if effect.from:getEquips():length() > 0 then
            local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
            local cards = effect.from:getCards("e")
            for _,card in sgs.qlist(cards) do
                if not card:isKindOf("BatteRingRam") then
                    dummy:addSubcard(card)
                end
            end
            if dummy:subcardsLength() > 0 then
                effect.from:getRoom():throwCard(dummy, effect.from)
            end
            dummy:deleteLater()
        end
		effect.from:getRoom():damage(sgs.DamageStruct("sfofl_batteringram", effect.from, effect.to, 1, sgs.DamageStruct_Normal))
	end
}
sfofl_batteringramVS = sgs.CreateViewAsSkill {
    name = "sfofl_batteringram",
    n = 0,
    view_as = function(self, cards)
        local acard = sfofl_batteringramCard:clone()
		acard:setSkillName(self:objectName())
		return acard
	end,
    enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_batteringram") and player:getEquips():length() >= 2
	end, 
}
sfofl_batteringramTr = sgs.CreateTriggerSkill {
	name = "sfofl_batteringram",
	view_as_skill = sfofl_batteringramVS,
	events = { },
	on_trigger = function(self, event, player, data)
	end,
    can_trigger = function(self,target)
		return target and target:hasTreasure("sfofl_batteringram")
	end,
}
sfofl_batteringram = sgs.CreateTreasure{
	name = "sfofl_batteringram",
	class_name = "BatteRingRam",
	equip_skill = sfofl_batteringramTr,
    suit = sgs.Card_NoSuit,
    number = 0,
	on_install = function(self,player)
		local room = player:getRoom()
		room:attachSkillToPlayer(player,"sfofl_batteringram")
	end,
	on_uninstall = function(self,player)
		player:getRoom():detachSkillFromPlayer(player,"sfofl_batteringram",true,true)
	end,
}
sfofl_batteringram:setParent(extension_card)




--[[
	技能名：刀车
	技能描述：装备牌/宝物\
        宝物技能：当你成为其他角色伤害牌的目标后，你可以进行一次判定，若花色和该伤害牌一致，你于此牌结算结束后对其造成1点伤害。
	引用：sfofl_bladecart
]] --

sfofl_bladecartTr = sgs.CreateTriggerSkill {
	name = "sfofl_bladecart",
	view_as_skill = sfofl_bladecartVS,
	events = { sgs.TargetConfirmed, sgs.CardFinished },
	on_trigger = function(self, event, player, data, room)
        local use = data:toCardUse()
        if event == sgs.TargetConfirmed then
            if use.to:contains(player) and use.card and use.from and use.card:isDamageCard() and not use.card:isKindOf("SkillCard") and player:objectName() ~= use.from:objectName() and player:hasTreasure("sfofl_bladecart") and room:askForSkillInvoke(player, self:objectName(), data) then
                local judge = sgs.JudgeStruct()
                judge.pattern = ".|"..use.card:getSuitString()
                judge.good = true
                judge.reason = self:objectName()
                judge.who = player
                room:judge(judge)
                if judge:isGood() then
                    room:setCardFlag(use.card, self:objectName()..player:objectName())
                    room:setCardFlag(use.card, self:objectName())
                end
            end
        elseif event == sgs.CardFinished then
            if use.card:hasFlag(self:objectName()) and use.from and use.from:isAlive() then
                player:gainMark("@1")
                for _,p in sgs.qlist(room:getAlivePlayers()) do
                    p:gainMark("@2")
                    if use.card:hasFlag(self:objectName()..p:objectName()) then
                        p:gainMark("@3")
                        room:damage(sgs.DamageStruct(self:objectName(), use.from, p))
                    end
                end
            end
        end
	end,
    can_trigger = function(self,target)
		return target
	end,
}
sfofl_bladecart = sgs.CreateTreasure{
	name = "sfofl_bladecart",
	class_name = "BladeCart",
	equip_skill = sfofl_bladecartTr,
    suit = sgs.Card_NoSuit,
    number = 0,
	on_install = function(self,player)
		local room = player:getRoom()
		room:attachSkillToPlayer(player,"sfofl_bladecart")
	end,
	on_uninstall = function(self,player)
		player:getRoom():detachSkillFromPlayer(player,"sfofl_bladecart",true,true)
	end,
}
sfofl_bladecart:setParent(extension_card)





















sfofl_nanhualaoxian = sgs.General(extension_gai, "sfofl_nanhualaoxian", "qun", 3)
--[[
	技能名：御风
	相关武将：南华老仙[官盗]
	技能描述：出牌阶段限一次，你可以进行判定，若结果为黑桃，你令一名其他角色跳过其下个回合的出牌阶段和弃牌阶段；红桃，你令一名其他角色跳过其下个回合的摸牌阶段；梅花或方块，你摸一张牌并重置“御风”。
	引用：sfofl_yufeng
]] --

sfofl_yufengCard = sgs.CreateSkillCard{
    name = "sfofl_yufeng",
    will_throw = false,
    target_fixed = true,
    on_use = function(self, room, source, targets)
        local judge = sgs.JudgeStruct()
        judge.pattern = "."
        judge.reason = self:objectName()
        judge.who = source
        room:judge(judge)
        local target
        if judge.card:getSuit() == sgs.Card_Spade or judge.card:getSuit() == sgs.Card_Heart then
            target = room:askForPlayerChosen(source, room:getOtherPlayers(source), self:objectName())
            room:addPlayerMark(target, "&sfofl_yufeng+:+".. judge.card:getSuitString().."_char" .."+to+#"..source:objectName().."-SelfClear")
            room:addPlayerMark(target, "sfofl_yufeng+:+".. judge.card:getSuitString().."_char" .."+to+#"..source:objectName().."-SelfClear")
        else
            source:drawCards(1, self:objectName())
            room:addPlayerHistory(source, "#sfofl_yufeng", -1)
        end
    end
}

sfofl_yufeng = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_yufeng",
	view_as = function(self) 
		return sfofl_yufengCard:clone()
	end, 
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_yufeng")
    end
}

sfofl_yufeng_Clear = sgs.CreateTriggerSkill{
    name = "#sfofl_yufeng_Clear",
    events = {sgs.EventPhaseStart},
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if player:getPhase() ~= sgs.Player_Start then return false end
        for _,mark in sgs.list(player:getMarkNames()) do
            if string.find(mark, "sfofl_yufeng") and player:getMark(mark) > 0 then
                local suit = mark:split("+")[3]:split("_")[1]
                if suit == "spade" then
                    player:skip(sgs.Player_Play)
                    player:skip(sgs.Player_Discard)
                else
                    player:skip(sgs.Player_Draw)
                end
            end
        end
    end,
    can_trigger = function(self, target)
        return target ~= nil
    end,
}

--[[
	技能名：天书
	相关武将：南华老仙[官盗]
	技能描述：出牌阶段开始时，若埸上没有太平要术，你可以弃置一张牌，然后将太平要术置入一名角色的装备区。
	引用：sfofl_tianshu
]] --
sfofl_tianshu = sgs.CreateTriggerSkill{
	name = "sfofl_tianshu",
	events = {sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data)
		if player:getPhase() == sgs.Player_Play then
			local room = player:getRoom()
            local id = player:getDerivativeCard("_taipingyaoshu", sgs.Player_PlaceTable)
            local card = sgs.Sanguosha:getCard(id)
            if room:getCardPlace(id) ~= sgs.Player_PlaceJudge and room:getCardPlace(id) ~= sgs.Player_PlaceEquip then
                if room:askForDiscard(player, "sfofl_tianshu", 1, 1,true,true,"@sfofl_tianshu") then
                    local target = room:askForPlayerChosen(player,room:getAlivePlayers(),self:objectName())
                    if target then
                        room:moveCardTo(card, player, target, sgs.Player_PlaceEquip,sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_PUT, player:objectName(), "sfofl_tianshu", ""))                
                    end
                end
            end
		end
	end,
}

sfofl_nanhualaoxian:addSkill(sfofl_yufeng)
sfofl_nanhualaoxian:addSkill(sfofl_yufeng_Clear)
extension_gai:insertRelatedSkills("sfofl_yufeng", "#sfofl_yufeng_Clear")
sfofl_nanhualaoxian:addSkill(sfofl_tianshu)

sfofl_zhengxuan = sgs.General(extension_gai, "sfofl_zhengxuan", "qun", 3)
--[[
	技能名：整经
	相关武将：郑玄[官盗]
	技能描述：出牌阶段限一次，你可以将牌堆中每种类别的各一张牌扣置于一名角色的武将牌一侧，该角色于其下个回合开始时获得这些牌，并跳过本回合的判定阶段和摸牌阶段。
	引用：sfofl_zhengjing
]] --

sfofl_zhengjingCard = sgs.CreateSkillCard{
    name = "sfofl_zhengjing",
    will_throw = false,
    filter = function(self, targets, to_select, player)
		return #targets < 1
	end,
    on_effect = function(self,effect)
        local from,to = effect.from,effect.to
        local room = from:getRoom()
        local toc = dummyCard()
        local ts = sgs.IntList()
        for _,id in sgs.list(room:getDrawPile())do
            local c = sgs.Sanguosha:getCard(id)
            if ts:contains(c:getTypeId())
            then continue end
            toc:addSubcard(id)
            ts:append(c:getTypeId())
        end
        to:addToPile("sfofl_zhengjing", toc, false)
    end
}

sfofl_zhengjing = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_zhengjing",
	view_as = function(self) 
		return sfofl_zhengjingCard:clone()
	end, 
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_zhengjing")
    end
}

sfofl_zhengjing_Clear = sgs.CreateTriggerSkill{
    name = "#sfofl_zhengjing_Clear",
    events = {sgs.EventPhaseStart},
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if player:getPhase() ~= sgs.Player_Start then return false end
        if player:getPile("sfofl_zhengjing"):length() > 0 then
            local obtain = sgs.Sanguosha:cloneCard("jink", sgs.Card_SuitToBeDecided, -1)
            obtain:addSubcards(player:getPile("sfofl_zhengjing"))
            room:obtainCard(player, obtain, false)
            obtain:deleteLater()
            player:skip(sgs.Player_Judge)
            player:skip(sgs.Player_Draw)
        end
    end,
    can_trigger = function(self, target)
        return target ~= nil
    end,
}
sfofl_zhengxuan:addSkill(sfofl_zhengjing)
sfofl_zhengxuan:addSkill(sfofl_zhengjing_Clear)
extension_gai:insertRelatedSkills("sfofl_zhengjing", "#sfofl_zhengjing_Clear")

sfofl_peixiu = sgs.General(extension_gai, "sfofl_peixiu", "qun", 3)

--[[
	技能名：爵制
	相关武将：裴秀[官盗]
	技能描述：出牌阶段，你可以弃置至少两张牌，然后展示牌堆顶等量的牌，并获得其中一张。
	引用：sfofl_juezhi
]] --
sfofl_juezhiCard = sgs.CreateSkillCard{
	name = "sfofl_juezhi",
	will_throw = true,
	target_fixed = true,
	on_use = function(self,room,source,targets)
		local card_ids = room:showDrawPile(source, self:subcardsLength(), self:objectName(), false)
		local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
        dummy:deleteLater()
        room:fillAG(card_ids)
        local card_id = room:askForAG(source, card_ids, false, self:objectName())
        dummy:addSubcard(card_id)
        room:clearAG()
        source:obtainCard(dummy)
	end
}
sfofl_juezhi = sgs.CreateViewAsSkill{
	name = "sfofl_juezhi",
	n = 999,
	view_filter = function(self,selected,to_select)
		return not sgs.Self:isJilei(to_select)
	end,
	view_as = function(self,cards)
		if #cards <= 1 then return nil end
		local skillcard = sfofl_juezhiCard:clone()
		for _,c in ipairs(cards)do
			skillcard:addSubcard(c)
		end
		return skillcard
	end,
	enabled_at_play = function(self,player)
		return player:getCardCount() >= 2
	end,
}

sfofl_peixiu:addSkill("xingtu")
sfofl_peixiu:addSkill(sfofl_juezhi)

sfofl_yongcai = sgs.General(extension_s, "sfofl_yongcai", "shu", 5)
--[[
	技能名：嚣反
	相关武将：雍闿[官盗]
	技能描述：蜀势力角色不以此法受到伤害后，你可以对其造成1点伤害，然后变更势力至吴；吴势力角色失去装备牌后，你与其各摸一张牌，然后变更势力至群；群势力角色造成伤害后，你可以获得伤害牌，然后变更势力至蜀。
	引用：sfofl_xiaofan
]] --

sfofl_xiaofan = sgs.CreateTriggerSkill{
    name = "sfofl_xiaofan",
    events = {sgs.Damaged, sgs.Damage, sgs.CardsMoveOneTime},
    frequency = sgs.Skill_Frequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.Damaged then
            local damage = data:toDamage()
            if damage.reason == self:objectName() then return false end
            if player:getKingdom() == "shu" and player:objectName() == damage.to:objectName() then
			    for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if p:getKingdom() ~= "wu" then
                        if room:askForSkillInvoke(p, "sfofl_xiaofan_damage", data) then
                            room:damage(sgs.DamageStruct(self:objectName(), p, player))
                            room:changeKingdom(p, "wu")
                        end
                    end
                end
            end
        elseif event == sgs.Damage then
            local damage = data:toDamage()
            local card = damage.card
            if not card then return end
            local ids = sgs.IntList()
            if card:isVirtualCard() then
                ids = card:getSubcards()
            else
                ids:append(card:getEffectiveId())
            end
            if ids:isEmpty() then return end
            for _, id in sgs.qlist(ids) do
                if room:getCardPlace(id) ~= sgs.Player_PlaceTable then return end
            end
            if player:getKingdom() == "qun" and player:objectName() == damage.from:objectName() then
			    for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if p:getKingdom() ~= "shu" then
                        if room:askForSkillInvoke(p, self:objectName(), data) then
                            p:obtainCard(card)
                            room:changeKingdom(p, "shu")
                            break
                        end
                    end
                end
            end
        elseif event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            if (move.from and (move.from:objectName() == player:objectName()) and (move.from_places:contains(sgs.Player_PlaceHand) or  move.from_places:contains(sgs.Player_PlaceEquip))) and not (move.to and (move.to:objectName() == player:objectName() and (move.to_place == sgs.Player_PlaceHand or move.to_place == sgs.Player_PlaceEquip))) then
                local ids = sgs.IntList()
                for _, id in sgs.qlist(move.card_ids) do
                    if sgs.Sanguosha:getCard(id):isKindOf("EquipCard") then
                        ids:append(id)
                    end
                end
                if ids:isEmpty() then return false end
                if player:getKingdom() == "wu" then
                    for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                        if p:getKingdom() ~= "qun" then
                            if room:askForSkillInvoke(p, self:objectName(), data) then
                                player:drawCards(1, self:objectName())
                                p:drawCards(1, self:objectName())
                                room:changeKingdom(p, "qun")
                            end
                        end
                    end
                end
            end
        end
    end,
    can_trigger = function(self, target)
        return target ~= nil
    end,
}

--[[
	技能名：骄扈
	相关武将：雍闿[官盗]
	技能描述：蜀势力技，摸牌阶段，你多摸X张牌（X为一号位已损失体力值+1）。
	引用：sfofl_jiaohu
]] --
sfofl_jiaohu = sgs.CreateTriggerSkill {
    name = "sfofl_jiaohu",
    frequency = sgs.Skill_Frequent,
    events = { sgs.DrawNCards },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local draw = data:toDraw()
        if draw.reason ~= "draw_phase" then return false end
        if player:getKingdom() ~= "shu" then return false end
        if event == sgs.DrawNCards then
            local x = 0
            for _, p in sgs.qlist(room:getAllPlayers()) do
                if p:getSeat() == 1 then
                    x = p:getLostHp() + 1
                end
            end
            draw.num = draw.num + x
            room:sendCompulsoryTriggerLog(player, "sfofl_jiaohu", true)
            data:setValue(draw)
        end
    end
}

--[[
	技能名：劝叛
	相关武将：雍闿[官盗]
	技能描述：吴势力技，当你获得装备牌后，你可以展示其中一张并交给一名其他角色。
	引用：sfofl_quanpan
]] --

sfofl_quanpan = sgs.CreateTriggerSkill {
    name = "sfofl_quanpan",
    frequency = sgs.Skill_NotFrequent,
    events = { sgs.CardsMoveOneTime },
    on_trigger = function(self, event, player, data, room)
        if player:getKingdom() ~= "wu" then return false end
        if event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            if not room:getTag("FirstRound"):toBool() and player:getPhase() ~= sgs.Player_NotActive and move.to and move.to:objectName() == player:objectName() then
                local ids = sgs.IntList()
                for _, id in sgs.qlist(move.card_ids) do
                    if room:getCardOwner(id) == player and room:getCardPlace(id) == sgs.Player_PlaceHand and sgs.Sanguosha:getCard(id):isKindOf("EquipCard") then
                        ids:append(id)
                    end
                end
                if ids:isEmpty() then return false end
                if room:askForSkillInvoke(player, self:objectName(), data) then
                   
                    local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                    dummy:deleteLater()
                    room:fillAG(ids)
                    local card_id = room:askForAG(player, ids, false, self:objectName())
                    dummy:addSubcard(card_id)
                    room:clearAG()
                    room:showCard(player, card_id)
                    room:setPlayerMark(player, "sfofl_quanpan", card_id)
                    local target = room:askForPlayerChosen(player,room:getOtherPlayers(player),self:objectName())
                    room:setPlayerMark(player, "sfofl_quanpan", 0)
                    target:obtainCard(dummy)
                    
                end
            end
        end
    end
}

--[[
	技能名：惑亂
	相关武将：雍闿[官盗]
	技能描述：群势力技，你与蜀势力角色相互造成伤害+1。
	引用：sfofl_huoluan
]] --
sfofl_huoluan = sgs.CreateTriggerSkill{
	name = "sfofl_huoluan",
	frequency = sgs.Skill_Frequent,
	events = {sgs.DamageCaused, sgs.DamageInflicted},
	on_trigger = function(self, event, player, data)
		local damage = data:toDamage()
        if player:getKingdom() ~= "qun" then
            return false
        end
        if event == sgs.DamageCaused and (not damage.to or damage.to:getKingdom() ~= "shu") then
            return false
        end
        if event == sgs.DamageInflicted and (not damage.from or damage.from:getKingdom() ~= "shu") then
            return false
        end
        damage.damage = damage.damage + 1
        local log = sgs.LogMessage()
        log.type = "#skill_add_damage"
        log.from = damage.from
        log.to:append(damage.to)
        log.arg  = self:objectName()
        log.arg2 = damage.damage
        player:getRoom():sendLog(log)
        data:setValue(damage)
		return false
	end,
}


sfofl_yongcai:addSkill(sfofl_xiaofan)
sfofl_yongcai:addSkill(sfofl_jiaohu)
sfofl_yongcai:addSkill(sfofl_quanpan)
sfofl_yongcai:addSkill(sfofl_huoluan)

sfofl_chezhou = sgs.General(extension_s, "sfofl_chezhou", "wei", 6)
--[[
	技能名：暗谋
	相关武将：雍闿[官盗]
	技能描述：锁定技，游戏开始时，你秘密选择一名其他角色，你与其互相使用牌无次数限制。
	引用：sfofl_anmou
]] --

sfofl_anmou = sgs.CreateTriggerSkill{
	name = "sfofl_anmou",
	events = {sgs.GameStart},
	frequency = sgs.Skill_Compulsory,
	on_trigger = function(self, event, player, data, room)
		if event == sgs.GameStart then
			local to = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName(), "sfofl_anmou-invoke", false, false)
			if to then
				room:broadcastSkillInvoke(self:objectName(), math.random(1, 2))
                room:addPlayerMark(to, "sfofl_anmou"..player:objectName())
                local splayer = sgs.SPlayerList()
                splayer:append(player)
                room:addPlayerMark(to, "&sfofl_anmou+to+#"..player:objectName(), 1, splayer)
			end
        end
    end
}
sfofl_anmou_buff = sgs.CreateTargetModSkill {
	name = "#sfofl_anmou_buff",
    residue_func = function(self, from, card, to)
        if from and to then
            if to:getMark("sfofl_anmou"..from:objectName()) > 0 or from:getMark("sfofl_anmou"..to:objectName()) > 0 then
			    return 999
            end
		end
        return 0
    end,
}


--[[
	技能名：偷算
	相关武将：雍闿[官盗]
	技能描述：锁定技，若你或“暗谋”角色首次对对方造成伤害时，此伤害+1且伤害来源摸三张牌，然后你失去此技能。
	引用：sfofl_tousuan
]] --
sfofl_tousuan = sgs.CreateTriggerSkill{
	name = "sfofl_tousuan",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.DamageCaused, sgs.DamageInflicted},
	on_trigger = function(self, event, player, data)
		local damage = data:toDamage()
        if event == sgs.DamageCaused and damage.to:getMark("sfofl_anmou"..player:objectName()) == 0 then
            return false
        end
        if event == sgs.DamageInflicted and (not damage.from or damage.from:getMark("sfofl_anmou"..player:objectName()) == 0) then
            return false
        end
        local target
        if event == sgs.DamageCaused then
            target = damage.to
        else
            target = damage.from
        end
        damage.damage = damage.damage + 1
        local log = sgs.LogMessage()
        log.type = "#skill_add_damage"
        log.from = damage.from
        log.to:append(damage.to)
        log.arg  = self:objectName()
        log.arg2 = damage.damage
        player:getRoom():sendLog(log)
        data:setValue(damage)
        damage.from:drawCards(3, self:objectName())
        player:getRoom():addPlayerMark(target, "&sfofl_anmou+to+#"..player:objectName())
        player:getRoom():handleAcquireDetachSkills(player, "-sfofl_tousuan")
		return false
	end,
}


sfofl_chezhou:addSkill(sfofl_anmou)
sfofl_chezhou:addSkill(sfofl_anmou_buff)
extension_s:insertRelatedSkills("sfofl_anmou", "#sfofl_anmou_buff")
sfofl_chezhou:addSkill(sfofl_tousuan)


sfofl_tianchuan = sgs.General(extension_e, "sfofl_tianchuan", "qun", 3, false)
--[[
	技能名：狐影
	相关武将：田钏[官盗]
	技能描述：锁定技，游戏开始时，你从游戏外获得两张【刑鞭】；其他角色死亡后，你从游戏外获得一张【刑鞭】。【刑鞭】不计入你的手牌上限；其他角色计算与你的距离+X（X为你场上的【刑鞭】数）。
	引用：sfofl_huying
]] --
sfofl_huying = sgs.CreateTriggerSkill{
    name = "sfofl_huying",
	frequency = sgs.Skill_Compulsory,
    waked_skills = "sfofl_xingbian",
	events = {sgs.GameStart, sgs.Death, sgs.EventPhaseProceeding},
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
		if event == sgs.GameStart then
            local x = 0
			for _,id in sgs.qlist(sgs.Sanguosha:getRandomCards(true))do
                local nmrq = sgs.Sanguosha:getEngineCard(id)
                if not nmrq:isKindOf("sfofl_xingbian")
                or room:getCardOwner(id) then continue end
                room:obtainCard(player,nmrq)
                room:ignoreCards(player, sgs.Sanguosha:getCard(id))
                x = x + 1
                if x >= 5 then 
                    break
                end
            end
        elseif event == sgs.Death then
            for _,id in sgs.qlist(sgs.Sanguosha:getRandomCards(true))do
                local nmrq = sgs.Sanguosha:getEngineCard(id)
                if not nmrq:isKindOf("sfofl_xingbian")
                or room:getCardOwner(id) then continue end
                room:obtainCard(player,nmrq)
                room:ignoreCards(player, sgs.Sanguosha:getCard(id))
                break
            end
        elseif event == sgs.EventPhaseProceeding then
            if player:getPhase() ~= sgs.Player_Discard then return false end
            local ignore = sgs.IntList()
            for _,card in sgs.qlist(player:getHandcards()) do
                if card:isKindOf("sfofl_xingbian") then
                    ignore:append(card:getEffectiveId())
                end
            end
            if ignore:isEmpty() then return false end
            room:ignoreCards(player, ignore);
		    return false;
		end
	end,
}
sfofl_huying_distance = sgs.CreateDistanceSkill {
	name = "#sfofl_huying_distance",
	correct_func = function(self, from, to)
        if to:hasSkill("sfofl_huying") then
            return getxingbian(to)
        end
	end
}

--[[
	技能名：潜荆
	相关武将：田钏[官盗]
	技能描述：你可以将场上或手牌中的一张【刑鞭】当不计次数的【杀】使用。当你造成或受到伤害后，你可以将手牌中的一张【刑鞭】置入一名角色的任意装备栏，若其为你，你摸一张牌。
	引用：sfofl_qianjing
]] --

sfofl_qianjingCard = sgs.CreateSkillCard{
    name = "sfofl_qianjing",
    filter = function(self, targets, to_select, player)
        local qtargets = sgs.PlayerList()
        for _,p in ipairs(targets) do
            qtargets:append(p)
        end
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
            local card, user_string = nil, self:getUserString()
            if user_string ~= "" then
                card = sgs.Sanguosha:cloneCard(user_string:split("+")[1])
                card:setSkillName("sfofl_qianjing")
            end
            return card and card:targetFilter(qtargets, to_select, player) and not player:isProhibited(to_select, card, qtargets)
        end
    
        local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
        slash:setSkillName("sfofl_qianjing")
        slash:addSubcards(self:getSubcards())
        slash:deleteLater()
        return slash and slash:targetFilter(qtargets, to_select, player) and not player:isProhibited(to_select, slash, qtargets)
    end,
    feasible = function(self, targets, player)
        local user_string = self:getUserString()
        local use_card = sgs.Sanguosha:cloneCard(user_string, sgs.Card_SuitToBeDecided, -1)
        use_card:setSkillName("sfofl_qianjing")
        for _,id in sgs.qlist(self:getSubcards()) do
            use_card:addSubcard(sgs.Sanguosha:getCard(id))
        end

        local qtargets = sgs.PlayerList()
        for _,p in ipairs(targets) do
            qtargets:append(p)
        end
        return use_card and use_card:targetsFeasible(qtargets, player)
    end,
    on_validate = function(self, cardUse)
        local source = cardUse.from
        local room = source:getRoom()
        local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
        slash:setSkillName("sfofl_qianjing")
        for _,id in sgs.qlist(self:getSubcards()) do
            slash:addSubcard(sgs.Sanguosha:getCard(id))
        end
        room:setCardFlag(slash, "RemoveFromHistory")
        return slash
    end,
    on_validate_in_response = function(self, source)
        local room = source:getRoom()

        local user_string = sgs.Sanguosha:getCurrentCardUsePattern()
        local use_card = sgs.Sanguosha:cloneCard(user_string, sgs.Card_SuitToBeDecided, -1)
        use_card:setSkillName("sfofl_qianjing")
        for _,id in sgs.qlist(self:getSubcards()) do
            use_card:addSubcard(sgs.Sanguosha:getCard(id))
        end
        return use_card
    end,
}


sfofl_qianjingEquipCard = sgs.CreateSkillCard{
	name = "sfofl_qianjingEquipCard",
	will_throw = false,
	filter = function(self,targets,to_select,source)
		if self:subcardsLength()>0 then
            local id = self:getSubcards():first()
            local n = sgs.Sanguosha:getCard(id):getRealCard():toEquipCard():location()
            return to_select:hasEquipArea(n) and to_select:getEquip(n)==nil and #targets == 0
		end
	end,
	on_use = function(self,room,source,targets)
        local to = targets[1]
        if self:subcardsLength()>0 then
            local id = self:getSubcards():first()
            local c = sgs.Sanguosha:getCard(id)
            id = c:getRealCard():toEquipCard():location()
            if to:isAlive() and to:hasEquipArea(id) then
                room:moveCardTo(c,to,sgs.Player_PlaceEquip)
            end
            if to:objectName() == source:objectName() then
                source:drawCards(1, self:objectName())
            end
        end
	end,
}

sfofl_qianjingVS = sgs.CreateViewAsSkill{
    name = "sfofl_qianjing",
    n = 1,
    expand_pile = "/sfofl_xingbian/sfofl_qianjing",
    view_filter = function(self, selected, to_select)
        if #selected >= 1 then return false end
        local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
        if pattern == "@@sfofl_qianjing" then
            return sgs.Self:getHandcards():contains(to_select) and to_select:isKindOf("sfofl_xingbian")
        end
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
            if (not to_select:isKindOf("sfofl_xingbian")) then return false end
            local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
            slash:setSkillName("sfofl_qianjing")
            slash:addSubcard(to_select)
            slash:deleteLater()
            return not sgs.Self:isLocked(slash)
        else
            local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
            if pattern == "slash" then
                if (not to_select:isKindOf("sfofl_xingbian")) then return false end
                local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
                slash:setSkillName("sfofl_qianjing")
                slash:addSubcard(to_select)
                slash:deleteLater()
                return not sgs.Self:isCardLimited(slash, sgs.Card_MethodResponse)
            end
        end
    end,
    view_as = function(self,cards)
        if #cards == 0 then return nil end
        local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
        if pattern == "@@sfofl_qianjing" then
            local card = sfofl_qianjingEquipCard:clone()
            for _,c in ipairs(cards) do
                card:addSubcard(c)
            end
            return card
        end
        local card = sfofl_qianjingCard:clone()
        for _,c in ipairs(cards) do
            card:addSubcard(c)
        end
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
            card:setUserString("slash")
            return card
        end
        local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
        card:setUserString(pattern)
        return card
    end,
    enabled_at_play = function(self, player)
        local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, -1)
        slash:setSkillName("sfofl_qianjing")
        slash:deleteLater()
        return slash:isAvailable(player)
    end,
    enabled_at_response = function(self, player, pattern)
        return (pattern == "slash" and sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE) or pattern == "@@sfofl_qianjing" 
    end,
}
sfofl_qianjing = sgs.CreateTriggerSkill{
	name = "sfofl_qianjing",
	events = {sgs.Damaged,sgs.Damage},
    view_as_skill = sfofl_qianjingVS,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()
        local pattern = {}
        for _,card in sgs.qlist(player:getHandcards()) do
            if card:isKindOf("sfofl_xingbian") then
                table.insert(pattern, card:getEffectiveId())
            end
        end
        if #pattern == 0 then return false end
		room:askForUseCard(player,"@@sfofl_qianjing","@sfofl_qianjing")
	end,
}

--[[
	技能名：鞭笞
	相关武将：田钏[官盗]
	技能描述：限定技，结束阶段，你可以弃置场上所有【刑鞭】，并令因此失去牌的其他角色依次选择一项：1.你操控其执行一个额外的出牌阶段且至多使用两张牌；2.失去2点体力
	引用：sfofl_bianchi
]] --

sfofl_bianchiCard = sgs.CreateSkillCard{
    name = "sfofl_bianchi",
    will_throw = false ,
    handling_method = sgs.Card_MethodUse,
    filter = function(self, targets, to_select, from)
        local target
        for _,p in sgs.qlist(from:getAliveSiblings()) do
            if p:hasFlag("sfofl_bianchi") then
                target = p
                break
            end
        end
        if target then
            local dc = sgs.Sanguosha:getCard(self:getSubcards():first())
            if dc:targetFixed() then return false end
            dc:setSkillName("sfofl_bianchi")
            local plist = sgs.PlayerList()
            for i = 1, #targets do plist:append(targets[i]) end
            return dc:targetFilter(plist,to_select,target)
        end
        return false
	end,
    feasible = function(self,targets,from)
        local target
        for _,p in sgs.qlist(from:getAliveSiblings()) do
            if p:hasFlag("sfofl_bianchi") then
                target = p
                break
            end
        end
        if target then
            local dc = sgs.Sanguosha:getCard(self:getSubcards():first())
            dc:setSkillName("sfofl_bianchi")
            if card and card:canRecast() and #targets == 0 then
                return false
            end
            local plist = sgs.PlayerList()
            for i = 1, #targets do plist:append(targets[i]) end
            return dc:targetFixed() or dc:targetsFeasible(plist, target)
        end
        return false
	end,
    on_use = function(self,room,source,targets)
        local player = source
        local room = player:getRoom()
        local dc = sgs.Sanguosha:getCard(self:getSubcards():first())
		card:setSkillName(self:objectName())
        local target
        for _,p in sgs.qlist(room:getAlivePlayers()) do
            if p:hasFlag("sfofl_bianchi") then
                target = p
                break
            end
        end
        if target then
            local new_use = sgs.CardUseStruct()
            new_use.card = dc
            new_use.from = target
            for i,p in sgs.list(targets)do
            new_use.to:append(p)
            end
            room:useCard(new_use)
        end
    end
}
sfofl_bianchiVS = sgs.CreateViewAsSkill{
    name = "sfofl_bianchi",
    n = 0,
    expand_pile = "#sfofl_bianchi",
    view_filter = function(self, selected, to_select)
        return sgs.Self:getPile("#sfofl_bianchi"):contains(to_select:getId())
    end,
    view_as = function(self, cards)
        if #cards == 1 then
            local card = sfofl_bianchiCard:clone()
			card:addSubcard(cards[1])
			return card
        end
	end,
    enabled_at_play = function(self, player)
        return false
    end,
    enabled_at_response = function(self, player, pattern)
        return pattern == "@@sfofl_bianchi"
    end,
}
sfofl_bianchi = sgs.CreateTriggerSkill{
    name = "sfofl_bianchi",
    frequency = sgs.Skill_Limited,
    limit_mark = "@sfofl_bianchi",
	events = {sgs.EventPhaseStart},
    view_as_skill = sfofl_bianchiVS,
    on_trigger = function(self, event, player, data, room)
        if player:getPhase() == sgs.Player_Finish and player:getMark("@sfofl_bianchi") > 0 then
            local can_invoke = false
            for _,p in sgs.qlist(room:getAlivePlayers()) do
                for _,card in sgs.qlist(p:getCards("e")) do
                    if card:isKindOf("sfofl_xingbian") then
                        can_invoke = true
                        break
                    end
                end
            end
            if can_invoke and room:askForSkillInvoke(player, self:objectName()) then
                room:doSuperLightbox(player,self:objectName())
                room:removePlayerMark(player, "@sfofl_bianchi")
                local targets = sgs.SPlayerList()
                for _,p in sgs.qlist(room:getAllPlayers()) do
                    local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                    dummy:deleteLater()
                    for _,card in sgs.qlist(p:getCards("e")) do
                        if card:isKindOf("sfofl_xingbian") then
                            dummy:addSubcard(card)
                        end
                    end
                    if dummy:subcardsLength() > 0 then
                        targets:append(p)
                        room:throwCard(dummy, player)
                    end
                end
                if targets:length() > 0 then
                    for _,p in sgs.qlist(targets) do
                        if p:objectName() == player:objectName() then continue end
                        local choicelist = { "losehp" }
                        if not p:isKongcheng() then
                            table.insert(choicelist, "usecard="..player:objectName())
                        end
                        if room:askForChoice(p,self:objectName(),table.concat(choicelist, "+"), ToData(player)) == "losehp" then
                            room:loseHp(p,2,true,player,self:objectName())
                        else
                            local view_cards = sgs.IntList()
                            local card_ids = {}
                            for _,card in sgs.qlist(p:getHandcards()) do
                                local id = card:getEffectiveId()
                                view_cards:append(id)
                                table.insert(card_ids, id)
                            end
                            local log = sgs.LogMessage()
                            log.type = "$ViewAllCards"
                            log.from = player
                            log.to:append(p)
                            log.card_str = table.concat(sgs.QList2Table(card_ids), "+")
                            room:sendLog(log, player)
                            room:setPlayerFlag(p, "sfofl_bianchi")
                            room:notifyMoveToPile(player, view_cards, "sfofl_bianchi",sgs.Player_PlaceHand,true, true)
                            local card = room:askForUseCard(player, "@@sfofl_bianchi", "@sfofl_bianchi:"..p:getGeneralName())
                            room:notifyMoveToPile(player, view_cards, "sfofl_bianchi", sgs.Player_PlaceHand, false, true)
                            if card then
                                local view_cards = sgs.IntList()
                                for _,card in sgs.qlist(p:getHandcards()) do
                                    local id = card:getEffectiveId()
                                    view_cards:append(id)
                                end
                                room:notifyMoveToPile(player, view_cards, "sfofl_bianchi",sgs.Player_PlaceHand,true, true)
                                local card = room:askForUseCard(player, "@@sfofl_bianchi", "@sfofl_bianchi:"..p:getGeneralName())
                                room:notifyMoveToPile(player, view_cards, "sfofl_bianchi", sgs.Player_PlaceHand, false, true)
                            end
                            room:setPlayerFlag(p, "-sfofl_bianchi")
                            
                        end
                    end
                end
            end
        end
    end
}

--[[
	技能名：刑鞭
	相关武将：田钏[官盗]
	技能描述：装备/任意装备栏 黑桃9\
锁定技，你装备区内每有一张【刑鞭】，你的攻击范围便+1；你的出牌阶段开始时，田钏指定一名其他角色，结束阶段，若你此回合未对其使用【杀】或未对其造成伤害，你对自己造成1点伤害。
	引用：sfofl_xingbian
]] --

sfofl_xingbian_weapon = sgs.CreateWeapon{
	name = "_sfofl_xingbian_weapon",
	class_name = "sfofl_xingbian",
	range = 1,
    equip_skill = sfofl_xingbianTr,
    suit = sgs.Card_Spade,
    number = 9,
	on_install = function(self,player)
		local room = player:getRoom()
		room:attachSkillToPlayer(player,"_sfofl_xingbian")
		return false
	end,
	on_uninstall = function(self,player)
        player:getRoom():detachSkillFromPlayer(player,"_sfofl_xingbian",true,true)
	end,
}
sfofl_xingbian_armor = sgs.CreateArmor{
	name = "_sfofl_xingbian_armor",
	class_name = "sfofl_xingbian",
    equip_skill = sfofl_xingbianTr,
    suit = sgs.Card_Spade,
    number = 9,
	on_install = function(self,player)
		local room = player:getRoom()
		room:attachSkillToPlayer(player,"_sfofl_xingbian")
		return false
	end,
	on_uninstall = function(self,player)
        player:getRoom():detachSkillFromPlayer(player,"_sfofl_xingbian",true,true)
	end,
}

sfofl_xingbian_offensivehorse = sgs.CreateOffensiveHorse{
	name = "_sfofl_xingbian_offensivehorse",
	class_name = "sfofl_xingbian",
    equip_skill = sfofl_xingbianTr,
    suit = sgs.Card_Spade,
    number = 9,
	on_install = function(self,player)
		local room = player:getRoom()
		room:attachSkillToPlayer(player,"_sfofl_xingbian")
		return false
	end,
	on_uninstall = function(self,player)
        player:getRoom():detachSkillFromPlayer(player,"_sfofl_xingbian",true,true)
	end,
}
sfofl_xingbian_defensivehorse = sgs.CreateDefensiveHorse{
	name = "_sfofl_xingbian_defensivehorse",
	class_name = "sfofl_xingbian",
    equip_skill = sfofl_xingbianTr,
    suit = sgs.Card_Spade,
    number = 9,
	on_install = function(self,player)
		local room = player:getRoom()
		room:attachSkillToPlayer(player,"_sfofl_xingbian")
		return false
	end,
	on_uninstall = function(self,player)
        player:getRoom():detachSkillFromPlayer(player,"_sfofl_xingbian",true,true)
	end,
}

sfofl_xingbian_treasure = sgs.CreateTreasure{
	name = "_sfofl_xingbian_treasure",
	class_name = "sfofl_xingbian",
	equip_skill = sfofl_xingbianTr,
    suit = sgs.Card_Spade,
    number = 9,
	on_install = function(self,player)
		local room = player:getRoom()
		room:attachSkillToPlayer(player,"_sfofl_xingbian")
	end,
	on_uninstall = function(self,player)
		player:getRoom():detachSkillFromPlayer(player,"_sfofl_xingbian",true,true)
	end,
}
function getxingbian(player)
    local x = 0
    if player:hasWeapon("_sfofl_xingbian_weapon") then
        x = x + 1
    end
    if player:hasArmorEffect("_sfofl_xingbian_armor") then
        x = x + 1
    end
    if player:hasDefensiveHorse("_sfofl_xingbian_defensivehorse") then
        x = x + 1
    end
    if player:hasOffensiveHorse("_sfofl_xingbian_offensivehorse") then
        x = x + 1
    end
    if player:hasTreasure("_sfofl_xingbian_treasure") then
        x = x + 1
    end
    return x
end
sfofl_xingbian_range = sgs.CreateAttackRangeSkill {
	name = "#sfofl_xingbian_range",
	extra_func = function(self, player)
        local x = player:getEquips():length()
		if player:hasEquipSkill("sfofl_xingbian") and getxingbian(player) > 0 then return getxingbian(player) end
	end,
}
sfofl_xingbianTr = sgs.CreateTriggerSkill {
	name = "_sfofl_xingbian",
    global = true,
	frequency = sgs.Skill_Compulsory,
	events = { sgs.EventPhaseStart, sgs.Damage, sgs.TargetSpecified },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.EventPhaseStart then
            if player:getPhase() == sgs.Player_Play then
                local target
                for _, p in sgs.qlist(room:getAllPlayers()) do
                    if string.find(p:getGeneralName(), "tianchuan") or string.find(p:getGeneral2Name(), "tianchuan") then
                        target = p
                        break
                    end
                end
                if not target then
                    for _, p in sgs.qlist(room:findPlayersBySkillName("sfofl_huying")) do
                        target = p
                        break
                    end
                end
                if target then
                    local dest = room:askForPlayerChosen(target, room:getOtherPlayers(player), self:objectName())
				    if dest then
                        room:addPlayerMark(dest, "&sfofl_xingbian+to+#"..target:objectName().."-Clear")
                        room:addPlayerMark(dest, "sfofl_xingbianTarget"..player:objectName().."-Clear")
                    end
                end
            elseif player:getPhase() == sgs.Player_Finish then
                for _, p in sgs.qlist(room:getAllPlayers()) do
                    if p:getMark("sfofl_xingbianTarget"..player:objectName().."-Clear") > 0 then
                        if player:getMark("sfofl_xingbian:"..p:objectName()..":-Clear") == 0 then
                            room:damage(sgs.DamageStruct(self:objectName(), player, player, 1))
                        end
                    end
                end
            end
        elseif event == sgs.Damage then
            local damage = data:toDamage()
            if damage.to and damage.to:getMark("sfofl_xingbianTarget"..player:objectName().."-Clear") > 0 then
                room:addPlayerMark(player, "sfofl_xingbian:"..damage.to:objectName()..":-Clear")
            end
        elseif event == sgs.TargetSpecified then
            local use = data:toCardUse()
            if use.card:isKindOf("Slash") then
                for _, p in sgs.qlist(use.to) do
                    if p:getMark("sfofl_xingbianTarget"..player:objectName().."-Clear") > 0 then
                        room:addPlayerMark(player, "sfofl_xingbian:"..p:objectName()..":-Clear")
                    end
                end
            end
        end
	end,
    can_trigger = function(self,target)
		return target and getxingbian(target) > 0 
	end,
}



sfofl_tianchuan:addSkill(sfofl_huying)
sfofl_tianchuan:addSkill(sfofl_huying_distance)
extension_e:insertRelatedSkills("sfofl_huying", "#sfofl_huying_distance")
sfofl_tianchuan:addSkill(sfofl_qianjing)
sfofl_tianchuan:addSkill(sfofl_bianchi)

sfofl_xingbian_weapon:setParent(extension_card)
sfofl_xingbian_armor:setParent(extension_card)
sfofl_xingbian_offensivehorse:setParent(extension_card)
sfofl_xingbian_defensivehorse:setParent(extension_card)
sfofl_xingbian_treasure:setParent(extension_card)
if not sgs.Sanguosha:getSkill("#sfofl_xingbian_range") then skills:append(sfofl_xingbian_range) end
if not sgs.Sanguosha:getSkill("_sfofl_xingbian") then skills:append(sfofl_xingbianTr) end

--[[
	技能名：常侍
	技能描述：游戏开始时，你获得一张“常侍”标记，当你失去“常侍”标记时，你减1点体力上限。<br>\
    拥有“常侍”标记的角色拥有以下技能：<br>1号位的弃牌阶段开始时，你可以摸一张牌，令其手牌上限+1。当你受到致命伤害时，你可以弃置“常侍”标记，将此伤害转移给另一名有“常侍”标记的角色。
	引用：sfofl_changshi
]] --
sfofl_changshi = sgs.CreateTriggerSkill{
    name = "sfofl_changshi",
    events = {sgs.GameStart, sgs.MarkChanged},
    frequency = sgs.Skill_NotFrequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.GameStart then
            room:addPlayerMark(player, "&sfofl_changshi")
        else
            local mark = data:toMark()
			if mark.name == "&sfofl_changshi" then
			    if mark.gain < 0 then
                    room:loseMaxHp(player, 1, self:objectName())
                end
            end
        end
    end,
}
sfofl_changshi_buff = sgs.CreateTriggerSkill{
    name = "#sfofl_changshi_buff",
    events = {sgs.EventPhaseStart, sgs.DamageInflicted},
    frequency = sgs.Skill_Frequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.EventPhaseStart then
            if player:getPhase() == sgs.Player_Discard and player:getSeat() == 1 then
                for _, p in sgs.qlist(room:findPlayersBySkillName("sfofl_changshi")) do
                    if p:getMark("&sfofl_changshi") > 0 then
                        if room:askForSkillInvoke(p, "sfofl_changshi", ToData(player)) then
                            p:drawCards(1, "sfofl_changshi")
                            room:addMaxCards(player, 1, true)
                        end
                    end
                end
            end
        elseif (event == sgs.DamageInflicted) and (player:getMark("&sfofl_changshi") > 0) then
			local damage = data:toDamage()
			if (damage.damage >= player:getHp()+player:getHujia()) and damage.to:objectName() == player:objectName() and player:askForSkillInvoke("sfofl_changshi", data) then
                local targets = sgs.SPlayerList()
                for _, p in sgs.qlist(room:getOtherPlayers(player)) do
                    if p:getMark("&sfofl_changshi") > 0 then
                        targets:append(p)
                    end
                end
                if targets:isEmpty() then return false end
                room:setTag("sfofl_changshi", data)
                local target = room:askForPlayerChosen(player, targets, "sfofl_changshi", "sfofl_changshi-invoke", true, true)
                room:removeTag("sfofl_changshi")
                if not target then return false end
                room:removePlayerMark(player,"&sfofl_changshi")
                local newdamage = data:toDamage()
                newdamage.to = target
                newdamage.transfer = true;
                newdamage.transfer_reason = "sfofl_changshi";
                data:setValue(newdamage)
                player:setTag("TransferDamage", data)
				return true
			end
        end
    end,
    can_trigger = function(self, target)
        return target
    end,
}
if not sgs.Sanguosha:getSkill("sfofl_changshi") then skills:append(sfofl_changshi) end
if not sgs.Sanguosha:getSkill("#sfofl_changshi_buff") then skills:append(sfofl_changshi_buff) end
extension_e:insertRelatedSkills("sfofl_changshi", "#sfofl_changshi_buff")

sfofl_zhangrang = sgs.General(extension_e, "sfofl_zhangrang", "qun", 4)
sfofl_zhangrang:setGender(sgs.General_Sexless)

--[[
	技能名：滔乱
	相关武将：张让[官盗]
	技能描述：出牌阶段限X次，你可以将一张牌当任意基本牌或普通锦囊牌使用（X为场上有“常侍”标记的角色数，每种牌名每回合限一次）。
	引用：sfofl_taoluan
]] --
sfofl_taoluanVS = sgs.CreateViewAsSkill{
	name = "sfofl_taoluan",
	n = 1,
    response_or_use = true,
	view_filter = function(self,selected,to_select)
		return #selected<1
	end,
	view_as = function(self,cards)
		if #cards < 1 then return nil end
		local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
		if pattern=="" then
			local dc = sgs.Self:getTag("sfofl_taoluan"):toCard()
			if dc==nil then return end
			pattern = dc:objectName()
		end
		for _,pn in sgs.list(pattern:split("+"))do
			local sc = sgs.Sanguosha:cloneCard(pn)
			sc:setSkillName(self:objectName())
			for _,c in sgs.list(cards)do
				sc:addSubcard(c)
			end
			if sgs.Self:isLocked(sc) then
				sc:deleteLater()
				continue
			end
			return sc
		end
	end,
	enabled_at_play = function(self,player)
        local x = 0
        for _,p in sgs.qlist(player:getAliveSiblings(true)) do
            if p:getMark("&sfofl_changshi") > 0 then
                x = x + 1
            end
        end
		return player:getMark("sfofl_taoluanUse-PlayClear")<x
	end,
}
sfofl_taoluan = sgs.CreateTriggerSkill{
	name = "sfofl_taoluan",
	view_as_skill = sfofl_taoluanVS,
	guhuo_type = "lr",
	events = {sgs.PreCardUsed},
	can_trigger = function(self,target)
		return target and target:isAlive()
	end,
	on_trigger = function(self,event,player,data,room)
		if event == sgs.PreCardUsed then
			local use = data:toCardUse()
			if use.card and table.contains(use.card:getSkillNames(),self:objectName()) then
				room:addPlayerMark(player,"sfofl_taoluanUse-PlayClear")
			end
		end
	end,
}

sfofl_zhangrang:addSkill(sfofl_taoluan)
sfofl_zhangrang:addSkill("sfofl_changshi")

sfofl_zhaozhong = sgs.General(extension_e, "sfofl_zhaozhong", "qun", 4)
sfofl_zhaozhong:setGender(sgs.General_Sexless)

--[[
	技能名：鸱嚥
	相关武将：赵忠[官盗]
	技能描述：当你使用【杀】指定一个目标后，你可以令目标角色和你依次将任意张牌置于各自的武将牌上直到回合结束，若其手牌数不大于你，其本回合受到的伤害+1；不小于你，其本回合不能使用手牌。
	引用：sfofl_chiyan
]] --
sfofl_chiyan = sgs.CreateTriggerSkill{
	name = "sfofl_chiyan",
	events = {sgs.TargetSpecified},
	frequency = sgs.Skill_NotFrequent, 
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.TargetSpecified) then
			local use = data:toCardUse()
			if use.card:isKindOf("Slash") then
                local can_invoke = false
				for _,p in sgs.qlist(use.to) do
				    if not p:isKongcheng() and player:askForSkillInvoke(self, ToData(p)) then
                        local card = room:askForExchange(p, self:objectName(), p:getHandcardNum(), 1, false, "@sfofl_chiyan", false)
                        if card then
                            local card_ids = card:getSubcards()
                            local splayers = sgs.SPlayerList()
                            splayers:append(p)
                            p:addToPile("sfofl_chiyan", card_ids, false, splayers)
                        end
                        can_invoke = true
                    end
				end
                if can_invoke then
                    local card = room:askForExchange(player, self:objectName(), player:getHandcardNum(), 1, false, "@sfofl_chiyan", false)
                    if card then
                        local card_ids = card:getSubcards()
                        local splayers = sgs.SPlayerList()
                        splayers:append(player)
                        player:addToPile("sfofl_chiyan", card_ids, false, splayers)
                    end
                    for _,p in sgs.qlist(use.to) do
                        if p:getHandcardNum() <= player:getHandcardNum() then
                            room:addPlayerMark(p, "sfofl_chiyan-Clear")
                            room:addPlayerMark(p, "&sfofl_chiyan-Clear")
                        end
                        if p:getHandcardNum() >= player:getHandcardNum() then
                            room:setPlayerCardLimitation(p, "use", ".|.|.|hand", true)
                        end
                    end
                end
			end
		end
	end
}
sfofl_chiyan_return = sgs.CreateTriggerSkill{
    name = "#sfofl_chiyan_return",
    events = {sgs.EventPhaseStart},
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if player:getPhase() ~= sgs.Player_NotActive then return false end
        for _,target in sgs.qlist(room:getAlivePlayers()) do
            if target:isAlive() and target:getPile("sfofl_chiyan") and target:getPile("sfofl_chiyan"):length() > 0 then
                local obtain = sgs.Sanguosha:cloneCard("jink", sgs.Card_SuitToBeDecided, -1)
                obtain:addSubcards(target:getPile("sfofl_chiyan"))
                room:obtainCard(target, obtain, false)
                obtain:deleteLater()
            end
        end
    end,
    can_trigger = function(self, target)
        return target ~= nil
    end,
}


sfofl_chiyan_buff = sgs.CreateTriggerSkill{
    name = "#sfofl_chiyan_buff", 
    events = {sgs.DamageInflicted}, 
    frequency = sgs.Skill_Compulsory, 
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.DamageInflicted then
            local damage = data:toDamage()
            if player:getMark("sfofl_chiyan-Clear") > 0 and player:objectName() == damage.to:objectName() then
                player:damageRevises(data,player:getMark("sfofl_chiyan-Clear"))
            end
        end
        return false
    end,
	can_trigger = function(self, target)
		return target
	end
}


sfofl_zhaozhong:addSkill(sfofl_chiyan)
sfofl_zhaozhong:addSkill(sfofl_chiyan_return)
sfofl_zhaozhong:addSkill(sfofl_chiyan_buff)
extension_e:insertRelatedSkills("sfofl_chiyan", "#sfofl_chiyan_return")
extension_e:insertRelatedSkills("sfofl_chiyan", "#sfofl_chiyan_buff")
sfofl_zhaozhong:addSkill("sfofl_changshi")

sfofl_sunzhang = sgs.General(extension_e, "sfofl_sunzhang", "qun", 4)
sfofl_sunzhang:setGender(sgs.General_Sexless)

--[[
	技能名：自谋
	相关武将：孙璋[官盗]
	技能描述：锁定技，出牌阶段开始时，你令所有其他角色依次选择一项：1.交给你一张牌；2.弃置你一张牌，然后你对其造成1点伤害。
	引用：sfofl_zimou
]] --
sfofl_zimou = sgs.CreateTriggerSkill{
    name = "sfofl_zimou", 
    events = {sgs.EventPhaseStart}, 
    frequency = sgs.Skill_Compulsory, 
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if player:getPhase() == sgs.Player_Play then
            for _,p in sgs.qlist(room:getAllPlayers()) do
                if not p:isNude() then
                    local optional = false
                    if p:canDiscard(player, "he") then
                        optional = true
                    end
                    local dc = room:askForExchange(p,self:objectName(),1,1,true,"@sfofl_zimou:"..player:objectName(),optional)
					if dc then
						room:giveCard(p,player,dc,self:objectName())
					else
						if p:canDiscard(player, "he") then
                            local id = room:askForCardChosen(p,player,"he",self:objectName(),false,sgs.Card_MethodDiscard)
				            room:throwCard(id,self:objectName(),player,p)
                            room:damage(sgs.DamageStruct(self:objectName(), player, p))
                        end
					end
                else
                    if p:canDiscard(player, "he") then
                        local id = room:askForCardChosen(p,player,"he",self:objectName(),false,sgs.Card_MethodDiscard)
                        room:throwCard(id,self:objectName(),player,p)
                        room:damage(sgs.DamageStruct(self:objectName(), player, p))
                    end
                end
            end
        end
        return false
    end,
}


sfofl_sunzhang:addSkill(sfofl_zimou)
sfofl_sunzhang:addSkill("sfofl_changshi")


sfofl_bilan = sgs.General(extension_e, "sfofl_bilan", "qun", 4)
sfofl_bilan:setGender(sgs.General_Sexless)

--[[
	技能名：庀材
	相关武将：毕岚[官盗]
	技能描述：出牌阶段限一次，你可以令至多X名角色依次将一张手牌置于牌堆顶，然后你亮出牌堆顶等量张牌：其中每有一种类型，你摸一张牌，若你摸了三张牌，因此失去牌的角色依次从亮出的牌中选择一张获得（X为你的体力值）。"
	引用：sfofl_picai
]] --
sfofl_picaiCard = sgs.CreateSkillCard{
	name = "sfofl_picai",
	will_throw = false,
	filter = function(self,targets,to_select,from)
		return #targets<from:getHp() and not to_select:isKongcheng()
	end,
	on_use = function(self,room,source,targets)
		local types = {}
        local x = 0
		for i,p in sgs.list(targets)do
			local dc = room:askForCard(p,".|.|.|hand!","@sfofl_picai",ToData(source),sgs.Card_MethodNone)
			if dc then
				room:moveCardTo(dc,nil,sgs.Player_DrawPile,true)
                if not table.contains(types, dc:getType()) then
                    table.insert(types, dc:getType())
                end
                x = x + 1
			end
		end
        local card_ids = room:showDrawPile(source, x, self:objectName(), true)
        source:drawCards(#types,"sfofl_picai")
        if #types == 3 then
            room:fillAG(card_ids)
            for _,p in sgs.list(targets)do
                if p:isAlive() then
                    local id = room:askForAG(p,card_ids,false,self:objectName())
                    card_ids:removeOne(id)
                    room:takeAG(p,id)
                end
            end
            room:clearAG()
        end
	end
}
sfofl_picai = sgs.CreateViewAsSkill{
	name = "sfofl_picai",
	view_as = function(self,cards)
		return sfofl_picaiCard:clone()
	end,
	enabled_at_play = function(self,player)
		return player:usedTimes("#sfofl_picai")<1
	end,
}

sfofl_bilan:addSkill(sfofl_picai)
sfofl_bilan:addSkill("sfofl_changshi")

sfofl_xiayun = sgs.General(extension_e, "sfofl_xiayun", "qun", 4)
sfofl_xiayun:setGender(sgs.General_Sexless)

--[[
	技能名：谣诼
	相关武将：夏恽[官盗]
	技能描述：出牌阶段限一次或当你受到伤害后，你可以与一名角色拼点：若你赢，其本回合手牌上限-2；若你没赢，你回复1点体力。当你拼点结算完成后，你获得对方的拼点牌。
	引用：sfofl_yaozhuo
]] --

sfofl_yaozhuoCard = sgs.CreateSkillCard{
	name = "sfofl_yaozhuo",
	target_fixed = false,
	filter = function(self, targets, to_select, player)
		return #targets < 1 and player:canPindian(to_select)
	end,
	on_effect = function(self, effect)
        local room = effect.from:getRoom()
        local success = effect.from:pindian(effect.to, "sfofl_yaozhuo", nil)
		if success then
            room:addPlayerMark(effect.to, "&sfofl_yaozhuo+to+#"..effect.from:objectName().."-Clear")
            room:setPlayerMark(effect.to, "ExtraBfMaxCards-Clear", effect.to:getMark("ExtraBfMaxCards-Clear") - 2)
		else
			local recover = sgs.RecoverStruct()
			recover.who = effect.from;
			room:recover(effect.from, recover)
		end
    end
}

sfofl_yaozhuoVS = sgs.CreateViewAsSkill{
	name = "sfofl_yaozhuo",
	n = 0,
	view_as = function(self, cards)
        return sfofl_yaozhuoCard:clone()
	end,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_yaozhuo")
	end,
    enabled_at_response = function(self, player, pattern)
		return string.startsWith(pattern, "@@sfofl_yaozhuo")
	end
}

sfofl_yaozhuo = sgs.CreateTriggerSkill{
	name = "sfofl_yaozhuo" ,
	events = {sgs.Pindian, sgs.Damaged} ,
	view_as_skill = sfofl_yaozhuoVS,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
        if event == sgs.Pindian then
            local pindian = data:toPindian()
            local to_obtain = nil
            local jianyong = nil
            if (pindian.from and pindian.from:isAlive() and pindian.from:hasSkill(self:objectName())) then
                jianyong = pindian.from
                to_obtain = pindian.to_card
            elseif (pindian.to and pindian.to:isAlive() and pindian.to:hasSkill(self:objectName())) then
                jianyong = pindian.to
                to_obtain = pindian.from_card
            end
            if jianyong and to_obtain and (room:getCardPlace(to_obtain:getEffectiveId()) == sgs.Player_PlaceTable) then
                if room:askForSkillInvoke(jianyong, self:objectName(), data) then
                    jianyong:obtainCard(to_obtain)
                end
            end
        else
            local damage = data:toDamage()
            if damage.to == player and player:hasSkill(self) then
                room:askForUseCard(player, "@@sfofl_yaozhuo","@sfofl_yaozhuo")
            end
        end
		return false
	end,
	can_trigger = function(self, target)
		return target
	end
}
sfofl_xiayun:addSkill(sfofl_yaozhuo)
sfofl_xiayun:addSkill("sfofl_changshi")

sfofl_lisong = sgs.General(extension_e, "sfofl_lisong", "qun", 4)
sfofl_lisong:setGender(sgs.General_Sexless)

--[[
	技能名：窥机
	相关武将：夏恽[官盗]
	技能描述：出牌阶段限一次，你可以观看一名其他角色的手牌，然后你可以弃置你与其共计四张花色各不相同的手牌。若如此做，弃置牌数较多的角色失去1点体力，弃置牌数较少的角色获得“仇海”直到本轮结束。
	引用：sfofl_kuiji
]] --

sfofl_kuijiVS = sgs.CreateViewAsSkill{
    name = "sfofl_kuiji",
    n = 99,
    response_pattern = "@@sfofl_kuiji",
    expand_pile = "#sfofl_kuiji",
    view_filter = function(self, selected, to_select)
        if not sgs.Self:hasFlag("sfofl_kuiji") then
            return false
        else
            if #selected > 0 then
                for _,card in ipairs(selected) do
			        if card:getSuit() == to_select:getSuit() then return false end
		        end
            end
            if (not sgs.Self:getHandcards():contains(to_select)) and (not sgs.Self:getPile("#sfofl_kuiji"):contains(to_select:getId())) then return false end
        end
		return true
	end,
    view_as = function(self, cards)
        local card = sfofl_kuijiCard:clone()
        if not sgs.Self:hasFlag("sfofl_kuiji") then
            return card
        else
            card = sfofl_kuijidisCard:clone()
            if #cards ~= 4 then return nil end
            for _,p in ipairs(cards) do
                card:addSubcard(p)
            end
            return card
        end
	end,
    enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_kuiji") 
	end,
}

sfofl_kuijiCard = sgs.CreateSkillCard{
    name = "sfofl_kuiji",
    filter = function(self, targets, to_select)
        if not sgs.Self:hasFlag("sfofl_kuiji") then
		    return #targets < 1 and to_select:objectName() ~= sgs.Self:objectName() and (not to_select:isKongcheng())
        else 
            return to_select:objectName() == sgs.Self:objectName()
        end
	end,
	on_effect = function(self, effect)
		local room = effect.from:getRoom()
        local thands = sgs.IntList()
        if not effect.to:isKongcheng() then
            for _,card in sgs.qlist(effect.to:getHandcards()) do
                thands:append(card:getId())
            end
        end

        room:notifyMoveToPile(effect.from, thands, "sfofl_kuiji", sgs.Player_PlaceHand, true)
        room:setPlayerFlag(effect.from, "sfofl_kuiji")

        local _data = sgs.QVariant()
        _data:setValue(effect.to)
        effect.from:setTag("sfofl_kuiji", _data)--ai

        local card = room:askForUseCard(effect.from, "@@sfofl_kuiji", "@sfofl_kuiji:"..effect.to:objectName())
        room:setPlayerFlag(effect.from, "-sfofl_kuiji")
        if not thands:isEmpty() then
            room:notifyMoveToPile(effect.from, thands, "sfofl_kuiji", sgs.Player_PlaceHand, false)
        end

        if not card then return false end
        
        local throwcard = card:getSubcards()
        local from_ids, to_ids = sgs.IntList(), sgs.IntList()
        
        for _,id in sgs.qlist(throwcard) do
            if thands:contains(id) then
                from_ids:append(id)
            else
                to_ids:append(id)
            end
        end
        
        local moves = sgs.CardsMoveList()
        if (not from_ids:isEmpty()) then 
            local move1 = sgs.CardsMoveStruct(from_ids, effect.to, nil, sgs.Player_PlaceHand, sgs.Player_DiscardPile,
							sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_THROW, effect.to:objectName(), nil, "sfofl_kuiji"))
            moves:append(move1)
            
        end
        
        if (not to_ids:isEmpty()) then
            local move2 = sgs.CardsMoveStruct(to_ids, effect.from, nil, sgs.Player_PlaceHand, sgs.Player_DiscardPile,
							sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_THROW, effect.from:objectName(), nil, "sfofl_kuiji"))
            moves:append(move2)
        end
        
        if (not moves:isEmpty()) then
            room:moveCardsAtomic(moves, true)
        end
        if from_ids:length() == to_ids:length() then return end
        if from_ids:length() > to_ids:length() then
            room:loseHp(effect.from,1,true,effect.from,self:objectName())
            room:addPlayerMark(effect.to, "sfofl_kuiji_chouhai_lun")
            room:handleAcquireDetachSkills(effect.to, "chouhai")
        else
            room:loseHp(effect.to,1,true,effect.from,self:objectName())
            room:handleAcquireDetachSkills(effect.from, "chouhai")
            room:addPlayerMark(effect.from, "sfofl_kuiji_chouhai_lun")
        end

        
    end
}
sfofl_kuijidisCard = sgs.CreateSkillCard{
    name = "sfofl_kuijidisCard",
    handling_method = sgs.Card_MethodDiscard,
    will_throw = false,
    target_fixed = true,
    on_use = function(self, room, source, targets)
        return false
    end
}

sfofl_kuiji = sgs.CreateTriggerSkill{
	name = "sfofl_kuiji",
	view_as_skill = sfofl_kuijiVS,
	events = {sgs.RoundEnd},
    waked_skills = "chouhai",
	can_trigger = function(self,player)
		return player and player:isAlive()
	end,
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
        for _,m in sgs.list(player:getMarkNames())do
            if m:startsWith("sfofl_kuiji_chouhai")
            then room:handleAcquireDetachSkills(player, "-chouhai") end
        end
	end,
}

sfofl_lisong:addSkill(sfofl_kuiji)
sfofl_lisong:addSkill("sfofl_changshi")

sfofl_duangui = sgs.General(extension_e, "sfofl_duangui", "qun", 4)
sfofl_duangui:setGender(sgs.General_Sexless)

--[[
	技能名：叱吓
	相关武将：夏恽[官盗]
	技能描述：当你使用【杀】指定唯一目标/成为【杀】的唯一目标后，你可以摸两张牌并展示两张手牌，然后你与目标角色/使用者拼点：若你赢，此【杀】伤害+1；若你没赢，你弃置两张牌。
	引用：sfofl_chihe
]] --
sfofl_chihe = sgs.CreateTriggerSkill{
	name = "sfofl_chihe",
	events = {sgs.TargetConfirmed, sgs.TargetSpecified},
	frequency = sgs.Skill_NotFrequent, 
	on_trigger = function(self, event, player, data)
		local use = data:toCardUse()
		local room = player:getRoom()
		if ((event == sgs.TargetSpecified) or (event == sgs.TargetConfirmed and use.to:contains(player))) and use.to:length() == 1 then
			if use.card:isKindOf("Slash") then
                local target
                if player == use.from then
                    target = use.to:first()
                else
                    target = use.from
                end
                if player:canPindian(target) and room:askForSkillInvoke(player, self:objectName(), data) then
                    player:drawCards(2, self:objectName())
                    local card = room:askForExchange(player, self:objectName(), 2, 2, false, "@sfofl_chihe", false)
                    room:showCard(player, card:getSubcards())
                    local success = player:pindian(target, "sfofl_chihe", nil)
                    if success then
                        room:setCardFlag(use.card, "sfofl_chihe")
                    else
                        room:askForDiscard(player, self:objectName(), 2, 2, false, false)
                    end
                end
			end
		end
	end
}
sfofl_chihe_buff = sgs.CreateTriggerSkill{
    name = "#sfofl_chihe_buff", 
    events = {sgs.DamageCaused}, 
    frequency = sgs.Skill_Compulsory, 
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.DamageCaused then
            local damage = data:toDamage()
            if damage.card and damage.card:hasFlag("sfofl_chihe") and player:objectName() == damage.from:objectName() then
                damage.damage = damage.damage + 1
                local log = sgs.LogMessage()
                log.type = "#skill_add_damage"
                log.from = damage.from
                log.to:append(damage.to)
                log.arg  = "sfofl_chihe"
                log.arg2 = damage.damage
                room:sendLog(log)
                data:setValue(damage)
            end
        end
        return false
    end,
	can_trigger = function(self, target)
		return target
	end
}

sfofl_duangui:addSkill(sfofl_chihe)
sfofl_duangui:addSkill(sfofl_chihe_buff)
sfofl_duangui:addSkill("sfofl_changshi")
extension_e:insertRelatedSkills("sfofl_chihe", "#sfofl_chihe_buff")


sfofl_guosheng = sgs.General(extension_e, "sfofl_guosheng", "qun", 4)
sfofl_guosheng:setGender(sgs.General_Sexless)

--[[
	技能名：逆取
	相关武将：郭胜[官盗]
	技能描述：每回合限一次，当一名角色使用或打出【闪】结算后，你可以摸一张牌，然后视为对其使用一张【杀】。
	引用：sfofl_niqu
]] --

sfofl_niqu = sgs.CreateTriggerSkill{
    name = "sfofl_niqu", 
    events = {sgs.CardFinished, sgs.PostCardResponded}, 
    frequency = sgs.Skill_NotFrequent, 
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local card
        if event == sgs.CardFinished then
            card = data:toCardUse().card
        elseif event == sgs.PostCardResponded then
            card = data:toCardResponse().m_card
        end
        if card and card:isKindOf("Jink") then
            for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                if p:getMark("sfofl_niqu-Clear") < 1 and room:askForSkillInvoke(p, self:objectName(), ToData(player)) then
                    room:addPlayerMark(p, "sfofl_niqu-Clear")
                    p:drawCards(1, self:objectName())
                    local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                    slash:deleteLater()
                    slash:setSkillName(self:objectName())
                    local use = sgs.CardUseStruct()
					use.card = slash
					use.from = p
					use.to:append(player)
					room:useCard(use)
                end
            end
        end
        return false
    end,
	can_trigger = function(self, target)
		return target
	end
}

sfofl_guosheng:addSkill(sfofl_niqu)
sfofl_guosheng:addSkill("sfofl_changshi")

sfofl_gaowang = sgs.General(extension_e, "sfofl_gaowang", "qun", 4)
sfofl_gaowang:setGender(sgs.General_Sexless)

--[[
	技能名：妙语
	相关武将：高望[官盗]
	技能描述：当一名角色回复体力后，你可以将牌堆顶一张牌交给其，当前回合结束时，其失去X点体力（X为你本回合发动此技能次数）。
	引用：sfofl_miaoyu
]] --

sfofl_miaoyu = sgs.CreateTriggerSkill{
    name = "sfofl_miaoyu", 
    events = {sgs.HpRecover, sgs.EventPhaseChanging}, 
    frequency = sgs.Skill_NotFrequent, 
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event==sgs.EventPhaseChanging and data:toPhaseChange().to==sgs.Player_NotActive then
            for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                for _, q in sgs.qlist(room:getAllPlayers()) do
                    if p:getMark("sfofl_miaoyu"..q:objectName().."-Clear") > 0 then
                        room:loseHp(q, p:getMark("sfofl_miaoyu-Clear"),true,p,self:objectName())
                    end
                end
            end
        elseif event==sgs.HpRecover then
            for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                if room:askForSkillInvoke(p, self:objectName(), ToData(player)) then
                    room:addPlayerMark(p, "sfofl_miaoyu"..player:objectName().."-Clear")
                    room:addPlayerMark(p, "sfofl_miaoyu-Clear")
                    room:addPlayerMark(player, "&sfofl_miaoyu+to+#"..p:objectName().."-Clear")
                    room:addPlayerMark(p, "&sfofl_miaoyu-Clear")
                    local id = room:getDrawPile():first()
                    room:moveCardTo(sgs.Sanguosha:getCard(id), p, player, sgs.Player_PlaceHand, sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_GIVE, p:objectName(), player:objectName(), self:objectName(), ""))
                end
            end

        end
        return false
    end,
	can_trigger = function(self, target)
		return target
	end
}
sfofl_gaowang:addSkill(sfofl_miaoyu)
sfofl_gaowang:addSkill("sfofl_changshi")

sfofl_hankui = sgs.General(extension_e, "sfofl_hankui", "qun", 4)
sfofl_hankui:setGender(sgs.General_Sexless)

--[[
	技能名：宵赂
	相关武将：韩悝[官盗]
	技能描述：每名其他角色的出牌阶段限一次，其可以交给你一张牌，然后其视为对另一名角色使用一张仅指定该角色为目标的普通锦囊牌。
	引用：sfofl_xiaolu
]] --
sfofl_xiaoluCard = sgs.CreateSkillCard {
	name = "sfofl_xiaolu",
	target_fixed = false,
	will_throw = false,
	filter = function(self, targets, to_select, player)
		if #targets == 0 then
			if to_select:hasSkill("sfofl_xiaolu") then
				return player:getMark("sfofl_xiaolu"..to_select:objectName().."-PlayClear") == 0
			end
		end
		return false
	end,
	on_use = function(self, room, source, targets)
		local zhangjiao = targets[1]
		if zhangjiao:hasSkill("sfofl_xiaolu") then
			room:addPlayerMark(source, "sfofl_xiaolu"..zhangjiao:objectName().."-PlayClear")
			room:giveCard(source,zhangjiao,self,"sfofl_xiaolu")
            local ids = room:getAvailableCardList(source,"trick","sfofl_xiaolu", nil, true)
			if ids:isEmpty() then return end
			room:fillAG(ids,source)
			local id = room:askForAG(source,ids,false,"sfofl_xiaolu")
			room:clearAG(source)
            local targets = room:getCardTargets(source, sgs.Sanguosha:getCard(id))
            if not targets:isEmpty() then
                room:setPlayerMark(source, "sfofl_xiaolu", id)
                local use_card = sgs.Sanguosha:cloneCard(sgs.Sanguosha:getCard(id):objectName(), sgs.Card_NoSuit, 0)
                use_card:setSkillName(self:objectName())
                use_card:deleteLater()
                local target = room:askForPlayerChosen(source, targets, "sfofl_xiaolu",
                    "@sfofl_xiaolu:" ..use_card:objectName())
                room:setPlayerMark(source, "sfofl_xiaolu", 0)
                local use = sgs.CardUseStruct()
                use.card = use_card
                use.from = source
                use.to:append(target)
                room:useCard(use)
            end
		end
	end
}
sfofl_xiaoluAttach = sgs.CreateViewAsSkill {
	name = "sfofl_xiaoluAttach&",
	n = 1,
	view_filter = function(self, selected, to_select)
		return true
	end,
	view_as = function(self, cards)
		if #cards == 1 then
			local card = sfofl_xiaoluCard:clone()
			card:addSubcard(cards[1])
			return card
		end
	end,
	enabled_at_play = function(self, player)
        for _,p in sgs.list(player:getAliveSiblings())do
            if p:hasSkill("sfofl_xiaolu") then
                return player:getMark("sfofl_xiaolu"..p:objectName().."-PlayClear") == 0
            end
        end
		return false
	end
}
sfofl_xiaolu = sgs.CreateTriggerSkill {
	name = "sfofl_xiaolu",
	frequency = sgs.Skill_NotFrequent,
	events = { sgs.GameStart, sgs.EventAcquireSkill },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.GameStart or (event == sgs.EventAcquireSkill and data:toString() == "sfofl_xiaolu")) and player:hasSkill(self:objectName()) then
			for _, p in sgs.qlist(room:getOtherPlayers(player)) do
				if not p:hasSkill("sfofl_xiaoluAttach") then
					room:attachSkillToPlayer(p, "sfofl_xiaoluAttach")
				end
			end
        end
    end
}
if not sgs.Sanguosha:getSkill("sfofl_xiaoluAttach&") then skills:append(sfofl_xiaoluAttach) end
sfofl_hankui:addSkill(sfofl_xiaolu)
sfofl_hankui:addSkill("sfofl_changshi")


sfofl_l_liuxie = sgs.General(extension_e, "sfofl_l_liuxie$", "qun", 3)

--[[
	技能名：天择
	相关武将：刘协[官盗]
	技能描述：当你成为【杀】的目标时，你可以弃置两张手牌（不足则全弃，无牌则不弃）并观看牌堆顶四张牌，然后获得其中两张牌。若如此做，你令一名体力值最大或手牌数最多的其他角色也如此做。
	引用：sfofl_tianzel
]] --
sfofl_tianzel = sgs.CreateTriggerSkill{
	name = "sfofl_tianzel",
	events = {sgs.TargetConfirming},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local use = data:toCardUse()
		if use.card:isKindOf("Slash") and room:askForSkillInvoke(player,self:objectName()) then
			room:askForDiscard(player, self:objectName(), 2, 2, false, false)
            local card_ids = room:getNCards(4)
			local obtained = sgs.IntList()
				room:fillAG(card_ids,player)
			local id1 = room:askForAG(player,card_ids,false,self:objectName())
				card_ids:removeOne(id1)
				obtained:append(id1)
				-- room:takeAG(player,id1,false)
			local id2 = room:askForAG(player,card_ids,false,self:objectName())
				card_ids:removeOne(id2)
				obtained:append(id2)
				room:clearAG(player)
			local dummy = sgs.Sanguosha:cloneCard("jink",sgs.Card_NoSuit,0)
			for _,id in sgs.qlist(obtained) do
				dummy:addSubcard(id)
			end
            player:obtainCard(dummy,false)
            room:returnToTopDrawPile(card_ids)
			local max = 0
			for _,p in sgs.qlist(room:getAllPlayers()) do
				if p:getHp() > max then
					max = p:getHp()
				end
			end
			local maxs = sgs.SPlayerList()
			for _,p in sgs.qlist(room:getOtherPlayers(player)) do
				if p:getHp() == max then
					maxs:append(p)
				end
			end
            local max_handcard = 0
            for _,p in sgs.qlist(room:getAllPlayers()) do
				if p:getHandcardNum() > max_handcard then
					max_handcard = p:getHandcardNum()
				end
			end
            for _,p in sgs.qlist(room:getOtherPlayers(player)) do
				if p:getHandcardNum() == max_handcard then
					maxs:append(p)
				end
			end
            local target = room:askForPlayerChosen(player, maxs, self:objectName(),
						"sfofl_tianzel-invoke", true, true)
            if not target then return false end
            room:doAnimate(1, player:objectName(), target:objectName())
            room:askForDiscard(target, self:objectName(), 2, 2, false, true)
            local card_ids = room:getNCards(4)
            local obtained = sgs.IntList()
                room:fillAG(card_ids,target)
            local id1 = room:askForAG(target,card_ids,false,self:objectName())
                card_ids:removeOne(id1)
                obtained:append(id1)
                -- room:takeAG(target,id1,false)
            local id2 = room:askForAG(target,card_ids,false,self:objectName())
                card_ids:removeOne(id2)
                obtained:append(id2)
                room:clearAG(target)
            local dummy = sgs.Sanguosha:cloneCard("jink",sgs.Card_NoSuit,0)
            dummy:deleteLater()
            for _,id in sgs.qlist(obtained) do
                dummy:addSubcard(id)
            end
            target:obtainCard(dummy,false)
            room:returnToTopDrawPile(card_ids)
		end
		return false
	end
}


--[[
	技能名：诏援
	相关武将：刘协[官盗]
	技能描述：出牌阶段，你可以将所有手牌交给一名其他角色，然后令该角色与你指定的另一名角色拼点，拼点赢的角色视为使用一张无距离限制的【杀】。
	引用：sfofl_zhaoyuan
]] --

sfofl_zhaoyuanCard = sgs.CreateSkillCard{
	name = "sfofl_zhaoyuan",
	target_fixed = false,
	will_throw = false,
	filter = function(self, targets, to_select)
		if #targets == 0 then
			return to_select:objectName() ~= sgs.Self:objectName()
		end
		return false
	end,
	on_effect = function(self, effect)
		local source = effect.from
		local target = effect.to
		source:getRoom():giveCard(effect.from,target,self,"sfofl_zhaoyuan")
		local room = source:getRoom()
		local targets = sgs.SPlayerList()
		local others = room:getOtherPlayers(target)
		for _,p in sgs.qlist(others) do
			if target:canPindian(p) then
				targets:append(p)
			end
		end
		if not target:isKongcheng() then
			if not targets:isEmpty() then
				local dest = room:askForPlayerChosen(source, targets, "sfofl_zhaoyuan")
                target:setFlags("sfofl_zhaoyuanPindianTarget")
                local n = target:pindianInt(dest,self:objectName())
                target:setFlags("-sfofl_zhaoyuanPindianTarget")
                if n < -1 then return end
                
                local loser,winner = nil,nil
                if n == -1 then
                    winner = dest
                    loser = target
                elseif n == 1 then
                    winner = target
                    loser = dest
                end
                if winner then
                    local players = sgs.SPlayerList()
                    for _, p in sgs.qlist(room:getOtherPlayers(winner)) do
                        if winner:canSlash(p, nil, false) then
                            players:append(p)
                        end
                    end
                    if players:length() > 0 then
                        local eny = room:askForPlayerChosen(winner, players, self:objectName())
                        if eny then
                            local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                            slash:setSkillName("sfofl_zhaoyuan")
                            local use = sgs.CardUseStruct()
                            use.card = slash
                            use.from = winner
                            use.to:append(eny)
                            room:useCard(use)
                            slash:deleteLater()
                        end
                    end
                end
			end
		end
	end
}
sfofl_zhaoyuan = sgs.CreateViewAsSkill{
	name = "sfofl_zhaoyuan",
	n = 0,
	view_as = function(self, cards)
		if #cards == 0 then
			local card = sfofl_zhaoyuanCard:clone()
			card:addSubcards(sgs.Self:getHandcards())
			return card
		end
	end,
	enabled_at_play = function(self, player)
		if not player:isKongcheng() then
			return true
		end
		return false
	end
}




sfofl_l_liuxie:addSkill(sfofl_tianzel)
sfofl_l_liuxie:addSkill(sfofl_zhaoyuan)
sfofl_l_liuxie:addSkill("ov_zhuiting")



sfofl_l_liuhong = sgs.General(extension_e, "sfofl_l_liuhong$", "qun", 4)

--[[
	技能名：革制
	相关武将：刘宏[官盗]
	技能描述：当你使用牌时，你可以重铸三种类别的牌各一张，然后选择一项：1.回复1点体力；2.使用下一张牌无次数限制；3.对一名其他角色造成1点伤害（每名角色限选一次）。
	引用：sfofl_gezhi
]] --
sfofl_gezhiCard = sgs.CreateSkillCard{
	name = "sfofl_gezhi",
    target_fixed = true,
    will_throw = false,
	on_use = function(self, room, source, targets)
		for _,id in sgs.qlist(self:getSubcards()) do
		    local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_RECAST, source:objectName())
            reason.m_skillName = self:objectName()
            room:moveCardTo(sgs.Sanguosha:getCard(id), source, nil, sgs.Player_DiscardPile, reason)
            source:broadcastSkillInvoke("@recast")
            local log = sgs.LogMessage()
            log.type = "#UseCard_Recast"
            log.from = source
            log.card_str = sgs.Sanguosha:getCard(id):toString()
            room:sendLog(log)
            source:drawCards(1, "recast")
        end
	end
}
sfofl_gezhiVS = sgs.CreateViewAsSkill{
	name = "sfofl_gezhi", 
	n = 3, 
	enabled_at_play = function(self, player)
		return  false
	end,
	enabled_at_response = function(self, player, pattern)
        return pattern == "@@sfofl_gezhi"
	end,
	view_filter = function(self, selected, to_select)
        for _, ca in sgs.list(selected) do
			if ca:getType() == to_select:getType() then return false end
		end
        return true
    end,
	view_as = function(self, cards) 
        if #cards == 0 then return nil end
        if #cards == 3 then
            local dummy = sfofl_gezhiCard:clone()
            for _,c in ipairs(cards) do
                dummy:addSubcard(c)
            end
            return dummy
        end
        return nil
	end
}
sfofl_gezhi = sgs.CreateTriggerSkill{
    name = "sfofl_gezhi",
    events = {sgs.CardUsed},
    view_as_skill = sfofl_gezhiVS,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.CardUsed then
            local use = data:toCardUse()
            if player and player:objectName() == use.from:objectName() and not use.card:isKindOf("SkillCard") then
                if player:hasFlag("sfofl_gezhi") and not use.card:isKindOf("SkillCard") then
                    room:setPlayerFlag(player, "-sfofl_gezhi")
                    room:setPlayerMark(player, "&sfofl_gezhi", 0)
                    use.m_addHistory = false
                    data:setValue(use)
                end
                local card = room:askForUseCard(player, "@@sfofl_gezhi", "@sfofl_gezhi", 5, sgs.Card_MethodRecast, false)
                if card then
                    local choicelist = { }
                    if player:isWounded() then
                        table.insert(choicelist, "recover")
                    end
                    table.insert(choicelist, "RemoveFromHistory")
                    local targets = sgs.SPlayerList()
                    for _, p in sgs.qlist(room:getOtherPlayers(player)) do
                        if p:getMark("sfofl_gezhi"..player:objectName()) == 0 then
                            targets:append(p)
                        end
                    end
                    if targets:length() > 0 then
                        table.insert(choicelist, "damage")
                    end
                    if #choicelist > 0 then
                        local choice = room:askForChoice(player, self:objectName(), table.concat(choicelist, "+"))
                        if choice == "recover" then
                            room:recover(player, sgs.RecoverStruct(self:objectName(), player, 1))
                        elseif choice == "RemoveFromHistory" then
                            room:setPlayerFlag(player, "sfofl_gezhi")
                            room:setPlayerMark(player, "&sfofl_gezhi", 1)
                        elseif choice == "damage" then
                            local target = room:askForPlayerChosen(player, targets, self:objectName())
                            if target then
                                room:addPlayerMark(target,"sfofl_gezhi"..player:objectName())
                                room:addPlayerMark(target,"&sfofl_gezhi+to+#"..player:objectName())
                                local damage = sgs.DamageStruct()
                                damage.from = player
                                damage.to = target
                                damage.damage = 1
                                room:damage(damage)
                            end
                        end
                    end
                end
            end
		end
    end,
}


--[[
	技能名：聚敛
	相关武将：刘宏[官盗]
	技能描述：主公技，结束阶段，其他群势力角色依次可以选择摸两张牌，若如此做，你获得其一张牌。
	引用：sfofl_julian
]] --
sfofl_julian = sgs.CreateTriggerSkill{
	name = "sfofl_julian$",
	events = {sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data, room)
        if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish
		and player:hasLordSkill(self) then
			for _, p in sgs.qlist(room:getLieges("qun", player)) do
				if p:askForSkillInvoke(self, data) then
                    p:drawCards(2, self:objectName())
                    if (not p:isNude()) then
                        local card_id = room:askForCardChosen(player, p, "he", self:objectName())
                        local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_EXTRACTION, player:objectName())
                        room:obtainCard(player, sgs.Sanguosha:getCard(card_id), reason, room:getCardPlace(card_id) ~= sgs.Player_PlaceHand)
                    end
                end
			end
		end
    end
}

sfofl_l_liuhong:addSkill(sfofl_gezhi)
sfofl_l_liuhong:addSkill(sfofl_julian)

sfofl_l_yuanshao = sgs.General(extension_e, "sfofl_l_yuanshao$", "qun", 4)

--[[
	技能名：合伐
	相关武将：袁绍[官盗]
	技能描述：出牌阶段限一次，你可以将任意张手牌当一张无次数限制、指定等量名角色为目标的【杀】使用，此【杀】伤害后，你将手牌补至手牌上限。
	引用：sfofl_hefa
]] --
sfofl_hefa_buff = sgs.CreateTargetModSkill{
	name = "#sfofl_hefa_buff",
	pattern = "Slash",
	extra_target_func = function(self, poi, card)
		if table.contains(card:getSkillNames(), "sfofl_hefa") then
			local x = card:subcardsLength()
			return x - 1
		else
			return 0
		end
	end,
    residue_func = function(self, from, card, to)
        if table.contains(card:getSkillNames(), "sfofl_hefa") then
            return 999
        end
        return 0
    end,
}
sfofl_hefaVS = sgs.CreateViewAsSkill{
    name = "sfofl_hefa",
    n = 999,
    view_as = function(self, cards)
	    if #cards == 0 then return nil end
   		local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_SuitToBeDecided, 0)
   		slash:setSkillName(self:objectName())
	   	for _,c in ipairs(cards) do
            slash:addSubcard(c)
        end
	    return slash
   	end,
    enabled_at_play = function(self, player)
	    return player:getMark("sfofl_hefa-PlayClear") == 0
    end,
}
sfofl_hefa = sgs.CreateTriggerSkill{
    name = "sfofl_hefa",
    events = {sgs.CardUsed, sgs.Damage},
    view_as_skill = sfofl_hefaVS,
    on_trigger = function(self, event, player, data, room)
        if event == sgs.CardUsed then
            local use = data:toCardUse()
            if use.card and table.contains(use.card:getSkillNames(), "sfofl_hefa") then
                room:addPlayerMark(player, "sfofl_hefa-PlayClear")
            end
        elseif event == sgs.Damage then
            local damage = data:toDamage()
            if damage.card and table.contains(damage.card:getSkillNames(), "sfofl_hefa") then
                local x = player:getMaxCards() - player:getHandcardNum()
                if x > 0 then
                    player:drawCards(x, self:objectName())
                end
            end
        end
    end
}


sfofl_l_yuanshao:addSkill(sfofl_hefa)
sfofl_l_yuanshao:addSkill(sfofl_hefa_buff)
sfofl_l_yuanshao:addSkill("xueyi")
extension_e:insertRelatedSkills("sfofl_hefa", "#sfofl_hefa_buff")


sfofl_l_zhangjiao = sgs.General(extension_e, "sfofl_l_zhangjiao$", "qun", 3)

--[[
	技能名：唤雷
	相关武将：张角[官盗]
	技能描述：当你使用或打出【闪】、【闪电】或不因此技能进行判定结算结束后，你可以令一名其他角色进行判定，若结果为♠，你对其造成2点雷电伤害；不为♠，你获得其一张手牌。
	引用：sfofl_huanlei
]] --
sfofl_huanlei = sgs.CreateTriggerSkill {
    name = "sfofl_huanlei",
    frequency = sgs.Skill_Frequent,
    events = { sgs.CardUsed, sgs.CardResponded, sgs.FinishJudge },
    on_trigger = function(self, event, player, data, room)
        local card
        if event == sgs.CardUsed then
            card = data:toCardUse().card
        elseif event == sgs.CardResponded then
            card = data:toCardResponse().m_card
        end
        if card and (card:isKindOf("Jink") or card:isKindOf("Lighting")) then
            local target = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName(), "sfofl_huanlei-invoke", true)
            if target then
                local judge = sgs.JudgeStruct()
                judge.who = target
                judge.pattern = ".|spade"
                judge.good = false
                judge.negative = true
                judge.reason = self:objectName()
                room:judge(judge)
                
                if judge:isBad() then
                    if judge.card:getSuit() == sgs.Card_Spade then
                        local damage = sgs.DamageStruct()
                        damage.from = player
                        damage.to = target
                        damage.damage = 2
                        damage.nature = sgs.DamageStruct_Thunder
                        room:damage(damage)
                    end
                else
                    if not target:isKongcheng() then
                        local id = room:askForCardChosen(player,target,"h",self:objectName())
                        room:obtainCard(player,id,false)
                    end
                end
            end
        end
        if event==sgs.FinishJudge then
            local judge = data:toJudge()
            if judge.reason~="sfofl_huanlei" then
                local target = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName(), "sfofl_huanlei-invoke", true)
                if target then
                    local newjudge = sgs.JudgeStruct()
                    newjudge.who = target
                    newjudge.pattern = ".|spade"
                    newjudge.good = false
                    newjudge.negative = true
                    newjudge.reason = self:objectName()
                    room:judge(newjudge)
                    
                    if newjudge:isBad() then
                        if newjudge.card:getSuit() == sgs.Card_Spade then
                            local damage = sgs.DamageStruct()
                            damage.from = player
                            damage.to = target
                            damage.damage = 2
                            damage.nature = sgs.DamageStruct_Thunder
                            room:damage(damage)
                        end
                    else
                        if not target:isKongcheng() then
                            local id = room:askForCardChosen(player,target,"h",self:objectName())
                            room:obtainCard(player,id,false)
                        end
                    end
                end
            end
        end
    end
}

--[[
	技能名：显道
	相关武将：张角[官盗]
	技能描述：当一名角色的判定牌生效前，你可以用一张黑色牌替换之，然后摸一张牌。
	引用：sfofl_xiandaoz
]] --
sfofl_xiandaoz = sgs.CreateTriggerSkill{
	name = "sfofl_xiandaoz" ,
	events = {sgs.AskForRetrial} ,
	can_trigger = function(self, target)
	if not (target and target:isAlive() and target:hasSkill(self:objectName())) then return false end
		if target:isKongcheng() then
			local has_black = false
			for i = 0, 3, 1 do
				local equip = target:getEquip(i)
				if equip and equip:isBlack() then
					has_black = true
					break
				end
			end
			return has_black
		else
			return true
		end
	end ,
		on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local judge = data:toJudge()
		local prompt_list = {
			"@sfofl_xiandaoz-card" ,
			judge.who:objectName() ,
			self:objectName() ,
			judge.reason ,
			tostring(judge.card:getEffectiveId())
		}
		local prompt = table.concat(prompt_list, ":")
		local card = room:askForCard(player, ".|black", prompt, data, sgs.Card_MethodResponse, judge.who, true)
		if card then
			room:broadcastSkillInvoke(self:objectName(), math.random(1,2))
			room:retrial(card, player, judge, self:objectName(), true)
			player:drawCards(1, self:objectName())	
		end
		return false
	end
}

sfofl_l_zhangjiao:addSkill(sfofl_huanlei)
sfofl_l_zhangjiao:addSkill(sfofl_xiandaoz)
sfofl_l_zhangjiao:addSkill("huangtian")



sfofl_l_sunquan = sgs.General(extension_e, "sfofl_l_sunquan$", "wu", 4)

--[[
	技能名：衡虑
	相关武将：孙权[官盗]
	技能描述：出牌阶段，你可以失去X点体力，弃置任意张手牌，将其中任意张【桃】分配给任意角色，然后摸等量+X张牌（X为你本回合发动此技能次数-1）。
	引用：sfofl_shenglv
]] --
sfofl_shenglv = sgs.CreateViewAsSkill {
    name = "sfofl_shenglv",
    n = 99,
    view_filter = function(self, selected, to_select)
        if #selected < 99 then
            return not to_select:isEquipped()
        end
    end,
    view_as = function(self, cards)
        if #cards < 1 then
            return nil
        end
        local acard = sfofl_shenglvCard:clone()
        for _, card in ipairs(cards) do
            local id = card:getId()
            acard:addSubcard(id)
        end
        acard:setSkillName(self:objectName())
        return acard
    end,
    enabled_at_play = function(self, player)
        return true
    end
}

sfofl_shenglvCard = sgs.CreateSkillCard {
    name = "sfofl_shenglv",
    target_fixed = true,
    will_throw = false,
    on_use = function(self, room, source, targets)
        local x = math.max(source:usedTimes("#sfofl_shenglv") - 1, 0)
        if x > 0 then
            room:loseHp(source, x, true, source, self:objectName())
        end
        room:throwCard(self, source)
        local to_obtain = sgs.IntList()
        for _, card_id in sgs.qlist(self:getSubcards()) do
            if sgs.Sanguosha:getCard(card_id):isKindOf("Peach") then
                to_obtain:append(card_id)
            end
        end
        if to_obtain:length() > 0 then
            source:assignmentCards(to_obtain, self:objectName(), room:getAlivePlayers(), to_obtain:length(), to_obtain:length(), true)
        end
        if source:isAlive() then
            room:drawCards(source, self:getSubcards():length()+x)
        end
    end
}


sfofl_l_sunquan:addSkill(sfofl_shenglv)
sfofl_l_sunquan:addSkill("jiuyuan")


sfofl_l_sunce = sgs.General(extension_e, "sfofl_l_sunce$", "wu", 4)

--[[
	技能名：激昂
	相关武将：孙权[官盗]
	技能描述：当你使用红色牌时，你可以摸一张牌。
	引用：sfofl_jiang
]] --
sfofl_jiang = sgs.CreateTriggerSkill{
	name = "sfofl_jiang" ,
	events = {sgs.CardUsed, sgs.CardResponded},
	frequency = sgs.Skill_Frequent, 
	on_trigger = function(self, event, sunce, data)
		if event == sgs.CardUsed then
            local use = data:toCardUse()
			if not (use.card:isKindOf("SkillCard")) and use.card:isRed() then
				if sunce:askForSkillInvoke(self:objectName(), data) then
					sunce:drawCards(1, self:objectName())
				end
			end
        elseif event == sgs.CardResponded then
            local resp = data:toCardResponse()
            if resp.m_isUse and resp.m_card and resp.m_card:isRed() and not (resp.m_card:isKindOf("SkillCard")) then
                if sunce:askForSkillInvoke(self:objectName(), data) then
					sunce:drawCards(1, self:objectName())
				end
            end 
		end
		return false
	end
}

--[[
	技能名：志扬
	相关武将：孙权[官盗]
	技能描述：你的红色拼点牌点数视为K。当你受到伤害后，你可以令伤害来源对你发动两次〖制霸〗。
	引用：sfofl_zhiyang
]] --
sfofl_zhiyang = sgs.CreateTriggerSkill{
	name = "sfofl_zhiyang",
	events = {sgs.PindianVerifying, sgs.Damaged},
	can_trigger = function(self,target)
		return target and target:isAlive()
		and target:getRoom():findPlayerBySkillName("sfofl_zhiyang")
	end,
	on_trigger = function(self,event,player,data,room)
		if event==sgs.PindianVerifying then
			local pindian = data:toPindian()
			for _,owner in sgs.list(room:findPlayersBySkillName("sfofl_zhiyang"))do
				if pindian.from==owner then
					Skill_msg("sfofl_zhiyang",owner)
					if pindian.from_card:isRed() then pindian.from_number=13 end
					data:setValue(pindian)
				elseif pindian.to==owner then
					Skill_msg("sfofl_zhiyang",owner)
					if pindian.to_card:isRed() then pindian.to_number=13 end
					data:setValue(pindian)
				end
			end
        elseif event == sgs.Damaged then
            local damage = data:toDamage()
            if damage.to == player and damage.from and player:hasSkill(self) and player:canPindian(damage.from) and room:askForSkillInvoke(player, self:objectName(), ToData(damage.from)) then
                local cns = sgs.Sanguosha:cloneSkillCard("ZhibaCard")
                room:useCard(sgs.CardUseStruct(cns,damage.from,player))
                if player:canPindian(damage.from) then
                    room:useCard(sgs.CardUseStruct(cns,damage.from,player))
                end
                cns:deleteLater()
            end
		end
		return false
	end
}

sfofl_l_sunce:addSkill(sfofl_jiang)
sfofl_l_sunce:addSkill(sfofl_zhiyang)
sfofl_l_sunce:addSkill("zhiba")  



sfofl_l_caopi = sgs.General(extension_e, "sfofl_l_caopi$", "wei", 3)

--[[
	技能名：篡尊
	相关武将：曹丕[官盗]
	技能描述：当其他角色死亡时，你可以获得其所有牌并回复1点体力。
	引用：sfofl_cuanzun
]] --
sfofl_cuanzun = sgs.CreateTriggerSkill{
		name = "sfofl_cuanzun",
		events = {sgs.Death},
		on_trigger = function(self, event, player, data)
			local room = player:getRoom()
			local death = data:toDeath()
			local splayer = death.who
			if splayer:objectName() ~= player:objectName()  then
                if player:isAlive()  then
                    if player:askForSkillInvoke(self:objectName(), data) then
                    local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                    local cards = splayer:getCards("he")
                    for _,card in sgs.qlist(cards) do
                        dummy:addSubcard(card)
                    end
                    if cards:length() > 0 then
                        local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_RECYCLE, player:objectName())
                        room:obtainCard(player, dummy, reason, false)
                    end
                    dummy:deleteLater()
                room:recover(player, sgs.RecoverStruct(player))
                end
            end
        end
    end
}



--[[
	技能名：流放
	相关武将：曹丕[官盗]
	技能描述：出牌阶段限一次或当你受到伤害后，你可以令一名角色摸X张牌并翻面，若X大于1，其进行一次【闪电】判定（X为你已损失的体力值）。
	引用：sfofl_liufangc
]] --
sfofl_liufangcVS = sgs.CreateViewAsSkill {
    name = "sfofl_liufangc",
    n = 0,
    view_as = function(self, cards)
        return sfofl_liufangcCard:clone()
    end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_liufangc")
    end
}

sfofl_liufangcCard = sgs.CreateSkillCard {
    name = "sfofl_liufangc",
    target_fixed = true,
    will_throw = false,
    on_use = function(self, room, source, targets)
        targets[1]:drawCards(source:getLostHp(), self:objectName())
        targets[1]:turnOver()
        if source:getLostHp() > 1 then
            local lightning = sgs.Sanguosha:cloneCard("lightning", sgs.Card_NoSuit, 0)
            local effect = sgs.CardEffectStruct()
            effect.from = nil
            effect.to = targets[1]
            effect.card = lightning
            lightning:onEffect(effect)
        end
    end
}

sfofl_liufangc = sgs.CreateMasochismSkill{
    name = "sfofl_liufangc",
    view_as_skill = sfofl_liufangcVS,
    on_damaged = function(self, player)
        local room = player:getRoom()
        local to = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName(), "sfofl_liufangc-invoke", true, true)
        if to then
            to:drawCards(player:getLostHp(), self:objectName())
            to:turnOver()
            if player:getLostHp() > 1 then
                local lightning = sgs.Sanguosha:cloneCard("lightning", sgs.Card_NoSuit, 0)
                local effect = sgs.CardEffectStruct()
                effect.from = nil
                effect.to = to
                effect.card = lightning
                lightning:onEffect(effect)
            end
        end
    end
}



sfofl_l_caopi:addSkill(sfofl_cuanzun)
sfofl_l_caopi:addSkill(sfofl_liufangc)
sfofl_l_caopi:addSkill("songwei")


sfofl_l_caocao = sgs.General(extension_e, "sfofl_l_caocao$", "wei", 4)

--[[
	技能名：雄图
	相关武将：曹操[官盗]
	技能描述：当你的体力值变化后，你可以从牌堆、弃牌堆、场上、处理区各获得一张伤害牌。
	引用：sfofl_xiongtu
]] --
sfofl_xiongtu = sgs.CreateTriggerSkill{
    name = "sfofl_xiongtu",
    events = {sgs.HpChanged},
    frequency = sgs.Skill_Frequent,
    on_trigger = function(self, event, player, data, room)
        local to_obtain = dummyCard()
        for _, id in sgs.qlist(room:getDrawPile()) do
            if sgs.Sanguosha:getCard(id):isDamageCard() then
                to_obtain:addSubcard(id)
                break
            end
        end
        for _, p in sgs.qlist(room:getOtherPlayers(player)) do
            for _, card in sgs.qlist(p:getCards("ej")) do
                if card:isDamageCard() then
                    to_obtain:addSubcard(card)
                end
            end
        end
        for _, id in sgs.qlist(room:getDiscardPile()) do
            if sgs.Sanguosha:getCard(id):isDamageCard() then
                to_obtain:addSubcard(id)
                break
            end
        end
        for id=0,sgs.Sanguosha:getCardCount()-1 do
            local c = sgs.Sanguosha:getEngineCard(id)
            if room:getCardPlace(id) == sgs.Player_PlaceTable and not string.find(c:objectName(), "_") and c:isDamageCard() then
                to_obtain:addSubcard(id)
                break
            end
        end
        if to_obtain:subcardsLength() > 0 and room:askForSkillInvoke(player, self:objectName(), data) then
            player:obtainCard(to_obtain)
        end
    end
}

sfofl_l_caocao:addSkill(sfofl_xiongtu)
sfofl_l_caocao:addSkill("hujia")



sfofl_l_liushan = sgs.General(extension_e, "sfofl_l_liushan$", "shu", 3)

--[[
	技能名：付相
	相关武将：刘禅[官盗]
	技能描述：出牌阶段开始前，你可以跳过此阶段，然后弃牌阶段结束时，你可以将此阶段进入弃牌堆的牌交给一名其他角色，其获得一个额外回合。
	引用：sfofl_fuxiang
]] --

sfofl_fuxiang = sgs.CreateTriggerSkill{
	name = "sfofl_fuxiang" ,
	events = {sgs.EventPhaseChanging, sgs.EventPhaseEnd} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
        if event == sgs.EventPhaseChanging then
            local change = data:toPhaseChange()
            if change.to == sgs.Player_Play then
                local invoked = false
                if player:isSkipped(sgs.Player_Play) then return false end
                invoked = player:askForSkillInvoke(self:objectName())
                if invoked then
                    player:setFlags("sfofl_fuxiang")
                    player:skip(sgs.Player_Play)
                end
            end
        elseif event == sgs.EventPhaseEnd then
            if player:getPhase() == sgs.Player_Discard and player:hasFlag("sfofl_fuxiang") then
                local DiscardPile = room:getDiscardPile()
				local tag = room:getTag("sfofl_fuxiangCard"):toString():split("+")
				room:removeTag("sfofl_fuxiangCard")
				if #tag == 0 then return false end
				local toGainList = sgs.IntList()				
				for _,is in ipairs(tag) do
					if is~="" and DiscardPile:contains(tonumber(is)) then
						toGainList:append(tonumber(is))
					end
				end
                local to_obtain = dummyCard()
                for _,id in sgs.list(toGainList)do
                    to_obtain:addSubcard(id)
                end
                local _player = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName())
                local p = _player
                local playerdata = sgs.QVariant()
                playerdata:setValue(p)
                room:setTag("sfofl_fuxiangTarget", playerdata)
                _player:obtainCard(to_obtain)
            end
		end
		return false
	end
}
sfofl_fuxiang_record = sgs.CreateTriggerSkill{
	name = "#sfofl_fuxiang_record",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.CardsMoveOneTime,},
	on_trigger = function(self, event, player, data, room)
		
		local current = room:getCurrent()
		if not current or current:isDead() or current:getPhase() ~= sgs.Player_Discard or not current:hasSkill("sfofl_fuxiang") then return false end		
		local move = data:toMoveOneTime()			
		if (move.to_place == sgs.Player_DiscardPile) 
			and ((bit32.band(move.reason.m_reason, sgs.CardMoveReason_S_MASK_BASIC_REASON) == 
				sgs.CardMoveReason_S_REASON_DISCARD) 
			or (move.reason.m_reason == sgs.CardMoveReason_S_REASON_JUDGEDONE)) then
			local oldtag = room:getTag("sfofl_fuxiangCard"):toString():split("+")
			local totag = {}
			for _,is in ipairs(oldtag) do
				table.insert(totag,tonumber(is))
			end					
			for _, card_id in sgs.qlist(move.card_ids) do
				table.insert(totag,card_id)
			end	
			room:setTag("sfofl_fuxiangCard",sgs.QVariant(table.concat(totag,"+")))
		end		
	end
}
sfofl_fuxiang_buff = sgs.CreateTriggerSkill{
	name = "#sfofl_fuxiang_buff" ,
	events = {sgs.EventPhaseStart} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if room:getTag("sfofl_fuxiangTarget") then
			local target = room:getTag("sfofl_fuxiangTarget"):toPlayer()
			room:removeTag("sfofl_fuxiangTarget")
			if target and target:isAlive() then
				target:gainAnExtraTurn()
			end
		end
		return false
	end ,
	can_trigger = function(self, target)
		return target and (target:getPhase() == sgs.Player_NotActive)
	end ,
	priority = 1
}


--[[
	技能名：乐纵
	相关武将：刘禅[官盗]
	技能描述：锁定技，当你成为【杀】或延时锦囊牌的目标时，使用者需交给你一张相同类别的手牌，否则此牌无效。
	引用：sfofl_lezong
]] --
sfofl_lezong = sgs.CreateTriggerSkill{
    name = "sfofl_lezong",
    events = {sgs.TargetConfirming},
    frequency = sgs.Skill_NotFrequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local use = data:toCardUse()
        if (use.card:isKindOf("Slash") or use.card:isKindOf("DelayedTrick")) and use.to:contains(player) then
            local typee = (use.card:isKindOf("BasicCard") and "BasicCard") or "TrickCard"
            local card = room:askForCard(use.from,""..typee .. "|.|.|hand","@sfofl_lezong:"..use.card:getType()..":"..use.card:getLogName() .. ":".. player:objectName(),data, sgs.Card_MethodNone)
            if card then
                room:giveCard(use.from, player, card, self:objectName())
            else
                local nullified = use.nullified_list
                table.insert(nullified,"_ALL_TARGETS")
                use.nullified_list = nullified
                data:setValue(use)
            end
        end
    end
}

sfofl_l_liushan:addSkill(sfofl_fuxiang)
sfofl_l_liushan:addSkill(sfofl_fuxiang_record)
sfofl_l_liushan:addSkill(sfofl_fuxiang_buff)
extension_e:insertRelatedSkills("sfofl_fuxiang", "#sfofl_fuxiang_record")
extension_e:insertRelatedSkills("sfofl_fuxiang", "#sfofl_fuxiang_buff")
sfofl_l_liushan:addSkill(sfofl_lezong)
sfofl_l_liushan:addSkill("ruoyu")


sfofl_l_liubei = sgs.General(extension_e, "sfofl_l_liubei$", "shu", 4)

--[[
	技能名：仁望
	相关武将：刘备[官盗]
	技能描述：出牌阶段，你可以将至少两张牌交给一名其他角色，然后回复1点体力且本回合出牌阶段使用【杀】次数上限+1。
	引用：sfofl_renwang
]] --
sfofl_renwangCard = sgs.CreateSkillCard {
	name = "sfofl_renwang",
	target_fixed = false,
	will_throw = false,
	on_use = function(self, room, source, targets)
		local target
		if #targets == 0 then
			local list = room:getAlivePlayers()
			for _, player in sgs.qlist(list) do
				if player:objectName() ~= source:objectName() then
					target = player
					break
				end
			end
		else
			target = targets[1]
		end
		room:giveCard(source, target, self, self:objectName(), false)
		room:recover(source,sgs.RecoverStruct(self:objectName(),source,1))
        room:addPlayerMark(source, "&sfofl_renwang-Clear")
        room:addSlashCishu(source, 1, true)
	end
}
sfofl_renwang = sgs.CreateViewAsSkill {
	name = "sfofl_renwang",
	n = 999,
	view_filter = function(self, selected, to_select)
		return true
	end,
	view_as = function(self, cards)
		if #cards > 1 then
			local rende_card = sfofl_renwangCard:clone()
			for i = 1, #cards, 1 do
				local id = cards[i]:getId()
				rende_card:addSubcard(id)
			end
			return rende_card
		end
	end,
}

sfofl_l_liubei:addSkill(sfofl_renwang)
sfofl_l_liubei:addSkill("jijiang")




quaxiaojiang = sgs.General(extension_e, "quaxiaojiang", "qun", 4)
yingzhen = sgs.CreateTriggerSkill{
    name = "yingzhen",
	events = {sgs.GameStart},
	on_trigger = function(self,event,player,data,room)
		if event==sgs.GameStart then
			local tp = room:askForPlayerChosen(player,room:getOtherPlayers(player),self:objectName(),"yingzhen0",false,true)
			if tp then
				local aps = sgs.SPlayerList()
				for _,p in sgs.list(room:getAlivePlayers())do
					if tp:isAdjacentTo(p) then aps:append(p) end
				end
				local ap = room:askForPlayerChosen(player,aps,"yingzhen1","yingzhen1",false)
				if ap~=player then room:swapSeat(ap,player) end
				player:gainAnExtraTurn()
				tp:gainAnExtraTurn()
			end
		end
	end,
}
quaxiaojiang:addSkill(yingzhen)
yuanjue = sgs.CreateTriggerSkill{
    name = "yuanjue",
	change_skill = true,
	waked_skills = "tongkai",
	events = {sgs.EventPhaseChanging,sgs.CardUsed},
	can_trigger = function(self,player)
		return player and player:isAlive()
	end,
	on_trigger = function(self,event,player,data,room)
		if event==sgs.EventPhaseChanging then
			local change = data:toPhaseChange()
			if change.to==sgs.Player_Draw and not player:isSkipped(change.to)
			and player:hasSkill(self) and player:askForSkillInvoke(self) then
				if player:getChangeSkillState(self:objectName())==1 then
					room:setChangeSkillState(player,self:objectName(),2)
					room:setPlayerMark(player,"yuanjue2",0)
					room:detachSkillFromPlayer(player,"tongkai")
					for _,p in sgs.qlist(room:getAlivePlayers())do
						room:acquireSkill(p,"#yuanjue1",true,false,false)
						room:filterCards(p,p:getHandcards(),false)
					end
				else
					for _,p in sgs.qlist(room:getAlivePlayers())do
						room:detachSkillFromPlayer(p,"#yuanjue1",false,true,false)
						local hs = sgs.CardList()
						for _,c in sgs.qlist(p:getHandcards())do
							if table.contains(c:getSkillNames(), "yuanjue") then hs:append(c) end
						end
						room:filterCards(p,hs,true)
					end
					room:setChangeSkillState(player,self:objectName(),1)
					room:setPlayerMark(player,"yuanjue2",1)
					room:acquireSkill(player,"tongkai")
				end
			end
		else
			local use = data:toCardUse()
			if use.card:isKindOf("Slash") and table.contains(use.card:getSkillNames(),self:objectName()) then
				use.m_addHistory = false
				data:setValue(use)
			end
		end
	end,
}
quaxiaojiang:addSkill(yuanjue)
yuanjue1 = sgs.CreateFilterSkill{
	name = "#yuanjue1",
	view_filter = function(self,card)
		return card:isKindOf("BasicCard")
	end,
	view_as = function(self,card)
		local ex = sgs.Sanguosha:cloneCard("slash",card:getSuit(),card:getNumber())
    	ex:setSkillName("yuanjue")
	    local wrap = sgs.Sanguosha:getWrappedCard(card:getEffectiveId())
	    wrap:takeOver(ex)
	    return wrap
	end
}
extension_e:addSkills(yuanjue1)
yuanjue2 = sgs.CreateDistanceSkill{
	name = "#yuanjue2",
	fixed_func = function(self,from,to)
		if from:getMark("yuanjue2")>0
		or to:getMark("yuanjue2")>0
		then return 1 end
		return -1
	end
}
quaxiaojiang:addSkill(yuanjue2)
aoyong = sgs.CreateTriggerSkill{
    name = "aoyong",
	events = {sgs.CardsMoveOneTime},
	on_trigger = function(self,event,player,data,room)
		if event==sgs.CardsMoveOneTime then
			local move = data:toMoveOneTime()
			if move.to_place==sgs.Player_PlaceHand and move.reason.m_skillName~=self:objectName()
			and move.to:objectName()==player:objectName() and player:askForSkillInvoke(self) then
				local choices = {"aoyong1"}
				if player:isWounded() then table.insert(choices,"aoyong2") end
				if player:getHandcardNum()>0 then table.insert(choices,"aoyong3") end
				if #choices>1 then table.insert(choices,"beishui") end
				local choice = room:askForChoice(player,self:objectName(),table.concat(choices,"+"),data)
				if choice=="beishui" then
					room:loseMaxHp(player,1,self:objectName())
				end
				if choice=="aoyong1" or choice=="beishui" then
					player:drawCards(1,self:objectName())
				end
				if choice=="aoyong2" or choice=="beishui" then
					room:recover(player,sgs.RecoverStruct(self:objectName(),player))
				end
				if choice=="aoyong3" or choice=="beishui" then
					room:askForUseCard(player,".|.|.|hand","aoyong3")
				end
			end
		end
	end,
}
aoyong:setProperty("IgnoreInvalidity",ToData(true))
quaxiaojiang:addSkill(aoyong)
tongkai = sgs.CreateTriggerSkill{
    name = "tongkai",
	events = {sgs.TargetConfirmed},
	on_trigger = function(self,event,player,data,room)
		if event==sgs.TargetConfirmed then
			local use = data:toCardUse()
			if use.card:isDamageCard() then
				for _,p in sgs.qlist(use.to)do
					if player:distanceTo(p)<=1 and player:askForSkillInvoke(self,ToData(p)) then
						player:drawCards(1,self:objectName())
						local dc = room:askForExchange(player,self:objectName(),1,1,true,"tongkai0:"..p:objectName())
						if dc then
							room:giveCard(player,p,dc,self:objectName())
							if p:handCards():contains(dc:getEffectiveId()) then
								dc = sgs.Sanguosha:getCard(dc:getEffectiveId())
								if dc:isKindOf("EquipCard") and dc:isAvailable(p) then
									room:askForUseCard(p,dc:toString(),"tongkai1:"..dc:objectName())
								end
							end
						end
					end
				end
			end
		end
	end,
}
extension_e:addSkills(tongkai)


mengdebenchu = sgs.General(extension_e, "mengdebenchu", "qun+wei", 4)
guibei = sgs.CreateTriggerSkill{
    name = "guibei",
	events = {sgs.GameStart},
	frequency = sgs.Skill_Compulsory,
	on_trigger = function(self,event,player,data,room)
		if event==sgs.GameStart then
			room:sendCompulsoryTriggerLog(player,self)
			player:drawCards(4,self:objectName())
			local aps = room:getAlivePlayers()
			if aps:last()~=player then
				room:swapSeat(player,aps:last())
			end
		end
	end,
}
mengdebenchu:addSkill(guibei)
jiechuvs = sgs.CreateViewAsSkill{
	name = "jiechu",
	view_as = function(self,cards)
		local dc = sgs.Sanguosha:cloneCard("snatch")
		dc:setSkillName("jiechu")
		return dc
	end,
	enabled_at_play = function(self,player)
		return player:getChangeSkillState(self:objectName())==1
	end,
}
jiechu = sgs.CreateTriggerSkill{
    name = "jiechu",
	view_as_skill = jiechuvs,
	events = {sgs.CardFinished,sgs.TargetConfirming,sgs.PreCardUsed},
	can_trigger = function(self,player)
		return player and player:isAlive()
	end,
	on_trigger = function(self,event,player,data,room)
		if event==sgs.PreCardUsed then
			local use = data:toCardUse()
			if use.card:getTypeId()>0 and table.contains(use.card:getSkillNames(),self:objectName()) then
				room:setChangeSkillState(player,self:objectName(),2)
			end
		elseif event==sgs.CardFinished then
			local use = data:toCardUse()
			if use.card:getTypeId()>0 and table.contains(use.card:getSkillNames(),self:objectName())
			and player:getChangeSkillState(self:objectName())==2 then
				for _,p in sgs.list(use.to)do
					if p:isDead() then continue end
					room:askForUseSlashTo(p,player,"jiechu0:"..player:objectName(),false)
				end
			end
		elseif event==sgs.TargetConfirming then
			local use = data:toCardUse()
			if use.card:isKindOf("Slash") and player:getChangeSkillState(self:objectName())==2
			and player:canDiscard(player,"he") and room:askForCard(player,".","jiechu1",data,self:objectName()) then
				room:setChangeSkillState(player,self:objectName(),1)
				local suit = room:askForSuit(player,self:objectName())
				use.card:setSuit(suit)
				local ns = sgs.Sanguosha:getCardNames("NatureSlash")
				table.removeOne(ns,use.card:objectName())
				if use.card:isKindOf("NatureSlash") then table.insert(ns,"slash") end
				local choice = room:askForChoice(player,self:objectName(),table.concat(ns,"+"),data)
				local dc = dummyCard(choice,suit)
				dc:addSubcards(use.card:getSubcards())
				dc:setSkillName("jiechu")
				use:changeCard(dc)
				data:setValue(use)
			end
		end
	end,
}
mengdebenchu:addSkill(jiechu)
daojue = sgs.CreateTriggerSkill{
    name = "daojue",
	change_skill = true,
	waked_skills = "mouqingzheng,ov_zhian,hujia,keolshenli,keshuaizhuni,keolshishou",
	events = {sgs.DamageInflicted,sgs.PreCardUsed},
	on_trigger = function(self,event,player,data,room)
		if event==sgs.DamageInflicted then
			local damage = data:toDamage()
			if damage.card and damage.card:getTypeId()>0 and player:getMark("daojueBan")<1
			and player:getMark(damage.card:getSuitString().."daojueSuit")<1 then
				room:sendCompulsoryTriggerLog(player,self)
				player:addMark(damage.card:getSuitString().."daojueSuit")
				player:damageRevises(data,-damage.damage)
				room:setPlayerFlag(player,"daojueBf0")
				local dc = room:askForUseCard(player,"Slash","daojue0",-1,sgs.Card_MethodUse,true,nil,nil,"daojueBf")
				room:setPlayerFlag(player,"-daojueBf0")
				if dc then
					player:addMark("daojue2Num")
					if player:getMark("daojue2Num")>2 then
						player:addMark("daojue")
						room:detachSkillFromPlayer(player,"jiechu")
						room:changeKingdom(player,"qun")
						room:handleAcquireDetachSkills(player,"keolshenli|keshuaizhuni|keolshishou")
					end
				elseif room:getCardOwner(use.card)==nil then
					player:obtainCard(use.card)
					player:addMark("daojue1Num")
					if player:getMark("daojue1Num")>2 then
						player:addMark("daojueBan")
						room:detachSkillFromPlayer(player,"jiechu")
						room:changeKingdom(player,"wei")
						room:handleAcquireDetachSkills(player,"mouqingzheng|ov_zhian|hujia")
					end
				end
				return true
			end
		else
			local use = data:toCardUse()
			if use.card:hasFlag("daojueBf") then
				room:setCardFlag(use.card,"daojueBf")
				room:setPlayerFlag(player,"-daojueBf0")
				for _,p in sgs.list(room:getOtherPlayers(player))do
					if use.to:contains(p) then continue end
					if player:canSlash(p,use.card,false)
					then use.to:append(p) end
				end
				room:sortByActionOrder(use.to)
				data:setValue(use)
			end
		end
	end,
}
mengdebenchu:addSkill(daojue)
tuonan = sgs.CreateTriggerSkill{
    name = "tuonan",
	events = {sgs.Dying},
	limit_mark = "@tuonan", 
	frequency = sgs.Skill_Limited,
	on_trigger = function(self,event,player,data,room)
		if event==sgs.Dying then
			local dying = data:toDying()
			if dying.who==player and player:getMark("@tuonan")>0
			and player:getHp()<1 and player:askForSkillInvoke(self) then
				room:removePlayerMark(player, "@tuonan")
				room:doSuperLightbox(player,self:objectName())
				room:recover(player,sgs.RecoverStruct(self:objectName(),player))
				local skills = {}
				for _,s in sgs.list(player:getVisibleSkillList())do
					local sd = s:getDescription()
					if string.sub(sd,3,4)=="技，" then
						table.insert(skills,s:objectName())
					end
				end
				if #skills<1 then return end
				local choice = room:askForChoice(player,self:objectName(),table.concat(skills,"+"),data)
				room:detachSkillFromPlayer(player,choice)
			end
		end
	end,
}
mengdebenchu:addSkill(tuonan)


sfofl_guozhao = sgs.General(extension_gai, "sfofl_guozhao", "wei", 3, false)

--[[
	技能名：偏宠
	相关武将：郭照[官盗]
	技能描述：摸牌阶段，你可以改为获得牌堆底的一张牌，此牌倒置（标记为“偏宠”），然后你摸一张牌，直到你下回合开始：你每失去一张倒置牌后，摸一张牌；你每失去一张未倒置的手牌后，获得牌堆底的一张牌并倒置。
	引用：sfofl_pianchong
]] --

sfofl_pianchong = sgs.CreateTriggerSkill{
	name = "sfofl_pianchong",
	frequency = sgs.Skill_Frequent,
	events = {sgs.CardsMoveOneTime,sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.CardsMoveOneTime) then
			local move = data:toMoveOneTime()
            if ((move.from_places:contains(sgs.Player_PlaceHand) or move.from_places:contains(sgs.Player_PlaceEquip)) and move.from:objectName() == player:objectName()) and not((move.to_place == sgs.Player_PlaceHand or move.to_place == sgs.Player_PlaceEquip) and move.to:objectName() == player:objectName())	and player:hasSkill(self) and player:getMark("sfofl_pianchong") > 0 then
				for i,id in sgs.qlist(move.card_ids) do
					local cd = sgs.Sanguosha:getCard(id)
					if cd:hasFlag("cardTip:sfofl_pianchong") then
                        player:drawCards(1, self:objectName())
                    else
					    if move.from_places:at(i)==sgs.Player_PlaceHand then
                            local card_ids = room:drawCardsList(player, 1, self:objectName(), false, true)
                            local card_id = card_ids:first()
                            room:setCardTip(card_id, "sfofl_pianchong")
                        end
                    end
				end
            end
		end
		if (event == sgs.EventPhaseStart) and (player:getPhase() == sgs.Player_Start) then	
            for _, card in sgs.qlist(player:getHandcards()) do
                if card:hasFlag("cardTip:sfofl_pianchong") then
                    room:setCardTip(card:getEffectiveId(), "-sfofl_pianchong")
                end
            end
            room:setPlayerMark(player, "sfofl_pianchong", 0)
            room:setPlayerMark(player, "&sfofl_pianchong", 0)
        elseif event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Draw then
            if room:askForSkillInvoke(player, self:objectName()) then
                local card_ids = room:drawCardsList(player, 1, self:objectName(), false, true)
                local card_id = card_ids:first()
                room:setCardTip(card_id, "sfofl_pianchong")
                player:drawCards(1,self:objectName())
                room:addPlayerMark(player, "&sfofl_pianchong")
                room:addPlayerMark(player, "sfofl_pianchong")
                return true
            end
		end
	end
}


--[[
	技能名：尊位
	相关武将：郭照[官盗]
	技能描述：出牌阶段限一次，你可以选择一项，然后移除该选项：1.将手牌数摸至全场最多；2.随机使用牌堆中的装备牌，直到你装备区牌数为全场最多；3.将体力回复至全场最多。
	引用：sfofl_zunwei
]] --
sfofl_zunwei = sgs.CreateViewAsSkill {
    name = "sfofl_zunwei",
    n = 0,
    view_as = function(self, cards)
        return sfofl_zunweiCard:clone()
    end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_zunwei") and 
        (player:getMark("sfofl_zunwei_hp") == 0 or
        player:getMark("sfofl_zunwei_equip") == 0 or
        player:getMark("sfofl_zunwei_handcard") == 0
        )
    end
}

sfofl_zunweiCard = sgs.CreateSkillCard {
    name = "sfofl_zunwei",
    target_fixed = true,
    will_throw = false,
    on_use = function(self, room, source, targets)
        local choicelist = {}
        local maxhandcard = 0
        local maxequip = 0
        local maxhp = 0
        for _,p in sgs.qlist(room:getAllPlayers())do
            if p:getHandcardNum() > maxhandcard then
                maxhandcard = p:getHandcardNum()
            end
            if p:getEquips():length() > maxequip then
                maxequip = p:getEquips():length()
            end
            if p:getHp() > maxhp then
                maxhp = p:getHp()
            end
        end
        if source:getHp() < math.min(maxhp, source:getMaxHp()) and source:getMark("sfofl_zunwei_hp") == 0 then
            table.insert(choicelist, "hp="..math.min(maxhp, source:getMaxHp()))
        end
        if source:getEquips():length() < maxequip and source:getMark("sfofl_zunwei_equip") == 0 then
            table.insert(choicelist, "equip="..maxequip)
        end
        if source:getHandcardNum() < maxhandcard and source:getMark("sfofl_zunwei_handcard") == 0 then
            table.insert(choicelist, "handcard="..maxhandcard)
        end
        if #choicelist == 0 then return false end
        local choice = room:askForChoice(source, self:objectName(), table.concat(choicelist, "+"))
        if string.startsWith(choice, "hp") then
            room:recover(source,sgs.RecoverStruct(self:objectName(),source, math.min(maxhp, source:getMaxHp())))
        elseif string.startsWith(choice, "equip") then
            for _, id in sgs.qlist(room:getDrawPile()) do
                if sgs.Sanguosha:getCard(id):isKindOf("EquipCard") and source:hasEquipArea(sgs.Sanguosha:getCard(id):getRealCard():toEquipCard():location()) and not source:getEquip(sgs.Sanguosha:getCard(id):getRealCard():toEquipCard():location()) then
                    room:useCard(sgs.CardUseStruct(sgs.Sanguosha:getCard(id), source, source))
                    if source:getEquips():length() >= maxequip then
                        break
                    end
                end
            end
            
        elseif string.startsWith(choice, "handcard") then
            source:drawCards(maxhandcard-source:getHandcardNum(), self:objectName())
        end
    end
}


sfofl_guozhao:addSkill(sfofl_pianchong)
sfofl_guozhao:addSkill(sfofl_zunwei)

sfofl_sunhanhua = sgs.General(extension_gai, "sfofl_sunhanhua", "wu", 3, false)

--[[
	技能名：冲虚
	相关武将：孙寒华[官盗]
	技能描述：出牌阶段限一次，你可以猜测牌堆顶两张牌颜色是否相同并展示之，若你猜对，你可以获得这两张牌或修改“妙剑”或修改“莲华”，否则你可以获得其中的一张牌，然后将另一张牌置于牌堆顶。
	引用：sfofl_chongxu
]] --
sfofl_chongxu = sgs.CreateViewAsSkill {
    name = "sfofl_chongxu",
    n = 0,
    view_as = function(self, cards)
        return sfofl_chongxuCard:clone()
    end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_chongxu")
    end
}

sfofl_chongxuCard = sgs.CreateSkillCard {
    name = "sfofl_chongxu",
    target_fixed = true,
    will_throw = false,
    on_use = function(self, room, source, targets)
        local choice = room:askForChoice(source, self:objectName(), "same+notsame")
        local card_ids = room:showDrawPile(source, 2, self:objectName(), false)
        local guess = false
        if sgs.Sanguosha:getCard(card_ids:first()):getColor() == sgs.Sanguosha:getCard(card_ids:first()):getColor() then
            if choice == "same" then
                guess = true
            else
                guess = false
            end
        else
            if choice == "notsame" then
                guess = true
            else
                guess = false
            end
        end
        if guess then
            local choicelist = {}
            table.insert(choicelist, "obtain")
            if source:getMark("sfofl_chongxu_sfofl_miaojing") < 2 then
                table.insert(choicelist, "sfofl_miaojing")
            end
            if source:getMark("sfofl_chongxu_sfofl_lianhua") < 2 then
                table.insert(choicelist, "sfofl_lianhua")
            end
            local choice = room:askForChoice(source, self:objectName(), table.concat(choicelist, "+"))
            if choice == "obtain" then
                local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                dummy:deleteLater()
                dummy:addSubcards(card_ids)
                room:obtainCard(source, dummy)
            else
                room:addPlayerMark(source, "sfofl_chongxu_"..choice)
                room:changeTranslation(source, choice, source:getMark("sfofl_chongxu_"..choice))
            end
        else
            local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
            dummy:deleteLater()
            room:fillAG(card_ids)
            local card_id = room:askForAG(source, card_ids, false, self:objectName())
            dummy:addSubcard(card_id)
            card_ids:removeOne(card_id)
            room:clearAG()
            source:obtainCard(dummy)
            room:returnToTopDrawPile(card_ids)
        end
    end
}

--[[
	技能名：妙剑
	相关武将：孙寒华[官盗]
	技能描述：出牌阶段限一次，你可以将一张【杀】当做刺【杀】使用，或将一张锦囊牌当做【无中生有】使用。<br>二级：出牌阶段限一次，你可以将一张基本牌当做刺【杀】使用，或将一张非基本牌当做【无中生有】使用。\
    <br>三级：出牌阶段限一次，你可以视为使用了一张刺【杀】或视为使用了一张【无中生有】。
	引用：sfofl_miaojing
]] --
sfofl_miaojingVS = sgs.CreateViewAsSkill{
    name = "sfofl_miaojing",
    n = 1,
    view_filter = function(self, selected, to_select)
        if sgs.Self:getMark("sfofl_chongxu_sfofl_miaojing") > 1 then
            return false
        elseif sgs.Self:getMark("sfofl_chongxu_sfofl_miaojing") > 0 then
            return to_select:isKindOf("Slash") or not to_select:isKindOf("BasicCard")
        end
        return to_select:isKindOf("Slash") or to_select:isKindOf("TrickCard")
    end,
    view_as = function(self, cards)
        local card = sfofl_miaojingCard:clone()
        if sgs.Self:getMark("sfofl_chongxu_sfofl_miaojing") > 1 then
            local dc = sgs.Self:getTag("sfofl_miaojing"):toCard()
            if dc then
                dc = sgs.Sanguosha:cloneCard(dc:objectName())
                dc:setSkillName("sfofl_miaojing")
			    return dc
            end
            return nil
        end
        if #cards == 0 and sgs.Self:getMark("sfofl_chongxu_sfofl_miaojing") < 2 then return nil end
        if #cards == 1 and sgs.Self:getMark("sfofl_chongxu_sfofl_miaojing") < 2 then
            card:addSubcard(cards[1])
            return card
        end
        return card
    end,
    enabled_at_play = function(self, player)
        return player:getMark("sfofl_miaojing-PlayClear") < 1
    end,
}

sfofl_miaojingCard = sgs.CreateSkillCard{
    name = "sfofl_miaojing",
    target_fixed = function(self)		
		if not sgs.Sanguosha:getCard(self:getSubcards():first()):isKindOf("Slash") then
            return true
        end
	end,
	feasible = function(self, targets,player)	
		if not sgs.Sanguosha:getCard(self:getSubcards():first()):isKindOf("Slash") then
            return true
        end
		local card = sgs.Sanguosha:cloneCard("yj_stabs_slash", sgs.Card_SuitToBeDecided, -1)
		card:setSkillName("sfofl_miaojing")
		local qtargets = sgs.PlayerList()
		for _, p in ipairs(targets) do
			qtargets:append(p)
		end
		return card:targetsFeasible(qtargets, player)
	end,
    filter = function(self, targets, to_select)
        local player = sgs.Self
        local qtargets = sgs.PlayerList()
        for _,p in ipairs(targets) do
            qtargets:append(p)
        end
        if not sgs.Sanguosha:getCard(self:getSubcards():first()):isKindOf("Slash") then
            return false
        end
        local card = sgs.Sanguosha:cloneCard("yj_stabs_slash", sgs.Card_SuitToBeDecided, -1)
        card:setSkillName(self:objectName())
        card:deleteLater()
        return card and card:targetFilter(qtargets, to_select, player) and not player:isProhibited(to_select, card, qtargets)
    end, 
    on_validate = function(self, cardUse)
        local source = cardUse.from
        local room = source:getRoom()
        if sgs.Sanguosha:getCard(self:getSubcards():first()):isKindOf("Slash") then
            local card = sgs.Sanguosha:cloneCard("yj_stabs_slash", sgs.Card_SuitToBeDecided, -1)
            card:setSkillName(self:objectName())
            room:setCardFlag(card, "RemoveFromHistory")
            card:addSubcards(self:getSubcards())
            return card
        else
            local card = sgs.Sanguosha:cloneCard("ex_nihilo", sgs.Card_SuitToBeDecided, -1)
            card:setSkillName(self:objectName())
            card:addSubcards(self:getSubcards())
            return card
        end
    end,
}


sfofl_miaojing = sgs.CreateTriggerSkill{
    name = "sfofl_miaojing",
    events = {sgs.GameStart, sgs.MarkChanged, sgs.CardUsed },
    juguan_type = "ex_nihilo,yj_stabs_slash",
    view_as_skill = sfofl_miaojingVS,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.GameStart then
            room:addPlayerMark(player,"sfofl_miaojing_juguan_remove_ex_nihilo")
            room:addPlayerMark(player,"sfofl_miaojing_juguan_remove_yj_stabs_slash")
        elseif event == sgs.MarkChanged then
            local mark = data:toMark()
			if mark.name == "sfofl_chongxu_sfofl_miaojing" and mark.gain > 0 then
                if player:getMark("sfofl_chongxu_sfofl_miaojing") >= 2 then
                    room:setPlayerMark(player,"sfofl_miaojing_juguan_remove_ex_nihilo", 0)
                    room:setPlayerMark(player,"sfofl_miaojing_juguan_remove_yj_stabs_slash", 0)
                end
            end
        elseif event == sgs.CardUsed then
            local use = data:toCardUse()
            if use.card and table.contains(use.card:getSkillNames(),self:objectName()) and not use.card:isKindOf("SkillCard") then
				room:addPlayerMark(player,"sfofl_miaojing-PlayClear")
			end
        end
    end
}


--[[
	技能名：莲华
	相关武将：孙寒华[官盗]
	技能描述：你成为其他角色使用【杀】的目标时，你摸一张牌。\
    <br>二级：你成为其他角色使用【杀】的目标时，你摸一张牌，然后进行一次判定，若判定结果为黑桃，则取消之。\
    <br>三级：你成为其他角色使用【杀】的目标时，你摸一张牌，除非该角色弃置一张牌，否则取消之。
	引用：sfofl_lianhua
]] --

sfofl_lianhua = sgs.CreateTriggerSkill{
	name = "sfofl_lianhua",
	events = {sgs.TargetConfirming},
    frequency = sgs.Skill_Frequent ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.TargetConfirming) then
			local use = data:toCardUse()
			if use.card:isKindOf("Slash") and use.from~=player and use.to:contains(player) then
				if room:askForSkillInvoke(player, self:objectName(), data) then
                    player:drawCards(1, self:objectName())
                    if player:getMark("sfofl_chongxu_sfofl_lianhua") == 1 then
                        local judge = sgs.JudgeStruct()
                        judge.pattern = ".|spade"
                        judge.reason = self:objectName()
                        judge.who = player
                        judge.time_consuming = true
                        room:judge(judge)
                        if judge:isGood() then
                            use.to:removeOne(player)
                            room:sendCompulsoryTriggerLog(player,self)
                            data:setValue(use)
                        end
                    end
                    if player:getMark("sfofl_chongxu_sfofl_lianhua") == 2 then
                        local card = room:askForCard(use.from,".","@sfofl_lianhua:"..use.card:getLogName() .. ":".. player:objectName(),data)
                        if card then
                        else
                            use.to:removeOne(player)
                            room:sendCompulsoryTriggerLog(player,self)
                            data:setValue(use)
                        end
                    end
                end
			end
		end
	end,
}

sfofl_sunhanhua:addSkill(sfofl_chongxu)
sfofl_sunhanhua:addSkill(sfofl_miaojing)
sfofl_sunhanhua:addSkill(sfofl_lianhua)


sfofl_liuyou = sgs.General(extension_gai, "sfofl_liuyou", "qun", 4)

--[[
	技能名：戡难
	相关武将：刘繇[官盗]
	技能描述：出牌阶段每名角色限一次，你可以与一名角色拼点，若你赢，此阶段“戡难” 失效；当你拼点后，赢的角色视为使用一张酒；当你的拼点牌翻开时，你可以令此牌点数+X或-X（ X 为埸上角色的势力数）；当你对本回合使用过酒的其他角色造成伤害时，此伤害+1，结算完成后，其可以对你使用一张【杀】。
	引用：sfofl_kannan
]] --
sfofl_kannanCard = sgs.CreateSkillCard{
	name = "sfofl_kannan",
	will_throw = false,
	filter = function(self, targets, to_select)
		return #targets == 0 and sgs.Self:canPindian(to_select) and to_select:getMark(self:objectName()..sgs.Self:objectName().."-PlayClear") == 0
	end,
	on_use = function(self, room, source, targets)
		room:addPlayerMark(targets[1], self:objectName()..source:objectName().."-PlayClear", 1)
		local success = source:pindian(targets[1], self:objectName(), nil)
        if success then
            room:addPlayerMark(source, "sfofl_kannan-PlayClear")
        end
	end
}
sfofl_kannanVS = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_kannan",
    view_as = function()
        return sfofl_kannanCard:clone()
    end,
    enabled_at_play = function(self, player)
        return player:getMark("sfofl_kannan-PlayClear") == 0 and player:canPindian()
    end
}
sfofl_kannan = sgs.CreateTriggerSkill{
	name = "sfofl_kannan",
	view_as_skill = sfofl_kannanVS,
	events = {sgs.Pindian, sgs.PindianVerifying, sgs.ConfirmDamage, sgs.DamageComplete},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.Pindian then
			local pindian = data:toPindian()
            if pindian.from:hasSkill(self:objectName()) or pindian.to:hasSkill(self:objectName()) then
                local winner = nil
                if pindian.from_number < pindian.to_number then
                    winner = pindian.to
                elseif pindian.from_number > pindian.to_number then
                    winner = pindian.from
                end
                if winner then
                    local analeptic = sgs.Sanguosha:cloneCard("analeptic", sgs.Card_NoSuit, 0)
                    analeptic:setSkillName("sfofl_kannan")
                    local use = sgs.CardUseStruct()
                    use.card = analeptic
                    use.from = winner
                    use.to:append(winner)
                    room:useCard(use)
                    analeptic:deleteLater()
                end
            end
        elseif event == sgs.PindianVerifying then
            local pindian = data:toPindian()
            local n = getKingdoms(player)
            for _,owner in sgs.list(room:findPlayersBySkillName("sfofl_kannan"))do
				if pindian.from==owner then
					local choice = room:askForChoice(owner, self:objectName(),"up="..n.."+down="..n.."+cancel", data)
                    if choice:startsWith("up") then
                        pindian.from_number = math.min(pindian.from_number+n, 13)
                        local log = sgs.LogMessage()
                        log.type = "#sfofl_kannanUp"
                        log.from = owner
                        log.arg  = pindian.from_number
                        room:sendLog(log)
                    elseif choice:startsWith("down") then
                        pindian.from_number = math.max(pindian.from_number-n, 1)
                        local log = sgs.LogMessage()
                        log.type = "#sfofl_kannanDown"
                        log.from = owner
                        log.arg  = pindian.from_number
                        room:sendLog(log)
                    end
					data:setValue(pindian)
				elseif pindian.to==owner then
                    local choice = room:askForChoice(owner, self:objectName(),"up="..n.."+down="..n.."+cancel", data)
					if choice:startsWith("up") then
                        pindian.to_number = math.min(pindian.to_number+n, 13)
                        local log = sgs.LogMessage()
                        log.type = "#sfofl_kannanUp"
                        log.from = owner
                        log.arg  = pindian.to_number
                        room:sendLog(log)
                    elseif choice:startsWith("down") then
                        pindian.to_number = math.max(pindian.to_number-n, 1)
                        local log = sgs.LogMessage()
                        log.type = "#sfofl_kannanDown"
                        log.from = owner
                        log.arg  = pindian.to_number
                        room:sendLog(log)
                    end
					data:setValue(pindian)
				end
			end
		elseif event == sgs.ConfirmDamage then
			local damage = data:toDamage()
			if damage.to and damage.to:getMark("sfofl_kannanAnaleptic-Clear") > 0 and damage.from and player == damage.from and player:hasSkill(self:objectName()) then
                room:addPlayerMark(damage.to, "sfofl_kannanDamaged-Clear")
                room:addPlayerMark(damage.to, "sfofl_kannanDamaged"..player:objectName().."-Clear")
				damage.damage = damage.damage + 1
                data:setValue(damage)
                local log = sgs.LogMessage()
                log.type = "#skill_add_damage"
                log.from = damage.from
                log.to:append(damage.to)
                log.arg  = self:objectName()
                log.arg2 = damage.damage
                room:sendLog(log)
			end
		elseif event == sgs.DamageComplete then
			if player:getMark("sfofl_kannanDamaged-Clear") > 0 then
                room:setPlayerMark(player, "sfofl_kannanDamaged-Clear", 0)
                for _,owner in sgs.list(room:findPlayersBySkillName("sfofl_kannan"))do
                    if player:getMark("sfofl_kannanDamaged"..owner:objectName().."-Clear") > 0 then
                        room:setPlayerMark(player, "sfofl_kannanDamaged"..owner:objectName().."-Clear", 0)
                        room:askForUseSlashTo(player, owner, "@sfofl_kannan:"..owner:objectName(), false, true)
                    end
                end
            end
		end
		return false
	end,
	can_trigger = function(self, target)
		return target
	end
}
sfofl_kannan_record = sgs.CreateTriggerSkill{
	name = "#sfofl_kannan_record",
	events = {sgs.PreCardUsed},
	priority = -1,
	on_trigger = function(self, event, player, data, room)
		if event == sgs.PreCardUsed then
			local card = data:toCardUse().card
		    if card and card:isKindOf("Analeptic") then
                room:addPlayerMark(player, "sfofl_kannanAnaleptic-Clear")
            end
		end
		return false
	end,
	can_trigger = function(self, target)
		return target
	end
}

sfofl_liuyou:addSkill(sfofl_kannan)
sfofl_liuyou:addSkill(sfofl_kannan_record)
extension_gai:insertRelatedSkills("sfofl_kannan", "#sfofl_kannan_record")

sfofl_fanjiangzhangda = sgs.General(extension_gai, "sfofl_fanjiangzhangda", "wu", 4)

--[[
	技能名：怨仇
	相关武将：范疆张达[官盗]
	技能描述：锁定技，当你使用牌指定目标后，此牌无视其相同颜色的防具、不能被颜色不同的牌抵消；当你成为牌的目标后，此牌无视你相同颜色的防具、不能被颜色不同的牌抵消。
	引用：sfofl_yuanchou
]] --
sfofl_yuanchou = sgs.CreateTriggerSkill{
	name = "sfofl_yuanchou",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.TargetConfirmed, sgs.CardUsed, sgs.CardResponded},
	on_trigger = function(self, event, player, data)
	    local room = player:getRoom()
		if event == sgs.TargetConfirmed then 
			local  use = data:toCardUse()
            if not use.card:isKindOf("SkillCard") and use.card:hasSuit() and player and player:hasSkill(self:objectName()) then 
                for _,p in sgs.qlist(use.to) do 
                    if (p:hasSkill(self:objectName()) or (player:hasSkill(self:objectName()) and player:objectName() == use.from:objectName()))  then
                        if p:getArmor() then
                            if p:getArmor():getColor() == use.card:getColor() then
                                p:addQinggangTag(use.card)
                            end
                        end
                        if p:hasSkill(self:objectName()) then
                            room:sendCompulsoryTriggerLog(p, self:objectName())
                            local log = sgs.LogMessage()
                            log.type = "#IgnoreArmor"
                            log.from = p
                            log.card_str = use.card:toString()
                            room:sendLog(log)
                        end
                    end
                end 
                if player:objectName() == use.from:objectName() and player:hasSkill(self:objectName()) then
                    room:sendCompulsoryTriggerLog(player, self:objectName())
                    local log = sgs.LogMessage()
                    log.type = "#IgnoreArmor"
                    log.from = player
                    log.card_str = use.card:toString()
                    room:sendLog(log)
                end
            end
        elseif event == sgs.CardUsed then
            local use = data:toCardUse()
            if use.who and (use.who:hasSkill(self:objectName()) or player:hasSkill(self:objectName())) and use.whocard then
                if use.card:getColor() ~= use.whocard:getColor() then
                    local nullified_list = use.nullified_list
                    table.insert(nullified_list, "_ALL_TARGETS")
                    use.nullified_list = nullified_list
                    data:setValue(use)
                end
            end
        elseif event == sgs.CardResponded then
            local resp = data:toCardResponse()
            if resp.m_toCard and resp.m_who and (resp.m_who:hasSkill(self:objectName()) or player:hasSkill(self:objectName())) then
                if resp.m_toCard:getColor() ~= resp.m_card:getColor() then
                    resp.nullified = true
                    data:setValue(resp)
                end
            end
		end
	end,
    can_trigger = function(self,target)
	    return target and target:isAlive()
    end
}

sfofl_fanjiangzhangda:addSkill(sfofl_yuanchou)
sfofl_fanjiangzhangda:addSkill("juesheng")


sfofl_huangquan = sgs.General(extension_gai, "sfofl_huangquan", "shu", 3)

--[[
	技能名：谏计
	相关武将：黄权[官盗]
	技能描述：出牌阶段限一次，你可以令一名其他角色摸一张牌然后该角色可以对“点虎”角色无距离限制使用此牌，或将此牌当【杀】使用。
	引用：sfofl_jianji
]] --

sfofl_jianjiCard = sgs.CreateSkillCard{
	name = "sfofl_jianji",
	filter = function(self, targets, to_select)
		return #targets == 0 and to_select:objectName() ~= sgs.Self:objectName()
	end,
	on_use = function(self, room, source, targets)
        local ids = targets[1]:drawCardsList(1, self:objectName())
		local card = sgs.Sanguosha:getCard(ids:first())
		if card:isAvailable(targets[1]) then
            room:setCardFlag(card, self:objectName())
			if card and not card:targetFixed() and room:askForUseCard(targets[1], ""..ids:first(), "@sfofl_jianji:".. card:objectName()) then
            else
                room:setCardFlag(card, "-"..self:objectName())
                local use_card = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                use_card:setSkillName(self:objectName())
                use_card:addSubcard(card)
                use_card:deleteLater()
                local targets = room:getCardTargets(targets[1], use_card)
                if not targets:isEmpty() then
                    local target = room:askForPlayerChosen(targets[1], targets, "sfofl_jianji",
                    "@sfofl_jianji_slash:" ..card:objectName(), true, true)
                    if target then
                        local use = sgs.CardUseStruct()
                        use.card = use_card
                        use.from = targets[1]
                        use.to:append(target)
                        room:useCard(use)
                    end
                end
            end
            room:setCardFlag(card, "-"..self:objectName())
		end
	end
}
sfofl_jianji = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_jianji",
	view_as = function(self)
		return sfofl_jianjiCard:clone()
	end,
	enabled_at_play = function(self,player)
		return not player:hasUsed("#sfofl_jianji")
	end
}
sfofl_jianji_buff = sgs.CreateTargetModSkill{
    name = "#sfofl_jianji_buff",
    pattern = ".",
    distance_limit_func = function(self, from, card, to)
        if card:hasFlag("sfofl_jianji") and to and to:getMark("&dianhu") > 0 then return 1000 end
        return 0
    end,
}
sfofl_jianji_prohibit = sgs.CreateProhibitSkill {
	name = "#sfofl_jianji_prohibit",
	is_prohibited = function(self, from, to, card)
		if card and card:hasFlag("sfofl_jianji") then
			if to and to:getMark("&dianhu") == 0 then
				return true
			end
		end
		return false
	end
}

sfofl_huangquan:addSkill("dianhu")
sfofl_huangquan:addSkill("#dianhu-target")
sfofl_huangquan:addSkill(sfofl_jianji)
sfofl_huangquan:addSkill(sfofl_jianji_buff)
sfofl_huangquan:addSkill(sfofl_jianji_prohibit)
extension_gai:insertRelatedSkills("sfofl_jianji", "#sfofl_jianji_buff")
extension_gai:insertRelatedSkills("sfofl_jianji", "#sfofl_jianji_prohibit")



sfofl_mayunlu = sgs.General(extension_gai, "sfofl_mayunlu", "shu", 4, false)

--[[
	技能名：凤魄
	相关武将：马云騄[官盗]
	技能描述：出牌阶段限一次，当你使用【杀】或伤害类锦囊牌指定唯一目标后，你可以弃置任意张方片手牌，然后选择一项：1.摸2X张牌；2.此牌造成的伤害+X（X为你弃置的牌数）。
	引用：sfofl_fengpo
]] --
sfofl_fengpo = sgs.CreateTriggerSkill{
	name = "sfofl_fengpo",
	events = {sgs.TargetSpecified,sgs.ConfirmDamage},
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
		if event==sgs.TargetSpecified then
            if player:getMark("sfofl_fengpo-PlayClear") == 0 and player:getPhase() == sgs.Player_Play then
                local use = data:toCardUse()
                use.card:removeTag("sfofl_fengpo")
                if use.to:length()==1 and (use.card:isKindOf("Slash") or (use.card:isKindOf("TrickCard") and use.card:isDamageCard())) then
                    local discard = room:askForDiscard(player, self:objectName(), player:getHandcardNum(), 0, true, false, "@sfofl_fengpo:"..use.to:first():objectName(), ".|diamond|.|.")
                    if discard then
                        local x = discard:subcardsLength()
                        local choice = "sfofl_fengpo1="..x.."+sfofl_fengpo2="..x
                        choice = room:askForChoice(player,"sfofl_fengpo",choice,data)
                        if choice:startsWith("sfofl_fengpo2")
                        then use.card:setTag("sfofl_fengpo",ToData(x))
                        else player:drawCards(x*2,"sfofl_fengpo") end
                    end
                end
            end
		else
		    local damage = data:toDamage()
            if damage.card then
                local x = damage.card:getTag("sfofl_fengpo"):toInt()
				if x<1 then return end
    	        player:damageRevises(data,x)
			end
		end
		return false
	end
}

sfofl_mayunlu:addSkill("mashu")
sfofl_mayunlu:addSkill(sfofl_fengpo)



sfofl_liyan = sgs.General(extension_gai, "sfofl_liyan", "shu", 3)

--[[
	技能名：督粮
	相关武将：李严[官盗]
	技能描述：出牌阶段限一次，你可以获得一名其他角色的一张手牌，然后选择一项：1.该角色进行判定，若结果为红色，其摸两张牌；2.令其于其下个摸牌阶段多摸一张牌。
	引用：sfofl_duliang
]] --
sfofl_duliangCard = sgs.CreateSkillCard{
	name = "sfofl_duliang",
	filter = function(self, targets, to_select)
		return #targets == 0 and not to_select:isKongcheng() and to_select:objectName() ~= sgs.Self:objectName()
	end,
	on_use = function(self, room, source, targets)
        local card = sgs.Sanguosha:getCard(room:askForCardChosen(source, targets[1], "h", self:objectName()))
        room:obtainCard(source, card, sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_EXTRACTION, source:objectName()), false)
        local choice = room:askForChoice(source, self:objectName(), "judge="..targets[1]:objectName().."+draw="..targets[1]:objectName(), ToData(targets[1]))
        if string.startsWith(choice,"judge") then
            local judge = sgs.JudgeStruct()
            judge.pattern = ".|red"
            judge.good = true
            judge.reason = self:objectName()
            judge.who = targets[1]
            judge.time_consuming = true
            room:judge(judge)
            if judge:isGood() then
                targets[1]:drawCards(2)
            end
        else
            room:addPlayerMark(targets[1], self:objectName().."-SelfClear")
            room:addPlayerMark(targets[1], "&sfofl_duliang+to+#"..source:objectName().."-SelfClear")
        end
	end
}
sfofl_duliangVS = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_duliang",
	view_as = function()
		return sfofl_duliangCard:clone()
	end,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_duliang")
	end
}
sfofl_duliang = sgs.CreateDrawCardsSkill{
	name = "sfofl_duliang",
	view_as_skill = sfofl_duliangVS,
	draw_num_func = function(self, player, n)
		local room = player:getRoom()
		local x = player:getMark(self:objectName().."-SelfClear")
		return n + x
	end,
    can_trigger = function(self,target)
	    return target and target:isAlive() and target:getMark("sfofl_duliang-SelfClear") > 0
    end
}

sfofl_liyan:addSkill("fulin")
sfofl_liyan:addSkill(sfofl_duliang)



sfofl_tianyu = sgs.General(extension_gai, "sfofl_tianyu", "wei", 4)

--[[
	技能名：追讨
	相关武将：田豫[官盗]
	技能描述：每轮开始时，你可以选择一名其他角色，本轮你与其的距离-1。
	引用：sfofl_zhuitao
]] --

sfofl_zhuitao_distance = sgs.CreateDistanceSkill{
	name = "#sfofl_zhuitao_distance",
	correct_func = function(self, from, to)
		if from:hasSkill("sfofl_zhuitao") then
			if to:getMark("sfofl_zhuitao"..from:objectName()) > 0 then
                return -1
            end
		else
			return 0
		end
	end
}
sfofl_zhuitao = sgs.CreateTriggerSkill{
	name = "sfofl_zhuitao" ,
	frequency = sgs.Skill_Frequent ,
	events = {sgs.EventPhaseStart, sgs.RoundEnd} ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.EventPhaseStart then 
            if player:getPhase() == sgs.Player_Start then
                local  targets = sgs.SPlayerList()
                for _,p in sgs.qlist(room:getOtherPlayers(player)) do
                    if p:getMark(self:objectName()..player:objectName()) == 0 then
                        targets:append(p)
                    end
                end
                local target = room:askForPlayerChosen(player, targets, self:objectName(), "sfofl_zhuitao-invoke", true, true)
                if not target then return false end
                room:addPlayerMark(target, "&sfofl_zhuitao+to+#"..player:objectName().."_lun")
                room:addPlayerMark(target, self:objectName()..player:objectName())
                room:broadcastSkillInvoke(self:objectName())
            end
		elseif event == sgs.RoundEnd then
            for _,p in sgs.qlist(room:getAllPlayers()) do
                if p:getMark(self:objectName()..player:objectName()) > 0 then
                    room:setPlayerMark(p, self:objectName()..player:objectName(),0)
                end
		    end
        end
		return false
	end
}



sfofl_tianyu:addSkill("saodi")
sfofl_tianyu:addSkill(sfofl_zhuitao)
sfofl_tianyu:addSkill(sfofl_zhuitao_distance)
extension_gai:insertRelatedSkills("sfofl_zhuitao", "#sfofl_zhuitao_distance")


sfofl_2_caopi = sgs.General(extension_gai, "sfofl_2_caopi$", "wei", 3)

--[[
	技能名：行殇
	相关武将：曹丕[官盗]
	技能描述：其他角色死亡时，你可以获得其所有牌，若你不为主公，你可以改为回复1点体力。
	引用：sfofl_xingshang
]] --

sfofl_xingshang = sgs.CreateTriggerSkill{
    name = "sfofl_xingshang",
    events = {sgs.Death},
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local death = data:toDeath()
        local splayer = death.who
        if splayer:objectName() ~= player:objectName()  then
            if player:isAlive() and ((not player:isLord() and player:isWounded()) or not splayer:isNude())  then
                if player:askForSkillInvoke(self:objectName(), data) then
                    if not player:isLord() and player:isWounded() and player:askForSkillInvoke(self:objectName().."lord", data) then
                        room:recover(player,sgs.RecoverStruct(self:objectName(),player, 1))
                    else
                        local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                        local cards = splayer:getCards("he")
                        for _,card in sgs.qlist(cards) do
                            dummy:addSubcard(card)
                        end
                        if cards:length() > 0 then
                            local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_RECYCLE, player:objectName())
                            room:obtainCard(player, dummy, reason, false)
                        end
                        dummy:deleteLater()
                    end
                end
            end
        end
    end
}

--[[
	技能名：放逐
	相关武将：曹丕[官盗]
	技能描述：当你受到伤害后，你可以令一名其他角色翻面并摸X张牌，若你不为主公，该角色可以改为弃置X张牌并失去1点体力（X为你已损失的体力值）。
	引用：sfofl_fangzhu
]] --    

sfofl_fangzhu = sgs.CreateMasochismSkill{
    name = "sfofl_fangzhu",
    on_damaged = function(self, player)
        local room = player:getRoom()
        local to = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName(), "sfofl_fangzhu-invoke", true, true)
        if to then
            if not player:isLord() then
                local n = player:getLostHp()
                if n>0 and room:askForDiscard(to, self:objectName(), n, n, true,true,"@sfofl_fangzhu:"..player:objectName()) then
                   room:loseHp(to, 1, true, player, self:objectName())
                else
                    to:drawCards(player:getLostHp(), self:objectName())
                    to:turnOver()
                end
            else
                to:drawCards(player:getLostHp(), self:objectName())
                to:turnOver()
            end
        end
    end
}

sfofl_2_caopi:addSkill(sfofl_xingshang)
sfofl_2_caopi:addSkill(sfofl_fangzhu)
sfofl_2_caopi:addSkill("songwei")


sfofl_zhangchangpu = sgs.General(extension_gai, "sfofl_zhangchangpu", "wei", 3, false)

--[[
	技能名：省身
	相关武将：张昌蒲[官盗]
	技能描述：当你受到伤害后，你可以摸X张牌，然后令你下一次展示的牌数+X。 (X为你已损失的体力值且严教累计至多+6)
	引用：sfofl_shengshen
]] --  

sfofl_shengshen = sgs.CreateTriggerSkill{
	name = "sfofl_shengshen",
	events = {sgs.Damaged},
	frequency = sgs.Skill_Frequent,
	on_trigger = function(self, event, player, data, room)
		if room:askForSkillInvoke(player, self:objectName(), data) then
			room:broadcastSkillInvoke(self:objectName())
			player:drawCards(player:getLostHp(), self:objectName())
            local x = math.min(6, player:getMark("&ny_10th_xingshen") + player:getLostHp())
			room:setPlayerMark(player, "&ny_10th_xingshen", x)
		end
		return false
	end
}

sfofl_zhangchangpu:addSkill("ny_tenth_yanjiao")
sfofl_zhangchangpu:addSkill(sfofl_shengshen)


sfofl_puyuan = sgs.General(extension_gai, "sfofl_puyuan", "shu", 4)

--[[
	技能名：铸刃
	相关武将：蒲元[官盗]
	技能描述：出牌阶段限一次，你可以弃置一张手牌并进行判定，若判定结果点数不大于此牌，你获得一张“铸刃”打造的武器牌（花色决定武器名称，点数决定成功率）
	引用：sfofl_zhuren
]] --  

sfofl_zhurenCard = sgs.CreateSkillCard{
    name = "sfofl_zhuren",
	target_fixed = true,
	on_use = function(self, room, source, targets)
		local card = sgs.Sanguosha:getCard(self:getSubcards():first())
        local judge = sgs.JudgeStruct()
        judge.pattern = ".|.|1~"..card:getNumberString().."|.|."
        judge.reason = self:objectName()
        judge.who = source
        judge.time_consuming = true
        room:judge(judge)
        if judge:isGood() then
            local name = "_hongduanqiang"
            if card:isKindOf("Lightning") then
                name = "_tianleiren"
            else
                if judge.card:getSuit() == sgs.Card_Spade then
                    name = "_hunduwanbi"
                elseif card:getSuit() == sgs.Card_Club then
                    name = "_shuibojian"
                elseif card:getSuit() == sgs.Card_Diamond then
                    name = "_liecuidao"
                end
            end
            local id = source:getDerivativeCard(name, sgs.Player_PlaceHand)
        end
	end
}
sfofl_zhuren = sgs.CreateOneCardViewAsSkill{
    name = "sfofl_zhuren",
    filter_pattern = ".|.|.|hand",
	view_as = function(self, card)
        local skillcard = sfofl_zhurenCard:clone()
		skillcard:addSubcard(card)
		return skillcard
    end,
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_zhuren") and player:canDiscard(player, "h")
	end
}

sfofl_puyuan:addSkill("tianjiang")
sfofl_puyuan:addSkill(sfofl_zhuren)


sfofl_gaolan = sgs.General(extension_gai, "sfofl_gaolan", "qun", 4)

--[[
	技能名：袭营
	相关武将：高览[官盗]
	技能描述：出牌阶段开始时，你可以弃置一张牌并令所有其他角色选择一项：弃置一张牌；本回合内不能使用或打出牌；若如此做且当前回合结束时，若你本回合造成过伤害，你可以获得弃牌堆中的一张【杀】或伤害类锦囊。
	引用：sfofl_xiying
]] --  
sfofl_xiying = sgs.CreateTriggerSkill{
	name = "sfofl_xiying" ,
    frequency = sgs.Skill_Frequent,
    events = {sgs.EventPhaseStart, sgs.EventPhaseChanging} ,
	on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.EventPhaseStart then
            if (player:getPhase() == sgs.Player_Play) and (not player:isKongcheng()) then
                local card = room:askForCard(player, ".", "@sfofl_xiying", sgs.QVariant(), sgs.Card_MethodDiscard, player, false, self:objectName())
                if card then
                    room:addPlayerMark(player, self:objectName().."-Clear")
                    room:broadcastSkillInvoke(self:objectName())
                    for _, p in sgs.qlist(room:getOtherPlayers(player)) do
                        local dest = sgs.QVariant()
                        dest:setValue(player)
                        local cd = room:askForCard(p, ".|.|.", "@xiying_CardLimitation", dest, sgs.Card_MethodDiscard, player, false, self:objectName())
                        if not cd then
                            room:addPlayerMark(p, self:objectName().. player:objectName() .."-Clear")
                            room:addPlayerMark(p, "&sfofl_xiying-Clear")
                            room:setPlayerCardLimitation(p, "use,response", ".", true)
                        end
                    end
                end
            end
        elseif event == sgs.EventPhaseChanging then
            local change = data:toPhaseChange()
            if change.to == sgs.Player_NotActive and player:getMark("sfofl_xiying-Clear") > 0 and player:getMark("damage_point_turn-Clear") > 0 and room:askForSkillInvoke(player, self:objectName()) then
                room:broadcastSkillInvoke("sfofl_xiying")
                local card_ids = sgs.IntList()
                for _, id in sgs.qlist(room:getDiscardPile()) do
                    local card = sgs.Sanguosha:getCard(id)
                    if card:isKindOf("Slash") or (card:isKindOf("TrickCard") and card:isDamageCard()) then
                        card_ids:append(id)
                    end
                end
                if not card_ids:isEmpty() then
                    local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                    dummy:deleteLater()
                    room:fillAG(card_ids)
                    local card_id = room:askForAG(player, card_ids, false, self:objectName())
                    dummy:addSubcard(card_id)
                    room:clearAG()
                    player:obtainCard(dummy)
                end
            end
		end
		return false
	end ,
}

sfofl_gaolan:addSkill(sfofl_xiying)


sfofl_duyu = sgs.General(extension_gai, "sfofl_duyu", "qun", 4)

--[[
	技能名：三陈
	相关武将：杜预[官盗]
	技能描述：觉醒技，结束阶段开始时，若你有至少三枚“武库”标记，你加1点体力上限，回复1点体力，然后获得技能“灭吴”。
	引用：sfofl_sanchen
]] --  

sfofl_sanchen = sgs.CreatePhaseChangeSkill{
    name = "sfofl_sanchen",
    frequency = sgs.Skill_Wake,
    waked_skills = "sfofl_miewu",
    on_phasechange = function(self, player)
        local room = player:getRoom()
        room:setPlayerMark(player, self:objectName(), 1)
        if room:changeMaxHpForAwakenSkill(player, 1, self:objectName()) then
            room:recover(player,sgs.RecoverStruct(self:objectName(),player, 1))
            room:handleAcquireDetachSkills(player, "sfofl_miewu")
        end
        return false
    end ,
    can_trigger = function(self, target)
        return target and target:isAlive() and target:hasSkill(self:objectName()) and target:getPhase() == sgs.Player_Finish 
        and target:getMark(self:objectName()) == 0 and (target:getMark("&mobilezhiwuku") >= 2 or target:canWake(self:objectName()))
    end
}

--[[
	技能名：灭吴
	相关武将：杜预[官盗]
	技能描述：每名角色的回合限一次，你可以移去一个“武库”，视为使用或打出任意一张基本牌或普通锦囊牌，若如此做，并摸一张牌。
	引用：sfofl_miewu
]] --  
sfofl_miewuCard = sgs.CreateSkillCard{
    name = "sfofl_miewu",
    will_throw = false,
    filter = function(self, targets, to_select, from)
        local pattern = self:getUserString()
		local dc = dummyCard(pattern:split("+")[1])
		if dc:targetFixed() then return false end
		dc:setSkillName("sfofl_miewu")
		local plist = sgs.PlayerList()
		for i = 1, #targets do plist:append(targets[i]) end
		return dc:targetFilter(plist,to_select,from)
	end,
    feasible = function(self,targets,from)
		local pattern = self:getUserString()
		local dc = dummyCard(pattern:split("+")[1])
        dc:setSkillName("sfofl_miewu")
        if card and card:canRecast() and #targets == 0 then
			return false
		end
		local plist = sgs.PlayerList()
		for i = 1, #targets do plist:append(targets[i]) end
		return dc:targetFixed() or dc:targetsFeasible(plist, from)
	end,
	on_validate = function(self, card_use)
		local player = card_use.from
        local room = player:getRoom()

        local pattern = self:getUserString()
        local card = sgs.Sanguosha:cloneCard(pattern, sgs.Card_NoSuit, 0)
		card:setSkillName(self:objectName())

        room:addPlayerMark(player, "sfofl_miewu-Clear", 1)
        room:addPlayerMark(player, "&sfofl_miewu-Clear", 1)
        room:removePlayerMark(player, "&mobilezhiwuku", 1)
        player:drawCards(1, self:objectName())
		return card
	end,
    on_validate_in_response = function(self, player)
        local room = player:getRoom()

        local pattern = self:getUserString()
		if pattern == "normal_slash" then pattern = "slash" end
        if pattern == "Slash" then
            local all = {"slash","fire_slash","thunder_slash"} 
            pattern = room:askForChoice(player, "sfofl_miewu_Slash", table.concat(all, "+"))
        end
        if pattern == "Jink" then pattern = "jink" end
        if pattern == "peach+analeptic" then 
            local all = {"peach","analeptic"} 
            local items = {}
            for _,item in ipairs(all) do
                local mark = string.format("sfofl_miewu_guhuo_remove_%s-Clear", item)
                if player:getMark(mark) == 0 then
                    table.insert(items, item)
                end
            end
            pattern = room:askForChoice(player, "sfofl_miewu_saveself", table.concat(items, "+"))
        end

		local card = sgs.Sanguosha:cloneCard(pattern, sgs.Card_NoSuit, 0)
		card:setSkillName(self:objectName())
        room:addPlayerMark(player, "sfofl_miewu-Clear", 1)
        room:addPlayerMark(player, "&sfofl_miewu-Clear", 1)
        room:removePlayerMark(player, "&mobilezhiwuku", 1)
        player:drawCards(1, self:objectName())
        return card
    end
}

sfofl_miewu = sgs.CreateZeroCardViewAsSkill{
    name = "sfofl_miewu",
    guhuo_type = "lr",
    view_as = function(self, card)
        local cc = sfofl_miewuCard:clone()
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
            local c = sgs.Self:getTag("sfofl_miewu"):toCard()
            cc:setUserString(c:objectName())
            return cc
        else
            local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
            if pattern == "slash" then pattern = "Slash" end
            cc:setUserString(pattern)
            return cc
        end
    end,
    enabled_at_play = function(self, player)
        if player:getMark("sfofl_miewu-Clear") > 0 then return false end
        if player:getMark("&mobilezhiwuku") < 1 then return false end
        local can = false
		for _,p in sgs.list(patterns())do
			local dc = dummyCard(p)
			if dc then
                if dc:isKindOf("BasicCard") or dc:isNDTrick()  then
                    dc:setSkillName("sfofl_miewu")
                    if not player:isLocked(dc)
                    then can = true break end
                end
			end
		end
		if can==false then return false end
        return true
    end,
    enabled_at_response = function(self, player, pattern)
        if player:getMark("sfofl_miewu-Clear") > 0 then return false end
        if player:getMark("&mobilezhiwuku") < 1  then return false end
        local can = false
		for _,p in sgs.list(pattern:split("+"))do
			local dc = dummyCard(p)
			if dc then
                if dc:isKindOf("BasicCard") or dc:isNDTrick()  then
                    dc:setSkillName("sfofl_miewu")
                    if not player:isLocked(dc)
                    then can = true break end
                end
			end
		end
		if can==false then return false end
        return true
    end
}



sfofl_duyu:addSkill("mobilezhiwuku")
sfofl_duyu:addSkill(sfofl_sanchen)
if not sgs.Sanguosha:getSkill("sfofl_miewu") then skills:append(sfofl_miewu) end

sfofl_xuchu = sgs.General(extension_gai, "sfofl_xuchu", "wei", 4)

--[[
	技能名：裸衣
	相关武将：许褚[官盗]
	技能描述：摸牌阶段，你可以少摸任意张牌并展示牌堆顶两倍的牌，然后你可以获得其中的基本牌、武器牌或【决斗】。若如此做，你放弃摸牌，且你为伤害来源的【杀】或【决斗】造成的伤害+1直到你的下回合开始。
	引用：sfofl_luoyi
]] --  
sfofl_luoyi = sgs.CreateTriggerSkill{
	name = "sfofl_luoyi",
	frequency = sgs.Skill_NotFrequent,
	events = {sgs.DrawNCards},
	on_trigger = function(self, event, player, data)
		local draw = data:toDraw()
		if draw.reason ~= "draw_phase" then return false end
		local room = player:getRoom()
		if draw.num > 0 then
			if room:askForSkillInvoke(player, self:objectName(), data) then
                local choicelist = {}
                for i = 1, draw.num, 1 do
                    table.insert(choicelist, i)
                end
                local choice = room:askForChoice(player, self:objectName(), table.concat(choicelist, "+"))
				draw.num = draw.num - tonumber(choice)
                local card_ids = room:showDrawPile(player, 2*tonumber(choice), self:objectName(), true, true)
                local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                dummy:deleteLater()
                for _, id in sgs.qlist(card_ids) do
                    local c = sgs.Sanguosha:getCard(id)
                    if c:isKindOf("BasicCard") or c:isKindOf("Duel") or c:isKindOf("Weapon") then
                        dummy:addSubcard(id)
                    end
                end
                player:obtainCard(dummy)
				room:addPlayerMark(player, "sfofl_luoyi")
				room:addPlayerMark(player, "&sfofl_luoyi")
				data:setValue(draw)
			end
		end
	end
}
sfofl_luoyi_buff = sgs.CreateTriggerSkill{
	name = "#sfofl_luoyi_buff",
	frequency = sgs.Skill_Frequent,
	events = {sgs.DamageCaused, sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data, room)
        if event == sgs.DamageCaused then
            local damage = data:toDamage()
            if damage.chain or damage.transfer or (not damage.by_user) then return false end
            local reason = damage.card
            if reason and (reason:isKindOf("Slash") or reason:isKindOf("Duel")) then
                damage.damage = damage.damage + 1
                data:setValue(damage)
            end
        elseif event == sgs.EventPhaseStart then
            if player:getPhase() == sgs.Player_Start then
                room:setPlayerMark(player, "sfofl_luoyi", 0)
				room:setPlayerMark(player, "&sfofl_luoyi", 0)
            end
        end
		return false
	end,
	can_trigger = function(self, target)
		return target and target:getMark("sfofl_luoyi") > 0 and target:isAlive()
	end
}

sfofl_xuchu:addSkill(sfofl_luoyi)
sfofl_xuchu:addSkill(sfofl_luoyi_buff)
extension_gai:insertRelatedSkills("sfofl_luoyi", "#sfofl_luoyi_buff")

sfofl_w_shenzhangliang = sgs.General(extension_war, "sfofl_w_shenzhangliang", "god", 3, true, hide_boss)
sfofl_w_shenzhangbao = sgs.General(extension_war, "sfofl_w_shenzhangbao", "god", 4, true, true)
sfofl_w_shenzhangjiao = sgs.General(extension_war, "sfofl_w_shenzhangjiao", "god", 5, true, true)

--[[
	技能名：人公
	相关武将：神张梁[战役]
	技能描述：出牌阶段，你可以将任意张牌置于你的武将牌上；你每有一张牌移出游戏时，便可以弃置其他角色的一张牌。
	引用：sfofl_rengong
]] -- 

sfofl_rengongCard = sgs.CreateSkillCard {
	name = "sfofl_rengong",
	target_fixed = true,
	will_throw = false,
	on_use = function(self, room, source, targets)
        local splayers = sgs.SPlayerList()
        splayers:append(source)
		-- source:addToPile("sfofl_huangjin", self, false, splayers)
		source:addToPile("sfofl_huangjin", self)
	end
}
sfofl_rengongVS = sgs.CreateViewAsSkill {
	name = "sfofl_rengong",
	n = 999,
	view_filter = function(self, selected, to_select)
		return not to_select:isEquipped()
	end,
	view_as = function(self, cards)
		if #cards > 0 then
			local card = sfofl_rengongCard:clone()
			for _, c in pairs(cards) do
                card:addSubcard(c)
            end
			return card
		end
	end,
	enabled_at_play = function(self, player)
		return not player:isKongcheng()
	end
}

sfofl_rengong = sgs.CreateTriggerSkill{
	name = "sfofl_rengong",
	events = {sgs.CardsMoveOneTime},
    view_as_skill = sfofl_rengongVS,
	on_trigger = function(self, event, player, data, room)
        if event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            local players = sgs.SPlayerList()
            if move.to_place and move.to_place == sgs.Player_PlaceSpecial and move.from and (move.from_places:contains(sgs.Player_PlaceHand) or move.from_places:contains(sgs.Player_PlaceEquip)) then
                if string.startsWith(move.to_pile_name, "#") then return false end
                local from = room:findPlayerByObjectName(move.from:objectName())
                if from and from:isAlive() and from:objectName() == player:objectName() then
                    for i,id in sgs.qlist(move.card_ids) do
					    if (move.from_places:at(i)==sgs.Player_PlaceHand or move.from_places:at(i)==sgs.Player_PlaceEquip) then
                            local targets = sgs.SPlayerList()
                            for _, p in sgs.qlist(room:getOtherPlayers(player)) do
                                if player:canDiscard(p, "he") then
                                    targets:append(p)
                                end
                            end
                            if not targets:isEmpty() then
                                local target = room:askForPlayerChosen(player, targets, self:objectName(), "sfofl_rengong-invoke", true, true)
                                if target then
                                    local id = room:askForCardChosen(player,target,"he",self:objectName(),false,sgs.Card_MethodDiscard)
                                    room:throwCard(id,self:objectName(),target,player)
                                else
                                    break
                                end
                            end
                        end
                    end
                end
            end
        end
		return false
	end
}


--[[
	技能名：鬼继
	相关武将：神张梁[战役]
	技能描述：锁定技，当你死亡时，你所属区域里的牌与武将牌上的牌保留给下一名登场角色。
	引用：sfofl_guiji
]] -- 

sfofl_guiji = sgs.CreateTriggerSkill{
    name = "sfofl_guiji", 
    events = {sgs.BeforeGameOverJudge}, 
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data, room)
        if event == sgs.BeforeGameOverJudge then
            local death = data:toDeath()
            if not player then return false end
            if player:objectName() ~= death.who:objectName() then return false end
            local general_list = { "sfofl_w_shenzhangliang", "sfofl_w_shenzhangbao", "sfofl_nw_shenzhangliang", "sfofl_nw_shenzhangbao" }
            local can_invoke = false
            for _,general in sgs.list(general_list)do
                if player:getGeneralName()==general or player:getGeneral2Name()==general then
                    can_invoke = true
                    break
                end
            end
            if can_invoke and player:hasSkill(self:objectName()) then
                player:setAlive(true)
                room:broadcastProperty(player, "alive")
                room:swapSeat(player, player)
                room:setPlayerFlag(player, "-Global_Dying")
                local currentdying = room:getTag("CurrentDying"):toStringList()
                table.removeOne(currentdying,player:objectName())
                room:setTag("CurrentDying", sgs.QVariant(table.concat(currentdying, "|")))
                -- room:recover(player, sgs.RecoverStruct(self:objectName(), player, player:getLostHp()))
                if player:getGeneralName()=="sfofl_w_shenzhangliang" then
                    room:changeHero(player,"sfofl_w_shenzhangbao",true,true)
                elseif player:getGeneral2Name()=="sfofl_w_shenzhangliang" then
                    room:changeHero(player,"sfofl_w_shenzhangbao",true,true, true)
                elseif player:getGeneralName()=="sfofl_w_shenzhangbao" then
                    room:changeHero(player,"sfofl_w_shenzhangjiao",true,true)
                elseif player:getGeneral2Name()=="sfofl_w_shenzhangbao" then
                    room:changeHero(player,"sfofl_w_shenzhangjiao",true,true, true)
                elseif player:getGeneralName()=="sfofl_nw_shenzhangliang" then
                    room:changeHero(player,"sfofl_nw_shenzhangbao",true,true)
                elseif player:getGeneral2Name()=="sfofl_nw_shenzhangliang" then
                    room:changeHero(player,"sfofl_nw_shenzhangbao",true,true, true)
                elseif player:getGeneralName()=="sfofl_nw_shenzhangbao" then
                    room:changeHero(player,"sfofl_nw_shenzhangjiao",true,true)
                elseif player:getGeneral2Name()=="sfofl_nw_shenzhangbao" then
                    room:changeHero(player,"sfofl_nw_shenzhangjiao",true,true, true)
                end
                return true
            end
        end
        return false
    end,
    can_trigger = function(self,target)
		return target
	end,

}


--[[
	技能名：血逆
	相关武将：神张梁[战役] 张宝[战役]
	技能描述：锁定技，结束阶段，若你的武将牌上有相同点数的牌，你死亡。
	引用：sfofl_xueni
]] -- 
sfofl_xueni = sgs.CreateTriggerSkill{
	name = "sfofl_xueni",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish then
            local card_ids = sgs.IntList()
            for _,key in sgs.list(player:getPileNames())do
                for _,id in sgs.list(player:getPile(key))do
                    card_ids:append(id)
                end
            end
            local numbers = {}
            local duplicatenumbers = {}
            for _, id in sgs.qlist(card_ids) do
                local c = sgs.Sanguosha:getCard(id)
                if not table.contains(numbers, c:getNumberString()) then
                    table.insert(numbers, c:getNumberString())
                else
                    if not table.contains(duplicatenumbers, c:getNumberString()) then
                        table.insert(duplicatenumbers, c:getNumberString())
                    end
                end
            end
            if #duplicatenumbers > 0 then
                room:killPlayer(player)
            end
        end
    end
}

--[[
	技能名：地公
	相关武将：神张宝[战役]
	技能描述：出牌阶段，你可以用任意张手牌替换武将牌上的牌。
	引用：sfofl_degong
]] -- 
sfofl_degongCard = sgs.CreateSkillCard {
	name = "sfofl_degong",
	target_fixed = true,
	will_throw = false,
	on_use = function(self, room, source, targets)
		source:exchangeFreelyFromPrivatePile(self:objectName(), "sfofl_huangjin", 999, false)
	end
}
sfofl_degong = sgs.CreateViewAsSkill {
	name = "sfofl_degong",
	n = 0,
	view_as = function(self, cards)
		return sfofl_degongCard:clone()
	end,
	enabled_at_play = function(self, player)
		return not player:isKongcheng() and not player:getPile("sfofl_huangjin"):isEmpty()
	end
}


--[[
	技能名：掣电
	相关武将：神张宝[战役]
	技能描述：结束阶段，你可以对一名体力值不少于你的角色造成1点雷电伤害。
	引用：sfofl_chedian
]] -- 

sfofl_chedian = sgs.CreateTriggerSkill{
	name = "sfofl_chedian",
	frequency = sgs.Skill_NotFrequent,
	events = {sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish and player:hasSkill(self:objectName()) then
            local targets = sgs.SPlayerList()
            for _, p in sgs.qlist(room:getAllPlayers()) do
                if p:getHp() >= player:getHp() then
                    targets:append(p)
                end
            end
            if not targets:isEmpty() then
                local target = room:askForPlayerChosen(player, targets, self:objectName(), "sfofl_chedian-invoke", true, true)
                if target then
                    local damage = sgs.DamageStruct()
                    damage.from = player
                    damage.to = target
                    damage.nature = sgs.DamageStruct_Thunder
                    room:damage(damage)
                end
            end
        end
    end
}

--[[
	技能名：天公
	相关武将：神张角[战役]
	技能描述：你可以将武将牌上的牌如手牌般使用或打出。
	引用：sfofl_tiangong
]] -- 
sfofl_tiangong = sgs.CreateViewAsSkill {
	name = "sfofl_tiangong",
	n = 1,
    expand_pile = "sfofl_huangjin",
	view_filter = function(self, selected, to_select)
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE
        or sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
            local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
            if pattern == "peach+analeptic" and sgs.Self:hasFlag("Global_PreventPeach") then
                pattern = "analeptic"
            end
            local can = false
            for _,p in sgs.list(pattern:split("+"))do
                local dc = dummyCard(p)
                if dc then
                    can = to_select:sameNameWith(dc, false)
                    if can then
                        break
                    end
                end
            end
            return can and sgs.Self:getPile("sfofl_huangjin"):contains(to_select:getId()) 
        end
        return sgs.Self:getPile("sfofl_huangjin"):contains(to_select:getId()) and to_select:isAvailable(sgs.Self)
	end,
	view_as = function(self, cards)
        if #cards == 1 then
            return cards[1]
        end
	end,
	enabled_at_play = function(self, player)
		return not player:getPile("sfofl_huangjin"):isEmpty()
	end,
    enabled_at_response = function(self,player,pattern)
		for _,p in sgs.list(pattern:split("+"))do
			local dc = dummyCard(p)
			if dc then
                for _,id in sgs.list(player:getPile("sfofl_huangjin"))do
                    local card = sgs.Sanguosha:getCard(id)
                    if card:sameNameWith(dc, false) then
                        if not player:isLocked(dc)
                        then return true end
                    end
                end
			end
		end
		return false
	end,
}

sfofl_w_shenzhangliang:addSkill(sfofl_rengong)
sfofl_w_shenzhangliang:addSkill(sfofl_guiji)
sfofl_w_shenzhangliang:addSkill(sfofl_xueni)
sfofl_w_shenzhangbao:addSkill(sfofl_degong)
sfofl_w_shenzhangbao:addSkill("sfofl_guiji")
sfofl_w_shenzhangbao:addSkill(sfofl_chedian)
sfofl_w_shenzhangjiao:addSkill(sfofl_tiangong)
sfofl_w_shenzhangjiao:addSkill("tenyearleiji")
sfofl_w_shenzhangjiao:addSkill("guidao")
sfofl_w_shenzhangjiao:addSkill("tiaoxin")



sfofl_w_kongrong = sgs.General(extension_war, "sfofl_w_kongrong", "qun", 3)

--[[
	技能名：名士
	相关武将：孔融[战役]
	技能描述：锁定技，若你的装备区里没有防具牌，属性【杀】对你无效。
	引用：sfofl_mingshi
]] -- 
sfofl_mingshi = sgs.CreateTriggerSkill{
    name = "sfofl_mingshi",
    frequency = sgs.Skill_Compulsory,
    events = { sgs.TargetConfirming },
    on_trigger = function(self, event, player, data)
        local use = data:toCardUse()
        local room = player:getRoom()
        if use.card and use.card:isKindOf("NatureSlash") and use.to:contains(player)  then
           if player:getArmor() == nil then
                local list = use.nullified_list
                table.insert(list,player:objectName())
                use.nullified_list = list
                data:setValue(use)
                room:sendCompulsoryTriggerLog(player, self:objectName(), true)
           end
        end
        return false
    end
}
sfofl_w_kongrong:addSkill(sfofl_mingshi)
sfofl_w_kongrong:addSkill("lirang")

sfofl_w_mateng = sgs.General(extension_war, "sfofl_w_mateng", "qun", 4)

--[[
	技能名：伏波
	相关武将：马腾[战役]
	技能描述：出牌阶段开始时，你视为使用一张【以逸待劳】。
	引用：sfofl_fubo
]] -- 

sfofl_fubo = sgs.CreateTriggerSkill{
	name = "sfofl_fubo",
	frequency = sgs.Skill_NotFrequent,
	events = {sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Play then
			local card = sgs.Sanguosha:cloneCard("EXCard_YYDL", sgs.Card_NoSuit, 0)
			card:setSkillName(self:objectName())
			card:deleteLater()
			
			-- use.to:append(dest)
			local others = room:askForPlayersChosen(player, room:getAlivePlayers(), self:objectName(), 0, room:getAlivePlayers():length(), "@sfofl_fubo:"..card:objectName(), true, true)
			if others and others:length() > 0 then
				local use = sgs.CardUseStruct()
				use.from = player
				use.card = card
				use.to = others
				room:useCard(use, false)
			end
			
		end
		return false
	end
}

sfofl_w_mateng:addSkill("mashu")
sfofl_w_mateng:addSkill(sfofl_fubo)


sfofl_w_shenyuanshao = sgs.General(extension_war, "sfofl_w_shenyuanshao", "qun", 4)

--[[
	技能名：步战
	相关武将：袁绍[战役] 文丑[战役]
	技能描述：锁定技，你不能装备坐骑牌。你的攻击范围+X（X为你损失的体力值）。
	引用：sfofl_buzhan
]] -- 
sfofl_buzhan = sgs.CreateCardLimitSkill{
    name = "sfofl_buzhan",
    limit_list = function(self, player)
        if player:hasSkill(self:objectName()) then 
            return "use"
        else
            return ""
        end
    end,
    limit_pattern = function(self, player)
        if player:hasSkill(self:objectName()) then 
            return "Horse|.|.|."
        end
    end,
}
sfofl_buzhan_range = sgs.CreateAttackRangeSkill {
	name = "#sfofl_buzhan_range",
	extra_func = function(self, player)
		if player:hasSkill("sfofl_buzhan") then return player:getLostHp() end
	end,
}

--[[
	技能名：临阵
	相关武将：袁绍[战役]
	技能描述：出牌阶段，你可以失去1点体力，若如此做，你可以摸三张牌并将其交给任意名角色。
	引用：sfofl_linzhen
]] -- 
sfofl_n_linzhenCard = sgs.CreateSkillCard{
	name = "sfofl_n_linzhen",
	target_fixed = true,
	on_use = function(self, room, source, targets)
		room:loseHp(source, 1, true, source, self:objectName())
		if source:isAlive() then
            local card_ids = room:drawCardsList(source, 3, self:objectName(), true, false)
            source:assignmentCards(card_ids,self:objectName(),room:getAllPlayers(),-1,0,false)
		end
	end
}
sfofl_n_linzhen = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_n_linzhen",
	view_as = function()
		return sfofl_n_linzhenCard:clone()
	end
}


--[[
	技能名：弩箭
	相关武将：袁绍[战役]
	技能描述：出牌阶段，你可以弃置一张装备牌，将牌堆顶两张牌置于你的武将牌上称为箭。当一名角色需要使用或打出杀时，你可以弃置一张箭，视为该角色使用或打出一张杀。
	引用：sfofl_nujian
]] -- 


sfofl_nujianAttachCard = sgs.CreateSkillCard{
	name = "sfofl_nujianAttach",
	mute = true,
	filter = function(self, targets, to_select, from)
		if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE
		then return false end
		local card = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
        card:deleteLater()
        card:setSkillName("sfofl_nujian")
		
		local plist = sgs.PlayerList()
		for i = 1, #targets do plist:append(targets[i]) end
		return card and card:targetFilter(plist, to_select, from)
	end,
	feasible = function(self, targets,from)
		if sgs.Sanguosha:getCurrentCardUseReason() ~= sgs.CardUseStruct_CARD_USE_REASON_RESPONSE then
			local card = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
			card:deleteLater()
			card:setSkillName("sfofl_nujian")
			local plist = sgs.PlayerList()
			for i = 1, #targets do plist:append(targets[i]) end
			return card and card:targetsFeasible(plist, from)
		end
		return true
	end,
	on_validate = function(self, use) 
		use.m_isOwnerUse = false
		local room = use.from:getRoom()
		local targets = sgs.SPlayerList()
		for _,p in sgs.list(room:getAllPlayers())do
			if p:hasSkill("sfofl_nujian") and not p:getPile("sfofl_nujian_jian"):isEmpty()
			then targets:append(p) end
		end
        if not targets:isEmpty() then
            local target = room:askForPlayerChosen(use.from,targets,"sfofl_nujian")
            if room:askForSkillInvoke(target, "sfofl_nujian", ToData(use.from)) then
                local ids = target:getPile("sfofl_nujian_jian")
                room:fillAG(ids,target)
                local id = room:askForAG(target,ids,false,"sfofl_nujian", "@sfofl_nujian:"..use.from:objectName())
                room:clearAG(target)
                local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_REMOVE_FROM_PILE, nil, "sfofl_nujian", nil)
                local card = sgs.Sanguosha:getCard(id)
                room:throwCard(card, reason, nil)
                local dc = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                dc:setSkillName("_sfofl_nujian")
                dc:deleteLater()
                return dc
            end
        end
		room:setPlayerFlag(use.from,"Global_sfofl_nujian_Failed")
		return nil
	end,
	on_validate_in_response = function(self,from)
		local room = from:getRoom()
        local targets = sgs.SPlayerList()
		for _,p in sgs.list(room:getAllPlayers())do
			if p:hasSkill("sfofl_nujian") and not p:getPile("sfofl_nujian_jian"):isEmpty()
			then targets:append(p) end
		end
        if not targets:isEmpty() then
            local target = room:askForPlayerChosen(from,targets,"sfofl_nujian")
            if room:askForSkillInvoke(target, "sfofl_nujian", ToData(from)) then
                local ids = target:getPile("sfofl_nujian_jian")
                room:fillAG(ids,target)
                local id = room:askForAG(target,ids,false,"sfofl_nujian", "@sfofl_nujian:"..from:objectName())
                room:clearAG(target)
                local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_REMOVE_FROM_PILE, nil, "sfofl_nujian", nil)
                local card = sgs.Sanguosha:getCard(id)
                room:throwCard(card, reason, nil)
                local dc = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                dc:setSkillName("_sfofl_nujian")
                dc:deleteLater()
                return dc
            end
        end
		room:setPlayerFlag(from,"Global_sfofl_nujian_Failed")
		return nil
	end,
}

sfofl_nujianAttach = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_nujianAttach&",
	view_as = function(self) 
		local dc = sfofl_nujianAttachCard:clone()
		return dc
	end,
	enabled_at_play = function(self, player)
		if player:hasFlag("Global_sfofl_nujian_Failed") then return false end
		for _, p in sgs.qlist(player:getAliveSiblings(true)) do
			if p:hasSkill("sfofl_nujian") and not p:getPile("sfofl_nujian_jian"):isEmpty() then
                local dc = sgs.Sanguosha:cloneCard("slash")
                if dc then
                    dc:deleteLater()
                    if dc:isAvailable(player) then return true end
                end
			end
		end
	    return false
	end,
	enabled_at_response = function(self, player, pattern)
		if player:hasFlag("Global_sfofl_nujian_Failed") then return false end
		for _, p in sgs.qlist(player:getAliveSiblings(true)) do
			if p:hasSkill("sfofl_nujian") and not p:getPile("sfofl_nujian_jian"):isEmpty() then
                for _,p in sgs.list(pattern:split("+"))do
                    local dc = dummyCard(p)
                    if dc and dc:isKindOf("Slash") then
                        dc:deleteLater()
                        return true
                    end
                end
            end
		end
	    return false
	end,
}

sfofl_nujianCard = sgs.CreateSkillCard {
	name = "sfofl_nujian",
	target_fixed = true,
	will_throw = true,
	on_use = function(self, room, source, targets)
		source:addToPile("sfofl_nujian_jian", room:getNCards(2))
	end
}
sfofl_nujianVS = sgs.CreateViewAsSkill {
	name = "sfofl_nujian",
	n = 1,
	view_filter = function(self, selected, to_select)
		return to_select:isKindOf("EquipCard")
	end,
	view_as = function(self, cards)
		if #cards == 1 then
			local card = sfofl_nujianCard:clone()
            card:addSubcard(cards[1])
			return card
		end
	end,
	enabled_at_play = function(self, player)
		return not player:isKongcheng()
	end
}
sfofl_nujian = sgs.CreateTriggerSkill {
	name = "sfofl_nujian",
	view_as_skill = sfofl_nujianVS,
	events = { sgs.GameStart, sgs.EventAcquireSkill },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.GameStart or (event == sgs.EventAcquireSkill and data:toString() == "sfofl_nujian")) and player:hasSkill(self:objectName()) then
			for _, p in sgs.qlist(room:getAllPlayers()) do
				if not p:hasSkill("sfofl_nujianAttach") then
					room:attachSkillToPlayer(p, "sfofl_nujianAttach")
				end
			end
        end
    end
}
if not sgs.Sanguosha:getSkill("sfofl_nujianAttach&") then skills:append(sfofl_nujianAttach) end

sfofl_w_shenyuanshao:addSkill(sfofl_buzhan)
sfofl_w_shenyuanshao:addSkill(sfofl_buzhan_range)
extension_war:insertRelatedSkills("sfofl_buzhan", "#sfofl_buzhan_range")
sfofl_w_shenyuanshao:addSkill(sfofl_n_linzhen)
sfofl_w_shenyuanshao:addSkill(sfofl_nujian)

sfofl_w_wenchou = sgs.General(extension_war, "sfofl_w_wenchou", "qun", 5)

--[[
	技能名：血战
	相关武将：文丑[战役]
	技能描述：锁定技，当你装备一张装备牌时，将牌堆顶上的一张牌置于你的武将牌上，称为战；你的摸牌阶段摸牌数+X（X为战的数量）。你可以将战和装备牌当决斗使用。
	引用：sfofl_2_xuezhan
]] -- 

sfofl_2_xuezhanVS = sgs.CreateViewAsSkill{
    name = "sfofl_2_xuezhan",
    n = 1,
    expand_pile = "sfofl_2_xuezhan",
	view_filter = function(self, selected, to_select)
        return  sgs.Self:getPile("sfofl_2_xuezhan"):contains(to_select:getId()) or to_select:isKindOf("EquipCard")
	end,
    view_as = function(self, cards)
	    if #cards == 0 then return nil end
   		local slash = sgs.Sanguosha:cloneCard("duel", sgs.Card_SuitToBeDecided, 0)
   		slash:setSkillName(self:objectName())
	   	for _,c in ipairs(cards) do
            slash:addSubcard(c)
        end
	    return slash
   	end,
    enabled_at_play = function(self, player)
	    return true
    end,
}
sfofl_2_xuezhan = sgs.CreateTriggerSkill{
    name = "sfofl_2_xuezhan",
    events = {sgs.CardUsed, sgs.DrawNCards},
    view_as_skill = sfofl_2_xuezhanVS,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.CardUsed then
            local use = data:toCardUse()
            if use.card:isKindOf("EquipCard") then
                player:addToPile("sfofl_2_xuezhan", room:getNCards(1))
            end
        elseif event == sgs.DrawNCards then
            local draw = data:toDraw()
		    if draw.reason ~= "draw_phase" then return false end
            draw.num = draw.num + player:getPile("sfofl_2_xuezhan"):length()
            data:setValue(draw)
        end
    end
}

sfofl_w_wenchou:addSkill("sfofl_buzhan")
sfofl_w_wenchou:addSkill("sfofl_buzhan_range")
sfofl_w_wenchou:addSkill(sfofl_2_xuezhan)

sfofl_w_gongsunzan = sgs.General(extension_war, "sfofl_w_gongsunzan", "qun", 4)

--[[
	技能名：骑阵
	相关武将：公孙瓒[战役]
	技能描述：当你使用【杀】结算后，若此【杀】造成伤害，你摸2张牌；若此杀被抵消，你可以将此闪交给一名角色，若如此做，该角色可以对目标使用一张杀。
	引用：sfofl_2_qizhen
]] -- 

sfofl_2_qizhen = sgs.CreateTriggerSkill{
    name = "sfofl_2_qizhen",
    events = {sgs.CardFinished, sgs.CardOffset},
    frequency = sgs.Skill_Frequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.CardFinished then   
            local use = data:toCardUse()
            if use.card:isKindOf("Slash") and use.card:hasFlag("DamageDone") and room:askForSkillInvoke(player, self:objectName(), data) then
                player:drawCards(2, "sfofl_2_qizhen")
            end
        elseif event == sgs.CardOffset then
            local effect = data:toCardEffect()
            if effect.card and effect.card:isKindOf("Slash") then
                if effect.offset_card and effect.offset_card:isKindOf("Jink") and room:getCardPlace(effect.offset_card:getEffectiveId()) == sgs.Player_DiscardPile then
                    local target = room:askForPlayerChosen(player, room:getAllPlayers(), self:objectName(), "sfofl_2_qizhen-invoke", true, true)
                    if target then
                        room:obtainCard(target, effect.offset_card)
                        if effect.to and effect.to:isAlive() then
                            room:askForUseSlashTo(target, effect.to, "@sfofl_2_qizhen:"..effect.to:objectName(), false, true)
                        end
                    end
                end
            end
        end
    end,
}

sfofl_w_gongsunzan:addSkill(sfofl_2_qizhen)
sfofl_w_gongsunzan:addSkill("yicong")


sfofl_w_lijue = sgs.General(extension_war, "sfofl_w_lijue", "qun", 5)

--[[
	技能名：魔军
	相关武将：李傕[战役]
	技能描述：锁定技，当你使用【杀】对目标角色造成伤害后，其判定，若结果为黑色，你摸一张牌。
	引用：sfofl_mojun
]] -- 
sfofl_mojun = sgs.CreateTriggerSkill{
	name = "sfofl_mojun",
	events = {sgs.Damage},
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()
		if damage.card and damage.card:isKindOf("Slash") and damage.to:objectName() ~= player:objectName()
			and not damage.chain and not damage.transfer then
            local judge = sgs.JudgeStruct()
            judge.pattern = ".|black"
            judge.good = true
            judge.reason = self:objectName()
            judge.who = damage.to
            room:judge(judge)
            if judge:isGood() then
                player:drawCards(1, self:objectName())
            end
        end
    end
}


sfofl_w_lijue:addSkill("yangwu")
sfofl_w_lijue:addSkill(sfofl_mojun)


sfofl_w_dianwei = sgs.General(extension_war, "sfofl_w_dianwei", "wei", 5)

--[[
	技能名：死战
	相关武将：典韦[战役]
	技能描述：当你受到一次伤害后，你可以与伤害来源拼点：若你赢，你回复1点体力。
	引用：sfofl_sizhan
]] -- 
sfofl_sizhan = sgs.CreateTriggerSkill{
	name = "sfofl_sizhan",
	events = {sgs.Damaged},
	on_trigger = function(self,event,player,data,room)
		if event == sgs.Damaged then
            local damage = data:toDamage()
            if damage.to == player and damage.from and player:hasSkill(self) and player:canPindian(damage.from) and room:askForSkillInvoke(player, self:objectName(), ToData(damage.from)) then
                local success = player:pindian(damage.from, self:objectName(), nil)
                if success then
                    room:recover(player, sgs.RecoverStruct(self:objectName(), player, 1))
                end
            end
		end
		return false
	end
}


--[[
	技能名：护主
	相关武将：典韦[战役]
	技能描述：其他角色受到1点伤害后，你可以摸一张牌交给其一张牌。
	引用：sfofl_huzhu
]] -- 

sfofl_huzhu = sgs.CreateTriggerSkill {
	name = "sfofl_huzhu",
	frequency = sgs.Skill_NotFrequent,
	events = { sgs.Damaged },
	on_trigger = function(self, event, player, data)
		local damage = data:toDamage()
		local room = player:getRoom()
		local target = damage.to
		for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
            if p:objectName() == target:objectName() then continue end
            local x = damage.damage
            for i = 0, x - 1, 1 do
                if room:askForSkillInvoke(p, self:objectName(), ToData(damage.to)) then
                    p:drawCards(1, self:objectName())
                    local give = room:askForExchange(p, self:objectName(), 1, 1, true, "@sfofl_huzhu:" .. target:objectName(), false)
                    local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_GIVE, target:objectName(), p:objectName(), self:objectName(), nil)
                    reason.m_playerId = p:objectName()
                    room:moveCardTo(give, p, target, sgs.Player_PlaceHand, reason)
                else
                    break
                end
            end
		end
		return false
	end,
	can_trigger = function(self, target)
		return target and not target:hasSkill("sfofl_huzhu")
	end
}


sfofl_w_dianwei:addSkill(sfofl_sizhan)
sfofl_w_dianwei:addSkill(sfofl_huzhu)

sfofl_w_caoanmin = sgs.General(extension_war, "sfofl_w_caoanmin", "wei", 4)

--[[
	技能名：窥舍
	相关武将：曹安民[战役]
	技能描述：出牌阶段限一次，你选择一名其他角色的一张牌交给你选择的另一名角色，若如此做，失去牌的角色可以对你使用一张杀。
	引用：sfofl_kuishe
]] -- 

sfofl_kuisheCard = sgs.CreateSkillCard{
	name = "sfofl_kuishe",
	filter = function(self, targets, to_select, player)
		if to_select:objectName() == player:objectName() then return false end
		if #targets == 0 then
			return not to_select:isNude()
        end
	end,
	on_use = function(self, room, source, targets)
        local target = targets[1]
		if target:isKongcheng() then return false end
		local id = room:askForCardChosen(target, target, "he", "sfofl_kuishe")
		local cd = sgs.Sanguosha:getCard(id)
        local dest = room:askForPlayerChosen(source, room:getOtherPlayers(source), self:objectName())
        local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_GIVE, target:objectName(), dest:objectName(), "sfofl_kuishe","")
        room:moveCardTo(cd,dest,sgs.Player_PlaceHand,reason)
        room:askForUseSlashTo(target, source, "@sfofl_kuishe:"..source:objectName(), false, true)
		end
}
sfofl_kuishe = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_kuishe",
	view_as = function() 
		return sfofl_kuisheCard:clone()
	end, 
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_kuishe")
	end,
}

sfofl_w_caoanmin:addSkill(sfofl_kuishe)



sfofl_w_chunyuqiong = sgs.General(extension_war, "sfofl_w_chunyuqiong", "god", 4, true, hide_boss)
sfofl_w_zhanghe = sgs.General(extension_war, "sfofl_w_zhanghe", "god", 5, true, true)
sfofl_w_yuanshao = sgs.General(extension_war, "sfofl_w_yuanshao", "god", 6, true, true)

--[[
	技能名：乌巢
	相关武将：淳于琼[战役] 张郃[战役]
	技能描述：锁定技，当你死亡时，你所属区域里的牌与武将牌上的牌保留给下一名登场角色。
	引用：sfofl_wuchao
]] -- 
sfofl_wuchao = sgs.CreateTriggerSkill{
    name = "sfofl_wuchao", 
    events = {sgs.BeforeGameOverJudge}, 
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data, room)
        if event == sgs.BeforeGameOverJudge then
            local death = data:toDeath()
            if not player then return false end
            if player:objectName() ~= death.who:objectName() then return false end
            local general_list = { "sfofl_w_chunyuqiong", "sfofl_w_zhanghe", "sfofl_nw_chunyuqiong", "sfofl_nw_zhanghe" }
            local can_invoke = false
            for _,general in sgs.list(general_list)do
                if player:getGeneralName()==general or player:getGeneral2Name()==general then
                    can_invoke = true
                    break
                end
            end
            if can_invoke and player:hasSkill(self:objectName()) then
                player:setAlive(true)
                room:broadcastProperty(player, "alive")
                room:swapSeat(player, player)
                room:setPlayerFlag(player, "-Global_Dying")
                local currentdying = room:getTag("CurrentDying"):toStringList()
                table.removeOne(currentdying,player:objectName())
                room:setTag("CurrentDying", sgs.QVariant(table.concat(currentdying, "|")))
                -- room:recover(player, sgs.RecoverStruct(self:objectName(), player, player:getLostHp()))
                if player:getGeneralName()=="sfofl_w_chunyuqiong" then
                    room:changeHero(player,"sfofl_w_zhanghe",true,true)
                elseif player:getGeneral2Name()=="sfofl_w_chunyuqiong" then
                    room:changeHero(player,"sfofl_w_zhanghe",true,true, true)
                elseif player:getGeneralName()=="sfofl_w_zhanghe" then
                    room:changeHero(player,"sfofl_w_yuanshao",true,true)
                elseif player:getGeneral2Name()=="sfofl_w_zhanghe" then
                    room:changeHero(player,"sfofl_w_yuanshao",true,true, true)
                elseif player:getGeneralName()=="sfofl_nw_chunyuqiong" then
                    room:changeHero(player,"sfofl_nw_zhanghe",true,true)
                elseif player:getGeneral2Name()=="sfofl_nw_chunyuqiong" then
                    room:changeHero(player,"sfofl_nw_zhanghe",true,true, true)
                elseif player:getGeneralName()=="sfofl_nw_zhanghe" then
                    room:changeHero(player,"sfofl_nw_yuanshao",true,true)
                elseif player:getGeneral2Name()=="sfofl_nw_zhanghe" then
                    room:changeHero(player,"sfofl_nw_yuanshao",true,true, true)
                end
                return true
            end
        end
        return false
    end,
    can_trigger = function(self,target)
		return target
	end,
}

--[[
	技能名：仓储
	相关武将：淳于琼[战役]
	技能描述：出牌阶段开始时，你可以把牌堆顶两张牌正面向上置于你的武将牌上称为粮。若如此做，你视为使用一张酒。
	引用：sfofl_cangchu
]] -- 
sfofl_cangchu = sgs.CreateTriggerSkill{
    name = "sfofl_cangchu",
    events = {sgs.EventPhaseStart},
    frequency = sgs.Skill_Frequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Play and room:askForSkillInvoke(player, self:objectName()) then
            local splayers = sgs.SPlayerList()
            splayers:append(player)
            -- player:addToPile("sfofl_wuchaoliang", room:getNCards(2), false, splayers)
            player:addToPile("sfofl_wuchaoliang", room:getNCards(2))
            local analeptic = sgs.Sanguosha:cloneCard("analeptic", sgs.Card_NoSuit, 0)
            analeptic:setSkillName("sfofl_cangchu")
            local use = sgs.CardUseStruct()
            use.card = analeptic
            use.from = player
            use.to:append(player)
            room:useCard(use)
            analeptic:deleteLater()
        end
    end
}


--[[
	技能名：粮营
	相关武将：淳于琼[战役]
	技能描述：锁定技，你受到的火属性伤害+1。回合结束时，你摸两张牌。
	引用：sfofl_liangying
]] -- 
sfofl_liangying = sgs.CreateTriggerSkill{
    name = "sfofl_liangying", 
    events = {sgs.DamageInflicted, sgs.EventPhaseChanging}, 
    frequency = sgs.Skill_NotFrequent, 
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event==sgs.EventPhaseChanging and data:toPhaseChange().to==sgs.Player_NotActive then
            player:drawCards(2, self:objectName())
        else
            local damage = data:toDamage()
            if damage.nature == sgs.DamageStruct_Fire then
                player:damageRevises(data,1)
            end
        end
    end
}

--[[
	技能名：远略
	相关武将：张郃[战役]
	技能描述：出牌阶段限一次，若你的装备区里有牌且数量为全埸最多，你可以对一名角色造成1点伤害。
	引用：sfofl_yuanlue
]] -- 


sfofl_yuanlueCard = sgs.CreateSkillCard{
	name = "sfofl_yuanlue",
    filter = function(self, targets, to_select, player)
		return #targets == 0
	end,
	on_use = function(self, room, source, targets)
        local damage = sgs.DamageStruct()
        damage.from = source
        damage.to = targets[1]
        room:damage(damage)
    end
}
sfofl_yuanlue = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_yuanlue",
	view_as = function() 
		return sfofl_yuanlueCard:clone()
	end, 
	enabled_at_play = function(self, player)
        local x = 0
		for _,p in sgs.list(player:getAliveSiblings())do
			if p:getEquips():length() > x then
                x = p:getEquips():length()
            end
		end
		return player:getEquips():length() >= x and not player:hasUsed("#sfofl_yuanlue") and player:getEquips():length() > 0
	end,
}


--[[
	技能名：奔袭
	相关武将：张郃[战役]
	技能描述：每名角色限一次，一名角色的结束阶段，你可以将埸上一张牌置于你的武将牌上称为粮。
	引用：sfofl_benxi
]] -- 
sfofl_benxi = sgs.CreateTriggerSkill {
    name = "sfofl_benxi",
    frequency = sgs.Skill_Frequent,
    events = { sgs.EventPhaseStart },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if player:getPhase() ~= sgs.Player_Finish then return false end
        for _, p in sgs.list(room:findPlayersBySkillName(self:objectName())) do
            local targets = sgs.SPlayerList()
            for _, q in sgs.qlist(room:getAllPlayers()) do
				for _, card in sgs.qlist(q:getCards("ej")) do
                    targets:append(q)
                    break
                end
            end
            if not targets:isEmpty() and p:getMark("sfofl_benxi"..player:objectName()) == 0 then
                local target = room:askForPlayerChosen(p, targets, self:objectName(), "sfofl_benxi-invoke", true, true)
                if target then
                    room:addPlayerMark(p, "sfofl_benxi"..player:objectName())
                    local id = room:askForCardChosen(p,target,"ej",self:objectName(),false,sgs.Card_MethodNone)
                    local splayers = sgs.SPlayerList()
                    splayers:append(p)
                    -- p:addToPile("sfofl_wuchaoliang",  id, false, splayers)
                    p:addToPile("sfofl_wuchaoliang",  id)
                end
            end
        end
    end,
    can_trigger = function(self, target)
        return (target ~= nil)
    end,
}

--[[
	技能名：无断
	相关武将：袁绍[战役]
	技能描述：准备阶段，你可以弃置一张牌或粮获得急攻和渐营直到回合结束。
	引用：sfofl_wuduan
]] -- 
sfofl_wuduanCard = sgs.CreateSkillCard{
	name = "sfofl_wuduan",
	target_fixed = true,
    will_throw = true,
	on_use = function(self, room, source, targets)
        room:acquireOneTurnSkills(source, "sfofl_wuduan", "jianying|jigong")
    end
}

sfofl_wuduanVS = sgs.CreateViewAsSkill{
	name = "sfofl_wuduan",
	n = 1,
    expand_pile = "sfofl_wuchaoliang",
	view_filter = function(self, selected, to_select)
        return true
	end,
	view_as = function(self, cards)
		if #cards == 1 then
			local card = sfofl_wuduanCard:clone()
            card:addSubcard(cards[1])
			return card
		end
	end,
	enabled_at_play = function(self, player)
		return false
	end,
    enabled_at_response = function(self, player, pattern)
		return string.startsWith(pattern, "@@sfofl_wuduan")
	end
}

sfofl_wuduan = sgs.CreateTriggerSkill {
    name = "sfofl_wuduan",
    view_as_skill = sfofl_wuduanVS,
    events = { sgs.EventPhaseStart },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if player:getPhase() ~= sgs.Player_Start then return false end
        room:askForUseCard(player, "@@sfofl_wuduan","@sfofl_wuduan")
    end
}





--[[
	技能名：决战
	相关武将：袁绍[战役]
	技能描述：锁定技，你可以把武将牌上的粮当手牌般使用或打出。
	引用：sfofl_juezhan
]] -- 
sfofl_juezhan = sgs.CreateViewAsSkill {
	name = "sfofl_juezhan",
	n = 1,
    expand_pile = "sfofl_wuchaoliang",
	view_filter = function(self, selected, to_select)
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE
        or sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
            local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
            if pattern == "peach+analeptic" and sgs.Self:hasFlag("Global_PreventPeach") then
                pattern = "analeptic"
            end
            local can = false
            for _,p in sgs.list(pattern:split("+"))do
                local dc = dummyCard(p)
                if dc then
                    can = to_select:sameNameWith(dc, false)
                    if can then
                        break
                    end
                end
            end
            return can and sgs.Self:getPile("sfofl_wuchaoliang"):contains(to_select:getId()) 
        end
        return sgs.Self:getPile("sfofl_wuchaoliang"):contains(to_select:getId()) and to_select:isAvailable(sgs.Self)
	end,
	view_as = function(self, cards)
        if #cards == 1 then
            return cards[1]
        end
	end,
	enabled_at_play = function(self, player)
		return not player:getPile("sfofl_wuchaoliang"):isEmpty()
	end,
    enabled_at_response = function(self,player,pattern)
		for _,p in sgs.list(pattern:split("+"))do
			local dc = dummyCard(p)
			if dc then
                for _,id in sgs.list(player:getPile("sfofl_wuchaoliang"))do
                    local card = sgs.Sanguosha:getCard(id)
                    if card:sameNameWith(dc, false) then
                        if not player:isLocked(dc)
                        then return true end
                    end
                end
			end
		end
		return false
	end,
}

--[[
	技能名：少谋
	相关武将：袁绍[战役]
	技能描述：当你受到1点伤害时，若你有牌，你需要弃置一张粮，视为对伤害来源使用一张杀。
	引用：sfofl_shaomou
]] -- 
sfofl_shaomou = sgs.CreateTriggerSkill {
	name = "sfofl_shaomou",
	events = { sgs.DamageInflicted },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()
        local x = damage.damage
        if player:hasSkill(self:objectName()) then
            for i = 0, x - 1, 1 do
                if not player:isNude() and not player:getPile("sfofl_wuchaoliang"):isEmpty() then
                    local ids = player:getPile("sfofl_wuchaoliang")
                    room:fillAG(ids,player)
                    local id = room:askForAG(player,ids,false,self:objectName())
                    room:clearAG(player)
                    local reason = sgs.CardMoveReason(sgs.CardMoveReason_S_REASON_REMOVE_FROM_PILE, nil, "sfofl_shaomou", nil)
                    local card = sgs.Sanguosha:getCard(id)
                    room:throwCard(card, reason, nil)
                    if damage.from then
                        local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                        slash:setSkillName("sfofl_shaomou")
                        local use = sgs.CardUseStruct()
                        use.card = slash
                        use.from = player
                        use.to:append(damage.from)
                        room:useCard(use)
                        slash:deleteLater()
                    end
                end
            end
        end
		return false
	end
}




sfofl_w_chunyuqiong:addSkill(sfofl_wuchao)
sfofl_w_chunyuqiong:addSkill(sfofl_cangchu)
sfofl_w_chunyuqiong:addSkill(sfofl_liangying)
sfofl_w_zhanghe:addSkill("sfofl_wuchao")
sfofl_w_zhanghe:addSkill(sfofl_yuanlue)
sfofl_w_zhanghe:addSkill(sfofl_benxi)
sfofl_w_yuanshao:addSkill(sfofl_wuduan)
sfofl_w_yuanshao:addSkill(sfofl_juezhan)
sfofl_w_yuanshao:addSkill(sfofl_shaomou)



sfofl_w_zhangfei = sgs.General(extension_war, "sfofl_w_zhangfei", "qun", 4)

sfofl_w_zhangfei:addSkill("tenyearpaoxiao")

sfofl_w_liubei = sgs.General(extension_war, "sfofl_w_liubei", "qun", 4)

--[[
	技能名：仁德
	相关武将：刘备[战役]
	技能描述：出牌阶段，你可以将任意手牌交给其他角色，每回合你以此法给出第二张牌时，你可以视为使用一张基本牌。
	引用：sfofl_rende
]] -- 
sfofl_rende_basicCard = sgs.CreateSkillCard{
	name = "sfofl_rende_basic",
	will_throw = false,
	handling_method = sgs.Card_MethodNone,
	filter = function(self, targets, to_select)
		local card =  sgs.Sanguosha:cloneCard(sgs.Self:property("sfofl_rende"):toString(), sgs.Card_NoSuit, 0)
		card:deleteLater()
		card:setSkillName("_"..self:objectName())
		if card and card:targetFixed() then
			return false
		end
		local qtargets = sgs.PlayerList()
		for _, p in ipairs(targets) do
			qtargets:append(p)
		end
		return card and card:targetFilter(qtargets, to_select, sgs.Self) 
			and not sgs.Self:isProhibited(to_select, card, qtargets)
	end,
	feasible = function(self, targets)
		local card =  sgs.Sanguosha:cloneCard(sgs.Self:property("sfofl_rende"):toString(), sgs.Card_NoSuit, 0)
		card:deleteLater()
		card:setSkillName("_"..self:objectName())
		local qtargets = sgs.PlayerList()
		for _, p in ipairs(targets) do
			qtargets:append(p)
		end
		if card and card:canRecast() and #targets == 0 then
			return false
		end
		return card and card:targetsFeasible(qtargets, sgs.Self)
	end,	
	on_validate = function(self, card_use)
		local player = card_use.from
		local room = player:getRoom()
		-- local use_card = sgs.Sanguosha:cloneCard(self:getUserString())
		local name = player:property("sfofl_rende"):toString()
		local use_card = sgs.Sanguosha:cloneCard(name, sgs.Card_NoSuit, 0)
		use_card:setSkillName("_"..self:objectName())
		local available = true
		for _,p in sgs.qlist(card_use.to) do
			if player:isProhibited(p,use_card)	then
				available = false
				break
			end
		end
		available = available and use_card:isAvailable(player)
		if not available then return nil end
		return use_card		
	end,
}
sfofl_rendeCard = sgs.CreateSkillCard{
	name = "sfofl_rende",
	will_throw = false,
	handling_method = sgs.Card_MethodNone,
	filter = function(self, selected, to_select)
		return (#selected == 0) and (to_select:objectName() ~= sgs.Self:objectName())
	end,
	on_use = function(self, room, source, targets)
		room:obtainCard(targets[1], self, false)
		local old_value = source:getMark("sfofl_rende-Clear")
		local new_value = old_value + 1
		if old_value < 1 then
		    room:setPlayerMark(source, "sfofl_rende-Clear", new_value)
			local Set = function(list)
				local set = {}
				for _, l in ipairs(list) do set[l] = true end
				return set
			end
			local basic = {"slash", "peach"}
			if not (Set(sgs.Sanguosha:getBanPackages()))["maneuvering"] then
				table.insert(basic, 2, "thunder_slash")
				table.insert(basic, 2, "fire_slash")
				table.insert(basic, 2, "ice_slash")
				table.insert(basic, "analeptic")
			end
			table.insert(basic, "cancel")
			for _, patt in ipairs(basic) do
				local poi = sgs.Sanguosha:cloneCard(patt, sgs.Card_NoSuit, -1)
				if poi and (not poi:isAvailable(source)) or (patt == "peach" and not source:isWounded()) then
				    table.removeOne(basic, patt)
					--[[if patt == "slash" then
						table.removeOne(basic, "thunder_slash")
						table.removeOne(basic, "fire_slash")
					end]]
				end
			end
			local choice = room:askForChoice(source, self:objectName(), table.concat(basic, "+"))
			if choice ~= "cancel" then
				room:setPlayerProperty(source, "sfofl_rende", sgs.QVariant(choice))
				local usecard = room:askForUseCard(source, "@@sfofl_rende", "@sfofl_rende:"..choice)
				room:setPlayerProperty(source, "sfofl_rende", sgs.QVariant())
				if not usecard then
		            room:setPlayerMark(source, "sfofl_rende-Clear", 0)
				end
			else
				room:setPlayerMark(source, "sfofl_rende-Clear", 0)
			end
		end
	end,
}
sfofl_rende = sgs.CreateViewAsSkill{
	name = "sfofl_rende",
	n = 999,
	view_filter = function(self, selected, to_select)
		return not to_select:isEquipped()
	end,
	view_as = function(self, cards)
		if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
		    if #cards == 0 then return nil end
		    local rende_card = sfofl_rendeCard:clone()
		    for _, c in ipairs(cards) do
			    rende_card:addSubcard(c)
		    end
		    return rende_card
		end
		local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
		if string.find(pattern, "@@sfofl_rende") then 
		    if #cards ~= 0 then return nil end  
			local name = sgs.Self:property("sfofl_rende"):toString()
			local card = sgs.Sanguosha:cloneCard(name, sgs.Card_NoSuit, 0)
			card:setSkillName("_sfofl_rende_basic")
			return card
		end
		
	end,
	enabled_at_response = function(self, player, pattern)
		return string.find(pattern, "@@sfofl_rende")
	end,
	enabled_at_play = function(self, player)
		return not player:isKongcheng()
	end,
}

sfofl_w_liubei:addSkill(sfofl_rende)


sfofl_w_caocao = sgs.General(extension_war, "sfofl_w_caocao", "god", 6)

--[[
	技能名：连舟
	相关武将：曹操[战役]
	技能描述：其他角色使用黑色牌对你造成伤害时，除非该角色弃置一张红色牌，否则此伤害-1。
	引用：sfofl_lianzhou
]] -- 

sfofl_lianzhou = sgs.CreateTriggerSkill {
	name = "sfofl_lianzhou",
	events = { sgs.DamageInflicted },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()
		if not player:isKongcheng() and damage.from and damage.from:canDiscard(damage.from, "he") and damage.card and damage.card:isBlack() then
            local card = room:askForCard( damage.from, ".red", "@sfofl_lianzhou:"..player:objectName(), data, sgs.Card_MethodDiscard, player, false, "sfofl_lianzhou")
            if card then
            else
                player:damageRevises(data, -1)
            end
		end
		return false
	end
}

sfofl_w_caocao:addSkill(sfofl_lianzhou)
sfofl_w_caocao:addSkill("tenyearjianxiong")
sfofl_w_caocao:addSkill("yingzi")


sfofl_w_pochengguanyu = sgs.General(extension_war, "sfofl_w_pochengguanyu", "god", 5, true, hide_boss)

--[[
	技能名：破城
	相关武将：破城关羽[战役]
	技能描述：摸牌阶段，若你当前的体力值不大于3，你可以多摸一张牌，然后弃置两张牌，令一名其他角色选择一项：1.弃置一张装备牌，你回复1点体力；2.受到1点伤害，你弃置其一张手牌。
	引用：sfofl_pocheng
]] -- 

sfofl_pocheng = sgs.CreateTriggerSkill {
    name = "sfofl_pocheng",
    frequency = sgs.Skill_NotFrequent,
    events = { sgs.DrawNCards, sgs.AfterDrawNCards },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local draw = data:toDraw()
        if draw.reason ~= "draw_phase" then return false end
        if event == sgs.AfterDrawNCards then
            if player:hasFlag(self:objectName()) then
                room:setPlayerFlag(player, "-"..self:objectName())
                local card = room:askForDiscard(player, self:objectName(), 2, 2, true, true, "@sfofl_pocheng")
                if card then
                    local dest = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName())
                    if room:askForCard(dest, ".Equip", "@sfofl_pocheng_target:"..player:objectName(), ToData(player), sgs.Card_MethodDiscard, player, false, self:objectName()) then
                        room:recover(player, sgs.RecoverStruct(self:objectName(), player, 1))
                    else
                        local damage = sgs.DamageStruct()
                        damage.to = dest
                        room:damage(damage)
                        if player:canDiscard(dest, "h") then
                            local id = room:askForCardChosen(player,dest,"h",self:objectName(),false,sgs.Card_MethodDiscard)
                            room:throwCard(id,self:objectName(),dest,player)
                        end
                    end
                end
            end
        else
            if player:getHp() <= 3 and room:askForSkillInvoke(player, self:objectName(), data) then
                room:setPlayerFlag(player, self:objectName())
                draw.num = draw.num + 1
                data:setValue(draw)
            end
        end
    end
}

sfofl_w_pochengguanyu:addSkill("tenyearwusheng")
sfofl_w_pochengguanyu:addSkill("tenyearyijue")
sfofl_w_pochengguanyu:addSkill(sfofl_pocheng)

sfofl_w_jushoucaoren = sgs.General(extension_war, "sfofl_w_jushoucaoren", "god", 7, true, hide_boss)

--[[
	技能名：守樊
	相关武将：据守曹仁[战役]
	技能描述：回合结束时，你可以摸3张牌，并从中弃一张牌，若你弃置的是装备牌，你可以改为使用之。
	引用：sfofl_shoufan
]] -- 
sfofl_shoufanCard = sgs.CreateSkillCard{
	name = "sfofl_shoufan",
	target_fixed = true,
    will_throw = false,
	on_use = function(self, room, source, targets)
        local card = sgs.Sanguosha:getCard(self:getSubcards():first())
		if card:isKindOf("EquipCard") and not source:isCardLimited(card, sgs.Card_MethodUse) and room:askForSkillInvoke(source, "sfofl_shoufan_equip", ToData(card)) then
            room:useCard(sgs.CardUseStruct(card, source, source))
        else
            room:throwCard(card, source, source)
        end
	end
}
sfofl_shoufanVS = sgs.CreateOneCardViewAsSkill{
	name = "sfofl_shoufan",
	view_filter = function(self, card)
        return card:hasFlag("sfofl_shoufan")
    end,
    view_as = function(self, card)
        local cc = sfofl_shoufanCard:clone()
        cc:addSubcard(card:getEffectiveId())
        return cc
    end,
	enabled_at_play = function()
		return false
	end,
	enabled_at_response = function(self, player, pattern)
		return pattern == "@@sfofl_shoufan!"
	end
}
sfofl_shoufan = sgs.CreateTriggerSkill{
	name = "sfofl_shoufan",
    events = {sgs.EventPhaseChanging},
    view_as_skill = sfofl_shoufanVS,
	on_trigger = function(self, event, target, data)
		local room = target:getRoom()
        local change = data:toPhaseChange()
		if change.to == sgs.Player_NotActive and room:askForSkillInvoke(target, self:objectName()) then	
            local card_ids = target:drawCardsList(3, self:objectName(), true, false)
            if not target:isKongcheng() then
                local x = 0
                for _, id in sgs.qlist(card_ids) do
                    if room:getCardPlace(id) == sgs.Player_PlaceHand and room:getCardOwner(id) == target then
                        room:setCardFlag(id, self:objectName())
                        x = x + 1
                    end
                end
                if x > 0 then
                    room:askForUseCard(target, "@@sfofl_shoufan!", "@sfofl_shoufan")
                end
                for _, id in sgs.qlist(card_ids) do
                    room:setCardFlag(id, "-"..self:objectName())
                end
            end
				
		end
	end
}

--[[
	技能名：盾击
	相关武将：据守曹仁[战役]
	技能描述：每回合限一次，当你于回合内使用装备牌结算结束后，你可视为使用一张杀。
	引用：sfofl_dunji
]] -- 
sfofl_dunjiCard = sgs.CreateSkillCard{
	name = "sfofl_dunji",
	filter = function(self, targets, to_select)
		local targets_list = sgs.PlayerList()
		for _, target in ipairs(targets) do
			targets_list:append(target)
		end
		local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
		slash:setSkillName("_"..self:objectName())
		slash:deleteLater()
		return slash:targetFilter(targets_list, to_select, sgs.Self)
	end,
	on_use = function(self, room, source, targets)
		local targets_list = sgs.SPlayerList()
		for _, target in ipairs(targets) do
			if source:canSlash(target, nil, false) then
				targets_list:append(target)
			end
		end
		if not targets_list:isEmpty() then
            local slash = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
            slash:setSkillName("_"..self:objectName())
            room:useCard(sgs.CardUseStruct(slash, source, targets_list))
		end
	end
}
sfofl_dunjiVS = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_dunji",
	view_as = function()
		return sfofl_dunjiCard:clone()
	end,
	enabled_at_play = function()
		return false
	end,
	enabled_at_response = function(self, player, pattern)
		return pattern == "@@sfofl_dunji"
	end
}
sfofl_dunji = sgs.CreateTriggerSkill{
	name = "sfofl_dunji",
	view_as_skill = sfofl_dunjiVS,
	events = {sgs.CardFinished},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.CardFinished then
			if data:toCardUse().card:isKindOf("EquipCard") and player:getMark("sfofl_dunji-Clear") == 0 and player:getPhase() ~= sgs.Player_NotActive then
				if room:askForUseCard(player, "@@sfofl_dunji", "@sfofl_dunji") then
                    room:addPlayerMark(player, "sfofl_dunji-Clear")
                end
			end
		end
		return false
	end
}

--[[
	技能名：固城
	相关武将：据守曹仁[战役]
	技能描述：锁定技，你的手牌上张始终为4；若你的装备区里没有防具牌，你视为装备着仁王盾。
	引用：sfofl_gucheng
]] -- 
sfofl_gucheng_buff = sgs.CreateViewAsEquipSkill{
    name = "#sfofl_gucheng_buff",
	view_as_equip = function(self,target)
		if target:getArmor()==nil and target:hasSkill("sfofl_gucheng") then
	    	return "renwang_shield"
		end
	end 
}
sfofl_gucheng = sgs.CreateMaxCardsSkill {
	name = "sfofl_gucheng",
	fixed_func = function(self, target)
		if target:hasSkill("sfofl_gucheng") then
			return 4
		end
	end
}

sfofl_w_jushoucaoren:addSkill(sfofl_shoufan)
sfofl_w_jushoucaoren:addSkill(sfofl_dunji)
sfofl_w_jushoucaoren:addSkill(sfofl_gucheng)
sfofl_w_jushoucaoren:addSkill(sfofl_gucheng_buff)
extension_war:insertRelatedSkills("sfofl_gucheng", "#sfofl_gucheng_buff")


sfofl_w_shenmenghuo_7 = sgs.General(extension_war, "sfofl_w_shenmenghuo_7", "god", 7)
sfofl_w_shenmenghuo_6 = sgs.General(extension_war, "sfofl_w_shenmenghuo_6", "god", 6)
sfofl_w_shenmenghuo_5 = sgs.General(extension_war, "sfofl_w_shenmenghuo_5", "god", 5)
sfofl_w_shenmenghuo_4 = sgs.General(extension_war, "sfofl_w_shenmenghuo_4", "god", 4)
sfofl_w_shenmenghuo_3 = sgs.General(extension_war, "sfofl_w_shenmenghuo_3", "god", 3)
sfofl_w_shenmenghuo_2 = sgs.General(extension_war, "sfofl_w_shenmenghuo_2", "god", 2)
sfofl_w_shenmenghuo_1 = sgs.General(extension_war, "sfofl_w_shenmenghuo_1", "god", 1)


sfofl_w_shenmenghuo_7:addSkill("zaiqi")
sfofl_w_shenmenghuo_7:addSkill("huoshou")

sfofl_w_shenmenghuo_6:addSkill("zaiqi")
sfofl_w_shenmenghuo_6:addSkill("huoshou")

sfofl_w_shenmenghuo_5:addSkill("zaiqi")
sfofl_w_shenmenghuo_5:addSkill("huoshou")

sfofl_w_shenmenghuo_4:addSkill("zaiqi")
sfofl_w_shenmenghuo_4:addSkill("huoshou")
sfofl_w_shenmenghuo_3:addSkill("huoshou")
sfofl_w_shenmenghuo_2:addSkill("huoshou")
sfofl_w_shenmenghuo_1:addSkill("huoshou")


--[[
	技能名：复战
	相关武将：神孟获[战役]
	技能描述：锁定技，每局游戏限两次，当你进入濒死状态时，将你武将牌随机替换成一个未出埸的孟获并将手牌补至4张，弃置判定区内的牌，立刻进入你的回合。
	引用：sfofl_fuzhan
]] -- 
sfofl_fuzhan = sgs.CreateTriggerSkill{
    name = "sfofl_fuzhan", 
    events = {sgs.EnterDying}, 
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data, room)
        if event == sgs.EnterDying then
            local dying = data:toDying()
            if player:objectName() ~= dying.who:objectName() then return false end
            if player:hasSkill(self:objectName()) and player:getMark("sfofl_fuzhan") < 2 then
                local menghuo = { "sfofl_w_shenmenghuo_7", "sfofl_w_shenmenghuo_6", "sfofl_w_shenmenghuo_5", "sfofl_w_shenmenghuo_4", "sfofl_w_shenmenghuo_3", "sfofl_w_shenmenghuo_2", "sfofl_w_shenmenghuo_1" }
                local second = false
                if table.contains(menghuo, player:getGeneral2Name()) then
                    second = true
                end
                for _,p in sgs.qlist(room:getAlivePlayers()) do
                    if table.contains(menghuo, p:getGeneralName()) then
                        table.removeOne(menghuo, p:getGeneralName())
                    end
                    if table.contains(menghuo, p:getGeneral2Name()) then
                        table.removeOne(menghuo, p:getGeneral2Name())
                    end
                end
                for _, mark in sgs.list(player:getMarkNames()) do
                    if string.find(mark, "sfofl_fuzhan:") and table.contains(menghuo, mark:split(":")[2]) and player:getMark(mark) > 0 then
                        table.removeOne(menghuo, mark:split(":")[2])
                    end
                end
                if #menghuo > 0 then
                   
                    local skills_list = {}
                    for _,ske in sgs.qlist(player:getVisibleSkillList()) do
                        if string.find(ske:getDescription(), "继承技") then 
                            table.insert(skills_list, ske:objectName())
                        end
                    end
                    if second then
                        room:addPlayerMark(player, "sfofl_fuzhan:"..player:getGeneral2Name())
                    else
                        room:addPlayerMark(player, "sfofl_fuzhan:"..player:getGeneralName())
                    end
                    room:addPlayerMark(player, "sfofl_fuzhan")
                    room:changeHero(player,RandomList(menghuo)[1],true,true, second)
                    room:handleAcquireDetachSkills(player, table.concat(skills_list, "|"))
                    if player:getHandcardNum() < 4 then
                        player:drawCards(4-player:getHandcardNum(), self:objectName())
                    end
                    local ids = player:getJudgingAreaID()
                    room:throwCard(ids,self:objectName(),player,player)
                    local current = room:getCurrent()
                    if current and current:isAlive() and (room:getTag("Global_ExtraTurn".. current:objectName()):toBool()) then
                        room:throwEvent(sgs.TurnBroken)
                    end
                    local current = room:getCurrent()
                    if current and current:isAlive() then
                        current:changePhase(current:getPhase(), sgs.Player_NotActive)
                    end
                    local target = player:getNextAlive(room:alivePlayerCount() - 1)
                    if target then
                        room:setCurrent(target)
                    end
                    room:throwEvent(sgs.TurnBroken)
                end
                return true
            end
        end
        return false
    end
}

if not sgs.Sanguosha:getSkill("sfofl_fuzhan") then skills:append(sfofl_fuzhan) end
sfofl_w_shenmenghuo_7:addSkill("sfofl_fuzhan")
sfofl_w_shenmenghuo_6:addSkill("sfofl_fuzhan")
sfofl_w_shenmenghuo_5:addSkill("sfofl_fuzhan")
sfofl_w_shenmenghuo_4:addSkill("sfofl_fuzhan")
sfofl_w_shenmenghuo_3:addSkill("sfofl_fuzhan")
sfofl_w_shenmenghuo_2:addSkill("sfofl_fuzhan")
sfofl_w_shenmenghuo_1:addSkill("sfofl_fuzhan")

--[[
	技能名：截刀
	相关武将：神孟获[战役]
	技能描述：继承技，当你每回合第一次造成伤害时，你可令此伤害+1，然后若受到此伤害的角色没有死亡，你弃置一张牌。
	引用：sfofl_jiedao
]] -- 

sfofl_jiedao = sgs.CreateTriggerSkill{
	name = "sfofl_jiedao",
	events = {sgs.DamageCaused, sgs.DamageComplete},
	frequency = sgs.Skill_NotFrequent,
	on_trigger = function(self, event, player, data, room)
		local damage = data:toDamage()
		if event == sgs.DamageCaused then
			if damage.from and damage.from:objectName() == player:objectName() and player:hasSkill(self:objectName()) then
				room:addPlayerMark(player, "sfofl_jiedao_damage-Clear")
				if player:getMark("sfofl_jiedao_damage-Clear") == 1 and room:askForSkillInvoke(player, self:objectName(), data) then
					damage.damage = damage.damage + 1
                    data:setValue(damage)
                    local log = sgs.LogMessage()
                    log.type = "#skill_add_damage"
                    log.from = damage.from
                    log.to:append(damage.to)
                    log.arg  = self:objectName()
                    log.arg2 = damage.damage
                    room:sendLog(log)
					room:addPlayerMark(player, "sfofl_jiedao_invoke-Clear")
				end
			end
		elseif event == sgs.DamageComplete then
			if damage.from and damage.to and damage.to:isAlive() and damage.from:getMark("sfofl_jiedao_invoke-Clear") > 0 then
                room:setPlayerMark(player, "sfofl_jiedao_invoke-Clear", 0)
				room:askForDiscard(damage.from, self:objectName(), 1, 1, false, true)
			end
		end
		return false
	end,
    can_trigger = function(self, target)
		return target ~= nil
	end
}

--[[
	技能名：渠魁
	相关武将：神孟获[战役]
	技能描述：继承技，准备阶段，你可以失去1点体力弃置一名角色区域里的至多2张牌。
	引用：sfofl_qukui
]] -- 

sfofl_qukui = sgs.CreateTriggerSkill{
	name = "sfofl_qukui",
	frequency = sgs.Skill_Frequent,
	events = {sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Start then
            local targets = sgs.SPlayerList()
            for _, p in sgs.qlist(room:getAllPlayers()) do
                if player:canDiscard(p, "hej") then
                    targets:append(p)
                end
            end
            if not targets:isEmpty() then
                local target = room:askForPlayerChosen(player, targets, self:objectName(), "sfofl_qukui-invoke", true, true)
                if target then
                    room:loseHp(player, 1, true, player, self:objectName())
                    local remove = sgs.IntList()
                    for i = 1, 2 do--进行多次执行
                        local id = room:askForCardChosen(player, target, "hej", self:objectName(),
                            false,--选择卡牌时手牌不可见
                            sgs.Card_MethodDiscard,--设置为弃置类型
                            remove,--将子卡表设置为不可选卡牌id表（保证每张卡只能被选择一次）
                            i>1)--只有执行过一次选择才可取消
                        if id < 0 then break end--如果卡牌id无效就结束多次执行
                        remove:append(id)--将选择的id添加到虚拟卡的子卡表
                    end
                    room:throwCard(remove,self:objectName(),target,player)
                end
            end
        end
    end
}



--[[
	技能名：烈斧
	相关武将：神孟获[战役]
	技能描述：继承技，当你使用杀指定目标后，你可以与其拼点，若你赢，你获得其一张牌。
	引用：sfofl_liefu
]] -- 
sfofl_liefu = sgs.CreateTriggerSkill{
	name = "sfofl_liefu",
	frequency = sgs.Skill_NotFrequent,
	events = {sgs.TargetSpecified},
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
		local use = data:toCardUse()
		if event == sgs.TargetSpecified then
			if use.card:isKindOf("Slash") then
                for _, p in sgs.qlist(use.to) do
                    if player:canPindian(p)	and player:askForSkillInvoke(self,ToData(p)) then
                        if player:pindian(p,self:objectName()) then
                            if not p:isNude() then
                                local id = room:askForCardChosen(player, p, "he", "sfofl_liefu")
                                room:obtainCard(player, id, false)
                            end
                        end
                    end
                end
			end
		end
	end,
}


--[[
	技能名：并蛮
	相关武将：神孟获[战役]
	技能描述：继承技，出牌阶段限一次，你可以观看牌堆项三张牌，然后展示其中任意数量红色牌并获得之，其余以任意顺序置于牌堆顶。
	引用：sfofl_bingman
]] -- 

sfofl_bingmanCard = sgs.CreateSkillCard{
	name = "sfofl_bingman",
	target_fixed = true,
	on_use = function(self, room, source, targets)
        local card_ids = room:showDrawPile(source, 3, self:objectName(), false, true)
        local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
        dummy:deleteLater()
        local to_obtain = sgs.IntList()
        local disable = sgs.IntList()
        for _, id in sgs.qlist(card_ids) do
            local c = sgs.Sanguosha:getCard(id)
            if c:isRed() then
                to_obtain:append(id)
            else
                disable:append(id)
            end
        end
        while to_obtain:length()>0 do
            room:fillAG(card_ids,source, disable)
            local card_id = room:askForAG(source, to_obtain, true, self:objectName())
            if card_id <= 0 then break end
            dummy:addSubcard(card_id)
            card_ids:removeOne(card_id)
            to_obtain:removeOne(card_id)
            room:clearAG()
        end
        if dummy:subcardsLength() > 0 then
            source:obtainCard(dummy)
        end
        if card_ids:length() > 0 then
            room:returnToTopDrawPile(card_ids)
        end
	end
}
sfofl_bingman = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_bingman",
	view_as = function()
		return sfofl_bingmanCard:clone()
	end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_bingman")
    end
}


--[[
	技能名：南兵
	相关武将：神孟获[战役]
	技能描述：继承技，出牌阶段，你可以将所有手牌当做南蛮入侵使用。
	引用：sfofl_nanbing
]] -- 

sfofl_nanbing = sgs.CreateViewAsSkill {
	name = "sfofl_nanbing",
	n = 0,
	view_as = function(self, cards)
		local card = sgs.Sanguosha:cloneCard("SavageAssault", sgs.Card_SuitToBeDecided, 0)
		card:addSubcards(sgs.Self:getHandcards())
		card:setSkillName(self:objectName())
		return card
	end,
	enabled_at_play = function(self, player)
		return not player:isKongcheng()
	end,
}

--[[
	技能名：损寿
	相关武将：神孟获[战役]
	技能描述：继承技，你不会成为黑色牌的目标，你的黑色牌目标数+1。
	引用：sfofl_sunshou
]] -- 
sfofl_sunshou_prohibit = sgs.CreateProhibitSkill {
	name = "#sfofl_sunshou_prohibit",
	is_prohibited = function(self, from, to, card)
		if card:isBlack() and to and to:hasSkill("sfofl_sunshou") then
			return true
		end
		return false
	end
}
sfofl_sunshou = sgs.CreateTargetModSkill {
	name = "sfofl_sunshou",
	pattern = ".",
	extra_target_func = function(self,from,card)
		if from:hasSkill(self:objectName()) and card and card:isBlack() then return 1 end
		return 0
	end,
}

--[[
	技能名：再整
	相关武将：神孟获[战役]
	技能描述：继承技，出牌阶段限一次，你可以摸三张牌然后弃置埸上一张牌，若如此做，你本回合的手牌上限等于你此阶段造成的伤害值。
	引用：sfofl_zaizheng
]] -- 
sfofl_zaizhengCard = sgs.CreateSkillCard{
	name = "sfofl_zaizheng",
	target_fixed = true,
	on_use = function(self, room, source, targets)
            local card_ids = room:drawCardsList(source, 3, self:objectName(), true, false)
            local targets = sgs.SPlayerList()
            for _, p in sgs.qlist(room:getAllPlayers()) do
                if source:canDiscard(p, "ej") then
                    targets:append(p)
                end
            end
            if not targets:isEmpty() then
                local target = room:askForPlayerChosen(source, targets, self:objectName())
                if target then
                    local id = room:askForCardChosen(source,target,"ej",self:objectName(),false,sgs.Card_MethodDiscard)
                    room:throwCard(id,self:objectName(),target,source)
                    room:addPlayerMark(source, "&sfofl_zaizheng-Clear")
                    room:addPlayerMark(source, "sfofl_zaizheng-Clear")
                end
            end
	end
}
sfofl_zaizheng = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_zaizheng",
	view_as = function()
		return sfofl_zaizhengCard:clone()
	end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_zaizheng")
    end
}
sfofl_zaizheng_cardmax = sgs.CreateMaxCardsSkill {
	name = "#sfofl_zaizheng_cardmax",
	fixed_func = function(self, target)
		if target:hasSkill("sfofl_zaizheng") and target:getMark("sfofl_zaizheng-Clear") > 0 then
			return target:getMark("damage_point_play_phase")
		end
	end
}




sfofl_w_shenmenghuo_7:addSkill(sfofl_jiedao)
sfofl_w_shenmenghuo_6:addSkill(sfofl_qukui)
sfofl_w_shenmenghuo_5:addSkill(sfofl_liefu)
sfofl_w_shenmenghuo_4:addSkill(sfofl_bingman)
sfofl_w_shenmenghuo_3:addSkill(sfofl_nanbing)
sfofl_w_shenmenghuo_2:addSkill(sfofl_sunshou)
sfofl_w_shenmenghuo_2:addSkill(sfofl_sunshou_prohibit)
extension_war:insertRelatedSkills("sfofl_sunshou", "#sfofl_sunshou_prohibit")
sfofl_w_shenmenghuo_1:addSkill(sfofl_zaizheng)
sfofl_w_shenmenghuo_1:addSkill(sfofl_zaizheng_cardmax)
extension_war:insertRelatedSkills("sfofl_zaizheng", "#sfofl_zaizheng_cardmax")


sfofl_w_jinsimayi = sgs.General(extension_war, "sfofl_w_jinsimayi", "jin", 5)

sfofl_w_jinsimayi:addSkill("renjie")
sfofl_w_jinsimayi:addSkill("baiyin")


sfofl_w_jinsimazhao = sgs.General(extension_war, "sfofl_w_jinsimazhao", "jin", 5)

--[[
	技能名：弑敌
	相关武将：司马昭[战役]
	技能描述：回合开始阶段，你可以指定一名角色观看你的手牌并弃置其中一张，你对其造成1点伤害。
	引用：sfofl_shidi
]] -- 
sfofl_shidi = sgs.CreateTriggerSkill{
	name = "sfofl_shidi",
	frequency = sgs.Skill_Frequent,
	events = {sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Start then
            if not player:isKongcheng() then
                local target = room:askForPlayerChosen(player, room:getAllPlayers(), self:objectName(), "sfofl_shidi-invoke", true, true)
                if target then
                    if target:canDiscard(player, "h") then
                        local id = room:askForCardChosen(target,player,"h",self:objectName(),false,sgs.Card_MethodDiscard)
                        room:throwCard(id,self:objectName(),player,target)
                        local damage = sgs.DamageStruct()
                        damage.from = player
                        damage.to = target
                        room:damage(damage)
                    end
                end
            end
        end
    end
}

--[[
	技能名：昭心
	相关武将：司马昭[战役]
	技能描述：限定技，你可以展出你所有的手牌，所有其他角色选择交给你一张手牌或受到1点伤害。
	引用：sfofl_zhaoxin
]] -- 
sfofl_zhaoxinCard = sgs.CreateSkillCard{
	name = "sfofl_zhaoxin",
	target_fixed = true,
	on_use = function(self, room, source, targets)
        room:removePlayerMark(source, "@sfofl_zhaoxin")
        room:doSuperLightbox(source,self:objectName())
        room:showAllCards(source)
        for _, p in sgs.qlist(room:getOtherPlayers(source)) do
            if not p:isKongcheng() then
                local card = room:askForCard(p, ".|.|.|hand", "@sfofl_zhaoxin_target:" .. source:objectName(), ToData(source), sgs.Card_MethodNone)
                if card then
                    room:giveCard(p, source, card, self:objectName(), false)
                else
                    local damage = sgs.DamageStruct()
                    damage.to = p
                    room:damage(damage)
                end
            else
                local damage = sgs.DamageStruct()
                damage.to = p
                room:damage(damage)
            end
        end
	end
}
sfofl_zhaoxinVS = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_zhaoxin",
	view_as = function()
		return sfofl_zhaoxinCard:clone()
	end,
    enabled_at_play = function(self, player)
        return player:getMark("@sfofl_zhaoxin") > 0 and not player:isKongcheng()
    end
}
sfofl_zhaoxin = sgs.CreateTriggerSkill{
	name = "sfofl_zhaoxin",
	frequency = sgs.Skill_Limited,
	events = {},
    view_as_skill = sfofl_zhaoxinVS,
    limit_mark = "@sfofl_zhaoxin",
	on_trigger = function(self, event, player, data)
    end
}

sfofl_w_jinsimazhao:addSkill(sfofl_shidi)
sfofl_w_jinsimazhao:addSkill(sfofl_zhaoxin)


sfofl_nw_shenzhangliang = sgs.General(extension_war, "sfofl_nw_shenzhangliang", "god", 4, true, hide_boss)
sfofl_nw_shenzhangbao = sgs.General(extension_war, "sfofl_nw_shenzhangbao", "god", 4, true, true)
sfofl_nw_shenzhangjiao = sgs.General(extension_war, "sfofl_nw_shenzhangjiao", "god", 5, true, true)
    
--[[
	技能名：人公
	相关武将：神张梁[战役]
	技能描述：每名角色的结束阶段限一次，你可以将一张牌置于你的武将牌上然后摸两张牌。
	引用：sfofl_n_rengong
]] -- 
--血逆
--鬼继
sfofl_n_rengong = sgs.CreateTriggerSkill {
    name = "sfofl_n_rengong",
    events = { sgs.EventPhaseStart},
    frequency = sgs.Skill_Frequent,
    on_trigger = function(self, event, player, data, room)
        local room = player:getRoom()
        if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish then
            for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                if not p:isKongcheng() then
                    local card = room:askForExchange(p, self:objectName(), 1, 1, true, "@sfofl_n_rengong", true)
                    if card then
                        local card_ids = card:getSubcards()
                        p:addToPile("sfofl_huangjin", card_ids)
                        p:drawCards(2, self:objectName())
                    end
                end
            end
        end
    end,
    can_trigger = function(self, target)
        return target
    end
}      

--[[
	技能名：掣电
	相关武将：神张宝[战役]
	技能描述：其他角色的结束阶段，你可以对其造成一点雷电伤害。
	引用：sfofl_n_chedian
]] -- 
--地公
--鬼继 
sfofl_n_chedian = sgs.CreateTriggerSkill {
    name = "sfofl_n_chedian",
    events = { sgs.EventPhaseStart},
    frequency = sgs.Skill_Frequent,
    on_trigger = function(self, event, player, data, room)
        local room = player:getRoom()
        if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish then
            for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                if p:objectName() ~= player:objectName() and room:askForSkillInvoke(p, self:objectName(), ToData(player)) then
                    local damage = sgs.DamageStruct()
                    damage.from = p
                    damage.to = player
                    damage.nature = sgs.DamageStruct_Thunder
                    room:damage(damage)
                end
            end
        end
    end,
    can_trigger = function(self, target)
        return target
    end
}   

--[[
	技能名：天公
	相关武将：神张角[战役]
	技能描述：准备阶段你摸两张牌，你可以将武将牌上的牌如手牌般使用或打出。
	引用：sfofl_n_tiangong
]] --     
sfofl_n_tiangongVS = sgs.CreateViewAsSkill {
	name = "sfofl_n_tiangong",
	n = 1,
    expand_pile = "sfofl_huangjin",
	view_filter = function(self, selected, to_select)
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE
        or sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
            local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
            if pattern == "peach+analeptic" and sgs.Self:hasFlag("Global_PreventPeach") then
                pattern = "analeptic"
            end
            local can = false
            for _,p in sgs.list(pattern:split("+"))do
                local dc = dummyCard(p)
                if dc then
                    can = to_select:sameNameWith(dc, false)
                    if can then
                        break
                    end
                end
            end
            return can and sgs.Self:getPile("sfofl_huangjin"):contains(to_select:getId()) 
        end
        return sgs.Self:getPile("sfofl_huangjin"):contains(to_select:getId()) and to_select:isAvailable(sgs.Self)
	end,
	view_as = function(self, cards)
        if #cards == 1 then
            return cards[1]
        end
	end,
	enabled_at_play = function(self, player)
		return not player:getPile("sfofl_huangjin"):isEmpty()
	end,
    enabled_at_response = function(self,player,pattern)
		for _,p in sgs.list(pattern:split("+"))do
			local dc = dummyCard(p)
			if dc then
                for _,id in sgs.list(player:getPile("sfofl_huangjin"))do
                    local card = sgs.Sanguosha:getCard(id)
                    if card:sameNameWith(dc, false) then
                        if not player:isLocked(dc)
                        then return true end
                    end
                end
			end
		end
		return false
	end,
}
sfofl_n_tiangong = sgs.CreateTriggerSkill{
	name = "sfofl_n_tiangong",
	events = {sgs.EventPhaseStart},
    view_as_skill = sfofl_n_tiangongVS,
	on_trigger = function(self, event, player, data, room)
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Start then
            player:drawCards(2, self:objectName())
        end
    end
}


--[[
	技能名：雷鸣
	相关武将：神张角[战役]
	技能描述：你可以将【杀】当做雷【杀】使用。每当有角色受到1点雷电伤害时，你可以摸一张牌。
	引用：sfofl_n_leiming
]] --     

sfofl_n_leimingVS = sgs.CreateOneCardViewAsSkill{
	name = "sfofl_n_leiming" ,
	filter_pattern = "%slash" ,
	enabled_at_play = function(self, player)
		return sgs.Slash_IsAvailable(player)
	end ,
	enabled_at_response = function(self, player, pattern)
		return sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE and pattern == "slash"
	end ,
	view_as = function(self, card)
		local acard = sgs.Sanguosha:cloneCard("thunder_slash", card:getSuit(), card:getNumber())
		acard:addSubcard(card)
		acard:setSkillName(self:objectName())
		return acard
	end ,
}
sfofl_n_leiming = sgs.CreateTriggerSkill{
	name = "sfofl_n_leiming" ,
	events = {sgs.DamageInflicted} ,
	view_as_skill = sfofl_n_leimingVS ,
	can_trigger = function(self, target)
		return target
	end ,
	on_trigger = function(self, event, player, data, room)
		if event == sgs.DamageInflicted then
			local damage = data:toDamage()
			if damage.nature == sgs.DamageStruct_Thunder then
				for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if room:askForSkillInvoke(p, self:objectName()) then
                        p:drawCards(1, self:objectName())
                    end
                end
			end
		end
		return false
	end
}


--[[
	技能名：鬼神
	相关武将：神张角[战役]
	技能描述：当一名角色的判定牌生效前，你可以打出一张牌替换之。
	引用：sfofl_n_guishen
]] -- 
sfofl_n_guishen = sgs.CreateTriggerSkill{
	name = "sfofl_n_guishen" ,
	events = {sgs.AskForRetrial} ,
	can_trigger = function(self, target)
	if not (target and target:isAlive() and target:hasSkill(self:objectName())) then return false end
		return true
	end ,
		on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local judge = data:toJudge()
		local prompt_list = {
			"@sfofl_n_guishen-card" ,
			judge.who:objectName() ,
			self:objectName() ,
			judge.reason ,
			tostring(judge.card:getEffectiveId())
		}
		local prompt = table.concat(prompt_list, ":")
		local card = room:askForCard(player, ".", prompt, data, sgs.Card_MethodResponse, judge.who, true)
		if card then
			room:broadcastSkillInvoke(self:objectName(), math.random(1,2))
			room:retrial(card, player, judge, self:objectName(), true)
		end
		return false
	end
}



sfofl_nw_shenzhangliang:addSkill(sfofl_n_rengong)
sfofl_nw_shenzhangliang:addSkill("sfofl_xueni")
sfofl_nw_shenzhangliang:addSkill("sfofl_guiji")
sfofl_nw_shenzhangbao:addSkill("sfofl_degong")
sfofl_nw_shenzhangbao:addSkill("sfofl_guiji")
sfofl_nw_shenzhangbao:addSkill(sfofl_n_chedian)
sfofl_nw_shenzhangjiao:addSkill(sfofl_n_tiangong)
sfofl_nw_shenzhangjiao:addSkill("tenyearleiji")
sfofl_nw_shenzhangjiao:addSkill(sfofl_n_leiming)
sfofl_nw_shenzhangjiao:addSkill(sfofl_n_guishen)
sfofl_nw_shenzhangjiao:addSkill("tiaoxin")



sfofl_nw_shenyuanshao = sgs.General(extension_war, "sfofl_nw_shenyuanshao", "god", 4)
    
--[[
	技能名：乱箭
	相关武将：神袁绍[战役]
	技能描述：摸牌阶段，你可以额外摸两张牌，然后弃置X张牌（X为你装备区牌的数量。出牌阶段，你可以将两张手牌当万箭齐发使用（不能使用本回合发动此技能时已用过的花色）。
	引用：sfofl_n_luanjian
]] -- 
sfofl_n_luanjianVS = sgs.CreateViewAsSkill{
    name = "sfofl_n_luanjian",
    n = 2,
    view_filter = function(self, selected, to_select)
            return not (to_select:isEquipped() or string.find(sgs.Self:property(self:objectName()):toString(),to_select:getSuitString()))
    end,
    view_as = function(self, cards)
        if #cards ~= 2 then return nil end
        local card = sgs.Sanguosha:cloneCard("archery_attack",sgs.Card_SuitToBeDecided,-1)
        for _,c in pairs(cards) do
        card:addSubcard(c)
        end
        card:setSkillName(self:objectName())
            return card
    end,
    enabled_at_play=function(self,player)
        local x=0
        for _, card in sgs.qlist(player:getHandcards()) do
			if  string.find(player:property(self:objectName()):toString(),card:getSuitString()) then
				x = x + 1
			end	
	    end
		return player:getHandcardNum()>=2 and player:getHandcardNum()-x>1
    end,
}
sfofl_n_luanjian = sgs.CreateTriggerSkill{
    name = "sfofl_n_luanjian",
    view_as_skill=sfofl_n_luanjianVS,
    events ={sgs.PreCardUsed,sgs.EventPhaseEnd, sgs.DrawNCards, sgs.AfterDrawNCards},
    on_trigger=function(self,event,player,data,room)
		if event==sgs.PreCardUsed then
            local use=data:toCardUse()
            if use.card:getSkillName()==self:objectName() then
            local suits =player:property(self:objectName()):toString()==""and{}or player:property(self:objectName()):toString():split("+")
            for _,id in sgs.qlist(use.card:getSubcards()) do
                table.insert(suits,sgs.Sanguosha:getCard(id):getSuitString())
            end
            room:setPlayerProperty(player,self:objectName(),sgs.QVariant(table.concat(suits,"+")))
            end
            return false
        end
	    if event == sgs.EventPhaseEnd then
            if player:getPhase() == sgs.Player_Play then
                local room = player:getRoom()
                room:setPlayerProperty(player,self:objectName(),sgs.QVariant(nil))
            end
        end
        if event == sgs.AfterDrawNCards then
            local draw = data:toDraw()
            if draw.reason ~= "draw_phase" then return false end
            if player:getMark("sfofl_n_luanjian-Clear") > 0 then
                if player:canDiscard(player, "he") then
                    room:askForDiscard(player, self:objectName(), player:getEquips():length(), player:getEquips():length(), false, true)
                end
                room:setPlayerMark(player, "sfofl_n_luanjian-Clear", 0)
            end
        end
        if event == sgs.DrawNCards then
            local draw = data:toDraw()
            if draw.reason ~= "draw_phase" then return false end
            if room:askForSkillInvoke(player, self:objectName()) then
                room:addPlayerMark(player, "sfofl_n_luanjian-Clear")
                draw.num = draw.num + 2
                data:setValue(draw)
            end
        end
	end
}




--步战
--弩箭

sfofl_nw_shenyuanshao:addSkill("sfofl_buzhan")
sfofl_nw_shenyuanshao:addSkill("#sfofl_buzhan_range")
sfofl_nw_shenyuanshao:addSkill(sfofl_n_luanjian)
sfofl_nw_shenyuanshao:addSkill("sfofl_nujian")

  
sfofl_nw_wenchou = sgs.General(extension_war, "sfofl_nw_wenchou", "god", 5)

--[[
	技能名：血战
	相关武将：神文丑[战役]
	技能描述：摸牌阶段，你可以额外摸两张牌，然后弃置X张牌（X为你装备区牌的数量。你可以将装备牌当决斗使用。
	引用：sfofl_n_xuezhan
]] --


sfofl_n_xuezhanVS = sgs.CreateViewAsSkill{
    name = "sfofl_n_xuezhan",
    n = 1,
	view_filter = function(self, selected, to_select)
        return  to_select:isKindOf("EquipCard")
	end,
    view_as = function(self, cards)
	    if #cards == 0 then return nil end
   		local slash = sgs.Sanguosha:cloneCard("duel", sgs.Card_SuitToBeDecided, 0)
   		slash:setSkillName(self:objectName())
	   	for _,c in ipairs(cards) do
            slash:addSubcard(c)
        end
	    return slash
   	end,
    enabled_at_play = function(self, player)
	    return true
    end,
}    
sfofl_n_xuezhan = sgs.CreateTriggerSkill{
    name = "sfofl_n_xuezhan",
    view_as_skill=sfofl_n_xuezhanVS,
    events ={sgs.DrawNCards, sgs.AfterDrawNCards},
    on_trigger=function(self,event,player,data,room)
        if event == sgs.AfterDrawNCards then
            local draw = data:toDraw()
            if draw.reason ~= "draw_phase" then return false end
            if player:getMark("sfofl_n_xuezhan-Clear") > 0 then
                if player:canDiscard(player, "he") then
                    room:askForDiscard(player, self:objectName(), player:getEquips():length(), player:getEquips():length(), false, true)
                end
                room:setPlayerMark(player, "sfofl_n_xuezhan-Clear", 0)
            end
        end
        if event == sgs.DrawNCards then
            local draw = data:toDraw()
            if draw.reason ~= "draw_phase" then return false end
            if room:askForSkillInvoke(player, self:objectName()) then
                room:addPlayerMark(player, "sfofl_n_xuezhan-Clear")
                draw.num = draw.num + 2
                data:setValue(draw)
            end
        end
	end
}

--步战

sfofl_nw_wenchou:addSkill("sfofl_buzhan")
sfofl_nw_wenchou:addSkill("#sfofl_buzhan_range")
sfofl_nw_wenchou:addSkill(sfofl_n_xuezhan)


--[[
	技能名：玉玺
	技能描述：锁定技，摸牌阶段摸牌时，你额外摸一张牌；出牌阶段开始时，你观看一名其他角色的所有手牌。
    锁定技，当你死亡时，杀死你的角色获得你装备区的玉壐。
	引用：sfofl_n_jadeseal
]] --
sfofl_n_jadesealTr = sgs.CreateTriggerSkill {
	name = "sfofl_n_jadeseal",
	frequency = sgs.Skill_Compulsory,
	events = { sgs.DrawNCards, sgs.EventPhaseStart },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
        if event == sgs.DrawNCards then
            local draw = data:toDraw()
            if draw.reason ~= "draw_phase" then return false end
            room:sendCompulsoryTriggerLog(player, "sfofl_n_jadeseal", true)
            draw.num = draw.num + 1
            data:setValue(draw)
        elseif event == sgs.EventPhaseStart then
            if player:getPhase() == sgs.Player_Play then
                local target = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName())
                if not target:isKongcheng() then
                    room:showAllCards(target, player)
                end
            end
        end
	end,
    can_trigger = function(self,target)
		return target and target:hasTreasure("sfofl_n_jadeseal")
	end,
}
sfofl_n_jadeseal = sgs.CreateTreasure{
	name = "sfofl_n_jadeseal",
	class_name = "Jadeseal",
	equip_skill = sfofl_n_jadesealTr,
    suit = sgs.Card_Heart,
    number = 6,
	on_install = function(self,player)
		local room = player:getRoom()
		room:attachSkillToPlayer(player,"sfofl_n_jadeseal")
	end,
	on_uninstall = function(self,player)
		player:getRoom():detachSkillFromPlayer(player,"sfofl_n_jadeseal",true,true)
	end,
}
sfofl_n_jadeseal_dead = sgs.CreateTriggerSkill{
	name = "sfofl_n_jadeseal_dead",
	events = {sgs.Death},
	global = true,
	priority = -1,
	on_trigger = function(self, event, player, data, room)
		local death = data:toDeath()
        if death.who and death.who:hasTreasure("sfofl_n_jadeseal") then
            if death.damage and death.damage.from and death.damage.from:isAlive() then
                room:obtainCard(death.damage.from, death.who:getTreasure(), true)
            end
        end
		return false
	end
}
if not sgs.Sanguosha:getSkill("sfofl_n_jadeseal_dead") then skills:append(sfofl_n_jadeseal_dead) end


sfofl_n_jadeseal:setParent(extension_card)

sfofl_nw_jiaxu = sgs.General(extension_war, "sfofl_nw_jiaxu", "god", 3)

--[[
	技能名：避世
	相关武将：神贾诩[战役]
	技能描述：当你成为其他角色使用的杀的目标后，你可以令其摸一张牌令此杀无效。
	引用：sfofl_n_bishi
]] --
sfofl_n_bishi = sgs.CreateTriggerSkill{
	name = "sfofl_n_bishi",
	events = {sgs.TargetConfirmed},
    frequency = sgs.Skill_Frequent ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.TargetConfirmed) then
			local use = data:toCardUse()
			if use.card:isKindOf("Slash") and use.from~=player and use.to:contains(player) then
				if room:askForSkillInvoke(player, self:objectName(), data) then
                    use.from:drawCards(1, self:objectName())
                    local list = use.nullified_list
                    table.insert(list,player:objectName())
                    use.nullified_list = list
                    data:setValue(use)
                end
			end
		end
	end,
}


--[[
	技能名：谏兵
	相关武将：神贾诩[战役]
	技能描述：当一名其他角色受到杀的伤害时，你可以获得其一张牌，如果该牌是红桃，其回复1点体力。
	引用：sfofl_n_jianbing
]] --
sfofl_n_jianbing = sgs.CreateTriggerSkill{
	name = "sfofl_n_jianbing" ,
	events = {sgs.DamageInflicted} ,
	can_trigger = function(self, target)
		return target
	end ,
	on_trigger = function(self, event, player, data, room)
		if event == sgs.DamageInflicted then
			local damage = data:toDamage()
			if damage.card and damage.card:isKindOf("Slash") then
				for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if p:objectName() ~= player:objectName() and not player:isNude() and room:askForSkillInvoke(p, self:objectName(), data) then
                        local id = room:askForCardChosen(p, player, "he", "sfofl_n_jianbing")
                        room:obtainCard(p, id, true)
                        if sgs.Sanguosha:getCard(id):getSuit() == sgs.Card_Heart then
                            room:recover(player, sgs.RecoverStruct(self:objectName(), p, 1))
                        end
                    end
                end
			end
		end
		return false
	end
}


sfofl_nw_jiaxu:addSkill(sfofl_n_bishi)
sfofl_nw_jiaxu:addSkill(sfofl_n_jianbing)
sfofl_nw_jiaxu:addSkill("weimu")


sfofl_nw_fanchou = sgs.General(extension_war, "sfofl_nw_fanchou", "qun", 4)

--[[
	技能名：扬武
	相关武将：樊稠[战役]
	技能描述：出牌阶段限一次，你可以选择一名手牌比你多的角色，观看其所有手牌并获得其一张牌。
	引用：sfofl_n_yangwu
]] --


sfofl_n_yangwuCard = sgs.CreateSkillCard{
	name = "sfofl_n_yangwu",
    filter = function(self, targets, to_select, player)
		return #targets == 0 and to_select:getHandcardNum() > player:getHandcardNum()
	end,
	on_use = function(self, room, source, targets)
        if not targets[1]:isKongcheng() then
            local id = room:askForCardChosen(source, targets[1], "h", "sfofl_n_jianbing", true)
            room:obtainCard(source, id, true)
        end
    end
}
sfofl_n_yangwu = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_n_yangwu",
	view_as = function() 
		return sfofl_n_yangwuCard:clone()
	end, 
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_n_yangwu")
	end,
}

sfofl_nw_fanchou:addSkill(sfofl_n_yangwu)

sfofl_nw_wangyun = sgs.General(extension_war, "sfofl_nw_wangyun", "qun", 3)

--[[
	技能名：连计
	相关武将：王允[战役]
	技能描述：出牌阶段结束时，若你此阶段内使用过牌的类别数：达到1，你可以令一名角色摸一张牌；达到2，你可以回复1点体力；达到3，你可以令一名角色于此阶段结束后代替你执行你此回合所有剩余的阶段。
	引用：sfofl_n_lianji
]] --
sfofl_n_lianji = sgs.CreateTriggerSkill{
    name = "sfofl_n_lianji",
    events = {sgs.CardFinished, sgs.EventPhaseEnd},
    frequency = sgs.Skill_NotFrequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.CardFinished then
            local use = data:toCardUse() 
            if use.card:getTypeId()>0 then
                if player:getMark("sfofl_n_lianji"..use.card:getType().."-Clear")<1 then
                    MarkRevises(player,"&sfofl_n_lianji-Clear",use.card:getType())
                    player:addMark("sfofl_n_lianji"..use.card:getType().."-Clear")
                end
            end
        elseif event == sgs.EventPhaseEnd then
            if player:getPhase() == sgs.Player_Play then
                local n = 0
                for _,m in sgs.list(player:getMarkNames())do
                    if m:startsWith("sfofl_n_lianji") and player:getMark(m)>0 then
                        n = n + 1
                    end
                end
                if n >= 1 then
                    local target = room:askForPlayerChosen(player, room:getAllPlayers(), self:objectName(), "sfofl_n_lianji-invoke", true, true)
                    if target then
                        target:drawCards(1, self:objectName())
                    end
                    if n >= 2 then
                        if player:isWounded() and room:askForSkillInvoke(player, self:objectName()) then
                            room:recover(player, sgs.RecoverStruct(self:objectName(), player, 1))
                        end
                        if n >= 3 then
                            local target = room:askForPlayerChosen(player, room:getAllPlayers(), self:objectName().."phase", "sfofl_n_lianji_phase-invoke", true, true)
                            if target then
                                local phase = sgs.PhaseList()
                                if player:isSkipped(sgs.Player_Discard) then
                                    phase:append(sgs.Player_Discard)
                                end
                                if player:isSkipped(sgs.Player_Finish) then
                                    phase:append(sgs.Player_Finish)
                                end
                                if phase:isEmpty() then
                                    target:play(phase)
                                end
                            end
                        end
                    end
                end
            end
        end
    end,
}



--[[
	技能名：谋逞
	相关武将：王允[战役]
	技能描述：出牌阶段限一次，你可以将一张黑色牌当【借刀杀人】使用。
	引用：sfofl_n_moucheng
]] --

sfofl_n_mouchengVS = sgs.CreateOneCardViewAsSkill {
	name = "sfofl_n_moucheng",
	filter_pattern = ".|black",
	view_as = function(self, card)
		local acard = sgs.Sanguosha:cloneCard("collateral", card:getSuit(), card:getNumber())
		acard:addSubcard(card:getId())
		acard:setSkillName(self:objectName())
		return acard
	end,
	enabled_at_play = function(self, player)
		return player:getMark("sfofl_n_moucheng-PlayClear") == 0
	end,
}


sfofl_n_moucheng = sgs.CreateTriggerSkill {
	name = "sfofl_n_moucheng",
    view_as_skill = sfofl_n_mouchengVS,
	events = { sgs.CardFinished},
	on_trigger = function(self, event, player, data)
		local use = data:toCardUse()
		local room = player:getRoom()
		if event == sgs.CardFinished then
            if table.contains(use.card:getSkillNames(), "sfofl_n_moucheng") then
                room:addPlayerMark(player, "sfofl_n_moucheng-PlayClear")
            end
		end
	end
}

sfofl_nw_wangyun:addSkill(sfofl_n_lianji)
sfofl_nw_wangyun:addSkill(sfofl_n_moucheng)

sfofl_nw_dianwei = sgs.General(extension_war, "sfofl_nw_dianwei", "god", 5)

--[[
	技能名：迫视
	相关武将：典韦[战役]
	技能描述：锁定技，你计算与装备区里牌数大于你的角色互相距离为1，且不能响应对方使用的牌。
	引用：sfofl_n_poshi
]] --

sfofl_n_poshi = sgs.CreateTriggerSkill{
    name = "sfofl_n_poshi",
    events = {sgs.CardsMoveOneTime, sgs.EventAcquireSkill, sgs.EventLoseSkill, sgs.TargetConfirmed },
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.TargetConfirmed then
            local use = data:toCardUse()
            if use.from and (use.from:objectName() == player:objectName() or use.to:contains(player)) then
                if use.from:objectName() == player:objectName() then
                    local targets = sgs.SPlayerList()
                    local no_respond_list = use.no_respond_list
                    for _, p in sgs.qlist(use.to) do
                        if p:getEquips():length() > player:getEquips():length() then
                            targets:append(p)
                            table.insert(no_respond_list, p:objectName())
                        end
                    end
                    use.no_respond_list = no_respond_list
                    data:setValue(use)
                    if not targets:isEmpty() then
                        local log = sgs.LogMessage()
                        log.type = "$NoRespond"
                        log.from = use.from
                        log.to = targets
                        log.arg = self:objectName()
                        log.card_str = use.card:toString()
                        room:sendLog(log)
                    end
                else
                    if use.from:getEquips():length() > player:getEquips():length() then
                        local no_respond_list = use.no_respond_list
                        table.insert(no_respond_list, player:objectName())
                        use.no_respond_list = no_respond_list
                        data:setValue(use)
                        room:sendCompulsoryTriggerLog(player, "sfofl_n_poshi", true)
                    end
                end
            end
           
        elseif event == sgs.EventLoseSkill then
            if data:toString() == "sfofl_n_poshi" then
                for _,p in sgs.qlist(room:getOtherPlayers(player)) do
                    if p:getEquips():length() > player:getEquips():length() then
                        room:removeFixedDistance(player, p, 1)
                        room:removeFixedDistance(p, player, 1)
                    end
                end
            end
        elseif event == sgs.EventAcquireSkill then
            if data:toString() == "sfofl_n_poshi" then
                for _,p in sgs.qlist(room:getOtherPlayers(player)) do
                    if p:getEquips():length() > player:getEquips():length() then
                        room:setFixedDistance(player, p, 1)
                        room:setFixedDistance(p, player, 1)
                    end
                end
            end
        else
            local move = data:toMoveOneTime()
            local from
            local to
            if move.from then
                from = room:findPlayerByObjectName(move.from:objectName())
                if not from then return end
                for _,p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if from:getEquips():length() > p:getEquips():length() then
                        room:setFixedDistance(from, p, 1)
                        room:setFixedDistance(p, from, 1)
                    else
                        room:removeFixedDistance(from, p, 1)
                        room:removeFixedDistance(p, from, 1)
                    end
                end
            end
            if move.to then
                to = room:findPlayerByObjectName(move.to:objectName())
                for _,p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if to:getEquips():length() > p:getEquips():length() then
                        room:setFixedDistance(to, p, 1)
                        room:setFixedDistance(p, to, 1)
                    else
                        room:removeFixedDistance(to, p, 1)
                        room:removeFixedDistance(p, to, 1)
                    end
                end
            end
        end
    end,
}

--[[
	技能名：断戟
	相关武将：典韦[战役]
	技能描述：锁定技，你不能使用武器牌；出牌阶段限一次，你可以将一张装备牌当决斗使用。
	引用：sfofl_n_duanji
]] --
sfofl_n_duanjiVS = sgs.CreateViewAsSkill{
    name = "sfofl_n_duanji",
    n = 1,
	view_filter = function(self, selected, to_select)
        return  to_select:isKindOf("EquipCard")
	end,
    view_as = function(self, cards)
	    if #cards == 0 then return nil end
   		local slash = sgs.Sanguosha:cloneCard("duel", sgs.Card_SuitToBeDecided, 0)
   		slash:setSkillName(self:objectName())
	   	for _,c in ipairs(cards) do
            slash:addSubcard(c)
        end
	    return slash
   	end,
    enabled_at_play = function(self, player)
	    return player:getMark("sfofl_n_duanji-PlayClear") == 0
    end,
}    
sfofl_n_duanji = sgs.CreateTriggerSkill {
	name = "sfofl_n_duanji",
    view_as_skill = sfofl_n_duanjiVS,
	events = { sgs.CardFinished},
	on_trigger = function(self, event, player, data)
		local use = data:toCardUse()
		local room = player:getRoom()
		if event == sgs.CardFinished then
            if table.contains(use.card:getSkillNames(), "sfofl_n_duanji") then
                room:addPlayerMark(player, "sfofl_n_duanji-PlayClear")
            end
		end
	end
}
sfofl_n_duanji_limit = sgs.CreateCardLimitSkill{
    name = "#sfofl_n_duanji_limit",
    limit_list = function(self, player)
        if player:hasSkill("sfofl_n_duanji") then 
            return "use"
        else
            return ""
        end
    end,
    limit_pattern = function(self, player)
        if player:hasSkill("sfofl_n_duanji") then 
            return "Weapon|.|.|."
        end
    end,
}

--死战
--护主
sfofl_nw_dianwei:addSkill(sfofl_n_poshi)
sfofl_nw_dianwei:addSkill(sfofl_n_duanji)
sfofl_nw_dianwei:addSkill(sfofl_n_duanji_limit)
extension_war:insertRelatedSkills("sfofl_n_duanji", "#sfofl_n_duanji_limit")
sfofl_nw_dianwei:addSkill("sfofl_sizhan")
sfofl_nw_dianwei:addSkill("sfofl_huzhu")

sfofl_nw_shencaocao = sgs.General(extension_war, "sfofl_nw_shencaocao", "god", 4)

--[[
	技能名：护驾
	相关武将：曹操[战役]
	技能描述：主公技，当你需要使用或打出一张殺或【闪】时，你可以令其他魏势力角色打出一张相应的牌，视为你使用或打出之。
	引用：sfofl_n_hujia
]] --

sfofl_n_hujiaCard = sgs.CreateSkillCard {
	name = "sfofl_n_hujia",
	will_throw = false,
	filter = function(self, targets, to_select)
		local name = ""
		local card
		local plist = sgs.PlayerList()
		for i = 1, #targets do plist:append(targets[i]) end
		local aocaistring = self:getUserString()
		if aocaistring==""
		then aocaistring = "slash"
		end
		if aocaistring ~= "" then
			local uses = aocaistring:split("+")
			name = uses[1]
			card = sgs.Sanguosha:cloneCard(name)
		end
		return card and card:targetFilter(plist, to_select, sgs.Self) and
			not sgs.Self:isProhibited(to_select, card, plist)
	end,
	feasible = function(self, targets, from)
		local name = ""
		local card
		local plist = sgs.PlayerList()
		for i = 1, #targets do plist:append(targets[i]) end
		local aocaistring = self:getUserString()
		if aocaistring==""
			then aocaistring = "slash"
			end
		if aocaistring ~= "" then
			local uses = aocaistring:split("+")
			name = uses[1]
			card = sgs.Sanguosha:cloneCard(name)
		end
		return card and card:targetsFeasible(plist, from)
	end,
	on_validate_in_response = function(self, user)
		local room = user:getRoom()
		local aocaistring = self:getUserString()
		if aocaistring==""
			then aocaistring = "slash"
			end
		local prompt = string.format("@sfofl_n_hujia:%s", aocaistring)
		local dt = sgs.QVariant()
		dt:setValue(user)
		local card
		for _, p in sgs.qlist(room:getLieges("wei", user)) do
			card = room:askForCard(p, aocaistring, prompt, dt, sgs.Card_MethodResponse, p);
			if card then
				break
			end
		end
		if card then
			return card
		end
		room:setPlayerFlag(user, "Global_sfofl_n_hujiaFailed")
		return nil
	end,
	on_validate = function(self, cardUse)
		cardUse.m_isOwnerUse = false
		local user = cardUse.from
		local room = user:getRoom()
		local aocaistring = self:getUserString()
		if aocaistring==""
			then aocaistring = "slash"
			end
		local prompt = string.format("@sfofl_n_hujia:%s", aocaistring)
		local dt = sgs.QVariant()
		dt:setValue(user)
		local card
		for _, p in sgs.qlist(room:getLieges("wei", user)) do
			card = room:askForCard(p, aocaistring, prompt, dt, sgs.Card_MethodResponse,p);
			if card then
				break
			end
		end
		if card then
			return card
		end
		room:setPlayerFlag(user, "Global_sfofl_n_hujiaFailed")
		return nil
	end
}
sfofl_n_hujia = sgs.CreateZeroCardViewAsSkill {
	name = "sfofl_n_hujia$",
	enabled_at_play = function(self, player)
		if player:hasFlag("Global_sfofl_n_hujiaFailed") then return false end
		return sgs.Slash_IsAvailable(player)
	end,
	enabled_at_response = function(self, player, pattern)
		if player:hasFlag("Global_sfofl_n_hujiaFailed") then return end
		if pattern == "slash" or pattern == "jink" then
			return true
		end
		return false
	end,
	view_as = function(self)
		local acard = sfofl_n_hujiaCard:clone()
		local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
		acard:setUserString(pattern)
		return acard
	end
}

sfofl_nw_shencaocao:addSkill("tenyearjianxiong")
sfofl_nw_shencaocao:addSkill("feiying")
sfofl_nw_shencaocao:addSkill(sfofl_n_hujia)


sfofl_nw_shenlvbu = sgs.General(extension_war, "sfofl_nw_shenlvbu", "god", 5, true, hide_boss)

--[[
	技能名：神戟
	相关武将：神吕布[战役]
	技能描述：你使用的杀可以多指定一名角色为目标。
	引用：sfofl_n_shenji
]] --
sfofl_n_shenji = sgs.CreateTargetModSkill {
	name = "sfofl_n_shenji",
	pattern = "Slash",
	extra_target_func = function(self,from,card)
		if from:hasSkill(self:objectName()) then return 1 end
		return 0
	end,
}

--[[
	技能名：神威
	相关武将：神吕布[战役]
	技能描述：锁定技，你摸牌阶段改为摸X张牌（X为你的体力值）。
	引用：sfofl_n_shenwei
]] --
sfofl_n_shenwei = sgs.CreateDrawCardsSkill{
	name = "sfofl_n_shenwei",
	frequency = sgs.Skill_Compulsory,
	draw_num_func = function(self, player, n)
		return player:getHp()
	end,
}

sfofl_nw_shenlvbu:addSkill("mashu")
sfofl_nw_shenlvbu:addSkill("wushuang")
sfofl_nw_shenlvbu:addSkill(sfofl_n_shenji)
sfofl_nw_shenlvbu:addSkill(sfofl_n_shenwei)
sfofl_nw_shenlvbu:addSkill("xiuluo")


sfofl_nw_chunyuqiong = sgs.General(extension_war, "sfofl_nw_chunyuqiong", "god", 6, true, hide_boss)
sfofl_nw_zhanghe = sgs.General(extension_war, "sfofl_nw_zhanghe", "god", 5, true, true)
sfofl_nw_yuanshao = sgs.General(extension_war, "sfofl_nw_yuanshao", "god", 4, true, true)

--[[
	技能名：仓储
	相关武将：淳于琼[战役]
	技能描述：锁定技，你受到的火焰伤害+1；出牌阶段开始时，你视为使用一张【酒】。
	引用：sfofl_n_cangchu
]] --
sfofl_n_cangchu = sgs.CreateTriggerSkill{
    name = "sfofl_n_cangchu", 
    events = {sgs.DamageInflicted, sgs.EventPhaseStart}, 
    frequency = sgs.Skill_NotFrequent, 
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event==sgs.EventPhaseStart and player:getPhase() == sgs.Player_Play then
            local analeptic = sgs.Sanguosha:cloneCard("analeptic", sgs.Card_NoSuit, 0)
            analeptic:setSkillName("sfofl_n_cangchu")
            local use = sgs.CardUseStruct()
            use.card = analeptic
            use.from = player
            use.to:append(player)
            room:useCard(use)
            analeptic:deleteLater()
        else
            local damage = data:toDamage()
            if damage.nature == sgs.DamageStruct_Fire then
                player:damageRevises(data,1)
            end
        end
    end
}

--[[
	技能名：粮营
	相关武将：淳于琼[战役]
	技能描述：结束阶段，你可以摸三张牌，然后将一张牌置于你的武将牌上，成为“粮”。
	引用：sfofl_n_liangying
]] --
sfofl_n_liangying = sgs.CreateTriggerSkill{
    name = "sfofl_n_liangying", 
    events = {sgs.EventPhaseStart}, 
    frequency = sgs.Skill_Frequent, 
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event==sgs.EventPhaseStart and player:getPhase() == sgs.Player_Finish and room:askForSkillInvoke(player, self:objectName()) then
            player:drawCards(3, self:objectName())
            if not player:isKongcheng() then
                local card = room:askForExchange(player, self:objectName(), 1, 1, true, "@sfofl_n_liangying", true)
                if card then
                    local card_ids = card:getSubcards()
                    player:addToPile("sfofl_wuchaoliang", card_ids)
                end
            end
        end
    end
}

--乌巢


--[[
	技能名：远略
	相关武将：张郃[战役]
	技能描述：出牌阶段限一次，你可以失去1点体力并摸三张牌，然后将两张牌置于你的武将牌上，称为“粮”，若你装备区里的牌数为全场最多，你可以回复1点体力。
	引用：sfofl_n_yuanlue
]] --
sfofl_n_yuanlueCard = sgs.CreateSkillCard{
	name = "sfofl_n_yuanlue",
	target_fixed = true,
	on_use = function(self, room, source, targets)
		room:loseHp(source, 1, true, source, self:objectName())
		if source:isAlive() then
            source:drawCards(3, self:objectName())
            local card = room:askForExchange(source, self:objectName(), 2, 2, true, "@sfofl_n_yuanlue", true)
            if card then
                local card_ids = card:getSubcards()
                source:addToPile("sfofl_wuchaoliang", card_ids)
                local max = 0
                for _,p in sgs.qlist(room:getAllPlayers()) do
                    if p:getEquips():length() > max then
                        max = p:getEquips():length()
                    end
                end
                if source:getEquips():length() == max and room:askForSkillInvoke(source, self:objectName()) then
                    room:recover(source, sgs.RecoverStruct(self:objectName(), source, 1))
                end
            end
		end
	end
}
sfofl_n_yuanlue = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_n_yuanlue",
	view_as = function()
		return sfofl_n_yuanlueCard:clone()
	end,
    enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_n_yuanlue")
	end,
}


--[[
	技能名：袭营
	相关武将：张郃[战役]
	技能描述：一名角色的结束阶段，你可以弃置一名角色区域里的一张牌。
	引用：sfofl_n_xiying
]] --

sfofl_n_xiying = sgs.CreateTriggerSkill {
    name = "sfofl_n_xiying",
    frequency = sgs.Skill_Frequent,
    events = { sgs.EventPhaseStart },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if player:getPhase() ~= sgs.Player_Finish then return false end
        for _, p in sgs.list(room:findPlayersBySkillName(self:objectName())) do
            local targets = sgs.SPlayerList()
            for _, q in sgs.qlist(room:getAllPlayers()) do
				if p:canDiscard(q, "hej") then
                    targets:append(q)
                end
            end
            if not targets:isEmpty() then
                local target = room:askForPlayerChosen(p, targets, self:objectName(), "sfofl_n_xiying-invoke", true, true)
                if target then
                    local id = room:askForCardChosen(p,target,"hej",self:objectName(),false,sgs.Card_MethodDiscard)
                    room:throwCard(id,self:objectName(),target,p)
                end
            end
        end
    end,
    can_trigger = function(self, target)
        return (target ~= nil)
    end,
}
--乌巢

--[[
	技能名：无断
	相关武将：袁绍[战役]
	技能描述：准备阶段，你可以进行判定，若结果为：红色，你本回合获得“急攻”；黑色，你本回合获得“渐营”。
	引用：sfofl_n_wuduan
]] --
sfofl_n_wuduan = sgs.CreateTriggerSkill {
    name = "sfofl_n_wuduan",
    frequency = sgs.Skill_Frequent,
    events = { sgs.EventPhaseStart },
    waked_skills = "jigong,jianying",
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if player:getPhase() ~= sgs.Player_Start then return false end
        if room:askForSkillInvoke(player, self:objectName()) then
            local judge = sgs.JudgeStruct()
            judge.pattern = ".|"..card:getColorString()
            judge.reason = self:objectName()
            judge.who = player
            room:judge(judge)
            if judge.card:isRed() then
                room:acquireOneTurnSkills(player, "sfofl_n_wuduan", "jigong")
            elseif judge.card:isBlack() then
                room:acquireOneTurnSkills(player, "sfofl_n_wuduan", "jianying")
            end
        end
    end
}

--[[
	技能名：决战
	相关武将：袁绍[战役]
	技能描述：锁定技，你可以将武将牌上的“粮”当手牌使用、打出或弃置；你可以将两张“粮”当任意一张基本牌或普通锦囊牌使用（每种牌名每回合限一次）。
	引用：sfofl_n_juezhan
]] --

sfofl_n_juezhanVS = sgs.CreateViewAsSkill {
	name = "sfofl_n_juezhan",
	n = 1,
    expand_pile = "sfofl_wuchaoliang",
	view_filter = function(self, selected, to_select)
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE
        or sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
            local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
            if pattern == "peach+analeptic" and sgs.Self:hasFlag("Global_PreventPeach") then
                pattern = "analeptic"
            end
            local can = false
            for _,p in sgs.list(pattern:split("+"))do
                local dc = dummyCard(p)
                if dc then
                    can = to_select:sameNameWith(dc, false)
                    if can then
                        break
                    end
                end
            end
            return can and sgs.Self:getPile("sfofl_wuchaoliang"):contains(to_select:getId()) 
        end
        return sgs.Self:getPile("sfofl_wuchaoliang"):contains(to_select:getId()) and to_select:isAvailable(sgs.Self)
	end,
	view_as = function(self, cards)
        if #cards == 1 then
            return cards[1]
        end
	end,
	enabled_at_play = function(self, player)
		return not player:getPile("sfofl_wuchaoliang"):isEmpty()
	end,
    enabled_at_response = function(self,player,pattern)
		for _,p in sgs.list(pattern:split("+"))do
			local dc = dummyCard(p)
			if dc then
                for _,id in sgs.list(player:getPile("sfofl_wuchaoliang"))do
                    local card = sgs.Sanguosha:getCard(id)
                    if card:sameNameWith(dc, false) then
                        if not player:isLocked(dc)
                        then return true end
                    end
                end
			end
		end
		return false
	end,
}

sfofl_n_juezhanAttachCard = sgs.CreateSkillCard{
    name = "sfofl_n_juezhanAttach",
    will_throw = false,
    filter = function(self, targets, to_select, from)
        local pattern = self:getUserString()
		local dc = dummyCard(pattern:split("+")[1])
		if dc:targetFixed() then return false end
		dc:setSkillName("sfofl_n_juezhan")
        dc:addSubcards(self:getSubcards())
		local plist = sgs.PlayerList()
		for i = 1, #targets do plist:append(targets[i]) end
		return dc:targetFilter(plist,to_select,from)
	end,
    feasible = function(self,targets,from)
		local pattern = self:getUserString()
		local dc = dummyCard(pattern:split("+")[1])
        dc:setSkillName("sfofl_n_juezhan")
        dc:addSubcards(self:getSubcards())
        if dc and dc:canRecast() and #targets == 0 then
			return false
		end
		local plist = sgs.PlayerList()
		for i = 1, #targets do plist:append(targets[i]) end
		return dc:targetFixed() or dc:targetsFeasible(plist, from)
	end,
	on_validate = function(self, card_use)
		local player = card_use.from
        local room = player:getRoom()

        local pattern = self:getUserString()
        local card = sgs.Sanguosha:cloneCard(pattern, sgs.Card_NoSuit, 0)
		card:setSkillName("sfofl_n_juezhan")
        card:addSubcards(self:getSubcards())

        room:addPlayerMark(player,"sfofl_n_juezhanAttach_guhuo_remove_"..card:objectName().."-Clear")
        
		return card
	end,
    on_validate_in_response = function(self, player)
        local room = player:getRoom()

        local pattern = self:getUserString()
		if pattern == "normal_slash" then pattern = "slash" end
        if pattern == "Slash" then
            local all = {"slash","fire_slash","thunder_slash"} 
            pattern = room:askForChoice(player, "sfofl_n_juezhanAttach_Slash", table.concat(all, "+"))
        end
        if pattern == "Jink" then pattern = "jink" end
        if pattern == "peach+analeptic" then 
            local all = {"peach","analeptic"} 
            local items = {}
            for _,item in ipairs(all) do
                local mark = string.format("sfofl_n_juezhanAttach_guhuo_remove_%s-Clear", item)
                if player:getMark(mark) == 0 then
                    table.insert(items, item)
                end
            end
            pattern = room:askForChoice(player, "sfofl_n_juezhanAttach_saveself", table.concat(items, "+"))
        end

		local card = sgs.Sanguosha:cloneCard(pattern, sgs.Card_NoSuit, 0)
		card:setSkillName("sfofl_n_juezhan")
        card:addSubcards(self:getSubcards())
        room:addPlayerMark(player,"sfofl_n_juezhanAttach_guhuo_remove_"..card:objectName().."-Clear")
        return card
    end
}

sfofl_n_juezhanAttach = sgs.CreateViewAsSkill{
    name = "sfofl_n_juezhanAttach&",
    guhuo_type = "lr",
    n = 2,
    expand_pile = "sfofl_wuchaoliang",
    view_filter = function(self, selected, to_select)
        return sgs.Self:getPile("sfofl_wuchaoliang"):contains(to_select:getId()) 
	end,
    view_as = function(self, cards)
        if #cards == 2 then
            local cc = sfofl_n_juezhanAttachCard:clone()
            if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_PLAY then
                local c = sgs.Self:getTag("sfofl_n_juezhanAttach"):toCard()
                cc:setUserString(c:objectName())
                cc:addSubcard(cards[1])
		        cc:addSubcard(cards[2])
                return cc
            elseif sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
                local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
                if pattern == "slash" then pattern = "Slash" end
                cc:setUserString(pattern)
                cc:addSubcard(cards[1])
		        cc:addSubcard(cards[2])
                return cc
            end
        end
    end,
    enabled_at_play = function(self, player)
        local can = false
		for _,p in sgs.list(patterns())do
			local dc = dummyCard(p)
			if dc then
                if (dc:isKindOf("BasicCard") or dc:isNDTrick()) and player:getMark("sfofl_n_juezhanAttach_guhuo_remove_"..p.."-Clear") == 0  then
                    dc:setSkillName("sfofl_n_juezhanAttach")
                    if not player:isLocked(dc)
                    then can = true break end
                end
			end
		end
		if can==false then return false end
        return true
    end,
    enabled_at_response = function(self, player, pattern)
        if sgs.Sanguosha:getCurrentCardUseReason() ~= sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then return false end
        local can = false
		for _,p in sgs.list(pattern:split("+"))do
			local dc = dummyCard(p)
			if dc then
                if (dc:isKindOf("BasicCard") or dc:isNDTrick()) and player:getMark("sfofl_n_juezhanAttach_guhuo_remove_"..p.."-Clear") == 0  then
                    dc:setSkillName("sfofl_n_juezhan")
                    if not player:isLocked(dc)
                    then can = true break end
                end
			end
		end
		if can==false then return false end
        return true
    end
}
sfofl_n_juezhan = sgs.CreateTriggerSkill {
	name = "sfofl_n_juezhan",
	view_as_skill = sfofl_n_juezhanVS,
	events = { sgs.GameStart, sgs.EventAcquireSkill },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.GameStart or (event == sgs.EventAcquireSkill and data:toString() == "sfofl_n_juezhan")) and player:hasSkill(self:objectName()) then
			room:attachSkillToPlayer(player, "sfofl_n_juezhanAttach")
        end
    end
}

sfofl_nw_chunyuqiong:addSkill("sfofl_wuchao")
sfofl_nw_chunyuqiong:addSkill(sfofl_n_cangchu)
sfofl_nw_chunyuqiong:addSkill(sfofl_n_liangying)
sfofl_nw_zhanghe:addSkill("sfofl_wuchao")
sfofl_nw_zhanghe:addSkill(sfofl_n_yuanlue)
sfofl_nw_zhanghe:addSkill(sfofl_n_xiying)
sfofl_nw_yuanshao:addSkill(sfofl_n_wuduan)
sfofl_nw_yuanshao:addSkill(sfofl_n_juezhan)
if not sgs.Sanguosha:getSkill("sfofl_n_juezhanAttach&") then skills:append(sfofl_n_juezhanAttach) end



sfofl_nw_shenzhouyu = sgs.General(extension_war, "sfofl_nw_shenzhouyu", "god", 4)

--[[
	技能名：火神
	相关武将：神周瑜[战役]
	技能描述：锁定技，你不会受到火焰伤害。回合结束时，若你本回合造成过火焰伤害，你回复1点体力。
	引用：sfofl_n_huoshen
]] --

sfofl_n_huoshen = sgs.CreateTriggerSkill {
    name = "sfofl_n_huoshen",
    frequency = sgs.Skill_Compulsory,
    events = { sgs.DamageInflicted, sgs.Damage, sgs.EventPhaseChanging },
    on_trigger = function(self, event, player, data)
        local damage = data:toDamage()
        local room = player:getRoom()
        if event == sgs.DamageInflicted then
            if damage.nature == sgs.DamageStruct_Fire then
                if player:hasSkill(self:objectName()) then
                    damage.prevented = true
                    data:setValue(damage)
                    local log = sgs.LogMessage()
                    log.type  = "#SkillNullifyDamage"
                    log.from  = player
                    log.arg   = self:objectName()
                    log.arg2  = damage.damage
                    room:sendLog(log)
                    return true
                end
            end
        elseif event == sgs.Damage and damage.nature == sgs.DamageStruct_Fire then
            room:addPlayerMark(player, "sfofl_n_huoshen-Clear")
        elseif event==sgs.EventPhaseChanging and data:toPhaseChange().to==sgs.Player_NotActive then
            if player:getMark("sfofl_n_huoshen-Clear") > 0 then
                room:sendCompulsoryTriggerLog(player, "sfofl_n_huoshen", true)
                room:recover(player, sgs.RecoverStruct(self:objectName(), player, 1))
            end
        end
    end
}

--[[
	技能名：纵火
	相关武将：神周瑜[战役]
	技能描述：你可以将红色牌当火攻使用，你使用火攻结算完成后，若此牌未造成伤害，你可以弃置其一张牌。
	引用：sfofl_n_zonghuo
]] --
sfofl_n_zonghuoVS = sgs.CreateViewAsSkill {
	name = "sfofl_n_zonghuo",
    n = 1,
	view_filter = function(self, selected, to_select)
       	return to_select:isRed()
	end,
	view_as = function(self,cards)
        if #cards > 0 then
            local fire_attack = sgs.Sanguosha:cloneCard("fire_attack", sgs.Card_SuitToBeDecided, -1)
            for _,card in pairs(cards) do
                fire_attack:addSubcard(card)
            end
            fire_attack:setSkillName(self:objectName())
            return fire_attack
        end
	end,
	enabled_at_play = function(self, player)
		return true
	end,
}
sfofl_n_zonghuo = sgs.CreateTriggerSkill{
	name = "sfofl_n_zonghuo",
	view_as_skill = sfofl_n_zonghuoVS,
	events = {sgs.CardFinished},
	on_trigger = function(self, event, player, data, room)
        if event == sgs.CardFinished then
            local use = data:toCardUse()
            if use.card and table.contains(use.card:getSkillNames(), "sfofl_n_zonghuo")  then
                if not use.card:hasFlag("DamageDone") and player:hasSkill(self:objectName()) then
                    for _, p in sgs.qlist(use.to) do
                        if player:canDiscard(p, "he") and room:askForSkillInvoke(player, self:objectName(), ToData(p)) then
                            local id = room:askForCardChosen(player,p,"he",self:objectName(),false,sgs.Card_MethodDiscard)
                            room:throwCard(id,self:objectName(),p,player)
                        end
                    end
                end
            end
        end
		return false
	end,
}



--[[
	技能名：焚音
	相关武将：神周瑜[战役]
	技能描述：出牌阶段限一次，你可以弃置所有手牌，然后对所有其他角色造成1点火焰伤害。
	引用：sfofl_n_fenyin
]] --
sfofl_n_fenyinCard = sgs.CreateSkillCard{
	name = "sfofl_n_fenyin",
	target_fixed = true,
	on_use = function(self, room, source, targets)
        source:throwAllHandCards(self:objectName())
        for _, p in sgs.qlist(room:getOtherPlayers(source)) do
            local damage = sgs.DamageStruct()
            damage.from = source
            damage.to = p
            damage.nature = sgs.DamageStruct_Fire
            room:damage(damage)
        end
	end
}
sfofl_n_fenyin = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_n_fenyin",
	view_as = function()
		return sfofl_n_fenyinCard:clone()
	end,
    enabled_at_play = function(self, player)
        return not player:hasUsed("#sfofl_n_fenyin") and not player:isKongcheng()
    end
}


sfofl_nw_shenzhouyu:addSkill(sfofl_n_huoshen)
sfofl_nw_shenzhouyu:addSkill(sfofl_n_zonghuo)
sfofl_nw_shenzhouyu:addSkill(sfofl_n_fenyin)

sfofl_nw_shenzhugeliang = sgs.General(extension_war, "sfofl_nw_shenzhugeliang", "god", 4)

--[[
	技能名：风神
	相关武将：神诸葛亮[战役]
	技能描述：锁定技，你不会受到【杀】和【决斗】的伤害。
	引用：sfofl_n_fengshen
]] --
sfofl_n_fengshen = sgs.CreateTriggerSkill {
    name = "sfofl_n_fengshen",
    frequency = sgs.Skill_Compulsory,
    events = { sgs.DamageInflicted},
    on_trigger = function(self, event, player, data)
        local damage = data:toDamage()
        local room = player:getRoom()
        if event == sgs.DamageInflicted then
            if damage.card and (damage.card:isKindOf("Slash") or damage.card:isKindOf("Duel")) then
                if player:hasSkill(self:objectName()) then
                    damage.prevented = true
                    data:setValue(damage)
                    local log = sgs.LogMessage()
                    log.type  = "#SkillNullifyDamage"
                    log.from  = player
                    log.arg   = self:objectName()
                    log.arg2  = damage.damage
                    room:sendLog(log)
                    return true
                end
            end
        end
    end
}

--[[
	技能名：祭风
	相关武将：神诸葛亮[战役]
	技能描述：当一名角色造成火焰伤害时，你可以令其摸一张牌。
	引用：sfofl_n_jifeng
]] --
sfofl_n_jifeng = sgs.CreateTriggerSkill {
    name = "sfofl_n_jifeng",
    frequency = sgs.Skill_NotFrequent,
    events = { sgs.DamageCaused },
    on_trigger = function(self, event, player, data)
        local damage = data:toDamage()
        local room = player:getRoom()
        if event == sgs.DamageCaused then
            if damage.nature == sgs.DamageStruct_Fire and damage.from and damage.from:isAlive() then
                for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if room:askForSkillInvoke(p, self:objectName(), ToData(damage.from)) then
                        damage.from:drawCards(1, self:objectName())
                    end
                end
            end
        end
    end,
	can_trigger = function(self, target)
		return target ~= nil
	end
}


--[[
	技能名：智算
	相关武将：神诸葛亮[战役]
	技能描述：每回合限四次，你使用一张黑色牌结算完成后，你可以摸一张牌。
	引用：sfofl_n_zhisuan
]] --
sfofl_n_zhisuan = sgs.CreateTriggerSkill {
    name = "sfofl_n_zhisuan",
    events = { sgs.CardFinished },
    frequency = sgs.Skill_Frequent,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local use = data:toCardUse()
        if use.card:isBlack() and player:getMark("sfofl_n_zhisuan-Clear") < 4 then
            if room:askForSkillInvoke(player, self:objectName(), data) then
                room:addPlayerMark(player, "sfofl_n_zhisuan-Clear")
                room:addPlayerMark(player, "&sfofl_n_zhisuan-Clear")
                player:drawCards(1, self:objectName())
            end
        end
    end,
}


sfofl_nw_shenzhugeliang:addSkill(sfofl_n_fengshen)
sfofl_nw_shenzhugeliang:addSkill(sfofl_n_jifeng)
sfofl_nw_shenzhugeliang:addSkill(sfofl_n_zhisuan)

sfofl_nw_guojia = sgs.General(extension_war, "sfofl_nw_guojia", "wei", 3)

--[[
	技能名：统筹
	相关武将：郭嘉[战役]
	技能描述：出牌阶段限一次，你可以进行一次判定，若为红色：你回复1点体力；若为黑色：你本回合使用【杀】没有次数限制。然后你可以变更一次副将。
	引用：sfofl_n_tongchou
]] --
sfofl_n_tongchouCard = sgs.CreateSkillCard{
	name = "sfofl_n_tongchou",
	target_fixed = true,
	on_use = function(self, room, source, targets)
		local judge = sgs.JudgeStruct()
        judge.pattern = "."
        judge.reason = self:objectName()
        judge.who = source
        room:judge(judge)
        if judge.card:isRed() then
            room:recover(source, sgs.RecoverStruct(self:objectName(), source, 1))
        elseif judge.card:isBlack() then
            room:addPlayerMark(source, "&sfofl_n_tongchou-Clear")
            room:addSlashCishu(source, 999, true)
        end
        if room:askForSkillInvoke(source, self:objectName()) then
            ChangeGeneral(room, source, "sfofl_nw_guojia")
        end
	end
}
sfofl_n_tongchou = sgs.CreateZeroCardViewAsSkill{
	name = "sfofl_n_tongchou",
	view_as = function()
		return sfofl_n_tongchouCard:clone()
	end,
    enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_n_tongchou")
	end,
}

sfofl_nw_guojia:addSkill("tiandu")
sfofl_nw_guojia:addSkill("tenyearyiji")
sfofl_nw_guojia:addSkill(sfofl_n_tongchou)


sfofl_nw_shenmachao = sgs.General(extension_war, "sfofl_nw_shenmachao", "god", 0, true, true)

sfofl_n_weishui_gain = sgs.CreateTriggerSkill{
	name = "#sfofl_n_weishui_gain" ,
	events = {sgs.Damage},
	frequency = sgs.Skill_Compulsory,
	on_trigger = function(self,event,player,data,room)
		local Generals = player:property("weishuiGenerals"):toString():split("+")
		room:sendCompulsoryTriggerLog(player,"sfofl_n_weishui_rule")
		local aps = {}
		for _,p in sgs.list(room:getAlivePlayers())do
			table.insert(aps,p:getGeneralName())
			table.insert(aps,p:getGeneral2Name())
		end
		local splist = sgs.SPlayerList()
		splist:append(player)
		local tes = {}
        local damage = data:toDamage()
        local x = damage.damage
        for i = 0, x - 1, 1 do
            for _,name in sgs.list(RandomList(sgs.Sanguosha:getLimitedGeneralNames()))do
                if table.contains(Generals,name) or table.contains(aps,name) then continue end
                room:doAnimate(4,player:objectName(),"unknown",room:getOtherPlayers(player))
                room:doAnimate(4,player:objectName(),name,splist)
                table.insert(Generals,name)
                break
            end
            for _,name in sgs.list(Generals)do
                table.insert(tes,sgs.Sanguosha:translate(name))
            end
        end
		sgs.Sanguosha:addTranslationEntry(":&weishuiGenerals",table.concat(tes,"、"))
		room:setPlayerProperty(player,"weishuiGenerals",ToData(table.concat(Generals,"+")))
		room:setPlayerMark(player,"&weishuiGenerals",#Generals)
		return false
	end
}
sfofl_n_weishui_gain:setProperty("IgnoreInvalidity",ToData(true))


function weishuiSkills(player)
	local sk = {}
	for _,n in sgs.list(player:property("weishuiGenerals"):toString():split("+"))do
		for _,s in sgs.list(sgs.Sanguosha:getGeneral(n):getVisibleSkillList())do
			table.insert(sk,s)
		end
	end
	return sk
end

sfofl_n_weishui_ruleCard = sgs.CreateSkillCard{
	name = "sfofl_n_weishui_rule",
	target_fixed = true,
	about_to_use = function(self,room,use)
		local qipjsks = {}
		for _,s in sgs.list(weishuiSkills(use.from))do
			if s:inherits("FilterSkill") then continue end
			if s:inherits("ViewAsSkill") and sgs.Sanguosha:getViewAsSkill(s:objectName()):isEnabledAtPlay(use.from)
			then table.insert(qipjsks,s:objectName()) end
			if s:inherits("TriggerSkill") then
				local ts = sgs.Sanguosha:getTriggerSkill(s:objectName())
				ts = ts:getViewAsSkill()
				if ts and ts:isEnabledAtPlay(use.from)
				then table.insert(qipjsks,ts:objectName()) end
			end
		end
		local qipjsk = room:askForChoice(use.from,"sfofl_n_weishui_rule",table.concat(qipjsks,"+"))
		room:setPlayerMark(use.from,"sfofl_n_weishui_ruleSkill-PlayClear",1)
		room:setPlayerProperty(use.from,"sfofl_n_weishui_ruleSkill",sgs.QVariant(qipjsk))
		room:askForUseCard(use.from,"@@sfofl_n_weishui_rule","sfofl_n_weishui_rule0:"..qipjsk,-1,sgs.Card_MethodPlay)
	end
}
sfofl_n_weishui_ruleVS = sgs.CreateViewAsSkill{
	name = "sfofl_n_weishui_rule",
	n = 999,
	view_filter = function(self,selected,to_select)
		if sgs.Sanguosha:getCurrentCardUseReason()==sgs.CardUseStruct_CARD_USE_REASON_PLAY
		and sgs.Self:getMark("sfofl_n_weishui_ruleSkill-PlayClear")<1 then return end
		local cards = sgs.CardList()
		for _,c in sgs.list(selected)do
			cards:append(c)
		end
		local va = sgs.Sanguosha:getViewAsSkill(sgs.Self:property("sfofl_n_weishui_ruleSkill"):toString())
		return va and va:viewFilter(cards,to_select)
	end,
	view_as = function(self,selected)
		if sgs.Sanguosha:getCurrentCardUseReason()==sgs.CardUseStruct_CARD_USE_REASON_PLAY
		and sgs.Self:getMark("sfofl_n_weishui_ruleSkill-PlayClear")<1
		then return sfofl_n_weishui_ruleCard:clone()
		else
			local cards = sgs.CardList()
			for _,c in sgs.list(selected)do
				cards:append(c)
			end
			local va = sgs.Sanguosha:getViewAsSkill(sgs.Self:property("sfofl_n_weishui_ruleSkill"):toString())
			return va and va:viewAs(cards)
		end
	end,
	enabled_at_response = function(self,player,pattern)
	   	if pattern=="@@sfofl_n_weishui_rule" then return true end
		for _,s in sgs.list(weishuiSkills(player))do
			player:setProperty("sfofl_n_weishui_ruleSkill",sgs.QVariant(s:objectName()))
			if sgs.Self then sgs.Self:setProperty("sfofl_n_weishui_ruleSkill",sgs.QVariant(s:objectName())) end
			if s:inherits("ViewAsSkill") and sgs.Sanguosha:getViewAsSkill(s:objectName()):isEnabledAtResponse(player,pattern)
			then return true end
			if s:inherits("TriggerSkill") then
				s = sgs.Sanguosha:getTriggerSkill(s:objectName())
				s = s:getViewAsSkill()
				if s and s:isEnabledAtResponse(player,pattern)
				then return true end
			end
		end
	end,
	enabled_at_play = function(self,player)
		for _,s in sgs.list(weishuiSkills(player))do
			if s:inherits("FilterSkill") then continue end
			if s:inherits("ViewAsSkill") and sgs.Sanguosha:getViewAsSkill(s:objectName()):isEnabledAtPlay(player)
			then return true end
			if s:inherits("TriggerSkill") then
				s = sgs.Sanguosha:getTriggerSkill(s:objectName())
				s = s:getViewAsSkill()
				if s and s:isEnabledAtPlay(player)
				then return true end
			end
		end
		return false
	end,
}
local events = {}
for i=sgs.GameStart,sgs.EventForDiy do
	table.insert(events,i)
end
sfofl_n_weishui_rule = sgs.CreateTriggerSkill{
	name = "sfofl_n_weishui_rule",
	events = events,
	view_as_skill = sfofl_n_weishui_ruleVS,
	can_trigger = function(self,target)
		return target and target:isAlive()
	end,
	on_trigger = function(self,event,player,data,room)
		if player:hasSkill(self) then
			if event==sgs.ChoiceMade then
				local cm = data:toString()
				if cm:startsWith("notifyInvoked:") then
					cm = cm:split(":")
					for _,s in sgs.list(weishuiSkills(player))do
						if s:objectName()==cm[2] then
							player:addMark("sfofl_n_weishui_ruleUse"..cm[2])
							break
						end
					end
				end
			elseif event==sgs.CardFinished then
				room:setPlayerMark(player,"sfofl_n_weishui_ruleSkill-PlayClear",0)
				local use = data:toCardUse()
				if use.card:getSkillName()~="" then
					for _,s in sgs.list(weishuiSkills(player))do
						if table.contains(use.card:getSkillNames(),s:objectName()) then
							room:broadcastSkillInvoke(self:objectName())
							local yg = player:property("weishuiGenerals"):toString()
							yg = yg:split("+")
                            local remove
                            yg = yg:split("+")
                            for _,name in sgs.list(yg)do
                                if sgs.Sanguosha:getGeneral(name):hasSkill(ts:objectName())	then
                                    table.removeOne(yg,name)
                                    remove = name
                                    break
                                end
                            end
							local log = sgs.LogMessage()
							log.type = "$weishuiremoveOne"
							log.from = player
							log.arg = remove
							room:sendLog(log)
                            local tes = {}
							for _,name in sgs.list(yg)do
								table.insert(tes,sgs.Sanguosha:translate(name))
							end
							sgs.Sanguosha:addTranslationEntry(":&weishuiGenerals",table.concat(tes,"、"))
							room:setPlayerMark(player,"&weishuiGenerals",#yg)
							room:setPlayerProperty(player,"weishuiGenerals",ToData(table.concat(yg,"+")))
                            local data = sgs.QVariant("sfofl_n_weishui_rule:"..player:objectName()..":".. remove)
		                    room:getThread():trigger(sgs.EventForDiy,room,player,data)
							break
						end
					end
				end
			end
		end
		for _,owner in sgs.list(room:findPlayersBySkillName(self:objectName()))do
			for _,s in sgs.list(weishuiSkills(owner))do
				local ts = sgs.Sanguosha:getTriggerSkill(s:objectName())
				if ts and ts:hasEvent(event) then
					-- owner:acquireSkill(ts:objectName())
                    room:setPlayerProperty(player, "pingjian_triggerskill", sgs.QVariant(ts:objectName()))
					if ts:triggerable(player) then ts:trigger(event,room,player,data) end
                    room:setPlayerProperty(player, "pingjian_triggerskill", sgs.QVariant(""))
					-- owner:detachSkill(ts:objectName())
					if owner:getMark("sfofl_n_weishui_ruleUse"..ts:objectName())>0 then
						owner:setMark("sfofl_n_weishui_ruleUse"..ts:objectName(),0)
						room:broadcastSkillInvoke(self:objectName())
						local yg = owner:property("weishuiGenerals"):toString()
                        local remove
						yg = yg:split("+")
                        for _,name in sgs.list(yg)do
                            if sgs.Sanguosha:getGeneral(name):hasSkill(ts:objectName())	then
						        table.removeOne(yg,name)
                                remove = name
                                break
                            end
                        end
						local log = sgs.LogMessage()
						log.type = "$weishuiremoveOne"
						log.from = owner
						log.arg = remove
						room:sendLog(log)
                        local tes = {}
						for _,name in sgs.list(yg)do
							table.insert(tes,sgs.Sanguosha:translate(name))
						end
                        sgs.Sanguosha:addTranslationEntry(":&weishuiGenerals",table.concat(tes,"、"))
						room:setPlayerMark(owner,"&weishuiGenerals",#yg)
						room:setPlayerProperty(owner,"weishuiGenerals",ToData(table.concat(yg,"+")))
                        local data = sgs.QVariant("sfofl_n_weishui_rule:"..owner:objectName()..":".. remove)
		                room:getThread():trigger(sgs.EventForDiy,room,player,data)
					end
				end
			end
		end
		return false
	end
}

sfofl_n_weishui_rule:setProperty("IgnoreInvalidity",ToData(true))


sfofl_n_weishui_rule_cardmax = sgs.CreateMaxCardsSkill {
	name = "#sfofl_n_weishui_rule_cardmax",
	fixed_func = function(self, target)
		if target:hasSkill("sfofl_n_weishui_rule") then
			return 999
		end
	end
}

sfofl_n_weishui_rule_hp = sgs.CreateTriggerSkill{
	name = "#sfofl_n_weishui_rule_hp",
	frequency = sgs.Skill_Frequent,
	events = {sgs.HpChanged},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.HpChanged) then
			room:setTag("SkipGameRule", sgs.QVariant(tonumber(event)))
        end
    end
}

--[[
	技能名：士气
	相关武将：神马超[战役]
	技能描述：锁定技，当你使用士气上的蜀势力武将技能结算完成后，你摸两张牌。
	引用：sfofl_n_shiqi
]] --
sfofl_n_shiqi = sgs.CreateTriggerSkill{
	name = "sfofl_n_shiqi",
	frequency = sgs.Skill_Frequent,
	events = {sgs.EventForDiy},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.EventForDiy) then
			local ys = data:toString()
			if ys:startsWith("sfofl_n_weishui_rule:") then
                local sts = ys:split(":")
                if table.contains(sgs.Sanguosha:getGeneral(sts[3]):getKingdoms(),"shu") then
                    player:drawCards(2, self:objectName())
                end
            end
        end
    end
}

--[[
	技能名：冲杀
	相关武将：神马超[战役]
	技能描述：当你使用【杀】指定目标时，你可以获得其一张牌，若其使用【闪】抵消此【杀】，其可以弃置你一张牌。
	引用：sfofl_n_chongsha
]] --
sfofl_n_chongsha = sgs.CreateTriggerSkill{
    name = "sfofl_n_chongsha",
    events = {sgs.TargetSpecified, sgs.CardOffset},
    on_trigger = function(self,event,player,data)
        local room = player:getRoom()
        if event == sgs.TargetSpecified then
            local use = data:toCardUse()
            if not use.card:isKindOf("Slash") then return false end
            for _, p in sgs.qlist(use.to) do
                if not p:isNude() and room:askForSkillInvoke(player,self:objectName(),ToData(p)) then
                    local id = room:askForCardChosen(player, p, "he", self:objectName())
                    room:obtainCard(player, id, false)
                    room:setCardFlag(use.card, self:objectName()..p:objectName())
                end
            end
        elseif event == sgs.CardOffset then
            local effect = data:toCardEffect()
            if effect.card and effect.card:isKindOf("Slash") and effect.offset_card and effect.offset_card:isKindOf("Jink") then
                if effect.card:hasFlag(self:objectName()..effect.to:objectName()) and effect.to:canDiscard(effect.from, "he") and room:askForSkillInvoke(effect.to, self:objectName(), ToData(effect.from)) then
                    local id = room:askForCardChosen(effect.to,effect.from,"he",self:objectName(),false,sgs.Card_MethodDiscard)
                    room:throwCard(id,self:objectName(),effect.from,effect.to)
                end
            end
        end
        return false
    end
}



sfofl_nw_shenmachao:addSkill(sfofl_n_weishui_gain)
sfofl_nw_shenmachao:addSkill(sfofl_n_weishui_rule)
sfofl_nw_shenmachao:addSkill(sfofl_n_weishui_rule_cardmax)
sfofl_nw_shenmachao:addSkill(sfofl_n_weishui_rule_hp)
sfofl_nw_shenmachao:addSkill(sfofl_n_shiqi)
sfofl_nw_shenmachao:addSkill(sfofl_n_chongsha)

sfofl_nw_shenxuchu = sgs.General(extension_war, "sfofl_nw_shenxuchu", "god", 0, true, true)

--[[
	技能名：士气
	相关武将：神许褚[战役]
	技能描述：锁定技，当你使用士气上的魏势力武将技能结算完成后，你摸两张牌。
	引用：sfofl_n_2_shiqi
]] --

sfofl_n_2_shiqi = sgs.CreateTriggerSkill{
	name = "sfofl_n_2_shiqi",
	frequency = sgs.Skill_Frequent,
	events = {sgs.EventForDiy},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.EventForDiy) then
			local ys = data:toString()
			if ys:startsWith("sfofl_n_weishui_rule:") then
                local sts = ys:split(":")
                if table.contains(sgs.Sanguosha:getGeneral(sts[3]):getKingdoms(),"wei") then
                    player:drawCards(2, self:objectName())
                end
            end
        end
    end
}


--[[
	技能名：裸战
	相关武将：神许褚[战役]
	技能描述：出牌阶段限一次，你可以弃置一张装备牌，令一名其他家角色选择一项：1. 弃置一张装备牌；2. 你对其造成1点伤害。
	引用：sfofl_n_luozhan
]] --
sfofl_n_luozhanCard = sgs.CreateSkillCard{
	name = "sfofl_n_luozhan", 
	filter = function(self, targets, to_select) 
		if #targets ~= 0 or to_select:objectName() == sgs.Self:objectName() then return false end
        return true
	end,
	on_effect = function(self, effect)
		local room = effect.to:getRoom()
		if room:askForCard(effect.to, ".Equip", "@sfofl_n_luozhan:"..player:objectName(), ToData(effect.from), sgs.Card_MethodDiscard, effect.from, false, self:objectName()) then
        else
            local damage = sgs.DamageStruct()
            damage.to = effect.to
            damage.from = effect.from
            room:damage(damage)
        end
	end
}
sfofl_n_luozhan = sgs.CreateViewAsSkill{
	name = "sfofl_n_luozhan", 
	n = 1, 
	enabled_at_play = function(self, player)
		return not player:hasUsed("#sfofl_n_luozhanCard")
	end,
	view_filter = function(self, selected, to_select)
		return #selected == 0 and to_select:isKindOf("Weapon")
	end, 
	view_as = function(self, cards) 
		if #cards == 1 then
			local card = sfofl_n_luozhanCard:clone()
			card:addSubcard(cards[1])
			return card
		end
	end
}


sfofl_nw_shenxuchu:addSkill("#sfofl_n_weishui_gain")
sfofl_nw_shenxuchu:addSkill("sfofl_n_weishui_rule")
sfofl_nw_shenxuchu:addSkill("#sfofl_n_weishui_rule_cardmax")
sfofl_nw_shenxuchu:addSkill("#sfofl_n_weishui_rule_hp")
sfofl_nw_shenxuchu:addSkill(sfofl_n_2_shiqi)
sfofl_nw_shenxuchu:addSkill(sfofl_n_luozhan)

sfofl_nw_shenzhangliao = sgs.General(extension_war, "sfofl_nw_shenzhangliao", "god", 4)

--[[
	技能名：突袭
	相关武将：神张辽[战役]
	技能描述：回合开始时，你可以观看一名其他角色的手牌并弃置其中一张。
	引用：sfofl_n_tuxi
]] --

sfofl_n_tuxi = sgs.CreateTriggerSkill{
	name = "sfofl_n_tuxi",
	frequency = sgs.Skill_Frequent,
	events = {sgs.EventPhaseStart},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.EventPhaseStart and player:getPhase() == sgs.Player_Start then
            local targets = sgs.SPlayerList()
            for _, p in sgs.qlist(room:getAllPlayers()) do
				if player:canDiscard(p, "h") then
                    targets:append(p)
                end
            end
            if not targets:isEmpty() then
                local target = room:askForPlayerChosen(player, targets, self:objectName(), "sfofl_n_tuxi-invoke", true, true)
                if target then
                    local id = room:askForCardChosen(player,target,"h",self:objectName(),true,sgs.Card_MethodDiscard)
                    room:throwCard(id,self:objectName(),target,player)
                end
            end
        end
    end
}

--[[
	技能名：威震
	相关武将：神张辽[战役]
	技能描述：锁定技，手牌数大于你的角色对你造成的伤害至多为1。
	引用：sfofl_n_weizhen
]] --
sfofl_n_weizhen = sgs.CreateTriggerSkill{
	name = "sfofl_n_weizhen",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.DamageInflicted},
	on_trigger = function(self,event,player,data)
		local damage = data:toDamage()
		if damage.damage <= 1 then return false end
        if not damage.from or damage.from:getHandcardNum() <= player:getHandcardNum() then return false end
		local room = player:getRoom()
		room:sendCompulsoryTriggerLog(player,self:objectName())
		damage.damage = 1
		data:setValue(damage)
		return false
	end,
}



--[[
	技能名：止啼
	相关武将：神张辽[战役]
	技能描述：回合结束时，若你的手牌数小于2，你可以观看牌堆顶四张牌，获得其中花色相同的任意张牌。
	引用：sfofl_n_zhiti
]] --
sfofl_n_zhiti = sgs.CreateTriggerSkill{
    name = "sfofl_n_zhiti", 
    events = {sgs.EventPhaseChanging}, 
    frequency = sgs.Skill_Frequent, 
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event==sgs.EventPhaseChanging and data:toPhaseChange().to==sgs.Player_NotActive then
            if player:getHandcardNum() < 2 and room:askForSkillInvoke(player, self:objectName()) then
                local card_ids = room:showDrawPile(player, 4, self:objectName())
                local suits = {}
                local dummy = sgs.Sanguosha:cloneCard("slash", sgs.Card_NoSuit, 0)
                dummy:deleteLater()
                room:fillAG(card_ids)
                local card_id = room:askForAG(player, card_ids, false, self:objectName(), "@sfofl_n_zhiti")
                --dummy:addSubcard(card_id)
                for _, id in sgs.qlist(card_ids) do
                    if sgs.Sanguosha:getCard(id):getSuit() == sgs.Sanguosha:getCard(card_id):getSuit() then
                       dummy:addSubcard(id)
                    end
                end
                room:clearAG()
                player:obtainCard(dummy)
            end
        end
    end
}


sfofl_nw_shenzhangliao:addSkill(sfofl_n_tuxi)
sfofl_nw_shenzhangliao:addSkill(sfofl_n_weizhen)
sfofl_nw_shenzhangliao:addSkill(sfofl_n_zhiti)

sfofl_nw_shenguanyu = sgs.General(extension_war, "sfofl_nw_shenguanyu", "god", 5)

--[[
	技能名：虎威
	相关武将：神关羽[战役]
	技能描述：锁定技，回合开始时，你展示牌堆顶一张牌，若此牌为红色，你获得此牌且本回合使用【杀】的次数+1；若此牌为黑色，你将此牌置于武将牌子上，称为“骤”，若你有三张花色相同的“骤”，你移去所有“骤”令一名其他角色弃置装备区里的所有牌，其减少2点体力上限。
	引用：sfofl_n_huwei
]] --
sfofl_n_huwei = sgs.CreateTriggerSkill{
    name = "sfofl_n_huwei",
    frequency = sgs.Skill_Compulsory,
    events = { sgs.EventPhaseStart },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if player:getPhase() ~= sgs.Player_Start then return false end
        local ids = room:showDrawPile(player,1,self:objectName(),false)
        local card = sgs.Sanguosha:getCard(ids:first())
        if card:isRed() then
            player:obtainCard(card)
            room:addPlayerMark(player, "&sfofl_n_huwei-Clear")
            room:addSlashCishu(player, 1, true)
        elseif card:isBlack() then
            player:addToPile("sfofl_n_huwei", ids)
            local spade, club = 0, 0
            for _, id in sgs.qlist(player:getPile("sfofl_n_huwei")) do
                local suit = sgs.Sanguosha:getCard(id):getSuitString()
                if suit == "spade" then
                    spade = spade + 1
                elseif suit == "club" then
                    club = club + 1
                end
            end
           
            if spade >= 3 or club >= 3 then
                player:clearOnePrivatePile("sfofl_n_huwei")
                local target = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName(), "sfofl_n_huwei-invoke", true, true)
                if target then
                    target:throwAllEquips(self:objectName())
                    room:loseMaxHp(target, 2, self:objectName())
                end
                
            end
            
        end
    end,
}

sfofl_nw_shenguanyu:addSkill("tenyearwusheng")
sfofl_nw_shenguanyu:addSkill(sfofl_n_huwei)
   

sfofl_nw_shenyujin = sgs.General(extension_war, "sfofl_nw_shenyujin", "god", 8)

--[[
	技能名：败降
	相关武将：神于禁[战役]
	技能描述：其他角色于其出牌阶段内使用牌指定你为目标后，你可以摸一张牌并交给其一张牌，其本回合手牌上限-1，若如此做，本回合弃牌阶段结束时，若其此阶段弃置过至少两张手牌，其失去1点体力。
	引用：sfofl_n_baijiang
]] --

sfofl_n_baijiang = sgs.CreateTriggerSkill{
    name = "sfofl_n_baijiang",
	events = {sgs.TargetConfirmed},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.TargetConfirmed then
			local use = data:toCardUse()
			if use.from and use.card and use.from and use.from:getPhase() == sgs.Player_Play and use.from:objectName() ~= player:objectName() then
				if use.to:contains(player) then
                    if room:askForSkillInvoke(player, self:objectName(), data) then
                        player:drawCards(1, self:objectName())
                        if not player:isKongcheng() then
                            local card = nil
                            if player:getHandcardNum() > 1 then
                                card = room:askForCard(player, ".|.|.|hand!", "@sfofl_n_baijiang:" .. use.from:objectName(), ToData(use.from), sgs.Card_MethodNone)
                                if not card then
                                    card = player:getHandcards():at(math.random(0, player:getHandcardNum() - 1))
                                end
                            elseif not player:isKongcheng() then
                                card = player:getHandcards():first()
                            end
                            room:giveCard(player, use.from, card, self:objectName(), false)
                        end
                        room:addPlayerMark(use.from, "&sfofl_n_baijiang+to+#"..player:objectName().."-Clear")
                        room:addPlayerMark(use.from, "sfofl_n_baijiang-Clear")
                        room:addMaxCards(use.from, -1)
                    end
                end
			end
		end
		return false
	end,
}
sfofl_n_baijiang_buff = sgs.CreateTriggerSkill{
	name = "#sfofl_n_baijiang_buff",
	events = {sgs.CardsMoveOneTime,sgs.EventPhaseChanging},
	
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if event == sgs.CardsMoveOneTime then
			local move = data:toMoveOneTime()
			if move.from and player:getMark("sfofl_n_baijiang-Clear") > 0 and player:objectName() == move.from:objectName() and player:getPhase() == sgs.Player_Discard and bit32.band(move.reason.m_reason,sgs.CardMoveReason_S_MASK_BASIC_REASON) == sgs.CardMoveReason_S_REASON_DISCARD then
				room:addPlayerMark(player, "sfofl_n_baijiang_DisCard-Clear", move.card_ids:length())
		end
		elseif event == sgs.EventPhaseChanging then
			local change = data:toPhaseChange()
			if change.to ~= sgs.Player_NotActive then return false end
			if player:getMark("sfofl_n_baijiang-Clear") > 0 and player:getMark("sfofl_n_baijiang_DisCard-Clear") >= 2 then
                for _, zangba in sgs.qlist(room:findPlayersBySkillName("sfofl_n_baijiang")) do
                    if player:getMark("&sfofl_n_baijiang+to+#"..zangba:objectName().."-Clear") > 0 then
                        room:sendCompulsoryTriggerLog(zangba,"sfofl_n_baijiang",true)
                        room:loseHp(player, 1, true, zangba, "sfofl_n_baijiang")
                    end
                end
			end
		end
	end,

	can_trigger = function(self, target)
		return target ~= nil
	end
}

--[[
	技能名：筑营
	相关武将：神于禁[战役]
	技能描述：当你受到伤害时，你可以弃置两张牌令此伤害-1；若你以此法弃置的牌类别相同，你摸一张牌。
	引用：sfofl_n_zhuying
]] --
sfofl_n_zhuying = sgs.CreateTriggerSkill {
	name = "sfofl_n_zhuying",
	events = { sgs.DamageInflicted },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()
		if not player:isKongcheng() then
            room:setTag("sfofl_n_zhuying", data)
            local card = room:askForDiscard(player, self:objectName(), 2, 0, true, true, "@sfofl_n_zhuying")
            room:removeTag("sfofl_n_zhuying")
            if card then
                if sgs.Sanguosha:getCard(card:getSubcards():first()):getType() == sgs.Sanguosha:getCard(card:getSubcards():last()):getType() then
                    player:drawCards(1, self:objectName())
                end
                player:damageRevises(data, -1)
            end
		end
		return false
	end
}

sfofl_nw_shenyujin:addSkill(sfofl_n_baijiang)
sfofl_nw_shenyujin:addSkill(sfofl_n_baijiang_buff)
extension_war:insertRelatedSkills("sfofl_n_baijiang", "#sfofl_n_baijiang_buff")
sfofl_nw_shenyujin:addSkill(sfofl_n_zhuying)

sfofl_nw_shenfazheng = sgs.General(extension_war, "sfofl_nw_shenfazheng", "god", 3)

--[[
	技能名：诱战
	相关武将：神法正[战役]
	技能描述：你距离1以内的角色成为【杀】的目标后，你可以弃置此【杀】的使用者一张牌。
	引用：sfofl_n_youzhan
]] --
sfofl_n_youzhan = sgs.CreateTriggerSkill{
    name = "sfofl_n_youzhan",
	events = {sgs.TargetConfirmed},
	on_trigger = function(self, event, player, data, room)
		if event == sgs.TargetConfirmed then
			local use = data:toCardUse()
			if use.from and use.card and use.card:isKindOf("Slash") then
				for _, p in sgs.qlist(use.to) do
                    if player:distanceTo(p) <= 1 then
                        if player:canDiscard(use.from, "he") and room:askForSkillInvoke(player, self:objectName(), ToData(use.from)) then
                            local id = room:askForCardChosen(player,use.from,"he",self:objectName(),false,sgs.Card_MethodDiscard)
                            room:throwCard(id,self:objectName(),use.from,player)
                        end
                    end
				end
			end
		end
		return false
	end,
}

sfofl_nw_shenfazheng:addSkill("xuanhuo")
sfofl_nw_shenfazheng:addSkill("enyuan")
sfofl_nw_shenfazheng:addSkill(sfofl_n_youzhan)




sfofl_nw_shenzhanghe = sgs.General(extension_war, "sfofl_nw_shenzhanghe", "god", 4)

--[[
	技能名：识计
	相关武将：神张郃[战役]
	技能描述：回合结束时，你可以将一张【闪】交给一名其他角色，然后你摸两张牌。
	引用：sfofl_n_shiji
]] --

sfofl_n_shijiCard = sgs.CreateSkillCard {
	name = "sfofl_n_shiji",
	will_throw = false,
	target_fixed = false,
	handling_method = sgs.Card_MethodNone,
	on_use = function(self, room, source, targets)
		room:giveCard(source, targets[1], self, self:objectName(), false)
        source:drawCards(2, self:objectName())
	end
}
sfofl_n_shijiVS = sgs.CreateOneCardViewAsSkill {
	name = "sfofl_n_shiji",
	filter_pattern = "Jink",
	response_pattern = "@@sfofl_n_shiji",
	view_as = function(self, card)
		local skillcard = sfofl_n_shijiCard:clone()
		skillcard:addSubcard(card)
		return skillcard
	end,
}
sfofl_n_shiji = sgs.CreateTriggerSkill {
    name = "sfofl_n_shiji",
    events = { sgs.EventPhaseChanging },
    view_as_skill = sfofl_n_shijiVS,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event==sgs.EventPhaseChanging and data:toPhaseChange().to==sgs.Player_NotActive and not player:isKongcheng() then
			room:askForUseCard(player, "@@sfofl_n_shiji", "@sfofl_n_shiji")
        end
    end
}
sfofl_nw_shenzhanghe:addSkill(sfofl_n_shiji)
sfofl_nw_shenzhanghe:addSkill("qiaobian")



sfofl_nw_shenmenghuo = sgs.General(extension_war, "sfofl_nw_shenmenghuo", "god", 2, true, hide_boss)

--[[
	技能名：特殊规则
	相关武将：神孟获[战役]
	技能描述：第一阶段神孟获体力上限为2，副将为忙牙长，神孟获阵亡后进入第二阶段；\
    第二阶段神孟获体力上限翻倍并将体力回复至体力上限，将副将替换为朵思大王，将手牌摸至四张并立即进入神孟获的回合，神孟获阵亡后进入第三阶段；\
    第三阶段神孟获体力上限翻倍并将体力回复至体力上限，将副将替换为兀突骨，将手牌摸至四张并立即进入神孟获的回合。
	引用：sfofl_n_menghuo_rule
]] --


sfofl_n_menghuo_rule = sgs.CreateTriggerSkill{
    name = "sfofl_n_menghuo_rule", 
    events = {sgs.BeforeGameOverJudge, sgs.GameStart}, 
    frequency = sgs.Skill_Compulsory,
    can_trigger = function(self,target)
		return target
	end,
	on_trigger = function(self,event,player,data,room)
		if event == sgs.BeforeGameOverJudge then
            local death = data:toDeath()
            if not player then return false end
            if player:objectName() ~= death.who:objectName() then return false end
            if player and player:hasSkill(self:objectName()) and player:property("sfofl_nw_shenmenghuo_Phase"):toInt() < 3 then
                death.who:setAlive(true)
                room:broadcastProperty(death.who, "alive")
                room:swapSeat(death.who, death.who)
                room:setPlayerFlag(death.who, "-Global_Dying")
                local currentdying = room:getTag("CurrentDying"):toStringList()
                table.removeOne(currentdying,death.who:objectName())
                room:setTag("CurrentDying", sgs.QVariant(table.concat(currentdying, "|")))

                room:gainMaxHp(player, player:getMaxHp(), self:objectName())
                room:recover(player, sgs.RecoverStruct(self:objectName(), player, player:getLostHp()))
                local n = player:property("sfofl_nw_shenmenghuo_Phase"):toInt()
                n = n + 1
                if n == 2 then
                    room:changeHero(player,"ov_duosidawang",false,false,true,true)
                else
                    room:changeHero(player,"wutugu",false,false,true,true)
                end
                room:setPlayerProperty(player,"sfofl_nw_shenmenghuo_Phase",sgs.QVariant(n))
                if player:getHandcardNum() < 4 then
                    player:drawCards(4-player:getHandcardNum(), self:objectName())
                end
                local current = room:getCurrent()
                if current and current:isAlive() and (room:getTag("Global_ExtraTurn".. current:objectName()):toBool()) then
                    room:throwEvent(sgs.TurnBroken)
                end
                local current = room:getCurrent()
                if current and current:isAlive() then
                    current:changePhase(current:getPhase(), sgs.Player_NotActive)
                end
                local target = player:getNextAlive(room:alivePlayerCount() - 1)
                if target then
                    room:setCurrent(target)
                end
                room:throwEvent(sgs.TurnBroken)
            end 
        elseif event == sgs.GameStart then
            if player and player:hasSkill(self:objectName()) then
                room:changeHero(player,"sfofl_nw_shenmenghuo",false,false,false,false)
                room:changeHero(player,"mangyachang",false,false,true,true)
                room:setPlayerProperty(player,"sfofl_nw_shenmenghuo_Phase",sgs.QVariant(1))
            end
        end
        return false
    end,
}
sfofl_n_menghuo_rule:setProperty("IgnoreInvalidity",ToData(true))

sfofl_nw_shenmenghuo:addSkill("huoshou")
sfofl_nw_shenmenghuo:addSkill("zaiqi")
sfofl_nw_shenmenghuo:addSkill(sfofl_n_menghuo_rule)




sfofl_nw_wenyang = sgs.General(extension_war, "sfofl_nw_wenyang", "wei+wu", 4)

--[[
	技能名：椎锋
	相关武将：文鸯[战役]
	技能描述：魏势力技，你可以失去1点体力，视为使用一张【杀】或【决斗】。
	引用：sfofl_n_zhuifeng
]] --
sfofl_n_zhuifengCard = sgs.CreateSkillCard {
    name = "sfofl_n_zhuifeng",
    filter = function(self,targets,to_select,player)
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE
        then return end
        local card = sgs.Sanguosha:cloneCard(self:getUserString():split("+")[1])
        if card then
            card:deleteLater()
            if card:targetFixed() then return end
            card:setSkillName("sfofl_n_zhuifeng")
            local qtargets = sgs.PlayerList()
            for _,p in ipairs(targets)do
                qtargets:append(p)
            end
            return card:targetFilter(qtargets,to_select,player)
        end
    end,
    feasible = function(self,targets,player)
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE
        then return true end
        local card = sgs.Sanguosha:cloneCard(self:getUserString():split("+")[1])
        if card then
            card:deleteLater()
            if card:targetFixed() then return true end
            card:setSkillName("sfofl_n_zhuifeng")
            local qtargets = sgs.PlayerList()
            for _,p in ipairs(targets)do
                qtargets:append(p)
            end
            return card:targetsFeasible(qtargets,player)
        end
    end,
    on_validate = function(self,cardUse)
        local source = cardUse.from
        local room = source:getRoom()
        local user_string = self:getUserString()	
        room:loseHp(sgs.HpLostStruct(source,1,"sfofl_n_zhuifeng",source))
        if source:isDead() then return nil end
        
        local use_card = sgs.Sanguosha:cloneCard(user_string)
        if not use_card then return nil end
        use_card:setSkillName("sfofl_n_zhuifeng")
        use_card:deleteLater()
        return use_card
    end
}

sfofl_n_zhuifeng = sgs.CreateZeroCardViewAsSkill{
    name = "sfofl_n_zhuifeng",
    view_as = function()
        local c = sfofl_n_zhuifengCard:clone()
        c:setUserString("duel")
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE
        or sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
            c:setUserString(sgs.Sanguosha:getCurrentCardUsePattern())
        end
        return c
    end,
    enabled_at_play = function(self,player)
        return player:getKingdom() == "wei"
    end,
    enabled_at_response = function(self,player,pattern)
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE
        or player:getPhase()~=sgs.Player_Play or player:getKingdom() ~= "wei"
        then return false end
        return string.find(pattern,"Duel")
    end
}


--[[
	技能名：冲坚
	相关武将：文鸯[战役]
	技能描述：吴势力技，你可以将一张装备牌当做【酒】或【杀】使用。
	引用：sfofl_n_chongjian
]] --
sfofl_n_chongjianCard = sgs.CreateSkillCard {
    name = "sfofl_n_chongjian",
    handling_method = sgs.Card_MethodUse,
    filter = function(self,targets,to_select,player)
        local card = sgs.Sanguosha:cloneCard(self:getUserString():split("+")[1])
        if card then
            card:deleteLater()
            if card:targetFixed() then return end
            card:addSubcard(self)
            card:setSkillName("sfofl_n_chongjian")
            local qtargets = sgs.PlayerList()
            for _,p in ipairs(targets)do
                qtargets:append(p)
            end
            return card:targetFilter(qtargets,to_select,player)
        end
    end,
    feasible = function(self,targets,player)
        local card = sgs.Sanguosha:cloneCard(self:getUserString():split("+")[1])
        if card then
            card:deleteLater()
            if card:targetFixed() then return true end
            card:addSubcard(self)
            card:setSkillName("sfofl_n_chongjian")
            local qtargets = sgs.PlayerList()
            for _,p in ipairs(targets)do
                qtargets:append(p)
            end
            return card:targetsFeasible(qtargets,player)
        end
    end,
    on_validate = function(self,cardUse)
        local source = cardUse.from
        local room = source:getRoom()
        local user_string = self:getUserString()
        if (string.find(user_string,"slash") or string.find(user_string,"Slash"))
        and sgs.Sanguosha:getCurrentCardUseReason() ~= sgs.CardUseStruct_CARD_USE_REASON_RESPONSE then
            local slashs = sgs.Sanguosha:getSlashNames()
            user_string = room:askForChoice(source,"sfofl_n_chongjian",table.concat(slashs,"+"))
        end
        if user_string == "peach+analeptic" then
            user_string = "analeptic"
        end
        local use_card = sgs.Sanguosha:cloneCard(user_string)
        if not use_card then return nil end
        use_card:setSkillName("sfofl_n_chongjian")
        use_card:addSubcard(self)
        use_card:deleteLater()
        return use_card
    end,
    on_validate_in_response = function(self,source)
        local room = source:getRoom()
        local user_string = self:getUserString()
        if user_string == "peach+analeptic" then
            user_string = "analeptic"
        end
        local use_card = sgs.Sanguosha:cloneCard(user_string)
        if not use_card then return nil end
        use_card:setSkillName("sfofl_n_chongjian")
        use_card:addSubcard(self)
        use_card:deleteLater()
        return use_card
    end
}

sfofl_n_chongjian = sgs.CreateOneCardViewAsSkill{
    name = "sfofl_n_chongjian",
    response_or_use = true,
    filter_pattern = "EquipCard",
    view_as = function(self,card)
        if sgs.Sanguosha:getCurrentCardUseReason() == sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE then
            local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
            if pattern == "peach+analeptic" then
                pattern = "analeptic"
            end
            local c = sfofl_n_chongjianCard:clone()
            c:addSubcard(card)
            c:setUserString(pattern)
            return c
        end
        local cj = sgs.Self:getTag("sfofl_n_chongjian"):toCard()
        if cj and cj:isAvailable(sgs.Self) then
            local c = sfofl_n_chongjianCard:clone()
            c:setUserString(cj:objectName())
            c:addSubcard(card)
            return c
        end
    end,
    enabled_at_play = function(self,player)
        return player:getKingdom() == "wu"
        and (sgs.Slash_IsAvailable(player) or sgs.Analeptic_IsAvailable(player))
    end,
    enabled_at_response = function(self,player,pattern)
        if sgs.Sanguosha:getCurrentCardUseReason() ~= sgs.CardUseStruct_CARD_USE_REASON_RESPONSE_USE
        or player:getKingdom() ~= "wu" then return false end
        return string.find(pattern,"slash") or string.find(pattern,"Slash") or string.find(pattern,"analeptic")
    end
}

sfofl_n_chongjian:setJuguanDialog("slash,analeptic")


sfofl_nw_wenyang:addSkill("quedi")
sfofl_nw_wenyang:addSkill("mobilechoujue")
sfofl_nw_wenyang:addSkill(sfofl_n_zhuifeng)
sfofl_nw_wenyang:addSkill(sfofl_n_chongjian)

sfofl_xiacaopi = sgs.General(extension_e, "sfofl_xiacaopi", "wei", 3, true, true)

--[[
	技能名：勤艺
	相关武将：俠曹丕[官盗]
	技能描述：每回合你首次造成或受到伤害后，你可以视为使用一张未以此法使用的基本牌或普通锦囊牌。
	引用：sfofl_qinyi
]] --
sfofl_qinyiCard = sgs.CreateSkillCard {
	name = "sfofl_qinyi",
	target_fixed = true,
	on_use = function(self, room, source, targets)
        local card_ids
        local ids = room:getAvailableCardList(source,"trick+basic","sfofl_qinyi", nil, false)
        card_ids = ids
        for _, id in sgs.qlist(ids) do
            if source:getMark("sfofl_qinyi"..sgs.Sanguosha:getCard(id):objectName()) > 0 then
                card_ids:removeOne(id)
            end
        end
        if card_ids:isEmpty() then return end
        room:fillAG(ids,source)
        local id = room:askForAG(source,card_ids,false,"sfofl_qinyi")
        room:clearAG(source)
        local targets = room:getCardTargets(source, sgs.Sanguosha:getCard(id))
        if not targets:isEmpty() then
            room:setPlayerMark(source, "sfofl_qinyi", id)
            local use_card = sgs.Sanguosha:cloneCard(sgs.Sanguosha:getCard(id):objectName(), sgs.Card_NoSuit, 0)
            use_card:setSkillName(self:objectName())
            use_card:deleteLater()
            local target = room:askForPlayerChosen(source, targets, "sfofl_qinyi",
                "@sfofl_qinyiUse:" ..use_card:objectName())
            room:setPlayerMark(source, "sfofl_qinyi", 0)
            local use = sgs.CardUseStruct()
            use.card = use_card
            use.from = source
            use.to:append(target)
            room:useCard(use)
            room:addPlayerMark(source, "sfofl_qinyi"..sgs.Sanguosha:getCard(id):objectName())
        end
	end
}
sfofl_qinyiVS = sgs.CreateViewAsSkill{
    name = "sfofl_qinyi",
    n = 0,
    view_as = function(self,cards)
        if #cards == 0 then return nil end
        local pattern = sgs.Sanguosha:getCurrentCardUsePattern()
        if pattern == "@@sfofl_qinyi" then
            local card = sfofl_qinyiCard:clone()
            return card
        end
    end,
    enabled_at_play = function(self, player)
        return false
    end,
    enabled_at_response = function(self, player, pattern)
        return pattern == "@@sfofl_qinyi" 
    end,
}
sfofl_qinyi = sgs.CreateTriggerSkill{
	name = "sfofl_qinyi",
	events = {sgs.Damaged,sgs.Damage},
    view_as_skill = sfofl_qinyiVS,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local damage = data:toDamage()
        if player:getMark("sfofl_qinyi-Clear") == 0 then
            room:addPlayerMark(player, "sfofl_qinyi-Clear")
		    room:askForUseCard(player,"@@sfofl_qinyi","@sfofl_qinyi")
        end
	end,
}

--[[
	技能名：技新
	相关武将：俠曹丕[官盗]
	技能描述：每当你使用你本局游戏未使用过的牌后，你可以摸X张牌并展示，令这些牌不计距离次数和手牌上限（X为此技能本轮使用次数）。
	引用：sfofl_jixin
]] --
sfofl_jixin = sgs.CreateTriggerSkill{
    name = "sfofl_jixin",
    events = {sgs.CardUsed, sgs.CardResponded},
    frequency = sgs.Skill_Frequent, 
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local card
        if event == sgs.CardUsed then
            card = data:toCardUse().card
        else
            if data:toCardResponse().m_isUse then
                card = data:toCardResponse().m_card
            end
        end
        if card:isKindOf("SkillCard") then return false end
        if player:getMark("sfofl_jixin:"..card:objectName()) > 0 then return false end
        room:addPlayerMark(player, "sfofl_jixin:"..card:objectName())
        if room:askForSkillInvoke(player, self:objectName()) then
            room:addPlayerMark(player, "sfofl_jixin_lun")
            room:addPlayerMark(player, "&sfofl_jixin_lun")
            local x = player:getMark("sfofl_jixin_lun")
            local cards = player:drawCardsList(x, self:objectName())
            room:showCard(player, cards)
            room:ignoreCards(player, cards)
            for _, id in sgs.qlist(cards) do
                if room:getCardPlace(id) == sgs.Player_PlaceHand and room:getCardOwner(id) == player then
                    room:setCardFlag(id, self:objectName())
                    room:setCardTip(id, self:objectName())
                end
            end
        end
    end
}
sfofl_jixin_buff = sgs.CreateTriggerSkill{
    name = "#sfofl_jixin_buff",
    events = {sgs.EventPhaseChanging},
    frequency = sgs.Skill_Frequent, 
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.EventPhaseChanging then
            local change = data:toPhaseChange()
            if change.to == sgs.Player_Discard then
                for _,card in sgs.qlist(player:getHandcards()) do
                    if card:hasFlag("sfofl_jixin") then
                        room:ignoreCards(player, card)
                    end
                end
            end
        end
    end
}
sfofl_jixin_targetmod = sgs.CreateTargetModSkill {
	name = "#sfofl_jixin_targetmod",
	residue_func = function(self, player, card)
		if card and card:hasFlag("sfofl_jixin") then return 999 end
		return 0
	end,
    distance_limit_func = function(self, from, card, to)
        if card and card:hasFlag("sfofl_jixin") then return 1000 end
        return 0
    end,

}


--[[
	技能名：继魏
	相关武将：俠曹丕[官盗]
	技能描述：觉醒技，每个回合结束时，若本轮“技新”发动次数不小于1号位的当前体力值，你增加1点体力上限并回复所有体力且挑选5个魏势力主公技获得。
	引用：sfofl_jiwei
]] --
sfofl_jiwei_record = sgs.CreateTriggerSkill{
	name = "#sfofl_jiwei_record",
	events = {sgs.InvokeSkill},
	on_trigger = function(self, event, player, data, room)
        if event==sgs.InvokeSkill and data:toString() == "sfofl_jixin" and player:getMark("sfofl_jiwei") == 0 then
            room:addPlayerMark(player, "sfofl_jiwei_jixin_lun")
        end
    end
}
sfofl_jiwei = sgs.CreateTriggerSkill{
	name = "sfofl_jiwei",
	frequency = sgs.Skill_Wake,
	events = {sgs.EventPhaseChanging},
	on_trigger = function(self, event, player, data, room)
        if event==sgs.EventPhaseChanging and data:toPhaseChange().to==sgs.Player_NotActive then
            for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                if p:getMark("sfofl_jiwei") == 0 then
                    local lord
                    for _, q in sgs.qlist(room:getAlivePlayers()) do
                        if q:getSeat() == n then
                            lord = q
                            break
                        end
                    end
                    if (lord and p:getMark("sfofl_jiwei_jixin_lun") >= lord:getHp()) or p:canWake(self:objectName()) then
                        room:addPlayerMark(p, "sfofl_jiwei")
                        if room:changeMaxHpForAwakenSkill(p, 1, self:objectName()) then
                            room:recover(p,sgs.RecoverStruct(self:objectName(),p, p:getLostHp()))
                            local skills = {}
                            for _,name in ipairs(sgs.Sanguosha:getLimitedGeneralNames()) do
                                local general = sgs.Sanguosha:getGeneral(generalname)
                                if general and table.contains(general:getKingdoms(),"wei") then
                                    for _,skill in sgs.qlist(general:getVisibleSkillList()) do
                                        if skill:isLordSkill() then
					                        if not table.contains(skills, skill:objectName()) then
                                                table.insert(skills, name)
                                            end
                                        end
                                    end
                                end
                            end
                            for i = 1, 5, 1 do
                                if #skills > 0 then
                                    local choice = room:askForChoice(p,"sfofl_jiwei",table.concat(skills,"+"))
                                    room:handleAcquireDetachSkills(p, choice)
                                    table.removeOne(skills, choice)
                                end
                            end
                        end
                   end
                end
            end
        end
    end,
    can_trigger = function(self, target)
		return target and target:isAlive()
	end,
}
sfofl_xiacaopi:addSkill(sfofl_qinyi)
sfofl_xiacaopi:addSkill(sfofl_jixin)
sfofl_xiacaopi:addSkill(sfofl_jixin_buff)
sfofl_xiacaopi:addSkill(sfofl_jixin_targetmod)
extension_e:insertRelatedSkills("sfofl_jixin", "#sfofl_jixin_buff")
extension_e:insertRelatedSkills("sfofl_jixin", "#sfofl_jixin_targetmod")
sfofl_xiacaopi:addSkill(sfofl_jiwei_record)
sfofl_xiacaopi:addSkill(sfofl_jiwei)
extension_e:insertRelatedSkills("sfofl_jiwei", "#sfofl_jiwei_record")

sfofl_peachchan = sgs.General(extension_s, "sfofl_peachchan", "qun", 4, false)
--[[
	技能名：桃宴
	相关武将：小桃[官盗]
	技能描述：回合开始时，你可以令至多两名其他角色各摸一张牌并从游戏外获得一张【桃】。
	引用：sfofl_taoyan
]] --

for i=0,5 do
	local card = sgs.Sanguosha:cloneCard("peach", sgs.Card_NoSuit, 0)
	card:setObjectName("_peach")
	card:setParent(exclusive_cards)
end

sfofl_taoyan = sgs.CreateTriggerSkill{
    name = "sfofl_taoyan",
	frequency = sgs.Skill_Frequent,
	events = {sgs.EventPhaseStart},
	on_trigger = function(self,event,player,data)
		local room = player:getRoom()
		if event == sgs.EventPhaseStart then
			if player:getPhase()==sgs.Player_Start then
                local others = room:askForPlayersChosen(player, room:getOtherPlayers(player), self:objectName(), 0, 2, "@sfofl_taoyan", true, true)
                if not others then return false end
                for _, p in sgs.qlist(others) do
                    room:drawCards(p, 1, self:objectName())
                    for _,id in sgs.qlist(sgs.Sanguosha:getRandomCards(true))do
                        local nmrq = sgs.Sanguosha:getEngineCard(id)
                        if nmrq:objectName()~="_peach"
                        or room:getCardOwner(id) then continue end
                        room:broadcastSkillInvoke(self:objectName(),1)
                        room:obtainCard(p,nmrq)
                        break
                    end
                end
			end
		end
	end,
}

--[[
	技能名：妍丽
	相关武将：小桃[官盗]
	技能描述：每轮限一次，当一名角色于你的回合外进入濒死状态时，你可以令其回复至1点体力，然后其摸一张牌。
	引用：sfofl_yanli
]] --
sfofl_yanli = sgs.CreateTriggerSkill {
	name = "sfofl_yanli",
	events = { sgs.EnterDying },
	can_trigger = function(self, player)
		return player
	end,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local dying = data:toDying()
		for _, p in sgs.qlist(room:findPlayerBySkillName(self:objectName())) do
            if p:getMark("sfofl_yanli_lun") == 0 and p:getPhase() == sgs.Player_NotActive and room:askForSkillInvoke(p, self:objectName(), data) then
                room:addPlayerMark(p, "sfofl_yanli_lun")
                room:recover(player,sgs.RecoverStruct(self:objectName(),p, 1-player:getHp()))
                player:drawCard(1, self:objectName())
            end
        end
	end
}




sfofl_peachchan:addSkill(sfofl_taoyan)
sfofl_peachchan:addSkill(sfofl_yanli)


sfofl_jinkchan = sgs.General(extension_s, "sfofl_jinkchan", "qun", 4, false)



--[[
	技能名：闪舞
	相关武将：小闪[官盗]
	技能描述：当其他角色成为【杀】的目标时，你可以弃置一张【闪】，取消之。
	引用：sfofl_shanwu
]] --
sfofl_shanwu = sgs.CreateTriggerSkill {
    name = "sfofl_shanwu",
    events = { sgs.TargetConfirmed },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.TargetConfirmed then
            local use = data:toCardUse()
            if use.card and use.card:isKindOf("Slash") and not use.to:contains(player) then
                for _, p in sgs.qlist(use.to) do
                    if not p:isKongcheng() and room:askForCard(player, ".Jink", "@sfofl_shanwu::"..p:objectName(), data, sgs.Card_MethodDiscard) then
                        room:sendCompulsoryTriggerLog(player,self:objectName(),true)
                        use.to:removeOne(p)
                        data:setValue(use)
                    end
                end
            end
        end
        return false
    end
}

--[[
	技能名：娴丽
	相关武将：小闪[官盗]
	技能描述：每回合限两次，当你失去【闪】时，你可以获得当前回合角色的一张牌。
	引用：sfofl_xianli
]] --

sfofl_xianli = sgs.CreateTriggerSkill {
    name = "sfofl_xianli",
    events = { sgs.CardsMoveOneTime },
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local move = data:toMoveOneTime()
        if move.from and move.from:objectName() == player:objectName()
            and move.to_place ~= sgs.Player_PlaceHand and move.from_places:contains(sgs.Player_PlaceHand) then
            local count = 0
            for i, id in sgs.qlist(move.card_ids) do
                local card = sgs.Sanguosha:getCard(id)
                if card:isKindOf("Jink") and move.from_places:at(i) == sgs.Player_PlaceHand then
                    count = count + 1
                end
            end
            if count > 0 then
                local current = room:getCurrent()
                if current and current:isAlive() and not current:isNude() and player:getMark("sfofl_xianli-Clear") < 2 and room:askForSkillInvoke(player, self:objectName(), ToData(current)) then
                    room:addPlayerMark(player, "sfofl_xianli-Clear")
                    room:broadcastSkillInvoke(self:objectName(),1)
                    local id = room:askForCardChosen(player, current, "he", self:objectName(), false, sgs.Card_MethodNone)
                    local card = sgs.Sanguosha:getCard(id)
                    room:obtainCard(player, card, false)
                end
            end
        end
        return false
    end
}



sfofl_jinkchan:addSkill(sfofl_shanwu)
sfofl_jinkchan:addSkill(sfofl_xianli)



sfofl_slashchan = sgs.General(extension_s, "sfofl_slashchan", "qun", 4, false)

--[[
	技能名：瑰杀
	相关武将：小杀[官盗]
	技能描述：当其他角色使用【杀】时，你可以弃置一张牌，令此【杀】不计入次数且造成伤害+1。
	引用：sfofl_guisha
]] --
sfofl_guisha_buff = sgs.CreateTriggerSkill{
	name = "#sfofl_guisha_buff",
	events = {sgs.DamageCaused},
	on_trigger = function(self, event, player, data, room)
        local damage = data:toDamage()
        if damage.card and damage.card:hasFlag("sfofl_guisha") then
            damage.damage = damage.damage + 1
            data:setValue(damage)
        end
    end
}

sfofl_guisha = sgs.CreateTriggerSkill{
	name = "sfofl_guisha",
	events = {sgs.CardUsed},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local use = data:toCardUse()
		if use.card:isKindOf("Slash") then
            for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                if p:canDiscard(p,"he") and room:askForCard(p, "..", "@sfofl_guisha:"..player:objectName(), data,self:objectName()) then
                    if use.m_addHistory then
                        room:addPlayerHistory(player, use.card:getClassName(),-1)
                    end
                    room:setCardFlag(use.card, self:objectName())
                end
            end
        end
    end,
	can_trigger = function(self, target)
		return target
	end
}

--[[
	技能名：姝丽
	相关武将：小杀[官盗]
	技能描述：每回合限两次，当其他角色使用【杀】造成伤害后，你可以与其各摸一张牌。
	引用：sfofl_shuli
]] --
sfofl_shuli = sgs.CreateTriggerSkill{
	name = "sfofl_shuli",
	events = {sgs.Damage},
	on_trigger = function(self, event, player, data, room)
        local damage = data:toDamage()
        for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
            if p:getMark("sfofl_shuli-Clear") < 2 and damage.from and damage.from:isAlive() and damage.from:objectName() ~= p:objectName()
            and room:askForSkillInvoke(p, self:objectName(), data) then
                room:addPlayerMark(p, "sfofl_shuli-Clear")
                room:broadcastSkillInvoke(self:objectName(),1)
                p:drawCard(1, self:objectName())
                damage.from:drawCard(1, self:objectName())
            end
        end
    end,
    can_trigger = function(self, target)
		return target
	end
}



sfofl_slashchan:addSkill(sfofl_guisha)
sfofl_slashchan:addSkill(sfofl_guisha_buff)
extension_s:insertRelatedSkills("sfofl_guisha", "#sfofl_guisha_buff")
sfofl_slashchan:addSkill(sfofl_shuli)


sfofl_analepticchan = sgs.General(extension_s, "sfofl_analepticchan", "qun", 4, false)

--[[
	技能名：美酿
	相关武将：小酒[官盗]
	技能描述：其他角色的出牌阶段开始时，你可以令其视为使用一张无次数限制的【酒】。
	引用：sfofl_meiniang
]] --
sfofl_meiniang = sgs.CreateTriggerSkill {
	name = "sfofl_meiniang",
	events = {sgs.EventPhaseStart},
	can_trigger = function(self, target)
		return target
	end,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if player:getPhase() ~= sgs.Player_Play then
			return false
		end
		for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
            if p:isAlive() and not p:isKongcheng() then
                if room:askForSkillInvoke(p, self:objectName()) then
                    local analeptic = sgs.Sanguosha:cloneCard("analeptic", sgs.Card_NoSuit, 0)
                    analeptic:setSkillName(self:objectName())
                    analeptic:deleteLater()
                    room:useCard(sgs.CardUseStruct(analeptic, player, sgs.SPlayerList(), false))
                end
            end
        end
		
		return false
	end
}


--[[
	技能名：媱丽
	相关武将：小酒[官盗]
	技能描述：当其他角色于其出牌阶段使用【酒】后，你可以令其本回合使用的下一张【杀】不可被响应且可以额外指定一个目标。
	引用：sfofl_yaoli
]] --

sfofl_yaoli = sgs.CreateTriggerSkill {
	name = "sfofl_yaoli",
	events = {sgs.CardFinished},
	can_trigger = function(self, target)
		return target and target:getPhase() == sgs.Player_Play
	end,
	on_trigger = function(self, event, player, data)
        local use = data:toCardUse()
        if use.card and use.card:isKindOf("Analeptic") then
            for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                if room:askForSkillInvoke(p, self:objectName(), data) then
                    room:broadcastSkillInvoke(self:objectName(),1)
                    room:setPlayerMark(player, "&sfofl_yaoli-Clear", 1)
                    room:addSlashMubiao(player, 1, true)
                end
            end
        end
    end
}
sfofl_yaoli_buff = sgs.CreateTriggerSkill {
	name = "#sfofl_yaoli_buff",
	events = {sgs.CardUsed},
	can_trigger = function(self, target)
		return target and target:getMark("&sfofl_yaoli-Clear") > 0
	end,
	on_trigger = function(self, event, player, data)
        local use = data:toCardUse()
        if use.card and use.card:isKindOf("Slash") then
            room:setPlayerMark(player, "&sfofl_yaoli-Clear", 0)
            local no_respond_list = use.no_respond_list
            table.insert(no_respond_list, "_ALL_TARGETS")
            use.no_respond_list = no_respond_list
            data:setValue(use)
            room:addSlashMubiao(player, -1, true)
        end
    end
}

sfofl_analepticchan:addSkill(sfofl_meiniang)
sfofl_analepticchan:addSkill(sfofl_yaoli)
sfofl_analepticchan:addSkill(sfofl_yaoli_buff)
extension_s:insertRelatedSkills("sfofl_yaoli", "#sfofl_yaoli_buff")

sfofl_indulgencechan = sgs.General(extension_s, "sfofl_indulgencechan", "qun", 4, false)
--[[
	技能名：乐虞
	相关武将：小乐[官盗]
	技能描述：一名角色的回合开始时，你可以弃置三张牌令其进行判定，若结果不为♥，其跳过本回合的出牌阶段。
	引用：sfofl_leyu
]] --

sfofl_leyu = sgs.CreateTriggerSkill {
	name = "sfofl_leyu",
	frequency = sgs.Skill_Compulsory,
	events = { sgs.EventPhaseStart },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if player:getPhase() == sgs.Player_Start then
			for _,p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                if room:askForDiscard(p, self:objectName(), 3, 3, true, true, "@sfofl_leyu-discard", ".", self:objectName()) then
                    room:broadcastSkillInvoke(self:objectName(),1)
                    local judge = sgs.JudgeStruct()
                    judge.who = player
                    judge.pattern = ".|heart"
                    judge.good = false
                    judge.reason = self:objectName()
                    room:judge(judge)
                    if judge:isBad() then
                        player:skip(sgs.Player_Play)
                    end
                end
			end
		end
	end,
    can_trigger = function(self, target)
        return target
    end

}



--[[
	技能名：媛丽
	相关武将：小乐[官盗]
	技能描述：当一名角色跳过出牌阶段时，你可以与一名其他角色各摸一张牌。
	引用：sfofl_yuanli
]] --

sfofl_yuanli = sgs.CreateTriggerSkill {
	name = "sfofl_yuanli",
	frequency = sgs.Skill_Compulsory,
	events = { sgs.EventPhaseSkipping },
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if player:getPhase() == sgs.Player_Play then
			for _,p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                local target = room:askForPlayerChosen(p, room:getOtherPlayers(p), self:objectName(), "sfofl_yuanli-invoke", true, true)
                if target then
                    room:broadcastSkillInvoke(self:objectName(),1)
                    p:drawCard(1, self:objectName())
                    target:drawCard(1, self:objectName())
                end
			end
		end
	end,
    can_trigger = function(self, target)
        return target
    end

}

sfofl_indulgencechan:addSkill(sfofl_leyu)
sfofl_indulgencechan:addSkill(sfofl_yuanli)




    
    
doHenshin = function(player, gerenal_name)
    local room = player:getRoom()
    if player:getMark("&sfofl_moli") >= 5 then
        room:doLightbox(gerenal_name.."_henshin", 3000)
        local cards = player:getJudgingArea()
        local slash = sgs.Sanguosha:cloneCard("slash")
        slash:deleteLater()
        slash:addSubcards(cards)
        room:throwCard(slash, "henshin", player, player)
        player:setTag(gerenal_name, ToData(player:getHp()))
        if player:getGeneralName() == gerenal_name then
            room:changeHero(player, gerenal_name.."_change", false, false, false, true, player:getTag(gerenal_name.."_change"):toInt() or 0)
        elseif player:getGeneral2Name() == gerenal_name then
            room:changeHero(player, gerenal_name.."_change", false, false, true, true, player:getTag(gerenal_name.."_change"):toInt() or 0)
        else
            return false
        end
        room:addPlayerMark(player, "sfofl_henshin")
    end
end

quitHenshin = function(player, gerenal_name)
    local room = player:getRoom()
    if player:getMark("&sfofl_moqi") > 0 then return false end
    if player:getMark("&sfofl_moli") == 0 then
        player:setTag(gerenal_name .. "_change", ToData(player:getHp()))
        if player:getGeneralName() == gerenal_name .. "_change" then
            room:changeHero(player, gerenal_name, false, false, false, true, player:getTag(gerenal_name):toInt() or 0)
        else
            room:changeHero(player, gerenal_name, false, false, true, true, player:getTag(gerenal_name):toInt() or 0)
        end
        room:removePlayerMark(player, "sfofl_henshin")
    end
end

costMana = function(player, num, gerenal_name)
    local room = player:getRoom()
    local mark = player:getMark("&sfofl_moli")
    if mark >= num then
        room:removePlayerMark(player, "&sfofl_moli", num)
        return true
    else
        local lost = num - mark
        room:removePlayerMark(player, "&sfofl_moli", mark)
        if player:getMark("&sfofl_moli") == 0 then
            quitHenshin(player, gerenal_name)
        end
        return false
    end
end
    
sfofl_magic_zhenji = sgs.General(extension_e, "sfofl_magic_zhenji", "wei", 3, false)
--[[
	技能名：魔力
	相关武将：甄姬[官盗]
	技能描述：魔力：变身技（0/5），当你于摸牌阶段外获得牌时，你可以展示之，若为黑色，你获得1点魔力，结束阶段，你进行吟唱并变身。
	引用：sfofl_moli_zhenji
]] --

sfofl_moli_zhenji = sgs.CreateTriggerSkill{
    name = "sfofl_moli_zhenji",
    events = {sgs.CardsMoveOneTime, sgs.EventPhaseProceeding},
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            if move.to and move.to:objectName() == player:objectName()
                and move.to_place == sgs.Player_PlaceHand and move.from_places:contains(sgs.Player_PlaceDraw) and player:getPhase() ~= sgs.Player_Draw then
                for i, id in sgs.qlist(move.card_ids) do
                    if room:askForSkillInvoke(player, self:objectName(), ToData(id)) then
                        room:showCard(player, id)
                        local card = sgs.Sanguosha:getCard(id)
                        if card:isBlack() then
                            room:broadcastSkillInvoke(self:objectName(),1)
                            if player:getMark("&sfofl_moli") < 5 then
                                room:addPlayerMark(player, "&sfofl_moli")
                            end
                        end
                    end
                end
            end
        elseif event == sgs.EventPhaseProceeding then
            if player:getPhase() == sgs.Player_Finish and player:getMark("&sfofl_moli") >= 5 then
                room:broadcastSkillInvoke(self:objectName(),2)
                doHenshin(player, "sfofl_magic_zhenji")
            end
        end
    end,
}

sfofl_magic_zhenji:addSkill("qingguo")
sfofl_magic_zhenji:addSkill(sfofl_moli_zhenji)
sfofl_magic_zhenji:addRelateSkill("sfofl_jinghong")
sfofl_magic_zhenji:addRelateSkill("sfofl_youlong")
sfofl_magic_zhenji:addRelateSkill("sfofl_haiyou")

sfofl_magic_zhenji_change = sgs.General(extension_e, "sfofl_magic_zhenji_change", "wei", 3, false, true)
--[[
	技能名：惊鸿
	相关武将：甄姬[闪耀战姬]
	技能描述：称号与你相同的角色不因此技能获得牌后，你可以消耗1点魔力令其判定，若为黑色牌其获得并重复之；你的黑色牌无次数限制且不计入手牌上限。
	引用：sfofl_jinghong
]] --


sfofl_jinghong = sgs.CreateTriggerSkill{
    name = "sfofl_jinghong",
    events = {sgs.CardsMoveOneTime},
    on_trigger = function(self, event, player, data)
        if event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            if move.to and move.to_place == sgs.Player_PlaceHand and move.reason.m_skillName~=self:objectName() then
                local to = room:findPlayerByObjectName(move.to:objectName())
                if to and ((string.find(to:getGeneralName(), "_change") and string.find(to:getGeneralName(), "sfofl_")) or (string.find(to:getGeneral2Name(), "_change") and string.find(to:getGeneral2Name(), "sfofl_"))) then
                    if room:askForSkillInvoke(player, self:objectName(), ToData(to)) then
                        if costMana(player, 1, "sfofl_magic_zhenji") then
                            while true do
                                local judge = sgs.JudgeStruct()
                                judge.who = player
                                judge.pattern = ".|black"
                                judge.good = true
                                judge.reason = self:objectName()
                                judge.throw_card = false
                                room:judge(judge)
                                if judge:isGood() then
                                    room:broadcastSkillInvoke(self:objectName(),1)
                                    room:obtainCard(p, judge.card, self:objectName(),false)
                                else
                                    break
                                end
                            end
                        end
                    end
                end
            end
        end
    end
}
sfofl_jinghong_buff = sgs.CreateTargetModSkill{
    name = "#sfofl_jinghong_buff",
	residue_func = function(self, player, card)
		if card and card:isBlack() then return 999 end
		return 0
	end,
}

sfofl_jinghong_limit = sgs.CreateCardLimitSkill{
    name = "#sfofl_jinghong_limit",
    limit_list = function(self, player)
        if player:hasSkill("sfofl_jinghong") then 
            return "ignore"
        else
            return ""
        end
    end,
    limit_pattern = function(self, player)
        if player:hasSkill("sfofl_jinghong") then 
            return ".|black"
        end
    end,
}


--[[
	技能名：游龙
	相关武将：甄姬[闪耀战姬]
	技能描述：锁定技，你造成的伤害改为冰冻伤害，受到冰冻伤害的角色直到其下个回合结束：摸牌数-1，你+1，且计算距离时+1，你-1，且不能响应你使用的牌。
	引用：sfofl_youlong
]] --

sfofl_youlong_buff = sgs.CreateTriggerSkill{
    name = "#sfofl_youlong_buff",
    events = {sgs.Damaged, sgs.DrawNCards},
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.Damaged then
            local damage = data:toDamage()
            if damage.nature == sgs.DamageStruct_Ice then
                local zhenji = room:findPlayerBySkillName(self:objectName())
                if not zhenji then return false end
                room:addPlayerMark(player, "&sfofl_youlong-SelfClear")
            end
        elseif event == sgs.DrawNCards then
            if player:getMark("&sfofl_youlong-SelfClear") > 0 then
                local draw = data:toDraw()
                if draw.reason ~= "draw_phase" then return false end
                draw.num = draw.num - 1
                data:setValue(draw)
            end
        end
    end,
    can_trigger = function(self, target)
        return target
    end,
}

sfofl_youlong_distance = sgs.CreateDistanceSkill{
    name = "#sfofl_youlong_distance",
    correct_func = function(self, from, to)
        if from:getMark("&sfofl_youlong-SelfClear") > 0 then
            return 1
        end
        if from and from:hasSkill("sfofl_youlong") and to and to:getMark("&sfofl_youlong-SelfClear") > 0 then
            return -1
        end
        return 0
    end,
}

sfofl_youlong = sgs.CreateTriggerSkill{
    name = "sfofl_youlong",
    events = {sgs.Predamage, sgs.CardUsed, sgs.DrawNCards},
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data)
        if event == sgs.Predamage then
            local damage = data:toDamage()
            if damage.from and damage.from:objectName() == player:objectName() then
                damage.nature = sgs.DamageStruct_Ice
                data:setValue(damage)
                player:getRoom():sendCompulsoryTriggerLog(player, self:objectName())
            end
        elseif event == sgs.CardUsed then
            local use = data:toCardUse()
            if use.card and not use.card:isKindOf("SkillCard") then
                local no_respond_list = use.no_respond_list
                local targets = sgs.SPlayerList()
                for _, p in sgs.qlist(room:getAlivePlayers()) do
                    if p:getMark("&sfofl_youlong-SelfClear") > 0 then
                        table.insert(no_respond_list, p:objectName())
                        targets:append(p)
                    end
                end
                if not targets:isEmpty() then
                    local log = sgs.LogMessage()
                    log.type = "$NoRespond"
                    log.from = use.from
                    log.to = targets
                    log.arg = self:objectName()
                    log.card_str = use.card:toString()
                    room:sendLog(log)
                    use.no_respond_list = no_respond_list
                    data:setValue(use)
                end
            end
        elseif event == sgs.DrawNCards then
            local draw = data:toDraw()
            if draw.reason ~= "draw_phase" then return false end
            for _, p in sgs.qlist(room:getAlivePlayers()) do
                if p:getMark("&sfofl_youlong-SelfClear") > 0 then
                    draw.num = draw.num + 1
                end
            end
            data:setValue(draw)
            room:sendCompulsoryTriggerLog(player, self:objectName())
        end
    end,
}

--[[
	技能名：海佑
	相关武将：甄姬[闪耀战姬]
	技能描述：称号与你相同的角色成为牌的目标时，你可以消耗1点魔力令之无效。
	引用：sfofl_haiyou
]] --
sfofl_haiyou = sgs.CreateTriggerSkill{
	name = "sfofl_haiyou",
	events = {sgs.TargetConfirming},
    frequency = sgs.Skill_Frequent ,
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		if (event == sgs.TargetConfirming) then
			local use = data:toCardUse()
			if not use.card:isKindOf("SkillCard") then
                for _, p in sgs.qlist(use.to) do
                    if ((string.find(p:getGeneralName(), "_change") and string.find(p:getGeneralName(), "sfofl_")) or (string.find(p:getGeneral2Name(), "_change") and string.find(p:getGeneral2Name(), "sfofl_"))) then
                        if room:askForSkillInvoke(player, self:objectName(), data) then
                            costMana(player, 1, "sfofl_magic_zhenji")
                            local list = use.nullified_list
                            table.insert(list, "_ALL_TARGETS")
                            use.nullified_list = list
                            data:setValue(use)
                            break
                        end
                    end
                end
			end
		end
	end,
}

sfofl_magic_zhenji_change:addSkill(sfofl_jinghong)
sfofl_magic_zhenji_change:addSkill(sfofl_jinghong_buff)
sfofl_magic_zhenji_change:addSkill(sfofl_jinghong_limit)
extension_e:insertRelatedSkills("sfofl_jinghong", "#sfofl_jinghong_buff")
extension_e:insertRelatedSkills("sfofl_jinghong", "#sfofl_jinghong_limit")
sfofl_magic_zhenji_change:addSkill(sfofl_youlong)
sfofl_magic_zhenji_change:addSkill(sfofl_youlong_buff)
sfofl_magic_zhenji_change:addSkill(sfofl_youlong_distance)
extension_e:insertRelatedSkills("sfofl_youlong", "#sfofl_youlong_buff")
extension_e:insertRelatedSkills("sfofl_youlong", "#sfofl_youlong_distance")
sfofl_magic_zhenji_change:addSkill(sfofl_haiyou)



sfofl_magic_woguotai = sgs.General(extension_e, "sfofl_magic_woguotai", "wu", 3, false)
--[[
	技能名：魔力
	相关武将：吴国太[官盗]
	技能描述：变身技（0/5），游戏开始时或当你场上的牌发生变化时，你获得1点魔力，当你失去牌时，你进行吟唱并变身。
	引用：sfofl_moli_woguotai
]] --
sfofl_moli_woguotai = sgs.CreateTriggerSkill{
    name = "sfofl_moli_woguotai",
    events = {sgs.CardsMoveOneTime, sgs.GameStart},
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            if ((move.to and move.to:objectName() == player:objectName()
                and (move.to_place == sgs.Player_PlaceEquip or move.to_place == sgs.Player_PlaceDelayedTrick))
                or (move.from and move.from:objectName() == player:objectName() and (move.from_places:contains(sgs.Player_PlaceEquip) or move.from_places:contains(sgs.Player_PlaceDelayedTrick)))) then
                if player:getMark("&sfofl_moli") < 5 then
                    room:addPlayerMark(player, "&sfofl_moli")
                end
            end
            if move.from and move.from:objectName() == player:objectName()
                and (move.from_places:contains(sgs.Player_PlaceEquip) or move.from_places:contains(sgs.Player_PlaceDelayedTrick)) then
                if player:getMark("&sfofl_moli") >= 5 then
                    room:broadcastSkillInvoke(self:objectName(),2)
                    doHenshin(player, "sfofl_magic_woguotai")
                end
            end
        elseif event == sgs.GameStart then
            if player:getMark("&sfofl_moli") < 5 then
                room:addPlayerMark(player, "&sfofl_moli")
            end
        end
    end,
}


sfofl_magic_woguotai:addSkill("tenyearganlu")
sfofl_magic_woguotai:addSkill("buyi")
sfofl_magic_woguotai:addSkill(sfofl_moli_woguotai)
sfofl_magic_woguotai:addRelateSkill("sfofl_fengshou")
sfofl_magic_woguotai:addRelateSkill("sfofl_susheng")

sfofl_magic_woguotai_change = sgs.General(extension_e, "sfofl_magic_woguotai_change", "wu", 3, false, true)
--[[
	技能名：凤守
	相关武将：吴国太[闪耀战姬]
	技能描述：当你变身后，你可以重新分配与你距离为1的角色的座次，然后消耗任意魔​​力，令等量名角色受到的火焰伤害+1。
	引用：sfofl_fengshou
]] --
sfofl_fengshou_buff = sgs.CreateTriggerSkill{
    name = "#sfofl_fengshou_buff",
    events = {sgs.Damaged},
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data)
        local damage = data:toDamage()
        if damage.nature == sgs.DamageStruct_Fire then
            player:damageRevises(data, 1)
        end
    end,
    can_trigger = function(self, target)
        return target and target:getMark("&sfofl_fengshou") > 0
    end,
}
sfofl_fengshou = sgs.CreateTriggerSkill{
    name = "sfofl_fengshou",
    events = {sgs.MarkChanged},
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.MarkChanged then
            local mark = data:toMark()
			if mark.name == "sfofl_henshin" and mark.gain > 0 then
                room:broadcastSkillInvoke(self:objectName(),1)
                local others = sgs.SPlayerList()
                for _, p in sgs.qlist(room:getOtherPlayers(player)) do
                    if player:distanceTo(p) == 1 then
                        others:append(p)
                    end
                end
                if not others:isEmpty() then
                    while true do
                        local from = room:askForPlayerChosen(player, others, self:objectName(), "sfofl_fengshou-invoke", true, true)
                        if not from then break end
                        room:setPlayerFlag(from, "sfofl_fengshou_target")
                        local to = room:askForPlayerChosen(player, others, self:objectName())
                        room:setPlayerFlag(from, "-sfofl_fengshou_target")
                        room:swapSeat(from, to)
                    end
                end
                local max_mana = player:getMark("&sfofl_moli")
                if max_mana > 0 then
                    local choicelist = {}
                    for i = 1, max_mana do
                        table.insert(choicelist, tostring(i))
                    end
                    local num = room:askForChoice(player, self:objectName(), table.concat(choicelist, "+"))
                    if num > 0 then
                        costMana(player, num, "sfofl_magic_woguotai")
                        local targets = room:askForPlayersChosen(player, room:getAlivePlayers(), self:objectName(), num, num, "@sfofl_fengshou")
                        for _, target in sgs.qlist(targets) do
                            room:addPlayerMark(target, "&sfofl_fengshou")
                        end
                    end
                end
            end
        end
    end,
}

--[[
	技能名：苏生
	相关武将：吴国太[闪耀战姬]
	技能描述：当称号与你相同的角色进入濒死状态时，你可以消耗任意魔​​力令其回复等量的体力和魔力，然后你摸等量张牌。
	引用：sfofl_susheng
]] --
sfofl_susheng = sgs.CreateTriggerSkill{
	name = "sfofl_susheng",
	events = {sgs.Dying},
	on_trigger = function(self, event, player, data)
		local room = player:getRoom()
		local dying = data:toDying()
		local _player = dying.who
		if _player:isKongcheng() then return false end
	    if ((string.find(_player:getGeneralName(), "_change") and string.find(_player:getGeneralName(), "sfofl_")) or (string.find(_player:getGeneral2Name(), "_change") and string.find(_player:getGeneral2Name(), "sfofl_"))) then
            if _player:getHp() < 1 and player:askForSkillInvoke(self:objectName(), data) then
                local max_mana = player:getMark("&sfofl_moli")
                if max_mana == 0 then return false end
                local choicelist = {}
                for i = 1, max_mana do
                    table.insert(choicelist, tostring(i))
                end
                local num = room:askForChoice(player, self:objectName(), table.concat(choicelist, "+"), data)
                if num > 0 then
                    costMana(player, num, "sfofl_magic_woguotai")
                    room:broadcastSkillInvoke(self:objectName())
                    room:recover(_player,sgs.RecoverStruct(self:objectName(),player, num))
                    room:setPlayerMark(_player, "&sfofl_moli", math.min(num+_player:getMark("&sfofl_moli"), 5))
                    player:drawCards(num, self:objectName())
                end
            end
		end
		return false
	end,
}
sfofl_magic_woguotai_change:addSkill(sfofl_fengshou)
sfofl_magic_woguotai_change:addSkill(sfofl_fengshou_buff)
extension_e:insertRelatedSkills("sfofl_fengshou", "#sfofl_fengshou_buff")
sfofl_magic_woguotai_change:addSkill(sfofl_susheng)

sfofl_magic_ruiji = sgs.General(extension_e, "sfofl_magic_ruiji", "wu", 4, false)
--[[
	技能名：魔力
	相关武将：芮姬[官盗]
	技能描述：变身技（0/5），游戏开始时或当你造成或受到伤害时，你获得1点魔力；当你进入濒死状态时或发动“铃音”后，你进行吟唱并变身。
	引用：sfofl_moli_ruiji
]] --
sfofl_moli_ruiji = sgs.CreateTriggerSkill{
    name = "sfofl_moli_ruiji",
    events = {sgs.GameStart, sgs.DamageInflicted, sgs.DamageCaused, sgs.Dying, sgs.MarkChanged},
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.DamageInflicted or event == sgs.DamageCaused or event == sgs.GameStart then
            if player:getMark("&sfofl_moli") < 5 then
                room:addPlayerMark(player, "&sfofl_moli")
            end
        elseif event == sgs.Dying then
            local dying = data:toDying()
            if dying.who:objectName() == player:objectName() then
                if player:getMark("&sfofl_moli") >= 5 then
                    room:broadcastSkillInvoke(self:objectName(),2)
                    doHenshin(player, "sfofl_magic_ruiji")
                end
            end
        elseif event == sgs.MarkChanged then
            local mark = data:toMark()
            if mark.name == "&tenyearlingyinBuff-Clear" and mark.gain > 0 then
                if player:getMark("&sfofl_moli") >= 5 then
                    room:broadcastSkillInvoke(self:objectName(),2)
                    doHenshin(player, "sfofl_magic_ruiji")
                end
            end
        end
    end,
}

sfofl_magic_ruiji:addSkill("tenyearwangyuan")
sfofl_magic_ruiji:addSkill("tenyearlingyin")
sfofl_magic_ruiji:addSkill("tenyearliying")
sfofl_magic_ruiji:addSkill(sfofl_moli_ruiji)
sfofl_magic_ruiji:addRelateSkill("sfofl_shengcai")
sfofl_magic_ruiji:addRelateSkill("sfofl_guanghui")
 
sfofl_magic_ruiji_change = sgs.General(extension_e, "sfofl_magic_ruiji_change", "wu", 4, false, true)
--[[
	技能名：圣裁
	相关武将：芮姬[闪耀战姬]
	技能描述：出牌阶段，你可消耗任意魔力，将等量张手牌当做无距离次数限制的【杀】使用，你以此法使用的【杀】造成的伤害+X（X为你本次消耗的魔力数）。
	引用：sfofl_shengcai
]] --

sfofl_shengcai_buff = sgs.CreateTargetModSkill{
    name = "#sfofl_shengcai_buff",
    residue_func = function(self, player, card)
        if card and card:isKindOf("Slash") and table.contains(card:getSkillNames(), "sfofl_shengcai") then return 999 end
        return 0
    end,
    distance_limit_func = function(self, from, card)
        if card and card:isKindOf("Slash") and table.contains(card:getSkillNames(), "sfofl_shengcai") then return 1000 end
        return 0
    end,
}


sfofl_shengcaiVS = sgs.CreateViewAsSkill{
    name = "sfofl_shengcai",
    n = 999,
    response_or_use = true,
    view_filter = function(self, selected, to_select)
        return not to_select:isEquipped()
    end,
    view_as = function(self, cards)
        if #cards == 0 then return nil end
        if #cards > sgs.Self:getMark("&sfofl_moli") then return nil end
        local slash = sgs.Sanguosha:cloneCard("slash")
        slash:setSkillName(self:objectName())
        slash:addSubcards(cards)
        return slash
    end,
    enabled_at_play = function(self, player)
        return player:getMark("&sfofl_moli") > 0 and sgs.Slash_IsAvailable(player)
    end,
    enabled_at_response = function(self, player, pattern)
        return false
    end,
}

sfofl_shengcai = sgs.CreateTriggerSkill{
    name = "sfofl_shengcai",
    events = {sgs.DamageCaused, sgs.CardUsed},
    view_as_skill = sfofl_shengcaiVS,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.DamageCaused then
            local damage = data:toDamage()
            if damage.card and damage.card:isKindOf("Slash") and table.contains(damage.card:getSkillNames(), "sfofl_shengcai") then
                damage.damage = damage.damage + damage.card:subcardsLength()
                local log = sgs.LogMessage()
                log.type = "#skill_add_damage"
                log.from = damage.from
                log.to:append(damage.to)
                log.arg  = self:objectName()
                log.arg2 = damage.damage
                room:sendLog(log)
                data:setValue(damage)
            end
        elseif event == sgs.CardUsed then
            local use = data:toCardUse()
            if use.card and use.card:isKindOf("Slash") and table.contains(use.card:getSkillNames(), "sfofl_shengcai") then
                costMana(player, use.card:subcardsLength(), "sfofl_magic_ruiji")
                room:addPlayerHistory(player, use.card:getClassName(), -1)
            end
        end
    end,
}

--[[
	技能名：光辉
	相关武将：芮姬[闪耀战姬]
	技能描述：锁定技，所有进入变身状态的角色使用牌不能被非变身状态的角色响应；称号与你相同的角色造成伤害时，你获得1点魔力。
	引用：sfofl_guanghui
]] --   

sfofl_guanghui = sgs.CreateTriggerSkill{
    name = "sfofl_guanghui",
    events = {sgs.DamageCaused, sgs.TargetConfirming},
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.DamageCaused then
            local damage = data:toDamage()
            if damage.from and ((string.find(damage.from:getGeneralName(), "_change") and string.find(damage.from:getGeneralName(), "sfofl_")) or (string.find(damage.from:getGeneral2Name(), "_change") and string.find(damage.from:getGeneral2Name(), "sfofl_"))) then
                for _, ruiji in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    room:broadcastSkillInvoke(self:objectName(),1)
                    if ruiji:getMark("&sfofl_moli") < 5 then
                        room:addPlayerMark(ruiji, "&sfofl_moli")
                    end
                end
            end
        elseif event == sgs.TargetConfirming then
            local use = data:toCardUse()
            if not use.card:isKindOf("SkillCard") then
                if from and ((string.find(from:getGeneralName(), "_change") and string.find(from:getGeneralName(), "sfofl_")) or (string.find(from:getGeneral2Name(), "_change") and string.find(from:getGeneral2Name(), "sfofl_"))) then
                    for _, p in sgs.qlist(room:findPlayerBySkillName(self:objectName())) do
                        local list = use.no_respond_list
                        local targets = sgs.SPlayerList()
                        for _, p in sgs.qlist(use.to) do
                            if not ((string.find(p:getGeneralName(), "_change") and string.find(p:getGeneralName(), "sfofl_")) or (string.find(p:getGeneral2Name(), "_change") and string.find(p:getGeneral2Name(), "sfofl_"))) then
                                table.insert(list, p:objectName())
                                targets:append(p)
                            end
                        end
                        use.no_respond_list = list
                        if not targets:isEmpty() then
                            room:sendCompulsoryTriggerLog(p, self:objectName())
                            local log = sgs.LogMessage()
                            log.type = "$NoRespond"
                            log.from = use.from
                            log.to = use.to
                            log.arg = self:objectName()
                            log.card_str = use.card:toString()
                            room:sendLog(log)
                        end
                        data:setValue(use)
                        break
                    end
                end
            end
        end
    end,
    can_trigger = function(self, target)
        return target
    end
}

sfofl_magic_ruiji_change:addSkill(sfofl_shengcai)
sfofl_magic_ruiji_change:addSkill(sfofl_shengcai_buff)
extension_e:insertRelatedSkills("sfofl_shengcai", "#sfofl_shengcai_buff")
sfofl_magic_ruiji_change:addSkill(sfofl_guanghui)

sfofl_magic_lulingqi = sgs.General(extension_e, "sfofl_magic_lulingqi", "qun", 4, false)
--[[
	技能名：魔力
	相关武将：吕玲绮[官盗]
	技能描述：变身技（0/5），游戏开始时或当你造成1点伤害时，你获得1点魔力，准备阶段，你进行吟唱并变身。
	引用：sfofl_moli_lulingqi
]] --

sfofl_moli_lulingqi = sgs.CreateTriggerSkill{
    name = "sfofl_moli_lulingqi",
    events = {sgs.GameStart, sgs.DamageCaused, sgs.EventPhaseProceeding},
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.DamageCaused or event == sgs.GameStart then
            if player:getMark("&sfofl_moli") < 5 then
                room:addPlayerMark(player, "&sfofl_moli")
            end
        elseif event == sgs.EventPhaseProceeding then
            if player:getPhase() == sgs.Player_Start then
                if player:getMark("&sfofl_moli") >= 5 then
                    room:broadcastSkillInvoke(self:objectName(),2)
                    doHenshin(player, "sfofl_magic_lulingqi")
                end
            end
        end
    end,
}


sfofl_magic_lulingqi:addSkill("guowu")
sfofl_magic_lulingqi:addSkill("zhuangrong")
sfofl_magic_lulingqi:addSkill(sfofl_moli_lulingqi)
sfofl_magic_lulingqi:addRelateSkill("sfofl_henghui")
sfofl_magic_lulingqi:addRelateSkill("sfofl_moqi")

sfofl_magic_lulingqi_change = sgs.General(extension_e, "sfofl_magic_lulingqi_change", "qun", 4, false, true)
--[[
	技能名：恒辉
	相关武将：吕玲绮[闪耀战姬]
	技能描述：锁定技，当你变身后，你获得任意个效果并消耗等量的魔力：1.使用【杀】的次数和造成的伤害+1；2.【杀】无距离限制且目标数+2；3.摸五张牌并弃置装备区内的所有牌。
	引用：sfofl_henghui
]] --

sfofl_henghui_buff = sgs.CreateTargetModSkill{
    name = "#sfofl_henghui_buff",
    pattern = "Slash",
    distance_limit_func = function(self, from, card)
        if from:getMark("&sfofl_henghui_sec") > 0 then
            return 1000
        end
        return 0
    end,
    extra_target_func = function(self,from,card)
		if from:getMark("&sfofl_henghui_sec") > 0 then return 2*from:getMark("&sfofl_henghui_sec") end
		return 0
	end,
    residue_func = function(self, player, card)
        if player:getMark("&sfofl_henghui_first") > 0 then
            return player:getMark("&sfofl_henghui_first")
        end
        return 0
    end,
}

sfofl_henghui_damage = sgs.CreateTriggerSkill{
    name = "#sfofl_henghui_damage",
    events = {sgs.DamageCaused},
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data)
        local damage = data:toDamage()
        if damage.card and damage.card:isKindOf("Slash") then
            damage.damage = damage.damage + player:getMark("&sfofl_henghui_first")
            local log = sgs.LogMessage()
            log.type = "#skill_add_damage"
            log.from = damage.from
            log.to:append(damage.to)
            log.arg  = "sfofl_henghui"
            log.arg2 = damage.damage
            player:getRoom():sendLog(log)
            data:setValue(damage)
        end
    end,
    can_trigger = function(self, target)
        return target and target:getMark("&sfofl_henghui_first") > 0
    end,
}

sfofl_henghui_clear = sgs.CreateTriggerSkill{
    name = "#sfofl_henghui_clear",
    events = {sgs.MarkChanged},
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.MarkChanged then
            local mark = data:toMark()
            if mark.name == "sfofl_henshin" and mark.gain < 0 then
                room:setPlayerMark(player, "&sfofl_henghui_first", 0)
                room:setPlayerMark(player, "&sfofl_henghui_sec", 0)
            end
        end
    end,
}

sfofl_henghui = sgs.CreateTriggerSkill{
    name = "sfofl_henghui",
    events = {sgs.MarkChanged},
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.MarkChanged then
            local mark = data:toMark()
            if mark.name == "sfofl_henshin" and mark.gain > 0 then
                room:broadcastSkillInvoke(self:objectName(),1)
                local max_mana = math.min(player:getMark("&sfofl_moli"), 3)
                if max_mana > 0 then
                    local choicelist = {}
                    if player:getMark("&sfofl_henghui_first") == 0 then
                        table.insert(choicelist, "damage")
                    end
                    if player:getMark("&sfofl_henghui_sec") == 0 then
                        table.insert(choicelist, "distance")
                    end
                    table.insert(choicelist, "draw")
                    table.insert(choicelist, "cancel")
                    while player:getMark("&sfofl_moli") > 0 and #choicelist > 0 do
                        local choice = room:askForChoice(player, self:objectName(), table.concat(choicelist, "+"))
                        if choice == "cancel" then
                            break
                        else
                            costMana(player, 1, "sfofl_magic_lulingqi")
                            if choice == "damage" then
                                room:addPlayerMark(player, "&sfofl_henghui_first")
                                table.removeOne(choicelist, "damage")
                            elseif choice == "distance" then
                                room:addPlayerMark(player, "&sfofl_henghui_sec")
                                table.removeOne(choicelist, "distance")
                            elseif choice == "draw" then
                                player:drawCards(5, self:objectName())
                                player:throwAllEquips(self:objectName())
                                table.removeOne(choicelist, "draw")
                            end
                        end
                    end
                end
            end
        end
    end,
}

--[[
	技能名：魔契
	相关武将：吕玲绮[闪耀战姬]
	技能描述：每次变身限一次，出牌阶段，你可以消耗至少3点魔力并失去所有体力，然后你令“恒辉”的所有数值翻倍。若如此做，你保持变身状态直到结束阶段。
	引用：sfofl_moqi
]] --
sfofl_moqi_clear = sgs.CreateTriggerSkill{
    name = "#sfofl_moqi_clear",
    events = {sgs.MarkChanged, sgs.EventPhaseChanging},
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.MarkChanged then
            local mark = data:toMark()
            if mark.name == "sfofl_henshin" and mark.gain < 0 then
                room:setPlayerMark(player, "sfofl_moqi_used", 0)
            end
        elseif event == sgs.EventPhaseChanging then
            local change = data:toPhaseChange()
            if change.to == sgs.Player_NotActive and player:getMark("&sfofl_moqi") > 0 then
                room:setPlayerMark(source, "&sfofl_moqi", 0)
                quitHenshin(player, "sfofl_magic_lulingqi")
            end
        end
    end,
}

sfofl_moqiCard = sgs.CreateSkillCard{
    name = "sfofl_moqi",
    target_fixed = true,
    on_use = function(self, room, source, targets)
        local max_mana = source:getMark("&sfofl_moli")
        if max_mana < 3 then return end
        local choicelist = {}
        for i = 3, max_mana do
            table.insert(choicelist, tostring(i))
        end
        local num = room:askForChoice(source, "sfofl_moqi", table.concat(choicelist, "+"))
        costMana(source, num, "sfofl_magic_lulingqi")
        room:loseHp(source, source:getHp(), true, source, "sfofl_moqi")
        local first = source:getMark("&sfofl_henghui_first")
        local sec = source:getMark("&sfofl_henghui_sec")
        room:setPlayerMark(source, "&sfofl_henghui_first", first * 2)
        room:setPlayerMark(source, "&sfofl_henghui_sec", sec * 2)
        room:setPlayerMark(source, "&sfofl_moqi", 1)
        room:setPlayerMark(source, "sfofl_moqi_used", 1)
    end,
}
sfofl_moqi = sgs.CreateViewAsSkill{
    name = "sfofl_moqi",
    n = 0,
    view_as = function(self, cards)
        return sfofl_moqiCard:clone()
    end,
    enabled_at_play = function(self, player)
        return player:getMark("sfofl_moqi_used") == 0 and player:getMark("&sfofl_moli") >= 3 and player:getHp() > 0
    end,
}

sfofl_magic_lulingqi_change:addSkill(sfofl_henghui)
sfofl_magic_lulingqi_change:addSkill(sfofl_henghui_buff)
sfofl_magic_lulingqi_change:addSkill(sfofl_henghui_damage)
sfofl_magic_lulingqi_change:addSkill(sfofl_henghui_clear)
extension_e:insertRelatedSkills("sfofl_henghui", "#sfofl_henghui_buff")
extension_e:insertRelatedSkills("sfofl_henghui", "#sfofl_henghui_damage")
extension_e:insertRelatedSkills("sfofl_henghui", "#sfofl_henghui_clear")
sfofl_magic_lulingqi_change:addSkill(sfofl_moqi_clear)
sfofl_magic_lulingqi_change:addSkill(sfofl_moqi)
extension_e:insertRelatedSkills("sfofl_moqi", "#sfofl_moqi_clear")

sfofl_magic_dongwan = sgs.General(extension_e, "sfofl_magic_dongwan", "qun", 3, false)
--[[
	技能名：魔力
	相关武将：董绾[官盗]
	技能描述：变身技（0/5），游戏开始时或当你于摸牌阶段外获得牌时，你获得1点魔力，结束阶段，你进行吟唱并变身。
	引用：sfofl_moli_dongwan
]] --

sfofl_moli_dongwan = sgs.CreateTriggerSkill{
    name = "sfofl_moli_dongwan",
    events = {sgs.CardsMoveOneTime, sgs.EventPhaseProceeding},
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.CardsMoveOneTime then
            local move = data:toMoveOneTime()
            if move.to and move.to:objectName() == player:objectName()
                and move.to_place == sgs.Player_PlaceHand and move.from_places:contains(sgs.Player_PlaceDraw) and player:getPhase() ~= sgs.Player_Draw then
                if player:getMark("&sfofl_moli") < 5 then
                    room:addPlayerMark(player, "&sfofl_moli")
                end
            end
        elseif event == sgs.EventPhaseProceeding then
            if player:getPhase() == sgs.Player_Finish and player:getMark("&sfofl_moli") >= 5 then
                room:broadcastSkillInvoke(self:objectName(),2)
                doHenshin(player, "sfofl_magic_dongwan")
            end
        end
    end,
}

sfofl_magic_dongwan:addSkill("ny_10th_shengdu")
sfofl_magic_dongwan:addSkill("ny_10th_jieling")
sfofl_magic_dongwan:addSkill(sfofl_moli_dongwan)
sfofl_magic_dongwan:addRelateSkill("sfofl_shengyan")
sfofl_magic_dongwan:addRelateSkill("sfofl_gongming")


sfofl_magic_dongwan_change = sgs.General(extension_e, "sfofl_magic_dongwan_change", "qun", 3, false, true)
--[[
	技能名：圣焰
	相关武将：董绾[闪耀战姬]
	技能描述：锁定技，你使用牌时额外结算一次，然后你消耗1点魔力或失去1点体力，对一名其他角色造成1点火焰伤害。
	引用：sfofl_shengyan
]] --
sfofl_shengyan = sgs.CreateTriggerSkill{
    name = "sfofl_shengyan",
    events = {sgs.CardFinished},
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local use = data:toCardUse()
        if use.card and not use.card:isKindOf("SkillCard") then
            room:broadcastSkillInvoke(self:objectName(),1)
            use.card:use(room,use.from,use.to)
            --造成火焰伤害
            local choice = room:askForChoice(player, self:objectName(), "mana+hp")
            if choice == "mana" then
                costMana(player, 1, "sfofl_magic_dongwan")
            else
                room:loseHp(player, 1, nil, self:objectName())
            end
            local target = room:askForPlayerChosen(player, room:getOtherPlayers(player), self:objectName(), "@sfofl_shengyan")
            room:damage(sgs.DamageStruct(self:objectName(), player, target, 1, sgs.DamageStruct_Fire))
        end
    end,
}


--[[
	技能名：共鸣
	相关武将：董绾[闪耀战姬]
	技能描述：当你消耗1点魔力后或失去1点体力后，你可以令称号与你相同的角色各摸X张牌（X为你本次变身此技能发动的次数）。
	引用：sfofl_gongming
]] --
sfofl_gongming = sgs.CreateTriggerSkill{
    name = "sfofl_gongming",
    events = {sgs.MarkChanged, sgs.HpLost},
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.MarkChanged then
            local mark = data:toMark()
            if mark.name == "&sfofl_moli" and mark.gain < 0 then
                if room:askForSkillInvoke(player, self:objectName(), data) then
                    for _, p in sgs.qlist(room:getAllPlayers()) do
                        if ((string.find(p:getGeneralName(), "_change") and string.find(p:getGeneralName(), "sfofl_")) or (string.find(p:getGeneral2Name(), "_change") and string.find(p:getGeneral2Name(), "sfofl_"))) then
                            local x = player:getMark("&sfofl_gongming")
                            room:broadcastSkillInvoke(self:objectName(),1)
                            p:drawCards(x, self:objectName())
                        end
                    end
                end
            end
        elseif event == sgs.HpLost then
            local lose = data:toHpLost()
            if lose.who and lose.who:objectName() == player:objectName() then
                if room:askForSkillInvoke(player, self:objectName(), data) then
                    for _, p in sgs.qlist(room:getAllPlayers()) do
                        if ((string.find(p:getGeneralName(), "_change") and string.find(p:getGeneralName(), "sfofl_")) or (string.find(p:getGeneral2Name(), "_change") and string.find(p:getGeneral2Name(), "sfofl_"))) then
                            local x = player:getMark("&sfofl_gongming")
                            room:broadcastSkillInvoke(self:objectName(),1)
                            p:drawCards(x, self:objectName())
                        end
                    end
                end
            end
        end
    end,
}

sfofl_magic_dongwan_change:addSkill(sfofl_shengyan)
sfofl_magic_dongwan_change:addSkill(sfofl_gongming)



sfofl_lord_goblin = sgs.General(extension_e, "sfofl_lord_goblin", "mo", 6)
--[[
	技能名：疑暴
	相关武将：哥布林领主[官盗]
	技能描述：锁定技，你造成或受到伤害后，令伤害角色摸三张牌；若你为伤害来源，随机废除受伤角色的一个装备区，然后你观看其手牌并获得其两张牌。
	引用：sfofl_yibao
]] --
sfofl_yibao = sgs.CreateTriggerSkill{
    name = "sfofl_yibao",
    frequency = sgs.Skill_Compulsory,
    events = {sgs.Damage, sgs.Damaged},
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local damage = data:toDamage()
        if damage.to and damage.to:isAlive() then
            room:broadcastSkillInvoke(self:objectName(),1)
            damage.to:drawCards(3, self:objectName())
            if damage.from and damage.from:objectName() == player:objectName() then
                room:broadcastSkillInvoke(self:objectName(),2)
                local equip_area = {}
                for i = 0, 4, 1 do
                    if damage.to:hasEquipArea(i) then
                        table.insert(equip_area, i)
                    end
                end
                damage.to:throwEquipArea(equip_area[math.random(1, #equip_area)])
                if not damage.to:isNude() then
                    local remove = sgs.IntList()
                    local to_obtain = dummyCard()
                    local max = math.min(2, damage.to:getCardCount())
                    for i = 1, max do--进行多次执行
                        local id = room:askForCardChosen(player, damage.to, "he", self:objectName(),
                            true,--选择卡牌时手牌可见
                            sgs.Card_MethodNone,
                            remove,--将子卡表设置为不可选卡牌id表（保证每张卡只能被选择一次）
                            false)--只有执行过一次选择才可取消
                        if id < 0 then break end--如果卡牌id无效就结束多次执行
                        remove:append(id)--将选择的id添加到虚拟卡的子卡表
                        to_obtain:addSubcard(id)
                    end
                    room:obtainCard(player, to_obtain, false)
                end
            end
        end
        return false
    end,
}

--[[
	技能名：如麟
	相关武将：哥布林领主[官盗]
	技能描述：锁定技，当你将要造成致命伤害时，你防止之并改为减少其1点体力上限，你增加1点体力上限并回复等量体力。
	引用：sfofl_rulin
]] --

sfofl_rulin = sgs.CreateTriggerSkill{
    name = "sfofl_rulin",
    frequency = sgs.Skill_Compulsory,
    events = {sgs.DamageCaused},
    on_trigger = function(self, event, player, data)
        local damage = data:toDamage()
        if damage.to and damage.to:isAlive() and damage.to:getHp() - damage.damage <= 0 then
            room:broadcastSkillInvoke(self:objectName(),1)
            room:sendCompulsoryTriggerLog(player, self:objectName())
            room:loseMaxHp(damage.to, 1, self:objectName())
            room:gainMaxHp(player, 1, self:objectName())
            local recover = sgs.RecoverStruct()
            recover.reason = self:objectName()
            recover.who = player
            recover.recover = damage.damage
            room:recover(player, recover, true)
            player:damageRevises(data, -damage.damage)
        end
        return false
    end,
}

--[[
	技能名：狂暴
	相关武将：哥布林领主[官盗]
	技能描述：锁定技，当你造成或受到伤害时，若伤害来源手牌数大于受伤角色，此伤害+1，且此牌不计入次数。
	引用：sfofl_kuangbao
]] --

sfofl_kuangbao = sgs.CreateTriggerSkill{
    name = "sfofl_kuangbao",
    frequency = sgs.Skill_Compulsory,
    events = {sgs.DamageCaused, sgs.DamageInflicted},
    on_trigger = function(self, event, player, data)
        local damage = data:toDamage()
        if damage.from and damage.from:getHandcardNum() > damage.to:getHandcardNum() then
            player:damageRevises(data, 1)
            if damage.card and not damage.card:isKindOf("SkillCard") then
                room:addPlayerHistory(player, damage.card:getClassName(), -1)
            end
        end
        return false
    end,
}

--[[
	技能名：飞升
	相关武将：哥布林领主[官盗]
	技能描述：锁定技，每个回合结束时，若你受到过至少2点伤害，你减2点体力上限且本回合结束时进行一个额外的回合。
	引用：sfofl_feisheng
]] --

sfofl_feisheng = sgs.CreateTriggerSkill{
    name = "sfofl_feisheng",
    frequency = sgs.Skill_Compulsory,
    events = {sgs.EventPhaseChanging, sgs.Damaged},
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        if event == sgs.Damaged then
            local damage = data:toDamage()
            if damage.to and damage.to:hasSkill(self:objectName()) then
                room:addPlayerMark(player, "sfofl_feisheng-Clear", damage.damage)
            end
            return false
        elseif event == sgs.EventPhaseChanging then
            local change = data:toPhaseChange()
            if change.to == sgs.Player_NotActive then
                for _, p in sgs.qlist(room:findPlayersBySkillName(self:objectName())) do
                    if p:getMark("sfofl_feisheng-Clear") >= 2 then
                        room:broadcastSkillInvoke(self:objectName(),1)
                        room:sendCompulsoryTriggerLog(p, self:objectName())
                        room:loseMaxHp(p, 2, self:objectName())
                        p:gainAnExtraTurn()
                    end
                end
            end
        end
        return false
    end,
    can_trigger = function(self, target)
        return target
    end,
}

sfofl_lord_goblin:addSkill(sfofl_yibao)
sfofl_lord_goblin:addSkill(sfofl_rulin)
sfofl_lord_goblin:addSkill(sfofl_kuangbao)
sfofl_lord_goblin:addSkill(sfofl_feisheng)

sfofl_goblin = sgs.General(extension_e, "sfofl_goblin", "mo", 4)
--[[
	技能名：恃强
	相关武将：哥布林[官盗]
	技能描述：锁定技，你造成或受到伤害时，若受伤角色/伤害来源的手牌数小于/大于你，此伤害+1。
	引用：sfofl_shiqiang
]] --
sfofl_shiqiang = sgs.CreateTriggerSkill{
	name = "sfofl_shiqiang",
	frequency = sgs.Skill_Compulsory,
	events = {sgs.DamageCaused, sgs.DamageInflicted},
	on_trigger = function(self, event, player, data)
		local damage = data:toDamage()
        local target
        if event == sgs.DamageCaused and player:getHandcardNum() > damage.to:getHandcardNum() then
            target = damage.to
        elseif event == sgs.DamageInflicted and player:getHandcardNum() < damage.from:getHandcardNum() then
            target = damage.from
        end
		if target then
            player:damageRevises(data, 1)
		end
		return false
	end,
}


--[[
	技能名：凌弱
	相关武将：哥布林[官盗]
	技能描述：锁定技，当你造成伤害后，你获得受伤角色的一张牌。
	引用：sfofl_lingruo
]] --
sfofl_lingruo = sgs.CreateTriggerSkill{
    name = "sfofl_lingruo",
    events = {sgs.Damage},
    frequency = sgs.Skill_Compulsory,
    on_trigger = function(self, event, player, data)
        local room = player:getRoom()
        local damage = data:toDamage()
        if damage.to and not damage.to:isNude() then
            room:broadcastSkillInvoke(self:objectName(),1)
            local id = room:askForCardChosen(player, damage.to, "he", self:objectName(), false, sgs.Card_MethodNone)
            local card = sgs.Sanguosha:getCard(id)
            room:obtainCard(player, card, false)
        end
    end,
}
sfofl_goblin:addSkill(sfofl_shiqiang)
sfofl_goblin:addSkill(sfofl_lingruo)


sgs.Sanguosha:addSkills(skills)

sgs.Sanguosha:setPackage(exclusive_cards)
return { extension_s, extension_e, extension_gai, extension_war,extension_card, extension_young, extension_youngcard }
